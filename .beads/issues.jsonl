{"id":"codex-16t","title":"Context overflow protection for handoff","description":"## Goal\nImplement Head+Tail truncation to prevent context overflow during handoff extraction.\n\n## Implementation\nIn core/src/tasks/handoff.rs, before building the extraction prompt:\n1. Estimate token count of history\n2. If exceeds model limit, truncate keeping first + recent messages\n3. Insert placeholder for omitted content\n\n## Code Pattern\n```rust\n// After getting history, before building prompt\nlet model_window = 128_000; // or get from model info\nlet budget = model_window.saturating_sub(8000); // reserve for prompt+response\n\nlet current_estimate = history.iter()\n    .map(|item| approx_token_count(\u0026serde_json::to_string(item).unwrap_or_default()))\n    .sum::\u003cusize\u003e();\n\nif current_estimate \u003e budget {\n    // Keep first message (original goal)\n    // Keep recent messages that fit\n    // Insert [... N messages omitted ...] placeholder\n}\n```\n\n## Files to modify\n- core/src/tasks/handoff.rs - add truncation logic in run method","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T01:46:52.917600737+01:00","updated_at":"2025-12-21T01:46:52.917600737+01:00"}
{"id":"codex-3zq","title":"/handoff command shows empty extracted context","description":"## Problem\nThe /handoff command shows a review dialog with empty 'Extracted Context' section.\n\n## User sees\n```\n┌ Handoff to new thread ────────────────────────────────────────────┐\n│Goal: \u003cwhatever user typed\u003e                                        │\n│───────────────────────────────────────────────────────────────────│\n│Extracted Context                                                  │\n│                                                                   │\n│───────────────────────────────────────────────────────────────────│\n│Relevant Files                                                     │\n│(no files)                                                         │\n│───────────────────────────────────────────────────────────────────│\n│[Enter] Confirm  [e] Edit  [Esc] Cancel                            │\n└───────────────────────────────────────────────────────────────────┘\n```\n\n## Root Cause\nIn core/src/tasks/handoff.rs, `run_extraction()` only captures text from `OutputItemDone` events:\n\n```rust\nwhile let Some(event) = stream.next().await {\n    match event {\n        Ok(ResponseEvent::OutputItemDone(item)) =\u003e {\n            // Only captures OutputItemDone!\n            if let ResponseItem::Message { content, .. } = \u0026item {\n                for c in content {\n                    if let ContentItem::OutputText { text, .. } = c {\n                        response_text.push_str(text);\n                    }\n                }\n            }\n        }\n        Ok(ResponseEvent::Completed { .. }) =\u003e break,\n        Err(e) =\u003e return Err(...),\n        _ =\u003e continue,  // \u003c-- OutputTextDelta is IGNORED here!\n    }\n}\n```\n\nBut streaming responses often come as `OutputTextDelta(String)` events, which are being discarded by `_ =\u003e continue`.\n\n## Fix\nAlso capture `ResponseEvent::OutputTextDelta`:\n\n```rust\nwhile let Some(event) = stream.next().await {\n    match event {\n        Ok(ResponseEvent::OutputItemDone(item)) =\u003e {\n            if let ResponseItem::Message { content, .. } = \u0026item {\n                for c in content {\n                    if let ContentItem::OutputText { text, .. } = c {\n                        response_text.push_str(text);\n                    }\n                }\n            }\n        }\n        Ok(ResponseEvent::OutputTextDelta(delta)) =\u003e {\n            response_text.push_str(\u0026delta);  // ADD THIS!\n        }\n        Ok(ResponseEvent::Completed { .. }) =\u003e break,\n        Err(e) =\u003e return Err(format!(\"Extraction stream error: {e}\")),\n        _ =\u003e continue,\n    }\n}\n```\n\n## Additional improvements\n1. Add logging when response_text is empty after streaming\n2. Add logging to show what events ARE being received (for debugging)\n3. Consider if there are other event types that should be captured\n\n## Files\n- core/src/tasks/handoff.rs - fix run_extraction() to capture OutputTextDelta","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-22T23:28:37.950975738+01:00","updated_at":"2025-12-22T23:28:37.950975738+01:00"}
{"id":"codex-460","title":"Backtrack \u0026 Session Replay Overhaul","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-22T22:07:31.261546993+01:00","updated_at":"2025-12-22T22:07:31.261546993+01:00"}
{"id":"codex-460.1","title":"Restore full session state including tool calls on resume","description":"Currently, resume only replays EventMsg variants, skipping ResponseItem (tool calls and outputs). Need to update get_event_msgs() and UI replay logic to include tool interactions so the session looks complete after resuming.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T22:07:34.892216246+01:00","updated_at":"2025-12-22T22:31:15.338468328+01:00","closed_at":"2025-12-22T22:31:15.338473679+01:00","dependencies":[{"issue_id":"codex-460.1","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.89262571+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.2","title":"Implement bidirectional navigation in backtrack view","description":"Add keybindings to move both 'up' (Esc) and 'down' in the backtrack view. Currently, there is no way to navigate forward/down once you've gone back.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T22:07:34.911128751+01:00","updated_at":"2025-12-22T22:39:37.330141019+01:00","closed_at":"2025-12-22T22:39:37.330146318+01:00","dependencies":[{"issue_id":"codex-460.2","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.911444524+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.3","title":"Fix data loss during backtrack","description":"Investigate and fix issues where backtracking sometimes results in data loss within the session.","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-22T22:07:34.927870804+01:00","updated_at":"2025-12-22T22:07:34.927870804+01:00","dependencies":[{"issue_id":"codex-460.3","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.928135604+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.4","title":"Support backtracking to subagent delegations","description":"Enable backtracking to points where subagents were delegated, whether by user (@agent, /command) or by the main agent. Currently, these delegation points are not captured or reachable in backtrack.","status":"in_progress","priority":1,"issue_type":"feature","created_at":"2025-12-22T22:07:34.944677159+01:00","updated_at":"2025-12-22T22:40:47.492781012+01:00","dependencies":[{"issue_id":"codex-460.4","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.944940014+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4hm","title":"/review fails for non-OpenAI providers due to hardcoded review_model default","description":"When using non-OpenAI providers like antigravity, /review fails with 404 because review_model defaults to gpt-5.1-codex-max which does not exist on those providers. The review uses the same provider but different model, causing the failure.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T16:32:02.531502279+01:00","updated_at":"2025-12-07T16:35:16.58935878+01:00","closed_at":"2025-12-07T16:35:16.58935878+01:00"}
{"id":"codex-4lk","title":"Show subagent session_id in TUI delegation display","description":"## Goal\nWhen displaying subagent delegations in the TUI, show the session_id for traceability:\n```\n• Delegated to @rush (019b47f9-ad11)\n  └ Task description...\n```\n\nThe session_id should be dimmed/subtle to not distract from the main content.\n\n## Why\n- Allows users to find the subagent's rollout file\n- Enables correlation between parent and child sessions\n- Useful for debugging subagent issues\n\n## Implementation\n1. The `SubagentEventPayload::TaskStarted` already contains `session_id`\n2. Update `SubagentTaskCell` in `tui/src/history_cell.rs` to store and display the session_id\n3. Format as truncated UUID (first 12 chars) with dim styling\n\n## Files\n- `tui/src/history_cell.rs` - update SubagentTaskCell rendering\n- Possibly `tui/src/app.rs` - ensure session_id is passed through","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-22T22:50:57.622919731+01:00","updated_at":"2025-12-22T22:50:57.622919731+01:00"}
{"id":"codex-4w8","title":"Implement Gemini CodeAssist quota status in /status","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-19T22:19:36.673883299+01:00","updated_at":"2025-12-19T22:19:36.673883299+01:00"}
{"id":"codex-4w8.1","title":"Define GeminiQuota and ModelQuota structs in protocol","description":"Add GeminiQuota struct to RateLimitSnapshot in protocol/src/protocol.rs. Fields: model_quotas: Vec\u003cModelQuota\u003e. ModelQuota should have: model_id, remaining_amount, remaining_fraction, reset_time, token_type","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:44.036365391+01:00","updated_at":"2025-12-19T22:19:44.036365391+01:00","dependencies":[{"issue_id":"codex-4w8.1","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:44.036765514+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.2","title":"Implement GeminiQuotaClient in core/src/quota/gemini.rs","description":"Create new module core/src/quota/gemini.rs. Implement GeminiQuotaClient that calls https://cloudcode-pa.googleapis.com/v1internal/retrieveUserQuota with OAuth token. Request: {project, userAgent}. Response: {buckets: [{remainingAmount, remainingFraction, resetTime, tokenType, modelId}]}. Return RateLimitSnapshot with gemini field populated.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:51.306184448+01:00","updated_at":"2025-12-19T22:19:51.306184448+01:00","dependencies":[{"issue_id":"codex-4w8.2","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:51.306574052+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.3","title":"Integrate GeminiQuotaClient in TUI prefetch_rate_limits","description":"In tui/src/chatwidget.rs, update prefetch_rate_limits to handle ProviderKind::Gemini. Create GeminiQuotaClient using auth_manager and poll for quota data. Store result in self.rate_limits. Only works for OAuth users, not GEMINI_API_KEY users.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:59.170757703+01:00","updated_at":"2025-12-19T22:19:59.170757703+01:00","dependencies":[{"issue_id":"codex-4w8.3","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:59.171150072+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.4","title":"Display Gemini quota in /status rate_limits section","description":"In tui/src/status/rate_limits.rs, update compose_rate_limit_data to handle RateLimitSnapshot.gemini field. Show per-model quota with remaining percentage and reset time. Format: 'gemini-2.5-flash: 75% remaining (resets in 2h 30m)'","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T22:20:06.697198418+01:00","updated_at":"2025-12-19T22:20:06.697198418+01:00","dependencies":[{"issue_id":"codex-4w8.4","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:20:06.697594504+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-56f","title":"Scope Gemini OAuth to providers requiring Code Assist","description":"resolve_gemini_credential always prefers stored Gemini OAuth tokens when gemini_account_count\u003e0, forcing all Gemini providers to use Code Assist endpoint and ignoring configured API keys. Public generative-language providers break after codex login --gemini. Adjust credential selection to only use OAuth for providers that explicitly require Code Assist and keep API-key providers on their configured bearer.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:19:48.565853205+01:00","updated_at":"2025-12-06T13:27:55.960118498+01:00","closed_at":"2025-12-06T13:27:55.960118498+01:00"}
{"id":"codex-5eu","title":"Subagent session viewer with /children command","description":"Add a /children slash command that opens a hierarchical picker to browse subagent sessions spawned from the current session. Selecting a subagent opens its transcript in a Ctrl+T style overlay.\n\n## Core Principle: REUSE EVERYTHING\nThis feature combines existing components - we are NOT building from scratch:\n1. **Resume picker UI** (tui/src/resume_picker.rs) → Copy and adapt for children picker\n2. **Transcript overlay** (tui/src/pager_overlay.rs) → Use as-is for viewing subagent history\n3. **Session listing** (core/src/rollout/list.rs) → Extend with parent_id filtering\n4. **Rollout loading** (core/src/rollout/recorder.rs) → Use get_rollout_history as-is\n\n## User Flow\n1. User types /children in chat\n2. Picker opens (like resume picker) showing direct children of current session\n3. User navigates:\n   - Up/Down: select session\n   - Right/l: drill into selected session's children\n   - Left/h/Backspace: go back to parent level\n   - Enter: view transcript of selected session\n   - q/Esc: close picker\n4. On Enter: TranscriptOverlay opens (exactly like Ctrl+T) showing subagent's full history\n\n## Key Components to Reuse\n| Need | Reuse From |\n|------|------------|\n| Picker UI layout | resume_picker.rs PickerState |\n| Session list rendering | resume_picker.rs render logic |\n| Transcript viewing | pager_overlay.rs TranscriptOverlay |\n| Session file scanning | rollout/list.rs list_conversations |\n| History loading | rollout/recorder.rs get_rollout_history |\n| HistoryCell conversion | Already exists in chatwidget for resume |\n\n## New Code Required\n1. parent_id field in SubAgentSource (protocol change)\n2. list_session_children() query function (filter by parent_id)\n3. children_picker.rs (copy resume_picker, add hierarchy navigation)\n4. /children slash command registration\n5. Glue code to connect picker → transcript overlay","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-22T23:10:54.49864669+01:00","updated_at":"2025-12-22T23:12:20.760017324+01:00"}
{"id":"codex-5eu.1","title":"Add parent_id to SubAgentSource for session linkage","description":"Modify SubAgentSource in protocol/src/protocol.rs to include parent_id: ConversationId.\n\n## Why This Matters\nWithout parent_id, we cannot query 'which sessions are children of session X'. This is the foundation for the entire /children feature.\n\n## Current Code (protocol/src/protocol.rs)\n```rust\npub enum SubAgentSource {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\n## Target Code\n```rust\npub struct SubAgentSource {\n    pub parent_id: ConversationId,\n    pub agent_type: SubAgentType,\n}\n\npub enum SubAgentType {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\n## Files to Modify\n1. **protocol/src/protocol.rs**\n   - Change SubAgentSource from enum to struct\n   - Add SubAgentType enum\n   - Update SessionSource::SubAgent to use new struct\n\n2. **core/src/codex_delegate.rs** (run_codex_conversation_interactive)\n   - Currently passes: `SessionSource::SubAgent(SubAgentSource::Other(subagent_name.to_string()))`\n   - Change to: `SessionSource::SubAgent(SubAgentSource { parent_id: parent_session.id, agent_type: SubAgentType::Other(...) })`\n\n3. **core/src/codex.rs** \n   - Update any pattern matching on SubAgentSource\n\n4. **Search for all usages**: `rg 'SubAgentSource' --type rust`\n\n## Backward Compatibility\nOld rollout files won't have parent_id. The list_session_children query should handle missing parent_id gracefully (treat as no parent).","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-22T23:11:02.628152795+01:00","updated_at":"2025-12-22T23:12:32.708265381+01:00","dependencies":[{"issue_id":"codex-5eu.1","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:02.628505174+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.1","depends_on_id":"codex-pkg","type":"discovered-from","created_at":"2025-12-22T23:11:02.629141104+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.2","title":"Add list_descendants query for session hierarchy","description":"Add a function to query direct children of a session by parent_id.\n\n## REUSE: core/src/rollout/list.rs\nThis file already has `list_conversations()` that scans session files. We extend it, not rewrite.\n\n## Existing Infrastructure to Reuse\n- `read_head_summary()` - already parses SessionMeta from rollout files\n- `HeadTailSummary` - already extracts source field\n- Directory scanning logic in `list_conversations()`\n- `ConversationItem` struct for results\n\n## New Function Signature\n```rust\n/// Returns direct children of the given parent session.\n/// Scans all session files and filters by parent_id in SessionMeta.\npub async fn list_session_children(\n    codex_home: \u0026Path,\n    parent_id: ConversationId,\n) -\u003e io::Result\u003cVec\u003cConversationItem\u003e\u003e\n```\n\n## Implementation Approach\n1. Extend `HeadTailSummary` to capture `parent_id: Option\u003cConversationId\u003e` from SubAgentSource\n2. Add helper to extract parent_id from SessionSource::SubAgent\n3. Scan sessions (reuse existing dir walking), filter where parent_id matches\n4. Return as Vec\u003cConversationItem\u003e (same type as list_conversations)\n\n## Why Not Pagination?\nFor children, we expect small numbers (tens, not thousands). Simple Vec return is fine. If needed later, can add pagination.\n\n## Key Files\n- core/src/rollout/list.rs - add list_session_children()\n- core/src/lib.rs - export new function","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:10.042180818+01:00","updated_at":"2025-12-22T23:12:47.113870006+01:00","dependencies":[{"issue_id":"codex-5eu.2","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:10.042558304+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.2","depends_on_id":"codex-5eu.1","type":"blocks","created_at":"2025-12-22T23:11:10.043274795+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.3","title":"Create children_picker.rs with hierarchical navigation","description":"Create tui/src/children_picker.rs by COPYING and ADAPTING tui/src/resume_picker.rs.\n\n## REUSE: tui/src/resume_picker.rs (1700+ lines)\nDO NOT write from scratch. Copy resume_picker.rs and modify:\n\n### What to Keep (copy as-is)\n- `PickerState` struct and its core logic\n- Rendering logic for session list (columns, styling)\n- Key handling for Up/Down/PageUp/PageDown/Home/End\n- Search/filter functionality\n- Background page loading infrastructure\n- All the test utilities\n\n### What to Modify\n1. **Data source**: Instead of `list_conversations()`, use `list_session_children(parent_id)`\n2. **Add hierarchy state**: Track current_parent_id and navigation stack\n3. **Add breadcrumb**: Show path like \"root \u003e finder \u003e rush\"\n4. **New keybindings**:\n   - Right/l: push current selection onto stack, load its children\n   - Left/h/Backspace: pop stack, go back to parent level\n5. **Return type**: `ChildrenSelection::ViewTranscript(PathBuf)` instead of Resume\n\n### New Return Type\n```rust\npub enum ChildrenSelection {\n    ViewTranscript(PathBuf),  // User pressed Enter - view this session's transcript\n    Exit,                      // User pressed q/Esc - cancelled\n}\n```\n\n### Hierarchy State\n```rust\nstruct HierarchyState {\n    /// Stack of parent IDs we've drilled into. Empty = showing root's children.\n    navigation_stack: Vec\u003cConversationId\u003e,\n    /// Current parent whose children we're showing.\n    current_parent_id: ConversationId,\n}\n```\n\n### Display Changes\n- Add 'Type' column showing: review, compact, finder, rush, oracle, etc.\n- Show child count indicator if session has children (so user knows they can drill in)\n\n## Files\n- tui/src/children_picker.rs - new file (copy from resume_picker.rs)\n- tui/src/lib.rs - add `mod children_picker;`","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:21.361049252+01:00","updated_at":"2025-12-22T23:13:03.81128294+01:00","dependencies":[{"issue_id":"codex-5eu.3","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:21.361381373+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.3","depends_on_id":"codex-5eu.2","type":"blocks","created_at":"2025-12-22T23:11:21.361904471+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.4","title":"Add /children slash command","description":"Register /children slash command and wire it to children_picker.\n\n## REUSE: Existing slash command infrastructure\nLook at how other slash commands are implemented in:\n- tui/src/slash_command.rs - SlashCommand enum and parsing\n- tui/src/app.rs - command handling\n\n## Step 1: Add to SlashCommand enum (tui/src/slash_command.rs)\n```rust\npub enum SlashCommand {\n    // ... existing variants ...\n    Children,  // NEW\n}\n```\n\n## Step 2: Add parsing\nIn the parsing logic (likely FromStr or parse function):\n```rust\n\"children\" =\u003e Some(SlashCommand::Children),\n```\n\n## Step 3: Handle in app.rs\nFind where slash commands are handled (search for SlashCommand:: matches).\nAdd:\n```rust\nSlashCommand::Children =\u003e {\n    // Get current session's conversation_id\n    let current_id = self.chat_widget.conversation_id();\n    if let Some(id) = current_id {\n        // Enter alt screen for picker\n        let _ = tui.enter_alt_screen();\n        \n        // Run the children picker (similar to resume picker flow)\n        match children_picker::run_children_picker(\n            tui,\n            \u0026self.config.codex_home,\n            id,\n        ).await? {\n            ChildrenSelection::ViewTranscript(path) =\u003e {\n                // Handle in next subtask (codex-5eu.5)\n            }\n            ChildrenSelection::Exit =\u003e {}\n        }\n        \n        // Leave alt screen\n        let _ = tui.leave_alt_screen();\n    } else {\n        // No active session - show error or do nothing\n    }\n}\n```\n\n## Reference: How /resume is handled\nSearch for `OpenResumePicker` or `run_resume_picker` in app.rs to see the pattern.\n\n## Files\n- tui/src/slash_command.rs - add Children variant\n- tui/src/app.rs - handle the command","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:28.794171096+01:00","updated_at":"2025-12-22T23:13:19.551346843+01:00","dependencies":[{"issue_id":"codex-5eu.4","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:28.794698593+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.4","depends_on_id":"codex-5eu.3","type":"blocks","created_at":"2025-12-22T23:11:28.795821113+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.5","title":"Load and display subagent transcript in overlay","description":"Connect children_picker selection to TranscriptOverlay for viewing.\n\n## REUSE: Existing transcript overlay (tui/src/pager_overlay.rs)\nTranscriptOverlay already exists and works perfectly. We just need to:\n1. Load the selected subagent's rollout file\n2. Convert to HistoryCells\n3. Pass to TranscriptOverlay\n\n## REUSE: Rollout loading (core/src/rollout/recorder.rs)\n`RolloutRecorder::get_rollout_history(path)` already loads a rollout file into `InitialHistory`.\n\n## REUSE: HistoryCell conversion\nLook at how resumed sessions create HistoryCells. Search in:\n- tui/src/chatwidget.rs - how ChatWidget handles resumed history\n- tui/src/app.rs - ResumeSelection::Resume handling\n\n## Implementation Flow\nWhen user selects a session in children_picker and presses Enter:\n\n```rust\nChildrenSelection::ViewTranscript(path) =\u003e {\n    // 1. Load rollout (REUSE existing function)\n    let history = RolloutRecorder::get_rollout_history(\u0026path).await?;\n    \n    // 2. Convert RolloutItems to HistoryCells\n    // FIND existing conversion logic - likely in chatwidget or app\n    let cells: Vec\u003cArc\u003cdyn HistoryCell\u003e\u003e = convert_rollout_to_cells(history);\n    \n    // 3. Create and show overlay (REUSE TranscriptOverlay)\n    self.overlay = Some(Overlay::new_transcript(cells));\n}\n```\n\n## Key Question to Investigate\nHow does ChatWidget convert InitialHistory/RolloutItems to HistoryCells during resume?\nFind this code and reuse it. DO NOT reimplement.\n\n## Files\n- tui/src/app.rs - handle ChildrenSelection::ViewTranscript\n- Possibly extract helper if conversion logic is buried in ChatWidget","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:38.449584507+01:00","updated_at":"2025-12-22T23:13:35.16024613+01:00","dependencies":[{"issue_id":"codex-5eu.5","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:38.449956613+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.5","depends_on_id":"codex-5eu.4","type":"blocks","created_at":"2025-12-22T23:11:38.463757343+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.6","title":"Add tests for /children feature","description":"Add tests for the /children feature. Port test patterns from existing code.\n\n## REUSE: Test patterns from resume_picker.rs\nresume_picker.rs has extensive tests (~500 lines). Copy test structure:\n- PickerState unit tests\n- Navigation tests\n- Snapshot tests for UI rendering\n\n## Test Areas\n\n### 1. Protocol tests (protocol/src/)\n- SubAgentSource serialization/deserialization\n- Backward compat: old rollouts without parent_id\n\n### 2. list_session_children tests (core/src/rollout/tests.rs)\n```rust\n#[tokio::test]\nasync fn list_session_children_finds_direct_children() {\n    // Create temp dir with mock rollout files\n    // One parent session, two child sessions with parent_id\n    // Verify list_session_children returns exactly the children\n}\n\n#[tokio::test]\nasync fn list_session_children_excludes_grandchildren() {\n    // Parent -\u003e Child -\u003e Grandchild\n    // list_session_children(parent) should return only Child, not Grandchild\n}\n\n#[tokio::test]  \nasync fn list_session_children_handles_missing_parent_id() {\n    // Old rollout file without parent_id\n    // Should not crash, should not be included in results\n}\n```\n\n### 3. children_picker tests (tui/src/children_picker.rs)\nCopy test structure from resume_picker.rs:\n- Navigation state tests\n- Hierarchy drill-down/up tests\n- Key handling tests\n- Snapshot tests for rendering\n\n### 4. Integration test (if feasible)\n- Spawn subagent, verify parent_id in rollout file\n- May be complex due to full Codex setup required\n\n## Files\n- protocol/src/protocol.rs - add serde tests for SubAgentSource\n- core/src/rollout/tests.rs - list_session_children tests\n- tui/src/children_picker.rs - picker tests (in same file, like resume_picker)","status":"open","priority":3,"issue_type":"task","created_at":"2025-12-22T23:11:45.405880895+01:00","updated_at":"2025-12-22T23:13:50.426799104+01:00","dependencies":[{"issue_id":"codex-5eu.6","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:45.406207045+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.6","depends_on_id":"codex-5eu.5","type":"blocks","created_at":"2025-12-22T23:11:45.406803971+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5qi","title":"Antigravity provider should not require project id","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T11:30:15.058435632+01:00","updated_at":"2025-12-07T11:41:06.66799857+01:00","closed_at":"2025-12-07T11:41:06.66799857+01:00"}
{"id":"codex-5v9","title":"Subagent SessionSource always hardcoded to 'review'","description":"## Problem\nIn `core/src/codex_delegate.rs:54`, the session source is hardcoded:\n```rust\nSessionSource::SubAgent(SubAgentSource::Review),\n```\n\nThis means ALL subagent sessions (rush, finder, oracle, general, etc.) are recorded as 'review' in their rollout metadata.\n\n## Impact\n- Can't tell which subagent type was used from the rollout file\n- Misleading metadata in session files\n\n## Fix\nPass the actual subagent type to `run_codex_conversation_interactive()` and use it when constructing `SessionSource::SubAgent()`.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-22T22:49:24.601095044+01:00","updated_at":"2025-12-22T23:02:12.6258385+01:00","closed_at":"2025-12-22T23:02:12.625845965+01:00"}
{"id":"codex-60v","title":"Fix fragile patch parsing with filenames containing spaces","description":"## Problem\n`WorktreeManager::parse_numstat_from_patch` uses `split_whitespace` to parse paths from `diff --git` headers. This incorrectly splits filenames containing spaces, resulting in truncated or invalid paths.\n\n## Solution\nIn `merge_pending_patches` (patch_merger.rs), use `p.diff.files_changed` which is already correctly parsed from `git diff --numstat` instead of the result from `apply_patch`.\n\n## Files\n- core/src/patch_merger.rs - use p.diff.files_changed\n- core/src/worktree_manager.rs - can remove parse_numstat_from_patch if no longer needed","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:18.955836089+01:00","updated_at":"2025-12-21T19:01:28.225151993+01:00","closed_at":"2025-12-21T19:01:28.225151993+01:00"}
{"id":"codex-64j","title":"Shared MCP connection manager and lazy MCP initialization","description":"Refactor MCP so connections are shared, lazily initialized per server, and no longer block session or subagent startup. Sessions and tools should treat MCP as an optional, per-server resource with explicit readiness, and the TUI should surface server status without delaying conversation flow.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-11T00:41:05.704146041+01:00","updated_at":"2025-12-11T01:08:13.833574857+01:00","closed_at":"2025-12-11T01:08:13.833574857+01:00"}
{"id":"codex-64j.1","title":"Harden and document MCP behavior (errors, timeouts, tests)","description":"Add tests and docs for the new MCP lifecycle: per-server lazy init, shared connections, and explicit readiness. Cover success, timeout, and failure paths, including what the model sees when a server is still starting or permanently failed. Update docs/config.md (MCP section) to describe the new behavior and any user-facing status messages.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.198131799+01:00","updated_at":"2025-12-11T01:08:10.029185972+01:00","closed_at":"2025-12-11T01:08:10.029185972+01:00","dependencies":[{"issue_id":"codex-64j.1","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.198413878+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.2","title":"Optimize subagent behavior with shared MCP clients","description":"Change subagent sessions to reuse the shared McpConnectionManager instead of reinitializing MCP per subagent. Ensure subagents pay zero MCP startup cost unless they actually invoke MCP tools, and verify that authorization/env isolation is handled via per-request metadata rather than redundant connections.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.21135687+01:00","updated_at":"2025-12-11T01:08:05.48787264+01:00","closed_at":"2025-12-11T01:08:05.48787264+01:00","dependencies":[{"issue_id":"codex-64j.2","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.211663315+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.3","title":"Add explicit MCP readiness and status to tool calls and TUI","description":"Plumb MCP server status into events so that the TUI can show per-server startup state (starting/ready/failed) without blocking the session. Update MCP tool handlers to surface clean, typed errors on not-ready/failed servers, and adjust the TUI to render these as actionable messages rather than generic tool failures.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.225203698+01:00","updated_at":"2025-12-11T01:08:00.743117603+01:00","closed_at":"2025-12-11T01:08:00.743117603+01:00","dependencies":[{"issue_id":"codex-64j.3","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.225523038+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.4","title":"Make MCP initialization lazy and per-server","description":"Remove the global upfront initialize() call from Session::new. Instead, have the MCP tool handler (and any direct users) call ensure_started(server) and wait_ready(server, timeout) before a tool call. Only initialize servers that are actually requested in a session, and ensure error paths are well-defined when a server is disabled or fails to connect.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.239103688+01:00","updated_at":"2025-12-11T01:07:56.428050943+01:00","closed_at":"2025-12-11T01:07:56.428050943+01:00","dependencies":[{"issue_id":"codex-64j.4","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.239380357+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.5","title":"Refactor McpConnectionManager into a shared, process-wide manager","description":"Move MCP connection management out of individual sessions into a shared McpConnectionManager that lives for the process (or workspace). Expose APIs to get or start a client per server (by name), track per-server status (NotConfigured/Pending/Connecting/Ready/Failed), and ensure configuration (McpServerConfig, OAuth store mode) is passed in cleanly without coupling to Session internals.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.251475348+01:00","updated_at":"2025-12-11T00:57:16.308717259+01:00","closed_at":"2025-12-11T00:57:16.308717259+01:00","dependencies":[{"issue_id":"codex-64j.5","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.251993197+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-669","title":"Fix P2: Ensure worktree cleanup on all error paths","description":"## Problem\nAfter worktree creation, several error paths don't cleanup the worktree:\n- If `submit` fails\n- If `next_event` returns error\n- Other early returns after worktree exists\n\nThis leaves orphaned worktrees in `~/.codex/agents/`.\n\n## Solution\nWrap the execution logic in an async block. Handle cleanup in the error path.\n\n## Implementation\n\nIn `core/src/tools/handlers/task.rs`, refactor the `TaskHandler::handle` method:\n\n### Step 1: After worktree creation, wrap everything in async block\n\nFind where `worktree_handle` is created. The code after that should be wrapped:\n\n```rust\nlet worktree_handle = worktree_manager\n    .create_worktree(\u0026parent_worktree)\n    .await\n    .map_err(|e| { ... })?;\n\nlet effective_cwd = worktree_handle.path.clone();\n\n// Wrap all remaining logic in async block\nlet execution_result: Result\u003cPendingSubagentResult, FunctionCallError\u003e = async {\n    // ... all the session creation, event loop, diff generation ...\n    // Return Ok(pending_result) on success\n    // Return Err(e) on any failure\n}.await;\n\n// Handle result with cleanup on error\nmatch execution_result {\n    Ok(pending) =\u003e {\n        invocation.session.pending_subagent_results.lock().await.push(pending);\n        \n        let response = serde_json::json!({\n            \"result\": pending.result,\n            \"session_id\": pending.session_id,\n            \"last_tool_output\": pending.last_tool_output,\n            \"changes\": \"pending\",\n        });\n        \n        Ok(ToolOutput::Function {\n            success: Some(true),\n            content: response.to_string(),\n            content_items: None,\n        })\n    }\n    Err(e) =\u003e {\n        // Cleanup on ANY error\n        let _ = worktree_manager.cleanup(\u0026worktree_handle).await;\n        Err(e)\n    }\n}\n```\n\n### Step 2: Remove explicit cleanup calls inside the async block\n\nThe current code has explicit cleanup in:\n- TurnAborted handler\n- generate_diff error handler\n\nRemove these - the outer match will handle cleanup.\n\n### Step 3: Ensure PendingSubagentResult contains worktree_handle\n\nThe pending result must own the worktree_handle so it can be cleaned up during merge.\n\nMake sure the async block returns the full PendingSubagentResult including worktree_handle.\n\n## Notes\n- The worktree_handle needs to be accessible both inside the async block (for building PendingSubagentResult) and outside (for error cleanup)\n- You may need to clone it or restructure slightly\n- The key is: on ANY error after worktree creation, cleanup must happen\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T18:23:10.141038222+01:00","updated_at":"2025-12-21T18:33:05.236369772+01:00","closed_at":"2025-12-21T18:33:05.236369772+01:00"}
{"id":"codex-6kk","title":"Provider-agnostic quota support for /status (Antigravity + ChatGPT)","description":"## Problem\n\nThe TUI `/status` command currently only works with ChatGPT's rate limit API. Antigravity users need quota visibility too.\n\n## Solution\n\nUnify how Codex fetches and displays model usage quotas across providers, starting with ChatGPT and Antigravity.\n\n## Reference Implementation\n\nBased on analysis of `third-party/AntigravityQuota` VS Code extension:\n\n### Process Discovery (process_finder.ts)\n- Find running `language_server_linux_x64` (or platform variant) process via:\n  - Linux: `pgrep -af language_server_linux_x64`\n  - macOS: `pgrep -fl language_server_macos` (or `_arm` variant)\n  - Windows: PowerShell `Get-CimInstance Win32_Process`\n- Parse command line args to extract:\n  - `--csrf_token \u003cuuid\u003e` (required for auth)\n  - `--extension_server_port \u003cport\u003e` (optional, may differ from connect port)\n- Get listening ports: `lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e` or `ss -tlnp`\n- Test each port with HTTPS POST to find working endpoint\n\n### API Call (quota_manager.ts)\n- Endpoint: `POST https://127.0.0.1:\u003cport\u003e/exa.language_server_pb.LanguageServerService/GetUserStatus`\n- Headers:\n  - `Content-Type: application/json`\n  - `Connect-Protocol-Version: 1`\n  - `X-Codeium-Csrf-Token: \u003ccsrf_token\u003e`\n- Body: `{\"metadata\": {\"ideName\": \"codex\", \"extensionName\": \"codex\", \"locale\": \"en\"}}`\n- TLS: Skip certificate verification (`rejectUnauthorized: false`)\n- Timeout: 5 seconds\n\n### Response Structure (types.ts)\n```typescript\ninterface server_user_status_response {\n  userStatus: {\n    name: string;\n    email: string;\n    planStatus?: {\n      planInfo: {\n        teamsTier: string;\n        planName: string;\n        monthlyPromptCredits: number;\n        monthlyFlowCredits: number;\n      };\n      availablePromptCredits: number;\n      availableFlowCredits: number;\n    };\n    cascadeModelConfigData?: {\n      clientModelConfigs: [{\n        label: string;\n        modelOrAlias: { model: string };\n        quotaInfo?: {\n          remainingFraction?: number;  // 0.0-1.0\n          resetTime: string;           // ISO timestamp\n        };\n      }];\n    };\n  };\n}\n```\n\n### Quota Parsing\n- **Prompt credits**: `availablePromptCredits / monthlyPromptCredits` → used percentage\n- **Per-model quotas**: `remainingFraction * 100` → remaining percentage, parse `resetTime` for countdown\n\n## Success Criteria\n- `/status` shows quota info for both ChatGPT and Antigravity providers\n- Graceful handling when language_server not running\n- No blocking of main turn loop","status":"in_progress","priority":2,"issue_type":"epic","created_at":"2025-12-11T00:59:44.83405989+01:00","updated_at":"2025-12-13T20:38:38.02545275+01:00"}
{"id":"codex-6kk.1","title":"Add tests and docs for provider quota integration","description":"## What\n\nAdd tests and documentation for the provider quota integration.\n\n## Tests Required\n\n### Unit Tests (core)\n\n1. **Antigravity response parsing**\n   - Valid response with all fields\n   - Response missing `planStatus`\n   - Response missing `cascadeModelConfigData`\n   - Empty `clientModelConfigs` array\n\n2. **Quota mapping**\n   - Credits calculation (used percentage)\n   - Model quota with `remainingFraction`\n   - Reset time parsing (ISO 8601)\n   - Most restrictive model selection\n\n3. **Process discovery mocking**\n   - Mock `pgrep` output parsing\n   - CSRF token extraction from command line\n   - Port list parsing from `lsof`/`ss`\n\n### Integration Tests (TUI)\n\n1. **Snapshot tests for status card**\n   - ChatGPT rate limits display\n   - Antigravity quota display\n   - No quota available display\n\n2. **Background fetch behavior**\n   - Quota fetch doesn't block UI\n   - Stale data handling\n   - Error state handling\n\n## Documentation Updates\n\n### docs/config.md\n\nAdd section:\n```markdown\n## Provider Quotas\n\nThe `/status` command shows your current usage limits for supported providers:\n\n### ChatGPT\nDisplays primary and secondary rate limit windows from the ChatGPT API.\n\n### Antigravity\nDisplays prompt credits and per-model quotas. Requires the Antigravity\nlanguage server to be running (automatically started by the Antigravity\nVS Code extension or Windsurf).\n\n**Troubleshooting:**\n- \"Quota unavailable\": Language server not running\n- \"No CSRF token\": Try restarting Antigravity\n```\n\n### docs/status.md (if exists)\n\nDocument the `/status` command output format for each provider.\n\n## Acceptance\n\n- All unit tests pass\n- Snapshot tests for status card rendering\n- Documentation explains provider differences\n- Troubleshooting guide for common issues","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.344454208+01:00","updated_at":"2025-12-12T20:41:20.654029537+01:00","dependencies":[{"issue_id":"codex-6kk.1","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.344812683+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.2","title":"Wire provider quotas into TUI /status for ChatGPT and Antigravity","description":"## What\n\nWire the provider-agnostic quota API into TUI's `/status` command.\n\n## Current Implementation\n\nIn `tui/src/rate_limits.rs`:\n- `fetch_rate_limits()` is ChatGPT-specific\n- Called via `AppEvent::RateLimitSnapshotFetched`\n- Renders in status card widget\n\n## Changes Required\n\n### 1. Replace direct ChatGPT call with trait-based dispatch\n\n```rust\n// Before\nlet snapshot = fetch_rate_limits(\u0026auth).await;\n\n// After\nif let Some(client) = create_quota_client(\u0026config) {\n    let snapshot = client.fetch_quota().await;\n    // ...\n}\n```\n\n### 2. Update status card rendering\n\nRemove any ChatGPT-specific language:\n- \"ChatGPT Rate Limits\" → \"Rate Limits\" or \"{Provider} Quotas\"\n- Handle new `credits` field for Antigravity\n\n### 3. Background fetch pattern\n\n```rust\nfn spawn_quota_fetch(\u0026self) {\n    let config = self.config.clone();\n    tokio::spawn(async move {\n        if let Some(client) = create_quota_client(\u0026config) {\n            match client.fetch_quota().await {\n                Some(snapshot) =\u003e {\n                    tx.send(AppEvent::RateLimitSnapshotFetched(snapshot)).await;\n                }\n                None =\u003e {\n                    // Optionally send error event\n                }\n            }\n        }\n    });\n}\n```\n\n### 4. Handle missing quota support\n\nWhen provider doesn't support quotas:\n- Show \"Quota info not available for {provider}\" in status card\n- Don't show error, just informational message\n\n## Status Card Display\n\nFor Antigravity, show:\n```\n╭─ Antigravity Quotas ─────────────────────────────────────────────╮\n│ Prompt Credits: 750 / 1000 (25% used)                            │\n│ Model Quota: 80% remaining (resets in 2h 30m)                    │\n╰──────────────────────────────────────────────────────────────────╯\n```\n\nFor ChatGPT, show existing format:\n```\n╭─ ChatGPT Rate Limits ────────────────────────────────────────────╮\n│ Primary: 45% used (resets in 15m)                                │\n│ Secondary: 12% used (resets in 1h)                               │\n╰──────────────────────────────────────────────────────────────────╯\n```\n\n## Acceptance\n\n- /status works for ChatGPT (existing behavior preserved)\n- /status works for Antigravity (shows credits + model quota)\n- Graceful fallback when quota unavailable\n- No hardcoded provider names in generic code paths","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.35852021+01:00","updated_at":"2025-12-12T23:03:54.2876507+01:00","closed_at":"2025-12-12T23:03:54.2876507+01:00","dependencies":[{"issue_id":"codex-6kk.2","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.358836664+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.3","title":"Design provider-agnostic quota API in core","description":"## What\n\nDesign a provider-neutral quota abstraction in codex-core that both ChatGPT and Antigravity (and future providers) can implement.\n\n## Proposed API\n\n```rust\n/// Trait for fetching quota/rate-limit info from a provider\n#[async_trait]\npub trait ProviderQuotaClient: Send + Sync {\n    /// Fetch current quota snapshot. Returns None if unavailable.\n    async fn fetch_quota(\u0026self) -\u003e Option\u003cRateLimitSnapshot\u003e;\n    \n    /// Human-readable provider name for error messages\n    fn provider_name(\u0026self) -\u003e \u0026'static str;\n}\n\n/// Factory to get the right client based on current auth/config\npub fn create_quota_client(config: \u0026Config) -\u003e Option\u003cBox\u003cdyn ProviderQuotaClient\u003e\u003e {\n    match \u0026config.model_provider {\n        ModelProvider::OpenAI if config.auth.is_chatgpt() =\u003e {\n            Some(Box::new(ChatGptQuotaClient::new(\u0026config.auth)))\n        }\n        ModelProvider::Antigravity =\u003e {\n            Some(Box::new(AntigravityQuotaClient::new()))\n        }\n        _ =\u003e None  // Provider doesn't support quota fetching\n    }\n}\n```\n\n## Existing ChatGPT Implementation\n\nCurrently in `tui/src/rate_limits.rs`:\n- `fetch_rate_limits()` makes HTTP call to ChatGPT API\n- Returns `RateLimitSnapshot` with primary/secondary windows\n\nThis should be wrapped in a `ChatGptQuotaClient` that implements the trait.\n\n## Behavior Requirements\n\n1. **Async-only**: All quota fetching is async, never blocks\n2. **Timeout**: Each provider should timeout within 5-10 seconds\n3. **Graceful failures**: Return `None` on any error, don't panic\n4. **Caching**: Consider caching results for a short period (e.g., 30s)\n5. **No blocking main loop**: TUI should spawn quota fetch in background\n\n## Discovery Logic\n\n```rust\nfn detect_provider(config: \u0026Config) -\u003e Option\u003cBox\u003cdyn ProviderQuotaClient\u003e\u003e {\n    // Priority:\n    // 1. Explicit model_provider setting\n    // 2. API base URL heuristics\n    // 3. Auth mode (ChatGPT auth implies OpenAI)\n    \n    if config.model_provider == ModelProvider::Antigravity {\n        return Some(Box::new(AntigravityQuotaClient::new()));\n    }\n    \n    if config.auth.is_chatgpt() {\n        return Some(Box::new(ChatGptQuotaClient::new(\u0026config.auth)));\n    }\n    \n    None\n}\n```\n\n## Acceptance\n\n- Trait defined in core with clear contract\n- ChatGPT client refactored to implement trait\n- Factory function picks correct client\n- No changes to TUI layer yet (that's codex-6kk.2)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.37383815+01:00","updated_at":"2025-12-12T22:52:54.929637164+01:00","closed_at":"2025-12-12T22:52:54.929637164+01:00","dependencies":[{"issue_id":"codex-6kk.3","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.374196324+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.4","title":"Implement Antigravity quota client using GetUserStatus","description":"## What\n\nImplement `AntigravityQuotaClient` in codex-core that discovers the local Antigravity language_server and fetches quota info.\n\n## Process Discovery (from AntigravityQuota/process_finder.ts)\n\n### Step 1: Find the process\n```rust\n// Platform-specific process discovery\n#[cfg(target_os = \"linux\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: pgrep -af language_server_linux_x64\n    // Parse output: \"\u003cpid\u003e /path/to/language_server_linux_x64 --csrf_token \u003ctoken\u003e ...\"\n    // Return (pid, command_line)\n}\n\n#[cfg(target_os = \"macos\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: pgrep -fl language_server_macos (or _arm for ARM)\n    // Same parsing\n}\n\n#[cfg(target_os = \"windows\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: powershell Get-CimInstance Win32_Process -Filter \"name='language_server_windows_x64.exe'\"\n    // Parse JSON output\n}\n```\n\n### Step 2: Extract CSRF token from command line\n```rust\nfn parse_csrf_token(cmd: \u0026str) -\u003e Option\u003cString\u003e {\n    // Regex: --csrf_token[=\\s]+([a-f0-9\\-]+)\n}\n```\n\n### Step 3: Find listening ports\n```rust\nfn get_listening_ports(pid: u32) -\u003e Vec\u003cu16\u003e {\n    // Linux: ss -tlnp | grep \"pid=\u003cpid\u003e\" OR lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e\n    // macOS: lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e\n    // Windows: PowerShell Get-NetTCPConnection -OwningProcess \u003cpid\u003e -State Listen\n}\n```\n\n### Step 4: Test ports to find working endpoint\n```rust\nasync fn find_working_port(ports: \u0026[u16], csrf_token: \u0026str) -\u003e Option\u003cu16\u003e {\n    // For each port, POST to /exa.language_server_pb.LanguageServerService/GetUnleashData\n    // Return first port that responds with 200\n}\n```\n\n## API Call (from AntigravityQuota/quota_manager.ts)\n\n```rust\nasync fn fetch_quota(port: u16, csrf_token: \u0026str) -\u003e Result\u003cServerUserStatusResponse\u003e {\n    let client = reqwest::Client::builder()\n        .danger_accept_invalid_certs(true)  // Self-signed cert\n        .timeout(Duration::from_secs(5))\n        .build()?;\n    \n    client.post(format!(\"https://127.0.0.1:{port}/exa.language_server_pb.LanguageServerService/GetUserStatus\"))\n        .header(\"Content-Type\", \"application/json\")\n        .header(\"Connect-Protocol-Version\", \"1\")\n        .header(\"X-Codeium-Csrf-Token\", csrf_token)\n        .json(\u0026json!({\n            \"metadata\": {\n                \"ideName\": \"codex\",\n                \"extensionName\": \"codex\",\n                \"locale\": \"en\"\n            }\n        }))\n        .send()\n        .await?\n        .json()\n        .await\n}\n```\n\n## Response Types\n\n```rust\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct ServerUserStatusResponse {\n    user_status: UserStatus,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct UserStatus {\n    name: String,\n    email: String,\n    plan_status: Option\u003cPlanStatus\u003e,\n    cascade_model_config_data: Option\u003cCascadeModelConfigData\u003e,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct PlanStatus {\n    plan_info: PlanInfo,\n    available_prompt_credits: i64,\n    available_flow_credits: i64,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct PlanInfo {\n    teams_tier: String,\n    plan_name: String,\n    monthly_prompt_credits: i64,\n    monthly_flow_credits: i64,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CascadeModelConfigData {\n    client_model_configs: Vec\u003cClientModelConfig\u003e,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct ClientModelConfig {\n    label: String,\n    model_or_alias: Option\u003cModelOrAlias\u003e,\n    quota_info: Option\u003cQuotaInfo\u003e,\n}\n\n#[derive(Deserialize)]\nstruct ModelOrAlias {\n    model: String,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct QuotaInfo {\n    remaining_fraction: Option\u003cf64\u003e,  // 0.0-1.0\n    reset_time: String,               // ISO timestamp\n}\n```\n\n## Error Handling\n\nReturn `None` (not panic) when:\n- Language server process not running\n- CSRF token not found in command line\n- No listening ports found\n- Connection refused/timeout\n- Invalid JSON response\n\n## Acceptance\n\n- Works on Linux, macOS, Windows\n- Fetches quota within 5 seconds\n- Returns `None` gracefully on any failure\n- Unit tests with mocked responses","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.389404355+01:00","updated_at":"2025-12-12T22:52:54.90518871+01:00","closed_at":"2025-12-12T22:52:54.90518871+01:00","dependencies":[{"issue_id":"codex-6kk.4","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.389727001+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.5","title":"Extend RateLimitSnapshot mapping for Antigravity-specific fields","description":"## What\n\nMap Antigravity's `GetUserStatus` response into Codex's existing `RateLimitSnapshot` and `CreditsSnapshot` models.\n\n## Antigravity Response Fields\n\nFrom `server_user_status_response`:\n- `userStatus.planStatus.availablePromptCredits` - credits remaining\n- `userStatus.planStatus.planInfo.monthlyPromptCredits` - credits total\n- `userStatus.cascadeModelConfigData.clientModelConfigs[].quotaInfo.remainingFraction` - 0.0-1.0\n- `userStatus.cascadeModelConfigData.clientModelConfigs[].quotaInfo.resetTime` - ISO timestamp\n\n## Mapping Strategy\n\n### Prompt Credits → CreditsSnapshot\n```rust\nCreditsSnapshot {\n    available: available_prompt_credits,\n    total: monthly_prompt_credits,\n    used_percent: ((monthly - available) / monthly) * 100.0,\n}\n```\n\n### Per-Model Quotas → RateLimitSnapshot\n\nThe existing `RateLimitSnapshot` has `primary_window` and `secondary_window` for ChatGPT's two rate limit tiers. For Antigravity, we can either:\n\n**Option A**: Use `primary_window` for the \"most restrictive\" model quota\n**Option B**: Add a new `model_quotas: HashMap\u003cString, ModelQuota\u003e` field\n\nRecommend Option A for simplicity:\n```rust\n// Find the model with lowest remainingFraction\nlet most_limited = configs.iter()\n    .filter_map(|c| c.quota_info.as_ref())\n    .min_by(|a, b| a.remaining_fraction.partial_cmp(\u0026b.remaining_fraction).unwrap());\n\nRateLimitSnapshot {\n    primary_window: RateLimitWindow {\n        used_percent: (1.0 - remaining_fraction) * 100.0,\n        reset_at: parse_iso_timestamp(reset_time),\n        limit: None,  // Antigravity doesn't expose absolute limits\n        remaining: None,\n    },\n    secondary_window: None,\n    credits: Some(credits_snapshot),\n}\n```\n\n## Time Formatting\n\nAntigravity's `resetTime` is ISO 8601 (e.g., `2025-01-15T00:00:00Z`). Convert to:\n- `reset_at: chrono::DateTime\u003cUtc\u003e`\n- For display: \"Resets in 2h 30m\" or \"Resets at midnight\"\n\n## Unit Tests\n\n```rust\n#[test]\nfn test_antigravity_quota_mapping() {\n    let response = serde_json::from_str::\u003cServerUserStatusResponse\u003e(r#\"{\n        \"userStatus\": {\n            \"planStatus\": {\n                \"planInfo\": { \"monthlyPromptCredits\": 1000 },\n                \"availablePromptCredits\": 750\n            },\n            \"cascadeModelConfigData\": {\n                \"clientModelConfigs\": [{\n                    \"label\": \"Claude 3.5\",\n                    \"quotaInfo\": { \"remainingFraction\": 0.8, \"resetTime\": \"2025-01-15T00:00:00Z\" }\n                }]\n            }\n        }\n    }\"#).unwrap();\n    \n    let snapshot = map_to_rate_limit_snapshot(\u0026response);\n    assert_eq!(snapshot.credits.unwrap().used_percent, 25.0);\n    assert_eq!(snapshot.primary_window.used_percent, 20.0);\n}\n```\n\n## Acceptance\n\n- Mapping preserves ChatGPT compatibility (existing fields still work)\n- Credits shown in /status card\n- Per-model quota shown as primary window\n- Reset time displayed correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.405867483+01:00","updated_at":"2025-12-12T22:52:54.917725294+01:00","closed_at":"2025-12-12T22:52:54.917725294+01:00","dependencies":[{"issue_id":"codex-6kk.5","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.406326319+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m1","title":"Fix unbounded memory growth in subagent sessions","description":"## Problem\nSubagentSession objects are stored in the subagent_sessions map and never removed. A long-running parent session that spawns many tasks will accumulate unbounded SubagentSession objects.\n\n## Analysis\nThis is a trade-off - sessions are kept for potential reuse. However, most subagents are not reused (each task() call creates a new session by default).\n\n## Options\n1. Add TTL-based cleanup for unused sessions\n2. Limit max sessions and evict LRU\n3. Mark as acceptable - sessions are relatively small and bounded by the conversation length\n\nFor now, mark as won't fix - this is acceptable in practice.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T19:17:33.577211174+01:00","updated_at":"2025-12-21T19:17:38.965785657+01:00","closed_at":"2025-12-21T19:17:38.965785657+01:00"}
{"id":"codex-6wa","title":"Dynamic MCP server enumeration in tool descriptions","description":"## Problem\n\nNon-OpenAI/Anthropic models (Gemini, Kimi, GLM, Grok, etc.) hallucinate MCP server names when using `read_mcp_resource`. Most commonly they invent a 'filesystem' server to read local files, resulting in errors like:\n\n```\nError: resources/read failed: unknown MCP server 'filesystem'\n```\n\nThis happens because:\n1. Models see `read_mcp_resource` tool available\n2. They want to read a file\n3. They invent server names based on training data patterns\n\n## Solution\n\nDynamically inject the list of available MCP servers into tool descriptions at runtime. This prevents the entire class of 'invented server name' hallucinations by showing models exactly what's available upfront.\n\n## Approach\n\nExtract server names from the `mcp_tools` HashMap keys (which have format `mcp__servername__toolname`) inside `build_specs()` and pass them to MCP resource tool creation functions. Update descriptions to show:\n- Available servers list\n- Explicit guidance that there's no filesystem server\n- Direction to use shell_command for local files\n\n## Files involved\n- `core/src/tools/spec.rs` - tool creation functions\n- `core/src/mcp_connection_manager.rs` - MCP_TOOL_NAME_DELIMITER constant\n\n## Success criteria\n- Tool descriptions dynamically list available MCP servers\n- Models stop hallucinating non-existent server names\n- No changes to external interfaces or ToolsConfig struct","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T16:05:44.227274567+01:00","updated_at":"2025-12-12T16:44:03.81796512+01:00","closed_at":"2025-12-12T16:44:03.81796512+01:00"}
{"id":"codex-6wa.1","title":"Export MCP_TOOL_NAME_DELIMITER constant","description":"## What\n\nMake `MCP_TOOL_NAME_DELIMITER` (currently `\"__\"`) accessible from `core/src/tools/spec.rs`.\n\n## Why\n\nNeed to parse server names from qualified tool names like `mcp__exa-search__web_search`.\n\n## How\n\nIn `core/src/mcp_connection_manager.rs`:\n- Change `const MCP_TOOL_NAME_DELIMITER` from private to `pub(crate) const`\n\nOr alternatively, re-export it via `core/src/lib.rs` or `core/src/mcp/mod.rs`.\n\n## Acceptance\n- `MCP_TOOL_NAME_DELIMITER` importable in `tools/spec.rs`\n- No changes to its value or behavior","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:06.10762724+01:00","updated_at":"2025-12-12T16:44:03.807142844+01:00","closed_at":"2025-12-12T16:44:03.807142844+01:00","dependencies":[{"issue_id":"codex-6wa.1","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:06.107928565+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.2","title":"Extract server names from mcp_tools in build_specs()","description":"## What\n\nInside `build_specs()` function in `core/src/tools/spec.rs`, extract unique MCP server names from the `mcp_tools` HashMap keys.\n\n## Why\n\nServer names are needed to dynamically populate tool descriptions.\n\n## How\n\n```rust\nuse crate::mcp_connection_manager::MCP_TOOL_NAME_DELIMITER;\nuse std::collections::BTreeSet;\n\n// Inside build_specs():\nlet mcp_server_names: Vec\u003cString\u003e = mcp_tools\n    .as_ref()\n    .map(|tools| {\n        tools.keys()\n            .filter_map(|k| {\n                // Format: mcp__servername__toolname\n                let parts: Vec\u003c\u0026str\u003e = k.split(MCP_TOOL_NAME_DELIMITER).collect();\n                parts.get(1).map(|s| s.to_string())\n            })\n            .collect::\u003cBTreeSet\u003c_\u003e\u003e()  // Dedupe and sort\n            .into_iter()\n            .collect()\n    })\n    .unwrap_or_default();\n```\n\n## Acceptance\n- `mcp_server_names: Vec\u003cString\u003e` available in `build_specs()`\n- Names are sorted and deduplicated\n- Empty vec when no MCP tools configured","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:14.858233758+01:00","updated_at":"2025-12-12T16:44:03.796654516+01:00","closed_at":"2025-12-12T16:44:03.796654516+01:00","dependencies":[{"issue_id":"codex-6wa.2","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:14.858572905+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.2","depends_on_id":"codex-6wa.1","type":"blocks","created_at":"2025-12-12T16:07:18.015773071+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.3","title":"Update MCP resource tool creation functions to accept server names","description":"## What\n\nModify the three MCP resource tool creation functions to accept a slice of server names:\n- `create_list_mcp_resources_tool()`\n- `create_list_mcp_resource_templates_tool()`\n- `create_read_mcp_resource_tool()`\n\n## Why\n\nThese functions need server names to build dynamic descriptions.\n\n## How\n\nChange signatures from:\n```rust\nfn create_list_mcp_resources_tool() -\u003e ToolSpec\nfn create_list_mcp_resource_templates_tool() -\u003e ToolSpec\nfn create_read_mcp_resource_tool() -\u003e ToolSpec\n```\n\nTo:\n```rust\nfn create_list_mcp_resources_tool(server_names: \u0026[String]) -\u003e ToolSpec\nfn create_list_mcp_resource_templates_tool(server_names: \u0026[String]) -\u003e ToolSpec\nfn create_read_mcp_resource_tool(server_names: \u0026[String]) -\u003e ToolSpec\n```\n\nUpdate call sites in `build_specs()` to pass `\u0026mcp_server_names`.\n\n## Acceptance\n- All three functions accept server names parameter\n- Compiles without errors\n- Tests still pass (may need updates)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:24.09025752+01:00","updated_at":"2025-12-12T16:44:03.828011316+01:00","closed_at":"2025-12-12T16:44:03.828011316+01:00","dependencies":[{"issue_id":"codex-6wa.3","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:24.090623428+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.3","depends_on_id":"codex-6wa.2","type":"blocks","created_at":"2025-12-12T16:07:18.048152242+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.4","title":"Build dynamic descriptions with server list","description":"## What\n\nUpdate the description strings in the three MCP resource tool functions to include the available server list.\n\n## Why\n\nModels need to see available servers upfront to avoid hallucinating non-existent ones.\n\n## How\n\n### For `create_read_mcp_resource_tool`:\n\n```rust\nlet description = if server_names.is_empty() {\n    \"Read a specific resource from an MCP server. No MCP servers are currently available. For local file access, use shell_command.\".to_string()\n} else {\n    format!(\n        \"Read a specific resource from an MCP server given the server name and resource URI. Available servers: {:?}. For local file access, use shell_command instead.\",\n        server_names\n    )\n};\n```\n\n### For `create_list_mcp_resources_tool`:\n\n```rust\nlet description = if server_names.is_empty() {\n    \"Lists resources provided by MCP servers. No MCP servers are currently available.\".to_string()\n} else {\n    format!(\n        \"Lists resources provided by MCP servers. Available servers: {:?}. Resources allow servers to share data that provides context to language models.\",\n        server_names\n    )\n};\n```\n\n### For `create_list_mcp_resource_templates_tool`:\n\nSimilar pattern.\n\n## Acceptance\n- Descriptions include server list when servers exist\n- Descriptions indicate 'no servers available' when empty\n- `read_mcp_resource` mentions shell_command for file access","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:34.650444397+01:00","updated_at":"2025-12-12T16:44:03.838111675+01:00","closed_at":"2025-12-12T16:44:03.838111675+01:00","dependencies":[{"issue_id":"codex-6wa.4","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:34.65076033+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.4","depends_on_id":"codex-6wa.3","type":"blocks","created_at":"2025-12-12T16:07:18.063719031+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.5","title":"Update tests for dynamic MCP tool descriptions","description":"## What\n\nUpdate existing tests in `core/src/tools/spec.rs` that create or verify MCP resource tools.\n\n## Why\n\nTests call the tool creation functions directly and will fail after signature changes.\n\n## How\n\nFind tests that call:\n- `create_list_mcp_resources_tool()`\n- `create_list_mcp_resource_templates_tool()`  \n- `create_read_mcp_resource_tool()`\n\nUpdate them to pass a server names slice, e.g., `\u0026[]` or `\u0026[\"test-server\".to_string()]`.\n\nAlso consider adding new test cases:\n1. Empty server list produces expected description\n2. Non-empty server list includes servers in description\n\n## Acceptance\n- All existing tests pass\n- New test verifies description contains server names when provided","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-12T16:06:44.305542595+01:00","updated_at":"2025-12-12T16:06:44.305542595+01:00","dependencies":[{"issue_id":"codex-6wa.5","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:44.30622701+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.5","depends_on_id":"codex-6wa.4","type":"blocks","created_at":"2025-12-12T16:07:18.032792289+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-71l","title":"Subagent configuration updates ignored on session reuse","description":"## Problem\nWhen a subagent session is reused, `TaskHandler` correctly updates the CWD via `OverrideTurnContext`, but it skips reloading the subagent definition and profile. This means changes to the subagent's system prompt, model selection, or approval policy in the `.md` file or `config.toml` are ignored for the reused session.\n\n## Analysis\nThis is actually acceptable behavior for now because:\n1. Session reuse is primarily for oracle/finder agents which don't typically have write permissions\n2. Reloading config mid-session could cause inconsistent behavior\n3. The warning log already notes that conversation history may reference outdated state\n\n## Decision\nMark as won't fix for now. Add a note that config changes require a new session.\n\n## Alternative (if needed later)\nThe handler could re-evaluate the configuration and apply relevant updates (model, policy) to the existing session where possible via additional OverrideTurnContext fields.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:49.849376672+01:00","updated_at":"2025-12-21T18:57:55.231203217+01:00","closed_at":"2025-12-21T18:57:55.231203217+01:00"}
{"id":"codex-7kf","title":"Migrate Custom Features (Providers, Subagents, UI)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-05T13:57:24.388988989+01:00","updated_at":"2025-12-05T16:02:22.845701629+01:00","closed_at":"2025-12-05T16:02:22.845701629+01:00"}
{"id":"codex-7kf.1","title":"Migrate Multi-provider Support (Gemini, Anthropic)","description":"Port core backend support for Gemini and Anthropic from the old fork to codex-rs/core.\n\nSTEPS:\n1. Copy source files from old fork (core/src/):\n   - gemini.rs\n   - gemini_messages.rs\n   - anthropic_messages.rs\n2. Copy resource files:\n   - core/gemini-3-prompt.md\n3. Integrate into codex-rs/core:\n   - Update lib.rs to expose modules\n   - Update model_family.rs to include Gemini/Anthropic variants\n   - Update model_provider_info logic if necessary","notes":"Gemini + Anthropic scaffolds ported; proceeding to subagents","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:30.334759125+01:00","updated_at":"2025-12-05T15:33:33.919881922+01:00","closed_at":"2025-12-05T15:33:33.919885529+01:00","dependencies":[{"issue_id":"codex-7kf.1","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:30.335098263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.1.1","title":"Port Gemini Support","description":"Port all Gemini-related code and assets.\n\nFILES TO COPY:\n- /core/src/gemini.rs\n- /core/src/gemini_messages.rs\n- /core/gemini-3-prompt.md\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Gemini as a provider in core/src/model_family.rs","notes":"Gemini provider files ported, compiling in codex-core","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:34.905643645+01:00","updated_at":"2025-12-05T15:24:55.559395065+01:00","closed_at":"2025-12-05T15:24:55.559399624+01:00","dependencies":[{"issue_id":"codex-7kf.1.1","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:34.905983584+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.1.2","title":"Port Anthropic Support","description":"Port Anthropic-related code.\n\nFILES TO COPY:\n- /core/src/anthropic_messages.rs\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Anthropic as a provider in core/src/model_family.rs (if distinct from OpenAI/Gemini path)","notes":"Anthropic messages/provider ported and compiling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:43.383129271+01:00","updated_at":"2025-12-05T15:31:40.109495912+01:00","closed_at":"2025-12-05T15:31:40.109498948+01:00","dependencies":[{"issue_id":"codex-7kf.1.2","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:43.383462036+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.2","title":"Migrate Subagents Architecture","description":"Port the subagent orchestration logic to enable task delegation.\n\nSTEPS:\n1. Copy core/src/subagents.rs to codex-rs/core/src/\n2. Copy core/src/tools/handlers/task.rs to codex-rs/core/src/tools/handlers/\n3. Register the 'task' tool in the core tool registry\n4. Ensure the task handler hooks correctly into the event loop in codex-rs/app-server or core","notes":"Subagent scaffolding and task tool stubbed; responds unsupported pending full wiring","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:34.951409492+01:00","updated_at":"2025-12-05T15:43:43.070080627+01:00","closed_at":"2025-12-05T15:43:43.070085035+01:00","dependencies":[{"issue_id":"codex-7kf.2","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:34.951692232+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.3","title":"Update TUI for New Providers and Subagents","description":"Adapt the TUI to render non-OpenAI models and subagent activities.\n\nSTEPS:\n1. Port TUI view modes:\n   - Copy/Adapt tui/src/tui/inline.rs\n   - Copy/Adapt tui/src/tui/standard.rs\n2. Update rendering logic:\n   - Check tui/src/chatwidget.rs for provider-specific rendering adjustments\n   - Ensure subagent tool calls are displayed correctly","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:39.162584085+01:00","updated_at":"2025-12-05T16:02:19.277920853+01:00","closed_at":"2025-12-05T16:02:19.277920853+01:00","dependencies":[{"issue_id":"codex-7kf.3","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:39.162905789+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83k","title":"Show model_provider and model in footer","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T16:13:54.687590171+01:00","updated_at":"2025-12-07T16:17:24.942337442+01:00","closed_at":"2025-12-07T16:17:24.942337442+01:00"}
{"id":"codex-83q","title":"Worktree-based subagent file change tracking","description":"Implement git worktree-based isolation for subagents to track ALL file changes (not just apply_patch). \n\n## Problem\n- Subagents can edit files via sed, python scripts, fastmod, cat - not just apply_patch\n- We need to track all changes regardless of method\n- Parallel subagents need correct attribution\n- Main agent spawns subagents mid-turn, so there's always dirty state\n\n## Solution: Recursive Snapshot Pattern\n1. When spawning subagent: capture parent's state via `git stash create -u`\n2. Create detached worktree from that snapshot\n3. Subagent runs freely in isolated worktree\n4. On completion: `git diff --binary $base_sha` to get changes\n5. Apply patch to parent worktree (not always main - supports nesting)\n6. Merge happens at end of turn, in invocation order\n\n## Key Design Decisions\n- Patch content NEVER goes in context - return patch_path on conflict\n- Merge at end of turn (all parallel subagents complete first)\n- Nested subagents: B spawned by A sees A's changes (recursive snapshot from parent worktree)\n- Physical layout flat: .codex/agents/\u003cuuid\u003e, but data flow is hierarchical\n- Subagent response unchanged - changes info is separate field\n\n## Response Format\n```json\n{\n  \"result\": \"subagent's response\",\n  \"session_id\": \"...\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"applied|conflict|no_changes\",\n    \"files_changed\": [{\"path\": \"...\", \"insertions\": N, \"deletions\": N}],\n    \"patch_path\": \".codex/patches/\u003cid\u003e.diff\"  // only if conflict\n  }\n}\n```","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T14:17:35.541896362+01:00","updated_at":"2025-12-21T14:46:08.439665158+01:00","closed_at":"2025-12-21T14:46:08.439665158+01:00"}
{"id":"codex-83q.1","title":"Add SubagentChanges type to protocol","description":"Add new types to codex-protocol for representing subagent file changes.\n\n## Location\n`codex-rs/protocol/src/models.rs` (or new file `subagent_changes.rs`)\n\n## Types to Add\n\n```rust\n/// Status of subagent's file changes after merge attempt\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n#[serde(rename_all = \"snake_case\")]\npub enum SubagentChangesStatus {\n    /// Changes applied successfully to parent worktree\n    Applied,\n    /// Merge conflict - patch saved to patch_path\n    Conflict,\n    /// Subagent made no file changes\n    NoChanges,\n}\n\n/// Summary of a single file change\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub struct FileChangeSummary {\n    pub path: String,\n    pub insertions: i32,\n    pub deletions: i32,\n}\n\n/// Subagent file changes info, separate from subagent's response\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub struct SubagentChanges {\n    pub status: SubagentChangesStatus,\n    /// List of changed files (empty if no_changes or conflict)\n    #[serde(default, skip_serializing_if = \"Vec::is_empty\")]\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Path to saved patch file (only present if conflict)\n    #[serde(default, skip_serializing_if = \"Option::is_none\")]\n    pub patch_path: Option\u003cString\u003e,\n}\n```\n\n## Tests\nAdd unit tests for serialization/deserialization of these types.\n\n## Notes\n- Use i32 for insertions/deletions (not unsigned - per AGENTS.md)\n- path is String not PathBuf for JSON serialization simplicity","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:06.797910136+01:00","updated_at":"2025-12-21T14:35:28.398731264+01:00","closed_at":"2025-12-21T14:35:28.398731264+01:00","dependencies":[{"issue_id":"codex-83q.1","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:06.798202064+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.2","title":"Add WorktreeManager for git worktree operations","description":"Create a new module to handle git worktree lifecycle operations.\n\n## Location\n`codex-rs/core/src/worktree_manager.rs` (new file)\n\n## Responsibilities\n1. Create worktree from a snapshot (stash ref or HEAD)\n2. Generate diff of changes in worktree\n3. Apply patch to target worktree\n4. Cleanup worktree on completion\n\n## Public API\n\n```rust\nuse std::path::{Path, PathBuf};\nuse anyhow::Result;\n\n/// Manages git worktree lifecycle for subagent isolation\npub struct WorktreeManager {\n    /// Root directory where worktrees are created (.codex/agents/)\n    worktrees_root: PathBuf,\n    /// Directory for storing conflict patches (.codex/patches/)\n    patches_dir: PathBuf,\n}\n\n/// Result of creating a worktree\npub struct WorktreeHandle {\n    /// Unique ID for this worktree\n    pub id: String,\n    /// Path to the worktree directory\n    pub path: PathBuf,\n    /// The base SHA this worktree was created from\n    pub base_sha: String,\n}\n\n/// Result of generating a diff\npub struct WorktreeDiff {\n    /// The patch content (may be empty if no changes)\n    pub patch: String,\n    /// Parsed file change summaries\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Whether there are any changes\n    pub has_changes: bool,\n}\n\n/// Result of applying a patch\npub enum PatchApplyResult {\n    /// Patch applied successfully\n    Applied { files_changed: Vec\u003cFileChangeSummary\u003e },\n    /// No changes to apply\n    NoChanges,\n    /// Conflict - patch saved to file\n    Conflict { patch_path: PathBuf },\n}\n\nimpl WorktreeManager {\n    pub fn new(codex_dir: \u0026Path) -\u003e Self;\n    \n    /// Capture current state of parent_dir and create isolated worktree.\n    /// Uses `git stash create -u` to snapshot dirty state.\n    pub async fn create_worktree(\u0026self, parent_dir: \u0026Path) -\u003e Result\u003cWorktreeHandle\u003e;\n    \n    /// Generate diff of all changes in worktree since base_sha.\n    /// Runs: git add -A \u0026\u0026 git diff --binary --cached $base_sha\n    pub async fn generate_diff(\u0026self, handle: \u0026WorktreeHandle) -\u003e Result\u003cWorktreeDiff\u003e;\n    \n    /// Apply patch to target directory.\n    /// Runs: git apply --check first, then git apply if OK.\n    /// On conflict, saves patch to patches_dir and returns Conflict.\n    pub async fn apply_patch(\n        \u0026self,\n        patch: \u0026str,\n        target_dir: \u0026Path,\n        task_id: \u0026str,\n    ) -\u003e Result\u003cPatchApplyResult\u003e;\n    \n    /// Remove worktree and cleanup.\n    pub async fn cleanup(\u0026self, handle: \u0026WorktreeHandle) -\u003e Result\u003c()\u003e;\n}\n```\n\n## Git Commands Used\n- `git stash create -u` - capture dirty state as ephemeral commit\n- `git worktree add --detach \u003cpath\u003e \u003csha\u003e` - create isolated worktree\n- `git add -A` - stage all changes in worktree\n- `git diff --binary --cached \u003csha\u003e` - generate patch\n- `git apply --check \u003cpatch\u003e` - test if patch applies cleanly\n- `git apply \u003cpatch\u003e` - apply patch\n- `git worktree remove --force \u003cpath\u003e` - cleanup\n\n## Error Handling\n- If not a git repo: return clear error\n- If git commands fail: return error with stderr\n- If worktree creation fails: cleanup partial state\n\n## Tests\n- Test create/cleanup lifecycle\n- Test diff generation with various changes (add, modify, delete, binary)\n- Test patch apply success and conflict cases\n- Test with untracked files\n- Test with empty changes (no diff)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:36.53303817+01:00","updated_at":"2025-12-21T14:35:28.415080757+01:00","closed_at":"2025-12-21T14:35:28.415080757+01:00","dependencies":[{"issue_id":"codex-83q.2","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:36.533389882+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.3","title":"Add SubagentContext to track parent worktree path","description":"Track the parent worktree path in subagent context so nested subagents know where to snapshot from.\n\n## Problem\nWhen subagent A spawns subagent B, B must snapshot from A's worktree (not main). We need to pass the current working directory context through the subagent spawn chain.\n\n## Location\nModify `codex-rs/core/src/tools/handlers/task.rs` and related subagent spawning code.\n\n## Current State\nThe task tool handler spawns subagents. It needs to know:\n1. What directory is the \"parent\" for snapshotting\n2. Where to apply patches back to\n\n## Solution\nAdd a field to track the effective working directory for the current agent:\n\n```rust\n/// Context passed to subagent for worktree isolation\npub struct SubagentWorktreeContext {\n    /// The directory to snapshot from when creating this subagent's worktree.\n    /// For root agent: the main workspace directory.\n    /// For nested subagent: the parent subagent's worktree path.\n    pub parent_worktree: PathBuf,\n    \n    /// Where to apply this subagent's changes back to.\n    /// Same as parent_worktree (patches go to parent).\n    pub merge_target: PathBuf,\n}\n```\n\n## Integration Points\n1. `TaskHandler::execute()` - needs access to current worktree context\n2. `SubagentSession` or `Codex` - may need to store worktree context\n3. `TurnContext` or `Session` - evaluate where this context should live\n\n## Notes\n- For the root/main agent, parent_worktree is the user's workspace (cwd)\n- For subagents, parent_worktree is their own worktree path (set by WorktreeManager)\n- This enables recursive nesting: A -\u003e B -\u003e C, each sees parent's state\n\n## Tests\n- Test that nested subagent receives correct parent_worktree\n- Test 3-level nesting: main -\u003e A -\u003e B","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:56.310074187+01:00","updated_at":"2025-12-21T14:35:28.431195031+01:00","closed_at":"2025-12-21T14:35:28.431195031+01:00","dependencies":[{"issue_id":"codex-83q.3","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:56.310460916+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.4","title":"Integrate WorktreeManager into task tool handler","description":"Modify the task tool handler to use WorktreeManager for subagent isolation.\n\n## Location\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Current Flow (simplified)\n1. Parse task arguments (subagent_type, prompt, session_id)\n2. Load or create SubagentSession\n3. Submit prompt to subagent\n4. Wait for completion, collect events\n5. Return result JSON\n\n## New Flow\n1. Parse task arguments\n2. **NEW: Create worktree from parent context**\n   ```rust\n   let worktree_manager = WorktreeManager::new(\u0026codex_home);\n   let handle = worktree_manager.create_worktree(\u0026parent_worktree).await?;\n   ```\n3. Load or create SubagentSession **with worktree path as cwd**\n4. Submit prompt to subagent\n5. Wait for completion, collect events\n6. **NEW: Generate diff from worktree**\n   ```rust\n   let diff = worktree_manager.generate_diff(\u0026handle).await?;\n   ```\n7. **NEW: Collect pending patches (don't apply yet)**\n   - Store (diff, handle, invocation_order) for end-of-turn merge\n8. Return intermediate result (subagent response, no changes yet)\n\n## Deferred Merge\nPatches are NOT applied immediately. They are collected and applied at end of turn.\nSee task \"Implement end-of-turn patch merge\" for the merge logic.\n\n## Error Handling\n- If worktree creation fails (not a git repo), return error to model\n- If subagent crashes, cleanup worktree anyway\n- Use RAII pattern or Drop to ensure cleanup\n\n## Integration with SubagentWorktreeContext\nPass the worktree path to the subagent so nested subagents snapshot from correct location.\n\n## Tests\n- Test subagent runs in isolated worktree\n- Test subagent changes don't affect main until merge\n- Test cleanup on error","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:12.934128284+01:00","updated_at":"2025-12-21T14:41:57.327049743+01:00","closed_at":"2025-12-21T14:41:57.327049743+01:00","dependencies":[{"issue_id":"codex-83q.4","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:12.934493462+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.4","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:05.60403044+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.4","depends_on_id":"codex-83q.3","type":"blocks","created_at":"2025-12-21T14:21:06.761192637+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.5","title":"Implement end-of-turn patch merge coordinator","description":"Implement logic to merge all subagent patches at the end of a turn.\n\n## Problem\nMultiple subagents may run in parallel during a turn. Their patches must be:\n1. Collected until all complete\n2. Applied sequentially in invocation order\n3. Conflicts detected and reported\n\n## Location\nNew module: `codex-rs/core/src/patch_merge_coordinator.rs`\nIntegration: `codex-rs/core/src/codex.rs` or turn execution logic\n\n## Data Structures\n\n```rust\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tokio::sync::Mutex;\n\n/// A pending patch from a completed subagent\npub struct PendingPatch {\n    /// Unique task ID for this subagent invocation\n    pub task_id: String,\n    /// The subagent type (for reporting)\n    pub subagent_type: String,\n    /// The patch content\n    pub patch: String,\n    /// Parsed file changes (for success reporting)\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Target directory to apply patch to\n    pub target_dir: PathBuf,\n    /// Invocation order (for deterministic merge order)\n    pub invocation_order: u32,\n    /// The worktree handle (for cleanup)\n    pub worktree_handle: WorktreeHandle,\n}\n\n/// Result of merging a single patch\npub struct PatchMergeResult {\n    pub task_id: String,\n    pub subagent_type: String,\n    pub changes: SubagentChanges,\n}\n\n/// Coordinates patch collection and merging\npub struct PatchMergeCoordinator {\n    pending: Mutex\u003cVec\u003cPendingPatch\u003e\u003e,\n    worktree_manager: Arc\u003cWorktreeManager\u003e,\n}\n\nimpl PatchMergeCoordinator {\n    /// Add a pending patch (called when subagent completes)\n    pub async fn add_pending(\u0026self, patch: PendingPatch);\n    \n    /// Merge all pending patches in invocation order.\n    /// Called at end of turn.\n    /// Returns results for each patch (success or conflict).\n    pub async fn merge_all(\u0026self) -\u003e Vec\u003cPatchMergeResult\u003e;\n    \n    /// Cleanup all worktrees (called after merge or on error)\n    pub async fn cleanup_all(\u0026self);\n}\n```\n\n## Merge Algorithm\n1. Sort pending patches by invocation_order\n2. Acquire lock on target directory\n3. For each patch:\n   a. Run `git apply --check` \n   b. If OK: `git apply`, record Applied\n   c. If FAIL: save patch to .codex/patches/\u003cid\u003e.diff, record Conflict\n   d. Cleanup worktree\n4. Release lock\n5. Return all results\n\n## Integration Point\nAt end of turn (after all tool calls complete), call `coordinator.merge_all()`.\nInject results into the response to the model.\n\n## Thread Safety\n- Use Mutex for pending patches list\n- Use file lock or async mutex for git operations on target dir\n\n## Tests\n- Test single patch merge\n- Test multiple patches, no conflict\n- Test multiple patches, second conflicts\n- Test invocation order respected\n- Test cleanup on partial failure","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:35.326040567+01:00","updated_at":"2025-12-21T14:42:03.80163668+01:00","closed_at":"2025-12-21T14:42:03.80163668+01:00","dependencies":[{"issue_id":"codex-83q.5","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:35.326414773+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.1","type":"blocks","created_at":"2025-12-21T14:21:08.1013988+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:09.259052952+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.4","type":"blocks","created_at":"2025-12-21T14:21:10.316965448+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.6","title":"Update task tool response to include SubagentChanges","description":"Modify the task tool's response JSON to include the SubagentChanges field.\n\n## Location\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Current Response Format\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\"\n}\n```\n\n## New Response Format\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"applied\",\n    \"files_changed\": [\n      {\"path\": \"src/main.rs\", \"insertions\": 10, \"deletions\": 3}\n    ]\n  }\n}\n```\n\nOr on conflict:\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"conflict\",\n    \"files_changed\": [],\n    \"patch_path\": \".codex/patches/abc123.diff\"\n  }\n}\n```\n\nOr no changes:\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": null\n}\n```\n\n## Implementation\nAfter merge results are available (from PatchMergeCoordinator), include the SubagentChanges in the response JSON.\n\nNote: The merge happens at end of turn, so this task depends on the merge coordinator being integrated.\n\n## Key Principle\n- `result`, `session_id`, `last_tool_output` are subagent's response (unchanged)\n- `changes` is OUR metadata about file changes (separate concern)\n- Never mix subagent content with our metadata\n\n## Tests\n- Test response includes changes on success\n- Test response includes patch_path on conflict\n- Test response has null changes when no files modified","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:50.853573615+01:00","updated_at":"2025-12-21T14:42:35.75156147+01:00","closed_at":"2025-12-21T14:42:35.75156147+01:00","dependencies":[{"issue_id":"codex-83q.6","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:50.853946908+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.6","depends_on_id":"codex-83q.5","type":"blocks","created_at":"2025-12-21T14:21:11.367960692+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.7","title":"Add text summary of subagent changes to user message","description":"Add a human-readable summary of subagent file changes as a text part alongside tool results.\n\n## Problem\nModels work better with alternating user/assistant messages. When multiple subagents complete, we have multiple tool results. Adding a text summary helps the model understand what happened.\n\n## Location\n`codex-rs/core/src/codex.rs` or wherever tool results are assembled into the response.\n\n## Current Behavior\nTool results are returned as-is to the model.\n\n## New Behavior\nAfter end-of-turn merge, add a text summary:\n\n```\nSubagent changes summary:\n- 'general' (task-abc): applied 3 files (src/foo.rs +10/-2, src/bar.rs +5/-0, lib.rs +1/-1)\n- 'painter' (task-def): conflict, patch saved to .codex/patches/def.diff\n- 'finder' (task-ghi): no file changes\n```\n\n## Format Details\n- One line per subagent that completed this turn\n- For applied: list files with +insertions/-deletions\n- For conflict: mention patch path\n- For no_changes: just say \"no file changes\"\n\n## Implementation\n1. After `PatchMergeCoordinator::merge_all()` returns results\n2. Format results into summary string\n3. Include as text part in the message sent to model\n\n## Notes\n- Keep it concise - don't duplicate info that's in JSON\n- This is for model context, not for user display\n- Only include subagents that had changes or conflicts (skip no_changes? TBD)\n\n## Tests\n- Test summary format for various scenarios\n- Test with mix of applied/conflict/no_changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T14:20:05.633679604+01:00","updated_at":"2025-12-21T14:45:29.051536046+01:00","closed_at":"2025-12-21T14:45:29.051536046+01:00","dependencies":[{"issue_id":"codex-83q.7","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:05.633978977+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.7","depends_on_id":"codex-83q.5","type":"blocks","created_at":"2025-12-21T14:21:12.644304394+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.8","title":"Handle non-git directories gracefully","description":"Handle the case where the workspace is not a git repository.\n\n## Problem\nThe worktree-based approach requires git. If the user is working in a non-git directory, we need a fallback.\n\n## Location\n`codex-rs/core/src/worktree_manager.rs`\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Detection\nCheck for git repo:\n```bash\ngit rev-parse --git-dir\n```\nIf this fails, we're not in a git repo.\n\n## Fallback Options\n\n### Option A: Fail with clear error\nReturn error to model: \"Subagent file tracking requires git. Please initialize a git repository.\"\n\nPros: Simple, honest\nCons: Breaks subagent functionality in non-git dirs\n\n### Option B: Run without isolation (legacy behavior)\nSkip worktree creation, run subagent in main directory, no change tracking.\n\nPros: Doesn't break functionality\nCons: No tracking, parallel subagents may conflict\n\n### Option C: Use temporary directory copy\nCopy workspace to temp dir, run there, diff after.\n\nPros: Works without git\nCons: Slow, doesn't handle large repos well\n\n## Recommendation\n**Option A** - fail with clear error. Rationale:\n- Git is nearly universal for code projects\n- The feature's value depends on accurate tracking\n- Better to be explicit than silently degraded\n\n## Implementation\n1. In WorktreeManager::create_worktree(), check for git first\n2. Return specific error type (e.g., NotAGitRepository)\n3. Task handler catches this error, returns user-friendly message\n\n## Tests\n- Test error message in non-git directory\n- Test normal operation in git directory","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T14:20:31.47935844+01:00","updated_at":"2025-12-21T14:43:02.817010427+01:00","closed_at":"2025-12-21T14:43:02.817010427+01:00","dependencies":[{"issue_id":"codex-83q.8","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:31.479668954+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.8","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:13.951156824+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.9","title":"Add environment variable sharing for build caches","description":"Set environment variables in subagent processes to share build caches with main workspace.\n\n## Problem\nWorktrees don't share build artifacts (target/, node_modules/). This means subagents would need to rebuild from scratch, which is slow.\n\n## Solution\nSet environment variables when spawning subagent process to point to main workspace's build directories.\n\n## Environment Variables to Set\n\n### Rust (Cargo)\n```\nCARGO_TARGET_DIR=/absolute/path/to/main/workspace/target\n```\nThis makes cargo use the main workspace's target directory.\n\n### Node.js (npm/yarn/pnpm)\n```\nnpm_config_cache=/absolute/path/to/main/.npm\nYARN_CACHE_FOLDER=/absolute/path/to/main/.yarn/cache\nPNPM_HOME=/absolute/path/to/main/.pnpm-store\n```\n\n### Python (pip)\n```\nPIP_CACHE_DIR=/absolute/path/to/main/.cache/pip\n```\n\n## Location\nWhen spawning the subagent process, set these env vars. This is likely in:\n- `codex-rs/core/src/tools/handlers/task.rs` (where subagent session is created)\n- Or in the subagent process spawn logic\n\n## Implementation\n1. Detect main workspace path (parent worktree for root, or parent's parent for nested)\n2. Construct env var map\n3. Pass to subagent process spawn\n\n## Caveats\n- Only set vars for tools that are detected (check if Cargo.toml exists, package.json, etc.)\n- These are optimizations, not requirements - if they fail, subagent still works (just slower)\n\n## Tests\n- Test CARGO_TARGET_DIR is set when Cargo.toml exists in main workspace\n- Test env vars propagate to subagent's shell commands","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T14:20:46.730764798+01:00","updated_at":"2025-12-21T14:45:20.887393941+01:00","closed_at":"2025-12-21T14:45:20.887393941+01:00","dependencies":[{"issue_id":"codex-83q.9","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:46.731112122+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.9","depends_on_id":"codex-83q.4","type":"blocks","created_at":"2025-12-21T14:21:14.966071462+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-86d","title":"Blocking I/O in WorktreeHandle Drop","description":"WorktreeHandle::drop uses std::process::Command to synchronously execute git worktree remove. This is an emergency fallback - normal cleanup should happen via cleanup() before drop. Low priority since it's rarely triggered.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T19:17:48.691649948+01:00","updated_at":"2025-12-21T19:17:54.787713236+01:00","closed_at":"2025-12-21T19:17:54.787713236+01:00"}
{"id":"codex-8ay","title":"Merge upstream/main into fork","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T12:53:34.411109138+01:00","updated_at":"2025-12-18T12:36:22.808762082+01:00","closed_at":"2025-12-18T12:36:22.808762082+01:00"}
{"id":"codex-8ay.1","title":"Resolve AGENTS.md - keep ours entirely","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:53:52.638578049+01:00","updated_at":"2025-12-18T12:36:10.404280273+01:00","closed_at":"2025-12-18T12:36:10.404280273+01:00","dependencies":[{"issue_id":"codex-8ay.1","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:53:52.639137096+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.10","title":"Resolve app-server conflicts - accept upstream","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:09.237345264+01:00","updated_at":"2025-12-18T12:36:10.399174245+01:00","closed_at":"2025-12-18T12:36:10.399174245+01:00","dependencies":[{"issue_id":"codex-8ay.10","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:09.237789251+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.11","title":"Resolve test files with simple conflicts","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:18.423001633+01:00","updated_at":"2025-12-18T12:36:10.397810759+01:00","closed_at":"2025-12-18T12:36:10.397810759+01:00","dependencies":[{"issue_id":"codex-8ay.11","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:18.423544229+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.12","title":"Resolve remaining core/* conflicts","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:55:27.975875486+01:00","updated_at":"2025-12-18T12:36:10.428449945+01:00","closed_at":"2025-12-18T12:36:10.428449945+01:00","dependencies":[{"issue_id":"codex-8ay.12","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:27.976481283+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.13","title":"Build and fix compilation errors","status":"closed","issue_type":"task","created_at":"2025-12-15T12:55:37.311969336+01:00","updated_at":"2025-12-18T12:36:10.397834926+01:00","closed_at":"2025-12-18T12:36:10.397834926+01:00","dependencies":[{"issue_id":"codex-8ay.13","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:37.312539093+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.14","title":"Run tests and fix failures","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:55:46.560821722+01:00","updated_at":"2025-12-18T12:36:10.397953853+01:00","closed_at":"2025-12-18T12:36:10.397953853+01:00","dependencies":[{"issue_id":"codex-8ay.14","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:46.56130801+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.2","title":"Resolve protocol/src/*.rs - keep provider extensions","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.10080133+01:00","updated_at":"2025-12-18T12:36:10.399922024+01:00","closed_at":"2025-12-18T12:36:10.399922024+01:00"}
{"id":"codex-8ay.3","title":"Resolve core/src/model_provider_info.rs","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.101001042+01:00","updated_at":"2025-12-18T12:36:10.399029158+01:00","closed_at":"2025-12-18T12:36:10.399029158+01:00","dependencies":[{"issue_id":"codex-8ay.3","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.101546733+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.4","title":"Resolve Cargo.toml and regenerate Cargo.lock","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.111883689+01:00","updated_at":"2025-12-18T12:36:10.447866451+01:00","closed_at":"2025-12-18T12:36:10.447866451+01:00","dependencies":[{"issue_id":"codex-8ay.4","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.115028392+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.5","title":"Resolve core/src/codex.rs - complex merge","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.112849302+01:00","updated_at":"2025-12-18T12:36:10.441995872+01:00","closed_at":"2025-12-18T12:36:10.441995872+01:00"}
{"id":"codex-8ay.6","title":"Resolve core/src/lib.rs - keep our modules","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.153336627+01:00","updated_at":"2025-12-18T12:36:10.399231595+01:00","closed_at":"2025-12-18T12:36:10.399231595+01:00","dependencies":[{"issue_id":"codex-8ay.6","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.153743513+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.7","title":"Resolve snapshot files - accept upstream","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-15T12:54:41.13876698+01:00","updated_at":"2025-12-18T12:36:10.399677367+01:00","closed_at":"2025-12-18T12:36:10.399677367+01:00","dependencies":[{"issue_id":"codex-8ay.7","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:41.139172404+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.8","title":"Resolve CI/workflow files - accept upstream","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-15T12:54:50.07028695+01:00","updated_at":"2025-12-18T12:36:10.397942411+01:00","closed_at":"2025-12-18T12:36:10.397942411+01:00","dependencies":[{"issue_id":"codex-8ay.8","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:50.070745676+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.9","title":"Resolve tui/tui2 conflicts - accept upstream, preserve customizations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:00.022732573+01:00","updated_at":"2025-12-18T12:36:10.399841891+01:00","closed_at":"2025-12-18T12:36:10.399841891+01:00","dependencies":[{"issue_id":"codex-8ay.9","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:00.02329124+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8k0","title":"Drop legacy execpolicy + local providers","description":"Goal: reduce fork complexity and future upstream merge friction by removing two unused stacks.\n\nScope:\n1) Remove execpolicy-legacy:\n- Delete the codex-execpolicy-legacy crate and remove execpolicy-legacy from the workspace.\n- Remove any remaining references in docs, tests, and Cargo manifests/lockfile.\n\n2) Remove local providers:\n- Delete codex-lmstudio and codex-ollama crates and remove them from the workspace.\n- Remove OSS-provider plumbing tied to these crates (oss_provider config option, LMSTUDIO/OLLAMA provider IDs/ports/constants, ensure_oss_ready helpers).\n- Remove CLI/TUI flags and help text for choosing local providers.\n- Update docs and tests/snapshots that mention local providers.\n\nDone when:\n- Workspace builds and tests pass without these crates.\n- No code/docs mention execpolicy-legacy, lmstudio, ollama, or oss_provider.\n- CLI/TUI help output no longer offers local providers.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-12T00:46:52.037997823+01:00","updated_at":"2025-12-12T01:08:24.078052292+01:00","closed_at":"2025-12-12T01:08:24.078052292+01:00"}
{"id":"codex-8k0.1","title":"Clean CLI/TUI + docs/tests","description":"Follow-up cleanup after dropping local providers:\n- Remove local-provider CLI/TUI flags and any related help text.\n- Update docs and example config to remove oss_provider and local provider mention.\n- Update or delete tests/snapshots referencing lmstudio or ollama.\n- Run targeted tests for affected crates.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.724088879+01:00","updated_at":"2025-12-12T01:08:19.386507206+01:00","closed_at":"2025-12-12T01:08:19.386507206+01:00","dependencies":[{"issue_id":"codex-8k0.1","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.724700548+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-8k0.2","title":"Remove lmstudio/ollama crates","description":"Delete local provider crates:\n- Remove lmstudio and ollama from codex-rs/Cargo.toml workspace members and workspace dependencies.\n- Delete codex-rs/lmstudio and codex-rs/ollama crate directories.\n- Remove their usage from codex-common OSS helper, codex-core model provider registry, and config parsing.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.749404256+01:00","updated_at":"2025-12-12T01:08:09.414548804+01:00","closed_at":"2025-12-12T01:08:09.414548804+01:00","dependencies":[{"issue_id":"codex-8k0.2","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.74966263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-8k0.3","title":"Remove execpolicy-legacy crate","description":"Delete codex-execpolicy-legacy:\n- Remove execpolicy-legacy from codex-rs/Cargo.toml workspace members and workspace dependencies.\n- Delete codex-rs/execpolicy-legacy crate directory.\n- Remove references to the legacy matcher/binary from execpolicy README and any docs/tests.\n- Regenerate Cargo.lock and ensure no dependency edges remain.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.760783007+01:00","updated_at":"2025-12-12T01:08:13.729300306+01:00","closed_at":"2025-12-12T01:08:13.729300306+01:00","dependencies":[{"issue_id":"codex-8k0.3","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.761067881+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f","title":"Handoff Feature - Continue work in new focused thread","description":"## Handoff Feature\n\nImplement Amp-style handoff for Codex - a user-initiated way to continue work in a new focused thread instead of compacting.\n\n### Reference\n- Amp handoff documentation: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n\n### Key Concepts\n- **User-initiated only**: Triggered via `/handoff \u003cgoal\u003e` command\n- **Creates NEW thread**: Original remains intact, new session gets extracted context\n- **Draft review**: User can review/edit extracted context before confirming\n- **Parent-child relationship**: Traceability between sessions in rollout files\n- **Selective extraction**: LLM extracts only what's relevant to the stated goal\n\n### Architecture Decision\nImplementing as **First-Class Session Operation** (Solution 3):\n- Protocol changes: Op::Handoff, EventMsg::HandoffDraft, SessionSource::Handoff\n- Core: HandoffTask similar to CompactTask\n- TUI: /handoff command + draft review screen\n- Rollout: Parent-child links in metadata\n\n### Why not alternatives?\n- Solution 1 (Enhanced Fork): No special rollout item, loses traceability\n- Solution 2 (Tool Call): Fights tool system, awkward interception\n\n### MVP Scope\n1. /handoff command\n2. Extraction with structured output\n3. New session creation\n4. Parent-child in rollout\n5. Read-only draft review\n\n### Future (post-MVP)\n- Editable draft review\n- Fallback model on context limit (90% warning)\n- read_parent_thread tool\n- File validation","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T20:03:16.034385303+01:00","updated_at":"2025-12-20T23:31:14.865315821+01:00","closed_at":"2025-12-20T23:31:14.865315821+01:00"}
{"id":"codex-92f.1","title":"Add Handoff protocol types to codex-protocol","description":"## Protocol Changes for Handoff\n\nAdd the following types to `protocol/src/protocol.rs`:\n\n### New Op variants\n```rust\npub enum Op {\n    // ... existing ...\n    Handoff { goal: String },\n    ConfirmHandoff { draft: HandoffDraft },\n    CancelHandoff,\n}\n```\n\n### New Event variants\n```rust\npub enum EventMsg {\n    // ... existing ...\n    HandoffDraft(HandoffDraftEvent),\n    HandoffCompleted(HandoffCompletedEvent),\n}\n```\n\n### New types\n```rust\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffDraftEvent {\n    pub summary: String,           // Extracted context (first-person perspective)\n    pub goal: String,              // User's stated goal\n    pub relevant_files: Vec\u003cPathBuf\u003e,\n    pub parent_id: ConversationId,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffDraft {\n    pub summary: String,\n    pub goal: String,\n    pub relevant_files: Vec\u003cPathBuf\u003e,\n    pub parent_id: ConversationId,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffCompletedEvent {\n    pub new_session_id: ConversationId,\n}\n```\n\n### Extend SessionSource\n```rust\npub enum SessionSource {\n    Cli,\n    Tui,\n    AppServer,\n    Handoff { parent_id: ConversationId, goal: String },  // NEW\n}\n```\n\n### Extend InitialHistory\n```rust\npub enum InitialHistory {\n    New,\n    Resumed(ResumedHistory),\n    Forked(Vec\u003cRolloutItem\u003e),\n    Handoff { context: Vec\u003cRolloutItem\u003e, parent_id: ConversationId },  // NEW\n}\n```\n\n### Files to modify\n- `protocol/src/protocol.rs` - main types\n- `protocol/src/lib.rs` - exports\n\n### Testing\n- Add serialization/deserialization tests for new types\n- Ensure JsonSchema and TS derive work correctly\n\n### Reference\n- Amp handoff: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Existing SessionSource in protocol.rs for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:03:45.39588034+01:00","updated_at":"2025-12-20T20:20:38.930694668+01:00","closed_at":"2025-12-20T20:20:38.930694668+01:00","dependencies":[{"issue_id":"codex-92f.1","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:03:45.396236239+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.2","title":"Implement HandoffTask in codex-core","description":"## HandoffTask Implementation\n\nCreate `core/src/tasks/handoff.rs` - a task that extracts relevant context from the conversation for handoff.\n\n### Task Structure\n```rust\npub struct HandoffTask {\n    pub goal: String,\n}\n\nimpl SessionTask for HandoffTask {\n    fn kind(\u0026self) -\u003e TaskKind { TaskKind::Regular }\n    \n    async fn run(...) -\u003e Option\u003cString\u003e {\n        // 1. Build extraction prompt with conversation + goal\n        // 2. Run extraction using current model\n        // 3. Parse structured output (JSON with summary + files)\n        // 4. Emit EventMsg::HandoffDraft\n        // 5. Return None (don't continue turn)\n    }\n    \n    async fn abort(...) { /* Cancel gracefully */ }\n}\n```\n\n### Extraction Prompt\nUse Amp's extraction prompt pattern (from handoff.md):\n```\nExtract relevant context from the conversation above for continuing this work.\nWrite from my perspective (first person: \"I did...\", \"I told you...\").\n\nConsider what would be useful based on my request:\n- What did I just do or implement?\n- What instructions did I already give you which are still relevant?\n- What files am I working on?\n- Did I provide a plan or spec that should be included?\n- What libraries, patterns, constraints, or preferences did I mention?\n- What important technical details did I discover?\n- What caveats, limitations, or open questions exist?\n\nExtract what matters for the specific request. Don't answer irrelevant questions.\nPick an appropriate length based on complexity.\n\nFocus on capabilities and behavior, not file-by-file changes.\nAvoid excessive implementation details unless critical.\n\nFormat your response as JSON:\n{\n  \"summary\": \"Plain text with bullets. No markdown headers.\",\n  \"files\": [\"path/to/file1.rs\", \"path/to/dir/\"]\n}\n\nMy request:\n```\n\n### Store template\nCreate `core/templates/handoff/extraction_prompt.md` for the prompt template.\n\n### Structured Output Parsing\n- Parse JSON response from model\n- Handle malformed JSON gracefully (try to extract summary at minimum)\n- Validate file paths exist (warn if not, but include anyway)\n\n### Files to create/modify\n- `core/src/tasks/handoff.rs` - new file\n- `core/src/tasks/mod.rs` - add module\n- `core/templates/handoff/extraction_prompt.md` - prompt template\n\n### Pattern to follow\n- Look at `core/src/tasks/compact.rs` for similar task structure\n- Look at `core/src/compact.rs` for how extraction prompts work\n\n### Testing\n- Unit test for prompt construction\n- Unit test for JSON parsing (valid, malformed cases)\n- Integration test with mock model response\n\n### Reference\n- Amp handoff: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Existing CompactTask for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:07.401767285+01:00","updated_at":"2025-12-20T20:38:04.70867295+01:00","closed_at":"2025-12-20T20:38:04.70867295+01:00","dependencies":[{"issue_id":"codex-92f.2","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:07.402097454+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.2","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:07.392706026+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.3","title":"Add create_handoff_conversation to ConversationManager","description":"## ConversationManager Handoff Support\n\nAdd method to create a new conversation from a handoff draft.\n\n### Method Signature\n```rust\nimpl ConversationManager {\n    pub async fn create_handoff_conversation(\n        \u0026self,\n        draft: HandoffDraft,\n        config: Config,\n    ) -\u003e CodexResult\u003cNewConversation\u003e {\n        // 1. Build initial context message\n        // 2. Build goal message  \n        // 3. Create InitialHistory::Handoff\n        // 4. Spawn with SessionSource::Handoff\n        // 5. Return NewConversation\n    }\n}\n```\n\n### Initial Context Message Format\nFollowing Amp's pattern:\n```\nContinuing work from thread {parent_id}. When you lack specific information you can use read_thread to get it.\n\n@file1.ts @file2.ts @dir/\n\nOther relevant files: path/to/file3.ts, path/to/file4.ts\n\n{extracted_summary}\n```\n\n### File Mentions\n- First 12 files get `@` prefix (attached/mentioned)\n- Remaining files listed as \"Other relevant files: ...\"\n- Use workspace-relative paths\n\n### Session Source\nUse new `SessionSource::Handoff { parent_id, goal }` to track lineage.\n\n### Files to modify\n- `core/src/conversation_manager.rs` - add method\n- May need to adjust `Codex::spawn` if InitialHistory::Handoff needs special handling\n\n### Pattern to follow\n- Look at `fork_conversation()` for similar pattern\n- Look at `resume_conversation_with_history()` for how to pass initial history\n\n### Testing\n- Unit test for context message formatting\n- Integration test creating handoff conversation\n\n### Reference\n- Amp handoff message format in handoff.md\n- Existing fork_conversation for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:23.53626433+01:00","updated_at":"2025-12-20T20:38:04.716029202+01:00","closed_at":"2025-12-20T20:38:04.716029202+01:00","dependencies":[{"issue_id":"codex-92f.3","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:23.536659754+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.3","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:08.70140454+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.4","title":"Handle Op::Handoff in codex session loop","description":"## Session Loop Handoff Handling\n\nWire up Op::Handoff and Op::ConfirmHandoff/CancelHandoff in the session submission handler.\n\n### Op::Handoff handling\nIn the session's submission processing (likely in `codex.rs` or related):\n```rust\nOp::Handoff { goal } =\u003e {\n    // 1. Validate not already in a task\n    // 2. Create HandoffTask { goal }\n    // 3. Spawn task (similar to compact task)\n    // 4. Task will emit HandoffDraftReady event when done\n}\n```\n\n### Op::ConfirmHandoff handling\n```rust\nOp::ConfirmHandoff { draft } =\u003e {\n    // 1. Call conversation_manager.create_handoff_conversation(draft, config)\n    // 2. Record HandoffItem in parent's rollout\n    // 3. Emit HandoffCompleted { new_session_id }\n    // 4. (TUI will handle switching to new session)\n}\n```\n\n### Op::CancelHandoff handling\n```rust\nOp::CancelHandoff =\u003e {\n    // 1. Clear any pending handoff state\n    // 2. No-op if nothing pending\n    // 3. Maybe emit event to confirm cancellation?\n}\n```\n\n### Rollout Recording\nWhen handoff completes, record in parent's rollout:\n```rust\nRolloutItem::Handoff(HandoffItem {\n    child_id: new_session_id,\n    goal: draft.goal,\n    timestamp: now(),\n})\n```\n\n### Files to modify\n- `core/src/codex.rs` - handle new Op variants in submission handler\n- May need to add HandoffItem to rollout types\n\n### Pattern to follow\n- Look at how Op::Compact is handled\n- Look at how Op::UserTurn spawns tasks\n\n### Testing\n- Integration test: submit Op::Handoff, verify HandoffDraft event emitted\n- Integration test: submit Op::ConfirmHandoff, verify new session created\n\n### Reference\n- Existing Op handling in codex.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:39.171018009+01:00","updated_at":"2025-12-20T20:45:55.852392637+01:00","closed_at":"2025-12-20T20:45:55.852392637+01:00","dependencies":[{"issue_id":"codex-92f.4","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:39.171386823+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.4","depends_on_id":"codex-92f.2","type":"blocks","created_at":"2025-12-20T20:06:09.969531781+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.4","depends_on_id":"codex-92f.3","type":"blocks","created_at":"2025-12-20T20:06:11.615432852+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.5","title":"Add /handoff slash command to TUI","description":"## TUI Slash Command\n\nAdd `/handoff \u003cgoal\u003e` command to the TUI.\n\n### SlashCommand enum\nIn `tui/src/slash_command.rs`:\n```rust\npub enum SlashCommand {\n    // ... existing ...\n    Handoff,  // Add after Review or in logical position\n}\n\nimpl SlashCommand {\n    pub fn description(self) -\u003e \u0026'static str {\n        match self {\n            // ... existing ...\n            SlashCommand::Handoff =\u003e \"continue work in a new focused thread\",\n        }\n    }\n    \n    pub fn available_during_task(self) -\u003e bool {\n        match self {\n            // ... existing ...\n            SlashCommand::Handoff =\u003e false,  // Cannot handoff while task running\n        }\n    }\n}\n```\n\n### Command invocation\nWhen user types `/handoff implement feature X`:\n1. Parse the goal (everything after `/handoff `)\n2. Submit `Op::Handoff { goal }` to core\n3. Wait for `EventMsg::HandoffDraft` response\n\n### Goal parsing\n- `/handoff` alone → show error \"Please provide a goal\"\n- `/handoff \u003cgoal\u003e` → submit with goal\n\n### Files to modify\n- `tui/src/slash_command.rs` - add enum variant\n- `tui/src/bottom_pane/chat_composer.rs` - handle command submission\n- `tui/src/app.rs` - wire up Op submission\n\n### Pattern to follow\n- Look at how /compact command is handled\n- Look at how /new command is handled\n\n### Testing\n- Verify command appears in slash command popup\n- Verify command sends correct Op\n\n### Reference\n- Existing slash commands for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:54.035096396+01:00","updated_at":"2025-12-20T20:38:04.722426832+01:00","closed_at":"2025-12-20T20:38:04.722426832+01:00","dependencies":[{"issue_id":"codex-92f.5","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:54.035405565+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.5","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:19.527512561+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.6","title":"Implement TUI handoff draft review screen","description":"## Handoff Draft Review Screen\n\nCreate a review screen in TUI that shows the extracted handoff draft for user review before confirming.\n\n### UI Design\nWhen `EventMsg::HandoffDraft` is received, show a review screen:\n\n```\n┌─────────────────────────────────────────────────────┐\n│ Handoff to new thread                               │\n├─────────────────────────────────────────────────────┤\n│ Goal: implement for teams                           │\n├─────────────────────────────────────────────────────┤\n│ Extracted Context:                                  │\n│ ─────────────────                                   │\n│ - I implemented user authentication with JWT        │\n│ - I'm using the auth-lib crate for token validation │\n│ - The login endpoint is at src/api/auth.rs          │\n│ - Need to add team-based permissions next           │\n│                                                     │\n├─────────────────────────────────────────────────────┤\n│ Relevant Files:                                     │\n│ ─────────────────                                   │\n│ • src/api/auth.rs                                   │\n│ • src/models/user.rs                                │\n│ • src/lib.rs                                        │\n│                                                     │\n├─────────────────────────────────────────────────────┤\n│ [Enter] Confirm  [Esc] Cancel                       │\n└─────────────────────────────────────────────────────┘\n```\n\n### MVP: Read-only review\n- Show summary text (scrollable if long)\n- Show file list\n- Show goal\n- Enter to confirm, Esc to cancel\n- No editing in MVP\n\n### Key bindings\n- `Enter` → Submit `Op::ConfirmHandoff { draft }`\n- `Esc` → Submit `Op::CancelHandoff`, return to chat\n\n### State management\nNeed to track:\n- `pending_handoff_draft: Option\u003cHandoffDraft\u003e`\n- When draft received, switch to review mode\n- When confirmed/cancelled, clear and switch back\n\n### Files to create/modify\n- `tui/src/handoff_review.rs` - new widget/component\n- `tui/src/app.rs` - handle EventMsg::HandoffDraft, manage state\n- `tui/src/lib.rs` or `tui/src/mod.rs` - add module\n\n### Pattern to follow\n- Look at `tui/src/bottom_pane/command_popup.rs` for modal patterns\n- Look at approval request handling for similar confirm/cancel flow\n\n### Styling\nFollow tui/styles.md conventions:\n- Use \".dim()\" for labels\n- Use standard borders\n- Keep it clean and readable\n\n### Testing\n- Snapshot test for draft review rendering\n- Test key handling (Enter/Esc)\n\n### Reference\n- Amp shows draft as editable before sending\n- MVP: read-only is fine","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:13.894665918+01:00","updated_at":"2025-12-20T20:45:55.859339608+01:00","closed_at":"2025-12-20T20:45:55.859339608+01:00","dependencies":[{"issue_id":"codex-92f.6","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:13.895040913+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.6","depends_on_id":"codex-92f.5","type":"blocks","created_at":"2025-12-20T20:06:19.535012747+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.7","title":"Handle session switch after handoff confirmation","description":"## Session Switch After Handoff\n\nWhen handoff is confirmed and new session is created, TUI needs to switch to the new session.\n\n### Flow\n1. User confirms handoff draft\n2. TUI sends `Op::ConfirmHandoff { draft }`\n3. Core creates new session via ConversationManager\n4. Core emits `EventMsg::HandoffCompleted { new_session_id }`\n5. TUI receives event\n6. TUI switches active session to new_session_id\n7. New session starts with context + goal already submitted\n\n### TUI State Changes\nIn app.rs or session management:\n```rust\nEventMsg::HandoffCompleted(event) =\u003e {\n    // 1. Clear handoff review state\n    self.pending_handoff_draft = None;\n    \n    // 2. Switch to new session\n    self.switch_to_session(event.new_session_id).await?;\n    \n    // 3. Clear chat history display (new session has its own)\n    self.clear_message_display();\n    \n    // 4. The new session's first turn is already running\n    //    (goal was submitted as part of handoff)\n}\n```\n\n### Auto-submit goal\nThe new session should automatically have the goal submitted as the first user message. This happens in `create_handoff_conversation` - the goal is part of the initial history.\n\nThe new session should immediately start processing (like a resume with a pending message).\n\n### Parent session handling\nAfter handoff, what happens to parent session?\n- Option A: Close parent session\n- Option B: Keep parent available (user can /resume it)\n\nRecommendation: Option B - keep parent. User may want to go back. The handoff is recorded in parent's rollout.\n\n### Files to modify\n- `tui/src/app.rs` - handle HandoffCompleted event\n- May need session switching logic if not already present\n\n### Pattern to follow\n- Look at how /new starts a new session\n- Look at how /resume switches sessions\n\n### Testing\n- Integration test: confirm handoff, verify session switch\n- Verify parent session still accessible via /resume\n\n### Reference\n- Amp creates new thread, original remains","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:32.308769081+01:00","updated_at":"2025-12-20T20:49:30.530796988+01:00","closed_at":"2025-12-20T20:49:30.530796988+01:00","dependencies":[{"issue_id":"codex-92f.7","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:32.309090314+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.7","depends_on_id":"codex-92f.6","type":"blocks","created_at":"2025-12-20T20:06:19.541408226+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.7","depends_on_id":"codex-92f.4","type":"blocks","created_at":"2025-12-20T20:06:19.548070715+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.8","title":"Record handoff in rollout files","description":"## Rollout Traceability for Handoff\n\nEnsure handoff creates proper audit trail in rollout files for both parent and child sessions.\n\n### Parent Rollout\nWhen handoff completes, add to parent's rollout:\n```json\n{\"type\": \"handoff\", \"child_id\": \"abc-123\", \"goal\": \"implement for teams\", \"timestamp\": \"2025-01-15T10:30:00Z\"}\n```\n\n### Child Rollout Metadata\nChild session's rollout should have:\n```json\n{\n  \"source\": {\n    \"type\": \"handoff\", \n    \"parent_id\": \"xyz-789\", \n    \"goal\": \"implement for teams\"\n  },\n  \"id\": \"abc-123\",\n  \"timestamp\": \"...\",\n  \"cwd\": \"...\",\n  ...\n}\n```\n\n### RolloutItem Extension\nAdd new rollout item type:\n```rust\npub enum RolloutItem {\n    // ... existing ...\n    Handoff(HandoffRolloutItem),\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HandoffRolloutItem {\n    pub child_id: ConversationId,\n    pub goal: String,\n    pub timestamp: String,\n}\n```\n\n### SessionMeta Extension\nEnsure SessionMeta supports handoff source:\n```rust\npub enum SessionSource {\n    Cli,\n    Tui,\n    AppServer,\n    Handoff { parent_id: ConversationId, goal: String },\n}\n```\n\n### Recording Points\n1. In `Op::ConfirmHandoff` handler, after creating child session:\n   - Persist HandoffRolloutItem to parent's rollout\n2. In `RolloutRecorder::new` for child session:\n   - Serialize SessionSource::Handoff to metadata\n\n### Files to modify\n- `protocol/src/protocol.rs` - RolloutItem variant (if not already)\n- `core/src/rollout/recorder.rs` - handle handoff source in metadata\n- `core/src/codex.rs` - persist handoff item when confirming\n\n### Pattern to follow\n- Look at how CompactedItem is recorded\n- Look at SessionMeta serialization\n\n### Testing\n- Verify parent rollout contains handoff item\n- Verify child rollout has correct source metadata\n- Test rollout replay with handoff items\n\n### Use Case\nThis enables:\n- Tracing conversation lineage\n- Future: navigate to parent from child\n- Future: read_parent_thread tool\n\n### Reference\n- Amp tracks thread relationships with parent/child links","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:51.80215288+01:00","updated_at":"2025-12-20T20:38:04.728926918+01:00","closed_at":"2025-12-20T20:38:04.728926918+01:00","dependencies":[{"issue_id":"codex-92f.8","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:51.802548605+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.8","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:19.564872423+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q","title":"Agent-routed custom prompts (Option C)","description":"## Overview\n\nExtend the existing custom prompts system (`~/.codex/prompts/*.md`) to support agent routing. When a prompt has an `agent` field in its frontmatter, it becomes an 'agent command' that delegates execution to a subagent via the task tool.\n\n## Goals\n\n1. Add `agent: Option\u003cString\u003e` field to `CustomPrompt` struct\n2. Parse the `agent` field from frontmatter during prompt discovery\n3. Validate that referenced agents exist in the subagent registry\n4. Route agent-enabled prompts through the task tool instead of inline submission\n5. Maintain full backward compatibility with existing prompts\n\n## Design (Option C: Unified with Mode Detection)\n\n**Behavior:**\n- If `agent` is set → always run as subtask via task tool\n- If no `agent` → pure text expansion (current behavior)\n- No separate `subtask` field needed - presence of `agent` determines behavior\n\n**Example prompt file (`~/.codex/prompts/explore.md`):**\n```markdown\n---\ndescription: Fast codebase exploration\nagent: explorer\n---\nFind files matching $1 and explain their purpose.\n```\n\n## Success Criteria\n\n- Prompts without `agent` work exactly as before\n- Prompts with `agent` execute via task tool delegation\n- Invalid agent references produce clear error messages at load time\n- TUI popup shows agent-enabled prompts distinctly (optional enhancement)\n\n## References\n\n- OpenCode's task.ts: `third-party/opencode/packages/opencode/src/tool/task.ts`\n- Existing prompt system: `core/src/custom_prompts.rs`\n- Task tool handler: `core/src/tools/handlers/task.rs`\n- Subagent registry: `core/src/subagents.rs`","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-13T12:12:37.062374714+01:00","updated_at":"2025-12-13T20:38:29.833200397+01:00","closed_at":"2025-12-13T20:38:29.833200397+01:00"}
{"id":"codex-96q.1","title":"Add agent field to CustomPrompt struct","description":"## What\n\nAdd an optional `agent` field to the `CustomPrompt` struct in the protocol crate.\n\n## Why\n\nThis field will indicate which subagent should handle the prompt execution. Its presence determines whether the prompt is a simple text expansion or an agent-routed command.\n\n## How\n\n### File: `protocol/src/custom_prompts.rs`\n\n```rust\n#[derive(Serialize, Deserialize, Debug, Clone, JsonSchema, TS)]\npub struct CustomPrompt {\n    pub name: String,\n    pub path: PathBuf,\n    pub content: String,\n    pub description: Option\u003cString\u003e,\n    pub argument_hint: Option\u003cString\u003e,\n    /// Subagent slug to route this prompt to. When set, the prompt\n    /// will be executed via the task tool instead of inline submission.\n    pub agent: Option\u003cString\u003e,\n}\n```\n\n### Add helper method\n\n```rust\nimpl CustomPrompt {\n    /// Returns true if this prompt should be delegated to an agent.\n    pub fn is_agent_command(\u0026self) -\u003e bool {\n        self.agent.is_some()\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `agent: Option\u003cString\u003e` field added to `CustomPrompt`\n- [ ] `is_agent_command()` helper method implemented\n- [ ] TypeScript types regenerated (if using ts-rs)\n- [ ] Existing tests still pass\n- [ ] `cargo test -p codex-protocol` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:01.387080446+01:00","updated_at":"2025-12-13T12:25:09.133976456+01:00","closed_at":"2025-12-13T12:25:09.133976456+01:00","dependencies":[{"issue_id":"codex-96q.1","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:01.38752217+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.2","title":"Parse agent field from frontmatter","description":"## What\n\nUpdate the frontmatter parser in `core/src/custom_prompts.rs` to extract the `agent` field.\n\n## Why\n\nThe `agent` field needs to be parsed from the YAML frontmatter so that the TUI can determine how to handle the prompt.\n\n## How\n\n### File: `core/src/custom_prompts.rs`\n\nUpdate `parse_frontmatter()` function to return the agent field:\n\n```rust\n/// Parse optional YAML-like frontmatter at the beginning of `content`.\n/// Supported keys:\n/// - `description`: short description shown in the slash popup\n/// - `argument-hint` or `argument_hint`: brief hint string\n/// - `agent`: subagent slug to route execution to\n/// Returns (description, argument_hint, agent, body_without_frontmatter).\nfn parse_frontmatter(content: \u0026str) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e, Option\u003cString\u003e, String) {\n    // ... existing logic ...\n    \n    match key.as_str() {\n        \"description\" =\u003e desc = Some(val),\n        \"argument-hint\" | \"argument_hint\" =\u003e hint = Some(val),\n        \"agent\" =\u003e agent = Some(val),  // NEW\n        _ =\u003e {}\n    }\n    \n    // ...\n    (desc, hint, agent, body)\n}\n```\n\n### Update `discover_prompts_in_excluding()`\n\nPass the parsed `agent` field to `CustomPrompt`:\n\n```rust\nlet (description, argument_hint, agent, body) = parse_frontmatter(\u0026content);\nout.push(CustomPrompt {\n    name,\n    path,\n    content: body,\n    description,\n    argument_hint,\n    agent,  // NEW\n});\n```\n\n## Acceptance Criteria\n\n- [ ] `parse_frontmatter()` returns 4-tuple including `agent`\n- [ ] `discover_prompts_in_excluding()` populates `agent` field\n- [ ] Add test for parsing agent from frontmatter\n- [ ] Existing frontmatter tests still pass\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:14.962714261+01:00","updated_at":"2025-12-13T12:25:09.150284906+01:00","closed_at":"2025-12-13T12:25:09.150284906+01:00","dependencies":[{"issue_id":"codex-96q.2","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:14.963038731+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.2","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.377098701+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.3","title":"Add SubmitAgentPrompt event to AppEvent","description":"## What\n\nAdd a new `AppEvent` variant for submitting agent-routed prompts.\n\n## Why\n\nThe TUI needs a way to signal that a prompt should be executed via the task tool rather than as a normal user message. This event will carry the expanded prompt content and target agent.\n\n## How\n\n### File: `tui/src/app_event.rs`\n\nAdd new variant:\n\n```rust\n#[derive(Debug)]\npub(crate) enum AppEvent {\n    // ... existing variants ...\n    \n    /// Submit a prompt to be executed by a specific subagent via the task tool.\n    /// This is triggered when a custom prompt has an `agent` field set.\n    SubmitAgentPrompt {\n        /// Short description for the task (typically the prompt name).\n        description: String,\n        /// The fully expanded prompt content to send to the agent.\n        prompt: String,\n        /// The subagent slug to route the task to.\n        agent: String,\n    },\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `SubmitAgentPrompt` variant added to `AppEvent`\n- [ ] Fields: `description`, `prompt`, `agent`\n- [ ] Compiles without errors\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:25.308996879+01:00","updated_at":"2025-12-13T12:25:09.156970512+01:00","closed_at":"2025-12-13T12:25:09.156970512+01:00","dependencies":[{"issue_id":"codex-96q.3","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:25.309333181+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.4","title":"Update ChatComposer to detect and route agent prompts","description":"## What\n\nModify `ChatComposer` to check if an expanded prompt has an `agent` field and emit the appropriate event.\n\n## Why\n\nThis is the core routing logic. When a user invokes a prompt with an `agent` field, instead of returning `InputResult::Submitted(text)`, we need to emit `SubmitAgentPrompt` event.\n\n## How\n\n### File: `tui/src/bottom_pane/chat_composer.rs`\n\n#### Option A: New InputResult variant (cleaner)\n\nAdd a new variant to `InputResult`:\n\n```rust\npub enum InputResult {\n    Submitted(String),\n    Command(SlashCommand),\n    AgentPrompt {\n        description: String,\n        prompt: String,\n        agent: String,\n    },\n    None,\n}\n```\n\n#### Update prompt expansion logic\n\nIn the Enter key handler where custom prompts are expanded:\n\n```rust\n// After expanding the prompt...\nif let Some(expanded) = expand_custom_prompt(first_line, \u0026self.custom_prompts) {\n    self.textarea.set_text(\"\");\n    \n    // Check if this is an agent-routed prompt\n    if let Some(agent) = prompt.agent.as_ref() {\n        return (\n            InputResult::AgentPrompt {\n                description: prompt.name.clone(),\n                prompt: expanded,\n                agent: agent.clone(),\n            },\n            true,\n        );\n    }\n    \n    // Normal text expansion (existing behavior)\n    return (InputResult::Submitted(expanded), true);\n}\n```\n\n#### Key insight\n\nThe `CustomPrompt` struct is already available in the composer via `self.custom_prompts`. After matching the prompt by name, check its `agent` field before deciding the return type.\n\n## Acceptance Criteria\n\n- [ ] `InputResult::AgentPrompt` variant added (or similar mechanism)\n- [ ] Prompts with `agent` field return `AgentPrompt` result\n- [ ] Prompts without `agent` field work as before\n- [ ] Snapshot tests updated if needed\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:39.306812294+01:00","updated_at":"2025-12-13T12:25:09.163272588+01:00","closed_at":"2025-12-13T12:25:09.163272588+01:00","dependencies":[{"issue_id":"codex-96q.4","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:39.307184735+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.386700154+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.2","type":"blocks","created_at":"2025-12-13T12:15:14.395294075+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.3","type":"blocks","created_at":"2025-12-13T12:15:14.405516864+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.5","title":"Handle SubmitAgentPrompt in App","description":"## What\n\nHandle the new `SubmitAgentPrompt` event (or `InputResult::AgentPrompt`) in the App layer to invoke the task tool.\n\n## Why\n\nThe App layer is responsible for translating UI events into core operations. When an agent prompt is submitted, we need to construct and send the appropriate operation to invoke the task tool.\n\n## How\n\n### File: `tui/src/app.rs`\n\nAdd handler for the new event/result:\n\n```rust\n// In handle_app_event() or equivalent:\nAppEvent::SubmitAgentPrompt { description, prompt, agent } =\u003e {\n    // Construct a user message that will trigger the task tool\n    // The task tool expects: description, prompt, subagent_type, session_id\n    \n    // Option 1: Synthesize a function call directly (complex)\n    // Option 2: Submit as a special user message that core interprets\n    // Option 3: Create a new Op variant for agent prompts\n    \n    // Recommended: Use Op::UserInput with a structured message that\n    // the model will interpret as a task delegation request\n    let task_request = format!(\n        \"Please delegate this task to the {} agent:\\n\\n{}\\n\\nTask description: {}\",\n        agent, prompt, description\n    );\n    \n    self.submit_user_message(task_request);\n}\n```\n\n### Alternative: Direct task tool invocation\n\nIf we want guaranteed routing (not relying on model interpretation):\n\n```rust\n// Create a synthetic function call for the task tool\nlet task_args = serde_json::json!({\n    \"description\": description,\n    \"prompt\": prompt,\n    \"subagent_type\": agent,\n});\n\n// This would require exposing task tool invocation from core\nself.invoke_task_tool(task_args);\n```\n\n### Considerations\n\n- **Option 1 (Prompt-based)**: Simpler, but relies on model understanding\n- **Option 2 (Direct invocation)**: Deterministic, but requires core changes\n\nRecommend starting with Option 1 for simplicity, with Option 2 as a future enhancement.\n\n## Acceptance Criteria\n\n- [ ] `SubmitAgentPrompt` event handled in App\n- [ ] Agent prompts trigger task delegation\n- [ ] User sees appropriate feedback in chat\n- [ ] Error handling for unknown agents\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:56.036505571+01:00","updated_at":"2025-12-13T12:25:09.170122158+01:00","closed_at":"2025-12-13T12:25:09.170122158+01:00","dependencies":[{"issue_id":"codex-96q.5","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:56.036879856+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.5","depends_on_id":"codex-96q.4","type":"blocks","created_at":"2025-12-13T12:15:14.414837571+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.6","title":"Validate agent references at prompt load time","description":"## What\n\nWhen loading custom prompts, validate that any `agent` field references an existing subagent.\n\n## Why\n\nEarly validation provides clear error messages and prevents runtime failures. Users should know immediately if their prompt references a non-existent agent.\n\n## How\n\n### Option A: Validation during discovery (recommended)\n\nAdd a validation function that checks prompts against the subagent registry:\n\n```rust\n// core/src/custom_prompts.rs\n\npub struct PromptLoadOutcome {\n    pub prompts: Vec\u003cCustomPrompt\u003e,\n    pub errors: Vec\u003cPromptLoadError\u003e,\n}\n\npub struct PromptLoadError {\n    pub path: PathBuf,\n    pub message: String,\n}\n\n/// Validate that all agent references in prompts exist in the registry.\npub fn validate_prompts(\n    prompts: \u0026[CustomPrompt],\n    agent_slugs: \u0026HashSet\u003cString\u003e,\n) -\u003e Vec\u003cPromptLoadError\u003e {\n    prompts\n        .iter()\n        .filter_map(|p| {\n            if let Some(ref agent) = p.agent {\n                if !agent_slugs.contains(agent) {\n                    return Some(PromptLoadError {\n                        path: p.path.clone(),\n                        message: format!(\n                            \"Agent '{}' not found. Available agents: {:?}\",\n                            agent,\n                            agent_slugs.iter().collect::\u003cVec\u003c_\u003e\u003e()\n                        ),\n                    });\n                }\n            }\n            None\n        })\n        .collect()\n}\n```\n\n### Integration point\n\nCall validation after loading prompts and subagents in the session initialization:\n\n```rust\nlet prompts = discover_prompts_in(\u0026prompts_dir).await;\nlet agents = SubagentRegistry::new(\u0026codex_home);\nlet agent_slugs: HashSet\u003c_\u003e = agents.list().iter().map(|a| a.slug.clone()).collect();\nlet errors = validate_prompts(\u0026prompts, \u0026agent_slugs);\n\nif !errors.is_empty() {\n    for err in \u0026errors {\n        warn!(\"Prompt validation error in {}: {}\", err.path.display(), err.message);\n    }\n}\n```\n\n### UI feedback\n\nOptionally show validation errors in the TUI status line or as a warning message.\n\n## Acceptance Criteria\n\n- [ ] `validate_prompts()` function implemented\n- [ ] Invalid agent references logged as warnings\n- [ ] Prompts with invalid agents still load (soft failure)\n- [ ] Clear error messages with available agent list\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T12:14:11.549891789+01:00","updated_at":"2025-12-13T12:25:09.176487394+01:00","closed_at":"2025-12-13T12:25:09.176487394+01:00","dependencies":[{"issue_id":"codex-96q.6","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:11.550219995+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.7","title":"Visual indicator for agent prompts in popup","description":"## What\n\nShow a visual indicator in the slash command popup to distinguish agent-routed prompts from regular text prompts.\n\n## Why\n\nUsers should be able to see at a glance which prompts will delegate to an agent vs. which will expand inline. This helps set expectations about behavior.\n\n## How\n\n### File: `tui/src/bottom_pane/command_popup.rs`\n\nUpdate the rendering to show agent indicator:\n\n```rust\n// When rendering CommandItem::UserPrompt:\nlet agent_indicator = match \u0026prompt.agent {\n    Some(agent) =\u003e format!(\" @{}\", agent).dim(),\n    None =\u003e Span::raw(\"\"),\n};\n\n// Build the line:\nlet line = Line::from(vec![\n    \"/prompts:\".dim(),\n    prompt.name.as_str().into(),\n    agent_indicator,\n    \" - \".dim(),\n    prompt.description.as_deref().unwrap_or(\"\").dim(),\n]);\n```\n\n### Example display\n\n```\n/prompts:review - review my current changes\n/prompts:explore @explorer - fast codebase exploration\n/prompts:commit - git commit helper\n```\n\n### Alternative: Icon-based\n\n```\n/prompts:review - review my current changes\n/prompts:explore 🤖 - fast codebase exploration\n/prompts:commit - git commit helper\n```\n\n## Acceptance Criteria\n\n- [ ] Agent prompts show indicator (e.g., `@agent` or icon)\n- [ ] Non-agent prompts display unchanged\n- [ ] Indicator is visually distinct but not distracting\n- [ ] Snapshot tests updated\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-13T12:14:24.914988828+01:00","updated_at":"2025-12-13T12:25:09.182068734+01:00","closed_at":"2025-12-13T12:25:09.182068734+01:00","dependencies":[{"issue_id":"codex-96q.7","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:24.915312997+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.8","title":"Add tests for agent-routed prompts","description":"## What\n\nAdd comprehensive tests for the agent-routed prompts feature.\n\n## Why\n\nTests ensure the feature works correctly and prevent regressions.\n\n## How\n\n### Protocol tests (`protocol/src/custom_prompts.rs`)\n\n```rust\n#[test]\nfn custom_prompt_is_agent_command() {\n    let prompt = CustomPrompt {\n        name: \"test\".to_string(),\n        path: PathBuf::from(\"/test.md\"),\n        content: \"test\".to_string(),\n        description: None,\n        argument_hint: None,\n        agent: Some(\"explorer\".to_string()),\n    };\n    assert!(prompt.is_agent_command());\n    \n    let regular = CustomPrompt {\n        agent: None,\n        ..prompt.clone()\n    };\n    assert!(!regular.is_agent_command());\n}\n```\n\n### Core tests (`core/src/custom_prompts.rs`)\n\n```rust\n#[tokio::test]\nasync fn parses_agent_from_frontmatter() {\n    let tmp = tempdir().expect(\"create TempDir\");\n    let dir = tmp.path();\n    let file = dir.join(\"explore.md\");\n    let text = \"---\\ndescription: Fast search\\nagent: explorer\\n---\\nFind files matching $1\";\n    fs::write(\u0026file, text).unwrap();\n\n    let found = discover_prompts_in(dir).await;\n    assert_eq!(found.len(), 1);\n    let p = \u0026found[0];\n    assert_eq!(p.name, \"explore\");\n    assert_eq!(p.agent.as_deref(), Some(\"explorer\"));\n}\n\n#[tokio::test]\nasync fn prompt_without_agent_has_none() {\n    let tmp = tempdir().expect(\"create TempDir\");\n    let dir = tmp.path();\n    fs::write(dir.join(\"simple.md\"), \"Just a prompt\").unwrap();\n\n    let found = discover_prompts_in(dir).await;\n    assert_eq!(found.len(), 1);\n    assert!(found[0].agent.is_none());\n}\n```\n\n### TUI tests (`tui/src/bottom_pane/chat_composer.rs`)\n\n```rust\n#[test]\nfn agent_prompt_returns_agent_result() {\n    // Setup composer with custom prompt that has agent field\n    // Simulate Enter on /prompts:explore foo\n    // Assert InputResult::AgentPrompt is returned\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Protocol: `is_agent_command()` test\n- [ ] Core: frontmatter parsing tests for agent field\n- [ ] Core: validation tests for invalid agent references\n- [ ] TUI: routing test for agent prompts\n- [ ] All tests pass: `cargo test -p codex-protocol -p codex-core -p codex-tui`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:14:41.516619731+01:00","updated_at":"2025-12-13T12:25:09.187998048+01:00","closed_at":"2025-12-13T12:25:09.187998048+01:00","dependencies":[{"issue_id":"codex-96q.8","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:41.516958158+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.8","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.426965733+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.8","depends_on_id":"codex-96q.2","type":"blocks","created_at":"2025-12-13T12:15:14.436293885+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.9","title":"Update documentation for agent prompts","description":"## What\n\nUpdate user documentation to explain the new agent-routed prompts feature.\n\n## Why\n\nUsers need to know how to create and use agent-routed prompts.\n\n## How\n\n### Update or create: `docs/custom-prompts.md`\n\nAdd section explaining agent routing:\n\n```markdown\n## Agent-Routed Prompts\n\nYou can create prompts that automatically delegate to a specific subagent.\nAdd an \\`agent\\` field to your frontmatter:\n\n\\`\\`\\`markdown\n---\ndescription: Fast codebase exploration\nagent: explorer\n---\nFind files matching $1 and explain their purpose.\n\\`\\`\\`\n\nWhen you invoke this prompt with \\`/prompts:explore src/*.rs\\`, it will:\n1. Expand the template with your arguments\n2. Delegate the task to the \\`explorer\\` subagent\n3. Return the subagent's response\n\n### Available Agents\n\nSee your configured agents in \\`~/.codex/agents/\\`.\n\n### When to Use\n\n- Use agent prompts for complex, multi-step tasks\n- Use regular prompts for simple text expansion\n- Agent prompts show \\`@agent\\` indicator in the popup\n\\`\\`\\`\n\n### Update: `docs/agents.md`\n\nCross-reference the agent prompts feature.\n\n## Acceptance Criteria\n\n- [ ] Documentation explains agent field usage\n- [ ] Examples provided for common use cases\n- [ ] Cross-references to agents documentation\n- [ ] Available agents discovery mentioned","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T12:14:54.056510028+01:00","updated_at":"2025-12-13T12:25:09.193806633+01:00","closed_at":"2025-12-13T12:25:09.193806633+01:00","dependencies":[{"issue_id":"codex-96q.9","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:54.056985958+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-972","title":"Remove parallel instruction injection and clean orphaned code","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T11:26:44.628791124+01:00","updated_at":"2025-12-15T11:35:37.302540337+01:00","closed_at":"2025-12-15T11:35:37.302540337+01:00"}
{"id":"codex-972.1","title":"Remove PARALLEL_INSTRUCTIONS injection from client_common.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:26:55.141615909+01:00","updated_at":"2025-12-15T11:35:16.039596865+01:00","closed_at":"2025-12-15T11:35:16.039596865+01:00","dependencies":[{"issue_id":"codex-972.1","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:26:55.142152042+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.2","title":"Remove allows_instruction_modifications field from ModelFamily","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:05.770248765+01:00","updated_at":"2025-12-15T11:35:26.154475186+01:00","closed_at":"2025-12-15T11:35:26.154475186+01:00","dependencies":[{"issue_id":"codex-972.2","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:05.770664669+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.3","title":"Delete templates/parallel/instructions.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:16.065704017+01:00","updated_at":"2025-12-15T11:35:10.981879171+01:00","closed_at":"2025-12-15T11:35:10.981879171+01:00","dependencies":[{"issue_id":"codex-972.3","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:16.066171138+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.4","title":"Search and remove orphaned parallel/sequential branching code","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:26.759441599+01:00","updated_at":"2025-12-15T11:35:21.09742754+01:00","closed_at":"2025-12-15T11:35:21.09742754+01:00","dependencies":[{"issue_id":"codex-972.4","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:26.759885466+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.5","title":"Test gpt-5.1, gpt-5.2, and codex models after cleanup","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:38.299661973+01:00","updated_at":"2025-12-15T11:35:05.926877604+01:00","closed_at":"2025-12-15T11:35:05.926877604+01:00","dependencies":[{"issue_id":"codex-972.5","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:38.300124946+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-9kr","title":"Unify review as task/subagent","description":"Unify the /review feature with the task/subagent system so that:\n1. Agent can invoke review via task tool (not just users)\n2. Both user /review and agent task(review) use the same prompt/policies\n3. Reduce code duplication between ReviewTask and task handler\n\nThree phases:\n- Phase 1: Create review.md subagent (enables agent access immediately)\n- Phase 2: Update ReviewTask to load from SubagentRegistry (unify definition source)  \n- Phase 3: Full unification - remove Op::Review and ReviewTask entirely\n\nDesign doc: Oracle recommended keeping Op::Review for Phase 2 due to TUI coupling, but Phase 3 removes it.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T14:10:36.259658275+01:00","updated_at":"2025-12-15T16:04:36.428775116+01:00","closed_at":"2025-12-15T16:04:36.428775116+01:00"}
{"id":"codex-9kr.1","title":"Create review.md subagent file","description":"Create ~/.codex/agents/review.md with:\n- YAML frontmatter: name, description, profile: inherit, sandbox_policy: read-only, approval_policy: never, allowed_subagents: []\n- Body: content from core/review_prompt.md\n- Add comment warning that JSON output format is required for TUI compatibility\n\nThis immediately enables agent to call task(subagent_type='review', prompt='\u003cdiff\u003e')\n\nFiles to reference:\n- core/review_prompt.md (source content)\n- ~/.codex/agents/oracle.md (example format)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:10:51.694652174+01:00","updated_at":"2025-12-15T14:16:44.709028672+01:00","closed_at":"2025-12-15T14:16:44.709028672+01:00","dependencies":[{"issue_id":"codex-9kr.1","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:10:51.694968969+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.10","title":"Update app-server review API to use DelegateSubagent","description":"Update app-server to use Op::DelegateSubagent for review:\n\n1. Modify app-server/src/codex_message_processor.rs review_start() \n2. Instead of Op::Review, emit Op::DelegateSubagent\n3. Update tests in app-server/tests/suite/v2/review.rs\n4. May need to update app-server-protocol types\n\nConsider backwards compatibility - existing API clients may expect ReviewStartResponse.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:00.619785448+01:00","updated_at":"2025-12-15T15:46:10.101396072+01:00","closed_at":"2025-12-15T15:46:10.101396072+01:00","dependencies":[{"issue_id":"codex-9kr.10","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:00.620114387+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.10","depends_on_id":"codex-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.742613814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.11","title":"Cleanup unused review types from protocol","description":"Remove unused review-related types after migration:\n\n1. Review which types are still needed:\n   - ReviewRequest - may still be used by review_prompts.rs\n   - ReviewTarget - may still be used\n   - ReviewDelivery - check if needed\n   - ReviewOutputEvent - may be used by TUI parsing\n   - ExitedReviewModeEvent - should be removed\n   \n2. Remove truly unused types from protocol/src/protocol.rs\n3. Update any remaining imports\n\nRun after all other Phase 3 tasks complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:18.206529477+01:00","updated_at":"2025-12-15T15:46:56.477464172+01:00","closed_at":"2025-12-15T15:46:56.477464172+01:00","dependencies":[{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:18.207056684+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr.9","type":"blocks","created_at":"2025-12-15T14:12:50.751121687+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr.10","type":"blocks","created_at":"2025-12-15T14:12:50.757716555+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.12","title":"Update tests after full review unification","description":"Update all tests affected by review unification:\n\n1. core/tests/suite/review.rs - update or remove Op::Review tests\n2. tui/src/chatwidget/tests.rs - update /review flow tests\n3. tui2/src/chatwidget/tests.rs - same\n4. app-server/tests/suite/v2/review.rs - update API tests\n5. Any snapshot tests that may have changed\n\nRun full test suite: cargo test --all-features","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:24.132550543+01:00","updated_at":"2025-12-15T16:04:03.730434461+01:00","closed_at":"2025-12-15T16:04:03.730434461+01:00","dependencies":[{"issue_id":"codex-9kr.12","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:24.132961548+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.12","depends_on_id":"codex-9kr.11","type":"blocks","created_at":"2025-12-15T14:12:50.764087215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.2","title":"Update task tool description to include review","description":"Update the task tool's generated description in core/src/tools/handlers/task.rs to mention the review subagent.\n\nThe tool description is dynamically generated from SubagentRegistry.list(). Since review.md will be loaded, it should automatically appear. Verify this works correctly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:10:57.217103789+01:00","updated_at":"2025-12-15T14:17:06.590975268+01:00","closed_at":"2025-12-15T14:17:06.590975268+01:00","dependencies":[{"issue_id":"codex-9kr.2","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:10:57.217401047+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.3","title":"Add review subagent integration test","description":"Add test in core/tests/ to verify:\n1. Agent can invoke task(subagent_type='review', prompt='...') \n2. Review subagent loads correctly from registry\n3. Output is returned properly\n\nReference existing subagent tests in core/tests/ for patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:02.317112673+01:00","updated_at":"2025-12-15T14:17:52.339367052+01:00","closed_at":"2025-12-15T14:17:52.339367052+01:00","dependencies":[{"issue_id":"codex-9kr.3","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:02.317466489+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.4","title":"Update ReviewTask to load prompt from SubagentRegistry","description":"Modify core/src/tasks/review.rs to:\n1. Attempt to load 'review' subagent from SubagentRegistry\n2. If found: use its system_prompt and policies (sandbox_policy, approval_policy)\n3. If not found: fallback to hardcoded REVIEW_PROMPT (backwards compat)\n\nThis unifies the prompt source - both /review (user) and task(review) (agent) use same definition.\n\nKey changes:\n- Add SubagentRegistry lookup in start_review_conversation()\n- Use subagent's system_prompt as base_instructions if available\n- Respect subagent's sandbox_policy and approval_policy\n\nKeep Op::Review and ExitedReviewModeEvent - TUI still needs them.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:11.018903647+01:00","updated_at":"2025-12-15T14:30:50.570232143+01:00","closed_at":"2025-12-15T14:30:50.570232143+01:00","dependencies":[{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:11.019273924+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr.1","type":"blocks","created_at":"2025-12-15T14:12:50.687699932+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr.2","type":"blocks","created_at":"2025-12-15T14:12:50.695450488+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.5","title":"Add test for ReviewTask registry loading","description":"Add tests to verify ReviewTask correctly:\n1. Loads from SubagentRegistry when review.md exists\n2. Falls back to REVIEW_PROMPT when review.md is missing\n3. Respects policies from subagent definition\n\nAdd to core/tests/suite/review.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:18.751001758+01:00","updated_at":"2025-12-15T14:31:07.503168654+01:00","closed_at":"2025-12-15T14:31:07.503168654+01:00","dependencies":[{"issue_id":"codex-9kr.5","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:18.751354872+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.5","depends_on_id":"codex-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.7023669+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.6","title":"Update TUI to use Op::DelegateSubagent for /review","description":"Modify TUI /review flow to emit Op::DelegateSubagent instead of Op::Review:\n\n1. Keep ReviewPopup (branch/commit/custom picker) - user still selects target\n2. Use review_prompts.rs to build the diff prompt (git diff, commit show, etc.)\n3. Instead of Op::Review, emit:\n   Op::DelegateSubagent {\n       agent: 'review',\n       prompt: '\u003cbuilt diff prompt\u003e',\n       description: '\u003cuser-facing hint\u003e',\n   }\n\nFiles to modify:\n- tui/src/chatwidget.rs (dispatch_command, review popup handling)\n- tui2/src/chatwidget.rs (same changes)\n\nKeep review_prompts.rs - still needed for building the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:27.691336026+01:00","updated_at":"2025-12-15T15:06:25.521132815+01:00","closed_at":"2025-12-15T15:06:25.521132815+01:00","dependencies":[{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:27.69173559+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.70883699+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr.5","type":"blocks","created_at":"2025-12-15T14:12:50.715400459+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.7","title":"Handle review output parsing in TUI SubagentEvent","description":"Update TUI to parse ReviewOutputEvent from SubagentEvent when agent is 'review':\n\n1. When receiving TaskComplete for 'review' subagent, attempt to parse output as JSON ReviewOutputEvent\n2. If valid JSON: render using existing review findings format (render_review_output_text)\n3. If not valid JSON: render as plain markdown\n\nThis replaces ExitedReviewModeEvent handling with SubagentEvent-based detection.\n\nFiles to modify:\n- tui/src/chatwidget.rs\n- tui2/src/chatwidget.rs  \n- Possibly tui/src/history_cell.rs for rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:35.292380316+01:00","updated_at":"2025-12-15T15:17:05.630380288+01:00","closed_at":"2025-12-15T15:17:05.630380288+01:00","dependencies":[{"issue_id":"codex-9kr.7","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:35.292739082+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.7","depends_on_id":"codex-9kr.6","type":"blocks","created_at":"2025-12-15T14:12:50.723307193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.8","title":"Remove Op::Review from protocol","description":"Remove Op::Review variant from protocol/src/protocol.rs:\n\n1. Remove Op::Review { review_request: ReviewRequest } variant\n2. Keep ReviewRequest, ReviewTarget, ReviewDelivery types if still used by review_prompts.rs\n3. Remove ExitedReviewModeEvent if no longer needed\n4. Update all match arms that handle Op::Review\n\nFiles to update:\n- protocol/src/protocol.rs\n- core/src/codex.rs (remove Op::Review handler)\n- Any other files matching on Op::Review","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:46.979545923+01:00","updated_at":"2025-12-15T15:43:25.394932343+01:00","closed_at":"2025-12-15T15:43:25.394932343+01:00","dependencies":[{"issue_id":"codex-9kr.8","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:46.979864121+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.8","depends_on_id":"codex-9kr.7","type":"blocks","created_at":"2025-12-15T14:12:50.730408158+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.9","title":"Remove ReviewTask and tasks/review.rs","description":"Delete core/src/tasks/review.rs and related code:\n\n1. Delete core/src/tasks/review.rs\n2. Remove ReviewTask from core/src/tasks/mod.rs\n3. Remove imports and usages of ReviewTask\n4. Remove exit_review_mode function\n5. Keep parse_review_output_event if needed by TUI (or move to protocol)\n\nThe review functionality now flows through task tool -\u003e SubagentDelegateTask.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:53.84168904+01:00","updated_at":"2025-12-15T15:45:11.900516798+01:00","closed_at":"2025-12-15T15:45:11.900516798+01:00","dependencies":[{"issue_id":"codex-9kr.9","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:53.842062202+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.9","depends_on_id":"codex-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.736446183+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9rt","title":"Subagent rendering polish","description":"Collection of UI/UX improvements for subagent rendering in the TUI. Covers nesting bugs, visual polish, and display consistency issues.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T21:52:05.938083509+01:00","updated_at":"2025-12-15T22:35:34.788011714+01:00","closed_at":"2025-12-15T22:35:34.788011714+01:00"}
{"id":"codex-9rt.1","title":"Subagent task description truncated in transcript overlay (Ctrl+t)","description":"## Issue\n\nThe task description (prompt) delegated to a subagent is truncated in both the normal view and the transcript overlay (Ctrl+t). Users should be able to see the full message sent to the subagent when viewing the expanded transcript.\n\n## Current Behavior\n\n- Task description is wrapped/truncated in `display_lines()`\n- Task description is also wrapped in `transcript_lines()` using `textwrap::wrap()`\n- Long prompts sent to subagents are cut off with no way to view the full content\n\n## Expected Behavior\n\n- Normal view: truncated task description (current behavior is fine)\n- Transcript overlay (Ctrl+t): full task description should be visible without truncation\n\n## Relevant Code\n\n- `tui/src/history_cell.rs:1420-1430`: `transcript_lines()` wraps description with `textwrap::wrap()`\n- The `wrap_width` calculation may be too aggressive for the transcript view\n\n## Fix Direction\n\nIn `transcript_lines()`, either:\n1. Don't limit wrap width for the description (let it flow naturally)\n2. Or use a much larger wrap width for transcript mode\n3. Ensure the full description is rendered across multiple lines without any character limit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:47.59488775+01:00","updated_at":"2025-12-15T22:35:19.590583799+01:00","closed_at":"2025-12-15T22:35:19.590583799+01:00","dependencies":[{"issue_id":"codex-9rt.1","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T22:03:47.595357588+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9rt.2","title":"Subagent final message not shown in UI","description":"## Issue\n\nThe last message from a subagent (its final response/output) is not visible in the UI. Users should be able to see what the subagent returned to the parent agent.\n\n## Current Behavior\n\n- Subagent cell shows: header, task description, and activity log (shell commands, patches, etc.)\n- The subagent's final textual response/message is not displayed\n- Users cannot see what the subagent concluded or reported back\n\n## Expected Behavior\n\n- Normal view: show truncated version of the subagent's final message\n- Transcript overlay (Ctrl+t): show the full final message expanded\n\n## Relevant Code\n\n- `tui/src/history_cell.rs`: `SubagentTaskCell` struct and its `display_lines()`/`transcript_lines()` methods\n- `tui/src/chatwidget.rs`: `on_subagent_event()` handles subagent events\n- The `SubagentState` struct may need a field to store the final message\n- `EventMsg::AgentMessage` events from subagents should be captured and displayed\n\n## Fix Direction\n\n1. Add a `final_message: Option\u003cString\u003e` field to `SubagentState`\n2. Capture `AgentMessage` events in `on_subagent_event()` and store the content\n3. Render the final message in both `display_lines()` (truncated) and `transcript_lines()` (full)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:58.785651289+01:00","updated_at":"2025-12-15T22:35:24.643083449+01:00","closed_at":"2025-12-15T22:35:24.643083449+01:00","dependencies":[{"issue_id":"codex-9rt.2","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T22:03:58.785965268+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-alj","title":"Parallel subagent delegations incorrectly nest due to shared DelegationRegistry state","description":"## Bug Summary\n\nWhen the parent agent spawns multiple subagents in parallel (e.g., two `@general` calls at once), they are rendered as nested rather than siblings. The second subagent appears nested inside the first, even though both should be at the same level under the parent.\n\n## Observed Behavior\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n  └ • Delegating to @general          \u003c-- BUG: This should NOT be nested\n    └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n      ... +10 more\n```\n\nThe second `@general` delegation appears nested inside the first one, but since `general` subagent cannot call itself, this is clearly incorrect. They should render as siblings:\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n• Delegating to @general              \u003c-- EXPECTED: Same level as above\n  └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n    ... +10 more\n```\n\n## Root Cause\n\nThe `DelegationRegistry` in `core/src/delegation.rs` uses a single shared `current: Arc\u003cRwLock\u003cOption\u003cDelegationContext\u003e\u003e\u003e` to track the active delegation context. When multiple subagents are spawned in parallel:\n\n1. First subagent calls `registry.enter(call_id_1)` → creates root context with `depth=0`, no parent\n2. Second subagent calls `registry.enter(call_id_2)` → sees first subagent's context as `current`, creates child with `depth=1` and `parent_delegation_id = call_id_1`\n\nThis causes the second subagent to incorrectly inherit from the first sibling instead of from the actual parent.\n\n## Relevant Code Paths\n\n- `core/src/delegation.rs`: `DelegationRegistry::enter()` uses shared `current` state\n- `core/src/tools/handlers/task.rs:202-208`: Retrieves delegation context for each subagent\n- `tui/src/chatwidget.rs:2187-2190`: Uses `parent_delegation_id` to nest cells\n\n## Fix Direction\n\nThe delegation context needs to be scoped per-call rather than shared globally. Options:\n\n1. Pass parent delegation ID explicitly from the caller rather than inferring from shared state\n2. Use a stack-based or tree-based registry that tracks parent-child relationships explicitly\n3. Store delegation context in the invocation/session context rather than a global registry\n\n## Test Case\n\nSee `tui/src/chatwidget/tests/subagent_tests.rs:91` for existing nesting test (`subagent_nesting_logic`). A new test should verify that two parallel delegations with the same parent remain siblings, not nested.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T21:50:57.207483466+01:00","updated_at":"2025-12-15T22:35:14.532746134+01:00","closed_at":"2025-12-15T22:35:14.532746134+01:00","dependencies":[{"issue_id":"codex-alj","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T21:52:32.934771433+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-ao9","title":"OpenRouter: some models fail with 'assistant content must contain at least one part'","description":"When using OpenRouter with certain models (e.g., xiaomi/mimo-v2-flash:free), the API returns error 400 with message 'assistant content must contain at least one part'. This happens after the assistant processes a shell command result. The issue is that some models don't accept empty assistant message content, but we're sending messages that lack required parts. Need to investigate our message serialization to ensure assistant messages always have valid content when sent to OpenRouter.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T10:47:25.118699639+01:00","updated_at":"2025-12-18T15:54:07.745376905+01:00","closed_at":"2025-12-18T15:54:07.745376905+01:00"}
{"id":"codex-bl3","title":"Gemini Low effort thinking_budget (512) is below Anthropic minimum (1024)","description":"When using Claude through Antigravity with Low reasoning effort (e.g., /review), the thinking_budget is set to 512 but Anthropic requires minimum 1024. This causes 400 errors.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T16:41:57.845756316+01:00","updated_at":"2025-12-07T16:47:59.841970442+01:00","closed_at":"2025-12-07T16:47:59.841970442+01:00"}
{"id":"codex-cs1","title":"Fix Gemini login prefers newest credential","description":"Gemini login currently keeps using the first stored credential; new logins append to auth.json but core picks index 0 so refreshed tokens are ignored unless users edit auth.json. Update persistence to promote most recent Gemini tokens to the front so runtime uses latest login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T12:59:39.702700307+01:00","updated_at":"2025-12-06T13:04:15.269773177+01:00","closed_at":"2025-12-06T13:04:15.269773177+01:00"}
{"id":"codex-d55","title":"Restrict subagent access to other subagents","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-10T11:46:51.10983909+01:00","updated_at":"2025-12-10T12:28:12.239896299+01:00","closed_at":"2025-12-10T12:28:12.239896299+01:00"}
{"id":"codex-d55.1","title":"Update Subagent Configuration Schema","description":"Modify `SubagentMetadata` in `codex-rs/core/src/subagents.rs` to include an optional list of allowed subagent slugs (e.g., `allowed_subagents: Vec\u003cString\u003e`). This will allow subagents to declare which other subagents they need access to in their frontmatter.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:46:59.596535735+01:00","updated_at":"2025-12-10T12:10:37.503321809+01:00","closed_at":"2025-12-10T12:10:37.503321809+01:00","dependencies":[{"issue_id":"codex-d55.1","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:46:59.596858281+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d55.2","title":"Pass Subagent Context to ToolsConfig","description":"Update `SessionConfiguration` and `ToolsConfig` to carry the list of allowed subagents. In `codex-rs/core/src/tools/handlers/task.rs`, extract the `allowed_subagents` from metadata when spawning a subagent and pass it to the new session configuration. Root sessions should have full access (None), while subagents should default to no access (Some(vec![])) unless specified.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:47:06.411262442+01:00","updated_at":"2025-12-10T12:20:43.504662463+01:00","closed_at":"2025-12-10T12:20:43.504662463+01:00","dependencies":[{"issue_id":"codex-d55.2","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:47:06.411575129+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d55.3","title":"Conditionally Inject and Filter Task Tool","description":"Modify `build_specs` in `codex-rs/core/src/tools/spec.rs` to check `ToolsConfig.allowed_subagents`. If `None`, inject the task tool with full access. If `Some(list)`, only inject the task tool if the list is not empty, and filter the available agents in the tool description to match the allowed list. If the list is empty, do not inject the task tool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:47:19.761597046+01:00","updated_at":"2025-12-10T12:23:18.651057619+01:00","closed_at":"2025-12-10T12:23:18.651057619+01:00","dependencies":[{"issue_id":"codex-d55.3","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:47:19.761959358+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d8a","title":"Gemini tokens ignored when API key present","description":"load_auth early returns CodexAuth::from_api_key_with_client when auth.json includes an API key, discarding gemini_accounts snapshot. Runtime then sees zero Gemini accounts and keeps using API key. Need to preserve auth snapshot so Gemini tokens remain accessible even when API key exists.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:09:00.722385922+01:00","updated_at":"2025-12-06T13:49:19.30910605+01:00","closed_at":"2025-12-06T13:49:19.30910605+01:00"}
{"id":"codex-dk5","title":"Fix P3: Delete unused SubagentWorktreeContext","description":"## Problem\n`SubagentWorktreeContext` in `core/src/subagent_worktree_context.rs` is dead code - defined but never used.\n\nThe worktree path propagation is handled implicitly via `config.cwd`.\n\n## Solution\nDelete the file and remove module exports.\n\n## Implementation\n\n### Step 1: Delete the file\n```bash\nrm core/src/subagent_worktree_context.rs\n```\n\n### Step 2: Remove from lib.rs\n\nIn `core/src/lib.rs`, remove these lines:\n```rust\npub mod subagent_worktree_context;\npub use subagent_worktree_context::*;\n```\n\n## After implementation\n- Run `cargo check -p codex-core`\n- Verify no compilation errors (no references to the deleted code)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T18:23:29.755850473+01:00","updated_at":"2025-12-21T18:32:55.655793878+01:00","closed_at":"2025-12-21T18:32:55.655793878+01:00"}
{"id":"codex-dt2","title":"Explore read_parent_thread tool for handoff","description":"## Overview\n\nAmp provides a `read_parent_thread` tool that allows the new (child) session created via handoff to read back into the parent thread's conversation history.\n\n## Why This Matters\n- Child session only receives extracted context summary\n- May need more details about specific decisions, code changes, or discussions\n- Prevents context loss for complex multi-step tasks\n\n## Research Questions\n1. How does Amp implement read_parent_thread?\n2. What API does it expose (read full thread? specific messages? search?)\n3. How is it rate-limited or token-budgeted?\n4. Should it read from rollout files or in-memory history?\n5. Security considerations (can child read sensitive parent content?)\n\n## Reference\n- Amp handoff docs: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Look for read_thread or read_parent_thread mentions\n\n## Subtasks to Create\n- Research Amp's read_thread implementation\n- Design tool schema for codex\n- Implement tool in core\n- Add to default tool list for handoff sessions\n- Test end-to-end","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-21T01:36:40.493345136+01:00","updated_at":"2025-12-21T01:36:40.493345136+01:00"}
{"id":"codex-dtx","title":"Implement @agent-name syntax for direct agent messaging","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-19T14:18:39.920260298+01:00","updated_at":"2025-12-19T14:18:39.920260298+01:00"}
{"id":"codex-dtx.1","title":"Add parse_agent_mention to prompt_args.rs","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-19T14:40:16.379785096+01:00","updated_at":"2025-12-19T14:40:16.379785096+01:00","dependencies":[{"issue_id":"codex-dtx.1","depends_on_id":"codex-dtx","type":"parent-child","created_at":"2025-12-19T14:40:16.380359322+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dut","title":"Add session_id to SubagentEventPayload for resumability","description":"## Problem\nWhen a subagent is interrupted, the main agent gets a tool_result but it lacks session_id.\n\n## Current Flow on Interruption\n1. User presses Ctrl+C during subagent execution\n2. Subagent emits `TurnAborted` event\n3. task.rs catches it and returns:\n   ```rust\n   let reason_str = format!(\"Turn aborted: {:?}\", ta.reason);\n   break Err(FunctionCallError::RespondToModel(reason_str));\n   ```\n4. This becomes a FunctionCallOutput recorded to history:\n   ```json\n   {\"call_id\": \"...\", \"output\": {\"content\": \"Turn aborted: UserCancelled\"}}\n   ```\n5. Main agent sees this but has NO session_id to offer for resume\n\n## Successful Completion (for comparison)\nOn success, the tool returns structured JSON with session_id:\n```rust\nlet response = serde_json::json!({\n    \"result\": final_output,\n    \"session_id\": session_id,  // ✓ Included\n    \"last_tool_output\": last_tool_output,\n    ...\n});\n```\n\n## Fix Options\n\n### Option A: Include session_id in abort message (minimal)\n```rust\nlet reason_str = format!(\n    \"Turn aborted: {:?}. To resume this subagent: codex resume {}\", \n    ta.reason, \n    session_id\n);\n```\n\n### Option B: Return structured JSON on abort (better)\n```rust\nlet abort_response = serde_json::json!({\n    \"error\": format!(\"Turn aborted: {:?}\", ta.reason),\n    \"session_id\": session_id,\n    \"can_resume\": true,\n});\nbreak Err(FunctionCallError::RespondToModel(abort_response.to_string()));\n```\n\n### Option C: Add session_id to SubagentEventPayload (most complete)\nAdd `session_id` field to `SubagentEventPayload` so TUI always has it from first event:\n```rust\npub struct SubagentEventPayload {\n    // ... existing fields ...\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub session_id: Option\u003cString\u003e,\n}\n```\n\n**Recommendation: Do both B and C**\n- Option B ensures main agent always gets session_id in tool output\n- Option C ensures TUI can display session_id even during execution\n\n## Files to modify\n1. **core/src/tools/handlers/task.rs**\n   - Update TurnAborted handling to include session_id in error response\n   - Update wrap_subagent_event() to accept session_id parameter\n\n2. **protocol/src/protocol.rs**\n   - Add `session_id: Option\u003cString\u003e` to SubagentEventPayload\n\n3. **tui/src/history_cell.rs** (optional)\n   - Store session_id in SubagentTaskCell\n   - Display it on interruption: \"To resume: codex resume \u003cid\u003e\"","status":"open","priority":1,"issue_type":"bug","created_at":"2025-12-22T23:19:14.120037924+01:00","updated_at":"2025-12-22T23:23:08.808505628+01:00"}
{"id":"codex-dxq","title":"AWS Bedrock provider support","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-14T18:08:03.131607868+01:00","updated_at":"2025-12-14T18:08:03.131607868+01:00"}
{"id":"codex-dxq.1","title":"Add AWS SDK dependencies to codex-core","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:18.498418872+01:00","updated_at":"2025-12-14T18:08:18.498418872+01:00","dependencies":[{"issue_id":"codex-dxq.1","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:18.498905891+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.2","title":"Add Bedrock tests (message/tool conversion, streaming)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-14T18:08:23.564600492+01:00","updated_at":"2025-12-14T18:08:23.564600492+01:00","dependencies":[{"issue_id":"codex-dxq.2","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:23.565100266+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.2","depends_on_id":"codex-dxq.5","type":"blocks","created_at":"2025-12-14T18:10:17.75071363+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.3","title":"Implement BedrockProvider and bedrock_messages.rs handler","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:28.622274175+01:00","updated_at":"2025-12-14T18:08:28.622274175+01:00","dependencies":[{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:28.622762467+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq.6","type":"blocks","created_at":"2025-12-14T18:08:58.510636816+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq.1","type":"blocks","created_at":"2025-12-14T18:10:17.707533596+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.4","title":"Integrate Bedrock dispatch in ModelClient::stream()","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:33.680358161+01:00","updated_at":"2025-12-14T18:08:33.680358161+01:00","dependencies":[{"issue_id":"codex-dxq.4","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:33.681087914+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.4","depends_on_id":"codex-dxq.3","type":"blocks","created_at":"2025-12-14T18:10:17.78887657+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.5","title":"Add built-in Bedrock provider to model_providers","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:38.742597104+01:00","updated_at":"2025-12-14T18:08:38.742597104+01:00","dependencies":[{"issue_id":"codex-dxq.5","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:38.743228368+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.5","depends_on_id":"codex-dxq.4","type":"blocks","created_at":"2025-12-14T18:10:17.829790545+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.6","title":"Add WireApi::Bedrock and ProviderKind::Bedrock","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:43.81996269+01:00","updated_at":"2025-12-14T18:08:43.81996269+01:00","dependencies":[{"issue_id":"codex-dxq.6","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:43.8205547+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-ez7","title":"Implement invocation-order patch merging","description":"## Problem\nCurrent implementation merges patches in completion order (non-deterministic). This can waste expensive work - if a fast trivial task finishes before a slow complex task and they conflict, the expensive work is lost.\n\n## Solution\nImplement \"Spawn All, Await Ordered\" pattern:\n1. Spawn all subagents in parallel (they execute concurrently)\n2. Collect results as they complete, but don't merge yet\n3. After ALL subagents complete, merge patches in invocation order\n\n## Implementation\n\n### Step 1: Create PendingSubagentResult struct\n\nIn `core/src/tools/handlers/task.rs` or new file `core/src/pending_patch.rs`:\n\n```rust\n/// Result from a completed subagent, pending merge\npub struct PendingSubagentResult {\n    /// Invocation order (0 = first spawned)\n    pub invocation_order: u32,\n    /// The subagent type\n    pub subagent_type: String,\n    /// Session ID\n    pub session_id: String,\n    /// The subagent's response\n    pub result: String,\n    /// Last tool output\n    pub last_tool_output: Option\u003cString\u003e,\n    /// The generated diff (if any)\n    pub diff: Option\u003cWorktreeDiff\u003e,\n    /// Worktree handle for cleanup\n    pub worktree_handle: Option\u003cWorktreeHandle\u003e,\n    /// Parent worktree to merge into\n    pub parent_worktree: PathBuf,\n}\n```\n\n### Step 2: Add invocation counter to turn/session context\n\nNeed a way to assign invocation_order when task tool is called. Options:\n- AtomicU32 counter in TurnContext\n- Or pass through tool dispatch\n\nAdd to TurnContext or Session:\n```rust\npub task_invocation_counter: AtomicU32,\n```\n\nIn task handler, get order:\n```rust\nlet invocation_order = turn.task_invocation_counter.fetch_add(1, Ordering::SeqCst);\n```\n\n### Step 3: Defer merge - collect pending results\n\nInstead of merging immediately after subagent completes, store the result.\n\nAdd to Session or TurnContext:\n```rust\npub pending_subagent_results: Mutex\u003cVec\u003cPendingSubagentResult\u003e\u003e,\n```\n\nAfter subagent completes and diff is generated:\n```rust\n// Don't merge here, just collect\nlet pending = PendingSubagentResult {\n    invocation_order,\n    subagent_type: args.subagent_type.clone(),\n    session_id: session_id.clone(),\n    result: final_output,\n    last_tool_output,\n    diff: Some(diff),\n    worktree_handle,\n    parent_worktree: parent_worktree.clone(),\n};\n\nturn.pending_subagent_results.lock().await.push(pending);\n\n// Return result WITHOUT changes field (changes come later)\nlet response = serde_json::json!({\n    \"result\": final_output,\n    \"session_id\": session_id,\n    \"last_tool_output\": last_tool_output,\n    \"changes\": \"pending_merge\",  // Marker that merge is deferred\n});\n```\n\n### Step 4: Merge at end of turn\n\nFind where all tool calls complete and add merge logic:\n\n```rust\n/// Merge all pending subagent patches in invocation order\npub async fn merge_pending_patches(\n    turn: \u0026TurnContext,\n    worktree_manager: \u0026WorktreeManager,\n) -\u003e Vec\u003c(String, SubagentChanges)\u003e {\n    let mut pending = turn.pending_subagent_results.lock().await;\n    \n    // Sort by invocation order\n    pending.sort_by_key(|p| p.invocation_order);\n    \n    let mut results = Vec::new();\n    \n    for p in pending.drain(..) {\n        let changes = if let (Some(diff), Some(handle)) = (p.diff, p.worktree_handle) {\n            if !diff.has_changes {\n                let _ = worktree_manager.cleanup(\u0026handle).await;\n                SubagentChanges {\n                    status: SubagentChangesStatus::NoChanges,\n                    files_changed: vec![],\n                    patch_path: None,\n                }\n            } else {\n                let task_id = format!(\"{}-{}\", p.subagent_type, p.session_id);\n                match worktree_manager.apply_patch(\u0026diff.patch, \u0026p.parent_worktree, \u0026task_id).await {\n                    Ok(PatchApplyResult::Applied { files_changed }) =\u003e {\n                        let _ = worktree_manager.cleanup(\u0026handle).await;\n                        SubagentChanges {\n                            status: SubagentChangesStatus::Applied,\n                            files_changed: convert_file_changes(files_changed),\n                            patch_path: None,\n                        }\n                    }\n                    Ok(PatchApplyResult::Conflict { patch_path }) =\u003e {\n                        let _ = worktree_manager.cleanup(\u0026handle).await;\n                        SubagentChanges {\n                            status: SubagentChangesStatus::Conflict,\n                            files_changed: vec![],\n                            patch_path: Some(patch_path.to_string_lossy().to_string()),\n                        }\n                    }\n                    // ... handle other cases\n                }\n            }\n        } else {\n            SubagentChanges {\n                status: SubagentChangesStatus::NoChanges,\n                files_changed: vec![],\n                patch_path: None,\n            }\n        };\n        \n        results.push((p.session_id, changes));\n    }\n    \n    results\n}\n```\n\n### Step 5: Inject merge results back to model\n\nAfter merge completes, the results need to reach the model. Options:\n1. Modify tool results before sending\n2. Add a system message with merge summary\n3. Store in context for next turn\n\nRecommended: Store results and include in next response or emit as event.\n\n## Files to modify\n- `core/src/tools/handlers/task.rs` - defer merge, collect pending\n- `core/src/codex.rs` - add pending_subagent_results, call merge at turn end\n- `core/src/turn_context.rs` or similar - add invocation counter\n\n## Tests\n- Test that invocation order is respected\n- Test parallel subagents merge in correct order\n- Test conflict in second subagent doesn't affect first\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T15:00:41.713378382+01:00","updated_at":"2025-12-21T15:36:21.341823984+01:00","closed_at":"2025-12-21T15:36:21.341823984+01:00"}
{"id":"codex-fmk","title":"Remove HasLegacyEvent pattern and new event wrappers","description":"Remove HasLegacyEvent trait and wrapper events (ItemStarted, ItemCompleted, etc). Emit legacy events directly. Simplifies protocol and removes double-send pattern.","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-18T17:02:53.47755984+01:00","updated_at":"2025-12-18T17:02:53.47755984+01:00"}
{"id":"codex-fmk.1","title":"Remove unused wrapper event types from EventMsg","description":"In protocol/src/protocol.rs: Remove ItemStarted, ItemCompleted, AgentMessageContentDelta, ReasoningContentDelta, ReasoningRawContentDelta variants from EventMsg. Remove their struct definitions. Update any matches on EventMsg to remove these arms.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:11.007386073+01:00","updated_at":"2025-12-18T17:25:41.162605469+01:00","closed_at":"2025-12-18T17:25:41.162605469+01:00","dependencies":[{"issue_id":"codex-fmk.1","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:11.007909974+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-fmk.2","title":"Remove HasLegacyEvent trait from protocol","description":"In protocol/src/protocol.rs: Remove HasLegacyEvent trait and all its impl blocks. Keep as_legacy_events methods on TurnItem/items.rs as standalone helpers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:16.068991783+01:00","updated_at":"2025-12-18T22:39:36.495896729+01:00","closed_at":"2025-12-18T22:39:36.495896729+01:00","dependencies":[{"issue_id":"codex-fmk.2","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:16.069851086+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-fmk.3","title":"Update codex.rs to emit legacy events directly","description":"In core/src/codex.rs: Remove as_legacy_events loop from send_event. Update emit_turn_item_completed to convert TurnItem to legacy events directly using item.as_legacy_events() and send each.","status":"in_progress","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:21.12874774+01:00","updated_at":"2025-12-18T17:04:23.190568796+01:00","dependencies":[{"issue_id":"codex-fmk.3","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:21.129334502+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd","title":"Skills cache auto-refresh via mtime checking","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T15:22:24.68068856+01:00","updated_at":"2025-12-18T15:31:12.698437339+01:00","closed_at":"2025-12-18T15:31:12.698437339+01:00"}
{"id":"codex-hcd.1","title":"Add CachedSkills struct with outcome and source mtimes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:35.705300567+01:00","updated_at":"2025-12-18T15:29:52.685298563+01:00","closed_at":"2025-12-18T15:29:52.685298563+01:00","dependencies":[{"issue_id":"codex-hcd.1","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:35.705942853+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd.2","title":"Add tests for mtime-based cache invalidation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:40.765788999+01:00","updated_at":"2025-12-18T15:31:07.645326966+01:00","closed_at":"2025-12-18T15:31:07.645326966+01:00","dependencies":[{"issue_id":"codex-hcd.2","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:40.76620866+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd.3","title":"Update SkillsManager to check mtimes before returning cache","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:45.821885038+01:00","updated_at":"2025-12-18T15:30:58.239083836+01:00","closed_at":"2025-12-18T15:30:58.239083836+01:00","dependencies":[{"issue_id":"codex-hcd.3","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:45.822487248+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-i1o","title":"Agent Create Wizard","description":"## Overview\n\nTUI-based wizard for creating subagent definitions with LLM-assisted generation. Follows the onboarding screen pattern with sequential steps.\n\n## Design Document\n\nSee `history/agent-wizard-design.md` for complete design including:\n- Configuration format (`[agent_wizard]` section)\n- Agent file format with required frontmatter fields\n- CLI commands (create, list, edit, delete)\n- TUI wizard flow (7 steps)\n- Validation rules and error messages\n- Generation prompt\n\n## Key Features\n\n1. **TUI Wizard** - 7-step interactive flow for agent creation\n2. **LLM Generation** - Uses configured profile to generate slug, name, system_prompt\n3. **Explicit Configuration** - All frontmatter fields required, no defaults\n4. **Scope Selection** - Global (~/.codex/agents/) or Project (.codex/agents/)\n5. **Conflict Detection** - Prevents creating duplicate slugs, warns on startup conflicts\n6. **$EDITOR Integration** - Edit generated agent before saving\n\n## CLI Commands\n\n- `codex agent create` - Launch TUI wizard (no flags)\n- `codex agent list` - List agents by scope with descriptions\n- `codex agent edit \u003cslug\u003e` - Open in $EDITOR (picker if ambiguous)\n- `codex agent delete \u003cslug\u003e` - Delete with confirmation (--yes to skip)\n\n## Validation\n\n**Hard (agent fails to load):**\n- Description \u003e 500 chars\n- Missing required field\n- Invalid profile/sandbox_policy/approval_policy\n\n**Soft (warning, continues):**\n- Global/project name conflict (project takes precedence)","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-13T12:53:39.796688648+01:00","updated_at":"2025-12-13T12:53:39.796688648+01:00"}
{"id":"codex-i1o.1","title":"Add [agent_wizard] config section","description":"## What\n\nAdd `[agent_wizard]` configuration section to the config system with `creation_profile` field.\n\n## Why\n\nThe wizard needs to know which model profile to use for LLM generation. This must be explicitly configured - no defaults.\n\n## How\n\n### File: `core/src/config/mod.rs`\n\nAdd new config struct:\n\n```rust\n#[derive(Debug, Clone, Deserialize, Default)]\npub struct AgentWizardConfig {\n    /// Profile name to use for LLM generation during agent creation.\n    /// Must reference an existing profile in [profiles] section.\n    pub creation_profile: Option\u003cString\u003e,\n}\n```\n\nAdd to main Config struct:\n\n```rust\npub struct Config {\n    // ... existing fields ...\n    #[serde(default)]\n    pub agent_wizard: AgentWizardConfig,\n}\n```\n\n### Validation function\n\n```rust\nimpl AgentWizardConfig {\n    /// Validate that creation_profile exists in profiles.\n    /// Returns error message if invalid.\n    pub fn validate(\u0026self, available_profiles: \u0026[String]) -\u003e Option\u003cString\u003e {\n        if let Some(ref profile) = self.creation_profile {\n            if !available_profiles.contains(profile) {\n                return Some(format!(\n                    \"Agent wizard profile '{}' not found. Available profiles: {}\",\n                    profile,\n                    available_profiles.join(\", \")\n                ));\n            }\n        }\n        None\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `[agent_wizard]` section parsed from config.toml\n- [ ] `creation_profile` field accessible as `Option\u003cString\u003e`\n- [ ] Validation function checks profile exists\n- [ ] Missing section doesn't break config loading\n- [ ] `cargo test -p codex-core` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:53:53.160472141+01:00","updated_at":"2025-12-13T12:53:53.160472141+01:00","dependencies":[{"issue_id":"codex-i1o.1","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:53:53.160829333+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.10","title":"Implement LLM agent generation function","description":"## What\n\nImplement the function that calls the LLM to generate agent configuration from a description.\n\n## Why\n\nThe wizard's Step 3 needs to generate slug, name, and system_prompt using the configured profile.\n\n## How\n\n### File: `core/src/agent_generator.rs` (new file)\n\n```rust\nuse schemars::JsonSchema;\nuse serde::{Deserialize, Serialize};\nuse anyhow::Result;\n\nconst AGENT_GENERATION_PROMPT: \u0026str = include_str!(\"prompts/agent_generate.md\");\n\n/// Schema for LLM-generated agent configuration\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema)]\npub struct GeneratedAgent {\n    /// Unique slug identifier (lowercase, hyphens allowed)\n    pub slug: String,\n    \n    /// Human-readable display name\n    pub name: String,\n    \n    /// The system prompt that governs the agent's behavior\n    pub system_prompt: String,\n}\n\n/// Generate an agent configuration using the specified profile.\n/// \n/// # Arguments\n/// * `description` - User's description of what the agent should do\n/// * `existing_slugs` - List of slugs that must not be reused\n/// * `profile` - Profile name to use for LLM generation\n/// \n/// # Returns\n/// Generated agent configuration or error\npub async fn generate_agent(\n    description: \u0026str,\n    existing_slugs: \u0026[String],\n    profile: \u0026str,\n    // ... other necessary context like codex instance\n) -\u003e Result\u003cGeneratedAgent\u003e {\n    // 1. Build prompt from template\n    let prompt = AGENT_GENERATION_PROMPT\n        .replace(\"{description}\", description)\n        .replace(\"{existing_slugs}\", \u0026format!(\"{:?}\", existing_slugs));\n    \n    // 2. Get model from profile\n    // 3. Call LLM with structured output schema\n    // 4. Parse response into GeneratedAgent\n    \n    todo!(\"Implementation depends on how profiles/LLM calls work\")\n}\n```\n\n### Integration with existing infrastructure\n\nNeed to investigate how to:\n1. Load profile configuration\n2. Make LLM call with structured output (JSON schema)\n3. Handle rate limits and errors\n\n## Acceptance Criteria\n\n- [ ] `GeneratedAgent` struct defined with schemars JsonSchema\n- [ ] `generate_agent()` function implemented\n- [ ] Uses profile from [agent_wizard].creation_profile\n- [ ] Returns structured GeneratedAgent\n- [ ] Handles LLM errors gracefully\n- [ ] `cargo test -p codex-core` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:04.931338897+01:00","updated_at":"2025-12-13T12:56:04.931338897+01:00","dependencies":[{"issue_id":"codex-i1o.10","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:56:04.93173338+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.10","depends_on_id":"codex-i1o.9","type":"blocks","created_at":"2025-12-13T12:58:48.883281018+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.11","title":"Create TUI wizard framework","description":"## What\n\nCreate the wizard framework following the onboarding screen pattern with sequential steps.\n\n## Why\n\nThe agent create wizard needs 7 steps that flow sequentially, similar to existing onboarding.\n\n## How\n\n### File: `tui/src/agent_wizard/mod.rs` (new file)\n\n```rust\nmod scope_step;\nmod description_step;\nmod generation_step;\nmod profile_step;\nmod sandbox_step;\nmod approval_step;\nmod review_step;\n\nuse crate::tui::{FrameRequester, Tui};\nuse crossterm::event::KeyEvent;\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\n\npub use scope_step::ScopeStep;\npub use description_step::DescriptionStep;\n// ... other exports\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum WizardStepState {\n    Hidden,\n    InProgress,\n    Complete,\n}\n\npub trait WizardStep {\n    fn get_state(\u0026self) -\u003e WizardStepState;\n    fn handle_key_event(\u0026mut self, key: KeyEvent);\n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer);\n    fn desired_height(\u0026self) -\u003e u16;\n}\n\npub struct AgentWizard {\n    request_frame: FrameRequester,\n    steps: Vec\u003cBox\u003cdyn WizardStep\u003e\u003e,\n    is_done: bool,\n    should_exit: bool,\n    result: Option\u003cAgentWizardResult\u003e,\n}\n\npub struct AgentWizardResult {\n    pub scope: AgentScope,\n    pub slug: String,\n    pub name: String,\n    pub description: String,\n    pub profile: String,\n    pub sandbox_policy: SubagentSandboxPolicy,\n    pub approval_policy: AskForApproval,\n    pub system_prompt: String,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum AgentScope {\n    Project,\n    Global,\n}\n```\n\n### Pattern reference\n\nFollow `tui/src/onboarding/onboarding_screen.rs` for:\n- Step sequencing logic\n- Keyboard handling delegation\n- Rendering with dynamic height\n- State management\n\n## Acceptance Criteria\n\n- [ ] `AgentWizard` struct with step management\n- [ ] `WizardStep` trait for individual steps\n- [ ] `AgentWizardResult` contains all collected data\n- [ ] `AgentScope` enum for project/global\n- [ ] Framework compiles and can hold steps\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:21.309276569+01:00","updated_at":"2025-12-13T12:56:21.309276569+01:00","dependencies":[{"issue_id":"codex-i1o.11","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:56:21.309670922+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.11","depends_on_id":"codex-i1o.1","type":"blocks","created_at":"2025-12-13T12:58:48.8912072+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.12","title":"Implement wizard Step 1: Scope selection","description":"## What\n\nImplement the scope selection step (Project vs Global) with radio buttons.\n\n## Why\n\nFirst step of wizard - user chooses where to create the agent.\n\n## How\n\n### File: `tui/src/agent_wizard/scope_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentScope};\nuse crossterm::event::{KeyCode, KeyEvent};\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\nuse ratatui::style::Stylize;\nuse ratatui::text::Line;\n\npub struct ScopeStep {\n    selected: AgentScope,\n    confirmed: bool,\n    project_path: String,  // Display path like \".codex/agents/\"\n    global_path: String,   // Display path like \"~/.codex/agents/\"\n}\n\nimpl ScopeStep {\n    pub fn new(project_path: String, global_path: String) -\u003e Self {\n        Self {\n            selected: AgentScope::Project,  // Default to project\n            confirmed: false,\n            project_path,\n            global_path,\n        }\n    }\n    \n    pub fn selection(\u0026self) -\u003e AgentScope {\n        self.selected\n    }\n}\n\nimpl WizardStep for ScopeStep {\n    fn get_state(\u0026self) -\u003e WizardStepState {\n        if self.confirmed {\n            WizardStepState::Complete\n        } else {\n            WizardStepState::InProgress\n        }\n    }\n    \n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                self.selected = AgentScope::Project;\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                self.selected = AgentScope::Global;\n            }\n            KeyCode::Enter =\u003e {\n                self.confirmed = true;\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // Render:\n        // Where should this agent be created?\n        //\n        //   (●) Project  .codex/agents/\n        //   ( ) Global   ~/.codex/agents/\n        //\n        // [Enter to continue]\n    }\n    \n    fn desired_height(\u0026self) -\u003e u16 {\n        6  // Header + 2 options + spacing + hint\n    }\n}\n```\n\n### Display format\n\n```\nWhere should this agent be created?\n\n  (●) Project  .codex/agents/\n  ( ) Global   ~/.codex/agents/\n\n[Enter to continue]\n```\n\n## Acceptance Criteria\n\n- [ ] Radio button UI with Project/Global options\n- [ ] Project selected by default\n- [ ] Up/Down or j/k to navigate\n- [ ] Enter to confirm\n- [ ] Shows actual paths for each scope\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:38.756526707+01:00","updated_at":"2025-12-13T12:56:38.756526707+01:00","dependencies":[{"issue_id":"codex-i1o.12","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:56:38.756853641+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.12","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.89928986+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.13","title":"Implement wizard Step 2: Description input","description":"## What\n\nImplement the description input step with character counter and 500 char limit.\n\n## Why\n\nUser describes what the agent should do. This is used for LLM generation.\n\n## How\n\n### File: `tui/src/agent_wizard/description_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState};\nuse crate::bottom_pane::textarea::TextArea;\nuse crossterm::event::{KeyCode, KeyEvent};\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\n\nconst MAX_DESCRIPTION_LENGTH: usize = 500;\n\npub struct DescriptionStep {\n    textarea: TextArea,\n    confirmed: bool,\n}\n\nimpl DescriptionStep {\n    pub fn new() -\u003e Self {\n        Self {\n            textarea: TextArea::new(),\n            confirmed: false,\n        }\n    }\n    \n    pub fn description(\u0026self) -\u003e String {\n        self.textarea.get_text().to_string()\n    }\n    \n    fn char_count(\u0026self) -\u003e usize {\n        self.textarea.get_text().chars().count()\n    }\n    \n    fn is_valid(\u0026self) -\u003e bool {\n        let count = self.char_count();\n        count \u003e 0 \u0026\u0026 count \u003c= MAX_DESCRIPTION_LENGTH\n    }\n}\n\nimpl WizardStep for DescriptionStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Enter if self.is_valid() =\u003e {\n                self.confirmed = true;\n            }\n            KeyCode::Char(c) if self.char_count() \u003c MAX_DESCRIPTION_LENGTH =\u003e {\n                self.textarea.handle_key_event(key);\n            }\n            KeyCode::Backspace | KeyCode::Delete =\u003e {\n                self.textarea.handle_key_event(key);\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // Render:\n        // What should this agent do? (max 500 chars)\n        //\n        // \u003e [textarea content]\n        //                                              73/500\n        //\n        // [Enter to continue]\n    }\n    \n    // ...\n}\n```\n\n### Display format\n\n```\nWhat should this agent do? (max 500 chars)\n\n\u003e Review code for security vulnerabilities and\n  suggest fixes for common issues like SQL injection\n                                              73/500\n\n[Enter to continue]\n```\n\n## Acceptance Criteria\n\n- [ ] Text input area with word wrap\n- [ ] Character counter showing current/max\n- [ ] Cannot exceed 500 characters\n- [ ] Cannot submit empty description\n- [ ] Enter only works when valid\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:55.915983158+01:00","updated_at":"2025-12-13T12:56:55.915983158+01:00","dependencies":[{"issue_id":"codex-i1o.13","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:56:55.916404411+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.13","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.906625174+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.14","title":"Implement wizard Step 3: LLM generation","description":"## What\n\nImplement the generation step with spinner, LLM call, and conflict checking.\n\n## Why\n\nThis step calls the LLM to generate slug, name, and system_prompt, then validates no conflicts.\n\n## How\n\n### File: `tui/src/agent_wizard/generation_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentScope};\nuse codex_core::agent_generator::{generate_agent, GeneratedAgent};\nuse crossterm::event::{KeyCode, KeyEvent};\n\npub enum GenerationState {\n    Generating,\n    Success(GeneratedAgent),\n    ConflictError { slug: String },\n    Error { message: String },\n}\n\npub struct GenerationStep {\n    state: GenerationState,\n    description: String,\n    scope: AgentScope,\n    existing_slugs: Vec\u003cString\u003e,\n    profile: String,\n}\n\nimpl GenerationStep {\n    pub fn new(\n        description: String,\n        scope: AgentScope,\n        existing_slugs: Vec\u003cString\u003e,\n        profile: String,\n    ) -\u003e Self {\n        Self {\n            state: GenerationState::Generating,\n            description,\n            scope,\n            existing_slugs,\n            profile,\n        }\n    }\n    \n    pub async fn start_generation(\u0026mut self) {\n        match generate_agent(\u0026self.description, \u0026self.existing_slugs, \u0026self.profile).await {\n            Ok(generated) =\u003e {\n                // Check for conflicts\n                if self.existing_slugs.contains(\u0026generated.slug) {\n                    self.state = GenerationState::ConflictError { \n                        slug: generated.slug \n                    };\n                } else {\n                    self.state = GenerationState::Success(generated);\n                }\n            }\n            Err(e) =\u003e {\n                self.state = GenerationState::Error { \n                    message: e.to_string() \n                };\n            }\n        }\n    }\n    \n    pub fn generated(\u0026self) -\u003e Option\u003c\u0026GeneratedAgent\u003e {\n        match \u0026self.state {\n            GenerationState::Success(g) =\u003e Some(g),\n            _ =\u003e None,\n        }\n    }\n}\n\nimpl WizardStep for GenerationStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match (\u0026self.state, key.code) {\n            (GenerationState::Error { .. }, KeyCode::Char('r')) =\u003e {\n                self.state = GenerationState::Generating;\n                // Trigger regeneration\n            }\n            (GenerationState::ConflictError { .. }, KeyCode::Char('r')) =\u003e {\n                self.state = GenerationState::Generating;\n                // Trigger regeneration with hint to use different name\n            }\n            (GenerationState::Success(_), KeyCode::Enter) =\u003e {\n                // Advance to next step\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        match \u0026self.state {\n            GenerationState::Generating =\u003e {\n                // ⣾ Generating agent configuration...\n                //   Using profile: fast (gpt-4o-mini)\n            }\n            GenerationState::Success(g) =\u003e {\n                // ✓ Generated: security-reviewer\n                // [Enter to continue]\n            }\n            GenerationState::ConflictError { slug } =\u003e {\n                // Error: Agent 'security-reviewer' already exists.\n                // [R]egenerate with different name  [Esc] Cancel\n            }\n            GenerationState::Error { message } =\u003e {\n                // Error: Failed to generate agent configuration.\n                // Reason: {message}\n                // [R]etry  [Esc] Cancel\n            }\n        }\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Spinner animation during generation\n- [ ] Shows which profile is being used\n- [ ] On success: shows generated slug, advances with Enter\n- [ ] On conflict: shows error, R to regenerate\n- [ ] On error: shows reason, R to retry, Esc to cancel\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:17.941098915+01:00","updated_at":"2025-12-13T12:57:17.941098915+01:00","dependencies":[{"issue_id":"codex-i1o.14","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:57:17.941491925+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.14","depends_on_id":"codex-i1o.10","type":"blocks","created_at":"2025-12-13T12:58:48.915773136+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.14","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.924950795+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.15","title":"Implement wizard Steps 4-6: Policy pickers","description":"## What\n\nImplement the three policy selection steps: Profile, Sandbox Policy, Approval Policy.\n\n## Why\n\nUser must explicitly choose all policies - no defaults.\n\n## How\n\n### Generic picker component\n\nCreate a reusable radio picker since all three steps have same UX:\n\n```rust\n// tui/src/agent_wizard/picker_step.rs\n\npub struct PickerStep\u003cT: Clone + PartialEq\u003e {\n    title: String,\n    options: Vec\u003c(T, String)\u003e,  // (value, display_label)\n    selected_index: usize,\n    confirmed: bool,\n}\n\nimpl\u003cT: Clone + PartialEq\u003e PickerStep\u003cT\u003e {\n    pub fn new(title: String, options: Vec\u003c(T, String)\u003e) -\u003e Self {\n        Self {\n            title,\n            options,\n            selected_index: 0,\n            confirmed: false,\n        }\n    }\n    \n    pub fn selection(\u0026self) -\u003e Option\u003cT\u003e {\n        self.options.get(self.selected_index).map(|(v, _)| v.clone())\n    }\n}\n\nimpl\u003cT: Clone + PartialEq\u003e WizardStep for PickerStep\u003cT\u003e {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                if self.selected_index \u003e 0 {\n                    self.selected_index -= 1;\n                }\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                if self.selected_index \u003c self.options.len() - 1 {\n                    self.selected_index += 1;\n                }\n            }\n            KeyCode::Enter =\u003e {\n                self.confirmed = true;\n            }\n            _ =\u003e {}\n        }\n    }\n    // ... render radio buttons\n}\n```\n\n### Step 4: Profile picker\n\n```rust\n// Load profiles from config\nlet profiles: Vec\u003cString\u003e = config.profiles.keys().cloned().collect();\nlet options: Vec\u003c(String, String)\u003e = profiles.iter()\n    .map(|p| (p.clone(), p.clone()))\n    .collect();\n    \nlet profile_step = PickerStep::new(\"Select profile:\".to_string(), options);\n```\n\n### Step 5: Sandbox policy picker\n\n```rust\nlet options = vec![\n    (SubagentSandboxPolicy::ReadOnly, \"read-only\".to_string()),\n    (SubagentSandboxPolicy::WorkspaceWrite, \"workspace-write\".to_string()),\n    (SubagentSandboxPolicy::DangerFullAccess, \"danger-full-access\".to_string()),\n];\nlet sandbox_step = PickerStep::new(\"Select sandbox policy:\".to_string(), options);\n```\n\n### Step 6: Approval policy picker\n\n```rust\nlet options = vec![\n    (AskForApproval::OnFailure, \"on-failure\".to_string()),\n    (AskForApproval::UnlessTrusted, \"unless-trusted\".to_string()),\n    (AskForApproval::OnRequest, \"on-request\".to_string()),\n    (AskForApproval::Never, \"never\".to_string()),\n];\nlet approval_step = PickerStep::new(\"Select approval policy:\".to_string(), options);\n```\n\n## Acceptance Criteria\n\n- [ ] Generic `PickerStep\u003cT\u003e` component\n- [ ] Profile picker lists profiles from config\n- [ ] Sandbox picker with 3 options\n- [ ] Approval picker with 4 options\n- [ ] Up/Down or j/k navigation\n- [ ] Enter to confirm\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:40.475341065+01:00","updated_at":"2025-12-13T12:57:40.475341065+01:00","dependencies":[{"issue_id":"codex-i1o.15","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:57:40.475671505+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.15","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.933506718+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.16","title":"Implement wizard Step 7: Review and confirm","description":"## What\n\nImplement the final review step with preview, create, edit, and cancel actions.\n\n## Why\n\nUser reviews the complete agent file before creating. Can edit in $EDITOR if needed.\n\n## How\n\n### File: `tui/src/agent_wizard/review_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentWizardResult};\nuse crossterm::event::{KeyCode, KeyEvent};\n\npub enum ReviewAction {\n    None,\n    Create,\n    Edit,\n    Cancel,\n}\n\npub struct ReviewStep {\n    result: AgentWizardResult,\n    action: ReviewAction,\n    scroll_offset: usize,\n}\n\nimpl ReviewStep {\n    pub fn new(result: AgentWizardResult) -\u003e Self {\n        Self {\n            result,\n            action: ReviewAction::None,\n            scroll_offset: 0,\n        }\n    }\n    \n    pub fn action(\u0026self) -\u003e \u0026ReviewAction {\n        \u0026self.action\n    }\n    \n    fn generate_file_content(\u0026self) -\u003e String {\n        format!(\n            \"---\nname: {}\ndescription: {}\nprofile: {}\nsandbox_policy: {}\napproval_policy: {}\nallowed_subagents: []\n---\n\n{}\",\n            self.result.name,\n            self.result.description,\n            self.result.profile,\n            self.result.sandbox_policy,\n            self.result.approval_policy,\n            self.result.system_prompt,\n        )\n    }\n}\n\nimpl WizardStep for ReviewStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Char('c') | KeyCode::Char('C') =\u003e {\n                self.action = ReviewAction::Create;\n            }\n            KeyCode::Char('e') | KeyCode::Char('E') =\u003e {\n                self.action = ReviewAction::Edit;\n            }\n            KeyCode::Esc =\u003e {\n                self.action = ReviewAction::Cancel;\n            }\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                self.scroll_offset = self.scroll_offset.saturating_sub(1);\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                self.scroll_offset += 1;\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // security-reviewer.md\n        // ────────────────────────────────────────────────\n        // ---\n        // name: Security Reviewer\n        // description: Reviews code for security...\n        // profile: default\n        // sandbox_policy: read-only\n        // approval_policy: on-failure\n        // allowed_subagents: []\n        // ---\n        //\n        // You are an expert security code reviewer...\n        // [scrollable preview]\n        //\n        // [C]reate  [E]dit in vim  [Esc] Cancel\n    }\n}\n```\n\n### Actions\n\n- **[C]reate**: Write file to disk, show success, exit wizard\n- **[E]dit**: Write temp file, open in $EDITOR, copy result to final location\n- **[Esc]**: Cancel wizard, no file created\n\n## Acceptance Criteria\n\n- [ ] Shows complete file preview with frontmatter\n- [ ] Scrollable if content is long\n- [ ] C key creates file\n- [ ] E key opens $EDITOR (or vi fallback)\n- [ ] Esc cancels wizard\n- [ ] Shows filename at top (slug.md)\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:02.385514156+01:00","updated_at":"2025-12-13T12:58:02.385514156+01:00","dependencies":[{"issue_id":"codex-i1o.16","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:58:02.385859164+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.16","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.942248726+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.17","title":"Implement 'codex agent create' CLI entry point","description":"## What\n\nImplement the CLI entry point that validates config and launches the TUI wizard.\n\n## Why\n\n`codex agent create` must check for [agent_wizard].creation_profile before starting wizard.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Subcommand)]\npub enum AgentCommand {\n    /// Create a new agent interactively\n    Create,\n    // ... other commands\n}\n\npub async fn run_agent_create(config: \u0026Config) -\u003e anyhow::Result\u003c()\u003e {\n    // 1. Check for creation_profile\n    let creation_profile = config.agent_wizard.creation_profile.as_ref()\n        .ok_or_else(|| {\n            let available = config.profiles.keys().cloned().collect::\u003cVec\u003c_\u003e\u003e();\n            anyhow::anyhow!(\n                \"Agent wizard not configured.\\n\\n\\\n                Add to ~/.codex/config.toml:\\n\\n\\\n                [agent_wizard]\\n\\\n                creation_profile = \\\"your-profile-name\\\"\\n\\n\\\n                Available profiles: {}\",\n                available.join(\", \")\n            )\n        })?;\n    \n    // 2. Validate creation_profile exists\n    if !config.profiles.contains_key(creation_profile) {\n        let available = config.profiles.keys().cloned().collect::\u003cVec\u003c_\u003e\u003e();\n        anyhow::bail!(\n            \"Agent wizard profile '{}' not found.\\n\\n\\\n            Available profiles: {}\",\n            creation_profile,\n            available.join(\", \")\n        );\n    }\n    \n    // 3. Launch TUI wizard\n    // Similar to how main.rs launches the TUI for interactive mode\n    run_agent_wizard(config, creation_profile).await\n}\n```\n\n### File: `cli/src/main.rs`\n\nAdd to Subcommand enum and handler:\n\n```rust\n/// Manage agents\nAgent(agent_cmd::AgentCli),\n\n// In main():\nSome(Subcommand::Agent(agent_cli)) =\u003e {\n    match agent_cli.command {\n        AgentCommand::Create =\u003e agent_cmd::run_agent_create(\u0026config).await?,\n        AgentCommand::List =\u003e agent_cmd::run_agent_list(\u0026codex_home, project_dir).await?,\n        // ...\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent create` checks for creation_profile\n- [ ] Missing profile shows helpful error with available profiles\n- [ ] Invalid profile shows error with available profiles\n- [ ] Valid config launches TUI wizard\n- [ ] Error messages match design doc format","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:20.579925126+01:00","updated_at":"2025-12-13T12:58:20.579925126+01:00","dependencies":[{"issue_id":"codex-i1o.17","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:58:20.58049868+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.17","depends_on_id":"codex-i1o.1","type":"blocks","created_at":"2025-12-13T12:58:48.950152404+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.17","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.958352938+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.18","title":"Add tests for agent wizard","description":"## What\n\nAdd comprehensive tests for the agent wizard functionality.\n\n## Why\n\nEnsure validation, conflict detection, and wizard flow work correctly.\n\n## How\n\n### Core tests (`core/src/subagents.rs`)\n\n```rust\n#[test]\nfn test_description_length_validation() {\n    let long_desc = \"x\".repeat(501);\n    let agent = SubagentDefinition {\n        slug: \"test\".to_string(),\n        metadata: SubagentMetadata {\n            description: long_desc,\n            // ... other required fields\n        },\n        system_prompt: \"test\".to_string(),\n    };\n    \n    let error = validate_agent(\u0026agent, \u0026HashSet::new());\n    assert!(error.is_some());\n    assert!(error.unwrap().message.contains(\"exceeds 500 characters\"));\n}\n\n#[test]\nfn test_conflict_detection() {\n    let project = vec![SubagentDefinition { slug: \"foo\".to_string(), .. }];\n    let global = vec![SubagentDefinition { slug: \"foo\".to_string(), .. }];\n    \n    let conflicts = detect_conflicts(\u0026project, \u0026global);\n    assert_eq!(conflicts.len(), 1);\n    assert_eq!(conflicts[0].slug, \"foo\");\n}\n\n#[test]\nfn test_missing_required_field() {\n    // YAML without 'profile' field should fail to parse\n}\n```\n\n### Config tests (`core/src/config/mod.rs`)\n\n```rust\n#[test]\nfn test_agent_wizard_config_parsing() {\n    let toml = r#\"\n    [agent_wizard]\n    creation_profile = \"fast\"\n    \"#;\n    \n    let config: Config = toml::from_str(toml).unwrap();\n    assert_eq!(config.agent_wizard.creation_profile, Some(\"fast\".to_string()));\n}\n\n#[test]\nfn test_agent_wizard_config_missing() {\n    let toml = \"\";\n    let config: Config = toml::from_str(toml).unwrap();\n    assert!(config.agent_wizard.creation_profile.is_none());\n}\n```\n\n### CLI tests\n\n- Test `agent list` output format\n- Test `agent delete` confirmation\n- Test `agent create` error when no config\n\n## Acceptance Criteria\n\n- [ ] Validation tests for description length\n- [ ] Conflict detection tests\n- [ ] Required field parsing tests\n- [ ] Config section parsing tests\n- [ ] CLI command output tests\n- [ ] All tests pass: `cargo test -p codex-core -p codex-tui`","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:39.060372719+01:00","updated_at":"2025-12-13T12:58:39.060372719+01:00","dependencies":[{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:58:39.060741593+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.967286532+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.3","type":"blocks","created_at":"2025-12-13T12:58:48.978608111+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.4","type":"blocks","created_at":"2025-12-13T12:58:48.98658045+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.2","title":"Add required fields to SubagentMetadata","description":"## What\n\nUpdate `SubagentMetadata` to require explicit values for all fields: `name`, `description`, `profile`, `sandbox_policy`, `approval_policy`, `allowed_subagents`.\n\n## Why\n\nAll agent configuration must be explicit - no magic defaults. This makes agent behavior predictable and auditable.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nUpdate `SubagentMetadata`:\n\n```rust\n#[derive(Debug, Clone, Deserialize)]\npub struct SubagentMetadata {\n    /// Human-readable display name (required)\n    pub name: String,\n    \n    /// Description of when to use this agent, max 500 chars (required)\n    pub description: String,\n    \n    /// Profile name from config.toml [profiles] (required)\n    pub profile: String,\n    \n    /// Sandbox policy (required)\n    pub sandbox_policy: SubagentSandboxPolicy,\n    \n    /// Approval policy (required)\n    pub approval_policy: AskForApproval,\n    \n    /// List of agent slugs this agent can delegate to (required, can be empty)\n    pub allowed_subagents: Vec\u003cString\u003e,\n    \n    /// Extra fields for forward compatibility\n    #[serde(flatten)]\n    pub extra: HashMap\u003cString, serde_yaml::Value\u003e,\n}\n```\n\n### Validation constants\n\n```rust\npub const MAX_DESCRIPTION_LENGTH: usize = 500;\n```\n\n### Migration note\n\nExisting agents without these fields will fail to load. Users must update their agent files.\n\n## Acceptance Criteria\n\n- [ ] All 6 fields are non-optional in struct\n- [ ] `MAX_DESCRIPTION_LENGTH` constant defined\n- [ ] Agents missing any field fail to parse with clear error\n- [ ] Update tests to use complete metadata\n- [ ] `cargo test -p codex-core` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:07.120610403+01:00","updated_at":"2025-12-13T12:54:07.120610403+01:00","dependencies":[{"issue_id":"codex-i1o.2","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:54:07.120988484+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.3","title":"Add agent validation during loading","description":"## What\n\nAdd comprehensive validation when loading agents: description length, profile existence, valid enum values.\n\n## Why\n\nHard constraints must be enforced at load time. Invalid agents should fail with clear error messages.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nAdd validation in `load_subagents()`:\n\n```rust\n#[derive(Debug, Clone)]\npub struct AgentValidationError {\n    pub slug: String,\n    pub path: PathBuf,\n    pub message: String,\n}\n\npub fn validate_agent(\n    agent: \u0026SubagentDefinition,\n    available_profiles: \u0026HashSet\u003cString\u003e,\n) -\u003e Option\u003cAgentValidationError\u003e {\n    // Check description length\n    if agent.metadata.description.len() \u003e MAX_DESCRIPTION_LENGTH {\n        return Some(AgentValidationError {\n            slug: agent.slug.clone(),\n            path: agent.path.clone(),\n            message: format!(\n                \"description exceeds {} characters (got {})\",\n                MAX_DESCRIPTION_LENGTH,\n                agent.metadata.description.len()\n            ),\n        });\n    }\n    \n    // Check profile exists\n    if !available_profiles.contains(\u0026agent.metadata.profile) {\n        return Some(AgentValidationError {\n            slug: agent.slug.clone(),\n            path: agent.path.clone(),\n            message: format!(\n                \"profile '{}' not found. Available: {}\",\n                agent.metadata.profile,\n                available_profiles.iter().cloned().collect::\u003cVec\u003c_\u003e\u003e().join(\", \")\n            ),\n        });\n    }\n    \n    None\n}\n```\n\n### Update `SubagentLoadOutcome`\n\n```rust\npub struct SubagentLoadOutcome {\n    pub agents: Vec\u003cSubagentDefinition\u003e,\n    pub parse_errors: Vec\u003cSubagentError\u003e,      // YAML/missing field errors\n    pub validation_errors: Vec\u003cAgentValidationError\u003e,  // NEW: semantic errors\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Description \u003e 500 chars → agent rejected with clear message\n- [ ] Invalid profile → agent rejected with available profiles listed\n- [ ] Parse errors (missing fields) reported separately\n- [ ] Validation errors include slug and path\n- [ ] `cargo test -p codex-core` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:21.437502157+01:00","updated_at":"2025-12-13T12:54:21.437502157+01:00","dependencies":[{"issue_id":"codex-i1o.3","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:54:21.437822729+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.3","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.831977814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.4","title":"Add agent conflict detection","description":"## What\n\nDetect when an agent slug exists in both global and project scopes. Report as warning at startup.\n\n## Why\n\nProject agents take precedence over global, but users should know about conflicts to avoid confusion.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nAdd conflict detection:\n\n```rust\n#[derive(Debug, Clone)]\npub struct AgentConflict {\n    pub slug: String,\n    pub project_path: PathBuf,\n    pub global_path: PathBuf,\n}\n\npub fn detect_conflicts(\n    project_agents: \u0026[SubagentDefinition],\n    global_agents: \u0026[SubagentDefinition],\n) -\u003e Vec\u003cAgentConflict\u003e {\n    let global_slugs: HashMap\u003c\u0026str, \u0026PathBuf\u003e = global_agents\n        .iter()\n        .map(|a| (a.slug.as_str(), \u0026a.path))\n        .collect();\n    \n    project_agents\n        .iter()\n        .filter_map(|p| {\n            global_slugs.get(p.slug.as_str()).map(|global_path| AgentConflict {\n                slug: p.slug.clone(),\n                project_path: p.path.clone(),\n                global_path: (*global_path).clone(),\n            })\n        })\n        .collect()\n}\n```\n\n### File: `core/src/subagents.rs` - Update outcome\n\n```rust\npub struct SubagentLoadOutcome {\n    pub agents: Vec\u003cSubagentDefinition\u003e,\n    pub parse_errors: Vec\u003cSubagentError\u003e,\n    pub validation_errors: Vec\u003cAgentValidationError\u003e,\n    pub conflicts: Vec\u003cAgentConflict\u003e,  // NEW\n}\n```\n\n### Precedence rule\n\nWhen merging agents, project agents override global agents with same slug.\n\n## Acceptance Criteria\n\n- [ ] `detect_conflicts()` function implemented\n- [ ] Conflicts returned in `SubagentLoadOutcome`\n- [ ] Project agents take precedence in merged registry\n- [ ] Test for conflict detection\n- [ ] `cargo test -p codex-core` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:34.766416129+01:00","updated_at":"2025-12-13T12:54:34.766416129+01:00","dependencies":[{"issue_id":"codex-i1o.4","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:54:34.766737903+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.4","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.84058263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.5","title":"Display agent warnings at TUI startup","description":"## What\n\nShow one-time warning messages at TUI startup for agent conflicts (soft constraints).\n\n## Why\n\nUsers need to know about conflicts between project and global agents, but these shouldn't block startup.\n\n## How\n\n### File: `tui/src/app.rs` (or appropriate startup location)\n\nAfter loading agents, check for conflicts and display:\n\n```rust\n// During TUI initialization, after loading agents\nif !agent_outcome.conflicts.is_empty() {\n    for conflict in \u0026agent_outcome.conflicts {\n        // Display warning - similar to MCP error display\n        eprintln!(\n            \"⚠ Agent conflict detected: '{}' exists in both project and global.\",\n            conflict.slug\n        );\n        eprintln!(\"  Project agent takes precedence. Consider renaming one.\");\n    }\n}\n```\n\n### Display format\n\n```\n⚠ Agent conflict detected: 'security-reviewer' exists in both project and global.\n  Project agent takes precedence. Consider renaming one.\n```\n\n### Behavior\n\n- One-time display at startup\n- Does not block TUI from starting\n- Similar pattern to MCP connection warnings\n\n## Acceptance Criteria\n\n- [ ] Conflicts displayed at startup\n- [ ] Warning format matches design doc\n- [ ] TUI continues after displaying warnings\n- [ ] Multiple conflicts each get their own message\n- [ ] `cargo test -p codex-tui` passes","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:47.335277405+01:00","updated_at":"2025-12-13T12:54:47.335277405+01:00","dependencies":[{"issue_id":"codex-i1o.5","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:54:47.335590273+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.5","depends_on_id":"codex-i1o.4","type":"blocks","created_at":"2025-12-13T12:58:48.848192687+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.6","title":"Implement 'codex agent list' CLI command","description":"## What\n\nImplement `codex agent list` command to display all agents grouped by scope.\n\n## Why\n\nUsers need to see what agents are available and where they're defined.\n\n## How\n\n### File: `cli/src/agent_cmd.rs` (new file)\n\n```rust\nuse clap::{Parser, Subcommand};\nuse codex_core::subagents::{load_subagents_from_both_scopes, SubagentDefinition};\nuse std::path::PathBuf;\n\n#[derive(Debug, Parser)]\npub struct AgentCli {\n    #[clap(subcommand)]\n    pub command: AgentCommand,\n}\n\n#[derive(Debug, Subcommand)]\npub enum AgentCommand {\n    /// List all available agents\n    List,\n    // ... other commands\n}\n\npub async fn run_agent_list(codex_home: \u0026Path, project_dir: Option\u003c\u0026Path\u003e) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    if project_agents.is_empty() \u0026\u0026 global_agents.is_empty() {\n        println!(\"No agents found.\");\n        println!();\n        println!(\"Create one with: codex agent create\");\n        return Ok(());\n    }\n    \n    if !project_agents.is_empty() {\n        println!(\"PROJECT AGENTS\");\n        for agent in \u0026project_agents {\n            println!(\"  {} - {}\", agent.slug, agent.metadata.description);\n        }\n        println!();\n    }\n    \n    if !global_agents.is_empty() {\n        println!(\"GLOBAL AGENTS\");\n        for agent in \u0026global_agents {\n            println!(\"  {} - {}\", agent.slug, agent.metadata.description);\n        }\n    }\n    \n    Ok(())\n}\n```\n\n### File: `cli/src/main.rs`\n\nAdd to Subcommand enum:\n```rust\n/// Manage agents\nAgent(agent_cmd::AgentCli),\n```\n\n### Output format\n\n```\nPROJECT AGENTS\n  security-reviewer - Reviews code for security vulnerabilities\n\nGLOBAL AGENTS\n  explorer - Fast codebase exploration\n  researcher - Deep research tasks\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent list` shows agents grouped by scope\n- [ ] Empty sections are omitted\n- [ ] Empty state shows helpful message\n- [ ] Description truncated if very long (single line)\n- [ ] Works without [agent_wizard] config","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:03.484477718+01:00","updated_at":"2025-12-13T12:55:03.484477718+01:00","dependencies":[{"issue_id":"codex-i1o.6","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:55:03.484885326+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.6","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.857049825+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.7","title":"Implement 'codex agent edit' CLI command","description":"## What\n\nImplement `codex agent edit \u003cslug\u003e` command to open agent file in $EDITOR.\n\n## Why\n\nUsers need to edit agent configurations after creation.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Parser)]\npub struct AgentEditArgs {\n    /// Agent slug to edit\n    slug: String,\n}\n\npub async fn run_agent_edit(\n    codex_home: \u0026Path,\n    project_dir: Option\u003c\u0026Path\u003e,\n    slug: \u0026str,\n) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    let project_match = project_agents.iter().find(|a| a.slug == slug);\n    let global_match = global_agents.iter().find(|a| a.slug == slug);\n    \n    let path = match (project_match, global_match) {\n        (Some(p), Some(g)) =\u003e {\n            // Ambiguous - show picker\n            println!(\"Multiple agents named '{}':\", slug);\n            println!();\n            println!(\"1. Project ({})\", p.path.display());\n            println!(\"2. Global  ({})\", g.path.display());\n            println!();\n            print!(\"Select [1-2]: \");\n            io::stdout().flush()?;\n            \n            let mut input = String::new();\n            io::stdin().read_line(\u0026mut input)?;\n            \n            match input.trim() {\n                \"1\" =\u003e p.path.clone(),\n                \"2\" =\u003e g.path.clone(),\n                _ =\u003e anyhow::bail!(\"Invalid selection\"),\n            }\n        }\n        (Some(p), None) =\u003e p.path.clone(),\n        (None, Some(g)) =\u003e g.path.clone(),\n        (None, None) =\u003e anyhow::bail!(\"Agent '{}' not found\", slug),\n    };\n    \n    let editor = std::env::var(\"EDITOR\").unwrap_or_else(|_| \"vi\".to_string());\n    let status = std::process::Command::new(\u0026editor)\n        .arg(\u0026path)\n        .status()?;\n    \n    if !status.success() {\n        anyhow::bail!(\"Editor exited with non-zero status\");\n    }\n    \n    Ok(())\n}\n```\n\n### Add to AgentCommand enum\n\n```rust\n/// Edit an agent in $EDITOR\nEdit(AgentEditArgs),\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent edit \u003cslug\u003e` opens file in $EDITOR\n- [ ] Ambiguous slug shows picker with numbered options\n- [ ] Missing slug shows error message\n- [ ] Falls back to `vi` if $EDITOR not set\n- [ ] Works without [agent_wizard] config","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:18.90041727+01:00","updated_at":"2025-12-13T12:55:18.90041727+01:00","dependencies":[{"issue_id":"codex-i1o.7","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:55:18.900753411+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.7","depends_on_id":"codex-i1o.6","type":"blocks","created_at":"2025-12-13T12:58:48.864906674+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.8","title":"Implement 'codex agent delete' CLI command","description":"## What\n\nImplement `codex agent delete \u003cslug\u003e` command with confirmation prompt.\n\n## Why\n\nUsers need to remove agents they no longer need.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Parser)]\npub struct AgentDeleteArgs {\n    /// Agent slug to delete\n    slug: String,\n    \n    /// Skip confirmation prompt\n    #[arg(long)]\n    yes: bool,\n}\n\npub async fn run_agent_delete(\n    codex_home: \u0026Path,\n    project_dir: Option\u003c\u0026Path\u003e,\n    args: AgentDeleteArgs,\n) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    let project_match = project_agents.iter().find(|a| a.slug == args.slug);\n    let global_match = global_agents.iter().find(|a| a.slug == args.slug);\n    \n    let path = match (project_match, global_match) {\n        (Some(p), Some(g)) =\u003e {\n            // Ambiguous - show picker (same as edit)\n            // ... picker code ...\n        }\n        (Some(p), None) =\u003e p.path.clone(),\n        (None, Some(g)) =\u003e g.path.clone(),\n        (None, None) =\u003e anyhow::bail!(\"Agent '{}' not found\", args.slug),\n    };\n    \n    // Confirmation\n    if !args.yes {\n        print!(\"Delete {}? [y/N]: \", path.display());\n        io::stdout().flush()?;\n        \n        let mut input = String::new();\n        io::stdin().read_line(\u0026mut input)?;\n        \n        if !input.trim().eq_ignore_ascii_case(\"y\") {\n            println!(\"Cancelled.\");\n            return Ok(());\n        }\n    }\n    \n    std::fs::remove_file(\u0026path)?;\n    println!(\"Deleted {}.\", path.display());\n    \n    Ok(())\n}\n```\n\n### Add to AgentCommand enum\n\n```rust\n/// Delete an agent\nDelete(AgentDeleteArgs),\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent delete \u003cslug\u003e` prompts for confirmation\n- [ ] `--yes` flag skips confirmation\n- [ ] Ambiguous slug shows picker\n- [ ] Missing slug shows error\n- [ ] Confirmation default is No (must type 'y')\n- [ ] Works without [agent_wizard] config","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:32.958993816+01:00","updated_at":"2025-12-13T12:55:32.958993816+01:00","dependencies":[{"issue_id":"codex-i1o.8","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:55:32.959307534+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.8","depends_on_id":"codex-i1o.6","type":"blocks","created_at":"2025-12-13T12:58:48.87528811+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.9","title":"Create agent generation prompt","description":"## What\n\nCreate the LLM prompt used to generate agent configurations from user descriptions.\n\n## Why\n\nThe wizard uses an LLM to generate slug, name, and system_prompt from a natural language description.\n\n## How\n\n### File: `core/src/prompts/agent_generate.md` (new file)\n\n```markdown\nYou are an expert AI agent architect. Generate a focused, effective agent configuration.\n\n## Task\n\nCreate an agent based on this description:\n\"{description}\"\n\n## Output Format (JSON)\n\n{\n  \"slug\": \"lowercase-with-hyphens\",\n  \"name\": \"Human Readable Name\", \n  \"system_prompt\": \"You are an expert...\"\n}\n\n## Rules\n\n1. **slug**: lowercase, hyphens only, 2-4 words, descriptive (e.g., \"security-reviewer\", \"api-docs-writer\")\n2. **name**: Title case, human-readable version of slug\n3. **system_prompt**: \n   - Second person (\"You are...\", \"You will...\")\n   - Specific, actionable instructions\n   - Include what the agent should NOT do\n   - 200-500 words typical length\n\n## Existing Slugs (DO NOT REUSE)\n\n{existing_slugs}\n```\n\n### File: `core/src/agent_generator.rs` (reference)\n\n```rust\nconst AGENT_GENERATION_PROMPT: \u0026str = include_str!(\"prompts/agent_generate.md\");\n```\n\n## Acceptance Criteria\n\n- [ ] Prompt file created at correct location\n- [ ] Placeholders for {description} and {existing_slugs}\n- [ ] Clear rules for slug, name, system_prompt format\n- [ ] Embedded via include_str! in agent_generator.rs","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:47.879037652+01:00","updated_at":"2025-12-13T12:55:47.879037652+01:00","dependencies":[{"issue_id":"codex-i1o.9","depends_on_id":"codex-i1o","type":"parent-child","created_at":"2025-12-13T12:55:47.879386959+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t","title":"Implement Antigravity Provider Support","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-06T12:34:26.379799781+01:00","updated_at":"2025-12-13T20:38:21.838736968+01:00","closed_at":"2025-12-13T20:38:21.838736968+01:00"}
{"id":"codex-i1t.1","title":"Define Antigravity Protocol and Types","description":"Extend core types to recognize Antigravity as a distinct authentication mode and wire protocol.\n\n**Actions:**\n1.  **codex-rs/app-server-protocol/src/protocol/common.rs**:\n    *   Update `enum AuthMode` to include `Antigravity`.\n    *   This distinguishes the login/auth flow from standard Gemini.\n\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Update `enum WireApi` to include `Antigravity`.\n    *   Update `enum ProviderKind` to include `Antigravity` (optional, but recommended for consistency).\n\n**Why:**\nThis is the foundational type work needed before we can write the implementation logic.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:31.707276308+01:00","updated_at":"2025-12-06T22:46:13.199124796+01:00","closed_at":"2025-12-06T22:46:13.199124796+01:00","dependencies":[{"issue_id":"codex-i1t.1","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:31.707575027+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.2","title":"Add Antigravity Configuration and Constants","description":"Create the configuration module containing hardcoded credentials and endpoints.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity.rs`\n2.  **Add Constants** (Mirroring the Python reference implementation):\n    *   `ANTIGRAVITY_CLIENT_ID`: \"1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com\"\n    *   `ANTIGRAVITY_CLIENT_SECRET`: \"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\"\n    *   `ANTIGRAVITY_AUTH_URL`, `ANTIGRAVITY_TOKEN_URL` (Standard Google OAuth endpoints).\n    *   `ANTIGRAVITY_ENDPOINT`: \"https://daily-cloudcode-pa.sandbox.googleapis.com\" (Note: Use the Sandbox URL as primary).\n    *   `ANTIGRAVITY_SCOPES`: Must include:\n        *   `https://www.googleapis.com/auth/cloud-platform`\n        *   `https://www.googleapis.com/auth/userinfo.email`\n        *   `https://www.googleapis.com/auth/cclog` (Critical)\n        *   `https://www.googleapis.com/auth/experimentsandconfigs` (Critical)\n\n**Why:**\nThese specific credentials and scopes are required to masquerade as the Antigravity client.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:38.497295683+01:00","updated_at":"2025-12-06T22:47:24.157608954+01:00","closed_at":"2025-12-06T22:47:24.157608954+01:00","dependencies":[{"issue_id":"codex-i1t.2","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:38.4976193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.3","title":"Implement Antigravity Authentication Flow","description":"Implement the OAuth flow using the Antigravity credentials.\n\n**Actions:**\n1.  **codex-rs/core/src/auth.rs**:\n    *   Update `CodexAuth` to handle `AuthMode::Antigravity`.\n    *   In `refresh_token()` logic:\n        *   Check if `mode == AuthMode::Antigravity`.\n        *   If so, use `antigravity::ANTIGRAVITY_CLIENT_ID/SECRET` instead of the Gemini ones.\n    *   In `login()` (if applicable) or manual token setup paths, ensure the correct scopes are requested.\n2.  **codex-rs/core/src/token_data.rs**:\n    *   Reuse `GeminiTokenData` struct for storage, as the fields (access_token, refresh_token, project_id) are identical.\n\n**Why:**\nWe need to authenticate *as* Antigravity to be allowed to call the internal endpoints.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:44.751257296+01:00","updated_at":"2025-12-06T23:27:23.359225469+01:00","closed_at":"2025-12-06T23:27:23.359225469+01:00","dependencies":[{"issue_id":"codex-i1t.3","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:44.751596443+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.4","title":"Refactor Gemini Messages for Reusability","description":"Extract payload construction logic to allow wrapping.\n\n**Actions:**\n1.  **codex-rs/core/src/gemini_messages.rs**:\n    *   Locate the `stream_gemini_messages` function.\n    *   Extract the logic that builds the `GeminiRequest` struct (converting `Prompt`, `tools`, etc.) into a new public function:\n        ```rust\n        pub fn build_gemini_payload(prompt: \u0026Prompt, config: \u0026Config, ...) -\u003e Result\u003cGeminiRequest\u003e\n        ```\n    *   Make `GeminiRequest` and its inner types (`GeminiContent`, `GeminiTool`, etc.) public (or public to crate) so they can be used by the Antigravity module.\n\n**Why:**\nAntigravity uses the *exact same* internal payload structure, but wraps it in an outer envelope. We must not duplicate the complex logic of converting Codex prompts/tools into the Gemini format.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:50.699256599+01:00","updated_at":"2025-12-06T23:27:28.524168016+01:00","closed_at":"2025-12-06T23:27:28.524168016+01:00","dependencies":[{"issue_id":"codex-i1t.4","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:50.69960826+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.5","title":"Implement Antigravity Message Streaming","description":"Implement the core Antigravity request/response logic.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity_messages.rs`\n2.  **Request Logic**:\n    *   Call `gemini_messages::build_gemini_payload(...)` to get the inner model request.\n    *   Wrap it in the Antigravity envelope:\n        ```rust\n        #[derive(Serialize)]\n        struct AntigravityRequest {\n            project: String, // from token data\n            userAgent: String, // MUST be \"antigravity\"\n            requestId: String, // \"agent-{uuid}\"\n            model: String,     // e.g. \"gemini-3-pro-preview\"\n            request: GeminiRequest,\n        }\n        ```\n3.  **Streaming Logic**:\n    *   Send POST to `{ANTIGRAVITY_ENDPOINT}/v1internal:streamGenerateContent`.\n    *   Use `eventsource-stream` (or similar) to handle SSE.\n4.  **Response Unwrapping**:\n    *   The stream yields JSON chunks.\n    *   **Crucial Step**: The chunks are Antigravity envelopes. You must extract the inner `response` field.\n        *   Example Chunk: `{\"responseId\": \"...\", \"response\": { \"candidates\": [...] }}`\n        *   Extract the inner object and treat it exactly like a standard Gemini chunk.\n    *   Reuse `gemini_messages::handle_stream_chunk` (or similar logic) if possible, or adapt it to parse the unwrapped chunk.\n\n**Why:**\nThis is the core logic that differentiates Antigravity from standard Gemini. The envelope makes the server treat us as the internal \"CloudCode\" tool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:57.840908107+01:00","updated_at":"2025-12-06T23:27:36.456056193+01:00","closed_at":"2025-12-06T23:27:36.456056193+01:00","dependencies":[{"issue_id":"codex-i1t.5","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:57.841295316+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.6","title":"Wire Antigravity into Client and Config","description":"Integrate the new provider into the main client dispatch.\n\n**Actions:**\n1.  **codex-rs/core/src/client.rs**:\n    *   In `ModelClient::stream()`, add a match arm for `WireApi::Antigravity`.\n    *   Call `antigravity_messages::stream_antigravity_messages(...)`.\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Ensure configuration loading (TOML) supports the new `wire_api = \"antigravity\"` string enum.\n\n**Why:**\nThis makes the new functionality accessible to the end user via their config.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:35:02.836823082+01:00","updated_at":"2025-12-06T23:53:10.512430351+01:00","closed_at":"2025-12-06T23:53:10.512430351+01:00","dependencies":[{"issue_id":"codex-i1t.6","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:35:02.837109549+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i3d","title":"Fix P1: Update cwd when reusing subagent session","description":"## Problem\nWhen reusing a subagent session via session_id, the Codex instance still has cwd pointing to the OLD worktree which was deleted after previous turn's merge.\n\n## Solution\nUse `Op::OverrideTurnContext` to update the cwd when reusing a session.\n\n## Implementation\n\nIn `core/src/tools/handlers/task.rs`, modify the session lookup to track if session was reused:\n\n### Step 1: Change session lookup to return reuse flag\n\nFind the block that gets `subagent_session_ref`. Change it to also return whether session was reused:\n\n```rust\nlet (subagent_session_ref, is_reused): (Arc\u003ccrate::codex::Codex\u003e, bool) = {\n    let services = \u0026invocation.session.services;\n    let mut sessions = services.subagent_sessions.lock().await;\n\n    if let Some(session) = sessions.get(\u0026session_id) {\n        info!(\n            subagent = %args.subagent_type,\n            session_id = %session_id,\n            \"Reusing existing subagent session\"\n        );\n        (session.codex.clone(), true)\n    } else {\n        // ... existing session creation logic ...\n        (codex_arc, false)\n    }\n};\n```\n\n### Step 2: Add OverrideTurnContext submission for reused sessions\n\nAfter getting the session but BEFORE sending TaskStarted event, add:\n\n```rust\n// If reusing session, update cwd to new worktree\nif is_reused {\n    tracing::warn!(\n        session_id = %session_id,\n        new_cwd = %effective_cwd.display(),\n        \"Reusing subagent session with new worktree - conversation history may reference outdated file state\"\n    );\n    \n    subagent_session_ref\n        .submit(Op::OverrideTurnContext {\n            cwd: Some(effective_cwd.clone()),\n            approval_policy: None,\n            sandbox_policy: None,\n            model: None,\n            effort: None,\n            summary: None,\n        })\n        .await\n        .map_err(|e| FunctionCallError::Fatal(format!(\"Failed to update subagent CWD: {e}\")))?;\n}\n```\n\n### Step 3: Add import for Op if not present\n\nMake sure `Op` is imported:\n```rust\nuse codex_protocol::protocol::Op;\n```\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T18:22:47.861172961+01:00","updated_at":"2025-12-21T18:33:00.879638276+01:00","closed_at":"2025-12-21T18:33:00.879638276+01:00"}
{"id":"codex-ip10","title":"Port models from static file (2666d0984)","description":"Load models from static file (models.json) instead of API calls","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:39:28.863154905+01:00","closed_at":"2025-12-18T12:39:28.863154905+01:00"}
{"id":"codex-ip11","title":"Port model picker enhancement (cc5231104)","description":"feat: model picker (#8209) - Enhanced model selection UI","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:46:45.672648767+01:00","closed_at":"2025-12-18T12:46:45.672648767+01:00"}
{"id":"codex-ip6","title":"Port upstream changes","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-18T02:41:52.575507538+01:00","updated_at":"2025-12-18T11:49:15.758772302+01:00","closed_at":"2025-12-18T11:49:15.758774366+01:00"}
{"id":"codex-ip6.1","title":"Port parallel tool calls fix (227aa5098)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:42:05.60790139+01:00","updated_at":"2025-12-18T11:48:01.59863462+01:00","closed_at":"2025-12-18T11:48:01.59863462+01:00","dependencies":[{"issue_id":"codex-ip6.1","depends_on_id":"codex-ip6","type":"parent-child","created_at":"2025-12-18T02:42:05.608562543+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-ip6.2","title":"Port session downgrade fix (c96975f51)","description":"Fix from upstream for session handling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:21.834825168+01:00","closed_at":"2025-12-18T11:48:21.834825168+01:00"}
{"id":"codex-ip6.3","title":"Port race on rx subscription fix (5ac5e87ff)","description":"Race condition fix from upstream","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:26.891946771+01:00","closed_at":"2025-12-18T11:48:26.891946771+01:00"}
{"id":"codex-ip6.4","title":"Port reasoning summary None fix (ccc5c7899)","description":"Fix: omit reasoning summary when ReasoningSummary::None","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:11.719324186+01:00","closed_at":"2025-12-18T11:48:11.719324186+01:00"}
{"id":"codex-ip6.5","title":"Port slash commands fuzzy matching fix (f78ad4ea6)","description":"Fixed regression that broke fuzzy matching for slash commands","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:16.783233845+01:00","closed_at":"2025-12-18T11:48:16.783233845+01:00"}
{"id":"codex-ip6.6","title":"Port keybindings input burst fix (fefe231ac)","description":"Fix: Don't trigger keybindings view on input burst","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:06.662915882+01:00","closed_at":"2025-12-18T11:48:06.662915882+01:00"}
{"id":"codex-ip7","title":"Port shell snapshotting feature","description":"Saves shell state for resume. Commits: a62ae37e5, 6f78cebc1","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T11:48:44.214501363+01:00","closed_at":"2025-12-18T11:48:44.214501363+01:00"}
{"id":"codex-ip7.1","title":"Port shell snapshotting base (a62ae37e5)","description":"feat: shell snapshotting (#7641)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:35.986590935+01:00","closed_at":"2025-12-18T12:36:35.986590935+01:00"}
{"id":"codex-ip7.2","title":"Port shell snapshot for shell command (6f78cebc1)","description":"feat: add shell snapshot for shell command (#7786)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:41.03101479+01:00","closed_at":"2025-12-18T12:36:41.03101479+01:00"}
{"id":"codex-ip8","title":"Port ghost snapshots v2 feature","description":"Git state snapshots. Commits: 138d6ca3f, b4aab5fb9","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T11:48:39.157036342+01:00","closed_at":"2025-12-18T11:48:39.157036342+01:00"}
{"id":"codex-ip8.1","title":"Port config ghost commits (138d6ca3f)","description":"feat: config ghost commits (#7873)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:46.075869453+01:00","closed_at":"2025-12-18T12:36:46.075869453+01:00"}
{"id":"codex-ip8.2","title":"Port ghost snapshot v2 (b4aab5fb9)","description":"feat: ghost snapshot v2 (#8055)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:51.121140758+01:00","closed_at":"2025-12-18T12:36:51.121140758+01:00"}
{"id":"codex-ip9","title":"Port SkillsManager refactor (245ea7a75)","description":"Reimplement skills loading using SkillsManager + skills/list op","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:26:41.806549333+01:00","closed_at":"2025-12-18T12:26:41.806549333+01:00"}
{"id":"codex-mxb","title":"Fail on non-git directory instead of silent degradation","description":"## Problem\nCurrent implementation silently degrades when workspace is not a git repository - it logs a warning and runs subagent without isolation. This violates the \"all or nothing\" principle and can cause:\n- Parallel subagents corrupting each other's files\n- No change tracking (wrong information)\n- Silent data loss\n\n## Solution\nFail immediately with a clear, actionable error when git is not available.\n\n## Implementation\n\n### Step 1: Remove the graceful degradation in task.rs\n\nFind this code in `core/src/tools/handlers/task.rs`:\n\n```rust\nlet worktree_handle = match worktree_manager.create_worktree(\u0026parent_worktree).await {\n    Ok(handle) =\u003e Some(handle),\n    Err(e) =\u003e {\n        tracing::warn!(\n            subagent = %args.subagent_type,\n            error = %e,\n            \"Failed to create worktree, running without isolation\"\n        );\n        None\n    }\n};\n```\n\nReplace with:\n\n```rust\nlet worktree_handle = worktree_manager\n    .create_worktree(\u0026parent_worktree)\n    .await\n    .map_err(|e| {\n        FunctionCallError::RespondToModel(format!(\n            \"Subagent execution requires a git repository for workspace isolation.              Error: {e}. Please ensure you are in a git repository (run 'git init' if needed).\"\n        ))\n    })?;\n```\n\n### Step 2: Update subsequent code that checks for Option\n\nThe code currently uses `if let Some(ref handle) = worktree_handle`. \n\nAfter the change, `worktree_handle` is no longer an Option - it's always `WorktreeHandle`.\n\nUpdate all usages:\n\nBefore:\n```rust\nlet effective_cwd = worktree_handle\n    .as_ref()\n    .map(|h| h.path.clone())\n    .unwrap_or_else(|| parent_worktree.clone());\n```\n\nAfter:\n```rust\nlet effective_cwd = worktree_handle.path.clone();\n```\n\nBefore:\n```rust\nif let Some(ref handle) = worktree_handle {\n    // cleanup\n}\n```\n\nAfter:\n```rust\n// Always cleanup since worktree always exists\nlet _ = worktree_manager.cleanup(\u0026worktree_handle).await;\n```\n\nBefore:\n```rust\nlet subagent_changes: Option\u003cSubagentChanges\u003e = if let Some(ref handle) = worktree_handle {\n    // ...\n} else {\n    None\n};\n```\n\nAfter:\n```rust\nlet subagent_changes: SubagentChanges = {\n    // ... (no Option needed, always have handle)\n};\n```\n\n### Step 3: Update CARGO_TARGET_DIR logic\n\nBefore:\n```rust\nif worktree_handle.is_some() {\n    // set CARGO_TARGET_DIR\n}\n```\n\nAfter:\n```rust\n// Always in worktree now, always set\nlet cargo_target = parent_worktree.join(\"target\");\nif cargo_target.exists() || parent_worktree.join(\"Cargo.toml\").exists() {\n    sub_config.shell_environment_policy.r#set.insert(\n        \"CARGO_TARGET_DIR\".to_string(),\n        cargo_target.to_string_lossy().to_string(),\n    );\n}\n```\n\n### Step 4: Ensure cleanup on all error paths\n\nSince we now always have a worktree, ensure cleanup happens on:\n- Subagent crash/timeout\n- TurnAborted\n- Any error after worktree creation\n\nUse a guard pattern or ensure all error paths call cleanup.\n\n## Files to modify\n- `core/src/tools/handlers/task.rs`\n\n## Error message format\nThe error returned to the model should be:\n```\nSubagent execution requires a git repository for workspace isolation. \nError: Not a git repository: /path/to/dir. \nPlease ensure you are in a git repository (run 'git init' if needed).\n```\n\n## Tests\n- Test that non-git directory returns error (not silent success)\n- Test that error message is actionable\n- Test that git directory works normally\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T15:01:12.251944448+01:00","updated_at":"2025-12-21T15:03:04.232420428+01:00","closed_at":"2025-12-21T15:03:04.232420428+01:00"}
{"id":"codex-p1z","title":"Improve tool output truncation policy","description":"Improve how codex-rs truncates tool outputs (shell commands, MCP tools, etc.) to better preserve useful context for the model.\n\n## Problem\nCurrent truncation uses a balanced 50/50 split (prefix + suffix), but:\n1. Stack traces, errors, and final results are usually at the END of output\n2. When output is truncated, the model has no way to retrieve the full output\n3. Non-OpenAI models (Claude, Gemini) can handle different truncation strategies\n\n## Current Behavior\n- **Prompt tells model**: \"Command line output will be truncated after 10 kilobytes or 256 lines\"\n- **Actual implementation**: Uses token-based (10k tokens) or byte-based (10KB) truncation, NOT line-based\n- OpenAI codex models: `TruncationPolicy::Tokens(10_000)`\n- Claude/Gemini: `TruncationPolicy::Bytes(10_000)`\n- Default fallback: `TruncationPolicy::Bytes(50_000)`\n\n## Research Findings\n- **gemini-cli**: Uses 20/80 head/tail split (1000 lines), 4MB threshold, writes full output to temp file\n- **opencode**: Uses 30k chars front-cut (loses tail)\n- **Claude Code**: Similar middle-cut but focuses on keeping errors visible\n\n## Goals\n1. Add configurable truncation bias (balanced vs tail-heavy) per model family\n2. Add file fallback mechanism so model can retrieve full output when needed\n3. Keep OpenAI models using balanced truncation (API requirement)\n4. Use tail-heavy truncation for Claude, Gemini, and other models","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T15:29:25.798282082+01:00","updated_at":"2025-12-12T16:19:23.491396911+01:00","closed_at":"2025-12-12T16:19:23.491396911+01:00"}
{"id":"codex-p1z.1","title":"Add TruncationBias enum to truncate.rs","description":"Add a new enum to control how truncation distributes budget between head and tail.\n\n## Implementation\n\nAdd to `core/src/truncate.rs`:\n\n```rust\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Default)]\npub enum TruncationBias {\n    #[default]\n    Balanced,    // 50/50 split - current behavior, required for OpenAI\n    TailHeavy,   // 20/80 split - better for error messages, stack traces\n}\n\nimpl TruncationBias {\n    pub fn head_ratio(\u0026self) -\u003e f64 {\n        match self {\n            TruncationBias::Balanced =\u003e 0.5,\n            TruncationBias::TailHeavy =\u003e 0.2,\n        }\n    }\n    \n    pub fn tail_ratio(\u0026self) -\u003e f64 {\n        1.0 - self.head_ratio()\n    }\n}\n```\n\n## Acceptance Criteria\n- [ ] Enum is public and exported from truncate module\n- [ ] Default is Balanced (backwards compatible)\n- [ ] Has helper methods for getting head/tail ratios\n- [ ] Unit tests for ratio calculations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:29:47.607595444+01:00","updated_at":"2025-12-12T15:39:38.987192018+01:00","closed_at":"2025-12-12T15:39:38.987192018+01:00","dependencies":[{"issue_id":"codex-p1z.1","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:29:47.60790742+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.2","title":"Modify truncation functions to accept bias parameter","description":"Update the core truncation functions to use TruncationBias when splitting content.\n\n## Files to Modify\n- `core/src/truncate.rs`\n\n## Functions to Update\n\n### truncate_with_byte_estimate\nCurrently uses hardcoded 50/50 split. Change to:\n```rust\nfn truncate_with_byte_estimate(content: \u0026str, policy: TruncationPolicy, bias: TruncationBias) -\u003e String {\n    let budget = policy.byte_budget();\n    let head_budget = (budget as f64 * bias.head_ratio()) as usize;\n    let tail_budget = budget - head_budget;\n    // ... use head_budget and tail_budget for splitting\n}\n```\n\n### truncate_with_token_budget  \nSame pattern - accept bias parameter and use ratios.\n\n### truncate_text / formatted_truncate_text\nAdd bias parameter, pass through to underlying functions.\n\n## Backwards Compatibility\n- All existing call sites will need updating\n- Default bias should be Balanced to maintain current behavior\n\n## Acceptance Criteria\n- [ ] All truncation functions accept TruncationBias parameter\n- [ ] Balanced bias produces identical output to current behavior\n- [ ] TailHeavy bias keeps 80% of budget for tail content\n- [ ] Unit tests verify both bias modes\n- [ ] UTF-8 boundary handling still works correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:29:58.099070837+01:00","updated_at":"2025-12-12T15:44:25.948678587+01:00","closed_at":"2025-12-12T15:44:25.948678587+01:00","dependencies":[{"issue_id":"codex-p1z.2","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:29:58.099439081+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.2","depends_on_id":"codex-p1z.1","type":"blocks","created_at":"2025-12-12T15:31:45.169751674+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.3","title":"Add truncation_bias field to ModelFamily","description":"Add truncation_bias field to ModelFamily struct and set appropriate values per model.\n\n## Files to Modify\n- `core/src/openai_models/model_family.rs`\n\n## Changes\n\n### Add field to ModelFamily struct\n```rust\npub struct ModelFamily {\n    // ... existing fields ...\n    pub truncation_policy: TruncationPolicy,\n    pub truncation_bias: TruncationBias,  // NEW\n    pub mcp_truncation_policy: TruncationPolicy,\n    pub mcp_truncation_bias: TruncationBias,  // NEW (may differ for MCP)\n}\n```\n\n### Set per-model values\n\n| Model Family | Bias | Rationale |\n|-------------|------|-----------|\n| gpt-* (OpenAI) | Balanced | API requires balanced truncation |\n| claude-* | TailHeavy | Anthropic handles varied formats well |\n| gemini-* | TailHeavy | Google models handle tail-heavy well |\n| o1-*, o3-* | Balanced | OpenAI reasoning models |\n| Default/Unknown | Balanced | Safe fallback |\n\n### Update model_family! macro\nAdd truncation_bias to the macro with default Balanced.\n\n## Acceptance Criteria\n- [ ] ModelFamily has truncation_bias field\n- [ ] All OpenAI models use Balanced\n- [ ] Claude and Gemini models use TailHeavy\n- [ ] Default fallback is Balanced\n- [ ] model_family! macro supports the new field","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:30:13.310242031+01:00","updated_at":"2025-12-12T15:45:56.903728718+01:00","closed_at":"2025-12-12T15:45:56.903728718+01:00","dependencies":[{"issue_id":"codex-p1z.3","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:13.310579144+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.3","depends_on_id":"codex-p1z.1","type":"blocks","created_at":"2025-12-12T15:31:45.137942484+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.4","title":"Wire truncation_bias through TurnContext to truncation call sites","description":"Pass truncation_bias from ModelFamily through TurnContext to all places where truncation is performed.\n\n## Context Flow\nModelFamily -\u003e TurnContext -\u003e truncation functions\n\n## Files to Modify\n\n### core/src/codex.rs or turn context\nAdd truncation_bias to TurnContext (it already has truncation_policy).\n\n### core/src/tools/mod.rs\nUpdate format_exec_output_* functions to accept and use bias:\n- format_exec_output_for_model_structured\n- format_exec_output_for_model_freeform  \n- format_exec_output_str\n\n### core/src/mcp_tool_call.rs\nUpdate MCP truncation to use mcp_truncation_bias.\n\n### core/src/unified_exec/session.rs and session_manager.rs\nUpdate unified exec truncation to use bias.\n\n### core/src/context_manager/history.rs\nIf truncation happens here, wire through bias.\n\n## Acceptance Criteria\n- [ ] TurnContext carries truncation_bias from ModelFamily\n- [ ] All truncation call sites use the bias from context\n- [ ] No hardcoded bias values in truncation calls\n- [ ] Tests pass with both Balanced and TailHeavy configurations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:30:26.014245293+01:00","updated_at":"2025-12-12T15:52:10.449645201+01:00","closed_at":"2025-12-12T15:52:10.449645201+01:00","dependencies":[{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:26.014684662+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z.3","type":"blocks","created_at":"2025-12-12T15:31:45.127437635+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z.2","type":"blocks","created_at":"2025-12-12T15:31:45.14868704+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.5","title":"Add file fallback for truncated output","description":"When output is truncated, save full content to a temp file and tell the model how to retrieve it.\n\n## Motivation\nCurrently when output is truncated, the model has no way to see the full content. Gemini-cli solves this by:\n1. Writing full output to a temp file\n2. Including the file path in the truncated message\n3. Instructing model to use read_file with offset/limit to paginate\n\n## Implementation\n\n### Add to truncate.rs\n```rust\npub struct TruncationResult {\n    pub content: String,\n    pub saved_file: Option\u003cPathBuf\u003e,\n    pub original_size: usize,\n}\n\npub fn truncate_with_file_fallback(\n    content: \u0026str,\n    policy: TruncationPolicy,\n    bias: TruncationBias,\n    temp_dir: \u0026Path,\n    call_id: \u0026str,\n) -\u003e std::io::Result\u003cTruncationResult\u003e\n```\n\n### Message format when truncated\n```\nOutput was truncated ({original_size} bytes -\u003e {truncated_size} bytes).\nFull output saved to: /tmp/codex/{call_id}.output\n\nTo read full output, use read_file tool with:\n- offset=0, limit=100 for first 100 lines\n- offset=N to skip N lines\n- limit=M to read M lines at a time\n\nTruncated output:\n{head}\n... [CONTENT TRUNCATED] ...\n{tail}\n```\n\n### Config\nAdd to Config:\n- `truncation_save_to_file: bool` (default: true)\n- Use existing `codex_home` for temp directory\n\n## Acceptance Criteria\n- [ ] Full output is saved to temp file when truncated\n- [ ] Truncated message includes file path and usage instructions\n- [ ] File is written atomically (write to .tmp then rename)\n- [ ] Graceful fallback if file write fails\n- [ ] Temp files are cleaned up on session end (optional, can be separate task)\n- [ ] Works with both Balanced and TailHeavy bias","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-12T15:30:40.915571164+01:00","updated_at":"2025-12-12T16:19:13.15430907+01:00","closed_at":"2025-12-12T16:19:13.15430907+01:00","dependencies":[{"issue_id":"codex-p1z.5","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:40.915945779+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.5","depends_on_id":"codex-p1z.4","type":"blocks","created_at":"2025-12-12T15:31:45.180079073+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.6","title":"Add offset/limit parameters to read_file tool","description":"Extend the read_file tool to support offset and limit parameters for paginated reading.\n\n## Motivation\nWhen output is truncated and saved to a file, the model needs a way to read specific portions without loading the entire file. Gemini-cli's read_file tool supports:\n- `offset`: Skip N lines from the beginning\n- `limit`: Read only M lines\n\n## Current State\nCheck if read_file already supports these parameters. If not, add them.\n\n## Implementation\n\n### Update tool schema\n```json\n{\n  \"name\": \"read_file\",\n  \"parameters\": {\n    \"path\": { \"type\": \"string\" },\n    \"offset\": { \"type\": \"integer\", \"description\": \"Number of lines to skip from start\" },\n    \"limit\": { \"type\": \"integer\", \"description\": \"Maximum number of lines to read\" }\n  }\n}\n```\n\n### Update handler\n```rust\n// In tools/handlers/read_file.rs\nfn read_file_with_range(path: \u0026Path, offset: Option\u003cusize\u003e, limit: Option\u003cusize\u003e) -\u003e Result\u003cString\u003e\n```\n\n### Behavior\n- `offset=None, limit=None`: Read entire file (current behavior)\n- `offset=100, limit=None`: Skip first 100 lines, read rest\n- `offset=None, limit=50`: Read first 50 lines\n- `offset=100, limit=50`: Skip 100 lines, read next 50\n\n## Acceptance Criteria\n- [ ] read_file accepts offset and limit parameters\n- [ ] Parameters are optional with sensible defaults\n- [ ] Line counting is 0-based\n- [ ] Works correctly with UTF-8 content\n- [ ] Returns helpful message if offset exceeds file length\n- [ ] Tool description explains the parameters","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-12T15:30:53.775036219+01:00","updated_at":"2025-12-12T16:19:17.070377645+01:00","closed_at":"2025-12-12T16:19:17.070377645+01:00","dependencies":[{"issue_id":"codex-p1z.6","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:53.775426194+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.6","depends_on_id":"codex-p1z.5","type":"blocks","created_at":"2025-12-12T15:31:45.158761668+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.7","title":"Add tests for truncation bias modes","description":"Comprehensive tests for the new truncation bias functionality.\n\n## Test Cases\n\n### Unit tests in truncate.rs\n\n1. **Balanced bias produces 50/50 split**\n   - Input: 1000 char string, budget 200\n   - Expected: ~100 chars head + marker + ~100 chars tail\n\n2. **TailHeavy bias produces 20/80 split**  \n   - Input: 1000 char string, budget 200\n   - Expected: ~40 chars head + marker + ~160 chars tail\n\n3. **UTF-8 boundary handling with both biases**\n   - Input: String with multi-byte chars (emojis)\n   - Expected: No broken UTF-8 sequences\n\n4. **Token-based truncation respects bias**\n   - Similar tests but with token policy\n\n5. **Edge cases**\n   - Empty string\n   - String shorter than budget\n   - Very small budget (e.g., 10 bytes)\n\n### Integration tests\n\n1. **Model family uses correct bias**\n   - Claude model -\u003e TailHeavy\n   - GPT model -\u003e Balanced\n\n2. **TurnContext propagates bias correctly**\n\n## Files\n- `core/src/truncate.rs` (unit tests module)\n- `core/tests/` (integration tests if needed)\n\n## Acceptance Criteria\n- [ ] All bias modes have dedicated test coverage\n- [ ] Edge cases are tested\n- [ ] Tests use pretty_assertions::assert_eq\n- [ ] Snapshot tests for truncation output format (if applicable)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T15:31:06.179192426+01:00","updated_at":"2025-12-12T15:53:25.964832188+01:00","closed_at":"2025-12-12T15:53:25.964832188+01:00","dependencies":[{"issue_id":"codex-p1z.7","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:31:06.179526775+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.7","depends_on_id":"codex-p1z.4","type":"blocks","created_at":"2025-12-12T15:31:45.116722775+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2","title":"Port Gemini Quota Functionality","description":"Port quota fetching and display logic from gemini-cli to codex-rs. Integrate with /status and TUI. Ensure functionality matches gemini-cli's stats command.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-20T12:44:24.326042661+01:00","updated_at":"2025-12-20T13:24:55.00855285+01:00","closed_at":"2025-12-20T13:24:55.00855285+01:00"}
{"id":"codex-pc2.1","title":"Implement GeminiQuotaClient in core","description":"Create `core/src/quota/gemini_client.rs` implementing the `ProviderQuotaClient` trait.\n\n## Implementation Details\n1. Add `GeminiQuota` and `GeminiBucket` structs to `protocol/src/protocol.rs`\n2. Add `gemini: Option\u003cGeminiQuota\u003e` field to `RateLimitSnapshot`\n3. Create `GeminiQuotaClient` struct with:\n   - OAuth token loading via `CodexAuth`\n   - HTTP client for Google CodeAssist API\n   - `fetch_quota()` implementation\n4. API endpoint: `https://cloudcode-pa.googleapis.com/v1internal:retrieveUserQuota`\n5. Request: `{ project: string }`\n6. Response: `{ buckets?: BucketInfo[] }` where BucketInfo has remainingFraction, resetTime, modelId, tokenType\n\n## Code Reuse\n- Follow `AntigravityQuotaClient` pattern exactly\n- Reuse `ProviderQuotaClient` trait\n- Map response to `RateLimitSnapshot` with `gemini` field populated","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.337081068+01:00","updated_at":"2025-12-20T13:12:41.103968304+01:00","closed_at":"2025-12-20T13:12:41.103968304+01:00","dependencies":[{"issue_id":"codex-pc2.1","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.337382564+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.2","title":"Display Gemini Quota in CLI status","description":"Update `run_login_status` in `cli/src/login.rs` to fetch and display Gemini quota.\n\n## Implementation Details\n1. Check if Gemini OAuth credentials exist via `CodexAuth`\n2. If credentials exist, instantiate `GeminiQuotaClient`\n3. Fetch quota and print text summary:\n   - Show each bucket with model name, remaining %, reset time\n   - Format: `Gemini Quota: model_id - XX% remaining (resets in Xh)`\n4. Graceful error handling - if fetch fails, show 'unavailable'\n\n## Dependencies\n- Requires codex-pc2.1 (GeminiQuotaClient) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.348466408+01:00","updated_at":"2025-12-20T13:20:05.32993453+01:00","closed_at":"2025-12-20T13:20:05.32993453+01:00","dependencies":[{"issue_id":"codex-pc2.2","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.348750461+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.2","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.349156297+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.3","title":"Display Gemini Quota in TUI","description":"Update TUI status display to render Gemini quota information.\n\n## Implementation Details\n1. Add `GeminiQuotaDisplay` struct to `tui/src/status/rate_limits.rs`\n2. Extend `RateLimitSnapshotDisplay` with `gemini: Option\u003cGeminiQuotaDisplay\u003e`\n3. In `compose_rate_limit_data()`:\n   - Check for `snapshot.gemini`\n   - Render bucket quotas as progress bars (reuse `render_status_limit_progress_bar`)\n   - Show model name, remaining %, reset time\n4. Display Gemini alongside Antigravity (not mutually exclusive)\n5. Only render if Gemini OAuth credentials are stored\n\n## Code Reuse\n- Reuse existing progress bar rendering from Antigravity\n- Reuse staleness detection logic\n- Follow same row structure as Antigravity model quotas\n\n## Dependencies\n- Requires codex-pc2.1 (GeminiQuotaClient and protocol types) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.357730504+01:00","updated_at":"2025-12-20T13:20:05.337033413+01:00","closed_at":"2025-12-20T13:20:05.337033413+01:00","dependencies":[{"issue_id":"codex-pc2.3","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.358006301+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.3","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.358393411+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.4","title":"Add tests for Gemini Quota","description":"Add unit tests for GeminiQuotaClient and TUI rendering.\n\n## Test Coverage\n1. `core/src/quota/gemini_client.rs` tests:\n   - Test parsing API response to `GeminiQuota`\n   - Test handling empty buckets\n   - Test handling missing fields gracefully\n   - Test ISO timestamp parsing\n\n2. `tui/src/status/rate_limits.rs` tests:\n   - Test `compose_rate_limit_data` with Gemini quota\n   - Test rendering alongside Antigravity quota\n   - Test staleness detection for Gemini data\n\n## Dependencies\n- Requires codex-pc2.1, codex-pc2.3 to be complete","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:44:24.367768088+01:00","updated_at":"2025-12-20T13:24:48.386541024+01:00","closed_at":"2025-12-20T13:24:48.386541024+01:00","dependencies":[{"issue_id":"codex-pc2.4","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.368017375+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.4","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.368524694+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pkg","title":"Subagent sessions lack parent_id for session linkage","description":"## Problem\nWhen a subagent is spawned via the task tool, its rollout file has no reference to the parent session that spawned it.\n\nThe `SubAgentSource` enum in `protocol/src/protocol.rs` only has:\n```rust\npub enum SubAgentSource {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\nCompare to `Handoff` which does store the parent:\n```rust\nHandoff {\n    parent_id: ConversationId,\n    goal: String,\n},\n```\n\n## Impact\n- Can't trace subagent sessions back to their parent session\n- Can't reconstruct session hierarchies from rollout files\n- Difficult to correlate subagent work with parent context\n\n## Fix\nAdd `parent_id: ConversationId` to `SubAgentSource` or create a richer struct:\n```rust\npub struct SubAgentSource {\n    pub parent_id: ConversationId,\n    pub agent_type: String,\n}\n```","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-22T22:49:40.871533158+01:00","updated_at":"2025-12-22T23:11:50.195435235+01:00","closed_at":"2025-12-22T23:11:50.195435235+01:00"}
{"id":"codex-pmh","title":"Ohm Rebranding and Provider Agnosticism","description":"Rename the application to Ohm and decouple the core logic from OpenAI to make it fully provider agnostic.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-21T02:11:41.967346505+01:00","updated_at":"2025-12-21T02:11:41.967346505+01:00"}
{"id":"codex-pmh.1","title":"Rename codex application to ohm","description":"Rename the binary, crates, and all internal references from codex to ohm.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T02:11:44.925052185+01:00","updated_at":"2025-12-21T02:11:44.925052185+01:00","dependencies":[{"issue_id":"codex-pmh.1","depends_on_id":"codex-pmh","type":"parent-child","created_at":"2025-12-21T02:11:44.925379469+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pmh.2","title":"Decouple ohm from OpenAI","description":"Refactor the codebase to be fully provider agnostic, removing hardcoded OpenAI dependencies from core logic.","status":"open","priority":1,"issue_type":"feature","created_at":"2025-12-21T02:11:44.933222+01:00","updated_at":"2025-12-21T02:11:44.933222+01:00","dependencies":[{"issue_id":"codex-pmh.2","depends_on_id":"codex-pmh","type":"parent-child","created_at":"2025-12-21T02:11:44.933472417+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pmh.3","title":"Refactor model declarations to {provider}/{model} format","description":"Migrate from treating Gemini/Antigravity as special profiles to a unified {provider}/{model} string format. Stop requiring specific profile flags for these providers.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T02:29:35.860121347+01:00","updated_at":"2025-12-21T02:29:35.860121347+01:00","dependencies":[{"issue_id":"codex-pmh.3","depends_on_id":"codex-pmh","type":"parent-child","created_at":"2025-12-21T02:29:35.860733525+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pmh.4","title":"Decouple agent models from profiles","description":"Refactor the configuration to allow agent models to be specified independently of profiles, enabling more flexible model switching.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T02:29:35.869279868+01:00","updated_at":"2025-12-21T02:29:35.869279868+01:00","dependencies":[{"issue_id":"codex-pmh.4","depends_on_id":"codex-pmh","type":"parent-child","created_at":"2025-12-21T02:29:35.86959553+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o","title":"UI/UX Enhancements and Subagent Traceability","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-21T02:06:52.763182455+01:00","updated_at":"2025-12-21T02:06:52.763182455+01:00"}
{"id":"codex-q6o.1","title":"Investigate subagent work summary for main agent","description":"Explore ways to notify the main agent about subagent work, including which files were edited and the number of lines changed.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.106766761+01:00","updated_at":"2025-12-21T02:06:57.106766761+01:00","dependencies":[{"issue_id":"codex-q6o.1","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.107115406+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.10","title":"Migrate crucial subagents to code","description":"Move the definitions of crucial subagents from config files into the code while ensuring they remain configurable/overridable via config.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:21:09.935577773+01:00","updated_at":"2025-12-21T11:34:41.766069234+01:00","closed_at":"2025-12-21T11:34:41.766069234+01:00","dependencies":[{"issue_id":"codex-q6o.10","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:21:09.935936738+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.11","title":"Port /review agent and workflow from amp","description":"Port the /review agent and associated workflow from amp (/home/ribelo/projects/github/coding-tools-prompts/amp) to ohm. This includes the agent prompt, skill, and any mode-specific logic.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:22:13.561005544+01:00","updated_at":"2025-12-21T11:34:43.762959542+01:00","closed_at":"2025-12-21T11:34:43.762959542+01:00","dependencies":[{"issue_id":"codex-q6o.11","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:22:13.561363688+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.12","title":"Improve review agent description and verification workflow","description":"Update the review agent's description to emphasize that the main agent must verify reported bugs before taking action. Prevent 'panicking' on false positives.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T02:29:35.876986076+01:00","updated_at":"2025-12-21T02:29:35.876986076+01:00","dependencies":[{"issue_id":"codex-q6o.12","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:29:35.877235442+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.2","title":"Return tool_result of last subagent tool_call to main agent","description":"If the last part returned by a subagent is a tool_call, ensure its tool_result output is returned to the main agent. This is useful when subagents use tools like echo to return messages.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.115022136+01:00","updated_at":"2025-12-21T11:34:37.685689546+01:00","closed_at":"2025-12-21T11:34:37.685689546+01:00","dependencies":[{"issue_id":"codex-q6o.2","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.115300558+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.3","title":"Include profile in session resume message","description":"Update the resume message shown after closing codex to include the current profile. For example: To continue this session, run codex --profile xyz resume \u003cuuid\u003e.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.122685782+01:00","updated_at":"2025-12-21T02:06:57.122685782+01:00","dependencies":[{"issue_id":"codex-q6o.3","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.122923937+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.4","title":"Investigate streaming bash output to UI","description":"Explore the possibility of streaming bash command output to the UI in real-time instead of waiting for the command to finish.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.131331473+01:00","updated_at":"2025-12-21T02:06:57.131331473+01:00","dependencies":[{"issue_id":"codex-q6o.4","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.131633911+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.5","title":"Show full subagent prompt in ctrl-t view","description":"Update the subagent hierarchy view (ctrl-t) to display the full task/prompt for each subagent.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T02:11:44.941660546+01:00","updated_at":"2025-12-21T02:11:44.941660546+01:00","dependencies":[{"issue_id":"codex-q6o.5","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:11:44.941981989+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.6","title":"Investigate subagent sandbox permission escalation bug","description":"Even when a subagent has approval_policy=never, escalation requests are being redirected to the user. Investigate and fix this sandbox escape/bug.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-21T02:11:44.949421612+01:00","updated_at":"2025-12-21T13:05:32.910399827+01:00","closed_at":"2025-12-21T13:05:32.910399827+01:00","dependencies":[{"issue_id":"codex-q6o.6","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:11:44.949663092+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.7","title":"Implement read_session tool","description":"Implement a tool that allows agents to query the conversation history of other sessions. The tool should delegate the search to a specialized subagent (e.g., finder) so that the main agent only receives relevant findings rather than the entire thread.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:16:14.728161966+01:00","updated_at":"2025-12-21T02:21:09.926234094+01:00","dependencies":[{"issue_id":"codex-q6o.7","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:16:14.728877832+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-q6o.7","depends_on_id":"codex-dt2","type":"related","created_at":"2025-12-21T02:17:09.448903538+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.8","title":"Update subagent prompts and descriptions from amp","description":"Update and clone subagent prompts and descriptions from /home/ribelo/projects/github/coding-tools-prompts/amp/prompts/subagents to align with amp's configuration.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:16:14.740453422+01:00","updated_at":"2025-12-21T11:34:39.829301912+01:00","closed_at":"2025-12-21T11:34:39.829301912+01:00","dependencies":[{"issue_id":"codex-q6o.8","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:16:14.740773382+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.9","title":"Support handoff to other profiles","description":"Implement the ability to handoff a conversation to a different profile. This involves allowing the user to specify a target profile during the handoff process.","status":"open","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:19:03.528877943+01:00","updated_at":"2025-12-21T02:19:03.528877943+01:00","dependencies":[{"issue_id":"codex-q6o.9","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:19:03.52936952+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qj1","title":"Implement Drop for WorktreeHandle to prevent directory leaks","description":"## Problem\n`WorktreeHandle` manages a directory in `.codex/agents/` but does not implement `Drop` to clean it up. Cleanup relies on `merge_pending_patches` or error handling paths in `TaskHandler`. If the application terminates or the session is dropped while `PendingSubagentResult`s are queued, the temporary worktree directories will remain on disk indefinitely.\n\n## Solution\nImplement `Drop` for `WorktreeHandle` that removes the worktree directory. Use a flag to track whether cleanup has already been performed (to avoid double-cleanup).\n\n## Files\n- core/src/worktree_manager.rs - add Drop impl for WorktreeHandle","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:37.136554152+01:00","updated_at":"2025-12-21T19:01:28.241779033+01:00","closed_at":"2025-12-21T19:01:28.241779033+01:00"}
{"id":"codex-rs-9kr","title":"Unify review as task/subagent","description":"Unify the /review feature with the task/subagent system so that:\n1. Agent can invoke review via task tool (not just users)\n2. Both user /review and agent task(review) use the same prompt/policies\n3. Reduce code duplication between ReviewTask and task handler\n\nThree phases:\n- Phase 1: Create review.md subagent (enables agent access immediately)\n- Phase 2: Update ReviewTask to load from SubagentRegistry (unify definition source)  \n- Phase 3: Full unification - remove Op::Review and ReviewTask entirely\n\nDesign doc: Oracle recommended keeping Op::Review for Phase 2 due to TUI coupling, but Phase 3 removes it.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T14:10:36.259658275+01:00","updated_at":"2025-12-15T16:04:36.428775116+01:00","closed_at":"2025-12-15T16:04:36.428775116+01:00"}
{"id":"codex-rs-9kr.1","title":"Create review.md subagent file","description":"Create ~/.codex/agents/review.md with:\n- YAML frontmatter: name, description, profile: inherit, sandbox_policy: read-only, approval_policy: never, allowed_subagents: []\n- Body: content from core/review_prompt.md\n- Add comment warning that JSON output format is required for TUI compatibility\n\nThis immediately enables agent to call task(subagent_type='review', prompt='\u003cdiff\u003e')\n\nFiles to reference:\n- core/review_prompt.md (source content)\n- ~/.codex/agents/oracle.md (example format)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:10:51.694652174+01:00","updated_at":"2025-12-15T14:16:44.709028672+01:00","closed_at":"2025-12-15T14:16:44.709028672+01:00","dependencies":[{"issue_id":"codex-rs-9kr.1","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:10:51.694968969+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.10","title":"Update app-server review API to use DelegateSubagent","description":"Update app-server to use Op::DelegateSubagent for review:\n\n1. Modify app-server/src/codex_message_processor.rs review_start() \n2. Instead of Op::Review, emit Op::DelegateSubagent\n3. Update tests in app-server/tests/suite/v2/review.rs\n4. May need to update app-server-protocol types\n\nConsider backwards compatibility - existing API clients may expect ReviewStartResponse.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:00.619785448+01:00","updated_at":"2025-12-15T15:46:10.101396072+01:00","closed_at":"2025-12-15T15:46:10.101396072+01:00","dependencies":[{"issue_id":"codex-rs-9kr.10","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:00.620114387+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.10","depends_on_id":"codex-rs-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.742613814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.11","title":"Cleanup unused review types from protocol","description":"Remove unused review-related types after migration:\n\n1. Review which types are still needed:\n   - ReviewRequest - may still be used by review_prompts.rs\n   - ReviewTarget - may still be used\n   - ReviewDelivery - check if needed\n   - ReviewOutputEvent - may be used by TUI parsing\n   - ExitedReviewModeEvent - should be removed\n   \n2. Remove truly unused types from protocol/src/protocol.rs\n3. Update any remaining imports\n\nRun after all other Phase 3 tasks complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:18.206529477+01:00","updated_at":"2025-12-15T15:46:56.477464172+01:00","closed_at":"2025-12-15T15:46:56.477464172+01:00","dependencies":[{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:18.207056684+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr.9","type":"blocks","created_at":"2025-12-15T14:12:50.751121687+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr.10","type":"blocks","created_at":"2025-12-15T14:12:50.757716555+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.12","title":"Update tests after full review unification","description":"Update all tests affected by review unification:\n\n1. core/tests/suite/review.rs - update or remove Op::Review tests\n2. tui/src/chatwidget/tests.rs - update /review flow tests\n3. tui2/src/chatwidget/tests.rs - same\n4. app-server/tests/suite/v2/review.rs - update API tests\n5. Any snapshot tests that may have changed\n\nRun full test suite: cargo test --all-features","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:24.132550543+01:00","updated_at":"2025-12-15T16:04:03.730434461+01:00","closed_at":"2025-12-15T16:04:03.730434461+01:00","dependencies":[{"issue_id":"codex-rs-9kr.12","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:24.132961548+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.12","depends_on_id":"codex-rs-9kr.11","type":"blocks","created_at":"2025-12-15T14:12:50.764087215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.2","title":"Update task tool description to include review","description":"Update the task tool's generated description in core/src/tools/handlers/task.rs to mention the review subagent.\n\nThe tool description is dynamically generated from SubagentRegistry.list(). Since review.md will be loaded, it should automatically appear. Verify this works correctly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:10:57.217103789+01:00","updated_at":"2025-12-15T14:17:06.590975268+01:00","closed_at":"2025-12-15T14:17:06.590975268+01:00","dependencies":[{"issue_id":"codex-rs-9kr.2","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:10:57.217401047+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.3","title":"Add review subagent integration test","description":"Add test in core/tests/ to verify:\n1. Agent can invoke task(subagent_type='review', prompt='...') \n2. Review subagent loads correctly from registry\n3. Output is returned properly\n\nReference existing subagent tests in core/tests/ for patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:02.317112673+01:00","updated_at":"2025-12-15T14:17:52.339367052+01:00","closed_at":"2025-12-15T14:17:52.339367052+01:00","dependencies":[{"issue_id":"codex-rs-9kr.3","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:02.317466489+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.4","title":"Update ReviewTask to load prompt from SubagentRegistry","description":"Modify core/src/tasks/review.rs to:\n1. Attempt to load 'review' subagent from SubagentRegistry\n2. If found: use its system_prompt and policies (sandbox_policy, approval_policy)\n3. If not found: fallback to hardcoded REVIEW_PROMPT (backwards compat)\n\nThis unifies the prompt source - both /review (user) and task(review) (agent) use same definition.\n\nKey changes:\n- Add SubagentRegistry lookup in start_review_conversation()\n- Use subagent's system_prompt as base_instructions if available\n- Respect subagent's sandbox_policy and approval_policy\n\nKeep Op::Review and ExitedReviewModeEvent - TUI still needs them.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:11.018903647+01:00","updated_at":"2025-12-15T14:30:50.570232143+01:00","closed_at":"2025-12-15T14:30:50.570232143+01:00","dependencies":[{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:11.019273924+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr.1","type":"blocks","created_at":"2025-12-15T14:12:50.687699932+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr.2","type":"blocks","created_at":"2025-12-15T14:12:50.695450488+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.5","title":"Add test for ReviewTask registry loading","description":"Add tests to verify ReviewTask correctly:\n1. Loads from SubagentRegistry when review.md exists\n2. Falls back to REVIEW_PROMPT when review.md is missing\n3. Respects policies from subagent definition\n\nAdd to core/tests/suite/review.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:18.751001758+01:00","updated_at":"2025-12-15T14:31:07.503168654+01:00","closed_at":"2025-12-15T14:31:07.503168654+01:00","dependencies":[{"issue_id":"codex-rs-9kr.5","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:18.751354872+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.5","depends_on_id":"codex-rs-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.7023669+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.6","title":"Update TUI to use Op::DelegateSubagent for /review","description":"Modify TUI /review flow to emit Op::DelegateSubagent instead of Op::Review:\n\n1. Keep ReviewPopup (branch/commit/custom picker) - user still selects target\n2. Use review_prompts.rs to build the diff prompt (git diff, commit show, etc.)\n3. Instead of Op::Review, emit:\n   Op::DelegateSubagent {\n       agent: 'review',\n       prompt: '\u003cbuilt diff prompt\u003e',\n       description: '\u003cuser-facing hint\u003e',\n   }\n\nFiles to modify:\n- tui/src/chatwidget.rs (dispatch_command, review popup handling)\n- tui2/src/chatwidget.rs (same changes)\n\nKeep review_prompts.rs - still needed for building the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:27.691336026+01:00","updated_at":"2025-12-15T15:06:25.521132815+01:00","closed_at":"2025-12-15T15:06:25.521132815+01:00","dependencies":[{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:27.69173559+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.70883699+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr.5","type":"blocks","created_at":"2025-12-15T14:12:50.715400459+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.7","title":"Handle review output parsing in TUI SubagentEvent","description":"Update TUI to parse ReviewOutputEvent from SubagentEvent when agent is 'review':\n\n1. When receiving TaskComplete for 'review' subagent, attempt to parse output as JSON ReviewOutputEvent\n2. If valid JSON: render using existing review findings format (render_review_output_text)\n3. If not valid JSON: render as plain markdown\n\nThis replaces ExitedReviewModeEvent handling with SubagentEvent-based detection.\n\nFiles to modify:\n- tui/src/chatwidget.rs\n- tui2/src/chatwidget.rs  \n- Possibly tui/src/history_cell.rs for rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:35.292380316+01:00","updated_at":"2025-12-15T15:17:05.630380288+01:00","closed_at":"2025-12-15T15:17:05.630380288+01:00","dependencies":[{"issue_id":"codex-rs-9kr.7","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:35.292739082+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.7","depends_on_id":"codex-rs-9kr.6","type":"blocks","created_at":"2025-12-15T14:12:50.723307193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.8","title":"Remove Op::Review from protocol","description":"Remove Op::Review variant from protocol/src/protocol.rs:\n\n1. Remove Op::Review { review_request: ReviewRequest } variant\n2. Keep ReviewRequest, ReviewTarget, ReviewDelivery types if still used by review_prompts.rs\n3. Remove ExitedReviewModeEvent if no longer needed\n4. Update all match arms that handle Op::Review\n\nFiles to update:\n- protocol/src/protocol.rs\n- core/src/codex.rs (remove Op::Review handler)\n- Any other files matching on Op::Review","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:46.979545923+01:00","updated_at":"2025-12-15T15:43:25.394932343+01:00","closed_at":"2025-12-15T15:43:25.394932343+01:00","dependencies":[{"issue_id":"codex-rs-9kr.8","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:46.979864121+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.8","depends_on_id":"codex-rs-9kr.7","type":"blocks","created_at":"2025-12-15T14:12:50.730408158+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.9","title":"Remove ReviewTask and tasks/review.rs","description":"Delete core/src/tasks/review.rs and related code:\n\n1. Delete core/src/tasks/review.rs\n2. Remove ReviewTask from core/src/tasks/mod.rs\n3. Remove imports and usages of ReviewTask\n4. Remove exit_review_mode function\n5. Keep parse_review_output_event if needed by TUI (or move to protocol)\n\nThe review functionality now flows through task tool -\u003e SubagentDelegateTask.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:53.84168904+01:00","updated_at":"2025-12-15T15:45:11.900516798+01:00","closed_at":"2025-12-15T15:45:11.900516798+01:00","dependencies":[{"issue_id":"codex-rs-9kr.9","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:53.842062202+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.9","depends_on_id":"codex-rs-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.736446183+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9rt","title":"Subagent rendering polish","description":"Collection of UI/UX improvements for subagent rendering in the TUI. Covers nesting bugs, visual polish, and display consistency issues.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T21:52:05.938083509+01:00","updated_at":"2025-12-15T22:35:34.788011714+01:00","closed_at":"2025-12-15T22:35:34.788011714+01:00"}
{"id":"codex-rs-9rt.1","title":"Subagent task description truncated in transcript overlay (Ctrl+t)","description":"## Issue\n\nThe task description (prompt) delegated to a subagent is truncated in both the normal view and the transcript overlay (Ctrl+t). Users should be able to see the full message sent to the subagent when viewing the expanded transcript.\n\n## Current Behavior\n\n- Task description is wrapped/truncated in `display_lines()`\n- Task description is also wrapped in `transcript_lines()` using `textwrap::wrap()`\n- Long prompts sent to subagents are cut off with no way to view the full content\n\n## Expected Behavior\n\n- Normal view: truncated task description (current behavior is fine)\n- Transcript overlay (Ctrl+t): full task description should be visible without truncation\n\n## Relevant Code\n\n- `tui/src/history_cell.rs:1420-1430`: `transcript_lines()` wraps description with `textwrap::wrap()`\n- The `wrap_width` calculation may be too aggressive for the transcript view\n\n## Fix Direction\n\nIn `transcript_lines()`, either:\n1. Don't limit wrap width for the description (let it flow naturally)\n2. Or use a much larger wrap width for transcript mode\n3. Ensure the full description is rendered across multiple lines without any character limit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:47.59488775+01:00","updated_at":"2025-12-15T22:35:19.590583799+01:00","closed_at":"2025-12-15T22:35:19.590583799+01:00","dependencies":[{"issue_id":"codex-rs-9rt.1","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T22:03:47.595357588+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9rt.2","title":"Subagent final message not shown in UI","description":"## Issue\n\nThe last message from a subagent (its final response/output) is not visible in the UI. Users should be able to see what the subagent returned to the parent agent.\n\n## Current Behavior\n\n- Subagent cell shows: header, task description, and activity log (shell commands, patches, etc.)\n- The subagent's final textual response/message is not displayed\n- Users cannot see what the subagent concluded or reported back\n\n## Expected Behavior\n\n- Normal view: show truncated version of the subagent's final message\n- Transcript overlay (Ctrl+t): show the full final message expanded\n\n## Relevant Code\n\n- `tui/src/history_cell.rs`: `SubagentTaskCell` struct and its `display_lines()`/`transcript_lines()` methods\n- `tui/src/chatwidget.rs`: `on_subagent_event()` handles subagent events\n- The `SubagentState` struct may need a field to store the final message\n- `EventMsg::AgentMessage` events from subagents should be captured and displayed\n\n## Fix Direction\n\n1. Add a `final_message: Option\u003cString\u003e` field to `SubagentState`\n2. Capture `AgentMessage` events in `on_subagent_event()` and store the content\n3. Render the final message in both `display_lines()` (truncated) and `transcript_lines()` (full)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:58.785651289+01:00","updated_at":"2025-12-15T22:35:24.643083449+01:00","closed_at":"2025-12-15T22:35:24.643083449+01:00","dependencies":[{"issue_id":"codex-rs-9rt.2","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T22:03:58.785965268+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-alj","title":"Parallel subagent delegations incorrectly nest due to shared DelegationRegistry state","description":"## Bug Summary\n\nWhen the parent agent spawns multiple subagents in parallel (e.g., two `@general` calls at once), they are rendered as nested rather than siblings. The second subagent appears nested inside the first, even though both should be at the same level under the parent.\n\n## Observed Behavior\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n  └ • Delegating to @general          \u003c-- BUG: This should NOT be nested\n    └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n      ... +10 more\n```\n\nThe second `@general` delegation appears nested inside the first one, but since `general` subagent cannot call itself, this is clearly incorrect. They should render as siblings:\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n• Delegating to @general              \u003c-- EXPECTED: Same level as above\n  └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n    ... +10 more\n```\n\n## Root Cause\n\nThe `DelegationRegistry` in `core/src/delegation.rs` uses a single shared `current: Arc\u003cRwLock\u003cOption\u003cDelegationContext\u003e\u003e\u003e` to track the active delegation context. When multiple subagents are spawned in parallel:\n\n1. First subagent calls `registry.enter(call_id_1)` → creates root context with `depth=0`, no parent\n2. Second subagent calls `registry.enter(call_id_2)` → sees first subagent's context as `current`, creates child with `depth=1` and `parent_delegation_id = call_id_1`\n\nThis causes the second subagent to incorrectly inherit from the first sibling instead of from the actual parent.\n\n## Relevant Code Paths\n\n- `core/src/delegation.rs`: `DelegationRegistry::enter()` uses shared `current` state\n- `core/src/tools/handlers/task.rs:202-208`: Retrieves delegation context for each subagent\n- `tui/src/chatwidget.rs:2187-2190`: Uses `parent_delegation_id` to nest cells\n\n## Fix Direction\n\nThe delegation context needs to be scoped per-call rather than shared globally. Options:\n\n1. Pass parent delegation ID explicitly from the caller rather than inferring from shared state\n2. Use a stack-based or tree-based registry that tracks parent-child relationships explicitly\n3. Store delegation context in the invocation/session context rather than a global registry\n\n## Test Case\n\nSee `tui/src/chatwidget/tests/subagent_tests.rs:91` for existing nesting test (`subagent_nesting_logic`). A new test should verify that two parallel delegations with the same parent remain siblings, not nested.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T21:50:57.207483466+01:00","updated_at":"2025-12-15T22:35:14.532746134+01:00","closed_at":"2025-12-15T22:35:14.532746134+01:00","dependencies":[{"issue_id":"codex-rs-alj","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T21:52:32.934771433+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-yr6","title":"Fix failing test model_migration_prompt_only_shows_for_deprecated_models in tui2","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-15T15:16:14.896470158+01:00","updated_at":"2025-12-15T15:16:14.896470158+01:00"}
{"id":"codex-sbl","title":"Parent session handoff traceability","description":"## Goal\nRecord handoff in parent session's rollout for bidirectional traceability.\n\n## Implementation\n1. Update Op::ConfirmHandoff in protocol/src/protocol.rs to include child_id: ConversationId\n2. Implement core handler in core/src/codex.rs to write RolloutItem::Handoff to parent's rollout\n3. Update TUI in tui/src/app.rs to send Op::ConfirmHandoff { draft, child_id } after spawning child\n\n## Code Pattern\n```rust\nOp::ConfirmHandoff { draft, child_id } =\u003e {\n    let item = RolloutItem::Handoff(HandoffRolloutItem {\n        child_id,\n        goal: draft.goal.clone(),\n        timestamp: time::OffsetDateTime::now_utc().format(\u0026Rfc3339).unwrap_or_default(),\n    });\n    if let Some(recorder) = sess.services.rollout.lock().await.as_ref() {\n        recorder.record_items(\u0026[item]).await?;\n    }\n}\n```\n\n## Files to modify\n- protocol/src/protocol.rs - add child_id to Op::ConfirmHandoff\n- core/src/codex.rs - implement handler\n- tui/src/app.rs - send Op after creating child session","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T01:46:46.552678702+01:00","updated_at":"2025-12-21T01:46:46.552678702+01:00"}
{"id":"codex-sex","title":"Handoff Feature Improvements","description":"Epic for all /handoff command improvements and fixes.\n\n## What is Handoff?\nThe /handoff command extracts context from current conversation and starts a new focused thread with that context. It's useful for:\n- Starting fresh when context gets too large\n- Focusing on a specific subtask\n- Handing work to a different profile/model\n\n## Current Issues\n1. Empty extracted context (streaming events not captured)\n2. No parent session traceability in child session\n3. Context overflow when conversation is large\n4. Various UX improvements needed\n\n## Related Tasks (to be consolidated under this epic)\n- codex-3zq: Empty extracted context bug\n- codex-16t: Context overflow protection\n- codex-sbl: Parent session traceability\n- codex-zal: Editable handoff draft\n- codex-dt2: read_parent_thread tool\n- codex-q6o.9: Handoff to other profiles","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-22T23:37:20.014649977+01:00","updated_at":"2025-12-22T23:37:20.014649977+01:00"}
{"id":"codex-te1","title":"Config v2: Typed provider-specific profile configuration","description":"## Problem\n\nCurrent config conflates wire format with provider identity. All profile fields are flat and shared across all provider types, making it impossible to express provider-specific configuration like OpenRouter's routing options.\n\n### Current Pain Points\n\n1. **No `ProviderKind::OpenRouter`** - OpenRouter masquerades as OpenAI with a different URL\n2. **No provider-specific profile config** - Can't express OpenRouter's `provider` routing field:\n   ```json\n   {\"provider\": {\"order\": [\"xai\"], \"allow_fallbacks\": false, \"data_collection\": \"deny\"}}\n   ```\n3. **Flat profile struct** - All fields are `Option\u003cT\u003e` with no validation based on provider type\n\n## Solution\n\nTwo-phase config parsing with strongly-typed provider-specific structs:\n\n1. Parse TOML into intermediate `ConfigProfileToml` with `provider: Option\u003ctoml::Table\u003e`\n2. Resolve `model_provider` → get `ProviderKind` from provider definition  \n3. Deserialize raw table into correct typed struct based on `ProviderKind`\n4. Hard error if fields don't match provider type\n\n### Target Config Shape\n\n```toml\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"  # NEW variant\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\nwire_api = \"responses\"\n\n[profiles.grok]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\nmodel_reasoning_effort = \"high\"\n\n[profiles.grok.provider]  # Provider-specific overrides\nrouting.order = [\"xai\"]\nrouting.allow_fallbacks = false\nrouting.data_collection = \"deny\"\n```\n\n### Type Structure\n\n```rust\n// Intermediate parsing\nstruct ConfigProfileToml {\n    // ... existing flat fields ...\n    #[serde(default)]\n    provider: Option\u003ctoml::Table\u003e,\n}\n\n// Typed provider configs (deny_unknown_fields)\nstruct OpenRouterProfileConfig {\n    routing: Option\u003cOpenRouterRouting\u003e,\n}\n\nstruct OpenRouterRouting {\n    order: Option\u003cVec\u003cString\u003e\u003e,\n    allow_fallbacks: Option\u003cbool\u003e,\n    require_parameters: Option\u003cbool\u003e,\n    data_collection: Option\u003cString\u003e,\n    // ... full OpenRouter spec\n}\n\n// Resolved enum\nenum ProviderProfileConfig {\n    OpenRouter(OpenRouterProfileConfig),\n    OpenAi(OpenAiProfileConfig),\n    Anthropic(AnthropicProfileConfig),\n    Gemini(GeminiProfileConfig),\n    None,\n}\n```\n\n## Key Design Decisions\n\n1. **No untagged enums** - Discriminator comes from provider definition, not profile itself\n2. **No repetition** - Provider type declared ONCE on provider definition\n3. **Flat common fields** - Cross-cutting settings stay flat in profile\n4. **deny_unknown_fields** - Typos and wrong-provider fields cause hard errors\n5. **Two-phase parse** - Parse TOML once, then typed conversion once (not \"parsing twice\")\n\n## Acceptance Criteria\n\n- [ ] `ProviderKind::OpenRouter` variant exists\n- [ ] OpenRouter routing config injectable into Responses requests\n- [ ] Config validation rejects wrong-provider fields\n- [ ] Existing configs continue to work (backward compatible for providers without specific config)\n- [ ] Documentation updated with OpenRouter example","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-14T16:44:35.267190006+01:00","updated_at":"2025-12-14T17:28:14.873995376+01:00","closed_at":"2025-12-14T17:28:14.873995376+01:00"}
{"id":"codex-te1.1","title":"Add ProviderKind::OpenRouter variant","description":"## What\n\nAdd `OpenRouter` variant to the `ProviderKind` enum and update all match arms.\n\n## Why\n\nOpenRouter is a distinct provider with its own capabilities (routing, provider preferences, data policies). Currently it masquerades as OpenAI with a different URL, which prevents expressing OpenRouter-specific features.\n\n## Where\n\n**Primary file:** `codex-rs/core/src/model_provider_info.rs`\n\n## How\n\n### 1. Add enum variant\n\n```rust\n#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum ProviderKind {\n    #[default]\n    OpenAi,\n    Anthropic,\n    Gemini,\n    Antigravity,\n    OpenRouter,  // NEW\n}\n```\n\n### 2. Update wire_api inference in deserializer\n\n```rust\nlet wire_api = raw.wire_api.unwrap_or(match provider_kind {\n    ProviderKind::Anthropic =\u003e WireApi::Anthropic,\n    ProviderKind::Gemini =\u003e WireApi::Gemini,\n    ProviderKind::Antigravity =\u003e WireApi::Antigravity,\n    ProviderKind::OpenAi =\u003e WireApi::Chat,\n    ProviderKind::OpenRouter =\u003e WireApi::Responses,  // NEW - OpenRouter defaults to Responses API\n});\n```\n\n### 3. Find and update all match arms\n\nSearch for `ProviderKind::` and `match.*provider_kind` to find all places that need updating.\n\n## Testing\n\n```rust\n#[test]\nfn deserializes_openrouter_provider() {\n    let toml = r#\"\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\n    \"#;\n    \n    let provider: ModelProviderInfo = toml::from_str(toml).unwrap();\n    assert_eq!(provider.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(provider.wire_api, WireApi::Responses);\n}\n\n#[test]\nfn openrouter_can_use_chat_wire_api() {\n    let toml = r#\"\nname = \"OpenRouter Chat\"\nprovider_kind = \"openrouter\"\nwire_api = \"chat\"\nbase_url = \"https://openrouter.ai/api/v1\"\n    \"#;\n    \n    let provider: ModelProviderInfo = toml::from_str(toml).unwrap();\n    assert_eq!(provider.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(provider.wire_api, WireApi::Chat);  // Explicit override\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `ProviderKind::OpenRouter` variant exists\n- [ ] Serializes as `\"openrouter\"` in TOML/JSON\n- [ ] Default wire_api is `Responses` for OpenRouter\n- [ ] Can override wire_api explicitly\n- [ ] All match arms updated (no compiler warnings)\n- [ ] `cargo test -p codex-core` passes\n- [ ] `just fix -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:45:29.846153598+01:00","updated_at":"2025-12-14T17:00:07.795358202+01:00","closed_at":"2025-12-14T17:00:07.795358202+01:00","dependencies":[{"issue_id":"codex-te1.1","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:45:29.846552189+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.2","title":"Define OpenRouter routing types","description":"## What\n\nCreate strongly-typed structs for OpenRouter's `provider` routing configuration, matching the OpenRouter API spec.\n\n## Why\n\nOpenRouter's Responses API accepts a `provider` field to control routing preferences, fallbacks, data collection policies, and more. These need typed representations for:\n1. Config parsing with validation\n2. Serialization into request bodies\n\n## Where\n\n**New file:** `codex-rs/core/src/openrouter_types.rs`  \n**Update:** `codex-rs/core/src/lib.rs` (add module)\n\n## How\n\n### OpenRouter Provider Routing Spec\n\nFrom https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider:\n\n```rust\nuse serde::{Deserialize, Serialize};\n\n/// OpenRouter provider routing configuration.\n/// Controls which providers serve requests and under what conditions.\n/// \n/// Reference: https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider\n#[derive(Debug, Clone, Default, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterRouting {\n    /// Ordered list of provider names to try. Empty = use OpenRouter's default ranking.\n    /// Example: [\"anthropic\", \"openai\"]\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub order: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// If true, allow fallback to other providers when preferred ones fail.\n    /// Default: true\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub allow_fallbacks: Option\u003cbool\u003e,\n\n    /// If true, only route to providers that support all request parameters.\n    /// Default: true  \n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub require_parameters: Option\u003cbool\u003e,\n\n    /// Data collection policy: \"allow\" or \"deny\".\n    /// Controls whether providers can use request data for training.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub data_collection: Option\u003cDataCollectionPolicy\u003e,\n\n    /// Zero Data Retention: if true, route only to providers with ZDR agreements.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub zdr: Option\u003cbool\u003e,\n\n    /// If true, only route to providers that guarantee distillable output.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub enforce_distillable_text: Option\u003cbool\u003e,\n\n    /// Only use these specific providers (exclusive list).\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub only: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Never use these providers.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub ignore: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Allowed quantization levels: [\"int4\", \"int8\", \"fp6\", \"fp8\", \"fp16\", \"bf16\", \"unknown\"]\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub quantizations: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Sort preference for provider ranking.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub sort: Option\u003cProviderSort\u003e,\n\n    /// Maximum price per million tokens (in USD).\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub max_price: Option\u003cMaxPrice\u003e,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum DataCollectionPolicy {\n    Allow,\n    Deny,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum ProviderSort {\n    /// Sort by price (cheapest first)\n    Price,\n    /// Sort by throughput (fastest first)  \n    Throughput,\n    /// Sort by latency (lowest first)\n    Latency,\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct MaxPrice {\n    /// Max price for prompt tokens (per million)\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub prompt: Option\u003cf64\u003e,\n    /// Max price for completion tokens (per million)\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub completion: Option\u003cf64\u003e,\n    /// Max price for request (flat rate)\n    #[serde(skip_serializing_if = \"Option::is_none\")]  \n    pub request: Option\u003cf64\u003e,\n    /// Max price for image processing\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub image: Option\u003cf64\u003e,\n}\n```\n\n### Profile Config Wrapper\n\n```rust\n/// OpenRouter-specific profile configuration.\n/// Parsed from [profiles.\u003cname\u003e.provider] when provider_kind is OpenRouter.\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterProfileConfig {\n    /// Routing preferences for this profile.\n    #[serde(default)]\n    pub routing: Option\u003cOpenRouterRouting\u003e,\n}\n```\n\n## Testing\n\n```rust\n#[test]\nfn parse_openrouter_routing_minimal() {\n    let toml = r#\"\nrouting.order = [\"xai\"]\n    \"#;\n    let config: OpenRouterProfileConfig = toml::from_str(toml).unwrap();\n    assert_eq!(config.routing.unwrap().order, Some(vec![\"xai\".to_string()]));\n}\n\n#[test]\nfn parse_openrouter_routing_full() {\n    let toml = r#\"\n[routing]\norder = [\"anthropic\", \"openai\"]\nallow_fallbacks = false\nrequire_parameters = true\ndata_collection = \"deny\"\nzdr = true\n    \"#;\n    let config: OpenRouterProfileConfig = toml::from_str(toml).unwrap();\n    let routing = config.routing.unwrap();\n    assert_eq!(routing.allow_fallbacks, Some(false));\n    assert_eq!(routing.data_collection, Some(DataCollectionPolicy::Deny));\n}\n\n#[test]\nfn reject_unknown_fields() {\n    let toml = r#\"\nrouting.unknown_field = true\n    \"#;\n    let result: Result\u003cOpenRouterProfileConfig, _\u003e = toml::from_str(toml);\n    assert!(result.is_err());\n}\n\n#[test]\nfn serialize_for_request_body() {\n    let routing = OpenRouterRouting {\n        order: Some(vec![\"xai\".to_string()]),\n        allow_fallbacks: Some(false),\n        ..Default::default()\n    };\n    let json = serde_json::to_value(\u0026routing).unwrap();\n    assert_eq!(json[\"order\"], serde_json::json!([\"xai\"]));\n    assert_eq!(json[\"allow_fallbacks\"], serde_json::json!(false));\n    // Verify None fields are skipped\n    assert!(json.get(\"data_collection\").is_none());\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `OpenRouterRouting` struct with all OpenRouter provider fields\n- [ ] `OpenRouterProfileConfig` wrapper for profile parsing\n- [ ] `deny_unknown_fields` on all structs\n- [ ] Proper `skip_serializing_if` for optional fields\n- [ ] Tests for parsing and serialization\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:46:11.910684602+01:00","updated_at":"2025-12-14T16:58:39.353302147+01:00","closed_at":"2025-12-14T16:58:39.353302147+01:00","dependencies":[{"issue_id":"codex-te1.2","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:46:11.911429665+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.3","title":"Add provider table to ConfigProfile with two-phase parsing","description":"## What\n\nModify `ConfigProfile` to accept an optional `[profiles.\u003cname\u003e.provider]` table, then add resolution logic to convert it into typed `ProviderProfileConfig` based on the resolved `ProviderKind`.\n\n## Why\n\nThis is the core mechanism that enables provider-specific configuration without untagged enum ambiguity. The discriminator (provider type) comes from the provider definition, not from the profile config itself.\n\n## Where\n\n**Primary files:**\n- `codex-rs/core/src/config/profile.rs` - Add `provider` field\n- `codex-rs/core/src/config/mod.rs` - Add resolution logic\n\n## How\n\n### 1. Update ConfigProfile to capture raw table\n\n```rust\n// profile.rs\nuse serde::Deserialize;\nuse toml::Table as TomlTable;\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\npub struct ConfigProfile {\n    pub model: Option\u003cString\u003e,\n    pub model_provider: Option\u003cString\u003e,\n    pub approval_policy: Option\u003cAskForApproval\u003e,\n    // ... existing fields ...\n    \n    /// Provider-specific configuration.\n    /// Parsed as raw TOML table, then validated against resolved ProviderKind.\n    #[serde(default)]\n    pub provider: Option\u003cTomlTable\u003e,\n}\n```\n\n### 2. Create ProviderProfileConfig enum\n\n```rust\n// New file: config/provider_profile.rs (or in profile.rs)\nuse crate::openrouter_types::OpenRouterProfileConfig;\n\n/// Resolved provider-specific profile configuration.\n#[derive(Debug, Clone, PartialEq)]\npub enum ProviderProfileConfig {\n    /// OpenRouter routing and preferences\n    OpenRouter(OpenRouterProfileConfig),\n    /// OpenAI-specific settings (reasoning, etc.) - future\n    OpenAi(OpenAiProfileConfig),\n    /// Anthropic-specific settings - future\n    Anthropic(AnthropicProfileConfig),\n    /// Gemini-specific settings - future\n    Gemini(GeminiProfileConfig),\n    /// Provider has no specific config or none was provided\n    None,\n}\n\n// Placeholder structs for future expansion\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenAiProfileConfig {\n    // Future: reasoning_effort, reasoning_summary, etc.\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct AnthropicProfileConfig {\n    // Future: thinking, beta flags, etc.\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct GeminiProfileConfig {\n    // Future: safety_settings, etc.\n}\n```\n\n### 3. Add resolution function\n\n```rust\n// config/mod.rs or config/provider_profile.rs\n\nuse crate::model_provider_info::ProviderKind;\nuse crate::error::CodexErr;\n\n/// Resolve raw provider config table into typed struct based on provider kind.\npub fn resolve_provider_config(\n    raw_table: Option\u003c\u0026TomlTable\u003e,\n    provider_kind: ProviderKind,\n    profile_name: \u0026str,\n) -\u003e Result\u003cProviderProfileConfig, CodexErr\u003e {\n    let Some(table) = raw_table else {\n        return Ok(ProviderProfileConfig::None);\n    };\n    \n    // Convert toml::Table to toml::Value for deserialization\n    let value = toml::Value::Table(table.clone());\n    \n    match provider_kind {\n        ProviderKind::OpenRouter =\u003e {\n            let config: OpenRouterProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid OpenRouter config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::OpenRouter(config))\n        }\n        ProviderKind::OpenAi =\u003e {\n            let config: OpenAiProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid OpenAI config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::OpenAi(config))\n        }\n        ProviderKind::Anthropic =\u003e {\n            let config: AnthropicProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid Anthropic config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::Anthropic(config))\n        }\n        ProviderKind::Gemini =\u003e {\n            let config: GeminiProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid Gemini config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::Gemini(config))\n        }\n        ProviderKind::Antigravity =\u003e {\n            // Antigravity doesn't have provider-specific config\n            if !table.is_empty() {\n                return Err(CodexErr::ConfigError(format!(\n                    \"Profile '{profile_name}' has [provider] config but Antigravity doesn't support it\"\n                )));\n            }\n            Ok(ProviderProfileConfig::None)\n        }\n    }\n}\n```\n\n### 4. Integrate into config loading\n\nIn `Config::load_from_base_config_with_overrides`, after resolving the provider:\n\n```rust\n// After resolving model_provider -\u003e ModelProviderInfo\nlet provider_profile_config = resolve_provider_config(\n    profile.provider.as_ref(),\n    model_provider.provider_kind,\n    \u0026profile_name,\n)?;\n\n// Store in Config struct (add new field)\nConfig {\n    // ... existing fields ...\n    provider_profile_config,\n}\n```\n\n## Testing\n\n```rust\n#[test]\nfn resolve_openrouter_provider_config() {\n    let mut table = TomlTable::new();\n    let mut routing = TomlTable::new();\n    routing.insert(\"order\".into(), toml::Value::Array(vec![\"xai\".into()]));\n    table.insert(\"routing\".into(), toml::Value::Table(routing));\n    \n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    match result {\n        ProviderProfileConfig::OpenRouter(config) =\u003e {\n            assert_eq!(config.routing.unwrap().order, Some(vec![\"xai\".to_string()]));\n        }\n        _ =\u003e panic!(\"Expected OpenRouter config\"),\n    }\n}\n\n#[test]\nfn reject_openrouter_config_on_openai_provider() {\n    let mut table = TomlTable::new();\n    let mut routing = TomlTable::new();\n    routing.insert(\"order\".into(), toml::Value::Array(vec![\"xai\".into()]));\n    table.insert(\"routing\".into(), toml::Value::Table(routing));\n    \n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenAi,  // Wrong provider!\n        \"test-profile\",\n    );\n    \n    // Should fail because OpenAiProfileConfig has deny_unknown_fields\n    // and doesn't have a 'routing' field\n    assert!(result.is_err());\n}\n\n#[test]\nfn empty_provider_table_is_ok() {\n    let table = TomlTable::new();\n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    match result {\n        ProviderProfileConfig::OpenRouter(config) =\u003e {\n            assert!(config.routing.is_none());\n        }\n        _ =\u003e panic!(\"Expected OpenRouter config\"),\n    }\n}\n\n#[test]\nfn no_provider_table_returns_none() {\n    let result = resolve_provider_config(\n        None,\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    assert!(matches!(result, ProviderProfileConfig::None));\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `ConfigProfile.provider: Option\u003cTomlTable\u003e` field added\n- [ ] `ProviderProfileConfig` enum with variants for each provider\n- [ ] `resolve_provider_config()` function correctly dispatches by ProviderKind\n- [ ] Unknown fields in provider config cause hard errors\n- [ ] Config loading integrates resolution\n- [ ] Tests for all provider kinds\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:46:57.881351131+01:00","updated_at":"2025-12-14T17:15:53.698347257+01:00","closed_at":"2025-12-14T17:15:53.698347257+01:00","dependencies":[{"issue_id":"codex-te1.3","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:46:57.88185829+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.3","depends_on_id":"codex-te1.1","type":"blocks","created_at":"2025-12-14T16:49:01.902575203+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.3","depends_on_id":"codex-te1.2","type":"blocks","created_at":"2025-12-14T16:49:12.016769291+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.4","title":"Inject OpenRouter routing into Responses request body","description":"## What\n\nWhen the provider is OpenRouter and the profile has routing config, inject it as the `provider` field in the Responses API request body.\n\n## Why\n\nThis is the actual feature delivery - allowing users to control OpenRouter's provider routing via config.\n\n## Where\n\n**Primary files:**\n- `codex-rs/core/src/api_bridge.rs` - Where requests are built\n- `codex-rs/codex-api/src/requests/responses.rs` - ResponsesRequestBuilder\n\n## How\n\n### Option A: Modify ResponsesRequestBuilder\n\nAdd a method to inject provider-specific body fields:\n\n```rust\n// codex-api/src/requests/responses.rs\n\nimpl\u003c'a\u003e ResponsesRequestBuilder\u003c'a\u003e {\n    // ... existing methods ...\n    \n    /// Inject provider-specific fields into the request body.\n    /// For OpenRouter, this adds the \"provider\" routing configuration.\n    pub fn provider_config(mut self, config: Option\u003cserde_json::Value\u003e) -\u003e Self {\n        self.provider_config = config;\n        self\n    }\n}\n\n// In build():\nif let Some(provider_config) = self.provider_config {\n    if let Some(obj) = body.as_object_mut() {\n        obj.insert(\"provider\".to_string(), provider_config);\n    }\n}\n```\n\n### Option B: Post-process in api_bridge\n\nModify the body after building the request:\n\n```rust\n// core/src/api_bridge.rs\n\nfn build_responses_request(\n    // ... existing params ...\n    provider_profile_config: \u0026ProviderProfileConfig,\n) -\u003e Result\u003cResponsesRequest, CodexErr\u003e {\n    let mut request = ResponsesRequestBuilder::new(model, instructions, input)\n        // ... existing builder calls ...\n        .build(provider)?;\n    \n    // Inject OpenRouter routing if present\n    if let ProviderProfileConfig::OpenRouter(config) = provider_profile_config {\n        if let Some(routing) = \u0026config.routing {\n            if let Some(obj) = request.body.as_object_mut() {\n                let provider_value = serde_json::to_value(routing)\n                    .map_err(|e| CodexErr::Internal(format!(\"Failed to serialize OpenRouter routing: {e}\")))?;\n                obj.insert(\"provider\".to_string(), provider_value);\n            }\n        }\n    }\n    \n    Ok(request)\n}\n```\n\n### Request Body Example\n\nBefore:\n```json\n{\n  \"model\": \"x-ai/grok-4.1-fast\",\n  \"instructions\": \"...\",\n  \"input\": [...],\n  \"stream\": true\n}\n```\n\nAfter (with OpenRouter routing):\n```json\n{\n  \"model\": \"x-ai/grok-4.1-fast\",\n  \"instructions\": \"...\",\n  \"input\": [...],\n  \"stream\": true,\n  \"provider\": {\n    \"order\": [\"xai\"],\n    \"allow_fallbacks\": false,\n    \"data_collection\": \"deny\"\n  }\n}\n```\n\n### Thread provider config through the call stack\n\nThe `ProviderProfileConfig` needs to be available where requests are built. Trace the path:\n\n1. `Config` struct holds `provider_profile_config: ProviderProfileConfig`\n2. `Codex::new()` receives `Config`\n3. Request building functions need access to it\n\n## Testing\n\n```rust\n#[test]\nfn openrouter_routing_injected_into_request() {\n    let routing = OpenRouterRouting {\n        order: Some(vec![\"xai\".to_string()]),\n        allow_fallbacks: Some(false),\n        ..Default::default()\n    };\n    let config = ProviderProfileConfig::OpenRouter(OpenRouterProfileConfig {\n        routing: Some(routing),\n    });\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    let provider = request.body.get(\"provider\").expect(\"provider field should exist\");\n    assert_eq!(provider[\"order\"], serde_json::json!([\"xai\"]));\n    assert_eq!(provider[\"allow_fallbacks\"], serde_json::json!(false));\n}\n\n#[test]\nfn non_openrouter_provider_has_no_provider_field() {\n    let config = ProviderProfileConfig::OpenAi(OpenAiProfileConfig::default());\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    assert!(request.body.get(\"provider\").is_none());\n}\n\n#[test]\nfn openrouter_without_routing_has_no_provider_field() {\n    let config = ProviderProfileConfig::OpenRouter(OpenRouterProfileConfig {\n        routing: None,\n    });\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    assert!(request.body.get(\"provider\").is_none());\n}\n```\n\n### Integration Test\n\n```rust\n#[tokio::test]\nasync fn openrouter_routing_sent_to_server() {\n    let config_toml = r#\"\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"http://localhost:PORT\"\nwire_api = \"responses\"\n\n[profiles.test]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\n\n[profiles.test.provider]\nrouting.order = [\"xai\"]\nrouting.allow_fallbacks = false\n    \"#;\n    \n    // Set up mock server\n    let server = MockServer::start().await;\n    let mock = server.mock(|when, then| {\n        when.method(POST)\n            .path(\"/responses\")\n            .json_body_partial(json!({\n                \"provider\": {\n                    \"order\": [\"xai\"],\n                    \"allow_fallbacks\": false\n                }\n            }));\n        then.status(200).body(sse_response());\n    });\n    \n    // Run codex with config\n    // ... test setup ...\n    \n    mock.assert();\n}\n```\n\n## Acceptance Criteria\n\n- [ ] OpenRouter routing config serialized into `provider` field\n- [ ] Only injected when provider_kind is OpenRouter AND routing is Some\n- [ ] Non-OpenRouter providers don't get `provider` field\n- [ ] Request body structure matches OpenRouter API spec\n- [ ] Unit tests pass\n- [ ] Integration test verifies actual request sent to mock server\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:47:37.539339392+01:00","updated_at":"2025-12-14T17:22:49.408467447+01:00","closed_at":"2025-12-14T17:22:49.408467447+01:00","dependencies":[{"issue_id":"codex-te1.4","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:47:37.540365722+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.4","depends_on_id":"codex-te1.3","type":"blocks","created_at":"2025-12-14T16:49:06.959562503+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.5","title":"Add built-in OpenRouter provider definition","description":"## What\n\nAdd OpenRouter as a built-in provider in `built_in_model_providers()` so users don't need to define it manually.\n\n## Why\n\nOpenRouter is a popular meta-provider. Having it built-in improves UX - users just need to set `OPENROUTER_API_KEY` and select the provider.\n\n## Where\n\n**File:** `codex-rs/core/src/model_provider_info.rs`\n\n## How\n\n```rust\npub fn built_in_model_providers() -\u003e HashMap\u003cString, ModelProviderInfo\u003e {\n    use ModelProviderInfo as P;\n\n    [\n        (\"openai\", P::create_openai_provider()),\n        (\n            \"anthropic\",\n            P {\n                name: \"Anthropic\".into(),\n                // ... existing ...\n            },\n        ),\n        (\n            \"gemini\",\n            P {\n                name: \"Gemini\".into(),\n                // ... existing ...\n            },\n        ),\n        // NEW: OpenRouter\n        (\n            \"openrouter\",\n            P {\n                name: \"OpenRouter\".into(),\n                base_url: Some(\"https://openrouter.ai/api/v1\".into()),\n                env_key: Some(\"OPENROUTER_API_KEY\".to_string()),\n                env_key_instructions: Some(\n                    \"Get your API key at https://openrouter.ai/keys\".into()\n                ),\n                experimental_bearer_token: None,\n                wire_api: WireApi::Responses,\n                provider_kind: ProviderKind::OpenRouter,\n                query_params: None,\n                http_headers: None,\n                env_http_headers: None,\n                request_max_retries: Some(DEFAULT_REQUEST_MAX_RETRIES),\n                stream_max_retries: Some(DEFAULT_STREAM_MAX_RETRIES),\n                stream_idle_timeout_ms: Some(DEFAULT_STREAM_IDLE_TIMEOUT_MS),\n                requires_openai_auth: false,\n                api_key_env_var: None,\n                version: None,\n                beta: None,\n                project_id: None,\n                use_bearer_auth: true,  // OpenRouter uses Bearer auth\n            },\n        ),\n    ]\n    .into_iter()\n    .map(|(k, v)| (k.to_string(), v))\n    .collect()\n}\n```\n\n## Usage After Implementation\n\nUsers can immediately use OpenRouter:\n\n```bash\nexport OPENROUTER_API_KEY=\"sk-or-...\"\ncodex --model-provider openrouter --model anthropic/claude-3.5-sonnet\n```\n\nOr in config.toml:\n\n```toml\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\n\n[profiles.grok.provider]\nrouting.order = [\"xai\"]\n```\n\n## Testing\n\n```rust\n#[test]\nfn built_in_providers_includes_openrouter() {\n    let providers = built_in_model_providers();\n    \n    let openrouter = providers.get(\"openrouter\").expect(\"openrouter should exist\");\n    assert_eq!(openrouter.name, \"OpenRouter\");\n    assert_eq!(openrouter.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(openrouter.wire_api, WireApi::Responses);\n    assert_eq!(openrouter.env_key, Some(\"OPENROUTER_API_KEY\".to_string()));\n    assert!(openrouter.use_bearer_auth);\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `openrouter` key in built_in_model_providers()\n- [ ] Correct base_url, env_key, wire_api, provider_kind\n- [ ] Uses Bearer auth (not x-api-key header)\n- [ ] Has helpful env_key_instructions\n- [ ] Test verifies built-in exists\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T16:48:03.772273563+01:00","updated_at":"2025-12-14T17:04:23.064987727+01:00","closed_at":"2025-12-14T17:04:23.064987727+01:00","dependencies":[{"issue_id":"codex-te1.5","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:48:03.772980944+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.5","depends_on_id":"codex-te1.1","type":"blocks","created_at":"2025-12-14T16:49:17.076247825+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.6","title":"Update documentation with OpenRouter config example","description":"## What\n\nAdd documentation for the new provider-specific configuration system, with OpenRouter as the primary example.\n\n## Why\n\nUsers need to know:\n1. How to configure OpenRouter routing\n2. The general pattern for provider-specific config\n3. What fields are available\n\n## Where\n\n**Files to update:**\n- `docs/config.md` (or equivalent config documentation)\n- `codex-rs/core/src/model_provider_info.rs` (doc comments)\n\n## How\n\n### Config Documentation Section\n\n```markdown\n## Provider-Specific Configuration\n\nSome providers support additional configuration beyond the standard profile fields.\nThese are specified in a `[profiles.\u003cname\u003e.provider]` table.\n\n### OpenRouter\n\nOpenRouter supports routing preferences to control which underlying providers \nserve your requests.\n\n```toml\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\nwire_api = \"responses\"\n\n[profiles.my-profile]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\nmodel_reasoning_effort = \"high\"\n\n# OpenRouter-specific routing configuration\n[profiles.my-profile.provider]\nrouting.order = [\"xai\"]                    # Preferred providers, in order\nrouting.allow_fallbacks = false            # Don't fall back to other providers\nrouting.require_parameters = true          # Only use providers supporting all params\nrouting.data_collection = \"deny\"           # Opt out of training data collection\n```\n\n#### Available Routing Options\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `order` | string[] | Ordered list of preferred provider names |\n| `allow_fallbacks` | bool | Allow fallback to non-preferred providers (default: true) |\n| `require_parameters` | bool | Only use providers supporting all request params (default: true) |\n| `data_collection` | \"allow\" \\| \"deny\" | Control training data collection |\n| `zdr` | bool | Zero Data Retention - only use providers with ZDR agreements |\n| `only` | string[] | Exclusive list of allowed providers |\n| `ignore` | string[] | Providers to never use |\n| `sort` | \"price\" \\| \"throughput\" \\| \"latency\" | Sort preference for provider ranking |\n| `max_price.prompt` | float | Max price per million prompt tokens (USD) |\n| `max_price.completion` | float | Max price per million completion tokens (USD) |\n\nSee [OpenRouter Provider Routing](https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider) for full details.\n\n### Other Providers\n\nOther providers have their own `[profiles.\u003cname\u003e.provider]` options:\n\n- **OpenAI**: (planned) reasoning_effort, reasoning_summary\n- **Anthropic**: (planned) thinking settings, beta flags\n- **Gemini**: (planned) safety_settings\n\nUsing options for the wrong provider type will result in a configuration error.\n```\n\n### Inline Doc Comments\n\nAdd to `OpenRouterRouting` struct:\n\n```rust\n/// OpenRouter provider routing configuration.\n/// \n/// Configure which underlying providers serve requests and under what conditions.\n/// Set via `[profiles.\u003cname\u003e.provider.routing]` in config.toml.\n/// \n/// # Example\n/// \n/// ```toml\n/// [profiles.my-profile.provider]\n/// routing.order = [\"xai\", \"openai\"]\n/// routing.allow_fallbacks = false\n/// routing.data_collection = \"deny\"\n/// ```\n/// \n/// Reference: https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider\n#[derive(Debug, Clone, Default, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterRouting {\n    // ...\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Config.md updated with provider-specific config section\n- [ ] OpenRouter example is complete and correct\n- [ ] All routing options documented with types\n- [ ] Link to OpenRouter API docs\n- [ ] Inline doc comments on OpenRouterRouting struct\n- [ ] Note about wrong-provider errors\n- [ ] Placeholder notes for other provider configs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T16:48:35.921077052+01:00","updated_at":"2025-12-14T17:27:04.95454122+01:00","closed_at":"2025-12-14T17:27:04.95454122+01:00","dependencies":[{"issue_id":"codex-te1.6","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:48:35.921643022+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.6","depends_on_id":"codex-te1.4","type":"blocks","created_at":"2025-12-14T16:48:56.847503698+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-u12","title":"Use model_context_window from config for context percentage calculation","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T16:13:59.274785935+01:00","updated_at":"2025-12-07T16:18:05.979811379+01:00","closed_at":"2025-12-07T16:18:05.979811379+01:00"}
{"id":"codex-vq1","title":"ChatGPT login overwrites Gemini tokens","description":"persist_tokens_async in login/server.rs builds a fresh AuthDotJson with empty gemini_accounts when saving ChatGPT tokens, wiping existing Gemini credentials. Need to merge with existing auth.json so Gemini accounts survive ChatGPT login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:55:23.755383003+01:00","updated_at":"2025-12-06T13:57:34.877510865+01:00","closed_at":"2025-12-06T13:57:34.877510865+01:00"}
{"id":"codex-wan","title":"Simplify reasoning display config","description":"Replace hide_agent_reasoning + show_raw_agent_reasoning with single reasoning_display enum (auto/raw/none). Reduces config confusion and prevents duplicate output.","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-18T16:34:02.946459889+01:00","updated_at":"2025-12-18T16:34:02.946459889+01:00"}
{"id":"codex-wan.1","title":"Update TurnItem::as_legacy_events to use ReasoningDisplay","description":"In protocol/src/items.rs: change as_legacy_events(show_raw: bool) to as_legacy_events(display: ReasoningDisplay). Auto=emit summary, Raw=emit raw, None=emit nothing.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:37.447461104+01:00","updated_at":"2025-12-18T16:57:00.814473511+01:00","closed_at":"2025-12-18T16:57:00.814473511+01:00","dependencies":[{"issue_id":"codex-wan.1","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:37.447841639+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.2","title":"Update codex.rs send_event to pass ReasoningDisplay","description":"In core/src/codex.rs: update show_raw_agent_reasoning() to return ReasoningDisplay and pass it to as_legacy_events().","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:42.501691701+01:00","updated_at":"2025-12-18T16:34:42.501691701+01:00","dependencies":[{"issue_id":"codex-wan.2","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:42.502151227+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.3","title":"Update exec event processor for ReasoningDisplay","description":"In exec/src/event_processor_with_human_output.rs: replace show_agent_reasoning/show_raw_agent_reasoning with reasoning_display enum matching.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:47.561792456+01:00","updated_at":"2025-12-18T16:34:47.561792456+01:00","dependencies":[{"issue_id":"codex-wan.3","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:47.562175988+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.4","title":"Update TUI for ReasoningDisplay","description":"In tui/src: update any reasoning display logic to use the new ReasoningDisplay enum instead of separate bool flags.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:52.624618089+01:00","updated_at":"2025-12-18T16:34:52.624618089+01:00","dependencies":[{"issue_id":"codex-wan.4","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:52.625067616+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.5","title":"Replace hide/show flags with reasoning_display in Config","description":"In core/src/config/mod.rs: remove hide_agent_reasoning and show_raw_agent_reasoning, add reasoning_display: ReasoningDisplay. Update ConfigProfile and ConfigOverrides similarly.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:57.67804739+01:00","updated_at":"2025-12-18T16:34:57.67804739+01:00","dependencies":[{"issue_id":"codex-wan.5","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:57.67852462+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.6","title":"Add ReasoningDisplay enum to protocol","description":"Add enum ReasoningDisplay { Auto, Raw, None } to protocol/src/config_types.rs with serde/Default derives. Auto is default.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:35:02.731875191+01:00","updated_at":"2025-12-18T16:56:39.562471348+01:00","closed_at":"2025-12-18T16:56:39.562471348+01:00","dependencies":[{"issue_id":"codex-wan.6","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:35:02.732361118+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m","title":"Skills cache mtime-based refresh improvements","description":"Implement file-level mtime checking to detect SKILL.md content edits. Currently only root directory mtime is checked, missing content changes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-18T23:03:13.868609791+01:00","updated_at":"2025-12-19T01:18:11.280463305+01:00","closed_at":"2025-12-19T01:18:11.280463305+01:00"}
{"id":"codex-x6m.1","title":"Update CachedSkills to track file mtimes","description":"Modify CachedSkills struct to store file_states: Vec\u003c(PathBuf, SystemTime)\u003e for each SKILL.md file loaded. Update validation to check both root and file mtimes.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T23:03:25.32059875+01:00","updated_at":"2025-12-18T23:11:47.412512629+01:00","closed_at":"2025-12-18T23:11:47.412512629+01:00","dependencies":[{"issue_id":"codex-x6m.1","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:25.321099025+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.2","title":"Remove dead invalidate_cache and invalidate_cwd methods","description":"Remove the #[allow(dead_code)] invalidate_cache() and invalidate_cwd() methods from SkillsManager - no longer needed with proper mtime tracking.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:35.882804844+01:00","updated_at":"2025-12-18T23:12:31.303810166+01:00","closed_at":"2025-12-18T23:12:31.303810166+01:00","dependencies":[{"issue_id":"codex-x6m.2","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:35.883726394+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.3","title":"Add test for skill removal detection","description":"Add test_cache_invalidation_on_skill_removal: load skills, delete a skill directory, verify reload detects removal.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:46.728105267+01:00","updated_at":"2025-12-18T23:19:21.004917188+01:00","closed_at":"2025-12-18T23:19:21.004917188+01:00","dependencies":[{"issue_id":"codex-x6m.3","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:46.728638194+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.4","title":"Add test for skill content edit detection","description":"Add test_cache_invalidation_on_skill_edit: load skills, modify SKILL.md content, verify reload detects change. Replace existing test_cache_hit_ignoring_content_change.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:57.422650121+01:00","updated_at":"2025-12-18T23:20:19.430586995+01:00","closed_at":"2025-12-18T23:20:19.430586995+01:00","dependencies":[{"issue_id":"codex-x6m.4","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:57.42304251+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.5","title":"Add test for skill precedence (repo vs user)","description":"Add test_repo_skills_override_user_skills: create same-named skill in both repo and user dirs, verify repo takes precedence.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:04:07.508347053+01:00","updated_at":"2025-12-18T23:24:35.003947514+01:00","closed_at":"2025-12-18T23:24:35.003947514+01:00","dependencies":[{"issue_id":"codex-x6m.5","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:04:07.508843511+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.6","title":"Add test for cache isolation between cwds","description":"Add test_cache_isolation_between_cwds: verify skills for cwd_a don't leak into cwd_b.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:04:17.843300246+01:00","updated_at":"2025-12-19T01:18:00.988424174+01:00","closed_at":"2025-12-19T01:18:00.988424174+01:00","dependencies":[{"issue_id":"codex-x6m.6","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:04:17.843662097+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-yr6","title":"Fix failing test model_migration_prompt_only_shows_for_deprecated_models in tui2","status":"open","priority":2,"issue_type":"bug","created_at":"2025-12-15T15:16:14.896470158+01:00","updated_at":"2025-12-15T15:16:14.896470158+01:00"}
{"id":"codex-zal","title":"Editable handoff draft via EDITOR","description":"## Goal\nAllow user to edit handoff draft in external editor before confirming.\n\n## Implementation\n1. Add 'e' key binding to handoff review screen\n2. Serialize draft to temp Markdown file\n3. Spawn $EDITOR, wait for exit\n4. Parse Markdown back to HandoffDraft\n5. Handle parse errors gracefully\n\n## Markdown Format\n```markdown\n# Goal\n\u003cgoal text\u003e\n\n# Summary  \n\u003csummary text\u003e\n\n# Relevant Files\n# One per line\nsrc/file1.rs\nsrc/file2.rs\n```\n\n## Key Bindings\n- Enter: Confirm as-is\n- Esc: Cancel\n- e: Edit in $EDITOR\n\n## Files to modify\n- tui/src/handoff_review.rs - add 'e' key handling, serialize/parse logic\n- tui/src/app.rs - handle editor spawning (look at /edit command pattern)","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T01:47:02.893245253+01:00","updated_at":"2025-12-21T01:47:02.893245253+01:00"}
{"id":"codex-zf4","title":"Quote paths with spaces in file mentions","description":"## Goal\nFix ambiguity when file paths contain spaces in handoff file mentions.\n\n## Implementation\nUpdate format_file_mentions in core/src/conversation_manager.rs to conditionally quote paths:\n\n```rust\nfn format_file_mentions(files: \u0026[PathBuf]) -\u003e String {\n    files.iter()\n        .take(12)\n        .map(|p| {\n            let s = p.display().to_string();\n            if s.chars().any(char::is_whitespace) {\n                format!(\"@\\\"{}\\\"\", s)  // Quote paths with spaces\n            } else {\n                format!(\"@{}\", s)\n            }\n        })\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\" \")\n}\n```\n\n## Files to modify\n- core/src/conversation_manager.rs - update format_file_mentions function","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-21T01:46:57.4551251+01:00","updated_at":"2025-12-21T01:46:57.4551251+01:00"}
{"id":"codex-zk7","title":"Gemini Provider Logic Alignment","description":"Epic to align codex-rs Gemini provider logic with gemini-cli best practices for stability and token efficiency. This involves implementing strict history curation, robust active loop detection, and proper tool cancellation feedback.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T12:22:23.70575291+01:00","updated_at":"2025-12-20T15:13:59.64849394+01:00","closed_at":"2025-12-20T15:13:59.64849394+01:00"}
{"id":"codex-zk7.1","title":"Implement Strict History Curation for Gemini","description":"What: Implement a strict history curation pass in core/src/gemini_messages.rs before sending requests to Gemini.\n\nHow: Iterate through message history to merge consecutive turns of the same role and enforce strict User-Model-User alternation. Drop orphaned tool calls or responses if they violate alternation.\n\nWhy: Gemini is extremely strict about history structure. Currently, codex-rs can produce invalid sequences (like text + tool response creating two user turns), leading to fatal 400 errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T12:22:30.901597316+01:00","updated_at":"2025-12-20T15:13:48.957691775+01:00","closed_at":"2025-12-20T15:13:48.957691775+01:00","dependencies":[{"issue_id":"codex-zk7.1","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.902037405+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.2","title":"Robust Active Loop Identification for Signatures","description":"What: Improve the logic for identifying the active loop start index in apply_synthetic_thought_signatures.\n\nHow: Instead of looking for the last user message with non-empty text, find the last user message that is NOT a tool response (i.e., does not contain function response parts).\n\nWhy: The current heuristic fails if a user message contains images or other non-text data, potentially leaving the model turn unsigned and causing API rejection.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.911713522+01:00","updated_at":"2025-12-20T15:13:50.93348213+01:00","closed_at":"2025-12-20T15:13:50.93348213+01:00","dependencies":[{"issue_id":"codex-zk7.2","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.911993006+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.3","title":"Implement Explicit Tool Cancellation Feedback","description":"What: Refine explicit tool cancellation feedback and prevent model apology loops.\n\nHow: \n1. Acknowledge existing cancellation feedback in core/src/tools/parallel.rs (injects 'aborted by user').\n2. Verify if non-parallel tool paths correctly inject cancellation messages.\n3. Ensure that when a tool is cancelled, the agent loop short-circuits so the model does NOT immediately generate a response (avoiding apology loops). \n4. Optionally align the 'aborted by user' string with gemini-cli's 'canceled by the user'.\n\nWhy: While a basic mechanism exists, we need to ensure it applies globally and doesn't waste tokens on apology turns after a user explicitly interrupts.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.920506774+01:00","updated_at":"2025-12-20T15:13:52.246937948+01:00","closed_at":"2025-12-20T15:13:52.246937948+01:00","dependencies":[{"issue_id":"codex-zk7.3","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.920766229+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.4","title":"Strip Thought Signatures from Historical Turns","description":"What: Omit the thought_signature property from historical function calls in GeminiContent.\n\nHow: Modify build_gemini_messages to only populate thought_signature for the active turn (most recent exchange).\n\nWhy: Signatures are one-time validation tokens with no semantic value in history. Stripping them saves context window tokens (~5-10 per tool call) and reduces noise.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.929168234+01:00","updated_at":"2025-12-20T15:13:54.639550774+01:00","closed_at":"2025-12-20T15:13:54.639550774+01:00","dependencies":[{"issue_id":"codex-zk7.4","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.929426707+01:00","created_by":"daemon","metadata":"{}"}]}
