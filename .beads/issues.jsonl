{"id":"codex-0c6","title":"Handle unified diff line numbers in apply_patch @@ marker","description":"## Problem\nModels sometimes emit unified diff format `@@ -308,52 +308,51 @@` instead of our format `@@ function_name`.\n\nThe parser strips `@@ ` prefix and tries to find literal text `-308,52 +308,51 @@` in the file, which fails.\n\n## Root Cause\n`parse_update_file_chunk` in `apply-patch/src/parser.rs` treats everything after `@@ ` as a literal context string to search for.\n\n## Fix\nDetect unified diff line number pattern (regex: `^-?\\d+,?\\d*\\s+\\+?\\d+,?\\d*\\s*@@$`) and either:\n1. Strip it and treat as empty context (preferred - simpler)\n2. Emit helpful error message\n\n## Definition of Done\n- Patches with `@@ -123,10 +123,11 @@` work (treated as `@@`)\n- Existing `@@ function_name` behavior unchanged\n- Tests added\n- `cargo test -p codex-apply-patch` passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T12:41:07.791177809+01:00","updated_at":"2026-01-07T14:10:22.95037315+01:00","closed_at":"2026-01-07T14:10:22.95037315+01:00"}
{"id":"codex-0d1","title":"Epic: Remove git worktree isolation feature","description":"Complete removal of the git worktree-based subagent isolation feature. Subagents will run directly in the parent working directory instead of isolated worktrees. This simplifies the codebase and removes ~700+ LOC of complexity.","notes":"Additional cleanup: Simplified SubagentOutcome - removed file tracking and conflict variants since we no longer have worktree isolation. SubagentTaskResult now only contains output + session_id.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-03T17:48:45.169195978+01:00","updated_at":"2026-01-03T18:41:13.918741142+01:00","closed_at":"2026-01-03T18:15:05.352008135+01:00"}
{"id":"codex-0d1.1","title":"Delete worktree_manager.rs and remove module exports","description":"Delete core/src/worktree_manager.rs (~679 LOC) entirely. Update core/src/lib.rs to remove:\n- `pub mod worktree_manager;`\n- `pub use worktree_manager::*;`\n\nThis removes: WorktreeManager, WorktreeHandle, WorktreeDiff, PatchApplyResult structs and all associated impl blocks.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:48:51.476207731+01:00","updated_at":"2026-01-03T17:57:19.782582824+01:00","closed_at":"2026-01-03T17:57:19.782582824+01:00","dependencies":[{"issue_id":"codex-0d1.1","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:48:51.476521049+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.10","title":"Update snapshot tests for removed events","description":"Run TUI tests and update any snapshots that reference SubagentChangesMerged events or worktree-related content:\n\n1. Run `cargo test -p codex-tui` to identify failing snapshot tests\n2. Review any `.snap.new` files generated\n3. Accept updated snapshots with `cargo insta accept -p codex-tui` after verifying correctness\n4. Ensure no test references removed types (SubagentChangesMergedCell, etc.)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:48.207065239+01:00","updated_at":"2026-01-03T18:12:53.716150491+01:00","closed_at":"2026-01-03T18:12:53.716150491+01:00","dependencies":[{"issue_id":"codex-0d1.10","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:48.207386402+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.10","depends_on_id":"codex-0d1.7","type":"blocks","created_at":"2026-01-03T17:50:03.672429656+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.10","depends_on_id":"codex-0d1.8","type":"blocks","created_at":"2026-01-03T17:50:03.690601116+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.10","depends_on_id":"codex-0d1.9","type":"blocks","created_at":"2026-01-03T17:50:03.70714375+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.11","title":"Final verification and cleanup","description":"Final steps to verify the removal is complete:\n\n1. Run `just fix -p codex-core` to fix any linter issues\n2. Run `just fix -p codex-tui` to fix any TUI linter issues\n3. Run `cargo check --bin codex` to verify full binary compiles\n4. Run `cargo test -p codex-core --all-features` to run core tests\n5. Run `cargo test -p codex-tui` to run TUI tests\n6. Search for any remaining 'worktree' references: `rg worktree --type rust` and clean up\n7. Verify no orphaned imports or dead code warnings","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:53.038261664+01:00","updated_at":"2026-01-03T18:14:58.971502791+01:00","closed_at":"2026-01-03T18:14:58.971502791+01:00","dependencies":[{"issue_id":"codex-0d1.11","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:53.038607875+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.11","depends_on_id":"codex-0d1.10","type":"blocks","created_at":"2026-01-03T17:50:03.725400342+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.2","title":"Remove SubagentWorktreeIsolation feature flag","description":"In core/src/features.rs:\n1. Remove `SubagentWorktreeIsolation` variant from `Feature` enum\n2. Remove corresponding `FeatureSpec` entry from the FEATURES array:\n   ```rust\n   FeatureSpec {\n       id: Feature::SubagentWorktreeIsolation,\n       key: \"subagent_worktree_isolation\",\n       stage: Stage::Stable,\n       default_enabled: true,\n   }\n   ```","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:48:55.171753675+01:00","updated_at":"2026-01-03T17:57:19.806212431+01:00","closed_at":"2026-01-03T17:57:19.806212431+01:00","dependencies":[{"issue_id":"codex-0d1.2","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:48:55.172157875+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.3","title":"Remove startup worktree pruning from codex.rs","description":"In core/src/codex.rs:\n1. Remove import: `use crate::worktree_manager::WorktreeManager;`\n2. Remove the startup pruning block (around lines where it says 'Prune any orphaned worktrees from previous sessions'):\n   ```rust\n   if let Ok(repo_root) = WorktreeManager::get_repo_root(\u0026config.cwd).await {\n       let worktree_manager = WorktreeManager::new_for_repo(\u0026repo_root);\n       if let Err(e) = worktree_manager.prune_orphaned_worktrees().await {\n           tracing::debug!(error = %e, \"Failed to prune orphaned worktrees on startup\");\n       }\n   }\n   ```","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:48:59.902353898+01:00","updated_at":"2026-01-03T17:57:19.825218122+01:00","closed_at":"2026-01-03T17:57:19.825218122+01:00","dependencies":[{"issue_id":"codex-0d1.3","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:48:59.902777436+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.4","title":"Simplify task.rs - remove all worktree isolation logic","description":"Major rewrite of core/src/tools/handlers/task.rs to remove worktree isolation:\n\nREMOVE IMPORTS:\n- `use crate::worktree_manager::PatchApplyResult;`\n- `use crate::worktree_manager::WorktreeManager;`\n\nREMOVE CONSTANTS:\n- Delete `WORKTREE_ISOLATION_PROMPT` const (the entire multi-line string)\n- Delete `NO_ISOLATION_PROMPT` const (the entire multi-line string)\n\nUPDATE TOOL DESCRIPTION:\n- Change 'Subagents run in isolated git worktrees; their changes are merged back when complete.' to 'Subagents run in the same working directory as the parent session.'\n\nSIMPLIFY EXECUTION FLOW in the handler:\n1. Remove `is_git_repo` check and `WorktreeManager::is_git_repo()` call\n2. Remove `worktree_manager` and `repo_root` variables entirely\n3. Remove `worktree_isolation_enabled` and `use_worktree` logic\n4. Remove `worktree_handle` variable - set `effective_cwd = parent_worktree.clone()` directly\n5. Remove the `create_worktree()` call and error handling\n6. Remove `isolation_prompt` variable - subagents don't need isolation prompts anymore\n7. Remove post-execution diff generation: `worktree_manager.generate_diff(\u0026handle)`\n8. Remove patch application: `apply_patch()` call and `PatchApplyResult` handling\n9. Remove `SubagentChangesMerged` event emission\n10. Remove `worktree_manager.cleanup(\u0026handle)` call\n11. Remove the 'reusing session, update cwd to new worktree' warning\n\nThe subagent should simply run in `parent_worktree` directly with no special handling.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:15.858035912+01:00","updated_at":"2026-01-03T17:59:31.580898214+01:00","closed_at":"2026-01-03T17:59:31.580898214+01:00","dependencies":[{"issue_id":"codex-0d1.4","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:15.858390518+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.4","depends_on_id":"codex-0d1.1","type":"blocks","created_at":"2026-01-03T17:50:03.550623333+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.4","depends_on_id":"codex-0d1.2","type":"blocks","created_at":"2026-01-03T17:50:03.568286052+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.5","title":"Delete subagent_changes.rs from protocol","description":"Delete protocol/src/subagent_changes.rs entirely.\n\nThen update protocol/src/lib.rs:\n1. Remove `mod subagent_changes;`\n2. Remove `pub use subagent_changes::*;` or any re-exports of SubagentChangesStatus, SubagentChanges, FileChangeSummary\n\nNote: FileChangeSummary may be used elsewhere - check if it needs to be preserved or moved.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:21.120254071+01:00","updated_at":"2026-01-03T18:02:04.136825962+01:00","closed_at":"2026-01-03T18:02:04.136825962+01:00","dependencies":[{"issue_id":"codex-0d1.5","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:21.120732744+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.5","depends_on_id":"codex-0d1.4","type":"blocks","created_at":"2026-01-03T17:50:03.585761766+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.6","title":"Remove SubagentChangesMergedEvent from protocol.rs","description":"In protocol/src/protocol.rs:\n\n1. Remove the `SubagentChangesMergedEvent` struct definition:\n   ```rust\n   #[derive(Debug, Clone, Deserialize, Serialize, TS, JsonSchema)]\n   pub struct SubagentChangesMergedEvent {\n       pub subagent_name: String,\n       pub task_description: String,\n       pub files_changed: Vec\u003ccrate::subagent_changes::FileChangeSummary\u003e,\n       #[serde(default, skip_serializing_if = \"Option::is_none\")]\n       pub session_id: Option\u003cString\u003e,\n   }\n   ```\n\n2. Remove the `SubagentChangesMerged(SubagentChangesMergedEvent)` variant from the `EventMsg` enum","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:26.451377987+01:00","updated_at":"2026-01-03T18:03:48.604925347+01:00","closed_at":"2026-01-03T18:03:48.604925347+01:00","dependencies":[{"issue_id":"codex-0d1.6","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:26.451794792+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.6","depends_on_id":"codex-0d1.5","type":"blocks","created_at":"2026-01-03T17:50:03.603399468+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.7","title":"Update TUI to remove SubagentChangesMerged handling","description":"Update TUI files to remove SubagentChangesMerged event handling:\n\n1. tui/src/chatwidget.rs:\n   - Remove import: `use codex_core::protocol::SubagentChangesMergedEvent;`\n   - Remove the match arm for `EventMsg::SubagentChangesMerged(SubagentChangesMergedEvent { ... })`\n\n2. tui/src/history_cell.rs:\n   - Remove `SubagentChangesMergedCell` struct and its `impl HistoryCell` block\n   - Remove the `pub(crate) fn create_subagent_changes_merged_cell()` function (or similar factory function)\n   - Remove any imports related to FileChangeSummary if no longer needed\n\n3. tui/src/app.rs:\n   - Replace `codex_core::WorktreeManager::is_git_repo(\u0026config.cwd)` with a simple inline git check:\n     ```rust\n     async fn is_git_repo(dir: \u0026Path) -\u003e bool {\n         tokio::process::Command::new(\"git\")\n             .args([\"rev-parse\", \"--git-dir\"])\n             .current_dir(dir)\n             .stdout(std::process::Stdio::null())\n             .stderr(std::process::Stdio::null())\n             .status()\n             .await\n             .map(|s| s.success())\n             .unwrap_or(false)\n     }\n     ```\n   - Or import from codex_core if a utility is preserved there","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:37.785099139+01:00","updated_at":"2026-01-03T18:08:22.077828692+01:00","closed_at":"2026-01-03T18:08:22.077828692+01:00","dependencies":[{"issue_id":"codex-0d1.7","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:37.785572111+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.7","depends_on_id":"codex-0d1.6","type":"blocks","created_at":"2026-01-03T17:50:03.621087596+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.8","title":"Update exec and mcp-server event handlers","description":"Remove SubagentChangesMerged match arms from event handlers:\n\n1. exec/src/event_processor_with_human_output.rs:\n   - Remove `| EventMsg::SubagentChangesMerged(_)` from the match arm that ignores these events\n\n2. mcp-server/src/codex_tool_runner.rs:\n   - Remove `| EventMsg::SubagentChangesMerged(_)` from the match arm","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:41.591645002+01:00","updated_at":"2026-01-03T18:08:22.095371815+01:00","closed_at":"2026-01-03T18:08:22.095371815+01:00","dependencies":[{"issue_id":"codex-0d1.8","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:41.591975413+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.8","depends_on_id":"codex-0d1.6","type":"blocks","created_at":"2026-01-03T17:50:03.638447859+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0d1.9","title":"Remove SubagentChangesMerged from rollout policy","description":"In core/src/rollout/policy.rs:\n\nRemove `| EventMsg::SubagentChangesMerged(_)` from the `should_persist_event_msg` function match statement.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T17:49:44.048571959+01:00","updated_at":"2026-01-03T18:08:22.112779699+01:00","closed_at":"2026-01-03T18:08:22.112779699+01:00","dependencies":[{"issue_id":"codex-0d1.9","depends_on_id":"codex-0d1","type":"parent-child","created_at":"2026-01-03T17:49:44.048953166+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0d1.9","depends_on_id":"codex-0d1.6","type":"blocks","created_at":"2026-01-03T17:50:03.6546063+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3","title":"Hybrid git apply --3way for subagent patch merging","description":"## Problem\n\nWhen subagent patches conflict with the parent working directory, the current implementation saves the patch to a file and tells the agent 'patch saved at /path'. This breaks the workflow because the agent can't see or resolve the conflict - it requires manual intervention.\n\n## Solution\n\nImplement a hybrid approach:\n1. Try clean `git apply` first (fast path, covers 90% of cases)\n2. Fall back to `git apply --3way` on failure (leaves conflict markers in files)\n3. Use `git diff --check` to detect whether conflicts exist\n4. Report conflicted files to agent so it can resolve them\n\n## Key Technical Details\n\n- `git apply --3way` exits 1 for BOTH soft failures (conflicts in files) and hard failures (missing base objects)\n- Use `git diff --check` after apply to distinguish: outputs `filename:line: leftover conflict marker`\n- `git status` won't help - files show as Modified, not Unmerged (unlike `git merge`)\n- LLMs excel at resolving `\u003c\u003c\u003c\u003c\u003c\u003c\u003c` markers - much better than asking them to manually apply a patch file\n\n## Files to Modify\n\n- `core/src/worktree_manager.rs`: Update `PatchApplyResult` enum and `apply_patch()` method\n- `core/src/patch_merger.rs`: Handle new `AppliedWithConflicts` variant\n- `core/src/codex.rs`: Update merge result handling to report conflicted files\n- `protocol/src/lib.rs` or `protocol/src/subagent_changes.rs`: May need to update `SubagentChangesStatus`\n\n## Acceptance Criteria\n\n- Clean patches still apply via fast path\n- Conflicting patches leave conflict markers in files instead of saving to patch file\n- Agent receives list of files with conflicts\n- Hard failures (missing base objects) still save patch file as fallback","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-24T00:46:22.858026831+01:00","updated_at":"2025-12-27T14:35:15.037438728+01:00","closed_at":"2025-12-27T14:35:15.037438728+01:00"}
{"id":"codex-0n3.1","title":"Add AppliedWithConflicts variant to PatchApplyResult","description":"## Task\n\nAdd a new variant to `PatchApplyResult` enum in `core/src/worktree_manager.rs`.\n\n## Current enum (around line 60-70)\n\n```rust\npub enum PatchApplyResult {\n    Applied,\n    NoChanges,\n    Conflict { patch_path: PathBuf },\n}\n```\n\n## New enum\n\n```rust\npub enum PatchApplyResult {\n    Applied,\n    NoChanges,\n    AppliedWithConflicts { files: Vec\u003cString\u003e },  // NEW: conflict markers left in files\n    Conflict { patch_path: PathBuf },              // Renamed semantically to 'hard failure'\n}\n```\n\n## Notes\n\n- `AppliedWithConflicts` means the patch was partially applied with `\u003c\u003c\u003c\u003c\u003c\u003c\u003c`/`=======`/`\u003e\u003e\u003e\u003e\u003e\u003e\u003e` conflict markers left in the listed files\n- `Conflict` now means a 'hard failure' where `--3way` couldn't work at all (e.g., missing base objects) and the patch was saved to a file\n- The `files` field should contain the file paths that have conflict markers","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:46:46.125246947+01:00","updated_at":"2025-12-27T14:35:14.946923182+01:00","closed_at":"2025-12-27T14:35:14.946923182+01:00","dependencies":[{"issue_id":"codex-0n3.1","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:46:46.125564665+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3.2","title":"Implement hybrid apply_patch with --3way fallback","description":"## Task\n\nRewrite `apply_patch()` method in `core/src/worktree_manager.rs` to use hybrid approach.\n\n## Current implementation (around line 280-320)\n\n1. `git apply --check` to test\n2. If fails, save patch and return `Conflict`\n3. If passes, `git apply` and return `Applied`\n\n## New implementation\n\n```rust\npub async fn apply_patch(\n    \u0026self,\n    patch: \u0026str,\n    target_dir: \u0026Path,\n    task_id: \u0026str,\n) -\u003e Result\u003cPatchApplyResult\u003e {\n    if patch.trim().is_empty() {\n        return Ok(PatchApplyResult::NoChanges);\n    }\n\n    // Create temp file for patch\n    let patch_file = self.patches_dir.join(format!(\"{task_id}.diff\"));\n    tokio::fs::create_dir_all(\u0026self.patches_dir).await?;\n    tokio::fs::write(\u0026patch_file, patch).await?;\n\n    // 1. Try clean apply first (fast path)\n    let check_output = Command::new(\"git\")\n        .args([\"apply\", \"--check\"])\n        .arg(\u0026patch_file)\n        .current_dir(target_dir)\n        .output()\n        .await\n        .context(\"Failed to check patch\")?;\n\n    if check_output.status.success() {\n        // Clean apply\n        let apply_output = Command::new(\"git\")\n            .arg(\"apply\")\n            .arg(\u0026patch_file)\n            .current_dir(target_dir)\n            .output()\n            .await\n            .context(\"Failed to apply patch\")?;\n\n        if apply_output.status.success() {\n            let _ = tokio::fs::remove_file(\u0026patch_file).await;\n            return Ok(PatchApplyResult::Applied);\n        }\n    }\n\n    // 2. Fall back to 3-way merge\n    let threeway_output = Command::new(\"git\")\n        .args([\"apply\", \"--3way\"])\n        .arg(\u0026patch_file)\n        .current_dir(target_dir)\n        .output()\n        .await\n        .context(\"Failed to apply patch with --3way\")?;\n\n    if threeway_output.status.success() {\n        let _ = tokio::fs::remove_file(\u0026patch_file).await;\n        return Ok(PatchApplyResult::Applied);\n    }\n\n    // 3. Check if we have conflict markers (soft failure) or hard failure\n    let conflicted_files = Self::detect_conflict_markers(target_dir).await?;\n\n    if !conflicted_files.is_empty() {\n        // Soft failure: conflicts left in files for agent to resolve\n        let _ = tokio::fs::remove_file(\u0026patch_file).await;\n        return Ok(PatchApplyResult::AppliedWithConflicts { files: conflicted_files });\n    }\n\n    // 4. Hard failure: save patch file\n    Ok(PatchApplyResult::Conflict { patch_path: patch_file })\n}\n```\n\n## Helper method to add\n\n```rust\n/// Detect files with conflict markers using `git diff --check`\nasync fn detect_conflict_markers(target_dir: \u0026Path) -\u003e Result\u003cVec\u003cString\u003e\u003e {\n    let output = Command::new(\"git\")\n        .args([\"diff\", \"--check\"])\n        .current_dir(target_dir)\n        .output()\n        .await\n        .context(\"Failed to run git diff --check\")?;\n\n    // git diff --check exits non-zero if markers found\n    // Output format: \"filename:line: leftover conflict marker\"\n    let stdout = String::from_utf8_lossy(\u0026output.stdout);\n    \n    let files: Vec\u003cString\u003e = stdout\n        .lines()\n        .filter(|line| line.contains(\"conflict marker\"))\n        .filter_map(|line| line.split(':').next().map(|s| s.to_string()))\n        .collect::\u003cstd::collections::HashSet\u003c_\u003e\u003e()\n        .into_iter()\n        .collect();\n\n    Ok(files)\n}\n```\n\n## Dependencies\n\n- Depends on codex-0n3.1 (PatchApplyResult enum update)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:47:06.204220095+01:00","updated_at":"2025-12-27T14:35:14.972041095+01:00","closed_at":"2025-12-27T14:35:14.972041095+01:00","dependencies":[{"issue_id":"codex-0n3.2","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:47:06.22683701+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0n3.2","depends_on_id":"codex-0n3.1","type":"blocks","created_at":"2025-12-24T00:48:08.772790746+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3.3","title":"Update patch_merger to handle AppliedWithConflicts","description":"## Task\n\nUpdate `merge_pending_patches()` in `core/src/patch_merger.rs` to handle the new `AppliedWithConflicts` variant.\n\n## Current handling (around line 55-95)\n\n```rust\nmatch worktree_manager.apply_patch(...).await {\n    Ok(PatchApplyResult::Applied) =\u003e { ... }\n    Ok(PatchApplyResult::NoChanges) =\u003e { ... }\n    Ok(PatchApplyResult::Conflict { patch_path }) =\u003e { ... }\n    Err(e) =\u003e { ... }\n}\n```\n\n## New handling\n\nAdd a case for `AppliedWithConflicts`:\n\n```rust\nOk(PatchApplyResult::AppliedWithConflicts { files }) =\u003e {\n    let _ = worktree_manager.cleanup(\u0026p.worktree_handle).await;\n    SubagentChanges {\n        status: SubagentChangesStatus::AppliedWithConflicts,\n        files_changed: convert_file_changes(p.diff.files_changed),\n        conflicted_files: Some(files),  // NEW field\n        patch_path: None,\n    }\n}\n```\n\n## Protocol update needed\n\nThe `SubagentChanges` struct in protocol needs a new field:\n- `conflicted_files: Option\u003cVec\u003cString\u003e\u003e`\n\nAnd `SubagentChangesStatus` needs a new variant:\n- `AppliedWithConflicts`\n\nCheck `protocol/src/subagent_changes.rs` or `protocol/src/lib.rs` for these types.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:47:22.9617392+01:00","updated_at":"2025-12-27T14:35:14.988796557+01:00","closed_at":"2025-12-27T14:35:14.988796557+01:00","dependencies":[{"issue_id":"codex-0n3.3","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:47:22.9621314+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0n3.3","depends_on_id":"codex-0n3.2","type":"blocks","created_at":"2025-12-24T00:48:08.793856508+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0n3.3","depends_on_id":"codex-0n3.4","type":"blocks","created_at":"2025-12-24T00:48:08.812648886+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3.4","title":"Update protocol types for AppliedWithConflicts","description":"## Task\n\nUpdate protocol types to support the new `AppliedWithConflicts` status.\n\n## Files to modify\n\nCheck `protocol/src/subagent_changes.rs` or `protocol/src/lib.rs` for these types.\n\n## Changes needed\n\n### 1. SubagentChangesStatus enum\n\nAdd new variant:\n\n```rust\n#[derive(Debug, Clone, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"snake_case\")]\npub enum SubagentChangesStatus {\n    Applied,\n    NoChanges,\n    AppliedWithConflicts,  // NEW\n    Conflict,\n}\n```\n\n### 2. SubagentChanges struct\n\nAdd new field:\n\n```rust\npub struct SubagentChanges {\n    pub status: SubagentChangesStatus,\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    pub conflicted_files: Option\u003cVec\u003cString\u003e\u003e,  // NEW\n    pub patch_path: Option\u003cString\u003e,\n}\n```\n\n## Notes\n\n- `conflicted_files` is `Option` because it's only populated for `AppliedWithConflicts` status\n- Use `#[serde(skip_serializing_if = \"Option::is_none\")]` to keep JSON clean","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:47:32.395700835+01:00","updated_at":"2025-12-27T14:35:15.004838625+01:00","closed_at":"2025-12-27T14:35:15.004838625+01:00","dependencies":[{"issue_id":"codex-0n3.4","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:47:32.396028501+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3.5","title":"Update codex.rs merge result handling for conflicts","description":"## Task\n\nUpdate the merge result handling in `core/src/codex.rs` (around line 2800-2850) to handle `AppliedWithConflicts` and inform the agent about files with conflict markers.\n\n## Current handling\n\n```rust\nmatch result.changes.status {\n    SubagentChangesStatus::Applied =\u003e {\n        // Send AgentMessage about merged files\n    }\n    SubagentChangesStatus::Conflict =\u003e {\n        // Send Warning about patch file location\n    }\n    SubagentChangesStatus::NoChanges =\u003e {}\n}\n```\n\n## New handling\n\nAdd case for `AppliedWithConflicts`:\n\n```rust\nSubagentChangesStatus::AppliedWithConflicts =\u003e {\n    let conflicted = result.changes.conflicted_files.clone().unwrap_or_default();\n    let message = format!(\n        \"Subagent {} changes applied with conflicts in: {}. Please resolve the conflict markers.\",\n        result.subagent_name,\n        conflicted.join(\", \")\n    );\n    sess.send_event(\n        \u0026turn_context,\n        EventMsg::Warning(WarningEvent { message }),\n    )\n    .await;\n}\n```\n\n## Notes\n\n- Use `Warning` event so it's visible to both TUI and agent\n- The message should clearly indicate the agent needs to resolve conflicts\n- Include the file list so agent knows where to look","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:47:43.472201878+01:00","updated_at":"2025-12-27T14:35:15.020759632+01:00","closed_at":"2025-12-27T14:35:15.020759632+01:00","dependencies":[{"issue_id":"codex-0n3.5","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:47:43.472568218+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0n3.5","depends_on_id":"codex-0n3.3","type":"blocks","created_at":"2025-12-24T00:48:08.830320583+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-0n3.6","title":"Add tests for hybrid patch apply","description":"## Task\n\nAdd tests for the new hybrid patch apply behavior in `core/src/worktree_manager.rs`.\n\n## Test cases needed\n\n### 1. test_apply_patch_clean\n- Create a worktree, make changes, generate diff\n- Apply to clean parent directory\n- Assert: `PatchApplyResult::Applied`\n\n### 2. test_apply_patch_with_conflicts\n- Create a worktree, modify file X\n- Modify same lines of file X in parent (create conflict)\n- Apply patch\n- Assert: `PatchApplyResult::AppliedWithConflicts { files }`\n- Assert: `files` contains file X\n- Assert: file X contains `\u003c\u003c\u003c\u003c\u003c\u003c\u003c` markers\n\n### 3. test_apply_patch_hard_failure\n- Create patch referencing non-existent base SHA (or corrupt patch)\n- Apply patch\n- Assert: `PatchApplyResult::Conflict { patch_path }`\n- Assert: patch file exists at `patch_path`\n\n### 4. test_detect_conflict_markers\n- Create file with conflict markers manually\n- Call `detect_conflict_markers()`\n- Assert: returns the file in list\n\n## Notes\n\n- Tests may need to be `#[tokio::test]`\n- May need to create temp git repos for testing\n- Check existing tests in the file for patterns","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T00:47:55.80653692+01:00","updated_at":"2026-01-02T11:47:35.859382195+01:00","closed_at":"2026-01-02T11:47:35.859382195+01:00","dependencies":[{"issue_id":"codex-0n3.6","depends_on_id":"codex-0n3","type":"parent-child","created_at":"2025-12-24T00:47:55.806909943+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-0n3.6","depends_on_id":"codex-0n3.2","type":"blocks","created_at":"2025-12-24T00:48:08.847984544+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-14l","title":"Session-wide change tracking (+heuristics) and /diff summary","description":"Add a session-wide changes tracker that aggregates edits across the root session and all subagent sessions.\n\nUser-visible:\n- Improve existing `/diff` to show three sections:\n  1) Git diff stats-only (per-file +N/-M, no full patch text)\n  2) Authoritative apply_patch edits recorded by Codex (per-file stats + optional unified diff snippet)\n  3) Heuristic/approx potential edits inferred from executed commands\n\nInternal:\n- Tracker must aggregate across subagent events forwarded via EventMsg::SubagentEvent.\n- Compaction must preserve/reflect these changes without parsing subagent tool output strings.\n\nDoD:\n- `/diff` works in non-git dirs and in git repos.\n- Git section is stats-only.\n- Parent session includes apply_patch edits made by subagents.\n- Compaction includes change metadata reliably.\n- Targeted tests cover core tracker + TUI rendering.","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-13T13:05:47.667601273+01:00","updated_at":"2026-01-13T13:10:30.467785395+01:00"}
{"id":"codex-14l.1","title":"Core: session-wide apply_patch change tracker","description":"Implement a session-scoped changes tracker that authoritatively records apply_patch edits across the entire session lifetime.\n\nGrounding:\n- TurnDiffTracker exists: core/src/turn_diff_tracker.rs\n- Patch events emitted in core/src/tools/events.rs (PatchApplyBegin/End + TurnDiff)\n\nScope:\n- New tracker stores baseline-on-first-touch and produces:\n  - unified diff (across all apply_patch edits in session)\n  - per-file stats (insertions/deletions) and changed-file list\n\nDoD:\n- Unit tests cover: multi-edit same file, add/delete/rename(move_path) cases, stable ordering.\n- No reliance on git; works outside repos.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:06:30.357735241+01:00","updated_at":"2026-01-13T13:06:30.357735241+01:00","dependencies":[{"issue_id":"codex-14l.1","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:30.368395934+01:00","created_by":"daemon"}]}
{"id":"codex-14l.10","title":"Port upstream: parse_command mutating xargs heuristic","description":"Port upstream changes that prevent mutating xargs pipelines from being dropped as harmless formatting commands.\n\nGrounding:\n- Upstream commit: 3c8fb90bf0ee58ce4267b35301660817cd029c2a\n- File: core/src/parse_command.rs\n\nDoD:\n- Add upstream unit test keeps_mutating_xargs_pipeline.\n- Existing parse_command tests still pass.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T13:07:12.466792893+01:00","updated_at":"2026-01-13T13:07:12.466792893+01:00","dependencies":[{"issue_id":"codex-14l.10","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:07:12.478767845+01:00","created_by":"daemon"},{"issue_id":"codex-14l.10","depends_on_id":"codex-14l.4","type":"related","created_at":"2026-01-13T13:08:07.57639242+01:00","created_by":"daemon"}]}
{"id":"codex-14l.11","title":"TUI: implement git diff stats-only output","description":"Replace current /diff full patch rendering with per-file stats output.\n\nGrounding:\n- Current implementation: tui/src/get_git_diff.rs (runs git diff --color etc)\n\nScope:\n- Implement git diff stats using `git diff --numstat` for tracked changes.\n- Include untracked files via `git diff --no-index --numstat /dev/null \u003cfile\u003e`.\n- Output format: one line per file with (+N -M). No patch hunks.\n\nDoD:\n- Unit test(s) for get_git_diff stats formatting.\n- /diff remains fast on large diffs.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:10:45.69836067+01:00","updated_at":"2026-01-13T13:10:45.69836067+01:00","dependencies":[{"issue_id":"codex-14l.11","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:10:45.710615467+01:00","created_by":"daemon"}]}
{"id":"codex-14l.2","title":"Core: wire root-session apply_patch events into session tracker","description":"Wire normal (non-subagent) apply_patch execution into the session-wide tracker.\n\nGrounding:\n- PatchApplyBegin/End emitted from core/src/tools/events.rs\n- ApplyPatchHandler: core/src/tools/handlers/apply_patch.rs\n\nDoD:\n- Every successful/failed PatchApplyEnd updates session tracker state consistently.\n- TurnDiffTracker-per-turn behavior remains unchanged.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:06:32.337202206+01:00","updated_at":"2026-01-13T13:06:32.337202206+01:00","dependencies":[{"issue_id":"codex-14l.2","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:32.343870538+01:00","created_by":"daemon"},{"issue_id":"codex-14l.2","depends_on_id":"codex-14l.1","type":"blocks","created_at":"2026-01-13T13:07:56.103415226+01:00","created_by":"daemon"}]}
{"id":"codex-14l.3","title":"Core: wire subagent patch events into session tracker","description":"Ensure apply_patch edits performed inside subagent sessions are recorded in the parent session-wide tracker.\n\nGrounding:\n- Subagent events forwarded in core/src/tools/handlers/task.rs as EventMsg::SubagentEvent(inner=...)\n\nScope:\n- While streaming subagent events, detect PatchApplyBegin/End events (including nested SubagentEvent recursion) and feed them into the parent session tracker.\n\nDoD:\n- Test demonstrates: subagent apply_patch edits appear in the session tracker and surface in /diff.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:06:35.441088901+01:00","updated_at":"2026-01-13T13:12:53.480890639+01:00","dependencies":[{"issue_id":"codex-14l.3","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:35.452954204+01:00","created_by":"daemon"},{"issue_id":"codex-14l.3","depends_on_id":"codex-14l.1","type":"blocks","created_at":"2026-01-13T13:07:56.234196673+01:00","created_by":"daemon"}]}
{"id":"codex-14l.4","title":"Core: heuristics/approx change detection from executed commands","description":"Add a best-effort (non-authoritative) tracker for likely file-modifying commands executed during the session.\n\nGrounding:\n- ExecCommandBegin/End events emitted and forwarded (also via SubagentEvent for subagents)\n- Command safety heuristic exists: core/src/command_safety/is_safe_command.rs\n- Command summarizer exists: core/src/parse_command.rs\n\nScope:\n- Record a list of heuristic \"possible modifications\" with command, cwd, and reason.\n- Intended to be displayed as the third section in /diff.\n\nDoD:\n- Includes obvious cases: redirects (\u003e), sed -i/--in-place, perl -pi, rg --replace, etc.\n- Clearly labeled as approximate.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T13:06:39.42482375+01:00","updated_at":"2026-01-13T13:12:54.437611398+01:00","dependencies":[{"issue_id":"codex-14l.4","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:39.435285343+01:00","created_by":"daemon"}]}
{"id":"codex-14l.5","title":"Protocol+core: add Op/GetSessionChanges and SessionChanges event","description":"Add protocol plumbing so TUI can request current session changes.\n\nScope:\n- protocol/src/protocol.rs: add Op::GetSessionChanges and EventMsg::SessionChanges { ... }\n- Payload should include:\n  - apply_patch section: file list + aggregate stats + optional unified diff string\n  - heuristics section: list of suspected-modification command summaries\n\nDoD:\n- Serialization tests updated/added (protocol crate).\n- Wire format is stable and documented in the issue.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:06:42.284195719+01:00","updated_at":"2026-01-13T13:07:07.882589362+01:00","dependencies":[{"issue_id":"codex-14l.5","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:42.466052298+01:00","created_by":"daemon"}]}
{"id":"codex-14l.6","title":"TUI: update /diff to show git stats + session changes","description":"Update the existing `/diff` command in the TUI.\n\nGrounding:\n- SlashCommand registry: tui/src/slash_command.rs\n- /diff implementation: tui/src/get_git_diff.rs and wiring in tui/src/chatwidget.rs\n\nScope:\n- `/diff` output shows 3 sections:\n  1) Git diff stats-only (per-file +N/-M; do not render full patch)\n  2) Codex apply_patch stats for this session (authoritative)\n  3) Heuristics/approx: suspected file modifications from executed commands\n- Use Op::GetSessionChanges to get sections (2) and (3) from core.\n\nDoD:\n- Snapshot tests updated/added.\n- Works while subagents are running (non-blocking UI).\n- No full diff text is shown.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:06:46.70650591+01:00","updated_at":"2026-01-13T13:10:35.329008444+01:00","dependencies":[{"issue_id":"codex-14l.6","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:46.718390351+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.9","type":"blocks","created_at":"2026-01-13T13:07:59.938642414+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.2","type":"blocks","created_at":"2026-01-13T13:08:00.201042986+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.3","type":"blocks","created_at":"2026-01-13T13:08:00.974143697+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.4","type":"blocks","created_at":"2026-01-13T13:08:01.764060445+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.5","type":"blocks","created_at":"2026-01-13T13:08:02.58585876+01:00","created_by":"daemon"},{"issue_id":"codex-14l.6","depends_on_id":"codex-14l.11","type":"blocks","created_at":"2026-01-13T13:10:51.379172519+01:00","created_by":"daemon"}]}
{"id":"codex-14l.7","title":"Compaction: include session-wide change metadata","description":"Integrate the session-wide changes tracker into compaction so summaries preserve what files were edited during the session.\n\nGrounding:\n- compaction file ops logic: core/src/compact.rs (FileOps + XML block)\n\nScope:\n- Use session tracker as authoritative source for apply_patch_paths (and optionally a heuristic count) when building the summary suffix.\n- Avoid parsing task tool outputs for subagent changes.\n\nDoD:\n- Unit tests cover: compaction includes apply_patch paths even when edits happened only in subagents.\n- Does not regress existing FileOps behavior for read_file/write_file.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T13:06:50.484707277+01:00","updated_at":"2026-01-13T13:06:50.484707277+01:00","dependencies":[{"issue_id":"codex-14l.7","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:50.49632689+01:00","created_by":"daemon"},{"issue_id":"codex-14l.7","depends_on_id":"codex-14l.1","type":"blocks","created_at":"2026-01-13T13:08:03.469038222+01:00","created_by":"daemon"},{"issue_id":"codex-14l.7","depends_on_id":"codex-14l.3","type":"blocks","created_at":"2026-01-13T13:08:04.371546087+01:00","created_by":"daemon"},{"issue_id":"codex-14l.7","depends_on_id":"codex-14l.4","type":"blocks","created_at":"2026-01-13T13:08:05.267444021+01:00","created_by":"daemon"},{"issue_id":"codex-14l.7","depends_on_id":"codex-14l.2","type":"blocks","created_at":"2026-01-13T13:08:55.856647516+01:00","created_by":"daemon"}]}
{"id":"codex-14l.8","title":"Docs: document /diff sections and limitations","description":"Update docs to describe `/diff` output sections:\n1) git stats-only\n2) apply_patch authoritative session tracker\n3) heuristics/approx\n\nDoD:\n- docs updated with usage examples and caveats.","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-13T13:06:53.441736981+01:00","updated_at":"2026-01-13T13:10:37.595401035+01:00","dependencies":[{"issue_id":"codex-14l.8","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:06:53.45388815+01:00","created_by":"daemon"},{"issue_id":"codex-14l.8","depends_on_id":"codex-14l.6","type":"blocks","created_at":"2026-01-13T13:08:06.160304316+01:00","created_by":"daemon"}]}
{"id":"codex-14l.9","title":"Core: implement Op::GetSessionChanges handler","description":"Implement the core-side handling for Op::GetSessionChanges.\n\nGrounding:\n- Op enum lives in protocol/src/protocol.rs\n- Ops are handled in core session loop (core/src/codex.rs)\n\nScope:\n- On request, read session-wide trackers and emit EventMsg::SessionChanges.\n- Must include both sections (apply_patch authoritative + heuristics).\n\nDoD:\n- Unit/integration test validates Op -\u003e EventMsg round-trip.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-13T13:07:09.841881567+01:00","updated_at":"2026-01-13T13:07:09.841881567+01:00","dependencies":[{"issue_id":"codex-14l.9","depends_on_id":"codex-14l","type":"parent-child","created_at":"2026-01-13T13:07:09.853949246+01:00","created_by":"daemon"},{"issue_id":"codex-14l.9","depends_on_id":"codex-14l.5","type":"blocks","created_at":"2026-01-13T13:07:56.709232784+01:00","created_by":"daemon"},{"issue_id":"codex-14l.9","depends_on_id":"codex-14l.1","type":"blocks","created_at":"2026-01-13T13:07:57.182014021+01:00","created_by":"daemon"},{"issue_id":"codex-14l.9","depends_on_id":"codex-14l.4","type":"blocks","created_at":"2026-01-13T13:07:58.110999226+01:00","created_by":"daemon"},{"issue_id":"codex-14l.9","depends_on_id":"codex-14l.2","type":"blocks","created_at":"2026-01-13T13:08:55.988066038+01:00","created_by":"daemon"},{"issue_id":"codex-14l.9","depends_on_id":"codex-14l.3","type":"blocks","created_at":"2026-01-13T13:08:56.658750497+01:00","created_by":"daemon"}]}
{"id":"codex-16t","title":"Context overflow protection for handoff","description":"## Goal\nImplement Head+Tail truncation to prevent context overflow during handoff extraction.\n\n## Implementation\nIn core/src/tasks/handoff.rs, before building the extraction prompt:\n1. Estimate token count of history\n2. If exceeds model limit, truncate keeping first + recent messages\n3. Insert placeholder for omitted content\n\n## Code Pattern\n```rust\n// After getting history, before building prompt\nlet model_window = 128_000; // or get from model info\nlet budget = model_window.saturating_sub(8000); // reserve for prompt+response\n\nlet current_estimate = history.iter()\n    .map(|item| approx_token_count(\u0026serde_json::to_string(item).unwrap_or_default()))\n    .sum::\u003cusize\u003e();\n\nif current_estimate \u003e budget {\n    // Keep first message (original goal)\n    // Keep recent messages that fit\n    // Insert [... N messages omitted ...] placeholder\n}\n```\n\n## Files to modify\n- core/src/tasks/handoff.rs - add truncation logic in run method","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T01:46:52.917600737+01:00","updated_at":"2025-12-22T23:37:54.295374096+01:00","closed_at":"2025-12-22T23:37:54.295374096+01:00"}
{"id":"codex-1md","title":"E2E test coverage for subagent prompts","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-11T14:29:22.895359705+01:00","updated_at":"2026-01-11T14:29:22.895359705+01:00"}
{"id":"codex-1md.1","title":"Test: subagent system_prompt appears in API request","description":"Create integration test that:\n1. Sets up MockServer with two SSE endpoints (parent + subagent)\n2. Parent response triggers task tool call for 'finder' subagent\n3. Capture subagent's outbound API request\n4. Assert developer_instructions contains finder.md system_prompt content\n\nFiles:\n- Add test to: core/tests/suite/client.rs\n- Use helpers from: core/tests/common/responses.rs\n- Reference: includes_developer_instructions_message_in_request (line 1020)\n- Subagent template: core/templates/subagents/finder.md\n\nDoD:\n- Test passes with cargo test -p codex-core\n- Verifies exact system_prompt text appears in request body\n- Uses ResponseMock.requests() to capture both parent and subagent calls","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T14:29:26.958729857+01:00","updated_at":"2026-01-11T21:18:47.795968397+01:00","closed_at":"2026-01-11T21:18:47.795968397+01:00","close_reason":"Implemented subagent system_prompt request assertion","dependencies":[{"issue_id":"codex-1md.1","depends_on_id":"codex-1md","type":"parent-child","created_at":"2026-01-11T14:29:26.967607252+01:00","created_by":"daemon"}]}
{"id":"codex-1md.2","title":"Test: subagent identity_prompt includes parent session ID","description":"Create integration test that verifies the subagent_identity_prompt() output appears in subagent API requests.\n\nVerify:\n- '# Subagent Context' header present\n- 'Parent session ID: {uuid}' with valid parent session ID\n- 'You are a specialized subagent' text present\n\nFiles:\n- core/tests/suite/client.rs\n- Reference: subagent_identity_prompt in core/src/tools/handlers/task.rs:1-12\n\nDoD:\n- Test verifies identity prompt structure in developer_instructions\n- Parent session ID is a valid UUID format","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T14:29:28.065240674+01:00","updated_at":"2026-01-11T21:18:51.692213294+01:00","closed_at":"2026-01-11T21:18:51.692213294+01:00","close_reason":"Verified subagent identity prompt includes parent session UUID","dependencies":[{"issue_id":"codex-1md.2","depends_on_id":"codex-1md","type":"parent-child","created_at":"2026-01-11T14:29:28.075291988+01:00","created_by":"daemon"}]}
{"id":"codex-1md.3","title":"Test: empty system_prompt still includes identity_prompt","description":"Create test for subagent with frontmatter-only (no markdown body).\n\nScenario:\n- Create temp subagent with empty system_prompt\n- Spawn it via task tool\n- Verify identity_prompt is still injected as developer_instructions\n\nReference:\n- loads_agent_with_frontmatter_only test in core/src/subagents.rs:601\n\nDoD:\n- Test passes when system_prompt is empty string\n- identity_prompt still appears in API request","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T14:29:29.119515136+01:00","updated_at":"2026-01-11T21:18:55.795147886+01:00","closed_at":"2026-01-11T21:18:55.795147886+01:00","close_reason":"Added frontmatter-only subagent test ensuring identity prompt injection","dependencies":[{"issue_id":"codex-1md.3","depends_on_id":"codex-1md","type":"parent-child","created_at":"2026-01-11T14:29:29.131492604+01:00","created_by":"daemon"}]}
{"id":"codex-1md.4","title":"Test: developer_instructions accumulate across delegation levels","description":"Create test for nested subagent delegation (parent → child → grandchild).\n\nVerify:\n- Child's developer_instructions includes parent identity\n- Grandchild's developer_instructions includes both parent and child context\n- Instructions accumulate via format!('{existing}\\n\\n{developer_prefix}')\n\nFiles:\n- core/src/tools/handlers/task.rs:364-366 (accumulation logic)\n\nDoD:\n- Test with 2+ levels of delegation\n- Verify no instructions are lost in chain","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T14:29:30.29019699+01:00","updated_at":"2026-01-12T03:02:14.758830118+01:00","closed_at":"2026-01-12T03:02:14.758830118+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-1md.4","depends_on_id":"codex-1md","type":"parent-child","created_at":"2026-01-11T14:29:30.302109366+01:00","created_by":"daemon"}]}
{"id":"codex-2kx","title":"Epic: Simplify delegation architecture - eliminate Commands","description":"Commands are a redundant hybrid that overlaps with Prompts (text expansion) and Subagents (delegated execution). Consolidate into just two primitives: Prompts and Subagents.\n\nCurrent state:\n- Simple Commands = text expansion → same as Prompts\n- Commands with agent = pre-canned subagent calls → redundant with @agent\n- Commands with profile = ad-hoc agents → should be proper agent definitions\n\nTarget state:\n- Prompts (~/.codex/prompts/*.md): Text templates/macros, become user messages\n- Subagents (~/.codex/agents/*.md): Delegated work with separate context\n\nBenefits:\n- Single delegation path (cleaner code)\n- Clear user mental model\n- ~500+ lines of code removed\n- No more confusing overlap","status":"open","priority":1,"issue_type":"epic","created_at":"2026-01-05T14:43:19.129864847+01:00","updated_at":"2026-01-05T14:43:19.129864847+01:00"}
{"id":"codex-2kx.1","title":"Audit existing commands and categorize","description":"Scan ~/.codex/commands/ (both default and user) and categorize each:\n- Simple (no frontmatter) → will become prompts\n- With agent → document which agent, consider if needed\n- With profile → document which profile, consider converting to agent\n\nCreate migration plan document listing each command and its target.","notes":"AUDIT COMPLETE:\n\n**User's Commands (~/.codex/commands/):**\n1. commit.md - HAS profile: zai → needs conversion to subagent\n2. test.md - NO profile/agent (just $ARGUMENTS) → simple prompt\n\n**User's Prompts (~/.codex/prompts/):**\n- apex2.md, first_principles.md, grok.md, orchestrate.md\n\n**Codebase Files to Modify:**\n\nPROTOCOL LAYER:\n- protocol/src/custom_commands.rs (CustomCommand struct, COMMANDS_CMD_PREFIX)\n- protocol/src/protocol.rs (ListCommandsResponse, imports)\n- protocol/src/lib.rs (re-export)\n\nCORE LAYER:\n- core/src/custom_commands.rs (discovery, validation)\n- core/src/tasks/command_delegate.rs (CommandDelegateTask - DELETE)\n- core/src/codex.rs (Op::DelegateCommand handler, list_commands)\n- core/src/lib.rs (re-export)\n\nTUI LAYER:\n- tui/src/bottom_pane/chat_composer.rs (InputResult::DelegateCommand, expansion)\n- tui/src/bottom_pane/command_popup.rs (CommandItem::UserCommand)\n- tui/src/bottom_pane/prompt_args.rs (expand_custom_command)\n- tui/src/bottom_pane/mod.rs (set_custom_commands)\n- tui/src/chatwidget.rs (on_list_commands, set_custom_commands)\n- tui/src/app.rs (AppEvent::SubmitCommand)\n- tui/src/app_event.rs (SubmitCommand variant)\n\nTESTS:\n- core/tests/suite/command_delegate_instructions.rs (DELETE)\n\nDOCS:\n- docs/custom_commands.md (UPDATE or DELETE)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T14:43:57.797272519+01:00","updated_at":"2026-01-05T15:04:16.210393498+01:00","closed_at":"2026-01-05T15:04:16.210393498+01:00","dependencies":[{"issue_id":"codex-2kx.1","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:43:57.797676349+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.2","title":"Merge simple commands into prompts","description":"For commands without profile/agent:\n1. Move files from commands/ to prompts/ (or merge content)\n2. Update any references in code\n3. Test that /prompts:name works same as /commands:name did\n\nNote: After recent fix, simple commands already behave like prompts (InputResult::Submitted). This task is about eliminating the separate directory/namespace.","notes":"SKIP: After the InputResult::Submitted fix, simple commands already work as prompts. User can manually move files from commands/ to prompts/ if desired. No code changes needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T14:44:02.009281014+01:00","updated_at":"2026-01-05T15:05:40.881365057+01:00","closed_at":"2026-01-05T15:05:40.881365057+01:00","dependencies":[{"issue_id":"codex-2kx.2","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:02.009601556+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.2","depends_on_id":"codex-2kx.1","type":"blocks","created_at":"2026-01-05T14:45:00.289303453+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.3","title":"Convert commands with agent/profile to proper subagents","description":"For each command with agent: or profile: frontmatter:\n1. Create equivalent agent definition in agents/\n2. For profile-only commands: create agent that uses that profile\n3. The command body becomes part of the agent's system prompt or initial instruction\n4. Test @agent invocation works same as /commands:name did","notes":"SKIP: commit.md is a user file, not codebase code. User can create @commit agent manually if desired. The code deletion in task 4 will remove profile support from commands entirely.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T14:44:04.476454953+01:00","updated_at":"2026-01-05T15:05:44.391894063+01:00","closed_at":"2026-01-05T15:05:44.391894063+01:00","dependencies":[{"issue_id":"codex-2kx.3","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:04.47685155+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.3","depends_on_id":"codex-2kx.1","type":"blocks","created_at":"2026-01-05T14:45:00.306539372+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.4","title":"Delete CommandDelegateTask and Op::DelegateCommand","description":"Remove delegation code path for commands:\n- Delete core/src/tasks/command_delegate.rs\n- Remove Op::DelegateCommand from protocol\n- Remove CommandDelegateTask from tasks/mod.rs\n- Update codex.rs handler to not match on DelegateCommand\n- Remove InputResult::DelegateCommand variant (or repurpose for @agent only)\n\nThis is the core cleanup - removes ~300 lines of redundant code.","notes":"REVISED PLAN based on user feedback:\n\nTwo primitives only:\n1. Prompts (/prompts:foo) - text expansion → user message  \n2. Agents (@agent) - delegation → Op::DelegateSubagent\n\nComposition: @agent /prompts:foo expands prompt first, then delegates\n\nChanges:\n1. Remove Op::DelegateCommand, use Op::DelegateSubagent for @agent\n2. Delete CommandDelegateTask entirely\n3. Remove profile from delegation path\n4. TUI: @agent parses rest, expands any /prompts: in it, then delegates\n5. Remove InputResult::DelegateCommand, add InputResult::DelegateAgent\n6. Remove AppEvent::SubmitCommand, add AppEvent::DelegateAgent","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T14:44:08.150865575+01:00","updated_at":"2026-01-05T16:25:00.427023309+01:00","closed_at":"2026-01-05T16:25:00.427023309+01:00","dependencies":[{"issue_id":"codex-2kx.4","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:08.151282701+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.4","depends_on_id":"codex-2kx.2","type":"blocks","created_at":"2026-01-05T14:45:01.442066322+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.4","depends_on_id":"codex-2kx.3","type":"blocks","created_at":"2026-01-05T14:45:01.458036435+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.5","title":"Remove CustomCommand struct and commands discovery","description":"Remove commands infrastructure:\n- Delete protocol/src/custom_commands.rs (or merge needed parts into prompts)\n- Remove core/src/custom_commands.rs discovery logic\n- Remove COMMANDS_CMD_PREFIX constant\n- Remove ListCommandsResponse event\n- Update TUI command popup to not show commands section\n- Remove set_custom_commands from composer/bottom_pane","acceptance_criteria":"DoD:\n- protocol: remove CustomCommand + ListCommands op/response + COMMANDS_CMD_PREFIX\n- core: remove commands discovery/validation and any ListCommands handling\n- tui: remove /commands section from popup and any expansion logic\n- docs: remove/update custom_commands docs\n- cargo check --bin codex passes; cargo test -p codex-core and cargo test -p codex-tui pass","notes":"DECISION: Remove custom commands completely. Keep only /prompts for text expansion and @agent for delegation. Any convenience aliases should be implemented as prompts or documented usage patterns.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-05T14:44:11.361129813+01:00","updated_at":"2026-01-12T16:23:53.404032951+01:00","closed_at":"2026-01-12T16:23:53.404032951+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-2kx.5","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:11.361491313+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.5","depends_on_id":"codex-2kx.4","type":"blocks","created_at":"2026-01-05T14:45:02.38860166+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.6","title":"Update TUI to use unified prompt/agent model","description":"Simplify TUI slash command handling:\n- command_popup.rs: remove commands section, keep prompts + builtins\n- chat_composer.rs: remove command-specific expansion paths\n- Remove CommandItem::UserCommand variant\n- Simplify prompt_args.rs (remove command expansion functions)\n\nAfter this, slash popup shows: builtins + prompts\nAgent invocation is via @agent syntax only","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T14:44:15.265370684+01:00","updated_at":"2026-01-12T16:23:54.231790786+01:00","closed_at":"2026-01-12T16:23:54.231790786+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-2kx.6","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:15.265972973+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.6","depends_on_id":"codex-2kx.5","type":"blocks","created_at":"2026-01-05T14:45:02.404604767+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2kx.7","title":"Update documentation for simplified model","description":"Update docs to reflect new architecture:\n- Remove references to commands/\n- Document prompts/ as the only text template location\n- Document @agent as the way to invoke subagents\n- Update any migration guides for users with existing commands","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-05T14:44:17.899333495+01:00","updated_at":"2026-01-05T14:44:17.899333495+01:00","dependencies":[{"issue_id":"codex-2kx.7","depends_on_id":"codex-2kx","type":"parent-child","created_at":"2026-01-05T14:44:17.899654598+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-2kx.7","depends_on_id":"codex-2kx.6","type":"blocks","created_at":"2026-01-05T14:45:03.118703415+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-2qn","title":"Inject parallel constraints when spawning multiple workers","description":"When a single model response spawns multiple task workers (multiple tool calls to name=\"task\"), inject a \"Parallel Execution Constraints\" snippet into each worker context so workers avoid overlapping writes and understand they are running concurrently.","acceptance_criteria":"- If a response contains \u003e=2 tool calls to \"task\", each spawned worker context includes a \"Parallel Execution Constraints\" section.\n- If a response contains exactly 1 tool call to \"task\", the section is omitted.\n- Counting is based on the current response tool call batch (not lifetime).\n- Unit tests cover the counting + injection behavior.\n- cargo test -p codex-core passes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-14T01:15:24.76675236+01:00","updated_at":"2026-01-14T01:26:06.157666668+01:00","closed_at":"2026-01-14T01:26:06.157666668+01:00","close_reason":"Implemented conditional Parallel Execution Constraints injection","dependencies":[{"issue_id":"codex-2qn","depends_on_id":"codex-jq3","type":"discovered-from","created_at":"2026-01-14T01:15:24.775842818+01:00","created_by":"daemon"}]}
{"id":"codex-2qq","title":"Notify parent agent when subagent patch merge fails","description":"When a subagent's changes fail to merge (e.g., git worktree conflicts), the parent agent receives NO notification about the failure. The parent continues as if the work was done successfully.\n\nCurrent behavior:\n- Subagent completes work\n- Merge fails silently  \n- Parent agent is unaware\n- User has to manually inform parent about the failure\n\nExpected behavior:\n- When merge fails, emit an event to parent agent\n- Event should include: subagent name, task description, failure reason, path to saved patch\n- Parent agent can then decide to retry, apply manually, or inform user\n\nRelated: The merge message shows '⚠ Subagent rush changes could not be merged. Patch saved to: ...' but this is only displayed to user, not sent to the agent.\n\nFiles to investigate:\n- core/src/tasks/ - subagent task handling\n- tui/src/chatwidget.rs - SubagentChangesMerged event handling","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T12:15:59.086105862+01:00","updated_at":"2025-12-27T14:35:15.053613781+01:00","closed_at":"2025-12-27T14:35:15.053613781+01:00"}
{"id":"codex-2rr","title":"Match upstream: UnifiedExec default behavior","description":"Fix fork drift so UnifiedExec matches upstream defaults.\\n\\nDoD:\\n- Feature::UnifiedExec is Beta and default_enabled=false (no longer forces unified exec for all models).\\n- ToolsConfig only forces UnifiedExec when the feature is enabled; otherwise uses model shell_type.\\n- When forcing UnifiedExec, fallback to ShellCommand on Windows when ConPTY unsupported (no panics).\\n- cargo check --bin codex passes; cargo test -p codex-core passes.","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-12T16:35:39.050206931+01:00","updated_at":"2026-01-12T16:57:25.370066818+01:00","closed_at":"2026-01-12T16:57:25.370066818+01:00","close_reason":"Completed"}
{"id":"codex-36x","title":"Fix OpenAI GPT-5.x dash model aliases breaking strict subagents","description":"Subagents configured with OpenAI canonical models like 'openai/gpt-5-2' (dash) are treated as non-strict and/or use an unsupported model slug, causing delegation failures (e.g. 'Instructions are not valid' or 'gpt-5-2 not supported'). Normalize known GPT-5.x dash aliases to the dotted form (gpt-5.2) consistently for config + subagent model resolution.","acceptance_criteria":"DoD:\n- Canonical model parsing/resolution normalizes 'openai/gpt-5-1*' and 'openai/gpt-5-2*' dash variants to dotted ('gpt-5.1*'/'gpt-5.2*') before ModelFamily selection and API calls.\n- Delegation to @general works when general.md uses 'openai/gpt-5-2' under an OpenAI API-key setup.\n- Unit tests cover normalization (dash -\u003e dot) and ensure non-GPT-5 models like 'gpt-4-0125-preview' are NOT rewritten.\n- cargo check --bin codex passes; cargo test -p codex-core passes.","status":"closed","issue_type":"bug","created_at":"2026-01-12T22:01:01.480588495+01:00","updated_at":"2026-01-12T22:25:54.054487259+01:00","closed_at":"2026-01-12T22:25:54.054487259+01:00","close_reason":"Not pursuing in-code change; fix applied by correcting ~/.codex/agents/general.md model slug"}
{"id":"codex-3qi","title":"Subagents: update templates and local agent files to model/reasoning_effort; remove unused core/agents","description":"Update built-in subagent templates to include reasoning_effort and ensure local ~/.codex/agents/*.md use model: {provider}/{model} (no profile). Remove unused duplicate subagent markdown files under codex-rs/core/agents.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T14:33:30.259848843+01:00","updated_at":"2026-01-11T14:36:24.237534159+01:00","closed_at":"2026-01-11T14:36:24.237534159+01:00","close_reason":"Updated built-in subagent templates to include reasoning_effort; migrated ~/.codex/agents from profile-\u003emodel; removed unused codex-rs/core/agents/*.md"}
{"id":"codex-3x8","title":"LoopDetector: Reset state on pending user input","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T01:22:10.399718376+01:00","updated_at":"2025-12-31T01:49:31.282357859+01:00","closed_at":"2025-12-31T01:49:31.282357859+01:00","dependencies":[{"issue_id":"codex-3x8","depends_on_id":"codex-45c","type":"discovered-from","created_at":"2025-12-31T01:22:10.401826771+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt","title":"Epic: Upstream Backports (Dec 2025)","description":"Backport important fixes and features from upstream since last merge (3e81ed4b9, 2025-12-12).\n\n## Priority Fixes\n- PTY race condition\n- Session Arc leak (Drop not triggered)\n- More safe commands\n- Parallel tool calls fix\n\n## Unified Exec\n- Make unified_exec default (remove experimental flag)\n- Port session pruning fix\n- Port close-at-end-of-turn fix\n- Port UI improvements (footer, waiting collapse)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-04T13:59:55.01732977+01:00","updated_at":"2026-01-04T15:31:44.035728279+01:00","closed_at":"2026-01-04T15:31:44.035728279+01:00"}
{"id":"codex-3yt.1","title":"Port: PTY race on rx subscription (f152b16ed)","description":"## Upstream\nCommit: f152b16ed9ead49541bd12d976b590cdbd2938e5\nPR: #7921\n\n## Problem\nRace condition where PTY sends first chunk before broadcast subscription is established.\n\n## Fix\nSubscribe to broadcast BEFORE starting the reader thread.\n\n## File\n`utils/pty/src/lib.rs`\n\n## Changes\n1. Add `initial_output_rx` parameter to `ExecCommandSession::new()`\n2. Subscribe before spawning reader thread in `spawn_pty_process()`\n\n## Diff\n```rust\n// Before spawning reader thread:\nlet (output_tx, _) = broadcast::channel::\u003cVec\u003cu8\u003e\u003e(256);\n+// Subscribe before starting the reader thread.\n+let initial_output_rx = output_tx.subscribe();\n\n// Pass to ExecCommandSession::new()\n-let (session, output_rx) = ExecCommandSession::new(writer_tx, output_tx, ...);\n+let (session, output_rx) = ExecCommandSession::new(writer_tx, output_tx, initial_output_rx, ...);\n```\n\n## Tests\nRun `cargo test -p codex-utils-pty`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:00:09.348678995+01:00","updated_at":"2026-01-04T14:29:49.430584376+01:00","closed_at":"2026-01-04T14:29:49.430584376+01:00","dependencies":[{"issue_id":"codex-3yt.1","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:00:09.349188958+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.2","title":"Port: Session Arc leak fix (167553f00)","description":"## Upstream\nCommit: 167553f00dc7379a0d4d54007c90cf191ed7d2f3\nPR: #8196\n\n## Problem\nTokio task holds Arc\u003cSession\u003e, preventing Drop from being called. Results in:\n- Temporary files not cleaned up\n- Shell snapshots not deleted\n- Session cleaning skipped on /new\n\n## Root Cause\nSkills update notification task owns Arc\u003cSession\u003e. Task only exits when broadcast channel closes, but channel only closes when Session drops. Circular dependency.\n\n## Fix\nUse Weak\u003cSession\u003e instead of Arc, upgrade on-demand.\n\n## File\n`core/src/codex.rs`\n\n## Changes\n```rust\n// Around line 738 in subscribe_skills_update_notifications\n-let sess = Arc::clone(\u0026sess);\n+let sess = Arc::downgrade(\u0026sess);\ntokio::spawn(async move {\n    loop {\n        match rx.recv().await {\n            Ok(()) =\u003e {\n+               let Some(sess) = sess.upgrade() else {\n+                   break;\n+               };\n                let turn_context = sess.new_default_turn().await;\n                // ...\n            }\n        }\n    }\n});\n```\n\n## Tests\nPort test from `core/tests/suite/shell_snapshot.rs`:\n- `shell_snapshot_deleted_after_shutdown_with_skills_enabled`\n\nRun `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:00:23.462023714+01:00","updated_at":"2026-01-04T14:29:49.447500627+01:00","closed_at":"2026-01-04T14:29:49.447500627+01:00","dependencies":[{"issue_id":"codex-3yt.2","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:00:23.462363622+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.3","title":"Port: More safe commands (49bf49c2f)","description":"## Upstream\nCommit: 49bf49c2faf9daef0a1834c02d648d5c25ca09f0\nPR: #7728\n\n## Description\nExpand safe command allowlist with more read-only utilities.\n\n## File\n`core/src/command_safety/is_safe_command.rs`\n\n## New Safe Commands\n- `cut`, `expr`, `id`, `paste`, `rev`, `seq`, `stat`, `tr`, `uname`, `uniq`, `whoami`\n- `base64` (without -o/--output flags)\n- Linux-only: `numfmt`, `tac`\n\n## Implementation\n1. Add new commands to the match arm (around line 50)\n2. Add `base64` handler that checks for unsafe output flags\n3. Add tests for new commands\n\n## Tests to Port\n- `known_safe_examples` - add base64, numfmt, tac\n- `base64_output_options_are_unsafe` - new test\n\nRun `cargo test -p codex-core is_safe_command`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:00:36.45373957+01:00","updated_at":"2026-01-04T14:29:49.464833494+01:00","closed_at":"2026-01-04T14:29:49.464833494+01:00","dependencies":[{"issue_id":"codex-3yt.3","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:00:36.454125586+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.4","title":"Port: Parallel tool calls TurnDiff fix (d802b1871)","description":"## Upstream\nCommit: d802b187167b9ccdd709d063a0885cad98f9621f\nPR: #7956\n\n## Problem\nTurnDiff event emitted before all parallel tool calls complete. The unified diff may be incomplete.\n\n## Root Cause\nTurnDiff was emitted inside the response_completed handler, before `drain_in_flight()` finished processing remaining tool futures.\n\n## Fix\nMove TurnDiff emission AFTER drain_in_flight completes.\n\n## File\n`core/src/codex.rs`\n\n## Changes\n```rust\n// Add flag before the loop\n+let mut should_emit_turn_diff = false;\n\n// In ResponseEvent::ResponseCompleted handler (remove diff emission):\n-let unified_diff = {\n-    let mut tracker = turn_diff_tracker.lock().await;\n-    tracker.get_unified_diff()\n-};\n-if let Ok(Some(unified_diff)) = unified_diff {\n-    let msg = EventMsg::TurnDiff(TurnDiffEvent { unified_diff });\n-    sess.send_event(\u0026turn_context, msg).await;\n-}\n+should_emit_turn_diff = true;\n\n// After drain_in_flight (add diff emission):\ndrain_in_flight(\u0026mut in_flight, sess.clone(), turn_context.clone()).await?;\n\n+if should_emit_turn_diff {\n+    let unified_diff = {\n+        let mut tracker = turn_diff_tracker.lock().await;\n+        tracker.get_unified_diff()\n+    };\n+    if let Ok(Some(unified_diff)) = unified_diff {\n+        let msg = EventMsg::TurnDiff(TurnDiffEvent { unified_diff });\n+        sess.send_event(\u0026turn_context, msg).await;\n+    }\n+}\n```\n\n## Tests\nPort streaming tests from `core/tests/suite/tool_parallelism.rs`\n\nRun `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:00:54.236661866+01:00","updated_at":"2026-01-04T14:29:49.481664292+01:00","closed_at":"2026-01-04T14:29:49.481664292+01:00","dependencies":[{"issue_id":"codex-3yt.4","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:00:54.237001393+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.5","title":"Enable unified_exec by default","description":"## Goal\nMake unified_exec the default shell tool (not experimental).\n\n## Changes\n\n### 1. Change feature stage and default\nFile: `core/src/features.rs`\n\n```rust\nFeatureSpec {\n    id: Feature::UnifiedExec,\n    key: \"unified_exec\",\n-   stage: Stage::Experimental,\n-   default_enabled: false,\n+   stage: Stage::Stable,\n+   default_enabled: true,\n},\n```\n\n### 2. Update tool selection logic (if needed)\nFile: `core/src/tools/spec.rs`\n\nThe existing logic already handles this:\n```rust\nlet shell_type = if !features.enabled(Feature::ShellTool) {\n    ConfigShellToolType::Disabled\n} else if features.enabled(Feature::UnifiedExec) {\n    if codex_utils_pty::conpty_supported() {\n        ConfigShellToolType::UnifiedExec\n    } else {\n        ConfigShellToolType::ShellCommand  // fallback\n    }\n} else {\n    model_family.shell_type\n};\n```\n\n## Verification\n1. Start codex without any flags\n2. Run a shell command\n3. Verify it uses PTY (interactive terminal, not simple exec)\n4. Check `lsof` for PTY file descriptors\n\n## Tests\nRun `cargo test -p codex-core` - update any tests that assume unified_exec is off by default","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:01:10.592300998+01:00","updated_at":"2026-01-04T14:35:41.941119187+01:00","closed_at":"2026-01-04T14:35:41.941119187+01:00","dependencies":[{"issue_id":"codex-3yt.5","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:01:10.592630487+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-3yt.5","depends_on_id":"codex-3yt.6","type":"blocks","created_at":"2026-01-04T14:02:07.987488721+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-3yt.5","depends_on_id":"codex-3yt.7","type":"blocks","created_at":"2026-01-04T14:02:08.002969789+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.6","title":"Port: Close unified_exec sessions at end of turn (ae57e1894)","description":"## Upstream\nCommit: ae57e18947e5f9c00ced62e71d3be1e8a79278e7\nPR: #8052\n\n## Problem\nLong-running commands (e.g., `docker compose logs --follow`) never detach, blocking the session indefinitely. Issue #5948.\n\n## Solution\nAutomatically close all unified_exec sessions at the end of each turn.\n\n## File\n`core/src/tasks/mod.rs`\n\n## Implementation\n\n### 1. Add helper method to Session\n```rust\nasync fn close_unified_exec_sessions(\u0026self) {\n    self.services\n        .unified_exec_manager\n        .terminate_all_sessions()\n        .await;\n}\n```\n\n### 2. Call on turn abort (in abort_running_tasks)\n```rust\npub async fn abort_running_tasks(\u0026self, reason: TurnAbortReason) {\n    for task in self.take_all_running_tasks().await {\n        self.handle_task_abort(task, reason.clone()).await;\n    }\n+   self.close_unified_exec_sessions().await;\n}\n```\n\n### 3. Call on turn finish (in on_task_finished)\n```rust\npub async fn on_task_finished(...) {\n    let mut active = self.active_turn.lock().await;\n-   if let Some(at) = active.as_mut() \u0026\u0026 at.remove_task(\u0026turn_context.sub_id) {\n-       *active = None;\n-   }\n+   let should_close = if let Some(at) = active.as_mut()\n+       \u0026\u0026 at.remove_task(\u0026turn_context.sub_id)\n+   {\n+       *active = None;\n+       true\n+   } else {\n+       false\n+   };\n    drop(active);\n+   if should_close {\n+       self.close_unified_exec_sessions().await;\n+   }\n    // ... rest of method\n}\n```\n\n### 4. Ensure terminate_all_sessions exists\nCheck `core/src/unified_exec/session_manager.rs` has:\n```rust\npub async fn terminate_all_sessions(\u0026self) {\n    // Kill all PTY sessions, clean up resources\n}\n```\n\n## Tests to Port\nFrom `core/tests/suite/unified_exec.rs`:\n- Test that long-running process is killed when turn ends\n- Test that session cleanup happens on abort\n\nAlso port helper from `core/tests/common/process.rs`:\n- `wait_for_pid_file()`\n- `process_is_alive()`\n\n## Verification\n1. Start codex with unified_exec enabled\n2. Run `sleep 999` via agent\n3. Complete turn (agent finishes speaking)\n4. Verify sleep process is terminated","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T14:01:24.564697854+01:00","updated_at":"2026-01-04T14:35:41.959216932+01:00","closed_at":"2026-01-04T14:35:41.959216932+01:00","dependencies":[{"issue_id":"codex-3yt.6","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:01:24.565043944+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.7","title":"Port: Unified exec session pruning (b2cddec3d)","description":"## Upstream\nCommit: b2cddec3d77887135eb75edada70ae85b804d071\nPR: #7239\n\n## Problem\nunified_exec leaks TTY file descriptors. Sessions stored even after child exits, PTY FDs stay open. Eventually exhausts FD limit (~64 sessions). Issue #7245.\n\n## Solution\nLRU pruning strategy - remove oldest exited sessions first, then oldest running.\n\n## Files\n- `core/src/unified_exec/mod.rs` - add constant, add `last_used` field\n- `core/src/unified_exec/session_manager.rs` - pruning logic\n\n## Implementation\n\n### 1. Add constant in mod.rs\n```rust\npub(crate) const MAX_UNIFIED_EXEC_SESSIONS: usize = 64;\n```\n\n### 2. Add last_used to SessionEntry in mod.rs\n```rust\nstruct SessionEntry {\n    // ... existing fields\n+   last_used: tokio::time::Instant,\n}\n```\n\n### 3. Update last_used on session access\nIn `prepare_session_handles()`:\n```rust\nlet mut sessions = self.sessions.lock().await;\nlet entry = sessions.get_mut(\u0026session_id)...;\n+entry.last_used = Instant::now();\n```\n\n### 4. Add pruning in store_session()\n```rust\nfn store_session(...) {\n    let entry = SessionEntry {\n        // ...\n        started_at,\n+       last_used: started_at,\n    };\n    let mut sessions = self.sessions.lock().await;\n+   Self::prune_sessions_if_needed(\u0026mut sessions);\n    sessions.insert(session_id, entry);\n}\n```\n\n### 5. Add pruning methods\n```rust\nfn prune_sessions_if_needed(sessions: \u0026mut HashMap\u003ci32, SessionEntry\u003e) {\n    if sessions.len() \u003c MAX_UNIFIED_EXEC_SESSIONS {\n        return;\n    }\n    // Find session to prune using LRU policy\n    // Protect 8 most recently used\n    // Prefer exited sessions over running\n    // Remove oldest non-protected\n}\n\nfn session_id_to_prune_from_meta(meta: \u0026[(i32, Instant, bool)]) -\u003e Option\u003ci32\u003e {\n    // Sort by recency, protect top 8\n    // Find oldest exited non-protected, or oldest running non-protected\n}\n```\n\n## Pruning Policy\n1. Protect 8 most recently used sessions (never prune)\n2. First prefer: exited sessions (LRU order)\n3. Fallback: running sessions (LRU order)\n\n## Tests to Port\nFrom `core/tests/suite/unified_exec.rs`:\n- Test pruning kicks in at MAX_UNIFIED_EXEC_SESSIONS\n- Test exited sessions pruned before running\n- Test protected sessions not pruned\n\nRun `cargo test -p codex-core unified_exec`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T14:01:36.122179054+01:00","updated_at":"2026-01-04T14:35:41.977157284+01:00","closed_at":"2026-01-04T14:35:41.977157284+01:00","dependencies":[{"issue_id":"codex-3yt.7","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:01:36.122562586+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.8","title":"Port: Unified exec footer UI (f74e0cda9)","description":"## Upstream\nCommit: f74e0cda9\nPR: #8117\n\n## What It Does\nShows a footer at bottom of chat area when unified_exec sessions are running in background:\n```\nBackground terminal running: echo hello · rg \"foo\" src · 1 more running\n```\n\n## New File: `tui/src/bottom_pane/unified_exec_footer.rs`\n\n### Structure\n```rust\npub(crate) struct UnifiedExecFooter {\n    sessions: Vec\u003cString\u003e,  // List of running command strings\n}\n\nimpl UnifiedExecFooter {\n    pub(crate) fn new() -\u003e Self\n    pub(crate) fn set_sessions(\u0026mut self, sessions: Vec\u003cString\u003e) -\u003e bool  // Returns true if changed\n    pub(crate) fn is_empty(\u0026self) -\u003e bool\n    fn render_lines(\u0026self, width: u16) -\u003e Vec\u003cLine\u003c'static\u003e\u003e\n}\n\nimpl Renderable for UnifiedExecFooter { ... }\n```\n\n### Constants\n```rust\nconst MAX_SESSION_LABEL_GRAPHEMES: usize = 48;  // Truncate long commands\nconst MAX_VISIBLE_SESSIONS: usize = 2;          // Show 2, then 'N more'\n```\n\n### Rendering Logic\n1. Label: \"Background terminal running:\" (dim)\n2. Commands: truncated, cyan, separated by \" · \"\n3. Overflow: \"N more running\" (dim)\n4. Word-wrap with indent on continuation lines\n\n## Integration Points\n\n### 1. `tui/src/bottom_pane/mod.rs`\n```rust\n+mod unified_exec_footer;\n+pub(crate) use unified_exec_footer::UnifiedExecFooter;\n```\n\n### 2. `tui/src/chatwidget.rs`\n- Add `unified_exec_footer: UnifiedExecFooter` field to ChatWidget\n- On unified_exec events, call `footer.set_sessions(active_commands)`\n- In render, allocate area for footer if not empty\n- Render footer at bottom of chat area\n\n### 3. Session Tracking\nNeed to track which unified_exec sessions are active. Check how upstream gets the list of running commands (likely from UnifiedExecSessionManager or events).\n\n## Tests to Port\nSnapshot tests:\n- `render_two_sessions` - Two active sessions\n- `render_more_sessions` - More than MAX_VISIBLE\n\nRun `cargo test -p codex-tui`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-04T14:01:48.769971741+01:00","updated_at":"2026-01-04T15:27:55.397162805+01:00","closed_at":"2026-01-04T15:27:55.397162805+01:00","dependencies":[{"issue_id":"codex-3yt.8","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:01:48.77032244+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-3yt.8","depends_on_id":"codex-3yt.5","type":"blocks","created_at":"2026-01-04T14:02:07.950713365+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3yt.9","title":"Port: Collapse 'waiting' status for unified_exec (6c76d1771)","description":"## Upstream\nCommit: 6c76d1771\nPR: #8257\n\n## What It Does\nWhen a unified_exec command is long-running (\"waiting\"), collapse multiple waiting indicators into a single compact display instead of showing each one separately.\n\nBefore:\n```\n· Waiting for echo hello...\n· Waiting for rg \"foo\" src...\n· Waiting for npm run dev...\n```\n\nAfter:\n```\n· Waiting for 3 commands...\n```\n\n## Files Changed\n- `tui/src/chatwidget.rs` (+75 lines) - Track waiting state, collapse logic\n- `tui/src/history_cell.rs` (+81 lines) - Render collapsed waiting state\n\n## Implementation Approach\n1. Track which exec cells are in \"waiting\" state\n2. When multiple cells are waiting, render single collapsed indicator\n3. Expand on hover/focus (optional)\n\n## Key Logic (from upstream)\nIn history_cell.rs, add handling for waiting exec cells:\n- Count cells in waiting state\n- If count \u003e 1, render collapsed \"Waiting for N commands...\"\n- Otherwise render normal waiting indicator\n\n## Styling\nUse dim text for collapsed indicator, consistent with other TUI conventions.\n\n## Tests to Port\nSnapshot tests from upstream:\n- `unified_exec_empty_then_non_empty_after`\n- `unified_exec_non_empty_then_empty_active`\n- `unified_exec_non_empty_then_empty_after`\n- `unified_exec_waiting_multiple_empty_active`\n- `unified_exec_waiting_multiple_empty_after`\n\nRun `cargo test -p codex-tui`\n\n## Note\nThis is UI polish - lower priority than the core unified_exec functionality.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-04T14:01:59.547428481+01:00","updated_at":"2026-01-04T15:27:55.416527202+01:00","closed_at":"2026-01-04T15:27:55.416527202+01:00","dependencies":[{"issue_id":"codex-3yt.9","depends_on_id":"codex-3yt","type":"parent-child","created_at":"2026-01-04T14:01:59.547786734+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-3yt.9","depends_on_id":"codex-3yt.5","type":"blocks","created_at":"2026-01-04T14:02:07.968349604+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-3zq","title":"/handoff command shows empty extracted context","description":"## Problem\nThe /handoff command shows a review dialog with empty 'Extracted Context' section.\n\n## User sees\n```\n┌ Handoff to new thread ────────────────────────────────────────────┐\n│Goal: \u003cwhatever user typed\u003e                                        │\n│───────────────────────────────────────────────────────────────────│\n│Extracted Context                                                  │\n│                                                                   │\n│───────────────────────────────────────────────────────────────────│\n│Relevant Files                                                     │\n│(no files)                                                         │\n│───────────────────────────────────────────────────────────────────│\n│[Enter] Confirm  [e] Edit  [Esc] Cancel                            │\n└───────────────────────────────────────────────────────────────────┘\n```\n\n## Root Cause\nIn core/src/tasks/handoff.rs, `run_extraction()` only captures text from `OutputItemDone` events:\n\n```rust\nwhile let Some(event) = stream.next().await {\n    match event {\n        Ok(ResponseEvent::OutputItemDone(item)) =\u003e {\n            // Only captures OutputItemDone!\n            if let ResponseItem::Message { content, .. } = \u0026item {\n                for c in content {\n                    if let ContentItem::OutputText { text, .. } = c {\n                        response_text.push_str(text);\n                    }\n                }\n            }\n        }\n        Ok(ResponseEvent::Completed { .. }) =\u003e break,\n        Err(e) =\u003e return Err(...),\n        _ =\u003e continue,  // \u003c-- OutputTextDelta is IGNORED here!\n    }\n}\n```\n\nBut streaming responses often come as `OutputTextDelta(String)` events, which are being discarded by `_ =\u003e continue`.\n\n## Fix\nAlso capture `ResponseEvent::OutputTextDelta`:\n\n```rust\nwhile let Some(event) = stream.next().await {\n    match event {\n        Ok(ResponseEvent::OutputItemDone(item)) =\u003e {\n            if let ResponseItem::Message { content, .. } = \u0026item {\n                for c in content {\n                    if let ContentItem::OutputText { text, .. } = c {\n                        response_text.push_str(text);\n                    }\n                }\n            }\n        }\n        Ok(ResponseEvent::OutputTextDelta(delta)) =\u003e {\n            response_text.push_str(\u0026delta);  // ADD THIS!\n        }\n        Ok(ResponseEvent::Completed { .. }) =\u003e break,\n        Err(e) =\u003e return Err(format!(\"Extraction stream error: {e}\")),\n        _ =\u003e continue,\n    }\n}\n```\n\n## Additional improvements\n1. Add logging when response_text is empty after streaming\n2. Add logging to show what events ARE being received (for debugging)\n3. Consider if there are other event types that should be captured\n\n## Files\n- core/src/tasks/handoff.rs - fix run_extraction() to capture OutputTextDelta","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-22T23:28:37.950975738+01:00","updated_at":"2025-12-22T23:37:47.286244054+01:00","closed_at":"2025-12-22T23:37:47.286244054+01:00"}
{"id":"codex-45c","title":"Loop Detection Service","description":"Port loop detection from gemini-cli to prevent agent death loops.\n\n## Background\nWhen LLMs get stuck, they can enter infinite loops - calling the same tool repeatedly or generating repetitive content. This wastes tokens/money and frustrates users. gemini-cli has a LoopDetectionService that catches these patterns.\n\n## What we're porting\n1. **Tool call repetition detection** - Hash tool name + args, detect 5+ consecutive identical calls\n2. **Content repetition detection** - Sliding window of 50-char chunks, detect 10+ repetitions within 250-char window\n\n## What we're NOT porting\n- LLM-based cognitive loop detection (requires extra model calls)\n- Timeouts (we have other mechanisms)\n- Session-level disable flag\n- Markdown parsing to skip code blocks (V1 - threshold is high enough)\n\n## Architecture\n- New module: core/src/loop_detector.rs\n- LoopDetector struct with Arc\u003cMutex\u003c\u003e\u003e wrapper\n- Task scope (lives in run_task, reset between user prompts)\n- Checks happen before tool execution and on text deltas\n- On detection: emit WarningEvent, abort turn, return control to user\n\n## Source reference\ngemini-cli: packages/core/src/services/loopDetectionService.ts","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-28T19:42:46.047788742+01:00","updated_at":"2025-12-30T02:27:21.044767316+01:00","closed_at":"2025-12-30T02:27:21.044767316+01:00"}
{"id":"codex-45c.1","title":"Create loop_detector.rs module","description":"## Task\nCreate `codex-rs/core/src/loop_detector.rs` with the LoopDetector struct.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.ts`\n- Lines 1-60: Constants and thresholds\n- Lines 90-130: LoopDetectionService class structure\n- Lines 160-190: `checkToolCallLoop()` method\n- Lines 200-280: `checkContentLoop()` and `analyzeContentChunksForLoop()` methods\n\n## Implementation\n\n```rust\nuse sha2::{Digest, Sha256};\nuse std::collections::HashMap;\n\nconst TOOL_CALL_LOOP_THRESHOLD: u32 = 5;\nconst CONTENT_LOOP_THRESHOLD: usize = 10;\nconst CONTENT_CHUNK_SIZE: usize = 50;\nconst CONTENT_WINDOW_SIZE: usize = 250; // 5 * CONTENT_CHUNK_SIZE\nconst MAX_HISTORY_LENGTH: usize = 5000;\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum LoopType {\n    ConsecutiveIdenticalToolCalls,\n    RepetitiveContent,\n}\n\npub struct LoopDetector {\n    // Tool call tracking\n    last_tool_hash: Option\u003cString\u003e,\n    tool_repetition_count: u32,\n    \n    // Content tracking\n    content_history: String,\n    chunk_occurrences: HashMap\u003cString, Vec\u003cusize\u003e\u003e, // hash -\u003e list of start indices\n}\n\nimpl LoopDetector {\n    pub fn new() -\u003e Self {\n        Self {\n            last_tool_hash: None,\n            tool_repetition_count: 0,\n            content_history: String::with_capacity(MAX_HISTORY_LENGTH),\n            chunk_occurrences: HashMap::new(),\n        }\n    }\n\n    /// Reset all state (call between user turns/prompts)\n    pub fn reset(\u0026mut self) {\n        self.last_tool_hash = None;\n        self.tool_repetition_count = 0;\n        self.reset_content();\n    }\n\n    /// Check tool call for loop. Returns Some(LoopType) if loop detected.\n    /// Call this when a tool call is received, before execution.\n    pub fn check_tool_call(\u0026mut self, name: \u0026str, args_json: \u0026str) -\u003e Option\u003cLoopType\u003e {\n        let mut hasher = Sha256::new();\n        hasher.update(name.as_bytes());\n        hasher.update(b\":\");\n        hasher.update(args_json.as_bytes());\n        let hash = format!(\"{:x}\", hasher.finalize());\n\n        if self.last_tool_hash.as_deref() == Some(\u0026hash) {\n            self.tool_repetition_count += 1;\n        } else {\n            self.last_tool_hash = Some(hash);\n            self.tool_repetition_count = 1;\n        }\n\n        // Reset content tracking on tool call (content loops are per-stream)\n        self.reset_content();\n\n        if self.tool_repetition_count \u003e= TOOL_CALL_LOOP_THRESHOLD {\n            Some(LoopType::ConsecutiveIdenticalToolCalls)\n        } else {\n            None\n        }\n    }\n\n    /// Check content delta for loop. Returns Some(LoopType) if loop detected.\n    /// Call this on each OutputTextDelta event.\n    pub fn check_content(\u0026mut self, delta: \u0026str) -\u003e Option\u003cLoopType\u003e {\n        self.content_history.push_str(delta);\n\n        // Prune if too large\n        if self.content_history.len() \u003e MAX_HISTORY_LENGTH * 2 {\n            self.reset_content();\n            return None;\n        }\n\n        self.detect_content_loop()\n    }\n\n    fn reset_content(\u0026mut self) {\n        self.content_history.clear();\n        self.chunk_occurrences.clear();\n    }\n\n    fn detect_content_loop(\u0026mut self) -\u003e Option\u003cLoopType\u003e {\n        let len = self.content_history.len();\n        if len \u003c CONTENT_CHUNK_SIZE {\n            return None;\n        }\n\n        // Check the most recently added chunk\n        let start = len - CONTENT_CHUNK_SIZE;\n        let chunk = \u0026self.content_history[start..];\n\n        let mut hasher = Sha256::new();\n        hasher.update(chunk.as_bytes());\n        let hash = format!(\"{:x}\", hasher.finalize());\n\n        let indices = self.chunk_occurrences.entry(hash).or_default();\n        indices.push(start);\n\n        // Count occurrences within the window\n        let recent_count = indices\n            .iter()\n            .filter(|\u0026\u0026idx| start.saturating_sub(idx) \u003c= CONTENT_WINDOW_SIZE)\n            .count();\n\n        if recent_count \u003e= CONTENT_LOOP_THRESHOLD {\n            Some(LoopType::RepetitiveContent)\n        } else {\n            None\n        }\n    }\n}\n\nimpl Default for LoopDetector {\n    fn default() -\u003e Self {\n        Self::new()\n    }\n}\n```\n\n## Also needed\n1. Add `sha2` dependency to `codex-rs/core/Cargo.toml`\n2. Add `mod loop_detector;` and `pub use loop_detector::{LoopDetector, LoopType};` to lib.rs\n\n## Tests\nAdd basic unit tests in the same file:\n- test_tool_call_loop_detection: 5 identical calls triggers, 4 does not\n- test_tool_call_different_args: changing args resets counter\n- test_content_loop_detection: repeated 50-char chunk triggers\n- test_content_no_loop: varied content does not trigger","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T19:43:26.344838009+01:00","updated_at":"2025-12-30T02:03:05.058072222+01:00","closed_at":"2025-12-30T02:03:05.058072222+01:00","dependencies":[{"issue_id":"codex-45c.1","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:43:26.345173559+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-45c.2","title":"Add LoopDetected error variant","description":"## Task\nAdd `LoopDetected` variant to `CodexErr` in `codex-rs/core/src/error.rs`.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.ts`\n- Lines 15-20: LoopType enum definition (CONSECUTIVE_IDENTICAL_TOOL_CALLS, CHANTING_IDENTICAL_SENTENCES, LLM_DETECTED_LOOP)\n- The error is emitted via events in gemini-cli, but we use a Result error type in Rust\n\n## Implementation\n\n1. Import LoopType at top of error.rs:\n```rust\nuse crate::loop_detector::LoopType;\n```\n\n2. Add variant to CodexErr enum:\n```rust\n#[derive(Debug, thiserror::Error)]\npub enum CodexErr {\n    // ... existing variants ...\n    \n    #[error(\"Loop detected: {0:?}\")]\n    LoopDetected(LoopType),\n}\n```\n\n## Notes\n- LoopType derives Debug, so the error message will show the variant name\n- This error will be caught in run_task() and converted to a WarningEvent\n- No protocol changes needed - we use existing WarningEvent for client notification","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T19:43:36.245787772+01:00","updated_at":"2025-12-30T02:06:34.553599221+01:00","closed_at":"2025-12-30T02:06:34.553599221+01:00","dependencies":[{"issue_id":"codex-45c.2","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:43:36.246211791+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.2","depends_on_id":"codex-45c.1","type":"blocks","created_at":"2025-12-28T19:45:26.159920756+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-45c.3","title":"Integrate loop detector in run_task","description":"## Task\nInitialize LoopDetector in `run_task()` and pass it through to `try_run_turn()`.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/core/client.ts`\n- Lines 50-70: LoopDetectionService instantiation in client\n- Lines 200-250: Integration in the streaming loop, calling `loopDetector.addAndCheck()` and `loopDetector.turnStarted()`\n\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.ts`\n- Lines 130-160: `reset()` method called between prompts\n\n## Files to modify\n- `codex-rs/core/src/codex.rs`\n\n## Implementation\n\n### 1. Add imports at top of codex.rs\n```rust\nuse crate::loop_detector::LoopDetector;\n```\n\n### 2. Define type alias (near other type aliases)\n```rust\npub(crate) type SharedLoopDetector = Arc\u003ctokio::sync::Mutex\u003cLoopDetector\u003e\u003e;\n```\n\n### 3. In run_task() function, initialize detector before the loop\nFind the line:\n```rust\nlet turn_diff_tracker = Arc::new(tokio::sync::Mutex::new(TurnDiffTracker::new()));\n```\n\nAdd after it:\n```rust\nlet loop_detector: SharedLoopDetector = Arc::new(tokio::sync::Mutex::new(LoopDetector::new()));\n```\n\n### 4. Pass loop_detector to run_turn()\nFind the call to `run_turn()` and add the loop_detector parameter:\n```rust\nmatch run_turn(\n    Arc::clone(\u0026sess),\n    Arc::clone(\u0026turn_context),\n    Arc::clone(\u0026turn_diff_tracker),\n    Arc::clone(\u0026loop_detector),  // ADD THIS\n    turn_input,\n    cancellation_token.child_token(),\n)\n```\n\n### 5. Update run_turn() signature\n```rust\nasync fn run_turn(\n    sess: Arc\u003cSession\u003e,\n    turn_context: Arc\u003cTurnContext\u003e,\n    turn_diff_tracker: SharedTurnDiffTracker,\n    loop_detector: SharedLoopDetector,  // ADD THIS\n    input: Vec\u003cResponseItem\u003e,\n    cancellation_token: CancellationToken,\n) -\u003e CodexResult\u003cTurnRunResult\u003e\n```\n\n### 6. Pass to try_run_turn() inside run_turn()\n```rust\ntry_run_turn(\n    router,\n    sess,\n    turn_context,\n    turn_diff_tracker,\n    loop_detector,  // ADD THIS\n    \u0026prompt,\n    cancellation_token,\n)\n```\n\n### 7. Update try_run_turn() signature\n```rust\nasync fn try_run_turn(\n    router: Arc\u003cToolRouter\u003e,\n    sess: Arc\u003cSession\u003e,\n    turn_context: Arc\u003cTurnContext\u003e,\n    turn_diff_tracker: SharedTurnDiffTracker,\n    loop_detector: SharedLoopDetector,  // ADD THIS\n    prompt: \u0026Prompt,\n    cancellation_token: CancellationToken,\n) -\u003e CodexResult\u003cTurnRunResult\u003e\n```\n\n### 8. Handle LoopDetected error in run_task() loop\nFind the error handling block in run_task() (around the match on run_turn result).\nAdd a new arm before the generic error handler:\n\n```rust\nErr(CodexErr::LoopDetected(loop_type)) =\u003e {\n    let message = match loop_type {\n        LoopType::ConsecutiveIdenticalToolCalls =\u003e {\n            \"Loop detected: Agent made 5 consecutive identical tool calls. Turn aborted.\"\n        }\n        LoopType::RepetitiveContent =\u003e {\n            \"Loop detected: Agent is generating repetitive content. Turn aborted.\"\n        }\n    };\n    let event = EventMsg::Warning(WarningEvent {\n        message: message.to_string(),\n    });\n    sess.send_event(\u0026turn_context, event).await;\n    break;\n}\n```\n\nImport LoopType if not already imported:\n```rust\nuse crate::loop_detector::LoopType;\n```\n\n## Notes\n- loop_detector has task scope - it persists across turns within run_task but resets between user prompts\n- The pattern matches turn_diff_tracker exactly\n- Error handling converts to WarningEvent and breaks the loop","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T19:43:56.961873116+01:00","updated_at":"2025-12-30T02:12:10.581930588+01:00","closed_at":"2025-12-30T02:12:10.581930588+01:00","dependencies":[{"issue_id":"codex-45c.3","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:43:56.962246548+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.3","depends_on_id":"codex-45c.1","type":"blocks","created_at":"2025-12-28T19:45:26.175519351+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.3","depends_on_id":"codex-45c.2","type":"blocks","created_at":"2025-12-28T19:45:26.191267522+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-45c.4","title":"Add tool call loop check in handle_output_item_done","description":"## Task\nAdd loop detection check when a FunctionCall is received, before tool execution.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.ts`\n- Lines 140-165: `addAndCheck()` method that dispatches to checkToolCallLoop on ToolCallRequest events\n- Lines 166-190: `checkToolCallLoop()` implementation - hashes name+args, compares to last, increments counter\n\n## Files to modify\n- `codex-rs/core/src/stream_events_utils.rs` (where handle_output_item_done lives)\n\n## Implementation\n\n### 1. Update HandleOutputCtx to include loop_detector\nFind the `HandleOutputCtx` struct and add a field:\n```rust\npub(crate) struct HandleOutputCtx {\n    pub(crate) sess: Arc\u003cSession\u003e,\n    pub(crate) turn_context: Arc\u003cTurnContext\u003e,\n    pub(crate) tool_runtime: ToolCallRuntime,\n    pub(crate) cancellation_token: CancellationToken,\n    pub(crate) loop_detector: SharedLoopDetector,  // ADD THIS\n}\n```\n\n### 2. Update the ctx creation in try_run_turn\nIn `codex.rs`, find where `HandleOutputCtx` is created:\n```rust\nlet mut ctx = HandleOutputCtx {\n    sess: sess.clone(),\n    turn_context: turn_context.clone(),\n    tool_runtime: tool_runtime.clone(),\n    cancellation_token: cancellation_token.child_token(),\n    loop_detector: loop_detector.clone(),  // ADD THIS\n};\n```\n\n### 3. Add check in handle_output_item_done\nIn `stream_events_utils.rs`, find the `handle_output_item_done` function.\nAt the beginning of the function, add the loop check for FunctionCall:\n\n```rust\npub(crate) async fn handle_output_item_done(\n    ctx: \u0026mut HandleOutputCtx,\n    item: ResponseItem,\n    previously_active_item: Option\u003cTurnItem\u003e,\n) -\u003e CodexResult\u003cOutputResult\u003e {\n    // Check for tool call loop BEFORE executing\n    if let ResponseItem::FunctionCall { name, arguments, .. } = \u0026item {\n        let mut detector = ctx.loop_detector.lock().await;\n        if let Some(loop_type) = detector.check_tool_call(name, arguments) {\n            return Err(CodexErr::LoopDetected(loop_type));\n        }\n    }\n    \n    // Also check CustomToolCall if it has similar structure\n    if let ResponseItem::CustomToolCall { name, arguments, .. } = \u0026item {\n        let args_str = arguments.as_ref().map(|v| v.to_string()).unwrap_or_default();\n        let mut detector = ctx.loop_detector.lock().await;\n        if let Some(loop_type) = detector.check_tool_call(name, \u0026args_str) {\n            return Err(CodexErr::LoopDetected(loop_type));\n        }\n    }\n\n    // ... rest of existing function\n}\n```\n\n### 4. Add imports to stream_events_utils.rs\n```rust\nuse crate::loop_detector::LoopType;\nuse crate::error::CodexErr;\nuse crate::codex::SharedLoopDetector;\n```\n\n## Notes\n- The check happens before any tool execution logic\n- Both FunctionCall and CustomToolCall are checked\n- FunctionCall.arguments is already a String (JSON), so we pass it directly\n- CustomToolCall.arguments is Option\u003cValue\u003e, so we serialize it\n- The lock is held briefly just for the hash check","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T19:44:16.553203364+01:00","updated_at":"2025-12-30T02:14:00.349594848+01:00","closed_at":"2025-12-30T02:14:00.349594848+01:00","dependencies":[{"issue_id":"codex-45c.4","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:44:16.553538634+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.4","depends_on_id":"codex-45c.3","type":"blocks","created_at":"2025-12-28T19:45:26.208667396+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-45c.5","title":"Add content loop check on OutputTextDelta","description":"## Task\nAdd loop detection check on streamed text deltas to catch repetitive content.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.ts`\n- Lines 140-165: `addAndCheck()` method that dispatches to checkContentLoop on Content events\n- Lines 195-280: `checkContentLoop()` implementation:\n  - Appends content to history buffer\n  - Handles code block detection (we skip this in V1)\n  - Calls `truncateAndUpdate()` to manage buffer size\n  - Calls `analyzeContentChunksForLoop()` to detect repetitions\n- Lines 300-350: `analyzeContentChunksForLoop()` - sliding window hash detection\n- Lines 360-400: `isLoopDetectedForChunk()` - checks if chunk appears 10+ times within 5*chunk_size distance\n\n## Files to modify\n- `codex-rs/core/src/codex.rs`\n\n## Implementation\n\n### 1. Find the OutputTextDelta handler in try_run_turn\nLook for this pattern in the match statement inside try_run_turn():\n```rust\nResponseEvent::OutputTextDelta(delta) =\u003e {\n    // ... existing code that sends AgentMessageDelta event\n}\n```\n\n### 2. Add loop check at the start of this arm\n```rust\nResponseEvent::OutputTextDelta(delta) =\u003e {\n    // Check for content loop\n    {\n        let mut detector = loop_detector.lock().await;\n        if let Some(loop_type) = detector.check_content(\u0026delta) {\n            return Err(CodexErr::LoopDetected(loop_type));\n        }\n    }\n    \n    // ... existing code (in review child threads, suppress...)\n    if active_item.is_some() {\n        sess.send_event(\n            \u0026turn_context,\n            EventMsg::AgentMessageDelta(AgentMessageDeltaEvent {\n                delta: delta.clone(),\n            }),\n        )\n        .await;\n    } else {\n        error_or_panic(\"OutputTextDelta without active item\".to_string());\n    }\n}\n```\n\n### 3. Make sure imports are present\nAt the top of codex.rs, ensure these are imported:\n```rust\nuse crate::loop_detector::{LoopDetector, LoopType};\nuse crate::error::CodexErr;\n```\n\n## Notes\n- The lock scope is limited with a block `{}` to avoid holding it across the await\n- The check happens before sending the delta to the client\n- This catches models that get stuck generating the same text over and over\n- The threshold is high (10 repetitions of 50-char chunk) to avoid false positives\n- V1 does NOT skip code blocks/tables like gemini-cli does - the high threshold should prevent false positives","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T19:44:32.997602551+01:00","updated_at":"2025-12-30T02:15:12.924868862+01:00","closed_at":"2025-12-30T02:15:12.924868862+01:00","dependencies":[{"issue_id":"codex-45c.5","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:44:32.997918244+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.5","depends_on_id":"codex-45c.3","type":"blocks","created_at":"2025-12-28T19:45:26.22424433+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-45c.6","title":"Add integration tests for loop detection","description":"## Task\nAdd integration tests to verify loop detection works end-to-end.\n\n## Gemini-cli Reference\nFile: `third-party/gemini-cli/packages/core/src/services/loopDetectionService.test.ts`\n- Lines 1-100: Test setup and mocking\n- Lines 100-150: Tool call loop tests (threshold=5, different args reset)\n- Lines 200-300: Content loop tests (repetition detection)\n- Lines 350-400: Code block skipping tests (we skip this in V1)\n\n## Files to modify\n- `codex-rs/core/src/codex.rs` (in the #[cfg(test)] mod tests section)\n\n## Test cases\n\n### 1. Test tool call loop detection\n```rust\n#[tokio::test]\nasync fn test_loop_detection_tool_calls() {\n    // Setup mock server that returns 6 identical tool calls\n    // Verify that after 5 calls, we get a WarningEvent about loop detection\n    // Verify the turn is aborted\n}\n```\n\nUse the existing test infrastructure with `responses::mount_sse_once`.\nCreate a response that emits multiple identical FunctionCall events.\n\n### 2. Test that different tool calls dont trigger\n```rust\n#[tokio::test]\nasync fn test_no_loop_for_different_tool_calls() {\n    // Setup mock server that returns 5 tool calls with different args\n    // Verify no loop detection warning\n    // Verify all tools execute\n}\n```\n\n### 3. Test content loop detection (optional, harder to test)\nContent loop detection is harder to test because it requires streaming\ndeltas. Consider deferring this test or testing at the unit level only.\n\n## Test pattern\nFollow existing test patterns in codex.rs tests:\n```rust\nuse core_test_support::responses;\n\nlet mock = responses::mount_sse_once(\u0026server, responses::sse(vec![\n    responses::ev_response_created(\"resp-1\"),\n    // Multiple identical function calls\n    responses::ev_function_call(\"call-1\", \"shell\", r#\"{\"command\":\"echo hi\",\"workdir\":\"/tmp\"}\"#),\n    responses::ev_function_call(\"call-2\", \"shell\", r#\"{\"command\":\"echo hi\",\"workdir\":\"/tmp\"}\"#),\n    responses::ev_function_call(\"call-3\", \"shell\", r#\"{\"command\":\"echo hi\",\"workdir\":\"/tmp\"}\"#),\n    responses::ev_function_call(\"call-4\", \"shell\", r#\"{\"command\":\"echo hi\",\"workdir\":\"/tmp\"}\"#),\n    responses::ev_function_call(\"call-5\", \"shell\", r#\"{\"command\":\"echo hi\",\"workdir\":\"/tmp\"}\"#),\n    responses::ev_completed(\"resp-1\"),\n])).await;\n```\n\n## Notes\n- Check for WarningEvent in the event stream\n- The test should verify the warning message contains \"Loop detected\"\n- May need to check how events are collected in existing tests","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T19:44:52.29111792+01:00","updated_at":"2025-12-30T02:27:21.027615446+01:00","closed_at":"2025-12-30T02:27:21.027615446+01:00","dependencies":[{"issue_id":"codex-45c.6","depends_on_id":"codex-45c","type":"parent-child","created_at":"2025-12-28T19:44:52.291511501+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.6","depends_on_id":"codex-45c.4","type":"blocks","created_at":"2025-12-28T19:45:26.240708006+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-45c.6","depends_on_id":"codex-45c.5","type":"blocks","created_at":"2025-12-28T19:45:26.259960155+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460","title":"Backtrack \u0026 Session Replay Overhaul","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T22:07:31.261546993+01:00","updated_at":"2025-12-27T11:54:24.060120721+01:00","closed_at":"2025-12-27T11:54:24.060120721+01:00"}
{"id":"codex-460.1","title":"Restore full session state including tool calls on resume","description":"Currently, resume only replays EventMsg variants, skipping ResponseItem (tool calls and outputs). Need to update get_event_msgs() and UI replay logic to include tool interactions so the session looks complete after resuming.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T22:07:34.892216246+01:00","updated_at":"2025-12-22T22:31:15.338468328+01:00","closed_at":"2025-12-22T22:31:15.338473679+01:00","dependencies":[{"issue_id":"codex-460.1","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.89262571+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.2","title":"Implement bidirectional navigation in backtrack view","description":"Add keybindings to move both 'up' (Esc) and 'down' in the backtrack view. Currently, there is no way to navigate forward/down once you've gone back.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T22:07:34.911128751+01:00","updated_at":"2025-12-22T22:39:37.330141019+01:00","closed_at":"2025-12-22T22:39:37.330146318+01:00","dependencies":[{"issue_id":"codex-460.2","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.911444524+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.3","title":"Fix data loss during backtrack","description":"Investigate and fix issues where backtracking sometimes results in data loss within the session.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-22T22:07:34.927870804+01:00","updated_at":"2025-12-26T22:10:26.951190275+01:00","closed_at":"2025-12-26T22:10:26.951190275+01:00","dependencies":[{"issue_id":"codex-460.3","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.928135604+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-460.4","title":"Support backtracking to subagent delegations","description":"Enable backtracking to points where subagents were delegated, whether by user (@agent, /command) or by the main agent. Currently, these delegation points are not captured or reachable in backtrack.","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-22T22:07:34.944677159+01:00","updated_at":"2025-12-27T11:54:10.714574123+01:00","closed_at":"2025-12-27T11:54:10.714574123+01:00","dependencies":[{"issue_id":"codex-460.4","depends_on_id":"codex-460","type":"parent-child","created_at":"2025-12-22T22:07:34.944940014+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4ep","title":"Task/Skill delegation v2: workers + internal skills + dynamic general","description":"Replace persona-oriented delegation with skill-driven workers.\n\nScope:\n- Skills become first-class, selectable modules; add internal/hidden skills.\n- Review remains a task handler, but its strict JSON contract lives in an internal skill.\n- Remove/replace the oracle persona with one or more skills.\n- Add a dynamic general task handler that accepts runtime-selected skills.\n- Ensure worker sessions only see the skills they are assigned (no global skills catalog / implicit skill-trigger injection).\n\nDoD:\n- task tool supports skill selection for task_type=general (enum from public skills).\n- Internal skills are not visible/selectable by the main agent.\n- review task still renders in TUI via ReviewOutputEvent parsing.\n- Oracle no longer exists as a worker/persona; equivalent behavior is available via skills.\n- Targeted tests updated/added; cargo check --bin codex passes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-14T12:07:05.450950475+01:00","updated_at":"2026-01-14T12:54:51.875962264+01:00","closed_at":"2026-01-14T12:54:51.875962264+01:00","close_reason":"Duplicate/superseded by codex-lhn (skills redesign epic)","dependencies":[{"issue_id":"codex-4ep","depends_on_id":"codex-lhn","type":"related","created_at":"2026-01-14T12:54:59.829202554+01:00","created_by":"daemon"}]}
{"id":"codex-4hm","title":"/review fails for non-OpenAI providers due to hardcoded review_model default","description":"When using non-OpenAI providers like antigravity, /review fails with 404 because review_model defaults to gpt-5.1-codex-max which does not exist on those providers. The review uses the same provider but different model, causing the failure.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T16:32:02.531502279+01:00","updated_at":"2025-12-07T16:35:16.58935878+01:00","closed_at":"2025-12-07T16:35:16.58935878+01:00"}
{"id":"codex-4lk","title":"Show subagent session_id in TUI delegation display","description":"## Goal\nWhen displaying subagent delegations in the TUI, show the session_id for traceability:\n```\n• Delegated to @rush (019b47f9-ad11)\n  └ Task description...\n```\n\nThe session_id should be dimmed/subtle to not distract from the main content.\n\n## Why\n- Allows users to find the subagent's rollout file\n- Enables correlation between parent and child sessions\n- Useful for debugging subagent issues\n\n## Implementation\n1. The `SubagentEventPayload::TaskStarted` already contains `session_id`\n2. Update `SubagentTaskCell` in `tui/src/history_cell.rs` to store and display the session_id\n3. Format as truncated UUID (first 12 chars) with dim styling\n\n## Files\n- `tui/src/history_cell.rs` - update SubagentTaskCell rendering\n- Possibly `tui/src/app.rs` - ensure session_id is passed through","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-22T22:50:57.622919731+01:00","updated_at":"2025-12-26T17:50:08.996759441+01:00","closed_at":"2025-12-26T17:50:08.996759441+01:00"}
{"id":"codex-4q5","title":"Configurable shell command timeouts","description":"Add configurable shell command timeouts to replace the hardcoded 10-second default. Users can set a custom default timeout and define regex-based overrides for specific commands (e.g., cargo → 5 minutes).\n\n**Config example:**\n```toml\n[shell]\ndefault_timeout_ms = 30000\n\n[[shell.timeout_overrides]]\npattern = \"^cargo\"\ntimeout_ms = 300000\n```\n\n**Precedence chain:**\n1. Model-provided timeout_ms (explicit per-call)\n2. First matching timeout_overrides pattern\n3. Configured default_timeout_ms\n4. Hardcoded 10,000ms fallback","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-24T14:23:17.711553812+01:00","updated_at":"2025-12-24T15:30:37.504094117+01:00","closed_at":"2025-12-24T15:30:37.504094117+01:00"}
{"id":"codex-4q5.1","title":"Add ShellConfigToml structs in config/types.rs","description":"Add TOML deserialization structs for shell timeout configuration.\n\n**File:** `core/src/config/types.rs`\n\n**Add these structs:**\n```rust\n#[derive(Deserialize, Debug, Clone, PartialEq, Default)]\n#[serde(deny_unknown_fields)]\npub struct ShellConfigToml {\n    /// Default timeout for shell commands in milliseconds. Falls back to 10,000 if not set.\n    pub default_timeout_ms: Option\u003cu64\u003e,\n\n    /// List of pattern-based timeout overrides. First match wins.\n    #[serde(default)]\n    pub timeout_overrides: Vec\u003cShellTimeoutOverrideToml\u003e,\n}\n\n#[derive(Deserialize, Debug, Clone, PartialEq)]\n#[serde(deny_unknown_fields)]\npub struct ShellTimeoutOverrideToml {\n    /// Regex pattern to match against the command string.\n    pub pattern: String,\n    /// Timeout in milliseconds for commands matching this pattern.\n    pub timeout_ms: u64,\n}\n```\n\n**Don't forget:** Add necessary imports (serde::Deserialize should already be there).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T14:23:34.805262094+01:00","updated_at":"2025-12-24T15:12:41.860815174+01:00","closed_at":"2025-12-24T15:12:41.860815174+01:00","dependencies":[{"issue_id":"codex-4q5.1","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:23:34.805757952+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4q5.2","title":"Add ShellConfig runtime struct in config/mod.rs","description":"Add runtime config struct with compiled regexes and resolution logic.\n\n**File:** `core/src/config/mod.rs`\n\n**1. Add import:**\n```rust\nuse regex::Regex;\n```\n\n**2. Add these structs (near other config structs):**\n```rust\n#[derive(Debug, Clone)]\npub struct ShellConfig {\n    pub default_timeout_ms: u64,\n    pub timeout_overrides: Vec\u003cShellTimeoutOverride\u003e,\n}\n\n#[derive(Debug, Clone)]\npub struct ShellTimeoutOverride {\n    pub pattern: String,  // Kept for PartialEq comparison\n    pub regex: Regex,\n    pub timeout_ms: u64,\n}\n\n// Manual PartialEq because Regex doesn't implement it\nimpl PartialEq for ShellConfig {\n    fn eq(\u0026self, other: \u0026Self) -\u003e bool {\n        self.default_timeout_ms == other.default_timeout_ms\n            \u0026\u0026 self.timeout_overrides == other.timeout_overrides\n    }\n}\n\nimpl PartialEq for ShellTimeoutOverride {\n    fn eq(\u0026self, other: \u0026Self) -\u003e bool {\n        self.pattern == other.pattern \u0026\u0026 self.timeout_ms == other.timeout_ms\n    }\n}\n\nimpl Default for ShellConfig {\n    fn default() -\u003e Self {\n        Self {\n            default_timeout_ms: 10_000,\n            timeout_overrides: Vec::new(),\n        }\n    }\n}\n\nimpl ShellConfig {\n    /// Returns the configured timeout for a command string.\n    /// Checks overrides in order, returns first match or default.\n    pub fn timeout_for(\u0026self, command: \u0026str) -\u003e u64 {\n        for entry in \u0026self.timeout_overrides {\n            if entry.regex.is_match(command) {\n                return entry.timeout_ms;\n            }\n        }\n        self.default_timeout_ms\n    }\n}\n```\n\n**3. Add TryFrom conversion (near other config conversions):**\n```rust\nimpl TryFrom\u003cShellConfigToml\u003e for ShellConfig {\n    type Error = regex::Error;\n\n    fn try_from(toml: ShellConfigToml) -\u003e Result\u003cSelf, Self::Error\u003e {\n        let mut overrides = Vec::new();\n        for item in toml.timeout_overrides {\n            overrides.push(ShellTimeoutOverride {\n                regex: Regex::new(\u0026item.pattern)?,\n                pattern: item.pattern,\n                timeout_ms: item.timeout_ms,\n            });\n        }\n        Ok(Self {\n            default_timeout_ms: toml.default_timeout_ms.unwrap_or(10_000),\n            timeout_overrides: overrides,\n        })\n    }\n}\n```\n\n**Note:** Import ShellConfigToml from types.rs if needed.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T14:23:49.588027089+01:00","updated_at":"2025-12-24T15:13:57.693415581+01:00","closed_at":"2025-12-24T15:13:57.693415581+01:00","dependencies":[{"issue_id":"codex-4q5.2","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:23:49.588444627+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-4q5.2","depends_on_id":"codex-4q5.1","type":"blocks","created_at":"2025-12-24T14:24:57.790094593+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4q5.3","title":"Add shell field to ConfigToml and Config structs","description":"Wire the new ShellConfig into the main config structs.\n\n**File:** `core/src/config/mod.rs`\n\n**1. Add to ConfigToml struct:**\nFind `pub struct ConfigToml` and add:\n```rust\n#[serde(default)]\npub shell: ShellConfigToml,\n```\n\n**2. Add to Config struct:**\nFind `pub struct Config` and add:\n```rust\n/// Shell execution configuration (timeouts, etc.)\npub shell: ShellConfig,\n```\n\n**3. Update Config loading logic:**\nIn `load_from_base_config_with_overrides` (or wherever ConfigToml→Config conversion happens), add:\n```rust\nlet shell = ShellConfig::try_from(config_toml.shell).map_err(|e| {\n    std::io::Error::new(\n        std::io::ErrorKind::InvalidData,\n        format!(\"Invalid shell timeout regex: {e}\"),\n    )\n})?;\n```\n\nAnd include `shell` in the Config struct initialization.\n\n**Hint:** Search for where other fields like `mcp_servers` are initialized to find the right location.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T14:24:00.439186125+01:00","updated_at":"2025-12-24T15:15:32.979532369+01:00","closed_at":"2025-12-24T15:15:32.979532369+01:00","dependencies":[{"issue_id":"codex-4q5.3","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:24:00.43953429+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-4q5.3","depends_on_id":"codex-4q5.2","type":"blocks","created_at":"2025-12-24T14:24:56.758267866+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4q5.4","title":"Update shell handler to use config timeout","description":"Modify the shell command handler to resolve timeout from config when model doesn't specify one.\n\n**File:** `core/src/tools/handlers/shell.rs`\n\n**Find `to_exec_params` function and update timeout resolution:**\n\nCurrent code (approximately):\n```rust\nexpiration: params.timeout_ms.into(),\n```\n\nChange to:\n```rust\n// Resolve timeout: Model explicit \u003e Config override \u003e Config default\nlet timeout_ms = params.timeout_ms.unwrap_or_else(|| {\n    session.config.shell.timeout_for(\u0026params.command)\n});\n// ...\nexpiration: timeout_ms.into(),\n```\n\n**Important:** The `params.command` is the raw command string (e.g., \"cargo build --release\"), NOT the wrapped shell command. Make sure you're matching against the user's command, not the shell wrapper.\n\n**Context:** The function signature should have access to `session` which contains `config`. If not, you may need to pass it through. Check how other config values are accessed in this handler.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T14:24:10.298946105+01:00","updated_at":"2025-12-24T15:16:21.796636649+01:00","closed_at":"2025-12-24T15:16:21.796636649+01:00","dependencies":[{"issue_id":"codex-4q5.4","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:24:10.299285754+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-4q5.4","depends_on_id":"codex-4q5.3","type":"blocks","created_at":"2025-12-24T14:24:59.947947542+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4q5.5","title":"Add unit tests for ShellConfig timeout resolution","description":"Add tests for the timeout resolution logic.\n\n**File:** `core/src/config/mod.rs` (in the tests module at bottom)\n\n**Test cases to cover:**\n\n1. **Default fallback**: No overrides, returns default_timeout_ms\n2. **First match wins**: Multiple patterns, verify order matters\n3. **Anchored patterns**: `^cargo` matches `cargo build` but NOT `echo cargo`\n4. **No match**: Command doesn't match any pattern, returns default\n5. **Partial match**: Pattern without anchor matches anywhere in command\n\n```rust\n#[test]\nfn shell_config_timeout_resolution() {\n    let config = ShellConfig {\n        default_timeout_ms: 10_000,\n        timeout_overrides: vec![\n            ShellTimeoutOverride {\n                pattern: \"^cargo build\".to_string(),\n                regex: Regex::new(\"^cargo build\").unwrap(),\n                timeout_ms: 300_000,\n            },\n            ShellTimeoutOverride {\n                pattern: \"^cargo\".to_string(),\n                regex: Regex::new(\"^cargo\").unwrap(),\n                timeout_ms: 180_000,\n            },\n        ],\n    };\n\n    // Specific pattern wins over generic\n    assert_eq!(config.timeout_for(\"cargo build --release\"), 300_000);\n    \n    // Generic cargo pattern\n    assert_eq!(config.timeout_for(\"cargo test\"), 180_000);\n    \n    // No match, falls back to default\n    assert_eq!(config.timeout_for(\"ls -la\"), 10_000);\n    \n    // Anchored pattern doesn't match mid-string\n    assert_eq!(config.timeout_for(\"echo cargo\"), 10_000);\n}\n\n#[test]\nfn shell_config_try_from_toml() {\n    let toml = ShellConfigToml {\n        default_timeout_ms: Some(30_000),\n        timeout_overrides: vec![\n            ShellTimeoutOverrideToml {\n                pattern: \"^npm\".to_string(),\n                timeout_ms: 120_000,\n            },\n        ],\n    };\n    \n    let config = ShellConfig::try_from(toml).unwrap();\n    assert_eq!(config.default_timeout_ms, 30_000);\n    assert_eq!(config.timeout_overrides.len(), 1);\n    assert_eq!(config.timeout_for(\"npm install\"), 120_000);\n}\n\n#[test]\nfn shell_config_invalid_regex_fails() {\n    let toml = ShellConfigToml {\n        default_timeout_ms: None,\n        timeout_overrides: vec![\n            ShellTimeoutOverrideToml {\n                pattern: \"[invalid\".to_string(), // Unclosed bracket\n                timeout_ms: 1000,\n            },\n        ],\n    };\n    \n    assert!(ShellConfig::try_from(toml).is_err());\n}\n```","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T14:24:33.154391458+01:00","updated_at":"2025-12-24T15:17:02.81833824+01:00","closed_at":"2025-12-24T15:17:02.81833824+01:00","dependencies":[{"issue_id":"codex-4q5.5","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:24:33.155002495+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-4q5.5","depends_on_id":"codex-4q5.4","type":"blocks","created_at":"2025-12-24T14:25:00.924710551+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4q5.6","title":"Export ShellConfigToml from types.rs","description":"Make sure the new types are exported properly.\n\n**File:** `core/src/config/types.rs`\n\nThe structs should already be `pub`, but verify they're accessible from `config/mod.rs`.\n\n**File:** `core/src/config/mod.rs`\n\nAdd to the imports from types.rs (find existing `use` or `pub use` statements):\n```rust\nuse types::{ShellConfigToml, ShellTimeoutOverrideToml};\n// or if re-exporting:\npub use types::{ShellConfigToml, ShellTimeoutOverrideToml};\n```\n\nAlso export the runtime types if needed by other crates:\n```rust\npub use self::{ShellConfig, ShellTimeoutOverride};\n```\n\n**Note:** Check how other types like `McpServerConfig` are exported and follow the same pattern.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T14:24:43.57782187+01:00","updated_at":"2025-12-24T15:13:57.709135728+01:00","closed_at":"2025-12-24T15:13:57.709135728+01:00","dependencies":[{"issue_id":"codex-4q5.6","depends_on_id":"codex-4q5","type":"parent-child","created_at":"2025-12-24T14:24:43.578175816+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-4q5.6","depends_on_id":"codex-4q5.1","type":"blocks","created_at":"2025-12-24T14:24:58.900628359+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-4v7","title":"Epic: Immutable built-in agents with config.toml overrides","description":"Make built-in agents (general, oracle, finder, rush, painter, librarian, review) immutable - hardcoded in binary, not user-editable files.\n\n**Current state:** Agents in ~/.codex/agents/*.md are cloned/generated and editable.\n\n**Target state:**\n- Built-in agents embedded in binary (include_str! or const)\n- Users configure only runtime settings via config.toml\n- Custom agents still loadable from ~/.codex/agents/ (new slugs only)\n\n**Config schema:**\n```toml\n[[agent]]\nname = \"general\"\nmodel = \"openai/gpt-5.2\"\nreasoning_effort = \"medium\"\nenabled = true\n\n[[agent]]\nname = \"oracle\"\nmodel = \"anthropic/claude-sonnet-4-20250514\"\n```\n\n**Configurable:** model, reasoning_effort, enabled, timeout\n**NOT configurable:** system_prompt, instructions (use custom agent instead)\n\n**Resolution order:**\n1. Built-in agents (hardcoded)\n2. File-based agents (custom slugs only; built-in slugs ignored)\n3. Config overrides (patch model/enabled on loaded agents)\n\n**Migration:** Existing ~/.codex/agents/oracle.md etc. silently ignored (reverts to immutable)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-12T16:40:28.245391731+01:00","updated_at":"2026-01-13T15:23:20.842877519+01:00","closed_at":"2026-01-13T15:23:20.842877519+01:00","close_reason":"Completed"}
{"id":"codex-4v7.1","title":"Add AgentConfigToml to config/types.rs","description":"Add agent override config structs:\n\n```rust\n#[derive(Deserialize, Default)]\npub struct ConfigToml {\n    // existing fields...\n    #[serde(default)]\n    pub agent: Vec\u003cAgentConfigToml\u003e,\n}\n\n#[derive(Deserialize)]\npub struct AgentConfigToml {\n    pub name: String,\n    pub model: Option\u003cString\u003e,\n    pub reasoning_effort: Option\u003cSubagentReasoningEffort\u003e,\n    pub enabled: Option\u003cbool\u003e,\n}\n```\n\nMove SubagentReasoningEffort to config/types.rs if needed to avoid circular deps.\n\nDoD: cargo check -p codex-core passes","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-12T16:40:48.232941395+01:00","updated_at":"2026-01-13T15:02:55.920957838+01:00","closed_at":"2026-01-13T15:02:55.920957838+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-4v7.1","depends_on_id":"codex-4v7","type":"parent-child","created_at":"2026-01-12T16:40:48.245059567+01:00","created_by":"daemon"}]}
{"id":"codex-4v7.2","title":"Embed built-in agent definitions in binary","description":"Replace file-based agent loading with embedded definitions.\n\n1. Keep agent markdown in core/src/subagents/ as files\n2. Use include_str! to embed at compile time\n3. Create BUILTIN_AGENTS: \u0026[(\u0026str, \u0026str)] = \u0026[(\"general\", include_str!(\"agents/general.md\")), ...]\n4. Remove ensure_builtin_agents() - no longer write to disk\n\nFiles: core/src/subagents.rs, core/src/subagents/*.md\n\nDoD: Built-in agents load without ~/.codex/agents/ existing","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-12T16:40:52.278408426+01:00","updated_at":"2026-01-13T15:02:56.030998019+01:00","closed_at":"2026-01-13T15:02:56.030998019+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-4v7.2","depends_on_id":"codex-4v7","type":"parent-child","created_at":"2026-01-12T16:40:52.29027617+01:00","created_by":"daemon"}]}
{"id":"codex-4v7.3","title":"Refactor load_subagents to use config overrides","description":"Update load_subagents to:\n\n1. Load built-ins first (from BUILTIN_AGENTS)\n2. Load custom agents from ~/.codex/agents/ (skip if slug matches built-in)\n3. Apply config.toml overrides (model, reasoning_effort, enabled)\n\n```rust\npub async fn load_subagents(codex_home: \u0026Path, config: \u0026Config) -\u003e SubagentLoadOutcome {\n    let mut registry = HashMap::new();\n    \n    // 1. Built-ins\n    for (slug, content) in BUILTIN_AGENTS {\n        registry.insert(slug, parse_agent(content));\n    }\n    \n    // 2. Custom (skip collisions)\n    for file in list_agent_files(codex_home) {\n        if !registry.contains_key(\u0026file.slug) {\n            registry.insert(file.slug, parse_agent(file.content));\n        }\n    }\n    \n    // 3. Config overrides\n    for cfg in \u0026config.agents {\n        if let Some(agent) = registry.get_mut(\u0026cfg.name) {\n            if let Some(m) = \u0026cfg.model { agent.metadata.model = m.clone(); }\n            // ...\n        }\n    }\n}\n```\n\nDoD: cargo test -p codex-core passes; config overrides work","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-12T16:40:58.921703608+01:00","updated_at":"2026-01-13T15:02:56.15387582+01:00","closed_at":"2026-01-13T15:02:56.15387582+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-4v7.3","depends_on_id":"codex-4v7","type":"parent-child","created_at":"2026-01-12T16:40:58.933114088+01:00","created_by":"daemon"},{"issue_id":"codex-4v7.3","depends_on_id":"codex-4v7.2","type":"blocks","created_at":"2026-01-12T16:41:16.065074337+01:00","created_by":"daemon"},{"issue_id":"codex-4v7.3","depends_on_id":"codex-4v7.1","type":"blocks","created_at":"2026-01-12T16:41:16.634164687+01:00","created_by":"daemon"}]}
{"id":"codex-4v7.4","title":"Add tests for agent config resolution","description":"Test cases:\n\n1. Built-in agent loads without any files\n2. Config override changes model\n3. Config override disables agent (enabled = false)\n4. Custom agent with new slug loads from file\n5. Custom agent with built-in slug is ignored\n6. Unknown agent in config is ignored (no error)\n\nDoD: All test cases pass","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-12T16:41:01.320107118+01:00","updated_at":"2026-01-13T15:02:56.289211509+01:00","closed_at":"2026-01-13T15:02:56.289211509+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-4v7.4","depends_on_id":"codex-4v7","type":"parent-child","created_at":"2026-01-12T16:41:01.332250128+01:00","created_by":"daemon"},{"issue_id":"codex-4v7.4","depends_on_id":"codex-4v7.3","type":"blocks","created_at":"2026-01-12T16:41:17.429083607+01:00","created_by":"daemon"}]}
{"id":"codex-4v7.5","title":"Update docs for agent configuration","description":"Document:\n\n1. Built-in agents are immutable\n2. config.toml [[agent]] syntax for overrides\n3. How to create custom agents (new slugs in ~/.codex/agents/)\n4. Migration: old agent files with built-in names are now ignored\n\nFiles: docs/agents.md or similar\n\nDoD: Docs updated","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-12T16:41:03.797235796+01:00","updated_at":"2026-01-13T15:02:57.042633158+01:00","closed_at":"2026-01-13T15:02:57.042633158+01:00","close_reason":"Completed","dependencies":[{"issue_id":"codex-4v7.5","depends_on_id":"codex-4v7","type":"parent-child","created_at":"2026-01-12T16:41:03.810208611+01:00","created_by":"daemon"},{"issue_id":"codex-4v7.5","depends_on_id":"codex-4v7.3","type":"blocks","created_at":"2026-01-12T16:41:17.971921499+01:00","created_by":"daemon"}]}
{"id":"codex-4w8","title":"Implement Gemini CodeAssist quota status in /status","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-19T22:19:36.673883299+01:00","updated_at":"2025-12-27T11:25:37.760857998+01:00","closed_at":"2025-12-27T11:25:37.760857998+01:00"}
{"id":"codex-4w8.1","title":"Define GeminiQuota and ModelQuota structs in protocol","description":"Add GeminiQuota struct to RateLimitSnapshot in protocol/src/protocol.rs. Fields: model_quotas: Vec\u003cModelQuota\u003e. ModelQuota should have: model_id, remaining_amount, remaining_fraction, reset_time, token_type","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:44.036365391+01:00","updated_at":"2025-12-27T11:25:25.027237635+01:00","closed_at":"2025-12-27T11:25:25.027237635+01:00","dependencies":[{"issue_id":"codex-4w8.1","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:44.036765514+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.2","title":"Implement GeminiQuotaClient in core/src/quota/gemini.rs","description":"Create new module core/src/quota/gemini.rs. Implement GeminiQuotaClient that calls https://cloudcode-pa.googleapis.com/v1internal/retrieveUserQuota with OAuth token. Request: {project, userAgent}. Response: {buckets: [{remainingAmount, remainingFraction, resetTime, tokenType, modelId}]}. Return RateLimitSnapshot with gemini field populated.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:51.306184448+01:00","updated_at":"2025-12-27T11:25:31.474431236+01:00","closed_at":"2025-12-27T11:25:31.474431236+01:00","dependencies":[{"issue_id":"codex-4w8.2","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:51.306574052+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.3","title":"Integrate GeminiQuotaClient in TUI prefetch_rate_limits","description":"In tui/src/chatwidget.rs, update prefetch_rate_limits to handle ProviderKind::Gemini. Create GeminiQuotaClient using auth_manager and poll for quota data. Store result in self.rate_limits. Only works for OAuth users, not GEMINI_API_KEY users.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T22:19:59.170757703+01:00","updated_at":"2025-12-27T11:25:31.491045186+01:00","closed_at":"2025-12-27T11:25:31.491045186+01:00","dependencies":[{"issue_id":"codex-4w8.3","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:19:59.171150072+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-4w8.4","title":"Display Gemini quota in /status rate_limits section","description":"In tui/src/status/rate_limits.rs, update compose_rate_limit_data to handle RateLimitSnapshot.gemini field. Show per-model quota with remaining percentage and reset time. Format: 'gemini-2.5-flash: 75% remaining (resets in 2h 30m)'","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T22:20:06.697198418+01:00","updated_at":"2025-12-27T11:25:31.507391825+01:00","closed_at":"2025-12-27T11:25:31.507391825+01:00","dependencies":[{"issue_id":"codex-4w8.4","depends_on_id":"codex-4w8","type":"parent-child","created_at":"2025-12-19T22:20:06.697594504+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-56f","title":"Scope Gemini OAuth to providers requiring Code Assist","description":"resolve_gemini_credential always prefers stored Gemini OAuth tokens when gemini_account_count\u003e0, forcing all Gemini providers to use Code Assist endpoint and ignoring configured API keys. Public generative-language providers break after codex login --gemini. Adjust credential selection to only use OAuth for providers that explicitly require Code Assist and keep API-key providers on their configured bearer.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:19:48.565853205+01:00","updated_at":"2025-12-06T13:27:55.960118498+01:00","closed_at":"2025-12-06T13:27:55.960118498+01:00"}
{"id":"codex-5eu","title":"Subagent session viewer with /children command","description":"Add a /children slash command that opens a hierarchical picker to browse subagent sessions spawned from the current session. Selecting a subagent opens its transcript in a Ctrl+T style overlay.\n\n## Core Principle: REUSE EVERYTHING\nThis feature combines existing components - we are NOT building from scratch:\n1. **Resume picker UI** (tui/src/resume_picker.rs) → Copy and adapt for children picker\n2. **Transcript overlay** (tui/src/pager_overlay.rs) → Use as-is for viewing subagent history\n3. **Session listing** (core/src/rollout/list.rs) → Extend with parent_id filtering\n4. **Rollout loading** (core/src/rollout/recorder.rs) → Use get_rollout_history as-is\n\n## User Flow\n1. User types /children in chat\n2. Picker opens (like resume picker) showing direct children of current session\n3. User navigates:\n   - Up/Down: select session\n   - Right/l: drill into selected session's children\n   - Left/h/Backspace: go back to parent level\n   - Enter: view transcript of selected session\n   - q/Esc: close picker\n4. On Enter: TranscriptOverlay opens (exactly like Ctrl+T) showing subagent's full history\n\n## Key Components to Reuse\n| Need | Reuse From |\n|------|------------|\n| Picker UI layout | resume_picker.rs PickerState |\n| Session list rendering | resume_picker.rs render logic |\n| Transcript viewing | pager_overlay.rs TranscriptOverlay |\n| Session file scanning | rollout/list.rs list_conversations |\n| History loading | rollout/recorder.rs get_rollout_history |\n| HistoryCell conversion | Already exists in chatwidget for resume |\n\n## New Code Required\n1. parent_id field in SubAgentSource (protocol change)\n2. list_session_children() query function (filter by parent_id)\n3. children_picker.rs (copy resume_picker, add hierarchy navigation)\n4. /children slash command registration\n5. Glue code to connect picker → transcript overlay","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T23:10:54.49864669+01:00","updated_at":"2025-12-27T15:18:36.24715217+01:00","closed_at":"2025-12-27T15:18:36.24715217+01:00"}
{"id":"codex-5eu.1","title":"Add parent_id to SubAgentSource for session linkage","description":"Modify SubAgentSource in protocol/src/protocol.rs to include parent_id: ConversationId.\n\n## Why This Matters\nWithout parent_id, we cannot query 'which sessions are children of session X'. This is the foundation for the entire /children feature.\n\n## Current Code (protocol/src/protocol.rs)\n```rust\npub enum SubAgentSource {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\n## Target Code\n```rust\npub struct SubAgentSource {\n    pub parent_id: ConversationId,\n    pub agent_type: SubAgentType,\n}\n\npub enum SubAgentType {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\n## Files to Modify\n1. **protocol/src/protocol.rs**\n   - Change SubAgentSource from enum to struct\n   - Add SubAgentType enum\n   - Update SessionSource::SubAgent to use new struct\n\n2. **core/src/codex_delegate.rs** (run_codex_conversation_interactive)\n   - Currently passes: `SessionSource::SubAgent(SubAgentSource::Other(subagent_name.to_string()))`\n   - Change to: `SessionSource::SubAgent(SubAgentSource { parent_id: parent_session.id, agent_type: SubAgentType::Other(...) })`\n\n3. **core/src/codex.rs** \n   - Update any pattern matching on SubAgentSource\n\n4. **Search for all usages**: `rg 'SubAgentSource' --type rust`\n\n## Backward Compatibility\nOld rollout files won't have parent_id. The list_session_children query should handle missing parent_id gracefully (treat as no parent).","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-22T23:11:02.628152795+01:00","updated_at":"2025-12-27T14:47:45.088112042+01:00","closed_at":"2025-12-27T14:47:45.088112042+01:00","dependencies":[{"issue_id":"codex-5eu.1","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:02.628505174+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.1","depends_on_id":"codex-pkg","type":"discovered-from","created_at":"2025-12-22T23:11:02.629141104+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.2","title":"Add list_descendants query for session hierarchy","description":"Add a function to query direct children of a session by parent_id.\n\n## REUSE: core/src/rollout/list.rs\nThis file already has `list_conversations()` that scans session files. We extend it, not rewrite.\n\n## Existing Infrastructure to Reuse\n- `read_head_summary()` - already parses SessionMeta from rollout files\n- `HeadTailSummary` - already extracts source field\n- Directory scanning logic in `list_conversations()`\n- `ConversationItem` struct for results\n\n## New Function Signature\n```rust\n/// Returns direct children of the given parent session.\n/// Scans all session files and filters by parent_id in SessionMeta.\npub async fn list_session_children(\n    codex_home: \u0026Path,\n    parent_id: ConversationId,\n) -\u003e io::Result\u003cVec\u003cConversationItem\u003e\u003e\n```\n\n## Implementation Approach\n1. Extend `HeadTailSummary` to capture `parent_id: Option\u003cConversationId\u003e` from SubAgentSource\n2. Add helper to extract parent_id from SessionSource::SubAgent\n3. Scan sessions (reuse existing dir walking), filter where parent_id matches\n4. Return as Vec\u003cConversationItem\u003e (same type as list_conversations)\n\n## Why Not Pagination?\nFor children, we expect small numbers (tens, not thousands). Simple Vec return is fine. If needed later, can add pagination.\n\n## Key Files\n- core/src/rollout/list.rs - add list_session_children()\n- core/src/lib.rs - export new function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:10.042180818+01:00","updated_at":"2025-12-27T14:52:39.05587194+01:00","closed_at":"2025-12-27T14:52:39.05587194+01:00","dependencies":[{"issue_id":"codex-5eu.2","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:10.042558304+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.2","depends_on_id":"codex-5eu.1","type":"blocks","created_at":"2025-12-22T23:11:10.043274795+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.3","title":"Create children_picker.rs with hierarchical navigation","description":"Create tui/src/children_picker.rs by COPYING and ADAPTING tui/src/resume_picker.rs.\n\n## REUSE: tui/src/resume_picker.rs (1700+ lines)\nDO NOT write from scratch. Copy resume_picker.rs and modify:\n\n### What to Keep (copy as-is)\n- `PickerState` struct and its core logic\n- Rendering logic for session list (columns, styling)\n- Key handling for Up/Down/PageUp/PageDown/Home/End\n- Search/filter functionality\n- Background page loading infrastructure\n- All the test utilities\n\n### What to Modify\n1. **Data source**: Instead of `list_conversations()`, use `list_session_children(parent_id)`\n2. **Add hierarchy state**: Track current_parent_id and navigation stack\n3. **Add breadcrumb**: Show path like \"root \u003e finder \u003e rush\"\n4. **New keybindings**:\n   - Right/l: push current selection onto stack, load its children\n   - Left/h/Backspace: pop stack, go back to parent level\n5. **Return type**: `ChildrenSelection::ViewTranscript(PathBuf)` instead of Resume\n\n### New Return Type\n```rust\npub enum ChildrenSelection {\n    ViewTranscript(PathBuf),  // User pressed Enter - view this session's transcript\n    Exit,                      // User pressed q/Esc - cancelled\n}\n```\n\n### Hierarchy State\n```rust\nstruct HierarchyState {\n    /// Stack of parent IDs we've drilled into. Empty = showing root's children.\n    navigation_stack: Vec\u003cConversationId\u003e,\n    /// Current parent whose children we're showing.\n    current_parent_id: ConversationId,\n}\n```\n\n### Display Changes\n- Add 'Type' column showing: review, compact, finder, rush, oracle, etc.\n- Show child count indicator if session has children (so user knows they can drill in)\n\n## Files\n- tui/src/children_picker.rs - new file (copy from resume_picker.rs)\n- tui/src/lib.rs - add `mod children_picker;`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:21.361049252+01:00","updated_at":"2025-12-27T15:04:43.361648773+01:00","closed_at":"2025-12-27T15:04:43.361648773+01:00","dependencies":[{"issue_id":"codex-5eu.3","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:21.361381373+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.3","depends_on_id":"codex-5eu.2","type":"blocks","created_at":"2025-12-22T23:11:21.361904471+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.4","title":"Add /children slash command","description":"Register /children slash command and wire it to children_picker.\n\n## REUSE: Existing slash command infrastructure\nLook at how other slash commands are implemented in:\n- tui/src/slash_command.rs - SlashCommand enum and parsing\n- tui/src/app.rs - command handling\n\n## Step 1: Add to SlashCommand enum (tui/src/slash_command.rs)\n```rust\npub enum SlashCommand {\n    // ... existing variants ...\n    Children,  // NEW\n}\n```\n\n## Step 2: Add parsing\nIn the parsing logic (likely FromStr or parse function):\n```rust\n\"children\" =\u003e Some(SlashCommand::Children),\n```\n\n## Step 3: Handle in app.rs\nFind where slash commands are handled (search for SlashCommand:: matches).\nAdd:\n```rust\nSlashCommand::Children =\u003e {\n    // Get current session's conversation_id\n    let current_id = self.chat_widget.conversation_id();\n    if let Some(id) = current_id {\n        // Enter alt screen for picker\n        let _ = tui.enter_alt_screen();\n        \n        // Run the children picker (similar to resume picker flow)\n        match children_picker::run_children_picker(\n            tui,\n            \u0026self.config.codex_home,\n            id,\n        ).await? {\n            ChildrenSelection::ViewTranscript(path) =\u003e {\n                // Handle in next subtask (codex-5eu.5)\n            }\n            ChildrenSelection::Exit =\u003e {}\n        }\n        \n        // Leave alt screen\n        let _ = tui.leave_alt_screen();\n    } else {\n        // No active session - show error or do nothing\n    }\n}\n```\n\n## Reference: How /resume is handled\nSearch for `OpenResumePicker` or `run_resume_picker` in app.rs to see the pattern.\n\n## Files\n- tui/src/slash_command.rs - add Children variant\n- tui/src/app.rs - handle the command","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:28.794171096+01:00","updated_at":"2025-12-27T15:07:41.7852162+01:00","closed_at":"2025-12-27T15:07:41.7852162+01:00","dependencies":[{"issue_id":"codex-5eu.4","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:28.794698593+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.4","depends_on_id":"codex-5eu.3","type":"blocks","created_at":"2025-12-22T23:11:28.795821113+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.5","title":"Load and display subagent transcript in overlay","description":"Connect children_picker selection to TranscriptOverlay for viewing.\n\n## REUSE: Existing transcript overlay (tui/src/pager_overlay.rs)\nTranscriptOverlay already exists and works perfectly. We just need to:\n1. Load the selected subagent's rollout file\n2. Convert to HistoryCells\n3. Pass to TranscriptOverlay\n\n## REUSE: Rollout loading (core/src/rollout/recorder.rs)\n`RolloutRecorder::get_rollout_history(path)` already loads a rollout file into `InitialHistory`.\n\n## REUSE: HistoryCell conversion\nLook at how resumed sessions create HistoryCells. Search in:\n- tui/src/chatwidget.rs - how ChatWidget handles resumed history\n- tui/src/app.rs - ResumeSelection::Resume handling\n\n## Implementation Flow\nWhen user selects a session in children_picker and presses Enter:\n\n```rust\nChildrenSelection::ViewTranscript(path) =\u003e {\n    // 1. Load rollout (REUSE existing function)\n    let history = RolloutRecorder::get_rollout_history(\u0026path).await?;\n    \n    // 2. Convert RolloutItems to HistoryCells\n    // FIND existing conversion logic - likely in chatwidget or app\n    let cells: Vec\u003cArc\u003cdyn HistoryCell\u003e\u003e = convert_rollout_to_cells(history);\n    \n    // 3. Create and show overlay (REUSE TranscriptOverlay)\n    self.overlay = Some(Overlay::new_transcript(cells));\n}\n```\n\n## Key Question to Investigate\nHow does ChatWidget convert InitialHistory/RolloutItems to HistoryCells during resume?\nFind this code and reuse it. DO NOT reimplement.\n\n## Files\n- tui/src/app.rs - handle ChildrenSelection::ViewTranscript\n- Possibly extract helper if conversion logic is buried in ChatWidget","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:11:38.449584507+01:00","updated_at":"2025-12-27T15:12:55.122126787+01:00","closed_at":"2025-12-27T15:12:55.122126787+01:00","dependencies":[{"issue_id":"codex-5eu.5","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:38.449956613+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.5","depends_on_id":"codex-5eu.4","type":"blocks","created_at":"2025-12-22T23:11:38.463757343+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5eu.6","title":"Add tests for /children feature","description":"Add tests for the /children feature. Port test patterns from existing code.\n\n## REUSE: Test patterns from resume_picker.rs\nresume_picker.rs has extensive tests (~500 lines). Copy test structure:\n- PickerState unit tests\n- Navigation tests\n- Snapshot tests for UI rendering\n\n## Test Areas\n\n### 1. Protocol tests (protocol/src/)\n- SubAgentSource serialization/deserialization\n- Backward compat: old rollouts without parent_id\n\n### 2. list_session_children tests (core/src/rollout/tests.rs)\n```rust\n#[tokio::test]\nasync fn list_session_children_finds_direct_children() {\n    // Create temp dir with mock rollout files\n    // One parent session, two child sessions with parent_id\n    // Verify list_session_children returns exactly the children\n}\n\n#[tokio::test]\nasync fn list_session_children_excludes_grandchildren() {\n    // Parent -\u003e Child -\u003e Grandchild\n    // list_session_children(parent) should return only Child, not Grandchild\n}\n\n#[tokio::test]  \nasync fn list_session_children_handles_missing_parent_id() {\n    // Old rollout file without parent_id\n    // Should not crash, should not be included in results\n}\n```\n\n### 3. children_picker tests (tui/src/children_picker.rs)\nCopy test structure from resume_picker.rs:\n- Navigation state tests\n- Hierarchy drill-down/up tests\n- Key handling tests\n- Snapshot tests for rendering\n\n### 4. Integration test (if feasible)\n- Spawn subagent, verify parent_id in rollout file\n- May be complex due to full Codex setup required\n\n## Files\n- protocol/src/protocol.rs - add serde tests for SubAgentSource\n- core/src/rollout/tests.rs - list_session_children tests\n- tui/src/children_picker.rs - picker tests (in same file, like resume_picker)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-22T23:11:45.405880895+01:00","updated_at":"2025-12-27T15:18:28.808451762+01:00","closed_at":"2025-12-27T15:18:28.808451762+01:00","dependencies":[{"issue_id":"codex-5eu.6","depends_on_id":"codex-5eu","type":"parent-child","created_at":"2025-12-22T23:11:45.406207045+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-5eu.6","depends_on_id":"codex-5eu.5","type":"blocks","created_at":"2025-12-22T23:11:45.406803971+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-5qi","title":"Antigravity provider should not require project id","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-07T11:30:15.058435632+01:00","updated_at":"2025-12-07T11:41:06.66799857+01:00","closed_at":"2025-12-07T11:41:06.66799857+01:00"}
{"id":"codex-5t2","title":"Make config.toml deserialization strict with deny_unknown_fields","description":"## Problem\n\nCurrently `ConfigToml` and related structs silently ignore unknown fields in config.toml. This means typos or deprecated fields go unnoticed, leading to user confusion when settings don't take effect.\n\n## Solution\n\nAdd `#[serde(deny_unknown_fields)]` to `ConfigToml` and all nested config structs to fail fast on unrecognized fields.\n\n## Files to modify\n\n- `core/src/config/mod.rs`: Add `#[serde(deny_unknown_fields)]` to `ConfigToml` struct\n- `core/src/config/types.rs`: Add to nested structs like `ShellEnvironmentPolicyToml`, `McpServerConfig`, `OtelConfigToml`, `Tui`, `Notifications`, `History`, etc.\n- `core/src/config/profile.rs`: Add to `ConfigProfile` if applicable\n- `core/src/features.rs`: Add to `FeaturesToml` if applicable\n\n## Implementation\n\n### 1. ConfigToml (core/src/config/mod.rs)\n\n```rust\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]  // ADD THIS\npub struct ConfigToml {\n    // ...\n}\n```\n\n### 2. Nested structs\n\nFind all structs that derive `Deserialize` and are used in config:\n```bash\nrg \"#\\[derive.*Deserialize\" core/src/config --type rust\n```\n\nAdd `#[serde(deny_unknown_fields)]` to each.\n\n## Caveats\n\n- **`#[serde(flatten)]` is incompatible with `deny_unknown_fields`** - if a struct uses `flatten`, you cannot use `deny_unknown_fields` on the parent. Check for this pattern and handle accordingly.\n- Some structs may use `#[serde(untagged)]` which also has interactions - test carefully.\n\n## Testing\n\n1. Create a config.toml with a typo field like `modle = \"gpt-4o\"`\n2. Run codex and verify it fails with a clear error message mentioning the unknown field\n3. Fix the typo and verify it loads successfully\n\n## Error message quality\n\nThe error should be user-friendly, e.g.:\n```\nError loading config.toml: unknown field `modle`, expected one of `model`, `model_provider`, ...\n```","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T00:56:38.453822001+01:00","updated_at":"2025-12-24T01:47:26.215126585+01:00","closed_at":"2025-12-24T01:47:26.215131544+01:00"}
{"id":"codex-5v9","title":"Subagent SessionSource always hardcoded to 'review'","description":"## Problem\nIn `core/src/codex_delegate.rs:54`, the session source is hardcoded:\n```rust\nSessionSource::SubAgent(SubAgentSource::Review),\n```\n\nThis means ALL subagent sessions (rush, finder, oracle, general, etc.) are recorded as 'review' in their rollout metadata.\n\n## Impact\n- Can't tell which subagent type was used from the rollout file\n- Misleading metadata in session files\n\n## Fix\nPass the actual subagent type to `run_codex_conversation_interactive()` and use it when constructing `SessionSource::SubAgent()`.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-22T22:49:24.601095044+01:00","updated_at":"2025-12-22T23:02:12.6258385+01:00","closed_at":"2025-12-22T23:02:12.625845965+01:00"}
{"id":"codex-60v","title":"Fix fragile patch parsing with filenames containing spaces","description":"## Problem\n`WorktreeManager::parse_numstat_from_patch` uses `split_whitespace` to parse paths from `diff --git` headers. This incorrectly splits filenames containing spaces, resulting in truncated or invalid paths.\n\n## Solution\nIn `merge_pending_patches` (patch_merger.rs), use `p.diff.files_changed` which is already correctly parsed from `git diff --numstat` instead of the result from `apply_patch`.\n\n## Files\n- core/src/patch_merger.rs - use p.diff.files_changed\n- core/src/worktree_manager.rs - can remove parse_numstat_from_patch if no longer needed","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:18.955836089+01:00","updated_at":"2025-12-21T19:01:28.225151993+01:00","closed_at":"2025-12-21T19:01:28.225151993+01:00"}
{"id":"codex-61f","title":"Loop detector incorrectly flags write_stdin polling as loop","description":"**Problem:**\nWhen monitoring long-running processes, the agent uses `write_stdin` with empty `chars` to poll for output. After 5 identical calls (TOOL_CALL_THRESHOLD), the loop detector triggers `ConsecutiveIdenticalToolCalls` and aborts the turn.\n\n**Root cause:**\n`loop_detector.rs` hashes tool name + args. Polling calls look identical:\n- name: `write_stdin`\n- args: `{\"session_id\": X, \"chars\": \"\", \"yield_time_ms\": Y}`\n\n**Example from real session:**\nAgent was processing 87 items, reporting progress at each poll. Got to 63/87 before loop detection aborted it.\n\n**Proposed fix:**\nExclude `write_stdin` with empty `chars` from consecutive tool detection since it's a legitimate polling pattern. The key insight is that the OUTPUT varies (new process output each time), even though the INPUT is identical.\n\n**Files:**\n- `core/src/loop_detector.rs` - `check_tool_call` method\n- `core/tests/suite/loop_detection.rs` - add test for write_stdin polling","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-05T11:20:41.851317832+01:00","updated_at":"2026-01-05T12:22:14.901597716+01:00","closed_at":"2026-01-05T12:22:14.901597716+01:00"}
{"id":"codex-64j","title":"Shared MCP connection manager and lazy MCP initialization","description":"Refactor MCP so connections are shared, lazily initialized per server, and no longer block session or subagent startup. Sessions and tools should treat MCP as an optional, per-server resource with explicit readiness, and the TUI should surface server status without delaying conversation flow.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-11T00:41:05.704146041+01:00","updated_at":"2025-12-11T01:08:13.833574857+01:00","closed_at":"2025-12-11T01:08:13.833574857+01:00"}
{"id":"codex-64j.1","title":"Harden and document MCP behavior (errors, timeouts, tests)","description":"Add tests and docs for the new MCP lifecycle: per-server lazy init, shared connections, and explicit readiness. Cover success, timeout, and failure paths, including what the model sees when a server is still starting or permanently failed. Update docs/config.md (MCP section) to describe the new behavior and any user-facing status messages.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.198131799+01:00","updated_at":"2025-12-11T01:08:10.029185972+01:00","closed_at":"2025-12-11T01:08:10.029185972+01:00","dependencies":[{"issue_id":"codex-64j.1","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.198413878+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.2","title":"Optimize subagent behavior with shared MCP clients","description":"Change subagent sessions to reuse the shared McpConnectionManager instead of reinitializing MCP per subagent. Ensure subagents pay zero MCP startup cost unless they actually invoke MCP tools, and verify that authorization/env isolation is handled via per-request metadata rather than redundant connections.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.21135687+01:00","updated_at":"2025-12-11T01:08:05.48787264+01:00","closed_at":"2025-12-11T01:08:05.48787264+01:00","dependencies":[{"issue_id":"codex-64j.2","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.211663315+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.3","title":"Add explicit MCP readiness and status to tool calls and TUI","description":"Plumb MCP server status into events so that the TUI can show per-server startup state (starting/ready/failed) without blocking the session. Update MCP tool handlers to surface clean, typed errors on not-ready/failed servers, and adjust the TUI to render these as actionable messages rather than generic tool failures.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.225203698+01:00","updated_at":"2025-12-11T01:08:00.743117603+01:00","closed_at":"2025-12-11T01:08:00.743117603+01:00","dependencies":[{"issue_id":"codex-64j.3","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.225523038+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.4","title":"Make MCP initialization lazy and per-server","description":"Remove the global upfront initialize() call from Session::new. Instead, have the MCP tool handler (and any direct users) call ensure_started(server) and wait_ready(server, timeout) before a tool call. Only initialize servers that are actually requested in a session, and ensure error paths are well-defined when a server is disabled or fails to connect.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.239103688+01:00","updated_at":"2025-12-11T01:07:56.428050943+01:00","closed_at":"2025-12-11T01:07:56.428050943+01:00","dependencies":[{"issue_id":"codex-64j.4","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.239380357+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-64j.5","title":"Refactor McpConnectionManager into a shared, process-wide manager","description":"Move MCP connection management out of individual sessions into a shared McpConnectionManager that lives for the process (or workspace). Expose APIs to get or start a client per server (by name), track per-server status (NotConfigured/Pending/Connecting/Ready/Failed), and ensure configuration (McpServerConfig, OAuth store mode) is passed in cleanly without coupling to Session internals.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:41:16.251475348+01:00","updated_at":"2025-12-11T00:57:16.308717259+01:00","closed_at":"2025-12-11T00:57:16.308717259+01:00","dependencies":[{"issue_id":"codex-64j.5","depends_on_id":"codex-64j","type":"parent-child","created_at":"2025-12-11T00:41:16.251993197+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-669","title":"Fix P2: Ensure worktree cleanup on all error paths","description":"## Problem\nAfter worktree creation, several error paths don't cleanup the worktree:\n- If `submit` fails\n- If `next_event` returns error\n- Other early returns after worktree exists\n\nThis leaves orphaned worktrees in `~/.codex/agents/`.\n\n## Solution\nWrap the execution logic in an async block. Handle cleanup in the error path.\n\n## Implementation\n\nIn `core/src/tools/handlers/task.rs`, refactor the `TaskHandler::handle` method:\n\n### Step 1: After worktree creation, wrap everything in async block\n\nFind where `worktree_handle` is created. The code after that should be wrapped:\n\n```rust\nlet worktree_handle = worktree_manager\n    .create_worktree(\u0026parent_worktree)\n    .await\n    .map_err(|e| { ... })?;\n\nlet effective_cwd = worktree_handle.path.clone();\n\n// Wrap all remaining logic in async block\nlet execution_result: Result\u003cPendingSubagentResult, FunctionCallError\u003e = async {\n    // ... all the session creation, event loop, diff generation ...\n    // Return Ok(pending_result) on success\n    // Return Err(e) on any failure\n}.await;\n\n// Handle result with cleanup on error\nmatch execution_result {\n    Ok(pending) =\u003e {\n        invocation.session.pending_subagent_results.lock().await.push(pending);\n        \n        let response = serde_json::json!({\n            \"result\": pending.result,\n            \"session_id\": pending.session_id,\n            \"last_tool_output\": pending.last_tool_output,\n            \"changes\": \"pending\",\n        });\n        \n        Ok(ToolOutput::Function {\n            success: Some(true),\n            content: response.to_string(),\n            content_items: None,\n        })\n    }\n    Err(e) =\u003e {\n        // Cleanup on ANY error\n        let _ = worktree_manager.cleanup(\u0026worktree_handle).await;\n        Err(e)\n    }\n}\n```\n\n### Step 2: Remove explicit cleanup calls inside the async block\n\nThe current code has explicit cleanup in:\n- TurnAborted handler\n- generate_diff error handler\n\nRemove these - the outer match will handle cleanup.\n\n### Step 3: Ensure PendingSubagentResult contains worktree_handle\n\nThe pending result must own the worktree_handle so it can be cleaned up during merge.\n\nMake sure the async block returns the full PendingSubagentResult including worktree_handle.\n\n## Notes\n- The worktree_handle needs to be accessible both inside the async block (for building PendingSubagentResult) and outside (for error cleanup)\n- You may need to clone it or restructure slightly\n- The key is: on ANY error after worktree creation, cleanup must happen\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T18:23:10.141038222+01:00","updated_at":"2025-12-21T18:33:05.236369772+01:00","closed_at":"2025-12-21T18:33:05.236369772+01:00"}
{"id":"codex-6kk","title":"Provider-agnostic quota support for /status (Antigravity + ChatGPT)","description":"## Problem\n\nThe TUI `/status` command currently only works with ChatGPT's rate limit API. Antigravity users need quota visibility too.\n\n## Solution\n\nUnify how Codex fetches and displays model usage quotas across providers, starting with ChatGPT and Antigravity.\n\n## Reference Implementation\n\nBased on analysis of `third-party/AntigravityQuota` VS Code extension:\n\n### Process Discovery (process_finder.ts)\n- Find running `language_server_linux_x64` (or platform variant) process via:\n  - Linux: `pgrep -af language_server_linux_x64`\n  - macOS: `pgrep -fl language_server_macos` (or `_arm` variant)\n  - Windows: PowerShell `Get-CimInstance Win32_Process`\n- Parse command line args to extract:\n  - `--csrf_token \u003cuuid\u003e` (required for auth)\n  - `--extension_server_port \u003cport\u003e` (optional, may differ from connect port)\n- Get listening ports: `lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e` or `ss -tlnp`\n- Test each port with HTTPS POST to find working endpoint\n\n### API Call (quota_manager.ts)\n- Endpoint: `POST https://127.0.0.1:\u003cport\u003e/exa.language_server_pb.LanguageServerService/GetUserStatus`\n- Headers:\n  - `Content-Type: application/json`\n  - `Connect-Protocol-Version: 1`\n  - `X-Codeium-Csrf-Token: \u003ccsrf_token\u003e`\n- Body: `{\"metadata\": {\"ideName\": \"codex\", \"extensionName\": \"codex\", \"locale\": \"en\"}}`\n- TLS: Skip certificate verification (`rejectUnauthorized: false`)\n- Timeout: 5 seconds\n\n### Response Structure (types.ts)\n```typescript\ninterface server_user_status_response {\n  userStatus: {\n    name: string;\n    email: string;\n    planStatus?: {\n      planInfo: {\n        teamsTier: string;\n        planName: string;\n        monthlyPromptCredits: number;\n        monthlyFlowCredits: number;\n      };\n      availablePromptCredits: number;\n      availableFlowCredits: number;\n    };\n    cascadeModelConfigData?: {\n      clientModelConfigs: [{\n        label: string;\n        modelOrAlias: { model: string };\n        quotaInfo?: {\n          remainingFraction?: number;  // 0.0-1.0\n          resetTime: string;           // ISO timestamp\n        };\n      }];\n    };\n  };\n}\n```\n\n### Quota Parsing\n- **Prompt credits**: `availablePromptCredits / monthlyPromptCredits` → used percentage\n- **Per-model quotas**: `remainingFraction * 100` → remaining percentage, parse `resetTime` for countdown\n\n## Success Criteria\n- `/status` shows quota info for both ChatGPT and Antigravity providers\n- Graceful handling when language_server not running\n- No blocking of main turn loop","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-11T00:59:44.83405989+01:00","updated_at":"2026-01-04T13:24:07.979732983+01:00","closed_at":"2026-01-04T13:24:07.979732983+01:00"}
{"id":"codex-6kk.1","title":"Add tests and docs for provider quota integration","description":"## What\n\nAdd tests and documentation for the provider quota integration.\n\n## Tests Required\n\n### Unit Tests (core)\n\n1. **Antigravity response parsing**\n   - Valid response with all fields\n   - Response missing `planStatus`\n   - Response missing `cascadeModelConfigData`\n   - Empty `clientModelConfigs` array\n\n2. **Quota mapping**\n   - Credits calculation (used percentage)\n   - Model quota with `remainingFraction`\n   - Reset time parsing (ISO 8601)\n   - Most restrictive model selection\n\n3. **Process discovery mocking**\n   - Mock `pgrep` output parsing\n   - CSRF token extraction from command line\n   - Port list parsing from `lsof`/`ss`\n\n### Integration Tests (TUI)\n\n1. **Snapshot tests for status card**\n   - ChatGPT rate limits display\n   - Antigravity quota display\n   - No quota available display\n\n2. **Background fetch behavior**\n   - Quota fetch doesn't block UI\n   - Stale data handling\n   - Error state handling\n\n## Documentation Updates\n\n### docs/config.md\n\nAdd section:\n```markdown\n## Provider Quotas\n\nThe `/status` command shows your current usage limits for supported providers:\n\n### ChatGPT\nDisplays primary and secondary rate limit windows from the ChatGPT API.\n\n### Antigravity\nDisplays prompt credits and per-model quotas. Requires the Antigravity\nlanguage server to be running (automatically started by the Antigravity\nVS Code extension or Windsurf).\n\n**Troubleshooting:**\n- \"Quota unavailable\": Language server not running\n- \"No CSRF token\": Try restarting Antigravity\n```\n\n### docs/status.md (if exists)\n\nDocument the `/status` command output format for each provider.\n\n## Acceptance\n\n- All unit tests pass\n- Snapshot tests for status card rendering\n- Documentation explains provider differences\n- Troubleshooting guide for common issues","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.344454208+01:00","updated_at":"2026-01-04T13:24:09.392735419+01:00","closed_at":"2026-01-04T13:24:09.392735419+01:00","dependencies":[{"issue_id":"codex-6kk.1","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.344812683+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.2","title":"Wire provider quotas into TUI /status for ChatGPT and Antigravity","description":"## What\n\nWire the provider-agnostic quota API into TUI's `/status` command.\n\n## Current Implementation\n\nIn `tui/src/rate_limits.rs`:\n- `fetch_rate_limits()` is ChatGPT-specific\n- Called via `AppEvent::RateLimitSnapshotFetched`\n- Renders in status card widget\n\n## Changes Required\n\n### 1. Replace direct ChatGPT call with trait-based dispatch\n\n```rust\n// Before\nlet snapshot = fetch_rate_limits(\u0026auth).await;\n\n// After\nif let Some(client) = create_quota_client(\u0026config) {\n    let snapshot = client.fetch_quota().await;\n    // ...\n}\n```\n\n### 2. Update status card rendering\n\nRemove any ChatGPT-specific language:\n- \"ChatGPT Rate Limits\" → \"Rate Limits\" or \"{Provider} Quotas\"\n- Handle new `credits` field for Antigravity\n\n### 3. Background fetch pattern\n\n```rust\nfn spawn_quota_fetch(\u0026self) {\n    let config = self.config.clone();\n    tokio::spawn(async move {\n        if let Some(client) = create_quota_client(\u0026config) {\n            match client.fetch_quota().await {\n                Some(snapshot) =\u003e {\n                    tx.send(AppEvent::RateLimitSnapshotFetched(snapshot)).await;\n                }\n                None =\u003e {\n                    // Optionally send error event\n                }\n            }\n        }\n    });\n}\n```\n\n### 4. Handle missing quota support\n\nWhen provider doesn't support quotas:\n- Show \"Quota info not available for {provider}\" in status card\n- Don't show error, just informational message\n\n## Status Card Display\n\nFor Antigravity, show:\n```\n╭─ Antigravity Quotas ─────────────────────────────────────────────╮\n│ Prompt Credits: 750 / 1000 (25% used)                            │\n│ Model Quota: 80% remaining (resets in 2h 30m)                    │\n╰──────────────────────────────────────────────────────────────────╯\n```\n\nFor ChatGPT, show existing format:\n```\n╭─ ChatGPT Rate Limits ────────────────────────────────────────────╮\n│ Primary: 45% used (resets in 15m)                                │\n│ Secondary: 12% used (resets in 1h)                               │\n╰──────────────────────────────────────────────────────────────────╯\n```\n\n## Acceptance\n\n- /status works for ChatGPT (existing behavior preserved)\n- /status works for Antigravity (shows credits + model quota)\n- Graceful fallback when quota unavailable\n- No hardcoded provider names in generic code paths","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.35852021+01:00","updated_at":"2025-12-12T23:03:54.2876507+01:00","closed_at":"2025-12-12T23:03:54.2876507+01:00","dependencies":[{"issue_id":"codex-6kk.2","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.358836664+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.3","title":"Design provider-agnostic quota API in core","description":"## What\n\nDesign a provider-neutral quota abstraction in codex-core that both ChatGPT and Antigravity (and future providers) can implement.\n\n## Proposed API\n\n```rust\n/// Trait for fetching quota/rate-limit info from a provider\n#[async_trait]\npub trait ProviderQuotaClient: Send + Sync {\n    /// Fetch current quota snapshot. Returns None if unavailable.\n    async fn fetch_quota(\u0026self) -\u003e Option\u003cRateLimitSnapshot\u003e;\n    \n    /// Human-readable provider name for error messages\n    fn provider_name(\u0026self) -\u003e \u0026'static str;\n}\n\n/// Factory to get the right client based on current auth/config\npub fn create_quota_client(config: \u0026Config) -\u003e Option\u003cBox\u003cdyn ProviderQuotaClient\u003e\u003e {\n    match \u0026config.model_provider {\n        ModelProvider::OpenAI if config.auth.is_chatgpt() =\u003e {\n            Some(Box::new(ChatGptQuotaClient::new(\u0026config.auth)))\n        }\n        ModelProvider::Antigravity =\u003e {\n            Some(Box::new(AntigravityQuotaClient::new()))\n        }\n        _ =\u003e None  // Provider doesn't support quota fetching\n    }\n}\n```\n\n## Existing ChatGPT Implementation\n\nCurrently in `tui/src/rate_limits.rs`:\n- `fetch_rate_limits()` makes HTTP call to ChatGPT API\n- Returns `RateLimitSnapshot` with primary/secondary windows\n\nThis should be wrapped in a `ChatGptQuotaClient` that implements the trait.\n\n## Behavior Requirements\n\n1. **Async-only**: All quota fetching is async, never blocks\n2. **Timeout**: Each provider should timeout within 5-10 seconds\n3. **Graceful failures**: Return `None` on any error, don't panic\n4. **Caching**: Consider caching results for a short period (e.g., 30s)\n5. **No blocking main loop**: TUI should spawn quota fetch in background\n\n## Discovery Logic\n\n```rust\nfn detect_provider(config: \u0026Config) -\u003e Option\u003cBox\u003cdyn ProviderQuotaClient\u003e\u003e {\n    // Priority:\n    // 1. Explicit model_provider setting\n    // 2. API base URL heuristics\n    // 3. Auth mode (ChatGPT auth implies OpenAI)\n    \n    if config.model_provider == ModelProvider::Antigravity {\n        return Some(Box::new(AntigravityQuotaClient::new()));\n    }\n    \n    if config.auth.is_chatgpt() {\n        return Some(Box::new(ChatGptQuotaClient::new(\u0026config.auth)));\n    }\n    \n    None\n}\n```\n\n## Acceptance\n\n- Trait defined in core with clear contract\n- ChatGPT client refactored to implement trait\n- Factory function picks correct client\n- No changes to TUI layer yet (that's codex-6kk.2)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.37383815+01:00","updated_at":"2025-12-12T22:52:54.929637164+01:00","closed_at":"2025-12-12T22:52:54.929637164+01:00","dependencies":[{"issue_id":"codex-6kk.3","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.374196324+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.4","title":"Implement Antigravity quota client using GetUserStatus","description":"## What\n\nImplement `AntigravityQuotaClient` in codex-core that discovers the local Antigravity language_server and fetches quota info.\n\n## Process Discovery (from AntigravityQuota/process_finder.ts)\n\n### Step 1: Find the process\n```rust\n// Platform-specific process discovery\n#[cfg(target_os = \"linux\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: pgrep -af language_server_linux_x64\n    // Parse output: \"\u003cpid\u003e /path/to/language_server_linux_x64 --csrf_token \u003ctoken\u003e ...\"\n    // Return (pid, command_line)\n}\n\n#[cfg(target_os = \"macos\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: pgrep -fl language_server_macos (or _arm for ARM)\n    // Same parsing\n}\n\n#[cfg(target_os = \"windows\")]\nfn find_language_server() -\u003e Result\u003c(u32, String)\u003e {\n    // Run: powershell Get-CimInstance Win32_Process -Filter \"name='language_server_windows_x64.exe'\"\n    // Parse JSON output\n}\n```\n\n### Step 2: Extract CSRF token from command line\n```rust\nfn parse_csrf_token(cmd: \u0026str) -\u003e Option\u003cString\u003e {\n    // Regex: --csrf_token[=\\s]+([a-f0-9\\-]+)\n}\n```\n\n### Step 3: Find listening ports\n```rust\nfn get_listening_ports(pid: u32) -\u003e Vec\u003cu16\u003e {\n    // Linux: ss -tlnp | grep \"pid=\u003cpid\u003e\" OR lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e\n    // macOS: lsof -iTCP -sTCP:LISTEN -n -P -p \u003cpid\u003e\n    // Windows: PowerShell Get-NetTCPConnection -OwningProcess \u003cpid\u003e -State Listen\n}\n```\n\n### Step 4: Test ports to find working endpoint\n```rust\nasync fn find_working_port(ports: \u0026[u16], csrf_token: \u0026str) -\u003e Option\u003cu16\u003e {\n    // For each port, POST to /exa.language_server_pb.LanguageServerService/GetUnleashData\n    // Return first port that responds with 200\n}\n```\n\n## API Call (from AntigravityQuota/quota_manager.ts)\n\n```rust\nasync fn fetch_quota(port: u16, csrf_token: \u0026str) -\u003e Result\u003cServerUserStatusResponse\u003e {\n    let client = reqwest::Client::builder()\n        .danger_accept_invalid_certs(true)  // Self-signed cert\n        .timeout(Duration::from_secs(5))\n        .build()?;\n    \n    client.post(format!(\"https://127.0.0.1:{port}/exa.language_server_pb.LanguageServerService/GetUserStatus\"))\n        .header(\"Content-Type\", \"application/json\")\n        .header(\"Connect-Protocol-Version\", \"1\")\n        .header(\"X-Codeium-Csrf-Token\", csrf_token)\n        .json(\u0026json!({\n            \"metadata\": {\n                \"ideName\": \"codex\",\n                \"extensionName\": \"codex\",\n                \"locale\": \"en\"\n            }\n        }))\n        .send()\n        .await?\n        .json()\n        .await\n}\n```\n\n## Response Types\n\n```rust\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct ServerUserStatusResponse {\n    user_status: UserStatus,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct UserStatus {\n    name: String,\n    email: String,\n    plan_status: Option\u003cPlanStatus\u003e,\n    cascade_model_config_data: Option\u003cCascadeModelConfigData\u003e,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct PlanStatus {\n    plan_info: PlanInfo,\n    available_prompt_credits: i64,\n    available_flow_credits: i64,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct PlanInfo {\n    teams_tier: String,\n    plan_name: String,\n    monthly_prompt_credits: i64,\n    monthly_flow_credits: i64,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct CascadeModelConfigData {\n    client_model_configs: Vec\u003cClientModelConfig\u003e,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct ClientModelConfig {\n    label: String,\n    model_or_alias: Option\u003cModelOrAlias\u003e,\n    quota_info: Option\u003cQuotaInfo\u003e,\n}\n\n#[derive(Deserialize)]\nstruct ModelOrAlias {\n    model: String,\n}\n\n#[derive(Deserialize)]\n#[serde(rename_all = \"camelCase\")]\nstruct QuotaInfo {\n    remaining_fraction: Option\u003cf64\u003e,  // 0.0-1.0\n    reset_time: String,               // ISO timestamp\n}\n```\n\n## Error Handling\n\nReturn `None` (not panic) when:\n- Language server process not running\n- CSRF token not found in command line\n- No listening ports found\n- Connection refused/timeout\n- Invalid JSON response\n\n## Acceptance\n\n- Works on Linux, macOS, Windows\n- Fetches quota within 5 seconds\n- Returns `None` gracefully on any failure\n- Unit tests with mocked responses","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.389404355+01:00","updated_at":"2025-12-12T22:52:54.90518871+01:00","closed_at":"2025-12-12T22:52:54.90518871+01:00","dependencies":[{"issue_id":"codex-6kk.4","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.389727001+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6kk.5","title":"Extend RateLimitSnapshot mapping for Antigravity-specific fields","description":"## What\n\nMap Antigravity's `GetUserStatus` response into Codex's existing `RateLimitSnapshot` and `CreditsSnapshot` models.\n\n## Antigravity Response Fields\n\nFrom `server_user_status_response`:\n- `userStatus.planStatus.availablePromptCredits` - credits remaining\n- `userStatus.planStatus.planInfo.monthlyPromptCredits` - credits total\n- `userStatus.cascadeModelConfigData.clientModelConfigs[].quotaInfo.remainingFraction` - 0.0-1.0\n- `userStatus.cascadeModelConfigData.clientModelConfigs[].quotaInfo.resetTime` - ISO timestamp\n\n## Mapping Strategy\n\n### Prompt Credits → CreditsSnapshot\n```rust\nCreditsSnapshot {\n    available: available_prompt_credits,\n    total: monthly_prompt_credits,\n    used_percent: ((monthly - available) / monthly) * 100.0,\n}\n```\n\n### Per-Model Quotas → RateLimitSnapshot\n\nThe existing `RateLimitSnapshot` has `primary_window` and `secondary_window` for ChatGPT's two rate limit tiers. For Antigravity, we can either:\n\n**Option A**: Use `primary_window` for the \"most restrictive\" model quota\n**Option B**: Add a new `model_quotas: HashMap\u003cString, ModelQuota\u003e` field\n\nRecommend Option A for simplicity:\n```rust\n// Find the model with lowest remainingFraction\nlet most_limited = configs.iter()\n    .filter_map(|c| c.quota_info.as_ref())\n    .min_by(|a, b| a.remaining_fraction.partial_cmp(\u0026b.remaining_fraction).unwrap());\n\nRateLimitSnapshot {\n    primary_window: RateLimitWindow {\n        used_percent: (1.0 - remaining_fraction) * 100.0,\n        reset_at: parse_iso_timestamp(reset_time),\n        limit: None,  // Antigravity doesn't expose absolute limits\n        remaining: None,\n    },\n    secondary_window: None,\n    credits: Some(credits_snapshot),\n}\n```\n\n## Time Formatting\n\nAntigravity's `resetTime` is ISO 8601 (e.g., `2025-01-15T00:00:00Z`). Convert to:\n- `reset_at: chrono::DateTime\u003cUtc\u003e`\n- For display: \"Resets in 2h 30m\" or \"Resets at midnight\"\n\n## Unit Tests\n\n```rust\n#[test]\nfn test_antigravity_quota_mapping() {\n    let response = serde_json::from_str::\u003cServerUserStatusResponse\u003e(r#\"{\n        \"userStatus\": {\n            \"planStatus\": {\n                \"planInfo\": { \"monthlyPromptCredits\": 1000 },\n                \"availablePromptCredits\": 750\n            },\n            \"cascadeModelConfigData\": {\n                \"clientModelConfigs\": [{\n                    \"label\": \"Claude 3.5\",\n                    \"quotaInfo\": { \"remainingFraction\": 0.8, \"resetTime\": \"2025-01-15T00:00:00Z\" }\n                }]\n            }\n        }\n    }\"#).unwrap();\n    \n    let snapshot = map_to_rate_limit_snapshot(\u0026response);\n    assert_eq!(snapshot.credits.unwrap().used_percent, 25.0);\n    assert_eq!(snapshot.primary_window.used_percent, 20.0);\n}\n```\n\n## Acceptance\n\n- Mapping preserves ChatGPT compatibility (existing fields still work)\n- Credits shown in /status card\n- Per-model quota shown as primary window\n- Reset time displayed correctly","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-11T00:59:54.405867483+01:00","updated_at":"2025-12-12T22:52:54.917725294+01:00","closed_at":"2025-12-12T22:52:54.917725294+01:00","dependencies":[{"issue_id":"codex-6kk.5","depends_on_id":"codex-6kk","type":"parent-child","created_at":"2025-12-11T00:59:54.406326319+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m1","title":"Fix unbounded memory growth in subagent sessions","description":"## Problem\nSubagentSession objects are stored in the subagent_sessions map and never removed. A long-running parent session that spawns many tasks will accumulate unbounded SubagentSession objects.\n\n## Analysis\nThis is a trade-off - sessions are kept for potential reuse. However, most subagents are not reused (each task() call creates a new session by default).\n\n## Options\n1. Add TTL-based cleanup for unused sessions\n2. Limit max sessions and evict LRU\n3. Mark as acceptable - sessions are relatively small and bounded by the conversation length\n\nFor now, mark as won't fix - this is acceptable in practice.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T19:17:33.577211174+01:00","updated_at":"2025-12-21T19:17:38.965785657+01:00","closed_at":"2025-12-21T19:17:38.965785657+01:00"}
{"id":"codex-6m2","title":"Turn-aware compaction","description":"## Problem\nCurrent compaction (in core/src/compact.rs) uses a state-reset strategy that loses assistant reasoning:\n- Only keeps: [InitialContext] + [UserMessages] + [Summary]\n- Discards all assistant messages, tool calls, and tool results\n- Not turn-aware - just extracts user message text\n\n## Solution: Turn-Aware Sliding Window\nKeep full recent conversation turns within token budget:\n- [InitialContext] + [Summary] + [LastNTurns with User+Assistant+Tools]\n- Never split ToolCall from ToolResult\n- Summarize everything before the cut point\n\n## Key Structures\n\n```rust\nstruct Turn {\n    items: Vec\u003cResponseItem\u003e,  // All items in this turn\n    token_count: usize,        // Cached approximate count\n}\n```\n\n## Algorithm\n1. `identify_turns(\u0026history)` - Group items by user messages\n2. `select_turns_within_budget(turns, budget)` - Walk backwards, keep complete turns\n3. Assemble: [InitialContext] + [Summary] + [KeptTurns.flatten()]\n\n## Turn Definition\n- Starts at ResponseItem::Message { role: \"user\", .. }\n- Includes all subsequent items until next user message\n- GhostSnapshots attach to their preceding turn\n- Consecutive user messages = separate turns\n\n## Budget Calculation\n```rust\nlet available = context_window\n    - system_prompt_tokens\n    - 1000  // summary reservation\n    - (context_window * 0.1);  // 10% safety buffer\n```\n\n## Files\n- core/src/compact.rs - Main implementation","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-01T12:00:37.620159403+01:00","updated_at":"2026-01-01T12:48:32.389988289+01:00","closed_at":"2026-01-01T12:48:32.389990984+01:00"}
{"id":"codex-6m2.1","title":"Add Turn struct and identify_turns function","description":"## Task\nAdd Turn struct and identify_turns function to core/src/compact.rs.\n\n## Implementation\n\n```rust\n/// A complete conversation turn starting with a user message.\n#[derive(Debug, Clone)]\npub(crate) struct Turn {\n    /// All ResponseItems in this turn (user message + assistant response + tool calls/results).\n    pub items: Vec\u003cResponseItem\u003e,\n    /// Approximate token count for budget calculations.\n    pub token_count: usize,\n}\n\n/// Groups history items into complete turns.\n/// A turn starts with a user message and includes all items until the next user message.\n/// GhostSnapshots attach to their preceding turn.\npub(crate) fn identify_turns(history: \u0026[ResponseItem]) -\u003e Vec\u003cTurn\u003e {\n    // Implementation...\n}\n```\n\n## Turn Definition\n- Starts at ResponseItem::Message { role: \"user\", .. }\n- Includes all subsequent items until next user message\n- GhostSnapshots attach to their preceding turn\n- Consecutive user messages = separate turns\n- Skip session prefix entries (AGENTS.md, ENVIRONMENT_CONTEXT)\n\n## Token Counting\nUse existing `approx_token_count` for text content. For function calls, count arguments. For tool results, count output.\n\n## Acceptance\n- [ ] Turn struct defined\n- [ ] identify_turns correctly groups items\n- [ ] Session prefix entries filtered out\n- [ ] Token counts approximated for each turn","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T12:01:03.028344791+01:00","updated_at":"2026-01-01T12:04:51.541743677+01:00","closed_at":"2026-01-01T12:04:51.541748927+01:00","dependencies":[{"issue_id":"codex-6m2.1","depends_on_id":"codex-6m2","type":"parent-child","created_at":"2026-01-01T12:01:03.029395215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m2.2","title":"Add select_turns_within_budget function","description":"## Task\nAdd select_turns_within_budget function to core/src/compact.rs.\n\n## Implementation\n\n```rust\n/// Selects turns from the end that fit within the token budget.\n/// Returns (turns_to_summarize, turns_to_keep).\n/// Always keeps the last turn even if it exceeds budget.\npub(crate) fn select_turns_within_budget(\n    turns: Vec\u003cTurn\u003e,\n    budget: usize,\n) -\u003e (Vec\u003cTurn\u003e, Vec\u003cTurn\u003e) {\n    // Walk backwards, accumulate token counts\n    // Stop when budget exceeded\n    // Return split point\n}\n```\n\n## Algorithm\n1. Always keep the last turn (even if oversized)\n2. Walk backwards prepending complete turns\n3. Stop when budget exceeded\n4. Return (turns before cut, turns to keep)\n\n## Budget\nThe budget passed in should already account for:\n- System prompt tokens\n- Summary reservation (~1000 tokens)\n- Safety buffer (10% of context window)\n\n## Acceptance\n- [ ] Function correctly splits turns\n- [ ] Last turn always kept\n- [ ] Budget respected for earlier turns\n- [ ] Empty input handled gracefully","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T12:01:13.817216708+01:00","updated_at":"2026-01-01T12:07:34.056575099+01:00","closed_at":"2026-01-01T12:07:34.05658079+01:00","dependencies":[{"issue_id":"codex-6m2.2","depends_on_id":"codex-6m2","type":"parent-child","created_at":"2026-01-01T12:01:13.818272757+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m2.3","title":"Update build_compacted_history for turn-aware compaction","description":"## Task\nUpdate build_compacted_history to accept kept turns instead of just user messages.\n\n## Current Signature\n```rust\npub(crate) fn build_compacted_history(\n    initial_context: Vec\u003cResponseItem\u003e,\n    user_messages: \u0026[String],\n    summary_text: \u0026str,\n) -\u003e Vec\u003cResponseItem\u003e\n```\n\n## New Signature\n```rust\npub(crate) fn build_compacted_history(\n    initial_context: Vec\u003cResponseItem\u003e,\n    kept_turns: \u0026[Turn],\n    summary_text: \u0026str,\n) -\u003e Vec\u003cResponseItem\u003e\n```\n\n## Changes\n1. Instead of creating new user messages from strings, flatten kept_turns into ResponseItems\n2. Summary message goes BEFORE the kept turns (it summarizes what came before)\n3. Keep GhostSnapshots handling (they should already be in the turns)\n\n## Output Structure\n```\n[InitialContext items]\n[Summary message]\n[Kept turn 1 items - user msg, assistant msg, tool calls, tool results]\n[Kept turn 2 items - ...]\n...\n```\n\n## Acceptance\n- [ ] New signature implemented\n- [ ] Summary placed before kept turns\n- [ ] All items from kept turns preserved\n- [ ] Existing tests updated or replaced","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T12:01:24.93420394+01:00","updated_at":"2026-01-01T12:11:40.917802104+01:00","closed_at":"2026-01-01T12:11:40.917807123+01:00","dependencies":[{"issue_id":"codex-6m2.3","depends_on_id":"codex-6m2","type":"parent-child","created_at":"2026-01-01T12:01:24.935887292+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m2.4","title":"Update run_compact_task_inner to use turn-aware flow","description":"## Task\nUpdate run_compact_task_inner in core/src/compact.rs to use the new turn-aware compaction.\n\n## Current Flow (around line 165)\n```rust\nlet history_snapshot = sess.clone_history().await.get_history();\nlet summary_suffix = get_last_assistant_message_from_turn(\u0026history_snapshot).unwrap_or_default();\nlet summary_text = format!(\"{SUMMARY_PREFIX}\\n{summary_suffix}\");\nlet user_messages = collect_user_messages(\u0026history_snapshot);\n\nlet initial_context = sess.build_initial_context(turn_context.as_ref());\nlet mut new_history = build_compacted_history(initial_context, \u0026user_messages, \u0026summary_text);\n```\n\n## New Flow\n```rust\nlet history_snapshot = sess.clone_history().await.get_history();\n\n// 1. Identify turns\nlet turns = identify_turns(\u0026history_snapshot);\n\n// 2. Calculate budget\nlet context_window = turn_context.client.get_model_context_window();\nlet initial_context = sess.build_initial_context(turn_context.as_ref());\nlet initial_tokens = approx_token_count_for_items(\u0026initial_context);\nlet summary_reservation = 1000;\nlet safety_buffer = context_window / 10;\nlet budget = context_window.saturating_sub(initial_tokens + summary_reservation + safety_buffer);\n\n// 3. Select turns within budget\nlet (turns_to_summarize, kept_turns) = select_turns_within_budget(turns, budget);\n\n// 4. Generate summary only for turns_to_summarize\nlet summary_suffix = get_last_assistant_message_from_turn(\u0026history_snapshot).unwrap_or_default();\nlet summary_text = format!(\"{SUMMARY_PREFIX}\\n{summary_suffix}\");\n\n// 5. Build new history\nlet mut new_history = build_compacted_history(initial_context, \u0026kept_turns, \u0026summary_text);\n```\n\n## Helper Needed\nAdd approx_token_count_for_items to estimate tokens for a slice of ResponseItems.\n\n## Acceptance\n- [ ] run_compact_task_inner uses new flow\n- [ ] Budget calculated from context window\n- [ ] Kept turns preserved in output\n- [ ] Tests pass","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T12:01:41.084791002+01:00","updated_at":"2026-01-01T12:11:52.953873303+01:00","closed_at":"2026-01-01T12:11:52.95387704+01:00","dependencies":[{"issue_id":"codex-6m2.4","depends_on_id":"codex-6m2","type":"parent-child","created_at":"2026-01-01T12:01:41.085789484+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6m2.5","title":"Add tests for turn-aware compaction","description":"## Task\nAdd unit tests for the new turn-aware compaction functions in core/src/compact.rs.\n\n## Tests Needed\n\n### identify_turns tests\n1. `test_identify_turns_groups_by_user_message` - Basic grouping\n2. `test_identify_turns_handles_consecutive_user_messages` - Each user msg = new turn\n3. `test_identify_turns_attaches_ghost_snapshots` - GhostSnapshot stays with preceding turn\n4. `test_identify_turns_filters_session_prefix` - AGENTS.md/ENV_CONTEXT filtered\n5. `test_identify_turns_empty_history` - Returns empty vec\n6. `test_identify_turns_calculates_token_count` - Token approximation works\n\n### select_turns_within_budget tests\n1. `test_select_turns_keeps_last_turn_always` - Even if oversized\n2. `test_select_turns_respects_budget` - Stops at budget\n3. `test_select_turns_empty_input` - Returns empty vecs\n4. `test_select_turns_all_fit` - All turns returned as kept\n\n### build_compacted_history tests\n1. `test_build_compacted_history_with_turns` - Basic assembly\n2. `test_build_compacted_history_summary_before_turns` - Order correct\n3. `test_build_compacted_history_empty_turns` - Just initial + summary\n\n## Test Helpers\nMay need to create helper functions to build test ResponseItems:\n- `user_msg(text: \u0026str) -\u003e ResponseItem`\n- `assistant_msg(text: \u0026str) -\u003e ResponseItem`\n- `function_call(name: \u0026str, args: \u0026str) -\u003e ResponseItem`\n- `function_result(call_id: \u0026str, output: \u0026str) -\u003e ResponseItem`\n\n## Acceptance\n- [ ] All tests pass\n- [ ] Edge cases covered\n- [ ] Uses pretty_assertions::assert_eq","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-01T12:01:54.823120419+01:00","updated_at":"2026-01-01T12:48:32.37276602+01:00","closed_at":"2026-01-01T12:48:32.372772252+01:00","dependencies":[{"issue_id":"codex-6m2.5","depends_on_id":"codex-6m2","type":"parent-child","created_at":"2026-01-01T12:01:54.824184703+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6sg","title":"Review subagent returns empty result","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-27T14:21:21.30567708+01:00","updated_at":"2026-01-02T12:12:29.854736443+01:00","closed_at":"2026-01-02T12:12:29.854736443+01:00"}
{"id":"codex-6wa","title":"Dynamic MCP server enumeration in tool descriptions","description":"## Problem\n\nNon-OpenAI/Anthropic models (Gemini, Kimi, GLM, Grok, etc.) hallucinate MCP server names when using `read_mcp_resource`. Most commonly they invent a 'filesystem' server to read local files, resulting in errors like:\n\n```\nError: resources/read failed: unknown MCP server 'filesystem'\n```\n\nThis happens because:\n1. Models see `read_mcp_resource` tool available\n2. They want to read a file\n3. They invent server names based on training data patterns\n\n## Solution\n\nDynamically inject the list of available MCP servers into tool descriptions at runtime. This prevents the entire class of 'invented server name' hallucinations by showing models exactly what's available upfront.\n\n## Approach\n\nExtract server names from the `mcp_tools` HashMap keys (which have format `mcp__servername__toolname`) inside `build_specs()` and pass them to MCP resource tool creation functions. Update descriptions to show:\n- Available servers list\n- Explicit guidance that there's no filesystem server\n- Direction to use shell_command for local files\n\n## Files involved\n- `core/src/tools/spec.rs` - tool creation functions\n- `core/src/mcp_connection_manager.rs` - MCP_TOOL_NAME_DELIMITER constant\n\n## Success criteria\n- Tool descriptions dynamically list available MCP servers\n- Models stop hallucinating non-existent server names\n- No changes to external interfaces or ToolsConfig struct","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T16:05:44.227274567+01:00","updated_at":"2025-12-12T16:44:03.81796512+01:00","closed_at":"2025-12-12T16:44:03.81796512+01:00"}
{"id":"codex-6wa.1","title":"Export MCP_TOOL_NAME_DELIMITER constant","description":"## What\n\nMake `MCP_TOOL_NAME_DELIMITER` (currently `\"__\"`) accessible from `core/src/tools/spec.rs`.\n\n## Why\n\nNeed to parse server names from qualified tool names like `mcp__exa-search__web_search`.\n\n## How\n\nIn `core/src/mcp_connection_manager.rs`:\n- Change `const MCP_TOOL_NAME_DELIMITER` from private to `pub(crate) const`\n\nOr alternatively, re-export it via `core/src/lib.rs` or `core/src/mcp/mod.rs`.\n\n## Acceptance\n- `MCP_TOOL_NAME_DELIMITER` importable in `tools/spec.rs`\n- No changes to its value or behavior","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:06.10762724+01:00","updated_at":"2025-12-12T16:44:03.807142844+01:00","closed_at":"2025-12-12T16:44:03.807142844+01:00","dependencies":[{"issue_id":"codex-6wa.1","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:06.107928565+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.2","title":"Extract server names from mcp_tools in build_specs()","description":"## What\n\nInside `build_specs()` function in `core/src/tools/spec.rs`, extract unique MCP server names from the `mcp_tools` HashMap keys.\n\n## Why\n\nServer names are needed to dynamically populate tool descriptions.\n\n## How\n\n```rust\nuse crate::mcp_connection_manager::MCP_TOOL_NAME_DELIMITER;\nuse std::collections::BTreeSet;\n\n// Inside build_specs():\nlet mcp_server_names: Vec\u003cString\u003e = mcp_tools\n    .as_ref()\n    .map(|tools| {\n        tools.keys()\n            .filter_map(|k| {\n                // Format: mcp__servername__toolname\n                let parts: Vec\u003c\u0026str\u003e = k.split(MCP_TOOL_NAME_DELIMITER).collect();\n                parts.get(1).map(|s| s.to_string())\n            })\n            .collect::\u003cBTreeSet\u003c_\u003e\u003e()  // Dedupe and sort\n            .into_iter()\n            .collect()\n    })\n    .unwrap_or_default();\n```\n\n## Acceptance\n- `mcp_server_names: Vec\u003cString\u003e` available in `build_specs()`\n- Names are sorted and deduplicated\n- Empty vec when no MCP tools configured","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:14.858233758+01:00","updated_at":"2025-12-12T16:44:03.796654516+01:00","closed_at":"2025-12-12T16:44:03.796654516+01:00","dependencies":[{"issue_id":"codex-6wa.2","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:14.858572905+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.2","depends_on_id":"codex-6wa.1","type":"blocks","created_at":"2025-12-12T16:07:18.015773071+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.3","title":"Update MCP resource tool creation functions to accept server names","description":"## What\n\nModify the three MCP resource tool creation functions to accept a slice of server names:\n- `create_list_mcp_resources_tool()`\n- `create_list_mcp_resource_templates_tool()`\n- `create_read_mcp_resource_tool()`\n\n## Why\n\nThese functions need server names to build dynamic descriptions.\n\n## How\n\nChange signatures from:\n```rust\nfn create_list_mcp_resources_tool() -\u003e ToolSpec\nfn create_list_mcp_resource_templates_tool() -\u003e ToolSpec\nfn create_read_mcp_resource_tool() -\u003e ToolSpec\n```\n\nTo:\n```rust\nfn create_list_mcp_resources_tool(server_names: \u0026[String]) -\u003e ToolSpec\nfn create_list_mcp_resource_templates_tool(server_names: \u0026[String]) -\u003e ToolSpec\nfn create_read_mcp_resource_tool(server_names: \u0026[String]) -\u003e ToolSpec\n```\n\nUpdate call sites in `build_specs()` to pass `\u0026mcp_server_names`.\n\n## Acceptance\n- All three functions accept server names parameter\n- Compiles without errors\n- Tests still pass (may need updates)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:24.09025752+01:00","updated_at":"2025-12-12T16:44:03.828011316+01:00","closed_at":"2025-12-12T16:44:03.828011316+01:00","dependencies":[{"issue_id":"codex-6wa.3","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:24.090623428+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.3","depends_on_id":"codex-6wa.2","type":"blocks","created_at":"2025-12-12T16:07:18.048152242+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.4","title":"Build dynamic descriptions with server list","description":"## What\n\nUpdate the description strings in the three MCP resource tool functions to include the available server list.\n\n## Why\n\nModels need to see available servers upfront to avoid hallucinating non-existent ones.\n\n## How\n\n### For `create_read_mcp_resource_tool`:\n\n```rust\nlet description = if server_names.is_empty() {\n    \"Read a specific resource from an MCP server. No MCP servers are currently available. For local file access, use shell_command.\".to_string()\n} else {\n    format!(\n        \"Read a specific resource from an MCP server given the server name and resource URI. Available servers: {:?}. For local file access, use shell_command instead.\",\n        server_names\n    )\n};\n```\n\n### For `create_list_mcp_resources_tool`:\n\n```rust\nlet description = if server_names.is_empty() {\n    \"Lists resources provided by MCP servers. No MCP servers are currently available.\".to_string()\n} else {\n    format!(\n        \"Lists resources provided by MCP servers. Available servers: {:?}. Resources allow servers to share data that provides context to language models.\",\n        server_names\n    )\n};\n```\n\n### For `create_list_mcp_resource_templates_tool`:\n\nSimilar pattern.\n\n## Acceptance\n- Descriptions include server list when servers exist\n- Descriptions indicate 'no servers available' when empty\n- `read_mcp_resource` mentions shell_command for file access","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T16:06:34.650444397+01:00","updated_at":"2025-12-12T16:44:03.838111675+01:00","closed_at":"2025-12-12T16:44:03.838111675+01:00","dependencies":[{"issue_id":"codex-6wa.4","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:34.65076033+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.4","depends_on_id":"codex-6wa.3","type":"blocks","created_at":"2025-12-12T16:07:18.063719031+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-6wa.5","title":"Update tests for dynamic MCP tool descriptions","description":"## What\n\nUpdate existing tests in `core/src/tools/spec.rs` that create or verify MCP resource tools.\n\n## Why\n\nTests call the tool creation functions directly and will fail after signature changes.\n\n## How\n\nFind tests that call:\n- `create_list_mcp_resources_tool()`\n- `create_list_mcp_resource_templates_tool()`  \n- `create_read_mcp_resource_tool()`\n\nUpdate them to pass a server names slice, e.g., `\u0026[]` or `\u0026[\"test-server\".to_string()]`.\n\nAlso consider adding new test cases:\n1. Empty server list produces expected description\n2. Non-empty server list includes servers in description\n\n## Acceptance\n- All existing tests pass\n- New test verifies description contains server names when provided","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T16:06:44.305542595+01:00","updated_at":"2026-01-05T01:05:24.041870592+01:00","closed_at":"2026-01-05T01:05:24.041870592+01:00","dependencies":[{"issue_id":"codex-6wa.5","depends_on_id":"codex-6wa","type":"parent-child","created_at":"2025-12-12T16:06:44.30622701+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-6wa.5","depends_on_id":"codex-6wa.4","type":"blocks","created_at":"2025-12-12T16:07:18.032792289+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-71l","title":"Subagent configuration updates ignored on session reuse","description":"## Problem\nWhen a subagent session is reused, `TaskHandler` correctly updates the CWD via `OverrideTurnContext`, but it skips reloading the subagent definition and profile. This means changes to the subagent's system prompt, model selection, or approval policy in the `.md` file or `config.toml` are ignored for the reused session.\n\n## Analysis\nThis is actually acceptable behavior for now because:\n1. Session reuse is primarily for oracle/finder agents which don't typically have write permissions\n2. Reloading config mid-session could cause inconsistent behavior\n3. The warning log already notes that conversation history may reference outdated state\n\n## Decision\nMark as won't fix for now. Add a note that config changes require a new session.\n\n## Alternative (if needed later)\nThe handler could re-evaluate the configuration and apply relevant updates (model, policy) to the existing session where possible via additional OverrideTurnContext fields.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:49.849376672+01:00","updated_at":"2025-12-21T18:57:55.231203217+01:00","closed_at":"2025-12-21T18:57:55.231203217+01:00"}
{"id":"codex-7kf","title":"Migrate Custom Features (Providers, Subagents, UI)","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-05T13:57:24.388988989+01:00","updated_at":"2025-12-05T16:02:22.845701629+01:00","closed_at":"2025-12-05T16:02:22.845701629+01:00"}
{"id":"codex-7kf.1","title":"Migrate Multi-provider Support (Gemini, Anthropic)","description":"Port core backend support for Gemini and Anthropic from the old fork to codex-rs/core.\n\nSTEPS:\n1. Copy source files from old fork (core/src/):\n   - gemini.rs\n   - gemini_messages.rs\n   - anthropic_messages.rs\n2. Copy resource files:\n   - core/gemini-3-prompt.md\n3. Integrate into codex-rs/core:\n   - Update lib.rs to expose modules\n   - Update model_family.rs to include Gemini/Anthropic variants\n   - Update model_provider_info logic if necessary","notes":"Gemini + Anthropic scaffolds ported; proceeding to subagents","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:30.334759125+01:00","updated_at":"2025-12-05T15:33:33.919881922+01:00","closed_at":"2025-12-05T15:33:33.919885529+01:00","dependencies":[{"issue_id":"codex-7kf.1","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:30.335098263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.1.1","title":"Port Gemini Support","description":"Port all Gemini-related code and assets.\n\nFILES TO COPY:\n- /core/src/gemini.rs\n- /core/src/gemini_messages.rs\n- /core/gemini-3-prompt.md\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Gemini as a provider in core/src/model_family.rs","notes":"Gemini provider files ported, compiling in codex-core","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:34.905643645+01:00","updated_at":"2025-12-05T15:24:55.559395065+01:00","closed_at":"2025-12-05T15:24:55.559399624+01:00","dependencies":[{"issue_id":"codex-7kf.1.1","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:34.905983584+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.1.2","title":"Port Anthropic Support","description":"Port Anthropic-related code.\n\nFILES TO COPY:\n- /core/src/anthropic_messages.rs\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Anthropic as a provider in core/src/model_family.rs (if distinct from OpenAI/Gemini path)","notes":"Anthropic messages/provider ported and compiling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:43.383129271+01:00","updated_at":"2025-12-05T15:31:40.109495912+01:00","closed_at":"2025-12-05T15:31:40.109498948+01:00","dependencies":[{"issue_id":"codex-7kf.1.2","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:43.383462036+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.2","title":"Migrate Subagents Architecture","description":"Port the subagent orchestration logic to enable task delegation.\n\nSTEPS:\n1. Copy core/src/subagents.rs to codex-rs/core/src/\n2. Copy core/src/tools/handlers/task.rs to codex-rs/core/src/tools/handlers/\n3. Register the 'task' tool in the core tool registry\n4. Ensure the task handler hooks correctly into the event loop in codex-rs/app-server or core","notes":"Subagent scaffolding and task tool stubbed; responds unsupported pending full wiring","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:34.951409492+01:00","updated_at":"2025-12-05T15:43:43.070080627+01:00","closed_at":"2025-12-05T15:43:43.070085035+01:00","dependencies":[{"issue_id":"codex-7kf.2","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:34.951692232+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kf.3","title":"Update TUI for New Providers and Subagents","description":"Adapt the TUI to render non-OpenAI models and subagent activities.\n\nSTEPS:\n1. Port TUI view modes:\n   - Copy/Adapt tui/src/tui/inline.rs\n   - Copy/Adapt tui/src/tui/standard.rs\n2. Update rendering logic:\n   - Check tui/src/chatwidget.rs for provider-specific rendering adjustments\n   - Ensure subagent tool calls are displayed correctly","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:39.162584085+01:00","updated_at":"2025-12-05T16:02:19.277920853+01:00","closed_at":"2025-12-05T16:02:19.277920853+01:00","dependencies":[{"issue_id":"codex-7kf.3","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:39.162905789+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-7kq","title":"Port upstream bugfixes (post 2026-01-09 sync)","description":"Port selected upstream openai/codex fixes that apply to this fork since our last upstream sync (debb9a68e / 2026-01-09 01:32). Scope: required bugfix ports from rust-v0.80.0 + post-0.80.0 that affect our core/tui tooling. Optional ports are tracked separately under epic codex-qg8.","acceptance_criteria":"DoD:\\n- Child tasks codex-7kq.1..codex-7kq.4 are closed.\\n- For touched crates: just fmt, just fix -p \u003ccrate\u003e, and cargo check --bin codex.\\n- Project-specific tests pass for touched crates (cargo test -p codex-core and/or cargo test -p codex-tui).","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-11T16:03:32.823622517+01:00","updated_at":"2026-01-11T16:35:21.54262756+01:00","closed_at":"2026-01-11T16:35:21.54262756+01:00","close_reason":"Completed required upstream bugfix ports"}
{"id":"codex-7kq.1","title":"Core: preserve LD_LIBRARY_PATH/DYLD_LIBRARY_PATH in subprocess env (#8951)","description":"Upstream: #8951 (d3ff668f6).\n\nProblem:\n- We spawn tool subprocesses with a controlled env (core/src/spawn.rs uses env_clear).\n- ShellEnvironmentPolicyInherit::Core allowlist in core/src/exec_env.rs omits LD_LIBRARY_PATH and DYLD_LIBRARY_PATH.\n- This can cause major perf regressions for subprocesses relying on dynamic linker search paths.\n\nWork:\n- Update core/src/exec_env.rs CORE_VARS allowlist to include LD_LIBRARY_PATH and DYLD_LIBRARY_PATH.\n- Keep default secret filtering behavior intact.\n- Add/adjust unit tests in core/src/exec_env.rs to cover these vars under Core inherit.","acceptance_criteria":"DoD:\n- Unit test covers preserving LD_LIBRARY_PATH/DYLD_LIBRARY_PATH under Core inherit.\n- cargo test -p codex-core passes.\n- cargo check --bin codex passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T16:06:18.309527822+01:00","updated_at":"2026-01-11T16:35:15.431889082+01:00","closed_at":"2026-01-11T16:35:15.431889082+01:00","close_reason":"Implemented + tested (cargo test -p codex-core)","dependencies":[{"issue_id":"codex-7kq.1","depends_on_id":"codex-7kq","type":"parent-child","created_at":"2026-01-11T16:06:18.309884423+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.2","title":"Core: treat null MCP resource args as empty/defaults (#8917)","description":"Upstream: #8917 (51dd5af80).\n\nProblem:\n- MCP resource tools parse tool arguments as JSON in core/src/tools/handlers/mcp_resource.rs.\n- If the model sends literal JSON null, we currently treat it as a value and then fail to deserialize defaults (parse_arguments + parse_args_with_default).\n\nWork:\n- Adjust parse_arguments (or call sites) so an arguments payload of null is treated as missing/empty args.\n- Add unit tests in core/src/tools/handlers/mcp_resource.rs covering: empty string, whitespace, and null.","acceptance_criteria":"DoD:\n- Unit tests cover null + empty args for MCP resource tools.\n- cargo test -p codex-core passes.\n- cargo check --bin codex passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T16:06:25.581991907+01:00","updated_at":"2026-01-11T16:35:15.451135196+01:00","closed_at":"2026-01-11T16:35:15.451135196+01:00","close_reason":"Implemented + tested (cargo test -p codex-core)","dependencies":[{"issue_id":"codex-7kq.2","depends_on_id":"codex-7kq","type":"parent-child","created_at":"2026-01-11T16:06:25.593812974+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.3","title":"TUI: /review \u003cinstructions\u003e launches review flow (#8823)","description":"Upstream: #8823 (124a09e57).\n\nProblem:\n- Built-in slash commands with arguments are not consistently dispatched.\n- We special-case /handoff \u003cgoal\u003e in tui/src/bottom_pane/chat_composer.rs, but /review \u003cinstructions\u003e likely falls through and submits literal text.\n\nWork:\n- Update TUI slash parsing/dispatch so /review \u003cinstructions\u003e routes into the review UX and preserves the instructions.\n- Add or update a regression test (likely in tui/src/chatwidget/tests.rs) locking in behavior.","acceptance_criteria":"DoD:\n- Regression test for /review \u003cinstructions\u003e added/updated.\n- cargo test -p codex-tui passes.\n- cargo check --bin codex passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T16:06:33.848715929+01:00","updated_at":"2026-01-11T16:35:15.465874629+01:00","closed_at":"2026-01-11T16:35:15.465874629+01:00","close_reason":"Implemented + tested (cargo test -p codex-tui)","dependencies":[{"issue_id":"codex-7kq.3","depends_on_id":"codex-7kq","type":"parent-child","created_at":"2026-01-11T16:06:33.8549078+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.4","title":"Core: stabilize list_dir pagination order (#8826)","description":"Upstream: #8826 (267c05fb3).\n\nProblem:\n- list_dir collects entries, slices by offset/limit, then sorts only the slice (core/src/tools/handlers/list_dir.rs:list_dir_slice).\n- This can produce unstable pagination (page boundaries shift) and confusing ordering across calls.\n\nWork:\n- Make ordering deterministic across the full entry set before slicing (sort globally then paginate), or otherwise guarantee stable ordering across pages.\n- Add or adjust unit tests in core/src/tools/handlers/list_dir.rs validating stable paging across multiple pages.","acceptance_criteria":"DoD:\n- Unit test covers stable paging across page 1 and page 2 with fixed inputs.\n- cargo test -p codex-core passes.\n- cargo check --bin codex passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-11T16:06:40.958467233+01:00","updated_at":"2026-01-11T16:35:15.479786261+01:00","closed_at":"2026-01-11T16:35:15.479786261+01:00","close_reason":"Implemented + tested (cargo test -p codex-core)","dependencies":[{"issue_id":"codex-7kq.4","depends_on_id":"codex-7kq","type":"parent-child","created_at":"2026-01-11T16:06:40.970226472+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.5","title":"Core: apply_patch Allow this session should persist for approved files (#8451)","description":"Upstream: #8451 (66450f044).\n\nProblem:\n- apply_patch approvals have an ApprovedForSession option.\n- Our current caching key for apply_patch approval appears patch-content-based (core/src/tools/runtimes/apply_patch.rs) rather than per-file/path, so re-approving similar patches may still prompt.\n\nWork:\n- Align semantics with upstream: choosing Allow this session for apply_patch should prevent re-prompts for previously approved files within the session.\n- Add tests in codex-core (unit or integration) covering the expected persistence behavior.","acceptance_criteria":"DoD:\n- Session-scoped allow for apply_patch avoids redundant prompts for the same file(s).\n- Tests added/updated.\n- cargo test -p codex-core passes.\n- cargo check --bin codex passes.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T16:06:53.205735934+01:00","updated_at":"2026-01-12T03:02:14.857315896+01:00","closed_at":"2026-01-12T03:02:14.857315896+01:00","close_reason":"Completed","labels":["optional","upstream"],"dependencies":[{"issue_id":"codex-7kq.5","depends_on_id":"codex-qg8","type":"parent-child","created_at":"2026-01-11T16:08:29.745897171+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.6","title":"App-server: set originator header from initialize request (#8873/#8988)","description":"Upstream: #8873 (ea56186c2) and #8988 (fbe883318).\n\nProblem:\n- App-server initialize request should propagate originator header consistently.\n\nWork:\n- Identify where app-server handles initialize and sets originator.\n- Port upstream logic so originator header is correctly derived from initialize request payload.","acceptance_criteria":"DoD:\n- App-server initialize sets correct originator header.\n- Relevant app-server tests pass (or add regression test if missing).\n- cargo check --bin codex passes.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T16:07:01.212871984+01:00","updated_at":"2026-01-12T03:02:15.418648641+01:00","closed_at":"2026-01-12T03:02:15.418648641+01:00","close_reason":"Completed","labels":["optional","upstream"],"dependencies":[{"issue_id":"codex-7kq.6","depends_on_id":"codex-qg8","type":"parent-child","created_at":"2026-01-11T16:08:43.188854833+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.7","title":"TUI: add alternate_screen config and --no-alt-screen flag (#8555)","description":"Upstream: #8555 (7daaabc79).\n\nProblem:\n- Some terminal multiplexers (e.g. Zellij) benefit from disabling alternate screen to preserve scrollback.\n\nWork:\n- Port upstream: add config to toggle alternate screen and CLI flag --no-alt-screen.\n- Ensure default behavior stays unchanged unless flag/config set.","acceptance_criteria":"DoD:\n- Alternate screen toggle implemented via config and CLI flag.\n- cargo test -p codex-tui passes.\n- cargo check --bin codex passes.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-11T16:07:08.244941513+01:00","updated_at":"2026-01-11T21:19:04.109813709+01:00","closed_at":"2026-01-11T21:19:04.109813709+01:00","close_reason":"Added alternate screen config + --no-alt-screen flag","labels":["optional","upstream"],"dependencies":[{"issue_id":"codex-7kq.7","depends_on_id":"codex-qg8","type":"parent-child","created_at":"2026-01-11T16:08:56.146146381+01:00","created_by":"daemon"}]}
{"id":"codex-7kq.8","title":"Bazel: add .git to .bazelignore and treat AGENTS.md as repo marker (#9008/#9010)","description":"Upstream: #9008 (74b223893) and #9010 (cf515142b).\n\nProblem:\n- Bazel integration/tests may need .git ignored and AGENTS.md treated as a repo-root marker.\n\nWork:\n- Port upstream behavior if we still run Bazel-based tests/workflows in this fork.","acceptance_criteria":"DoD:\n- Bazel workflows (if used) behave as expected.\n- No regressions in non-Bazel workflows.\n- cargo check --bin codex passes.","status":"closed","priority":4,"issue_type":"task","created_at":"2026-01-11T16:07:16.263809251+01:00","updated_at":"2026-01-12T03:02:16.522044744+01:00","closed_at":"2026-01-12T03:02:16.522044744+01:00","close_reason":"Completed","labels":["bazel","optional","upstream"],"dependencies":[{"issue_id":"codex-7kq.8","depends_on_id":"codex-qg8","type":"parent-child","created_at":"2026-01-11T16:09:09.807790985+01:00","created_by":"daemon"}]}
{"id":"codex-83k","title":"Show model_provider and model in footer","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T16:13:54.687590171+01:00","updated_at":"2025-12-07T16:17:24.942337442+01:00","closed_at":"2025-12-07T16:17:24.942337442+01:00"}
{"id":"codex-83q","title":"Worktree-based subagent file change tracking","description":"Implement git worktree-based isolation for subagents to track ALL file changes (not just apply_patch). \n\n## Problem\n- Subagents can edit files via sed, python scripts, fastmod, cat - not just apply_patch\n- We need to track all changes regardless of method\n- Parallel subagents need correct attribution\n- Main agent spawns subagents mid-turn, so there's always dirty state\n\n## Solution: Recursive Snapshot Pattern\n1. When spawning subagent: capture parent's state via `git stash create -u`\n2. Create detached worktree from that snapshot\n3. Subagent runs freely in isolated worktree\n4. On completion: `git diff --binary $base_sha` to get changes\n5. Apply patch to parent worktree (not always main - supports nesting)\n6. Merge happens at end of turn, in invocation order\n\n## Key Design Decisions\n- Patch content NEVER goes in context - return patch_path on conflict\n- Merge at end of turn (all parallel subagents complete first)\n- Nested subagents: B spawned by A sees A's changes (recursive snapshot from parent worktree)\n- Physical layout flat: .codex/agents/\u003cuuid\u003e, but data flow is hierarchical\n- Subagent response unchanged - changes info is separate field\n\n## Response Format\n```json\n{\n  \"result\": \"subagent's response\",\n  \"session_id\": \"...\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"applied|conflict|no_changes\",\n    \"files_changed\": [{\"path\": \"...\", \"insertions\": N, \"deletions\": N}],\n    \"patch_path\": \".codex/patches/\u003cid\u003e.diff\"  // only if conflict\n  }\n}\n```","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T14:17:35.541896362+01:00","updated_at":"2025-12-21T14:46:08.439665158+01:00","closed_at":"2025-12-21T14:46:08.439665158+01:00"}
{"id":"codex-83q.1","title":"Add SubagentChanges type to protocol","description":"Add new types to codex-protocol for representing subagent file changes.\n\n## Location\n`codex-rs/protocol/src/models.rs` (or new file `subagent_changes.rs`)\n\n## Types to Add\n\n```rust\n/// Status of subagent's file changes after merge attempt\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\n#[serde(rename_all = \"snake_case\")]\npub enum SubagentChangesStatus {\n    /// Changes applied successfully to parent worktree\n    Applied,\n    /// Merge conflict - patch saved to patch_path\n    Conflict,\n    /// Subagent made no file changes\n    NoChanges,\n}\n\n/// Summary of a single file change\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub struct FileChangeSummary {\n    pub path: String,\n    pub insertions: i32,\n    pub deletions: i32,\n}\n\n/// Subagent file changes info, separate from subagent's response\n#[derive(Debug, Clone, Serialize, Deserialize, PartialEq, Eq)]\npub struct SubagentChanges {\n    pub status: SubagentChangesStatus,\n    /// List of changed files (empty if no_changes or conflict)\n    #[serde(default, skip_serializing_if = \"Vec::is_empty\")]\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Path to saved patch file (only present if conflict)\n    #[serde(default, skip_serializing_if = \"Option::is_none\")]\n    pub patch_path: Option\u003cString\u003e,\n}\n```\n\n## Tests\nAdd unit tests for serialization/deserialization of these types.\n\n## Notes\n- Use i32 for insertions/deletions (not unsigned - per AGENTS.md)\n- path is String not PathBuf for JSON serialization simplicity","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:06.797910136+01:00","updated_at":"2025-12-21T14:35:28.398731264+01:00","closed_at":"2025-12-21T14:35:28.398731264+01:00","dependencies":[{"issue_id":"codex-83q.1","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:06.798202064+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.2","title":"Add WorktreeManager for git worktree operations","description":"Create a new module to handle git worktree lifecycle operations.\n\n## Location\n`codex-rs/core/src/worktree_manager.rs` (new file)\n\n## Responsibilities\n1. Create worktree from a snapshot (stash ref or HEAD)\n2. Generate diff of changes in worktree\n3. Apply patch to target worktree\n4. Cleanup worktree on completion\n\n## Public API\n\n```rust\nuse std::path::{Path, PathBuf};\nuse anyhow::Result;\n\n/// Manages git worktree lifecycle for subagent isolation\npub struct WorktreeManager {\n    /// Root directory where worktrees are created (.codex/agents/)\n    worktrees_root: PathBuf,\n    /// Directory for storing conflict patches (.codex/patches/)\n    patches_dir: PathBuf,\n}\n\n/// Result of creating a worktree\npub struct WorktreeHandle {\n    /// Unique ID for this worktree\n    pub id: String,\n    /// Path to the worktree directory\n    pub path: PathBuf,\n    /// The base SHA this worktree was created from\n    pub base_sha: String,\n}\n\n/// Result of generating a diff\npub struct WorktreeDiff {\n    /// The patch content (may be empty if no changes)\n    pub patch: String,\n    /// Parsed file change summaries\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Whether there are any changes\n    pub has_changes: bool,\n}\n\n/// Result of applying a patch\npub enum PatchApplyResult {\n    /// Patch applied successfully\n    Applied { files_changed: Vec\u003cFileChangeSummary\u003e },\n    /// No changes to apply\n    NoChanges,\n    /// Conflict - patch saved to file\n    Conflict { patch_path: PathBuf },\n}\n\nimpl WorktreeManager {\n    pub fn new(codex_dir: \u0026Path) -\u003e Self;\n    \n    /// Capture current state of parent_dir and create isolated worktree.\n    /// Uses `git stash create -u` to snapshot dirty state.\n    pub async fn create_worktree(\u0026self, parent_dir: \u0026Path) -\u003e Result\u003cWorktreeHandle\u003e;\n    \n    /// Generate diff of all changes in worktree since base_sha.\n    /// Runs: git add -A \u0026\u0026 git diff --binary --cached $base_sha\n    pub async fn generate_diff(\u0026self, handle: \u0026WorktreeHandle) -\u003e Result\u003cWorktreeDiff\u003e;\n    \n    /// Apply patch to target directory.\n    /// Runs: git apply --check first, then git apply if OK.\n    /// On conflict, saves patch to patches_dir and returns Conflict.\n    pub async fn apply_patch(\n        \u0026self,\n        patch: \u0026str,\n        target_dir: \u0026Path,\n        task_id: \u0026str,\n    ) -\u003e Result\u003cPatchApplyResult\u003e;\n    \n    /// Remove worktree and cleanup.\n    pub async fn cleanup(\u0026self, handle: \u0026WorktreeHandle) -\u003e Result\u003c()\u003e;\n}\n```\n\n## Git Commands Used\n- `git stash create -u` - capture dirty state as ephemeral commit\n- `git worktree add --detach \u003cpath\u003e \u003csha\u003e` - create isolated worktree\n- `git add -A` - stage all changes in worktree\n- `git diff --binary --cached \u003csha\u003e` - generate patch\n- `git apply --check \u003cpatch\u003e` - test if patch applies cleanly\n- `git apply \u003cpatch\u003e` - apply patch\n- `git worktree remove --force \u003cpath\u003e` - cleanup\n\n## Error Handling\n- If not a git repo: return clear error\n- If git commands fail: return error with stderr\n- If worktree creation fails: cleanup partial state\n\n## Tests\n- Test create/cleanup lifecycle\n- Test diff generation with various changes (add, modify, delete, binary)\n- Test patch apply success and conflict cases\n- Test with untracked files\n- Test with empty changes (no diff)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:36.53303817+01:00","updated_at":"2025-12-21T14:35:28.415080757+01:00","closed_at":"2025-12-21T14:35:28.415080757+01:00","dependencies":[{"issue_id":"codex-83q.2","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:36.533389882+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.3","title":"Add SubagentContext to track parent worktree path","description":"Track the parent worktree path in subagent context so nested subagents know where to snapshot from.\n\n## Problem\nWhen subagent A spawns subagent B, B must snapshot from A's worktree (not main). We need to pass the current working directory context through the subagent spawn chain.\n\n## Location\nModify `codex-rs/core/src/tools/handlers/task.rs` and related subagent spawning code.\n\n## Current State\nThe task tool handler spawns subagents. It needs to know:\n1. What directory is the \"parent\" for snapshotting\n2. Where to apply patches back to\n\n## Solution\nAdd a field to track the effective working directory for the current agent:\n\n```rust\n/// Context passed to subagent for worktree isolation\npub struct SubagentWorktreeContext {\n    /// The directory to snapshot from when creating this subagent's worktree.\n    /// For root agent: the main workspace directory.\n    /// For nested subagent: the parent subagent's worktree path.\n    pub parent_worktree: PathBuf,\n    \n    /// Where to apply this subagent's changes back to.\n    /// Same as parent_worktree (patches go to parent).\n    pub merge_target: PathBuf,\n}\n```\n\n## Integration Points\n1. `TaskHandler::execute()` - needs access to current worktree context\n2. `SubagentSession` or `Codex` - may need to store worktree context\n3. `TurnContext` or `Session` - evaluate where this context should live\n\n## Notes\n- For the root/main agent, parent_worktree is the user's workspace (cwd)\n- For subagents, parent_worktree is their own worktree path (set by WorktreeManager)\n- This enables recursive nesting: A -\u003e B -\u003e C, each sees parent's state\n\n## Tests\n- Test that nested subagent receives correct parent_worktree\n- Test 3-level nesting: main -\u003e A -\u003e B","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:18:56.310074187+01:00","updated_at":"2025-12-21T14:35:28.431195031+01:00","closed_at":"2025-12-21T14:35:28.431195031+01:00","dependencies":[{"issue_id":"codex-83q.3","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:18:56.310460916+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.4","title":"Integrate WorktreeManager into task tool handler","description":"Modify the task tool handler to use WorktreeManager for subagent isolation.\n\n## Location\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Current Flow (simplified)\n1. Parse task arguments (subagent_type, prompt, session_id)\n2. Load or create SubagentSession\n3. Submit prompt to subagent\n4. Wait for completion, collect events\n5. Return result JSON\n\n## New Flow\n1. Parse task arguments\n2. **NEW: Create worktree from parent context**\n   ```rust\n   let worktree_manager = WorktreeManager::new(\u0026codex_home);\n   let handle = worktree_manager.create_worktree(\u0026parent_worktree).await?;\n   ```\n3. Load or create SubagentSession **with worktree path as cwd**\n4. Submit prompt to subagent\n5. Wait for completion, collect events\n6. **NEW: Generate diff from worktree**\n   ```rust\n   let diff = worktree_manager.generate_diff(\u0026handle).await?;\n   ```\n7. **NEW: Collect pending patches (don't apply yet)**\n   - Store (diff, handle, invocation_order) for end-of-turn merge\n8. Return intermediate result (subagent response, no changes yet)\n\n## Deferred Merge\nPatches are NOT applied immediately. They are collected and applied at end of turn.\nSee task \"Implement end-of-turn patch merge\" for the merge logic.\n\n## Error Handling\n- If worktree creation fails (not a git repo), return error to model\n- If subagent crashes, cleanup worktree anyway\n- Use RAII pattern or Drop to ensure cleanup\n\n## Integration with SubagentWorktreeContext\nPass the worktree path to the subagent so nested subagents snapshot from correct location.\n\n## Tests\n- Test subagent runs in isolated worktree\n- Test subagent changes don't affect main until merge\n- Test cleanup on error","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:12.934128284+01:00","updated_at":"2025-12-21T14:41:57.327049743+01:00","closed_at":"2025-12-21T14:41:57.327049743+01:00","dependencies":[{"issue_id":"codex-83q.4","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:12.934493462+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.4","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:05.60403044+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.4","depends_on_id":"codex-83q.3","type":"blocks","created_at":"2025-12-21T14:21:06.761192637+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.5","title":"Implement end-of-turn patch merge coordinator","description":"Implement logic to merge all subagent patches at the end of a turn.\n\n## Problem\nMultiple subagents may run in parallel during a turn. Their patches must be:\n1. Collected until all complete\n2. Applied sequentially in invocation order\n3. Conflicts detected and reported\n\n## Location\nNew module: `codex-rs/core/src/patch_merge_coordinator.rs`\nIntegration: `codex-rs/core/src/codex.rs` or turn execution logic\n\n## Data Structures\n\n```rust\nuse std::path::PathBuf;\nuse std::sync::Arc;\nuse tokio::sync::Mutex;\n\n/// A pending patch from a completed subagent\npub struct PendingPatch {\n    /// Unique task ID for this subagent invocation\n    pub task_id: String,\n    /// The subagent type (for reporting)\n    pub subagent_type: String,\n    /// The patch content\n    pub patch: String,\n    /// Parsed file changes (for success reporting)\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    /// Target directory to apply patch to\n    pub target_dir: PathBuf,\n    /// Invocation order (for deterministic merge order)\n    pub invocation_order: u32,\n    /// The worktree handle (for cleanup)\n    pub worktree_handle: WorktreeHandle,\n}\n\n/// Result of merging a single patch\npub struct PatchMergeResult {\n    pub task_id: String,\n    pub subagent_type: String,\n    pub changes: SubagentChanges,\n}\n\n/// Coordinates patch collection and merging\npub struct PatchMergeCoordinator {\n    pending: Mutex\u003cVec\u003cPendingPatch\u003e\u003e,\n    worktree_manager: Arc\u003cWorktreeManager\u003e,\n}\n\nimpl PatchMergeCoordinator {\n    /// Add a pending patch (called when subagent completes)\n    pub async fn add_pending(\u0026self, patch: PendingPatch);\n    \n    /// Merge all pending patches in invocation order.\n    /// Called at end of turn.\n    /// Returns results for each patch (success or conflict).\n    pub async fn merge_all(\u0026self) -\u003e Vec\u003cPatchMergeResult\u003e;\n    \n    /// Cleanup all worktrees (called after merge or on error)\n    pub async fn cleanup_all(\u0026self);\n}\n```\n\n## Merge Algorithm\n1. Sort pending patches by invocation_order\n2. Acquire lock on target directory\n3. For each patch:\n   a. Run `git apply --check` \n   b. If OK: `git apply`, record Applied\n   c. If FAIL: save patch to .codex/patches/\u003cid\u003e.diff, record Conflict\n   d. Cleanup worktree\n4. Release lock\n5. Return all results\n\n## Integration Point\nAt end of turn (after all tool calls complete), call `coordinator.merge_all()`.\nInject results into the response to the model.\n\n## Thread Safety\n- Use Mutex for pending patches list\n- Use file lock or async mutex for git operations on target dir\n\n## Tests\n- Test single patch merge\n- Test multiple patches, no conflict\n- Test multiple patches, second conflicts\n- Test invocation order respected\n- Test cleanup on partial failure","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:35.326040567+01:00","updated_at":"2025-12-21T14:42:03.80163668+01:00","closed_at":"2025-12-21T14:42:03.80163668+01:00","dependencies":[{"issue_id":"codex-83q.5","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:35.326414773+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.1","type":"blocks","created_at":"2025-12-21T14:21:08.1013988+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:09.259052952+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.5","depends_on_id":"codex-83q.4","type":"blocks","created_at":"2025-12-21T14:21:10.316965448+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.6","title":"Update task tool response to include SubagentChanges","description":"Modify the task tool's response JSON to include the SubagentChanges field.\n\n## Location\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Current Response Format\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\"\n}\n```\n\n## New Response Format\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"applied\",\n    \"files_changed\": [\n      {\"path\": \"src/main.rs\", \"insertions\": 10, \"deletions\": 3}\n    ]\n  }\n}\n```\n\nOr on conflict:\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": {\n    \"status\": \"conflict\",\n    \"files_changed\": [],\n    \"patch_path\": \".codex/patches/abc123.diff\"\n  }\n}\n```\n\nOr no changes:\n```json\n{\n  \"result\": \"final_output\",\n  \"session_id\": \"uuid\",\n  \"last_tool_output\": \"...\",\n  \"changes\": null\n}\n```\n\n## Implementation\nAfter merge results are available (from PatchMergeCoordinator), include the SubagentChanges in the response JSON.\n\nNote: The merge happens at end of turn, so this task depends on the merge coordinator being integrated.\n\n## Key Principle\n- `result`, `session_id`, `last_tool_output` are subagent's response (unchanged)\n- `changes` is OUR metadata about file changes (separate concern)\n- Never mix subagent content with our metadata\n\n## Tests\n- Test response includes changes on success\n- Test response includes patch_path on conflict\n- Test response has null changes when no files modified","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T14:19:50.853573615+01:00","updated_at":"2025-12-21T14:42:35.75156147+01:00","closed_at":"2025-12-21T14:42:35.75156147+01:00","dependencies":[{"issue_id":"codex-83q.6","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:19:50.853946908+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.6","depends_on_id":"codex-83q.5","type":"blocks","created_at":"2025-12-21T14:21:11.367960692+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.7","title":"Add text summary of subagent changes to user message","description":"Add a human-readable summary of subagent file changes as a text part alongside tool results.\n\n## Problem\nModels work better with alternating user/assistant messages. When multiple subagents complete, we have multiple tool results. Adding a text summary helps the model understand what happened.\n\n## Location\n`codex-rs/core/src/codex.rs` or wherever tool results are assembled into the response.\n\n## Current Behavior\nTool results are returned as-is to the model.\n\n## New Behavior\nAfter end-of-turn merge, add a text summary:\n\n```\nSubagent changes summary:\n- 'general' (task-abc): applied 3 files (src/foo.rs +10/-2, src/bar.rs +5/-0, lib.rs +1/-1)\n- 'painter' (task-def): conflict, patch saved to .codex/patches/def.diff\n- 'finder' (task-ghi): no file changes\n```\n\n## Format Details\n- One line per subagent that completed this turn\n- For applied: list files with +insertions/-deletions\n- For conflict: mention patch path\n- For no_changes: just say \"no file changes\"\n\n## Implementation\n1. After `PatchMergeCoordinator::merge_all()` returns results\n2. Format results into summary string\n3. Include as text part in the message sent to model\n\n## Notes\n- Keep it concise - don't duplicate info that's in JSON\n- This is for model context, not for user display\n- Only include subagents that had changes or conflicts (skip no_changes? TBD)\n\n## Tests\n- Test summary format for various scenarios\n- Test with mix of applied/conflict/no_changes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T14:20:05.633679604+01:00","updated_at":"2025-12-21T14:45:29.051536046+01:00","closed_at":"2025-12-21T14:45:29.051536046+01:00","dependencies":[{"issue_id":"codex-83q.7","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:05.633978977+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.7","depends_on_id":"codex-83q.5","type":"blocks","created_at":"2025-12-21T14:21:12.644304394+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.8","title":"Handle non-git directories gracefully","description":"Handle the case where the workspace is not a git repository.\n\n## Problem\nThe worktree-based approach requires git. If the user is working in a non-git directory, we need a fallback.\n\n## Location\n`codex-rs/core/src/worktree_manager.rs`\n`codex-rs/core/src/tools/handlers/task.rs`\n\n## Detection\nCheck for git repo:\n```bash\ngit rev-parse --git-dir\n```\nIf this fails, we're not in a git repo.\n\n## Fallback Options\n\n### Option A: Fail with clear error\nReturn error to model: \"Subagent file tracking requires git. Please initialize a git repository.\"\n\nPros: Simple, honest\nCons: Breaks subagent functionality in non-git dirs\n\n### Option B: Run without isolation (legacy behavior)\nSkip worktree creation, run subagent in main directory, no change tracking.\n\nPros: Doesn't break functionality\nCons: No tracking, parallel subagents may conflict\n\n### Option C: Use temporary directory copy\nCopy workspace to temp dir, run there, diff after.\n\nPros: Works without git\nCons: Slow, doesn't handle large repos well\n\n## Recommendation\n**Option A** - fail with clear error. Rationale:\n- Git is nearly universal for code projects\n- The feature's value depends on accurate tracking\n- Better to be explicit than silently degraded\n\n## Implementation\n1. In WorktreeManager::create_worktree(), check for git first\n2. Return specific error type (e.g., NotAGitRepository)\n3. Task handler catches this error, returns user-friendly message\n\n## Tests\n- Test error message in non-git directory\n- Test normal operation in git directory","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T14:20:31.47935844+01:00","updated_at":"2025-12-21T14:43:02.817010427+01:00","closed_at":"2025-12-21T14:43:02.817010427+01:00","dependencies":[{"issue_id":"codex-83q.8","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:31.479668954+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.8","depends_on_id":"codex-83q.2","type":"blocks","created_at":"2025-12-21T14:21:13.951156824+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-83q.9","title":"Add environment variable sharing for build caches","description":"Set environment variables in subagent processes to share build caches with main workspace.\n\n## Problem\nWorktrees don't share build artifacts (target/, node_modules/). This means subagents would need to rebuild from scratch, which is slow.\n\n## Solution\nSet environment variables when spawning subagent process to point to main workspace's build directories.\n\n## Environment Variables to Set\n\n### Rust (Cargo)\n```\nCARGO_TARGET_DIR=/absolute/path/to/main/workspace/target\n```\nThis makes cargo use the main workspace's target directory.\n\n### Node.js (npm/yarn/pnpm)\n```\nnpm_config_cache=/absolute/path/to/main/.npm\nYARN_CACHE_FOLDER=/absolute/path/to/main/.yarn/cache\nPNPM_HOME=/absolute/path/to/main/.pnpm-store\n```\n\n### Python (pip)\n```\nPIP_CACHE_DIR=/absolute/path/to/main/.cache/pip\n```\n\n## Location\nWhen spawning the subagent process, set these env vars. This is likely in:\n- `codex-rs/core/src/tools/handlers/task.rs` (where subagent session is created)\n- Or in the subagent process spawn logic\n\n## Implementation\n1. Detect main workspace path (parent worktree for root, or parent's parent for nested)\n2. Construct env var map\n3. Pass to subagent process spawn\n\n## Caveats\n- Only set vars for tools that are detected (check if Cargo.toml exists, package.json, etc.)\n- These are optimizations, not requirements - if they fail, subagent still works (just slower)\n\n## Tests\n- Test CARGO_TARGET_DIR is set when Cargo.toml exists in main workspace\n- Test env vars propagate to subagent's shell commands","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T14:20:46.730764798+01:00","updated_at":"2025-12-21T14:45:20.887393941+01:00","closed_at":"2025-12-21T14:45:20.887393941+01:00","dependencies":[{"issue_id":"codex-83q.9","depends_on_id":"codex-83q","type":"parent-child","created_at":"2025-12-21T14:20:46.731112122+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-83q.9","depends_on_id":"codex-83q.4","type":"blocks","created_at":"2025-12-21T14:21:14.966071462+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-86d","title":"Blocking I/O in WorktreeHandle Drop","description":"WorktreeHandle::drop uses std::process::Command to synchronously execute git worktree remove. This is an emergency fallback - normal cleanup should happen via cleanup() before drop. Low priority since it's rarely triggered.","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T19:17:48.691649948+01:00","updated_at":"2025-12-21T19:17:54.787713236+01:00","closed_at":"2025-12-21T19:17:54.787713236+01:00"}
{"id":"codex-8ay","title":"Merge upstream/main into fork","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T12:53:34.411109138+01:00","updated_at":"2025-12-18T12:36:22.808762082+01:00","closed_at":"2025-12-18T12:36:22.808762082+01:00"}
{"id":"codex-8ay.1","title":"Resolve AGENTS.md - keep ours entirely","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:53:52.638578049+01:00","updated_at":"2025-12-18T12:36:10.404280273+01:00","closed_at":"2025-12-18T12:36:10.404280273+01:00","dependencies":[{"issue_id":"codex-8ay.1","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:53:52.639137096+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.10","title":"Resolve app-server conflicts - accept upstream","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:09.237345264+01:00","updated_at":"2025-12-18T12:36:10.399174245+01:00","closed_at":"2025-12-18T12:36:10.399174245+01:00","dependencies":[{"issue_id":"codex-8ay.10","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:09.237789251+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.11","title":"Resolve test files with simple conflicts","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:18.423001633+01:00","updated_at":"2025-12-18T12:36:10.397810759+01:00","closed_at":"2025-12-18T12:36:10.397810759+01:00","dependencies":[{"issue_id":"codex-8ay.11","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:18.423544229+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.12","title":"Resolve remaining core/* conflicts","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:55:27.975875486+01:00","updated_at":"2025-12-18T12:36:10.428449945+01:00","closed_at":"2025-12-18T12:36:10.428449945+01:00","dependencies":[{"issue_id":"codex-8ay.12","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:27.976481283+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.13","title":"Build and fix compilation errors","status":"closed","issue_type":"task","created_at":"2025-12-15T12:55:37.311969336+01:00","updated_at":"2025-12-18T12:36:10.397834926+01:00","closed_at":"2025-12-18T12:36:10.397834926+01:00","dependencies":[{"issue_id":"codex-8ay.13","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:37.312539093+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.14","title":"Run tests and fix failures","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T12:55:46.560821722+01:00","updated_at":"2025-12-18T12:36:10.397953853+01:00","closed_at":"2025-12-18T12:36:10.397953853+01:00","dependencies":[{"issue_id":"codex-8ay.14","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:46.56130801+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.2","title":"Resolve protocol/src/*.rs - keep provider extensions","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.10080133+01:00","updated_at":"2025-12-18T12:36:10.399922024+01:00","closed_at":"2025-12-18T12:36:10.399922024+01:00"}
{"id":"codex-8ay.3","title":"Resolve core/src/model_provider_info.rs","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.101001042+01:00","updated_at":"2025-12-18T12:36:10.399029158+01:00","closed_at":"2025-12-18T12:36:10.399029158+01:00","dependencies":[{"issue_id":"codex-8ay.3","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.101546733+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.4","title":"Resolve Cargo.toml and regenerate Cargo.lock","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.111883689+01:00","updated_at":"2025-12-18T12:36:10.447866451+01:00","closed_at":"2025-12-18T12:36:10.447866451+01:00","dependencies":[{"issue_id":"codex-8ay.4","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.115028392+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.5","title":"Resolve core/src/codex.rs - complex merge","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.112849302+01:00","updated_at":"2025-12-18T12:36:10.441995872+01:00","closed_at":"2025-12-18T12:36:10.441995872+01:00"}
{"id":"codex-8ay.6","title":"Resolve core/src/lib.rs - keep our modules","status":"closed","issue_type":"task","created_at":"2025-12-15T12:54:29.153336627+01:00","updated_at":"2025-12-18T12:36:10.399231595+01:00","closed_at":"2025-12-18T12:36:10.399231595+01:00","dependencies":[{"issue_id":"codex-8ay.6","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:29.153743513+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.7","title":"Resolve snapshot files - accept upstream","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-15T12:54:41.13876698+01:00","updated_at":"2025-12-18T12:36:10.399677367+01:00","closed_at":"2025-12-18T12:36:10.399677367+01:00","dependencies":[{"issue_id":"codex-8ay.7","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:41.139172404+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.8","title":"Resolve CI/workflow files - accept upstream","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-15T12:54:50.07028695+01:00","updated_at":"2025-12-18T12:36:10.397942411+01:00","closed_at":"2025-12-18T12:36:10.397942411+01:00","dependencies":[{"issue_id":"codex-8ay.8","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:54:50.070745676+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8ay.9","title":"Resolve tui/tui2 conflicts - accept upstream, preserve customizations","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T12:55:00.022732573+01:00","updated_at":"2025-12-18T12:36:10.399841891+01:00","closed_at":"2025-12-18T12:36:10.399841891+01:00","dependencies":[{"issue_id":"codex-8ay.9","depends_on_id":"codex-8ay","type":"parent-child","created_at":"2025-12-15T12:55:00.02329124+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-8k0","title":"Drop legacy execpolicy + local providers","description":"Goal: reduce fork complexity and future upstream merge friction by removing two unused stacks.\n\nScope:\n1) Remove execpolicy-legacy:\n- Delete the codex-execpolicy-legacy crate and remove execpolicy-legacy from the workspace.\n- Remove any remaining references in docs, tests, and Cargo manifests/lockfile.\n\n2) Remove local providers:\n- Delete codex-lmstudio and codex-ollama crates and remove them from the workspace.\n- Remove OSS-provider plumbing tied to these crates (oss_provider config option, LMSTUDIO/OLLAMA provider IDs/ports/constants, ensure_oss_ready helpers).\n- Remove CLI/TUI flags and help text for choosing local providers.\n- Update docs and tests/snapshots that mention local providers.\n\nDone when:\n- Workspace builds and tests pass without these crates.\n- No code/docs mention execpolicy-legacy, lmstudio, ollama, or oss_provider.\n- CLI/TUI help output no longer offers local providers.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-12T00:46:52.037997823+01:00","updated_at":"2025-12-12T01:08:24.078052292+01:00","closed_at":"2025-12-12T01:08:24.078052292+01:00"}
{"id":"codex-8k0.1","title":"Clean CLI/TUI + docs/tests","description":"Follow-up cleanup after dropping local providers:\n- Remove local-provider CLI/TUI flags and any related help text.\n- Update docs and example config to remove oss_provider and local provider mention.\n- Update or delete tests/snapshots referencing lmstudio or ollama.\n- Run targeted tests for affected crates.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.724088879+01:00","updated_at":"2025-12-12T01:08:19.386507206+01:00","closed_at":"2025-12-12T01:08:19.386507206+01:00","dependencies":[{"issue_id":"codex-8k0.1","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.724700548+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-8k0.2","title":"Remove lmstudio/ollama crates","description":"Delete local provider crates:\n- Remove lmstudio and ollama from codex-rs/Cargo.toml workspace members and workspace dependencies.\n- Delete codex-rs/lmstudio and codex-rs/ollama crate directories.\n- Remove their usage from codex-common OSS helper, codex-core model provider registry, and config parsing.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.749404256+01:00","updated_at":"2025-12-12T01:08:09.414548804+01:00","closed_at":"2025-12-12T01:08:09.414548804+01:00","dependencies":[{"issue_id":"codex-8k0.2","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.74966263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-8k0.3","title":"Remove execpolicy-legacy crate","description":"Delete codex-execpolicy-legacy:\n- Remove execpolicy-legacy from codex-rs/Cargo.toml workspace members and workspace dependencies.\n- Delete codex-rs/execpolicy-legacy crate directory.\n- Remove references to the legacy matcher/binary from execpolicy README and any docs/tests.\n- Regenerate Cargo.lock and ensure no dependency edges remain.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T00:47:23.760783007+01:00","updated_at":"2025-12-12T01:08:13.729300306+01:00","closed_at":"2025-12-12T01:08:13.729300306+01:00","dependencies":[{"issue_id":"codex-8k0.3","depends_on_id":"codex-8k0","type":"parent-child","created_at":"2025-12-12T00:47:23.761067881+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-90v","title":"Task routing: restore builtin review/search system prompts","description":"P0 regression: task-based delegation replaced persona subagents, but built-in task types \"review\" and \"search\" no longer include the system prompts that enforce required output formats/instructions. The TUI has special handling for task_type==\"review\" and expects a structured JSON review_output; without the old review prompt, delegated review tasks may break.","acceptance_criteria":"- Built-in \"review\" and \"search\" task types inject the same (or equivalent) system prompts as the previous review.md/finder.md subagents while keeping short descriptions for tool listings.\n- TUI review-mode parsing continues to work for delegated task_type=review.\n- Tests cover the regression and pass: cargo test -p codex-core, cargo test -p codex-tui.","status":"closed","issue_type":"bug","created_at":"2026-01-14T00:33:40.315042999+01:00","updated_at":"2026-01-14T01:08:34.669434393+01:00","closed_at":"2026-01-14T01:08:34.669434393+01:00","close_reason":"Restored builtin review/search system prompts","dependencies":[{"issue_id":"codex-90v","depends_on_id":"codex-jq3","type":"discovered-from","created_at":"2026-01-14T00:33:40.319091338+01:00","created_by":"daemon"}]}
{"id":"codex-92f","title":"Handoff Feature - Continue work in new focused thread","description":"## Handoff Feature\n\nImplement Amp-style handoff for Codex - a user-initiated way to continue work in a new focused thread instead of compacting.\n\n### Reference\n- Amp handoff documentation: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n\n### Key Concepts\n- **User-initiated only**: Triggered via `/handoff \u003cgoal\u003e` command\n- **Creates NEW thread**: Original remains intact, new session gets extracted context\n- **Draft review**: User can review/edit extracted context before confirming\n- **Parent-child relationship**: Traceability between sessions in rollout files\n- **Selective extraction**: LLM extracts only what's relevant to the stated goal\n\n### Architecture Decision\nImplementing as **First-Class Session Operation** (Solution 3):\n- Protocol changes: Op::Handoff, EventMsg::HandoffDraft, SessionSource::Handoff\n- Core: HandoffTask similar to CompactTask\n- TUI: /handoff command + draft review screen\n- Rollout: Parent-child links in metadata\n\n### Why not alternatives?\n- Solution 1 (Enhanced Fork): No special rollout item, loses traceability\n- Solution 2 (Tool Call): Fights tool system, awkward interception\n\n### MVP Scope\n1. /handoff command\n2. Extraction with structured output\n3. New session creation\n4. Parent-child in rollout\n5. Read-only draft review\n\n### Future (post-MVP)\n- Editable draft review\n- Fallback model on context limit (90% warning)\n- read_parent_thread tool\n- File validation","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T20:03:16.034385303+01:00","updated_at":"2025-12-20T23:31:14.865315821+01:00","closed_at":"2025-12-20T23:31:14.865315821+01:00"}
{"id":"codex-92f.1","title":"Add Handoff protocol types to codex-protocol","description":"## Protocol Changes for Handoff\n\nAdd the following types to `protocol/src/protocol.rs`:\n\n### New Op variants\n```rust\npub enum Op {\n    // ... existing ...\n    Handoff { goal: String },\n    ConfirmHandoff { draft: HandoffDraft },\n    CancelHandoff,\n}\n```\n\n### New Event variants\n```rust\npub enum EventMsg {\n    // ... existing ...\n    HandoffDraft(HandoffDraftEvent),\n    HandoffCompleted(HandoffCompletedEvent),\n}\n```\n\n### New types\n```rust\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffDraftEvent {\n    pub summary: String,           // Extracted context (first-person perspective)\n    pub goal: String,              // User's stated goal\n    pub relevant_files: Vec\u003cPathBuf\u003e,\n    pub parent_id: ConversationId,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffDraft {\n    pub summary: String,\n    pub goal: String,\n    pub relevant_files: Vec\u003cPathBuf\u003e,\n    pub parent_id: ConversationId,\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema, TS)]\npub struct HandoffCompletedEvent {\n    pub new_session_id: ConversationId,\n}\n```\n\n### Extend SessionSource\n```rust\npub enum SessionSource {\n    Cli,\n    Tui,\n    AppServer,\n    Handoff { parent_id: ConversationId, goal: String },  // NEW\n}\n```\n\n### Extend InitialHistory\n```rust\npub enum InitialHistory {\n    New,\n    Resumed(ResumedHistory),\n    Forked(Vec\u003cRolloutItem\u003e),\n    Handoff { context: Vec\u003cRolloutItem\u003e, parent_id: ConversationId },  // NEW\n}\n```\n\n### Files to modify\n- `protocol/src/protocol.rs` - main types\n- `protocol/src/lib.rs` - exports\n\n### Testing\n- Add serialization/deserialization tests for new types\n- Ensure JsonSchema and TS derive work correctly\n\n### Reference\n- Amp handoff: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Existing SessionSource in protocol.rs for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:03:45.39588034+01:00","updated_at":"2025-12-20T20:20:38.930694668+01:00","closed_at":"2025-12-20T20:20:38.930694668+01:00","dependencies":[{"issue_id":"codex-92f.1","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:03:45.396236239+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.2","title":"Implement HandoffTask in codex-core","description":"## HandoffTask Implementation\n\nCreate `core/src/tasks/handoff.rs` - a task that extracts relevant context from the conversation for handoff.\n\n### Task Structure\n```rust\npub struct HandoffTask {\n    pub goal: String,\n}\n\nimpl SessionTask for HandoffTask {\n    fn kind(\u0026self) -\u003e TaskKind { TaskKind::Regular }\n    \n    async fn run(...) -\u003e Option\u003cString\u003e {\n        // 1. Build extraction prompt with conversation + goal\n        // 2. Run extraction using current model\n        // 3. Parse structured output (JSON with summary + files)\n        // 4. Emit EventMsg::HandoffDraft\n        // 5. Return None (don't continue turn)\n    }\n    \n    async fn abort(...) { /* Cancel gracefully */ }\n}\n```\n\n### Extraction Prompt\nUse Amp's extraction prompt pattern (from handoff.md):\n```\nExtract relevant context from the conversation above for continuing this work.\nWrite from my perspective (first person: \"I did...\", \"I told you...\").\n\nConsider what would be useful based on my request:\n- What did I just do or implement?\n- What instructions did I already give you which are still relevant?\n- What files am I working on?\n- Did I provide a plan or spec that should be included?\n- What libraries, patterns, constraints, or preferences did I mention?\n- What important technical details did I discover?\n- What caveats, limitations, or open questions exist?\n\nExtract what matters for the specific request. Don't answer irrelevant questions.\nPick an appropriate length based on complexity.\n\nFocus on capabilities and behavior, not file-by-file changes.\nAvoid excessive implementation details unless critical.\n\nFormat your response as JSON:\n{\n  \"summary\": \"Plain text with bullets. No markdown headers.\",\n  \"files\": [\"path/to/file1.rs\", \"path/to/dir/\"]\n}\n\nMy request:\n```\n\n### Store template\nCreate `core/templates/handoff/extraction_prompt.md` for the prompt template.\n\n### Structured Output Parsing\n- Parse JSON response from model\n- Handle malformed JSON gracefully (try to extract summary at minimum)\n- Validate file paths exist (warn if not, but include anyway)\n\n### Files to create/modify\n- `core/src/tasks/handoff.rs` - new file\n- `core/src/tasks/mod.rs` - add module\n- `core/templates/handoff/extraction_prompt.md` - prompt template\n\n### Pattern to follow\n- Look at `core/src/tasks/compact.rs` for similar task structure\n- Look at `core/src/compact.rs` for how extraction prompts work\n\n### Testing\n- Unit test for prompt construction\n- Unit test for JSON parsing (valid, malformed cases)\n- Integration test with mock model response\n\n### Reference\n- Amp handoff: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Existing CompactTask for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:07.401767285+01:00","updated_at":"2025-12-20T20:38:04.70867295+01:00","closed_at":"2025-12-20T20:38:04.70867295+01:00","dependencies":[{"issue_id":"codex-92f.2","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:07.402097454+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.2","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:07.392706026+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.3","title":"Add create_handoff_conversation to ConversationManager","description":"## ConversationManager Handoff Support\n\nAdd method to create a new conversation from a handoff draft.\n\n### Method Signature\n```rust\nimpl ConversationManager {\n    pub async fn create_handoff_conversation(\n        \u0026self,\n        draft: HandoffDraft,\n        config: Config,\n    ) -\u003e CodexResult\u003cNewConversation\u003e {\n        // 1. Build initial context message\n        // 2. Build goal message  \n        // 3. Create InitialHistory::Handoff\n        // 4. Spawn with SessionSource::Handoff\n        // 5. Return NewConversation\n    }\n}\n```\n\n### Initial Context Message Format\nFollowing Amp's pattern:\n```\nContinuing work from thread {parent_id}. When you lack specific information you can use read_thread to get it.\n\n@file1.ts @file2.ts @dir/\n\nOther relevant files: path/to/file3.ts, path/to/file4.ts\n\n{extracted_summary}\n```\n\n### File Mentions\n- First 12 files get `@` prefix (attached/mentioned)\n- Remaining files listed as \"Other relevant files: ...\"\n- Use workspace-relative paths\n\n### Session Source\nUse new `SessionSource::Handoff { parent_id, goal }` to track lineage.\n\n### Files to modify\n- `core/src/conversation_manager.rs` - add method\n- May need to adjust `Codex::spawn` if InitialHistory::Handoff needs special handling\n\n### Pattern to follow\n- Look at `fork_conversation()` for similar pattern\n- Look at `resume_conversation_with_history()` for how to pass initial history\n\n### Testing\n- Unit test for context message formatting\n- Integration test creating handoff conversation\n\n### Reference\n- Amp handoff message format in handoff.md\n- Existing fork_conversation for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:23.53626433+01:00","updated_at":"2025-12-20T20:38:04.716029202+01:00","closed_at":"2025-12-20T20:38:04.716029202+01:00","dependencies":[{"issue_id":"codex-92f.3","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:23.536659754+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.3","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:08.70140454+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.4","title":"Handle Op::Handoff in codex session loop","description":"## Session Loop Handoff Handling\n\nWire up Op::Handoff and Op::ConfirmHandoff/CancelHandoff in the session submission handler.\n\n### Op::Handoff handling\nIn the session's submission processing (likely in `codex.rs` or related):\n```rust\nOp::Handoff { goal } =\u003e {\n    // 1. Validate not already in a task\n    // 2. Create HandoffTask { goal }\n    // 3. Spawn task (similar to compact task)\n    // 4. Task will emit HandoffDraftReady event when done\n}\n```\n\n### Op::ConfirmHandoff handling\n```rust\nOp::ConfirmHandoff { draft } =\u003e {\n    // 1. Call conversation_manager.create_handoff_conversation(draft, config)\n    // 2. Record HandoffItem in parent's rollout\n    // 3. Emit HandoffCompleted { new_session_id }\n    // 4. (TUI will handle switching to new session)\n}\n```\n\n### Op::CancelHandoff handling\n```rust\nOp::CancelHandoff =\u003e {\n    // 1. Clear any pending handoff state\n    // 2. No-op if nothing pending\n    // 3. Maybe emit event to confirm cancellation?\n}\n```\n\n### Rollout Recording\nWhen handoff completes, record in parent's rollout:\n```rust\nRolloutItem::Handoff(HandoffItem {\n    child_id: new_session_id,\n    goal: draft.goal,\n    timestamp: now(),\n})\n```\n\n### Files to modify\n- `core/src/codex.rs` - handle new Op variants in submission handler\n- May need to add HandoffItem to rollout types\n\n### Pattern to follow\n- Look at how Op::Compact is handled\n- Look at how Op::UserTurn spawns tasks\n\n### Testing\n- Integration test: submit Op::Handoff, verify HandoffDraft event emitted\n- Integration test: submit Op::ConfirmHandoff, verify new session created\n\n### Reference\n- Existing Op handling in codex.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:39.171018009+01:00","updated_at":"2025-12-20T20:45:55.852392637+01:00","closed_at":"2025-12-20T20:45:55.852392637+01:00","dependencies":[{"issue_id":"codex-92f.4","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:39.171386823+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.4","depends_on_id":"codex-92f.2","type":"blocks","created_at":"2025-12-20T20:06:09.969531781+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.4","depends_on_id":"codex-92f.3","type":"blocks","created_at":"2025-12-20T20:06:11.615432852+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.5","title":"Add /handoff slash command to TUI","description":"## TUI Slash Command\n\nAdd `/handoff \u003cgoal\u003e` command to the TUI.\n\n### SlashCommand enum\nIn `tui/src/slash_command.rs`:\n```rust\npub enum SlashCommand {\n    // ... existing ...\n    Handoff,  // Add after Review or in logical position\n}\n\nimpl SlashCommand {\n    pub fn description(self) -\u003e \u0026'static str {\n        match self {\n            // ... existing ...\n            SlashCommand::Handoff =\u003e \"continue work in a new focused thread\",\n        }\n    }\n    \n    pub fn available_during_task(self) -\u003e bool {\n        match self {\n            // ... existing ...\n            SlashCommand::Handoff =\u003e false,  // Cannot handoff while task running\n        }\n    }\n}\n```\n\n### Command invocation\nWhen user types `/handoff implement feature X`:\n1. Parse the goal (everything after `/handoff `)\n2. Submit `Op::Handoff { goal }` to core\n3. Wait for `EventMsg::HandoffDraft` response\n\n### Goal parsing\n- `/handoff` alone → show error \"Please provide a goal\"\n- `/handoff \u003cgoal\u003e` → submit with goal\n\n### Files to modify\n- `tui/src/slash_command.rs` - add enum variant\n- `tui/src/bottom_pane/chat_composer.rs` - handle command submission\n- `tui/src/app.rs` - wire up Op submission\n\n### Pattern to follow\n- Look at how /compact command is handled\n- Look at how /new command is handled\n\n### Testing\n- Verify command appears in slash command popup\n- Verify command sends correct Op\n\n### Reference\n- Existing slash commands for pattern","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:04:54.035096396+01:00","updated_at":"2025-12-20T20:38:04.722426832+01:00","closed_at":"2025-12-20T20:38:04.722426832+01:00","dependencies":[{"issue_id":"codex-92f.5","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:04:54.035405565+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.5","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:19.527512561+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.6","title":"Implement TUI handoff draft review screen","description":"## Handoff Draft Review Screen\n\nCreate a review screen in TUI that shows the extracted handoff draft for user review before confirming.\n\n### UI Design\nWhen `EventMsg::HandoffDraft` is received, show a review screen:\n\n```\n┌─────────────────────────────────────────────────────┐\n│ Handoff to new thread                               │\n├─────────────────────────────────────────────────────┤\n│ Goal: implement for teams                           │\n├─────────────────────────────────────────────────────┤\n│ Extracted Context:                                  │\n│ ─────────────────                                   │\n│ - I implemented user authentication with JWT        │\n│ - I'm using the auth-lib crate for token validation │\n│ - The login endpoint is at src/api/auth.rs          │\n│ - Need to add team-based permissions next           │\n│                                                     │\n├─────────────────────────────────────────────────────┤\n│ Relevant Files:                                     │\n│ ─────────────────                                   │\n│ • src/api/auth.rs                                   │\n│ • src/models/user.rs                                │\n│ • src/lib.rs                                        │\n│                                                     │\n├─────────────────────────────────────────────────────┤\n│ [Enter] Confirm  [Esc] Cancel                       │\n└─────────────────────────────────────────────────────┘\n```\n\n### MVP: Read-only review\n- Show summary text (scrollable if long)\n- Show file list\n- Show goal\n- Enter to confirm, Esc to cancel\n- No editing in MVP\n\n### Key bindings\n- `Enter` → Submit `Op::ConfirmHandoff { draft }`\n- `Esc` → Submit `Op::CancelHandoff`, return to chat\n\n### State management\nNeed to track:\n- `pending_handoff_draft: Option\u003cHandoffDraft\u003e`\n- When draft received, switch to review mode\n- When confirmed/cancelled, clear and switch back\n\n### Files to create/modify\n- `tui/src/handoff_review.rs` - new widget/component\n- `tui/src/app.rs` - handle EventMsg::HandoffDraft, manage state\n- `tui/src/lib.rs` or `tui/src/mod.rs` - add module\n\n### Pattern to follow\n- Look at `tui/src/bottom_pane/command_popup.rs` for modal patterns\n- Look at approval request handling for similar confirm/cancel flow\n\n### Styling\nFollow tui/styles.md conventions:\n- Use \".dim()\" for labels\n- Use standard borders\n- Keep it clean and readable\n\n### Testing\n- Snapshot test for draft review rendering\n- Test key handling (Enter/Esc)\n\n### Reference\n- Amp shows draft as editable before sending\n- MVP: read-only is fine","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:13.894665918+01:00","updated_at":"2025-12-20T20:45:55.859339608+01:00","closed_at":"2025-12-20T20:45:55.859339608+01:00","dependencies":[{"issue_id":"codex-92f.6","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:13.895040913+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.6","depends_on_id":"codex-92f.5","type":"blocks","created_at":"2025-12-20T20:06:19.535012747+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.7","title":"Handle session switch after handoff confirmation","description":"## Session Switch After Handoff\n\nWhen handoff is confirmed and new session is created, TUI needs to switch to the new session.\n\n### Flow\n1. User confirms handoff draft\n2. TUI sends `Op::ConfirmHandoff { draft }`\n3. Core creates new session via ConversationManager\n4. Core emits `EventMsg::HandoffCompleted { new_session_id }`\n5. TUI receives event\n6. TUI switches active session to new_session_id\n7. New session starts with context + goal already submitted\n\n### TUI State Changes\nIn app.rs or session management:\n```rust\nEventMsg::HandoffCompleted(event) =\u003e {\n    // 1. Clear handoff review state\n    self.pending_handoff_draft = None;\n    \n    // 2. Switch to new session\n    self.switch_to_session(event.new_session_id).await?;\n    \n    // 3. Clear chat history display (new session has its own)\n    self.clear_message_display();\n    \n    // 4. The new session's first turn is already running\n    //    (goal was submitted as part of handoff)\n}\n```\n\n### Auto-submit goal\nThe new session should automatically have the goal submitted as the first user message. This happens in `create_handoff_conversation` - the goal is part of the initial history.\n\nThe new session should immediately start processing (like a resume with a pending message).\n\n### Parent session handling\nAfter handoff, what happens to parent session?\n- Option A: Close parent session\n- Option B: Keep parent available (user can /resume it)\n\nRecommendation: Option B - keep parent. User may want to go back. The handoff is recorded in parent's rollout.\n\n### Files to modify\n- `tui/src/app.rs` - handle HandoffCompleted event\n- May need session switching logic if not already present\n\n### Pattern to follow\n- Look at how /new starts a new session\n- Look at how /resume switches sessions\n\n### Testing\n- Integration test: confirm handoff, verify session switch\n- Verify parent session still accessible via /resume\n\n### Reference\n- Amp creates new thread, original remains","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:32.308769081+01:00","updated_at":"2025-12-20T20:49:30.530796988+01:00","closed_at":"2025-12-20T20:49:30.530796988+01:00","dependencies":[{"issue_id":"codex-92f.7","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:32.309090314+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.7","depends_on_id":"codex-92f.6","type":"blocks","created_at":"2025-12-20T20:06:19.541408226+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.7","depends_on_id":"codex-92f.4","type":"blocks","created_at":"2025-12-20T20:06:19.548070715+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-92f.8","title":"Record handoff in rollout files","description":"## Rollout Traceability for Handoff\n\nEnsure handoff creates proper audit trail in rollout files for both parent and child sessions.\n\n### Parent Rollout\nWhen handoff completes, add to parent's rollout:\n```json\n{\"type\": \"handoff\", \"child_id\": \"abc-123\", \"goal\": \"implement for teams\", \"timestamp\": \"2025-01-15T10:30:00Z\"}\n```\n\n### Child Rollout Metadata\nChild session's rollout should have:\n```json\n{\n  \"source\": {\n    \"type\": \"handoff\", \n    \"parent_id\": \"xyz-789\", \n    \"goal\": \"implement for teams\"\n  },\n  \"id\": \"abc-123\",\n  \"timestamp\": \"...\",\n  \"cwd\": \"...\",\n  ...\n}\n```\n\n### RolloutItem Extension\nAdd new rollout item type:\n```rust\npub enum RolloutItem {\n    // ... existing ...\n    Handoff(HandoffRolloutItem),\n}\n\n#[derive(Debug, Clone, Serialize, Deserialize)]\npub struct HandoffRolloutItem {\n    pub child_id: ConversationId,\n    pub goal: String,\n    pub timestamp: String,\n}\n```\n\n### SessionMeta Extension\nEnsure SessionMeta supports handoff source:\n```rust\npub enum SessionSource {\n    Cli,\n    Tui,\n    AppServer,\n    Handoff { parent_id: ConversationId, goal: String },\n}\n```\n\n### Recording Points\n1. In `Op::ConfirmHandoff` handler, after creating child session:\n   - Persist HandoffRolloutItem to parent's rollout\n2. In `RolloutRecorder::new` for child session:\n   - Serialize SessionSource::Handoff to metadata\n\n### Files to modify\n- `protocol/src/protocol.rs` - RolloutItem variant (if not already)\n- `core/src/rollout/recorder.rs` - handle handoff source in metadata\n- `core/src/codex.rs` - persist handoff item when confirming\n\n### Pattern to follow\n- Look at how CompactedItem is recorded\n- Look at SessionMeta serialization\n\n### Testing\n- Verify parent rollout contains handoff item\n- Verify child rollout has correct source metadata\n- Test rollout replay with handoff items\n\n### Use Case\nThis enables:\n- Tracing conversation lineage\n- Future: navigate to parent from child\n- Future: read_parent_thread tool\n\n### Reference\n- Amp tracks thread relationships with parent/child links","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T20:05:51.80215288+01:00","updated_at":"2025-12-20T20:38:04.728926918+01:00","closed_at":"2025-12-20T20:38:04.728926918+01:00","dependencies":[{"issue_id":"codex-92f.8","depends_on_id":"codex-92f","type":"parent-child","created_at":"2025-12-20T20:05:51.802548605+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-92f.8","depends_on_id":"codex-92f.1","type":"blocks","created_at":"2025-12-20T20:06:19.564872423+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q","title":"Agent-routed custom prompts (Option C)","description":"## Overview\n\nExtend the existing custom prompts system (`~/.codex/prompts/*.md`) to support agent routing. When a prompt has an `agent` field in its frontmatter, it becomes an 'agent command' that delegates execution to a subagent via the task tool.\n\n## Goals\n\n1. Add `agent: Option\u003cString\u003e` field to `CustomPrompt` struct\n2. Parse the `agent` field from frontmatter during prompt discovery\n3. Validate that referenced agents exist in the subagent registry\n4. Route agent-enabled prompts through the task tool instead of inline submission\n5. Maintain full backward compatibility with existing prompts\n\n## Design (Option C: Unified with Mode Detection)\n\n**Behavior:**\n- If `agent` is set → always run as subtask via task tool\n- If no `agent` → pure text expansion (current behavior)\n- No separate `subtask` field needed - presence of `agent` determines behavior\n\n**Example prompt file (`~/.codex/prompts/explore.md`):**\n```markdown\n---\ndescription: Fast codebase exploration\nagent: explorer\n---\nFind files matching $1 and explain their purpose.\n```\n\n## Success Criteria\n\n- Prompts without `agent` work exactly as before\n- Prompts with `agent` execute via task tool delegation\n- Invalid agent references produce clear error messages at load time\n- TUI popup shows agent-enabled prompts distinctly (optional enhancement)\n\n## References\n\n- OpenCode's task.ts: `third-party/opencode/packages/opencode/src/tool/task.ts`\n- Existing prompt system: `core/src/custom_prompts.rs`\n- Task tool handler: `core/src/tools/handlers/task.rs`\n- Subagent registry: `core/src/subagents.rs`","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-13T12:12:37.062374714+01:00","updated_at":"2025-12-13T20:38:29.833200397+01:00","closed_at":"2025-12-13T20:38:29.833200397+01:00"}
{"id":"codex-96q.1","title":"Add agent field to CustomPrompt struct","description":"## What\n\nAdd an optional `agent` field to the `CustomPrompt` struct in the protocol crate.\n\n## Why\n\nThis field will indicate which subagent should handle the prompt execution. Its presence determines whether the prompt is a simple text expansion or an agent-routed command.\n\n## How\n\n### File: `protocol/src/custom_prompts.rs`\n\n```rust\n#[derive(Serialize, Deserialize, Debug, Clone, JsonSchema, TS)]\npub struct CustomPrompt {\n    pub name: String,\n    pub path: PathBuf,\n    pub content: String,\n    pub description: Option\u003cString\u003e,\n    pub argument_hint: Option\u003cString\u003e,\n    /// Subagent slug to route this prompt to. When set, the prompt\n    /// will be executed via the task tool instead of inline submission.\n    pub agent: Option\u003cString\u003e,\n}\n```\n\n### Add helper method\n\n```rust\nimpl CustomPrompt {\n    /// Returns true if this prompt should be delegated to an agent.\n    pub fn is_agent_command(\u0026self) -\u003e bool {\n        self.agent.is_some()\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `agent: Option\u003cString\u003e` field added to `CustomPrompt`\n- [ ] `is_agent_command()` helper method implemented\n- [ ] TypeScript types regenerated (if using ts-rs)\n- [ ] Existing tests still pass\n- [ ] `cargo test -p codex-protocol` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:01.387080446+01:00","updated_at":"2025-12-13T12:25:09.133976456+01:00","closed_at":"2025-12-13T12:25:09.133976456+01:00","dependencies":[{"issue_id":"codex-96q.1","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:01.38752217+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.2","title":"Parse agent field from frontmatter","description":"## What\n\nUpdate the frontmatter parser in `core/src/custom_prompts.rs` to extract the `agent` field.\n\n## Why\n\nThe `agent` field needs to be parsed from the YAML frontmatter so that the TUI can determine how to handle the prompt.\n\n## How\n\n### File: `core/src/custom_prompts.rs`\n\nUpdate `parse_frontmatter()` function to return the agent field:\n\n```rust\n/// Parse optional YAML-like frontmatter at the beginning of `content`.\n/// Supported keys:\n/// - `description`: short description shown in the slash popup\n/// - `argument-hint` or `argument_hint`: brief hint string\n/// - `agent`: subagent slug to route execution to\n/// Returns (description, argument_hint, agent, body_without_frontmatter).\nfn parse_frontmatter(content: \u0026str) -\u003e (Option\u003cString\u003e, Option\u003cString\u003e, Option\u003cString\u003e, String) {\n    // ... existing logic ...\n    \n    match key.as_str() {\n        \"description\" =\u003e desc = Some(val),\n        \"argument-hint\" | \"argument_hint\" =\u003e hint = Some(val),\n        \"agent\" =\u003e agent = Some(val),  // NEW\n        _ =\u003e {}\n    }\n    \n    // ...\n    (desc, hint, agent, body)\n}\n```\n\n### Update `discover_prompts_in_excluding()`\n\nPass the parsed `agent` field to `CustomPrompt`:\n\n```rust\nlet (description, argument_hint, agent, body) = parse_frontmatter(\u0026content);\nout.push(CustomPrompt {\n    name,\n    path,\n    content: body,\n    description,\n    argument_hint,\n    agent,  // NEW\n});\n```\n\n## Acceptance Criteria\n\n- [ ] `parse_frontmatter()` returns 4-tuple including `agent`\n- [ ] `discover_prompts_in_excluding()` populates `agent` field\n- [ ] Add test for parsing agent from frontmatter\n- [ ] Existing frontmatter tests still pass\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:14.962714261+01:00","updated_at":"2025-12-13T12:25:09.150284906+01:00","closed_at":"2025-12-13T12:25:09.150284906+01:00","dependencies":[{"issue_id":"codex-96q.2","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:14.963038731+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.2","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.377098701+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.3","title":"Add SubmitAgentPrompt event to AppEvent","description":"## What\n\nAdd a new `AppEvent` variant for submitting agent-routed prompts.\n\n## Why\n\nThe TUI needs a way to signal that a prompt should be executed via the task tool rather than as a normal user message. This event will carry the expanded prompt content and target agent.\n\n## How\n\n### File: `tui/src/app_event.rs`\n\nAdd new variant:\n\n```rust\n#[derive(Debug)]\npub(crate) enum AppEvent {\n    // ... existing variants ...\n    \n    /// Submit a prompt to be executed by a specific subagent via the task tool.\n    /// This is triggered when a custom prompt has an `agent` field set.\n    SubmitAgentPrompt {\n        /// Short description for the task (typically the prompt name).\n        description: String,\n        /// The fully expanded prompt content to send to the agent.\n        prompt: String,\n        /// The subagent slug to route the task to.\n        agent: String,\n    },\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `SubmitAgentPrompt` variant added to `AppEvent`\n- [ ] Fields: `description`, `prompt`, `agent`\n- [ ] Compiles without errors\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:25.308996879+01:00","updated_at":"2025-12-13T12:25:09.156970512+01:00","closed_at":"2025-12-13T12:25:09.156970512+01:00","dependencies":[{"issue_id":"codex-96q.3","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:25.309333181+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.4","title":"Update ChatComposer to detect and route agent prompts","description":"## What\n\nModify `ChatComposer` to check if an expanded prompt has an `agent` field and emit the appropriate event.\n\n## Why\n\nThis is the core routing logic. When a user invokes a prompt with an `agent` field, instead of returning `InputResult::Submitted(text)`, we need to emit `SubmitAgentPrompt` event.\n\n## How\n\n### File: `tui/src/bottom_pane/chat_composer.rs`\n\n#### Option A: New InputResult variant (cleaner)\n\nAdd a new variant to `InputResult`:\n\n```rust\npub enum InputResult {\n    Submitted(String),\n    Command(SlashCommand),\n    AgentPrompt {\n        description: String,\n        prompt: String,\n        agent: String,\n    },\n    None,\n}\n```\n\n#### Update prompt expansion logic\n\nIn the Enter key handler where custom prompts are expanded:\n\n```rust\n// After expanding the prompt...\nif let Some(expanded) = expand_custom_prompt(first_line, \u0026self.custom_prompts) {\n    self.textarea.set_text(\"\");\n    \n    // Check if this is an agent-routed prompt\n    if let Some(agent) = prompt.agent.as_ref() {\n        return (\n            InputResult::AgentPrompt {\n                description: prompt.name.clone(),\n                prompt: expanded,\n                agent: agent.clone(),\n            },\n            true,\n        );\n    }\n    \n    // Normal text expansion (existing behavior)\n    return (InputResult::Submitted(expanded), true);\n}\n```\n\n#### Key insight\n\nThe `CustomPrompt` struct is already available in the composer via `self.custom_prompts`. After matching the prompt by name, check its `agent` field before deciding the return type.\n\n## Acceptance Criteria\n\n- [ ] `InputResult::AgentPrompt` variant added (or similar mechanism)\n- [ ] Prompts with `agent` field return `AgentPrompt` result\n- [ ] Prompts without `agent` field work as before\n- [ ] Snapshot tests updated if needed\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:39.306812294+01:00","updated_at":"2025-12-13T12:25:09.163272588+01:00","closed_at":"2025-12-13T12:25:09.163272588+01:00","dependencies":[{"issue_id":"codex-96q.4","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:39.307184735+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.386700154+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.2","type":"blocks","created_at":"2025-12-13T12:15:14.395294075+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.4","depends_on_id":"codex-96q.3","type":"blocks","created_at":"2025-12-13T12:15:14.405516864+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.5","title":"Handle SubmitAgentPrompt in App","description":"## What\n\nHandle the new `SubmitAgentPrompt` event (or `InputResult::AgentPrompt`) in the App layer to invoke the task tool.\n\n## Why\n\nThe App layer is responsible for translating UI events into core operations. When an agent prompt is submitted, we need to construct and send the appropriate operation to invoke the task tool.\n\n## How\n\n### File: `tui/src/app.rs`\n\nAdd handler for the new event/result:\n\n```rust\n// In handle_app_event() or equivalent:\nAppEvent::SubmitAgentPrompt { description, prompt, agent } =\u003e {\n    // Construct a user message that will trigger the task tool\n    // The task tool expects: description, prompt, subagent_type, session_id\n    \n    // Option 1: Synthesize a function call directly (complex)\n    // Option 2: Submit as a special user message that core interprets\n    // Option 3: Create a new Op variant for agent prompts\n    \n    // Recommended: Use Op::UserInput with a structured message that\n    // the model will interpret as a task delegation request\n    let task_request = format!(\n        \"Please delegate this task to the {} agent:\\n\\n{}\\n\\nTask description: {}\",\n        agent, prompt, description\n    );\n    \n    self.submit_user_message(task_request);\n}\n```\n\n### Alternative: Direct task tool invocation\n\nIf we want guaranteed routing (not relying on model interpretation):\n\n```rust\n// Create a synthetic function call for the task tool\nlet task_args = serde_json::json!({\n    \"description\": description,\n    \"prompt\": prompt,\n    \"subagent_type\": agent,\n});\n\n// This would require exposing task tool invocation from core\nself.invoke_task_tool(task_args);\n```\n\n### Considerations\n\n- **Option 1 (Prompt-based)**: Simpler, but relies on model understanding\n- **Option 2 (Direct invocation)**: Deterministic, but requires core changes\n\nRecommend starting with Option 1 for simplicity, with Option 2 as a future enhancement.\n\n## Acceptance Criteria\n\n- [ ] `SubmitAgentPrompt` event handled in App\n- [ ] Agent prompts trigger task delegation\n- [ ] User sees appropriate feedback in chat\n- [ ] Error handling for unknown agents\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:13:56.036505571+01:00","updated_at":"2025-12-13T12:25:09.170122158+01:00","closed_at":"2025-12-13T12:25:09.170122158+01:00","dependencies":[{"issue_id":"codex-96q.5","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:13:56.036879856+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.5","depends_on_id":"codex-96q.4","type":"blocks","created_at":"2025-12-13T12:15:14.414837571+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.6","title":"Validate agent references at prompt load time","description":"## What\n\nWhen loading custom prompts, validate that any `agent` field references an existing subagent.\n\n## Why\n\nEarly validation provides clear error messages and prevents runtime failures. Users should know immediately if their prompt references a non-existent agent.\n\n## How\n\n### Option A: Validation during discovery (recommended)\n\nAdd a validation function that checks prompts against the subagent registry:\n\n```rust\n// core/src/custom_prompts.rs\n\npub struct PromptLoadOutcome {\n    pub prompts: Vec\u003cCustomPrompt\u003e,\n    pub errors: Vec\u003cPromptLoadError\u003e,\n}\n\npub struct PromptLoadError {\n    pub path: PathBuf,\n    pub message: String,\n}\n\n/// Validate that all agent references in prompts exist in the registry.\npub fn validate_prompts(\n    prompts: \u0026[CustomPrompt],\n    agent_slugs: \u0026HashSet\u003cString\u003e,\n) -\u003e Vec\u003cPromptLoadError\u003e {\n    prompts\n        .iter()\n        .filter_map(|p| {\n            if let Some(ref agent) = p.agent {\n                if !agent_slugs.contains(agent) {\n                    return Some(PromptLoadError {\n                        path: p.path.clone(),\n                        message: format!(\n                            \"Agent '{}' not found. Available agents: {:?}\",\n                            agent,\n                            agent_slugs.iter().collect::\u003cVec\u003c_\u003e\u003e()\n                        ),\n                    });\n                }\n            }\n            None\n        })\n        .collect()\n}\n```\n\n### Integration point\n\nCall validation after loading prompts and subagents in the session initialization:\n\n```rust\nlet prompts = discover_prompts_in(\u0026prompts_dir).await;\nlet agents = SubagentRegistry::new(\u0026codex_home);\nlet agent_slugs: HashSet\u003c_\u003e = agents.list().iter().map(|a| a.slug.clone()).collect();\nlet errors = validate_prompts(\u0026prompts, \u0026agent_slugs);\n\nif !errors.is_empty() {\n    for err in \u0026errors {\n        warn!(\"Prompt validation error in {}: {}\", err.path.display(), err.message);\n    }\n}\n```\n\n### UI feedback\n\nOptionally show validation errors in the TUI status line or as a warning message.\n\n## Acceptance Criteria\n\n- [ ] `validate_prompts()` function implemented\n- [ ] Invalid agent references logged as warnings\n- [ ] Prompts with invalid agents still load (soft failure)\n- [ ] Clear error messages with available agent list\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T12:14:11.549891789+01:00","updated_at":"2025-12-13T12:25:09.176487394+01:00","closed_at":"2025-12-13T12:25:09.176487394+01:00","dependencies":[{"issue_id":"codex-96q.6","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:11.550219995+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.7","title":"Visual indicator for agent prompts in popup","description":"## What\n\nShow a visual indicator in the slash command popup to distinguish agent-routed prompts from regular text prompts.\n\n## Why\n\nUsers should be able to see at a glance which prompts will delegate to an agent vs. which will expand inline. This helps set expectations about behavior.\n\n## How\n\n### File: `tui/src/bottom_pane/command_popup.rs`\n\nUpdate the rendering to show agent indicator:\n\n```rust\n// When rendering CommandItem::UserPrompt:\nlet agent_indicator = match \u0026prompt.agent {\n    Some(agent) =\u003e format!(\" @{}\", agent).dim(),\n    None =\u003e Span::raw(\"\"),\n};\n\n// Build the line:\nlet line = Line::from(vec![\n    \"/prompts:\".dim(),\n    prompt.name.as_str().into(),\n    agent_indicator,\n    \" - \".dim(),\n    prompt.description.as_deref().unwrap_or(\"\").dim(),\n]);\n```\n\n### Example display\n\n```\n/prompts:review - review my current changes\n/prompts:explore @explorer - fast codebase exploration\n/prompts:commit - git commit helper\n```\n\n### Alternative: Icon-based\n\n```\n/prompts:review - review my current changes\n/prompts:explore 🤖 - fast codebase exploration\n/prompts:commit - git commit helper\n```\n\n## Acceptance Criteria\n\n- [ ] Agent prompts show indicator (e.g., `@agent` or icon)\n- [ ] Non-agent prompts display unchanged\n- [ ] Indicator is visually distinct but not distracting\n- [ ] Snapshot tests updated\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-13T12:14:24.914988828+01:00","updated_at":"2025-12-13T12:25:09.182068734+01:00","closed_at":"2025-12-13T12:25:09.182068734+01:00","dependencies":[{"issue_id":"codex-96q.7","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:24.915312997+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.8","title":"Add tests for agent-routed prompts","description":"## What\n\nAdd comprehensive tests for the agent-routed prompts feature.\n\n## Why\n\nTests ensure the feature works correctly and prevent regressions.\n\n## How\n\n### Protocol tests (`protocol/src/custom_prompts.rs`)\n\n```rust\n#[test]\nfn custom_prompt_is_agent_command() {\n    let prompt = CustomPrompt {\n        name: \"test\".to_string(),\n        path: PathBuf::from(\"/test.md\"),\n        content: \"test\".to_string(),\n        description: None,\n        argument_hint: None,\n        agent: Some(\"explorer\".to_string()),\n    };\n    assert!(prompt.is_agent_command());\n    \n    let regular = CustomPrompt {\n        agent: None,\n        ..prompt.clone()\n    };\n    assert!(!regular.is_agent_command());\n}\n```\n\n### Core tests (`core/src/custom_prompts.rs`)\n\n```rust\n#[tokio::test]\nasync fn parses_agent_from_frontmatter() {\n    let tmp = tempdir().expect(\"create TempDir\");\n    let dir = tmp.path();\n    let file = dir.join(\"explore.md\");\n    let text = \"---\\ndescription: Fast search\\nagent: explorer\\n---\\nFind files matching $1\";\n    fs::write(\u0026file, text).unwrap();\n\n    let found = discover_prompts_in(dir).await;\n    assert_eq!(found.len(), 1);\n    let p = \u0026found[0];\n    assert_eq!(p.name, \"explore\");\n    assert_eq!(p.agent.as_deref(), Some(\"explorer\"));\n}\n\n#[tokio::test]\nasync fn prompt_without_agent_has_none() {\n    let tmp = tempdir().expect(\"create TempDir\");\n    let dir = tmp.path();\n    fs::write(dir.join(\"simple.md\"), \"Just a prompt\").unwrap();\n\n    let found = discover_prompts_in(dir).await;\n    assert_eq!(found.len(), 1);\n    assert!(found[0].agent.is_none());\n}\n```\n\n### TUI tests (`tui/src/bottom_pane/chat_composer.rs`)\n\n```rust\n#[test]\nfn agent_prompt_returns_agent_result() {\n    // Setup composer with custom prompt that has agent field\n    // Simulate Enter on /prompts:explore foo\n    // Assert InputResult::AgentPrompt is returned\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Protocol: `is_agent_command()` test\n- [ ] Core: frontmatter parsing tests for agent field\n- [ ] Core: validation tests for invalid agent references\n- [ ] TUI: routing test for agent prompts\n- [ ] All tests pass: `cargo test -p codex-protocol -p codex-core -p codex-tui`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:14:41.516619731+01:00","updated_at":"2025-12-13T12:25:09.187998048+01:00","closed_at":"2025-12-13T12:25:09.187998048+01:00","dependencies":[{"issue_id":"codex-96q.8","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:41.516958158+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.8","depends_on_id":"codex-96q.1","type":"blocks","created_at":"2025-12-13T12:15:14.426965733+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-96q.8","depends_on_id":"codex-96q.2","type":"blocks","created_at":"2025-12-13T12:15:14.436293885+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-96q.9","title":"Update documentation for agent prompts","description":"## What\n\nUpdate user documentation to explain the new agent-routed prompts feature.\n\n## Why\n\nUsers need to know how to create and use agent-routed prompts.\n\n## How\n\n### Update or create: `docs/custom-prompts.md`\n\nAdd section explaining agent routing:\n\n```markdown\n## Agent-Routed Prompts\n\nYou can create prompts that automatically delegate to a specific subagent.\nAdd an \\`agent\\` field to your frontmatter:\n\n\\`\\`\\`markdown\n---\ndescription: Fast codebase exploration\nagent: explorer\n---\nFind files matching $1 and explain their purpose.\n\\`\\`\\`\n\nWhen you invoke this prompt with \\`/prompts:explore src/*.rs\\`, it will:\n1. Expand the template with your arguments\n2. Delegate the task to the \\`explorer\\` subagent\n3. Return the subagent's response\n\n### Available Agents\n\nSee your configured agents in \\`~/.codex/agents/\\`.\n\n### When to Use\n\n- Use agent prompts for complex, multi-step tasks\n- Use regular prompts for simple text expansion\n- Agent prompts show \\`@agent\\` indicator in the popup\n\\`\\`\\`\n\n### Update: `docs/agents.md`\n\nCross-reference the agent prompts feature.\n\n## Acceptance Criteria\n\n- [ ] Documentation explains agent field usage\n- [ ] Examples provided for common use cases\n- [ ] Cross-references to agents documentation\n- [ ] Available agents discovery mentioned","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-13T12:14:54.056510028+01:00","updated_at":"2025-12-13T12:25:09.193806633+01:00","closed_at":"2025-12-13T12:25:09.193806633+01:00","dependencies":[{"issue_id":"codex-96q.9","depends_on_id":"codex-96q","type":"parent-child","created_at":"2025-12-13T12:14:54.056985958+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-972","title":"Remove parallel instruction injection and clean orphaned code","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T11:26:44.628791124+01:00","updated_at":"2025-12-15T11:35:37.302540337+01:00","closed_at":"2025-12-15T11:35:37.302540337+01:00"}
{"id":"codex-972.1","title":"Remove PARALLEL_INSTRUCTIONS injection from client_common.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:26:55.141615909+01:00","updated_at":"2025-12-15T11:35:16.039596865+01:00","closed_at":"2025-12-15T11:35:16.039596865+01:00","dependencies":[{"issue_id":"codex-972.1","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:26:55.142152042+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.2","title":"Remove allows_instruction_modifications field from ModelFamily","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:05.770248765+01:00","updated_at":"2025-12-15T11:35:26.154475186+01:00","closed_at":"2025-12-15T11:35:26.154475186+01:00","dependencies":[{"issue_id":"codex-972.2","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:05.770664669+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.3","title":"Delete templates/parallel/instructions.md","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:16.065704017+01:00","updated_at":"2025-12-15T11:35:10.981879171+01:00","closed_at":"2025-12-15T11:35:10.981879171+01:00","dependencies":[{"issue_id":"codex-972.3","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:16.066171138+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.4","title":"Search and remove orphaned parallel/sequential branching code","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:26.759441599+01:00","updated_at":"2025-12-15T11:35:21.09742754+01:00","closed_at":"2025-12-15T11:35:21.09742754+01:00","dependencies":[{"issue_id":"codex-972.4","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:26.759885466+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-972.5","title":"Test gpt-5.1, gpt-5.2, and codex models after cleanup","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T11:27:38.299661973+01:00","updated_at":"2025-12-15T11:35:05.926877604+01:00","closed_at":"2025-12-15T11:35:05.926877604+01:00","dependencies":[{"issue_id":"codex-972.5","depends_on_id":"codex-972","type":"parent-child","created_at":"2025-12-15T11:27:38.300124946+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-9kr","title":"Unify review as task/subagent","description":"Unify the /review feature with the task/subagent system so that:\n1. Agent can invoke review via task tool (not just users)\n2. Both user /review and agent task(review) use the same prompt/policies\n3. Reduce code duplication between ReviewTask and task handler\n\nThree phases:\n- Phase 1: Create review.md subagent (enables agent access immediately)\n- Phase 2: Update ReviewTask to load from SubagentRegistry (unify definition source)  \n- Phase 3: Full unification - remove Op::Review and ReviewTask entirely\n\nDesign doc: Oracle recommended keeping Op::Review for Phase 2 due to TUI coupling, but Phase 3 removes it.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T14:10:36.259658275+01:00","updated_at":"2025-12-15T16:04:36.428775116+01:00","closed_at":"2025-12-15T16:04:36.428775116+01:00"}
{"id":"codex-9kr.1","title":"Create review.md subagent file","description":"Create ~/.codex/agents/review.md with:\n- YAML frontmatter: name, description, profile: inherit, sandbox_policy: read-only, approval_policy: never, allowed_subagents: []\n- Body: content from core/review_prompt.md\n- Add comment warning that JSON output format is required for TUI compatibility\n\nThis immediately enables agent to call task(subagent_type='review', prompt='\u003cdiff\u003e')\n\nFiles to reference:\n- core/review_prompt.md (source content)\n- ~/.codex/agents/oracle.md (example format)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:10:51.694652174+01:00","updated_at":"2025-12-15T14:16:44.709028672+01:00","closed_at":"2025-12-15T14:16:44.709028672+01:00","dependencies":[{"issue_id":"codex-9kr.1","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:10:51.694968969+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.10","title":"Update app-server review API to use DelegateSubagent","description":"Update app-server to use Op::DelegateSubagent for review:\n\n1. Modify app-server/src/codex_message_processor.rs review_start() \n2. Instead of Op::Review, emit Op::DelegateSubagent\n3. Update tests in app-server/tests/suite/v2/review.rs\n4. May need to update app-server-protocol types\n\nConsider backwards compatibility - existing API clients may expect ReviewStartResponse.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:00.619785448+01:00","updated_at":"2025-12-15T15:46:10.101396072+01:00","closed_at":"2025-12-15T15:46:10.101396072+01:00","dependencies":[{"issue_id":"codex-9kr.10","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:00.620114387+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.10","depends_on_id":"codex-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.742613814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.11","title":"Cleanup unused review types from protocol","description":"Remove unused review-related types after migration:\n\n1. Review which types are still needed:\n   - ReviewRequest - may still be used by review_prompts.rs\n   - ReviewTarget - may still be used\n   - ReviewDelivery - check if needed\n   - ReviewOutputEvent - may be used by TUI parsing\n   - ExitedReviewModeEvent - should be removed\n   \n2. Remove truly unused types from protocol/src/protocol.rs\n3. Update any remaining imports\n\nRun after all other Phase 3 tasks complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:18.206529477+01:00","updated_at":"2025-12-15T15:46:56.477464172+01:00","closed_at":"2025-12-15T15:46:56.477464172+01:00","dependencies":[{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:18.207056684+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr.9","type":"blocks","created_at":"2025-12-15T14:12:50.751121687+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.11","depends_on_id":"codex-9kr.10","type":"blocks","created_at":"2025-12-15T14:12:50.757716555+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.12","title":"Update tests after full review unification","description":"Update all tests affected by review unification:\n\n1. core/tests/suite/review.rs - update or remove Op::Review tests\n2. tui/src/chatwidget/tests.rs - update /review flow tests\n3. tui2/src/chatwidget/tests.rs - same\n4. app-server/tests/suite/v2/review.rs - update API tests\n5. Any snapshot tests that may have changed\n\nRun full test suite: cargo test --all-features","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:24.132550543+01:00","updated_at":"2025-12-15T16:04:03.730434461+01:00","closed_at":"2025-12-15T16:04:03.730434461+01:00","dependencies":[{"issue_id":"codex-9kr.12","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:12:24.132961548+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.12","depends_on_id":"codex-9kr.11","type":"blocks","created_at":"2025-12-15T14:12:50.764087215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.2","title":"Update task tool description to include review","description":"Update the task tool's generated description in core/src/tools/handlers/task.rs to mention the review subagent.\n\nThe tool description is dynamically generated from SubagentRegistry.list(). Since review.md will be loaded, it should automatically appear. Verify this works correctly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:10:57.217103789+01:00","updated_at":"2025-12-15T14:17:06.590975268+01:00","closed_at":"2025-12-15T14:17:06.590975268+01:00","dependencies":[{"issue_id":"codex-9kr.2","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:10:57.217401047+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.3","title":"Add review subagent integration test","description":"Add test in core/tests/ to verify:\n1. Agent can invoke task(subagent_type='review', prompt='...') \n2. Review subagent loads correctly from registry\n3. Output is returned properly\n\nReference existing subagent tests in core/tests/ for patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:02.317112673+01:00","updated_at":"2025-12-15T14:17:52.339367052+01:00","closed_at":"2025-12-15T14:17:52.339367052+01:00","dependencies":[{"issue_id":"codex-9kr.3","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:02.317466489+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.4","title":"Update ReviewTask to load prompt from SubagentRegistry","description":"Modify core/src/tasks/review.rs to:\n1. Attempt to load 'review' subagent from SubagentRegistry\n2. If found: use its system_prompt and policies (sandbox_policy, approval_policy)\n3. If not found: fallback to hardcoded REVIEW_PROMPT (backwards compat)\n\nThis unifies the prompt source - both /review (user) and task(review) (agent) use same definition.\n\nKey changes:\n- Add SubagentRegistry lookup in start_review_conversation()\n- Use subagent's system_prompt as base_instructions if available\n- Respect subagent's sandbox_policy and approval_policy\n\nKeep Op::Review and ExitedReviewModeEvent - TUI still needs them.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:11.018903647+01:00","updated_at":"2025-12-15T14:30:50.570232143+01:00","closed_at":"2025-12-15T14:30:50.570232143+01:00","dependencies":[{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:11.019273924+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr.1","type":"blocks","created_at":"2025-12-15T14:12:50.687699932+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.4","depends_on_id":"codex-9kr.2","type":"blocks","created_at":"2025-12-15T14:12:50.695450488+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.5","title":"Add test for ReviewTask registry loading","description":"Add tests to verify ReviewTask correctly:\n1. Loads from SubagentRegistry when review.md exists\n2. Falls back to REVIEW_PROMPT when review.md is missing\n3. Respects policies from subagent definition\n\nAdd to core/tests/suite/review.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:18.751001758+01:00","updated_at":"2025-12-15T14:31:07.503168654+01:00","closed_at":"2025-12-15T14:31:07.503168654+01:00","dependencies":[{"issue_id":"codex-9kr.5","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:18.751354872+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.5","depends_on_id":"codex-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.7023669+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.6","title":"Update TUI to use Op::DelegateSubagent for /review","description":"Modify TUI /review flow to emit Op::DelegateSubagent instead of Op::Review:\n\n1. Keep ReviewPopup (branch/commit/custom picker) - user still selects target\n2. Use review_prompts.rs to build the diff prompt (git diff, commit show, etc.)\n3. Instead of Op::Review, emit:\n   Op::DelegateSubagent {\n       agent: 'review',\n       prompt: '\u003cbuilt diff prompt\u003e',\n       description: '\u003cuser-facing hint\u003e',\n   }\n\nFiles to modify:\n- tui/src/chatwidget.rs (dispatch_command, review popup handling)\n- tui2/src/chatwidget.rs (same changes)\n\nKeep review_prompts.rs - still needed for building the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:27.691336026+01:00","updated_at":"2025-12-15T15:06:25.521132815+01:00","closed_at":"2025-12-15T15:06:25.521132815+01:00","dependencies":[{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:27.69173559+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.70883699+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.6","depends_on_id":"codex-9kr.5","type":"blocks","created_at":"2025-12-15T14:12:50.715400459+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.7","title":"Handle review output parsing in TUI SubagentEvent","description":"Update TUI to parse ReviewOutputEvent from SubagentEvent when agent is 'review':\n\n1. When receiving TaskComplete for 'review' subagent, attempt to parse output as JSON ReviewOutputEvent\n2. If valid JSON: render using existing review findings format (render_review_output_text)\n3. If not valid JSON: render as plain markdown\n\nThis replaces ExitedReviewModeEvent handling with SubagentEvent-based detection.\n\nFiles to modify:\n- tui/src/chatwidget.rs\n- tui2/src/chatwidget.rs  \n- Possibly tui/src/history_cell.rs for rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:35.292380316+01:00","updated_at":"2025-12-15T15:17:05.630380288+01:00","closed_at":"2025-12-15T15:17:05.630380288+01:00","dependencies":[{"issue_id":"codex-9kr.7","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:35.292739082+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.7","depends_on_id":"codex-9kr.6","type":"blocks","created_at":"2025-12-15T14:12:50.723307193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.8","title":"Remove Op::Review from protocol","description":"Remove Op::Review variant from protocol/src/protocol.rs:\n\n1. Remove Op::Review { review_request: ReviewRequest } variant\n2. Keep ReviewRequest, ReviewTarget, ReviewDelivery types if still used by review_prompts.rs\n3. Remove ExitedReviewModeEvent if no longer needed\n4. Update all match arms that handle Op::Review\n\nFiles to update:\n- protocol/src/protocol.rs\n- core/src/codex.rs (remove Op::Review handler)\n- Any other files matching on Op::Review","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:46.979545923+01:00","updated_at":"2025-12-15T15:43:25.394932343+01:00","closed_at":"2025-12-15T15:43:25.394932343+01:00","dependencies":[{"issue_id":"codex-9kr.8","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:46.979864121+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.8","depends_on_id":"codex-9kr.7","type":"blocks","created_at":"2025-12-15T14:12:50.730408158+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9kr.9","title":"Remove ReviewTask and tasks/review.rs","description":"Delete core/src/tasks/review.rs and related code:\n\n1. Delete core/src/tasks/review.rs\n2. Remove ReviewTask from core/src/tasks/mod.rs\n3. Remove imports and usages of ReviewTask\n4. Remove exit_review_mode function\n5. Keep parse_review_output_event if needed by TUI (or move to protocol)\n\nThe review functionality now flows through task tool -\u003e SubagentDelegateTask.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:53.84168904+01:00","updated_at":"2025-12-15T15:45:11.900516798+01:00","closed_at":"2025-12-15T15:45:11.900516798+01:00","dependencies":[{"issue_id":"codex-9kr.9","depends_on_id":"codex-9kr","type":"parent-child","created_at":"2025-12-15T14:11:53.842062202+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9kr.9","depends_on_id":"codex-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.736446183+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9rt","title":"Subagent rendering polish","description":"Collection of UI/UX improvements for subagent rendering in the TUI. Covers nesting bugs, visual polish, and display consistency issues.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T21:52:05.938083509+01:00","updated_at":"2025-12-15T22:35:34.788011714+01:00","closed_at":"2025-12-15T22:35:34.788011714+01:00"}
{"id":"codex-9rt.1","title":"Subagent task description truncated in transcript overlay (Ctrl+t)","description":"## Issue\n\nThe task description (prompt) delegated to a subagent is truncated in both the normal view and the transcript overlay (Ctrl+t). Users should be able to see the full message sent to the subagent when viewing the expanded transcript.\n\n## Current Behavior\n\n- Task description is wrapped/truncated in `display_lines()`\n- Task description is also wrapped in `transcript_lines()` using `textwrap::wrap()`\n- Long prompts sent to subagents are cut off with no way to view the full content\n\n## Expected Behavior\n\n- Normal view: truncated task description (current behavior is fine)\n- Transcript overlay (Ctrl+t): full task description should be visible without truncation\n\n## Relevant Code\n\n- `tui/src/history_cell.rs:1420-1430`: `transcript_lines()` wraps description with `textwrap::wrap()`\n- The `wrap_width` calculation may be too aggressive for the transcript view\n\n## Fix Direction\n\nIn `transcript_lines()`, either:\n1. Don't limit wrap width for the description (let it flow naturally)\n2. Or use a much larger wrap width for transcript mode\n3. Ensure the full description is rendered across multiple lines without any character limit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:47.59488775+01:00","updated_at":"2025-12-15T22:35:19.590583799+01:00","closed_at":"2025-12-15T22:35:19.590583799+01:00","dependencies":[{"issue_id":"codex-9rt.1","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T22:03:47.595357588+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9rt.2","title":"Subagent final message not shown in UI","description":"## Issue\n\nThe last message from a subagent (its final response/output) is not visible in the UI. Users should be able to see what the subagent returned to the parent agent.\n\n## Current Behavior\n\n- Subagent cell shows: header, task description, and activity log (shell commands, patches, etc.)\n- The subagent's final textual response/message is not displayed\n- Users cannot see what the subagent concluded or reported back\n\n## Expected Behavior\n\n- Normal view: show truncated version of the subagent's final message\n- Transcript overlay (Ctrl+t): show the full final message expanded\n\n## Relevant Code\n\n- `tui/src/history_cell.rs`: `SubagentTaskCell` struct and its `display_lines()`/`transcript_lines()` methods\n- `tui/src/chatwidget.rs`: `on_subagent_event()` handles subagent events\n- The `SubagentState` struct may need a field to store the final message\n- `EventMsg::AgentMessage` events from subagents should be captured and displayed\n\n## Fix Direction\n\n1. Add a `final_message: Option\u003cString\u003e` field to `SubagentState`\n2. Capture `AgentMessage` events in `on_subagent_event()` and store the content\n3. Render the final message in both `display_lines()` (truncated) and `transcript_lines()` (full)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:58.785651289+01:00","updated_at":"2025-12-15T22:35:24.643083449+01:00","closed_at":"2025-12-15T22:35:24.643083449+01:00","dependencies":[{"issue_id":"codex-9rt.2","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T22:03:58.785965268+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9vf","title":"Port /ps slash command from upstream","description":"Upstream commit 4fb0b547d added /ps command to list background terminals.\n\n**What's needed:**\n\n1. `tui/src/slash_command.rs`:\n   - Add `Ps` variant to `SlashCommand` enum\n   - Add description: \"list background terminals\"\n   - Add to `available_during_task` match (returns `true`)\n\n2. `tui/src/chatwidget.rs`:\n   - Add match arm: `SlashCommand::Ps =\u003e { self.add_ps_output(); }`\n   - Add method:\n     ```rust\n     pub(crate) fn add_ps_output(\u0026mut self) {\n         let sessions = self\n             .running_unified_exec_sessions\n             .iter()\n             .map(|session| session.command_display.clone())\n             .collect();\n         self.add_to_history(history_cell::new_unified_exec_sessions_output(sessions));\n     }\n     ```\n\n**Already present in our fork:**\n- `new_unified_exec_sessions_output()` helper in history_cell.rs\n- `running_unified_exec_sessions` field in ChatWidget\n\n**Upstream commit:** 4fb0b547d65598d5dbeafdf6087051e0dd207f64","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-05T02:44:32.247391119+01:00","updated_at":"2026-01-05T03:47:40.92013682+01:00","closed_at":"2026-01-05T03:47:40.92013682+01:00"}
{"id":"codex-9vf.1","title":"Add SlashCommand::Ps variant to slash_command.rs","description":"Add Ps variant to SlashCommand enum:\n- Add variant after Status (or near other info commands)\n- Add description: \"list background terminals\"\n- Add to available_during_task match returning true\n- Add to is_visible (always visible, not debug-only)","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T02:44:52.981604177+01:00","updated_at":"2026-01-05T02:44:52.981604177+01:00","dependencies":[{"issue_id":"codex-9vf.1","depends_on_id":"codex-9vf","type":"parent-child","created_at":"2026-01-05T02:44:52.981965987+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9vf.2","title":"Add /ps handler and add_ps_output method in chatwidget.rs","description":"Wire up the /ps command in chatwidget:\n1. Add match arm in handle_slash_command: SlashCommand::Ps =\u003e self.add_ps_output()\n2. Add method:\n   pub(crate) fn add_ps_output(\u0026mut self) {\n       let sessions = self.running_unified_exec_sessions\n           .iter()\n           .map(|s| s.command_display.clone())\n           .collect();\n       self.add_to_history(history_cell::new_unified_exec_sessions_output(sessions));\n   }","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-05T02:44:55.830989213+01:00","updated_at":"2026-01-05T02:44:55.830989213+01:00","dependencies":[{"issue_id":"codex-9vf.2","depends_on_id":"codex-9vf","type":"parent-child","created_at":"2026-01-05T02:44:55.831411199+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9vf.2","depends_on_id":"codex-9vf.1","type":"blocks","created_at":"2026-01-05T02:45:03.642092419+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-9vf.3","title":"Port /ps snapshot tests from upstream","description":"Port the 4 snapshot tests from upstream commit 4fb0b547d:\n- ps_output_empty_snapshot\n- ps_output_multiline_snapshot  \n- ps_output_long_command_snapshot\n- ps_output_many_sessions_snapshot\n\nTests are in tui/src/history_cell.rs","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-05T02:44:58.31459537+01:00","updated_at":"2026-01-05T02:44:58.31459537+01:00","dependencies":[{"issue_id":"codex-9vf.3","depends_on_id":"codex-9vf","type":"parent-child","created_at":"2026-01-05T02:44:58.314936701+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-9vf.3","depends_on_id":"codex-9vf.2","type":"blocks","created_at":"2026-01-05T02:45:04.446603304+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y","title":"Refactor SubagentTaskResult to use typed enums with Markdown rendering","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-02T12:12:10.267954205+01:00","updated_at":"2026-01-02T12:29:47.785342542+01:00","closed_at":"2026-01-02T12:29:47.785342542+01:00"}
{"id":"codex-a5y.1","title":"Define SubagentOutput enum (Message, ToolResult, Empty)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:16.798118592+01:00","updated_at":"2026-01-02T12:14:13.341565971+01:00","closed_at":"2026-01-02T12:14:13.341565971+01:00","dependencies":[{"issue_id":"codex-a5y.1","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:16.798424847+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y.2","title":"Define SubagentOutcome enum (Applied, NoChanges, Conflict, Failed, NoFileSystem)","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:18.076292951+01:00","updated_at":"2026-01-02T12:14:13.365113187+01:00","closed_at":"2026-01-02T12:14:13.365113187+01:00","dependencies":[{"issue_id":"codex-a5y.2","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:18.076801935+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y.3","title":"Define FileChange struct and SubagentTaskResult struct","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:19.338423674+01:00","updated_at":"2026-01-02T12:14:13.384373133+01:00","closed_at":"2026-01-02T12:14:13.384373133+01:00","dependencies":[{"issue_id":"codex-a5y.3","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:19.338734999+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y.4","title":"Implement Display trait for Markdown rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:20.57606773+01:00","updated_at":"2026-01-02T12:18:27.403713028+01:00","closed_at":"2026-01-02T12:18:27.403713028+01:00","dependencies":[{"issue_id":"codex-a5y.4","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:20.576505687+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y.5","title":"Integrate SubagentTaskResult into task handler","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:22.016273412+01:00","updated_at":"2026-01-02T12:24:39.442413836+01:00","closed_at":"2026-01-02T12:24:39.442413836+01:00","dependencies":[{"issue_id":"codex-a5y.5","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:22.016999832+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-a5y.6","title":"Add unit tests for SubagentTaskResult rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-02T12:12:23.889739374+01:00","updated_at":"2026-01-02T12:28:28.840660465+01:00","closed_at":"2026-01-02T12:28:28.840660465+01:00","dependencies":[{"issue_id":"codex-a5y.6","depends_on_id":"codex-a5y","type":"parent-child","created_at":"2026-01-02T12:12:23.890659333+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-alj","title":"Parallel subagent delegations incorrectly nest due to shared DelegationRegistry state","description":"## Bug Summary\n\nWhen the parent agent spawns multiple subagents in parallel (e.g., two `@general` calls at once), they are rendered as nested rather than siblings. The second subagent appears nested inside the first, even though both should be at the same level under the parent.\n\n## Observed Behavior\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n  └ • Delegating to @general          \u003c-- BUG: This should NOT be nested\n    └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n      ... +10 more\n```\n\nThe second `@general` delegation appears nested inside the first one, but since `general` subagent cannot call itself, this is clearly incorrect. They should render as siblings:\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n• Delegating to @general              \u003c-- EXPECTED: Same level as above\n  └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n    ... +10 more\n```\n\n## Root Cause\n\nThe `DelegationRegistry` in `core/src/delegation.rs` uses a single shared `current: Arc\u003cRwLock\u003cOption\u003cDelegationContext\u003e\u003e\u003e` to track the active delegation context. When multiple subagents are spawned in parallel:\n\n1. First subagent calls `registry.enter(call_id_1)` → creates root context with `depth=0`, no parent\n2. Second subagent calls `registry.enter(call_id_2)` → sees first subagent's context as `current`, creates child with `depth=1` and `parent_delegation_id = call_id_1`\n\nThis causes the second subagent to incorrectly inherit from the first sibling instead of from the actual parent.\n\n## Relevant Code Paths\n\n- `core/src/delegation.rs`: `DelegationRegistry::enter()` uses shared `current` state\n- `core/src/tools/handlers/task.rs:202-208`: Retrieves delegation context for each subagent\n- `tui/src/chatwidget.rs:2187-2190`: Uses `parent_delegation_id` to nest cells\n\n## Fix Direction\n\nThe delegation context needs to be scoped per-call rather than shared globally. Options:\n\n1. Pass parent delegation ID explicitly from the caller rather than inferring from shared state\n2. Use a stack-based or tree-based registry that tracks parent-child relationships explicitly\n3. Store delegation context in the invocation/session context rather than a global registry\n\n## Test Case\n\nSee `tui/src/chatwidget/tests/subagent_tests.rs:91` for existing nesting test (`subagent_nesting_logic`). A new test should verify that two parallel delegations with the same parent remain siblings, not nested.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T21:50:57.207483466+01:00","updated_at":"2025-12-15T22:35:14.532746134+01:00","closed_at":"2025-12-15T22:35:14.532746134+01:00","dependencies":[{"issue_id":"codex-alj","depends_on_id":"codex-9rt","type":"parent-child","created_at":"2025-12-15T21:52:32.934771433+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-ao9","title":"OpenRouter: some models fail with 'assistant content must contain at least one part'","description":"When using OpenRouter with certain models (e.g., xiaomi/mimo-v2-flash:free), the API returns error 400 with message 'assistant content must contain at least one part'. This happens after the assistant processes a shell command result. The issue is that some models don't accept empty assistant message content, but we're sending messages that lack required parts. Need to investigate our message serialization to ensure assistant messages always have valid content when sent to OpenRouter.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-17T10:47:25.118699639+01:00","updated_at":"2025-12-18T15:54:07.745376905+01:00","closed_at":"2025-12-18T15:54:07.745376905+01:00"}
{"id":"codex-aoe","title":"Fix general subagent default profile (gpt-5-2-high)","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-10T20:25:12.733019168+01:00","updated_at":"2026-01-10T20:42:09.889685966+01:00","closed_at":"2026-01-10T20:42:09.889685966+01:00","close_reason":"Task tool now converts canonical profile model IDs to slugs and avoids base instruction overrides for subagents; general subagent works under zai","dependencies":[{"issue_id":"codex-aoe","depends_on_id":"codex-pmh.3.4","type":"discovered-from","created_at":"2026-01-10T20:25:12.733632894+01:00","created_by":"daemon"}]}
{"id":"codex-b90","title":"Remove tui2 crate completely","description":"tui2 was an experimental TUI rewrite that is no longer maintained. It has broken tests and duplicates work from tui. Remove it entirely to reduce maintenance burden.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-27T12:39:45.348414026+01:00","updated_at":"2025-12-27T13:00:51.419238038+01:00","closed_at":"2025-12-27T13:00:51.419238038+01:00"}
{"id":"codex-b90.1","title":"Delete tui2 directory","description":"Remove the entire codex-rs/tui2 directory","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T12:39:54.255489363+01:00","updated_at":"2025-12-27T13:00:51.322705496+01:00","closed_at":"2025-12-27T13:00:51.322710676+01:00","dependencies":[{"issue_id":"codex-b90.1","depends_on_id":"codex-b90","type":"parent-child","created_at":"2025-12-27T12:39:54.255850422+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-b90.2","title":"Remove tui2 from workspace Cargo.toml","description":"Remove codex-tui2 from workspace members in Cargo.toml","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T12:39:55.861158619+01:00","updated_at":"2025-12-27T13:00:51.344198021+01:00","closed_at":"2025-12-27T13:00:51.34420242+01:00","dependencies":[{"issue_id":"codex-b90.2","depends_on_id":"codex-b90","type":"parent-child","created_at":"2025-12-27T12:39:55.861459393+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-b90.3","title":"Remove tui2 dependencies from other crates","description":"Remove any references to codex-tui2 in exec, bin, or other crates that depend on it","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T12:39:57.669546028+01:00","updated_at":"2025-12-27T13:00:51.362320537+01:00","closed_at":"2025-12-27T13:00:51.362323703+01:00","dependencies":[{"issue_id":"codex-b90.3","depends_on_id":"codex-b90","type":"parent-child","created_at":"2025-12-27T12:39:57.669845139+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-b90.4","title":"Update feature flags that reference tui2","description":"Remove any feature flags like use-tui2 from Cargo.toml files","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T12:39:59.573143649+01:00","updated_at":"2025-12-27T13:00:51.381804845+01:00","closed_at":"2025-12-27T13:00:51.381808292+01:00","dependencies":[{"issue_id":"codex-b90.4","depends_on_id":"codex-b90","type":"parent-child","created_at":"2025-12-27T12:39:59.573443471+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-b90.5","title":"Verify build and tests after tui2 removal","description":"Run cargo check --bin codex and cargo test to ensure nothing broke","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-27T12:40:01.235891095+01:00","updated_at":"2025-12-27T13:00:51.399944173+01:00","closed_at":"2025-12-27T13:00:51.399946929+01:00","dependencies":[{"issue_id":"codex-b90.5","depends_on_id":"codex-b90","type":"parent-child","created_at":"2025-12-27T12:40:01.236217027+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-beg","title":"Implement subagent task verification mechanism","description":"Subagents sometimes report successful task completion while their changes are only partially merged or incorrect. We need a way to verify subagent work.\\n\\nIdeas:\\n1. A new 'reviewer' subagent that specifically checks the work of other agents.\\n2. A 'verify_subagent_task' tool that can compare requested changes with actual file modifications.\\n3. Using 'bd' tasks to track and verify sub-tasks.\\n4. Automatic verification step after subagent completion but before merging.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-23T14:32:35.490216888+01:00","updated_at":"2025-12-30T12:17:50.253245399+01:00","closed_at":"2025-12-30T12:17:50.253245399+01:00"}
{"id":"codex-bl3","title":"Gemini Low effort thinking_budget (512) is below Anthropic minimum (1024)","description":"When using Claude through Antigravity with Low reasoning effort (e.g., /review), the thinking_budget is set to 512 but Anthropic requires minimum 1024. This causes 400 errors.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-07T16:41:57.845756316+01:00","updated_at":"2025-12-07T16:47:59.841970442+01:00","closed_at":"2025-12-07T16:47:59.841970442+01:00"}
{"id":"codex-brq","title":"Fix nested delegation display order in activity log","description":"## Problem\nNested delegations (subagent spawning another subagent) are always rendered and never collapse into '+x more'.\n\nExample:\n```\n• Delegated to @general #parent-session\n  └ Migrate AI services...\n    ... +2 more\n  • Delegated to @finder #child-session   \u003c-- nested ALWAYS renders, never skipped\n    └ Find usages...\n      ✓ Ran grep...\n  ... +36 more\n    ✓ Ran cat file.ts\n```\n\n## Root Cause\nIn `tui/src/history_cell.rs`, the render loop only counts `SubagentLogEntry::Activity` items for skip logic (line ~1338), but `SubagentLogEntry::Child` items bypass the counter entirely (line ~1374).\n\n## File \u0026 Location\n`tui/src/history_cell.rs` - `impl HistoryCell for SubagentTaskCell`, `display_lines()` method.\n\n## Current Code Structure\n```rust\n// Line ~1337-1340: Only counts Activity, ignores Child\nlet total_activities = items\n    .iter()\n    .filter(|i| matches!(i, SubagentLogEntry::Activity(_)))\n    .count();\nlet skip_activities = total_activities.saturating_sub(5);\n\n// Line ~1346-1386: Loop processes items\nfor item in items {\n    match item {\n        SubagentLogEntry::Activity(activity) =\u003e {\n            activity_counter += 1;\n            if activity_counter \u003c= skip_activities {\n                skipped_block_count += 1;\n                continue;  // \u003c-- Activities can be skipped\n            }\n            // ... render activity\n        }\n        SubagentLogEntry::Child(idx) =\u003e {\n            // \u003c-- BUG: Child ALWAYS renders, no skip check\n            if let Some(child) = self.children.get(idx) {\n                lines.extend(child.display_lines(width));\n            }\n        }\n    }\n}\n```\n\n## Solution (Unified Stream)\n1. Count BOTH Activity and Child entries in total\n2. Use single counter for skip logic\n3. Both types collapse into '+N more'\n\n## Implementation\n```rust\n// Count all items, not just activities\nlet total_items = items.len();\nlet skip_count = total_items.saturating_sub(3);  // Show last 3\n\nlet mut item_counter = 0;\nlet mut skipped_block_count = 0;\n\nfor item in items {\n    item_counter += 1;\n    if item_counter \u003c= skip_count {\n        skipped_block_count += 1;\n        continue;\n    }\n\n    if skipped_block_count \u003e 0 {\n        lines.push(Line::from(vec![\n            activity_indent.clone().into(),\n            format!(\"... +{skipped_block_count} more\").dim().italic(),\n        ]));\n        skipped_block_count = 0;\n    }\n\n    match item {\n        SubagentLogEntry::Activity(activity) =\u003e {\n            // ... render activity (existing code)\n        }\n        SubagentLogEntry::Child(idx) =\u003e {\n            if let Some(child) = self.children.get(idx) {\n                lines.extend(child.display_lines(width));\n            }\n        }\n    }\n}\n```\n\n## Optional Guardrail\nDon't collapse running subagents - check `child.status` before skipping.\n\n## Tests\nRun `cargo test -p codex-tui` - snapshot tests may need updating.","notes":"## Oracle Recommendation (Option 1: Unified Stream)\n\n**Treat nested delegations exactly like activities.**\n\n### Implementation\nIn `tui/src/history_cell.rs` (SubagentTaskCell):\n1. **Unified Counting** - Count both `Activity` and `Child` entries towards total\n2. **Single Render Loop** - Iterate with one counter, skip items below threshold\n3. **Collapse uniformly** - Both activities and children collapse into '+N more'\n\n### Guardrail\nOptionally refuse to collapse *Running* subagents, only collapse Completed/Failed ones.\n\n### Trade-off\nCollapsing hides subtree info, but activity log is a 'tail' view focused on 'what is happening now'.\n\n### File\ntui/src/history_cell.rs - SubagentTaskCell impl","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-04T13:29:30.360063621+01:00","updated_at":"2026-01-05T01:05:21.755368709+01:00","closed_at":"2026-01-05T01:05:21.755368709+01:00"}
{"id":"codex-cs1","title":"Fix Gemini login prefers newest credential","description":"Gemini login currently keeps using the first stored credential; new logins append to auth.json but core picks index 0 so refreshed tokens are ignored unless users edit auth.json. Update persistence to promote most recent Gemini tokens to the front so runtime uses latest login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T12:59:39.702700307+01:00","updated_at":"2025-12-06T13:04:15.269773177+01:00","closed_at":"2025-12-06T13:04:15.269773177+01:00"}
{"id":"codex-d4p","title":"Epic: Improve compaction with conversation serialization","description":"Improve compaction quality by serializing conversation to text format instead of sending raw history. Key changes:\n1. Add SUMMARIZATION_SYSTEM_PROMPT for observer persona\n2. Serialize history to [User]/[Assistant]/[Tool] labeled text\n3. Wrap in \u003cconversation\u003e and \u003cprevious_summary\u003e XML tags\n4. Truncate large tool outputs to prevent token blowout\n5. Pass previous summary for iterative refinement\n\nThis prevents model from trying to continue the conversation instead of summarizing.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-07T14:11:01.93536496+01:00","updated_at":"2026-01-12T20:27:37.020569254+01:00","closed_at":"2026-01-12T20:27:37.020569254+01:00","close_reason":"Already present; verified"}
{"id":"codex-d4p.1","title":"Add serialize_history_to_text() function","description":"Add function to serialize ResponseItem list to labeled text format:\n- [User]: user message content\n- [Assistant]: assistant message content  \n- [Assistant thinking]: reasoning content\n- [Tool call: name]: tool arguments\n- [Tool result]: tool output (truncated to 100 lines max)\n\nDoD:\n- Function in compact.rs\n- Handles all ResponseItem variants\n- Truncates large outputs with marker\n- Unit tests for each variant","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T14:11:21.193380272+01:00","updated_at":"2026-01-12T20:27:37.013529029+01:00","closed_at":"2026-01-12T20:27:37.013529029+01:00","close_reason":"Already present; verified","dependencies":[{"issue_id":"codex-d4p.1","depends_on_id":"codex-d4p","type":"parent-child","created_at":"2026-01-07T14:11:21.193763364+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d4p.2","title":"Add SUMMARIZATION_SYSTEM_PROMPT and update prompt template","description":"Add system prompt constant and update the user prompt template:\n\n1. SUMMARIZATION_SYSTEM_PROMPT: 'You are a context summarization assistant...'\n2. Update prompt.md to reference \u003cprevious_summary\u003e and \u003cconversation\u003e tags\n3. Instructions to update (not replace) previous summary\n\nDoD:\n- Constants defined in compact.rs\n- prompt.md updated\n- System prompt used in compaction request","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T15:54:41.874763759+01:00","updated_at":"2026-01-12T20:27:37.017987592+01:00","closed_at":"2026-01-12T20:27:37.017987592+01:00","close_reason":"Already present; verified","dependencies":[{"issue_id":"codex-d4p.2","depends_on_id":"codex-d4p","type":"parent-child","created_at":"2026-01-07T15:54:41.875151278+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d4p.3","title":"Integrate serialization into compaction flow","description":"Modify run_compact_task_inner to:\n1. Extract previous summary from history (if exists)\n2. Serialize turns-to-summarize to text\n3. Build prompt with XML-wrapped sections\n4. Set system_message on Prompt struct\n5. Extract and pass previous summary\n\nDoD:\n- Compaction uses serialized text\n- Previous summary extracted and passed\n- System prompt set on request\n- Integration test passes","acceptance_criteria":"DoD:\n- Inline compaction uses serialized conversation text and \u003cprevious_summary\u003e/\u003cconversation\u003e blocks\n- SUMMARIZATION_SYSTEM_PROMPT applied (strict: injected message; non-strict: base_instructions_override)\n- cargo test -p codex-core includes compaction coverage","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T15:54:41.893342889+01:00","updated_at":"2026-01-12T20:27:37.018840138+01:00","closed_at":"2026-01-12T20:27:37.018840138+01:00","close_reason":"Already present; verified","dependencies":[{"issue_id":"codex-d4p.3","depends_on_id":"codex-d4p","type":"parent-child","created_at":"2026-01-07T15:54:41.893633322+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d4p.4","title":"Enrich ContextCompactedEvent with summary data","description":"Add fields to ContextCompactedEvent:\n- tokens_before: i32 (token count before compaction)\n- summary: String (the generated summary text)\n\nUpdate all consumers (TUI, exec, app-server) to handle new fields.\n\nDoD:\n- Protocol updated with new fields\n- Event populated with data\n- TUI shows token count\n- All tests pass","acceptance_criteria":"DoD:\n- protocol: ContextCompactedEvent includes tokens_before (i32) and summary (String)\n- core: populate event for inline + remote compaction\n- app-server/exec/tui: handle new fields without breaking; tui surfaces tokens_before\n- cargo check --bin codex passes; cargo test -p codex-core and cargo test -p codex-tui pass","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-07T15:54:41.912453911+01:00","updated_at":"2026-01-12T20:27:37.019597156+01:00","closed_at":"2026-01-12T20:27:37.019597156+01:00","close_reason":"Already present; verified","dependencies":[{"issue_id":"codex-d4p.4","depends_on_id":"codex-d4p","type":"parent-child","created_at":"2026-01-07T15:54:41.912744736+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d55","title":"Restrict subagent access to other subagents","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-10T11:46:51.10983909+01:00","updated_at":"2025-12-10T12:28:12.239896299+01:00","closed_at":"2025-12-10T12:28:12.239896299+01:00"}
{"id":"codex-d55.1","title":"Update Subagent Configuration Schema","description":"Modify `SubagentMetadata` in `codex-rs/core/src/subagents.rs` to include an optional list of allowed subagent slugs (e.g., `allowed_subagents: Vec\u003cString\u003e`). This will allow subagents to declare which other subagents they need access to in their frontmatter.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:46:59.596535735+01:00","updated_at":"2025-12-10T12:10:37.503321809+01:00","closed_at":"2025-12-10T12:10:37.503321809+01:00","dependencies":[{"issue_id":"codex-d55.1","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:46:59.596858281+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d55.2","title":"Pass Subagent Context to ToolsConfig","description":"Update `SessionConfiguration` and `ToolsConfig` to carry the list of allowed subagents. In `codex-rs/core/src/tools/handlers/task.rs`, extract the `allowed_subagents` from metadata when spawning a subagent and pass it to the new session configuration. Root sessions should have full access (None), while subagents should default to no access (Some(vec![])) unless specified.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:47:06.411262442+01:00","updated_at":"2025-12-10T12:20:43.504662463+01:00","closed_at":"2025-12-10T12:20:43.504662463+01:00","dependencies":[{"issue_id":"codex-d55.2","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:47:06.411575129+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d55.3","title":"Conditionally Inject and Filter Task Tool","description":"Modify `build_specs` in `codex-rs/core/src/tools/spec.rs` to check `ToolsConfig.allowed_subagents`. If `None`, inject the task tool with full access. If `Some(list)`, only inject the task tool if the list is not empty, and filter the available agents in the tool description to match the allowed list. If the list is empty, do not inject the task tool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-10T11:47:19.761597046+01:00","updated_at":"2025-12-10T12:23:18.651057619+01:00","closed_at":"2025-12-10T12:23:18.651057619+01:00","dependencies":[{"issue_id":"codex-d55.3","depends_on_id":"codex-d55","type":"parent-child","created_at":"2025-12-10T11:47:19.761959358+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-d8a","title":"Gemini tokens ignored when API key present","description":"load_auth early returns CodexAuth::from_api_key_with_client when auth.json includes an API key, discarding gemini_accounts snapshot. Runtime then sees zero Gemini accounts and keeps using API key. Need to preserve auth snapshot so Gemini tokens remain accessible even when API key exists.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:09:00.722385922+01:00","updated_at":"2025-12-06T13:49:19.30910605+01:00","closed_at":"2025-12-06T13:49:19.30910605+01:00"}
{"id":"codex-dk5","title":"Fix P3: Delete unused SubagentWorktreeContext","description":"## Problem\n`SubagentWorktreeContext` in `core/src/subagent_worktree_context.rs` is dead code - defined but never used.\n\nThe worktree path propagation is handled implicitly via `config.cwd`.\n\n## Solution\nDelete the file and remove module exports.\n\n## Implementation\n\n### Step 1: Delete the file\n```bash\nrm core/src/subagent_worktree_context.rs\n```\n\n### Step 2: Remove from lib.rs\n\nIn `core/src/lib.rs`, remove these lines:\n```rust\npub mod subagent_worktree_context;\npub use subagent_worktree_context::*;\n```\n\n## After implementation\n- Run `cargo check -p codex-core`\n- Verify no compilation errors (no references to the deleted code)","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-21T18:23:29.755850473+01:00","updated_at":"2025-12-21T18:32:55.655793878+01:00","closed_at":"2025-12-21T18:32:55.655793878+01:00"}
{"id":"codex-dt2","title":"Explore read_parent_thread tool for handoff","description":"## Overview\n\nAmp provides a `read_parent_thread` tool that allows the new (child) session created via handoff to read back into the parent thread's conversation history.\n\n## Why This Matters\n- Child session only receives extracted context summary\n- May need more details about specific decisions, code changes, or discussions\n- Prevents context loss for complex multi-step tasks\n\n## Research Questions\n1. How does Amp implement read_parent_thread?\n2. What API does it expose (read full thread? specific messages? search?)\n3. How is it rate-limited or token-budgeted?\n4. Should it read from rollout files or in-memory history?\n5. Security considerations (can child read sensitive parent content?)\n\n## Reference\n- Amp handoff docs: /home/ribelo/projects/github/coding-tools-prompts/amp/features/handoff.md\n- Look for read_thread or read_parent_thread mentions\n\n## Subtasks to Create\n- Research Amp's read_thread implementation\n- Design tool schema for codex\n- Implement tool in core\n- Add to default tool list for handoff sessions\n- Test end-to-end","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-21T01:36:40.493345136+01:00","updated_at":"2025-12-22T23:37:54.345841129+01:00","closed_at":"2025-12-22T23:37:54.345841129+01:00"}
{"id":"codex-dtx","title":"Implement @agent-name syntax for direct agent messaging","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-19T14:18:39.920260298+01:00","updated_at":"2025-12-27T11:26:21.069611066+01:00","closed_at":"2025-12-27T11:26:21.069611066+01:00"}
{"id":"codex-dtx.1","title":"Add parse_agent_mention to prompt_args.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-19T14:40:16.379785096+01:00","updated_at":"2025-12-27T11:26:21.053712243+01:00","closed_at":"2025-12-27T11:26:21.053712243+01:00","dependencies":[{"issue_id":"codex-dtx.1","depends_on_id":"codex-dtx","type":"parent-child","created_at":"2025-12-19T14:40:16.380359322+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dut","title":"Add session_id to SubagentEventPayload for resumability","description":"## Problem\nWhen a subagent is interrupted, the main agent gets a tool_result but it lacks session_id.\n\n## Current Flow on Interruption\n1. User presses Ctrl+C during subagent execution\n2. Subagent emits `TurnAborted` event\n3. task.rs catches it and returns:\n   ```rust\n   let reason_str = format!(\"Turn aborted: {:?}\", ta.reason);\n   break Err(FunctionCallError::RespondToModel(reason_str));\n   ```\n4. This becomes a FunctionCallOutput recorded to history:\n   ```json\n   {\"call_id\": \"...\", \"output\": {\"content\": \"Turn aborted: UserCancelled\"}}\n   ```\n5. Main agent sees this but has NO session_id to offer for resume\n\n## Successful Completion (for comparison)\nOn success, the tool returns structured JSON with session_id:\n```rust\nlet response = serde_json::json!({\n    \"result\": final_output,\n    \"session_id\": session_id,  // ✓ Included\n    \"last_tool_output\": last_tool_output,\n    ...\n});\n```\n\n## Fix Options\n\n### Option A: Include session_id in abort message (minimal)\n```rust\nlet reason_str = format!(\n    \"Turn aborted: {:?}. To resume this subagent: codex resume {}\", \n    ta.reason, \n    session_id\n);\n```\n\n### Option B: Return structured JSON on abort (better)\n```rust\nlet abort_response = serde_json::json!({\n    \"error\": format!(\"Turn aborted: {:?}\", ta.reason),\n    \"session_id\": session_id,\n    \"can_resume\": true,\n});\nbreak Err(FunctionCallError::RespondToModel(abort_response.to_string()));\n```\n\n### Option C: Add session_id to SubagentEventPayload (most complete)\nAdd `session_id` field to `SubagentEventPayload` so TUI always has it from first event:\n```rust\npub struct SubagentEventPayload {\n    // ... existing fields ...\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub session_id: Option\u003cString\u003e,\n}\n```\n\n**Recommendation: Do both B and C**\n- Option B ensures main agent always gets session_id in tool output\n- Option C ensures TUI can display session_id even during execution\n\n## Files to modify\n1. **core/src/tools/handlers/task.rs**\n   - Update TurnAborted handling to include session_id in error response\n   - Update wrap_subagent_event() to accept session_id parameter\n\n2. **protocol/src/protocol.rs**\n   - Add `session_id: Option\u003cString\u003e` to SubagentEventPayload\n\n3. **tui/src/history_cell.rs** (optional)\n   - Store session_id in SubagentTaskCell\n   - Display it on interruption: \"To resume: codex resume \u003cid\u003e\"","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-22T23:19:14.120037924+01:00","updated_at":"2025-12-26T17:45:17.742165555+01:00","closed_at":"2025-12-26T17:45:17.742165555+01:00"}
{"id":"codex-dxq","title":"AWS Bedrock provider support","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-14T18:08:03.131607868+01:00","updated_at":"2025-12-27T22:15:03.792627199+01:00","closed_at":"2025-12-27T22:15:03.792627199+01:00"}
{"id":"codex-dxq.1","title":"Add AWS SDK dependencies to codex-core","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:18.498418872+01:00","updated_at":"2025-12-27T21:15:51.19427392+01:00","closed_at":"2025-12-27T21:15:51.19427392+01:00","dependencies":[{"issue_id":"codex-dxq.1","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:18.498905891+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.2","title":"Add Bedrock tests (message/tool conversion, streaming)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T18:08:23.564600492+01:00","updated_at":"2025-12-27T22:14:57.170975362+01:00","closed_at":"2025-12-27T22:14:57.170975362+01:00","dependencies":[{"issue_id":"codex-dxq.2","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:23.565100266+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.2","depends_on_id":"codex-dxq.5","type":"blocks","created_at":"2025-12-14T18:10:17.75071363+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.3","title":"Implement BedrockProvider and bedrock_messages.rs handler","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:28.622274175+01:00","updated_at":"2025-12-27T21:52:03.501478735+01:00","closed_at":"2025-12-27T21:52:03.501478735+01:00","dependencies":[{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:28.622762467+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq.6","type":"blocks","created_at":"2025-12-14T18:08:58.510636816+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.3","depends_on_id":"codex-dxq.1","type":"blocks","created_at":"2025-12-14T18:10:17.707533596+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.4","title":"Integrate Bedrock dispatch in ModelClient::stream()","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:33.680358161+01:00","updated_at":"2025-12-27T21:55:32.775598217+01:00","closed_at":"2025-12-27T21:55:32.775598217+01:00","dependencies":[{"issue_id":"codex-dxq.4","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:33.681087914+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.4","depends_on_id":"codex-dxq.3","type":"blocks","created_at":"2025-12-14T18:10:17.78887657+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.5","title":"Add built-in Bedrock provider to model_providers","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:38.742597104+01:00","updated_at":"2025-12-27T22:00:51.646642279+01:00","closed_at":"2025-12-27T22:00:51.646642279+01:00","dependencies":[{"issue_id":"codex-dxq.5","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:38.743228368+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-dxq.5","depends_on_id":"codex-dxq.4","type":"blocks","created_at":"2025-12-14T18:10:17.829790545+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-dxq.6","title":"Add WireApi::Bedrock and ProviderKind::Bedrock","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T18:08:43.81996269+01:00","updated_at":"2025-12-27T21:23:44.253068215+01:00","closed_at":"2025-12-27T21:23:44.253068215+01:00","dependencies":[{"issue_id":"codex-dxq.6","depends_on_id":"codex-dxq","type":"parent-child","created_at":"2025-12-14T18:08:43.8205547+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-eeb","title":"Epic: Move truncated outputs to workspace-relative storage","description":"## Problem\n\nTruncated output files are stored in ~/.codex/truncated_outputs/ but subagents with workspace-only sandbox cannot read files outside the workspace.\n\n## Solution\n\nMove storage to \u003cworkspace\u003e/.codex/truncated_outputs/\u003csession_id\u003e/\u003ccall_id\u003e.output\n\nPer oracle recommendation:\n- Workspace-local storage is guaranteed readable under workspace-only sandbox\n- Session subdirs prevent collisions and enable easy GC\n- Use absolute paths in hints (read_file requires them)\n\n## Tasks\n1. Update truncate.rs to use workspace cwd instead of codex_home\n2. Add session_id to path for isolation\n3. Update GC to work with workspace-relative paths\n4. Delete existing ~/.codex/*.output files (3GB cleanup)","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-10T00:55:54.148164275+01:00","updated_at":"2026-01-12T20:27:58.817458664+01:00","closed_at":"2026-01-12T20:27:58.817458664+01:00","close_reason":"Restored implementation"}
{"id":"codex-eeb.1","title":"Update truncate_with_file_fallback to use cwd","description":"## Change\n\nRename parameter from `temp_dir` (codex_home) to `cwd` (workspace root).\nUpdate path to: `\u003ccwd\u003e/.codex/truncated_outputs/\u003ccall_id\u003e.output`\n\n## Files\n- core/src/truncate.rs - Update function signature and path generation\n- core/src/tools/mod.rs - Update call sites to pass cwd instead of codex_home\n- core/src/tools/events.rs - Update ToolEventCtx usage\n- core/src/unified_exec/session_manager.rs - Update call sites\n\n## DoD\n- [ ] Function uses cwd parameter\n- [ ] Files saved to \u003ccwd\u003e/.codex/truncated_outputs/\n- [ ] cargo check -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:56:11.000832588+01:00","updated_at":"2026-01-12T20:27:58.811856986+01:00","closed_at":"2026-01-12T20:27:58.811856986+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-eeb.1","depends_on_id":"codex-eeb","type":"parent-child","created_at":"2026-01-10T00:56:11.012822835+01:00","created_by":"daemon"}]}
{"id":"codex-eeb.2","title":"Add session_id to output file path","description":"## Change\n\nSKIPPED - session_id isolation deemed unnecessary because:\n1. call_id is already a UUID, so collisions are unlikely\n2. Time-based GC (7 days) works without session dirs\n3. Adding session_id would require threading conversation_id through many layers\n\n## Decision\nKeep simple flat structure: `\u003ccwd\u003e/.codex/truncated_outputs/\u003ccall_id\u003e.output`","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:56:11.034487335+01:00","updated_at":"2026-01-12T20:27:59.285829227+01:00","closed_at":"2026-01-12T20:27:59.285829227+01:00","close_reason":"Skipped (call_id already unique)","dependencies":[{"issue_id":"codex-eeb.2","depends_on_id":"codex-eeb","type":"parent-child","created_at":"2026-01-10T00:56:11.03486147+01:00","created_by":"daemon"},{"issue_id":"codex-eeb.2","depends_on_id":"codex-eeb.1","type":"blocks","created_at":"2026-01-10T00:56:18.416727561+01:00","created_by":"daemon"}]}
{"id":"codex-eeb.3","title":"Update GC for workspace-relative paths","description":"## Change\n\nUpdate cleanup_old_outputs to:\n1. Work on workspace .codex/truncated_outputs/ directory\n2. Delete session directories (not just files) older than 7 days\n3. Remove old codex_home cleanup (no longer needed)\n\n## DoD\n- [ ] GC works on workspace directory\n- [ ] Old session dirs cleaned up\n- [ ] cargo check -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:56:11.051729552+01:00","updated_at":"2026-01-12T20:27:58.815766658+01:00","closed_at":"2026-01-12T20:27:58.815766658+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-eeb.3","depends_on_id":"codex-eeb","type":"parent-child","created_at":"2026-01-10T00:56:11.051997841+01:00","created_by":"daemon"},{"issue_id":"codex-eeb.3","depends_on_id":"codex-eeb.2","type":"blocks","created_at":"2026-01-10T00:56:18.437071685+01:00","created_by":"daemon"}]}
{"id":"codex-eeb.4","title":"Delete existing ~/.codex/*.output files","description":"## Change\n\nOne-time cleanup of accumulated output files in ~/.codex/\n\nRun: rm ~/.codex/*.output\n\nThis is ~1177 files, 3.1GB\n\n## DoD\n- [ ] All .output files deleted from ~/.codex/\n- [ ] Verify with ls ~/.codex/*.output (should be empty)","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:56:11.067832733+01:00","updated_at":"2026-01-12T20:28:00.565009883+01:00","closed_at":"2026-01-12T20:28:00.565009883+01:00","close_reason":"Not run automatically (destructive); manual cleanup","dependencies":[{"issue_id":"codex-eeb.4","depends_on_id":"codex-eeb","type":"parent-child","created_at":"2026-01-10T00:56:11.068120691+01:00","created_by":"daemon"}]}
{"id":"codex-et1","title":"LoopDetector: Use sliding window for content detection","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-31T01:22:17.783717784+01:00","updated_at":"2025-12-31T01:49:31.303420833+01:00","closed_at":"2025-12-31T01:49:31.303420833+01:00","dependencies":[{"issue_id":"codex-et1","depends_on_id":"codex-45c","type":"discovered-from","created_at":"2025-12-31T01:22:17.784364479+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-ez7","title":"Implement invocation-order patch merging","description":"## Problem\nCurrent implementation merges patches in completion order (non-deterministic). This can waste expensive work - if a fast trivial task finishes before a slow complex task and they conflict, the expensive work is lost.\n\n## Solution\nImplement \"Spawn All, Await Ordered\" pattern:\n1. Spawn all subagents in parallel (they execute concurrently)\n2. Collect results as they complete, but don't merge yet\n3. After ALL subagents complete, merge patches in invocation order\n\n## Implementation\n\n### Step 1: Create PendingSubagentResult struct\n\nIn `core/src/tools/handlers/task.rs` or new file `core/src/pending_patch.rs`:\n\n```rust\n/// Result from a completed subagent, pending merge\npub struct PendingSubagentResult {\n    /// Invocation order (0 = first spawned)\n    pub invocation_order: u32,\n    /// The subagent type\n    pub subagent_type: String,\n    /// Session ID\n    pub session_id: String,\n    /// The subagent's response\n    pub result: String,\n    /// Last tool output\n    pub last_tool_output: Option\u003cString\u003e,\n    /// The generated diff (if any)\n    pub diff: Option\u003cWorktreeDiff\u003e,\n    /// Worktree handle for cleanup\n    pub worktree_handle: Option\u003cWorktreeHandle\u003e,\n    /// Parent worktree to merge into\n    pub parent_worktree: PathBuf,\n}\n```\n\n### Step 2: Add invocation counter to turn/session context\n\nNeed a way to assign invocation_order when task tool is called. Options:\n- AtomicU32 counter in TurnContext\n- Or pass through tool dispatch\n\nAdd to TurnContext or Session:\n```rust\npub task_invocation_counter: AtomicU32,\n```\n\nIn task handler, get order:\n```rust\nlet invocation_order = turn.task_invocation_counter.fetch_add(1, Ordering::SeqCst);\n```\n\n### Step 3: Defer merge - collect pending results\n\nInstead of merging immediately after subagent completes, store the result.\n\nAdd to Session or TurnContext:\n```rust\npub pending_subagent_results: Mutex\u003cVec\u003cPendingSubagentResult\u003e\u003e,\n```\n\nAfter subagent completes and diff is generated:\n```rust\n// Don't merge here, just collect\nlet pending = PendingSubagentResult {\n    invocation_order,\n    subagent_type: args.subagent_type.clone(),\n    session_id: session_id.clone(),\n    result: final_output,\n    last_tool_output,\n    diff: Some(diff),\n    worktree_handle,\n    parent_worktree: parent_worktree.clone(),\n};\n\nturn.pending_subagent_results.lock().await.push(pending);\n\n// Return result WITHOUT changes field (changes come later)\nlet response = serde_json::json!({\n    \"result\": final_output,\n    \"session_id\": session_id,\n    \"last_tool_output\": last_tool_output,\n    \"changes\": \"pending_merge\",  // Marker that merge is deferred\n});\n```\n\n### Step 4: Merge at end of turn\n\nFind where all tool calls complete and add merge logic:\n\n```rust\n/// Merge all pending subagent patches in invocation order\npub async fn merge_pending_patches(\n    turn: \u0026TurnContext,\n    worktree_manager: \u0026WorktreeManager,\n) -\u003e Vec\u003c(String, SubagentChanges)\u003e {\n    let mut pending = turn.pending_subagent_results.lock().await;\n    \n    // Sort by invocation order\n    pending.sort_by_key(|p| p.invocation_order);\n    \n    let mut results = Vec::new();\n    \n    for p in pending.drain(..) {\n        let changes = if let (Some(diff), Some(handle)) = (p.diff, p.worktree_handle) {\n            if !diff.has_changes {\n                let _ = worktree_manager.cleanup(\u0026handle).await;\n                SubagentChanges {\n                    status: SubagentChangesStatus::NoChanges,\n                    files_changed: vec![],\n                    patch_path: None,\n                }\n            } else {\n                let task_id = format!(\"{}-{}\", p.subagent_type, p.session_id);\n                match worktree_manager.apply_patch(\u0026diff.patch, \u0026p.parent_worktree, \u0026task_id).await {\n                    Ok(PatchApplyResult::Applied { files_changed }) =\u003e {\n                        let _ = worktree_manager.cleanup(\u0026handle).await;\n                        SubagentChanges {\n                            status: SubagentChangesStatus::Applied,\n                            files_changed: convert_file_changes(files_changed),\n                            patch_path: None,\n                        }\n                    }\n                    Ok(PatchApplyResult::Conflict { patch_path }) =\u003e {\n                        let _ = worktree_manager.cleanup(\u0026handle).await;\n                        SubagentChanges {\n                            status: SubagentChangesStatus::Conflict,\n                            files_changed: vec![],\n                            patch_path: Some(patch_path.to_string_lossy().to_string()),\n                        }\n                    }\n                    // ... handle other cases\n                }\n            }\n        } else {\n            SubagentChanges {\n                status: SubagentChangesStatus::NoChanges,\n                files_changed: vec![],\n                patch_path: None,\n            }\n        };\n        \n        results.push((p.session_id, changes));\n    }\n    \n    results\n}\n```\n\n### Step 5: Inject merge results back to model\n\nAfter merge completes, the results need to reach the model. Options:\n1. Modify tool results before sending\n2. Add a system message with merge summary\n3. Store in context for next turn\n\nRecommended: Store results and include in next response or emit as event.\n\n## Files to modify\n- `core/src/tools/handlers/task.rs` - defer merge, collect pending\n- `core/src/codex.rs` - add pending_subagent_results, call merge at turn end\n- `core/src/turn_context.rs` or similar - add invocation counter\n\n## Tests\n- Test that invocation order is respected\n- Test parallel subagents merge in correct order\n- Test conflict in second subagent doesn't affect first\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T15:00:41.713378382+01:00","updated_at":"2025-12-21T15:36:21.341823984+01:00","closed_at":"2025-12-21T15:36:21.341823984+01:00"}
{"id":"codex-fe0","title":"Config simplification: Remove unnecessary options and feature flags","description":"## Problem\n\nThe codebase has accumulated unnecessary config options and feature flags that add complexity without providing real value. This is a personal fork - we don't need upstream compatibility or user hand-holding.\n\n## Items to Remove\n\n### Config Options\n1. `reasoning_display` - Default to showing raw reasoning, remove config\n2. `model_supports_reasoning_summaries` - Move to ModelFamily auto-detection\n3. `model_reasoning_summary_format` - Hardcode in ModelFamily as boolean\n4. `hide_full_access_warning` - Remove warning entirely\n5. `hide_gpt5_1_migration_prompt` - Remove migration prompts entirely\n6. `hide_gpt-5.1-codex-max_migration_prompt` - Remove migration prompts entirely\n\n### Feature Flags\n7. `Feature::RmcpClient` - Always enable, no fallback exists\n8. `Feature::Skills` - Always enable, already loads regardless\n\n## Acceptance Criteria\n\n- All listed config options removed from ConfigToml and ConfigProfile\n- All listed feature flags removed from Features enum\n- Related display logic (warnings, migration prompts) deleted\n- Config parsing still works (deny_unknown_fields will catch old configs)\n- All tests pass","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-24T02:21:49.55861129+01:00","updated_at":"2025-12-28T18:17:15.502246986+01:00","closed_at":"2025-12-28T18:17:15.502246986+01:00"}
{"id":"codex-fe0.1","title":"Remove reasoning_display config option","description":"## Task\n\nRemove `reasoning_display` config option entirely. Default behavior will be to always show raw reasoning.\n\n## Files to modify\n\n### 1. core/src/config/mod.rs\n- Remove `reasoning_display: ReasoningDisplay` field from `Config` struct\n- Remove `reasoning_display: Option\u003cReasoningDisplay\u003e` field from `ConfigToml` struct\n- Remove `reasoning_display` from `ConfigOverrides` struct\n- Remove the merge logic: `reasoning_display: reasoning_display.or(config_profile.reasoning_display).or(cfg.reasoning_display).unwrap_or_default()`\n- Remove from all `Config` instantiations in tests\n\n### 2. core/src/config/profile.rs\n- Remove `reasoning_display: Option\u003cReasoningDisplay\u003e` from `ConfigProfile` struct\n\n### 3. core/src/client.rs\n- Find usage of `config.reasoning_display` and replace with hardcoded `ReasoningDisplay::Raw`\n- Or simplify the conditional entirely\n\n### 4. protocol/src/config_types.rs\n- Keep the `ReasoningDisplay` enum (may still be used internally)\n- Or remove if no longer referenced anywhere\n\n## Search commands to find all usages\n```bash\nrg \"reasoning_display\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:22:01.9214595+01:00","updated_at":"2025-12-24T14:07:21.324787247+01:00","closed_at":"2025-12-24T14:07:21.324787247+01:00","dependencies":[{"issue_id":"codex-fe0.1","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:22:01.921801503+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.2","title":"Remove model_supports_reasoning_summaries config option","description":"## Task\n\nRemove `model_supports_reasoning_summaries` config option. Model capability detection should be automatic in `ModelFamily`.\n\n## Files to modify\n\n### 1. core/src/config/mod.rs\n- Remove `model_supports_reasoning_summaries: Option\u003cbool\u003e` from `Config` struct\n- Remove `model_supports_reasoning_summaries: Option\u003cbool\u003e` from `ConfigToml` struct\n- Remove the merge logic for this field\n- Remove from all `Config` instantiations in tests\n\n### 2. core/src/config/profile.rs\n- Remove `model_supports_reasoning_summaries: Option\u003cbool\u003e` from `ConfigProfile` struct\n\n### 3. core/src/openai_models/model_family.rs\n- Remove the config override in `with_config_overrides()`:\n  ```rust\n  if let Some(supports_reasoning_summaries) = config.model_supports_reasoning_summaries {\n      self.supports_reasoning_summaries = supports_reasoning_summaries;\n  }\n  ```\n- The `supports_reasoning_summaries` field in `ModelFamily` stays - it's set per-model in `find_family_for_model()`\n\n## Search commands\n```bash\nrg \"model_supports_reasoning_summaries\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:22:12.592965753+01:00","updated_at":"2025-12-24T14:10:56.151512134+01:00","closed_at":"2025-12-24T14:10:56.151512134+01:00","dependencies":[{"issue_id":"codex-fe0.2","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:22:12.593452322+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.3","title":"Remove model_reasoning_summary_format config option","description":"## Task\n\nRemove `model_reasoning_summary_format` config option. Replace with hardcoded boolean `parse_reasoning_header` in `ModelFamily`.\n\n## Files to modify\n\n### 1. core/src/config/mod.rs\n- Remove `model_reasoning_summary_format: Option\u003cReasoningSummaryFormat\u003e` from `Config` struct\n- Remove `model_reasoning_summary_format: Option\u003cReasoningSummaryFormat\u003e` from `ConfigToml` struct\n- Remove the merge logic for this field\n- Remove from all `Config` instantiations in tests\n\n### 2. core/src/config/profile.rs\n- Remove `model_reasoning_summary_format: Option\u003cReasoningSummaryFormat\u003e` from `ConfigProfile` struct\n\n### 3. core/src/config/types.rs\n- Remove `ReasoningSummaryFormat` enum entirely (after confirming no other usages)\n\n### 4. core/src/openai_models/model_family.rs\n- Replace `reasoning_summary_format: ReasoningSummaryFormat` field with `pub parse_reasoning_header: bool`\n- Update `model_family!` macro to default it to `false`\n- Set it to `true` for models that currently use `Experimental` format (gpt-5.1-*, test-gpt-5, exp-codex)\n- Remove config override logic in `with_config_overrides()`\n\n### 5. tui/src/history_cell.rs (and tui2 equivalent)\n- Update `new_reasoning_summary_block()` to accept `bool` instead of enum\n- Update call sites in `chatwidget.rs` to pass `model_family.parse_reasoning_header`\n\n## Search commands\n```bash\nrg \"model_reasoning_summary_format|ReasoningSummaryFormat\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core -p codex-tui`\n- `cargo test -p codex-core -p codex-tui`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:22:26.810468372+01:00","updated_at":"2025-12-24T14:14:33.30552382+01:00","closed_at":"2025-12-24T14:14:33.30552382+01:00","dependencies":[{"issue_id":"codex-fe0.3","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:22:26.811165904+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.4","title":"Remove Feature::RmcpClient flag - always enable","description":"## Task\n\nRemove `Feature::RmcpClient` feature flag. The RMCP client is always used - no fallback exists.\n\n## Files to modify\n\n### 1. core/src/features.rs\n- Remove `RmcpClient` variant from `Feature` enum\n- Remove from `FeaturesToml` struct: `rmcp_client: Option\u003cbool\u003e`\n- Remove from `FeatureOverrides` if present\n- Remove the mapping logic\n\n### 2. core/src/features/legacy.rs (if exists)\n- Remove legacy mapping for rmcp_client\n\n### 3. cli/src/mcp_cmd.rs\n- Remove the check: `if !config.features.enabled(Feature::RmcpClient)`\n- Allow login/logout commands unconditionally\n\n### 4. app-server/src/codex_message_processor.rs\n- Remove any Feature::RmcpClient checks\n\n### 5. Any tests checking this feature flag\n- Remove or update tests\n\n## Search commands\n```bash\nrg \"RmcpClient|rmcp_client\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core -p codex-cli`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:22:38.784162944+01:00","updated_at":"2025-12-24T14:17:49.067101173+01:00","closed_at":"2025-12-24T14:17:49.067101173+01:00","dependencies":[{"issue_id":"codex-fe0.4","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:22:38.784528452+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.5","title":"Remove Feature::Skills flag - always enable","description":"## Task\n\nRemove `Feature::Skills` feature flag. Skills are already loaded regardless of flag - just remove the gate.\n\n## Files to modify\n\n### 1. core/src/features.rs\n- Remove `Skills` variant from `Feature` enum\n- Remove from `FeaturesToml` struct: `skills: Option\u003cbool\u003e`\n- Remove from `FeatureOverrides` if present\n- Remove the mapping logic\n\n### 2. core/src/codex.rs\n- Remove the check:\n  ```rust\n  let loaded_skills = if config.features.enabled(Feature::Skills) {\n      Some(skills_manager.skills_for_cwd(\u0026config.cwd))\n  } else {\n      None\n  };\n  ```\n- Replace with: `let loaded_skills = Some(skills_manager.skills_for_cwd(\u0026config.cwd));`\n\n### 3. core/src/project_doc.rs\n- Remove any Feature::Skills checks for rendering skills in prompts\n\n### 4. tui/src/app.rs and tui2/src/app.rs\n- Remove the check:\n  ```rust\n  let skills = if config.features.enabled(Feature::Skills) {\n      Some(skills_outcome.skills.clone())\n  } else {\n      None\n  };\n  ```\n- Replace with: `let skills = Some(skills_outcome.skills.clone());`\n\n### 5. Tests\n- Remove `config.features.enable(Feature::Skills)` calls in tests\n\n## Search commands\n```bash\nrg \"Feature::Skills|features.*skills\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core -p codex-tui`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:22:50.016081936+01:00","updated_at":"2025-12-24T14:28:11.485542103+01:00","closed_at":"2025-12-24T14:28:11.485542103+01:00","dependencies":[{"issue_id":"codex-fe0.5","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:22:50.016390575+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.6","title":"Remove hide_full_access_warning and the warning itself","description":"## Task\n\nRemove `hide_full_access_warning` config option AND the warning display logic entirely. If user sets `danger-full-access`, they already consented.\n\n## Files to modify\n\n### 1. core/src/config/types.rs\n- Find `Notice` or `NoticesConfig` struct\n- Remove `hide_full_access_warning: Option\u003cbool\u003e` field\n\n### 2. TUI warning display (tui/src/app.rs or similar)\n- Find where the full-access warning is displayed\n- Delete the entire warning display logic (not just the config check)\n\n### 3. Any tests for this config field\n- Remove tests\n\n## Search commands\n```bash\nrg \"hide_full_access_warning|full.access.warning\" --type rust -i\n```\n\n## Verification\n- `cargo check -p codex-core -p codex-tui`\n- `cargo test -p codex-core -p codex-tui`\n- Run with `sandbox_mode = \"danger-full-access\"` and verify no warning appears","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:23:01.6672778+01:00","updated_at":"2025-12-24T12:41:15.550841116+01:00","closed_at":"2025-12-24T12:41:15.550841116+01:00","dependencies":[{"issue_id":"codex-fe0.6","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:23:01.66765453+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fe0.7","title":"Remove GPT migration prompts entirely","description":"## Task\n\nRemove ALL GPT migration prompt config options AND the migration prompt logic entirely. This is OpenAI-specific nagware with no value in a multi-provider fork.\n\n## Config options to remove\n- `hide_gpt5_1_migration_prompt`\n- `hide_gpt-5.1-codex-max_migration_prompt` (note the quoted key with dots)\n\n## Files to modify\n\n### 1. core/src/config/types.rs\n- Find `Notice` struct\n- Remove `hide_gpt5_1_migration_prompt` field\n- Remove `hide_gpt_5_1_codex_max_migration_prompt` field (or however it's named)\n\n### 2. core/src/config/edit.rs\n- Remove setter methods like `blocking_set_hide_gpt5_1_migration_prompt`\n- Remove any snapshot tests for these\n\n### 3. core/src/openai_models/model_presets.rs\n- Remove `HIDE_*` constants\n- Remove or set `upgrade: None` in model definitions\n\n### 4. tui/src/app.rs\n- Find `migration_prompt_hidden` helper function - DELETE IT\n- Find `handle_model_migration_prompt_if_needed` logic - DELETE IT\n- Remove any UI that shows migration prompts\n\n### 5. Tests\n- Delete snapshot tests in `core/src/config/edit.rs` (`blocking_set_hide_*`)\n- Update `list_models.rs` to remove references to these keys\n\n## Search commands\n```bash\nrg \"migration_prompt|hide_gpt5|hide_gpt-5\" --type rust -i\nrg \"upgrade.*model|model.*upgrade\" --type rust\n```\n\n## Verification\n- `cargo check -p codex-core -p codex-tui`\n- `cargo test -p codex-core -p codex-tui`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-24T02:23:15.633636694+01:00","updated_at":"2025-12-26T17:38:05.231517405+01:00","closed_at":"2025-12-26T17:38:05.231517405+01:00","dependencies":[{"issue_id":"codex-fe0.7","depends_on_id":"codex-fe0","type":"parent-child","created_at":"2025-12-24T02:23:15.63409033+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-fmk","title":"Remove HasLegacyEvent pattern and new event wrappers","description":"Remove HasLegacyEvent trait and wrapper events (ItemStarted, ItemCompleted, etc). Emit legacy events directly. Simplifies protocol and removes double-send pattern.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T17:02:53.47755984+01:00","updated_at":"2025-12-27T11:24:33.937180262+01:00","closed_at":"2025-12-27T11:24:33.937180262+01:00"}
{"id":"codex-fmk.1","title":"Remove unused wrapper event types from EventMsg","description":"In protocol/src/protocol.rs: Remove ItemStarted, ItemCompleted, AgentMessageContentDelta, ReasoningContentDelta, ReasoningRawContentDelta variants from EventMsg. Remove their struct definitions. Update any matches on EventMsg to remove these arms.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:11.007386073+01:00","updated_at":"2025-12-18T17:25:41.162605469+01:00","closed_at":"2025-12-18T17:25:41.162605469+01:00","dependencies":[{"issue_id":"codex-fmk.1","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:11.007909974+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-fmk.2","title":"Remove HasLegacyEvent trait from protocol","description":"In protocol/src/protocol.rs: Remove HasLegacyEvent trait and all its impl blocks. Keep as_legacy_events methods on TurnItem/items.rs as standalone helpers.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:16.068991783+01:00","updated_at":"2025-12-18T22:39:36.495896729+01:00","closed_at":"2025-12-18T22:39:36.495896729+01:00","dependencies":[{"issue_id":"codex-fmk.2","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:16.069851086+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-fmk.3","title":"Update codex.rs to emit legacy events directly","description":"In core/src/codex.rs: Remove as_legacy_events loop from send_event. Update emit_turn_item_completed to convert TurnItem to legacy events directly using item.as_legacy_events() and send each.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T17:03:21.12874774+01:00","updated_at":"2025-12-27T11:24:28.989068546+01:00","closed_at":"2025-12-27T11:24:28.989068546+01:00","dependencies":[{"issue_id":"codex-fmk.3","depends_on_id":"codex-fmk","type":"parent-child","created_at":"2025-12-18T17:03:21.129334502+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd","title":"Skills cache auto-refresh via mtime checking","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T15:22:24.68068856+01:00","updated_at":"2025-12-18T15:31:12.698437339+01:00","closed_at":"2025-12-18T15:31:12.698437339+01:00"}
{"id":"codex-hcd.1","title":"Add CachedSkills struct with outcome and source mtimes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:35.705300567+01:00","updated_at":"2025-12-18T15:29:52.685298563+01:00","closed_at":"2025-12-18T15:29:52.685298563+01:00","dependencies":[{"issue_id":"codex-hcd.1","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:35.705942853+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd.2","title":"Add tests for mtime-based cache invalidation","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:40.765788999+01:00","updated_at":"2025-12-18T15:31:07.645326966+01:00","closed_at":"2025-12-18T15:31:07.645326966+01:00","dependencies":[{"issue_id":"codex-hcd.2","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:40.76620866+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-hcd.3","title":"Update SkillsManager to check mtimes before returning cache","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T15:22:45.821885038+01:00","updated_at":"2025-12-18T15:30:58.239083836+01:00","closed_at":"2025-12-18T15:30:58.239083836+01:00","dependencies":[{"issue_id":"codex-hcd.3","depends_on_id":"codex-hcd","type":"parent-child","created_at":"2025-12-18T15:22:45.822487248+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-i1o","title":"Agent Create Wizard","description":"## Overview\n\nTUI-based wizard for creating subagent definitions with LLM-assisted generation. Follows the onboarding screen pattern with sequential steps.\n\n## Design Document\n\nSee `history/agent-wizard-design.md` for complete design including:\n- Configuration format (`[agent_wizard]` section)\n- Agent file format with required frontmatter fields\n- CLI commands (create, list, edit, delete)\n- TUI wizard flow (7 steps)\n- Validation rules and error messages\n- Generation prompt\n\n## Key Features\n\n1. **TUI Wizard** - 7-step interactive flow for agent creation\n2. **LLM Generation** - Uses configured profile to generate slug, name, system_prompt\n3. **Explicit Configuration** - All frontmatter fields required, no defaults\n4. **Scope Selection** - Global (~/.codex/agents/) or Project (.codex/agents/)\n5. **Conflict Detection** - Prevents creating duplicate slugs, warns on startup conflicts\n6. **$EDITOR Integration** - Edit generated agent before saving\n\n## CLI Commands\n\n- `codex agent create` - Launch TUI wizard (no flags)\n- `codex agent list` - List agents by scope with descriptions\n- `codex agent edit \u003cslug\u003e` - Open in $EDITOR (picker if ambiguous)\n- `codex agent delete \u003cslug\u003e` - Delete with confirmation (--yes to skip)\n\n## Validation\n\n**Hard (agent fails to load):**\n- Description \u003e 500 chars\n- Missing required field\n- Invalid profile/sandbox_policy/approval_policy\n\n**Soft (warning, continues):**\n- Global/project name conflict (project takes precedence)","status":"tombstone","priority":1,"issue_type":"epic","created_at":"2025-12-13T12:53:39.796688648+01:00","updated_at":"2026-01-04T13:24:30.481765878+01:00","deleted_at":"2026-01-04T13:24:30.481765878+01:00","deleted_by":"ribelo","delete_reason":"manual delete","original_type":"epic"}
{"id":"codex-i1o.1","title":"Add [agent_wizard] config section","description":"## What\n\nAdd `[agent_wizard]` configuration section to the config system with `creation_profile` field.\n\n## Why\n\nThe wizard needs to know which model profile to use for LLM generation. This must be explicitly configured - no defaults.\n\n## How\n\n### File: `core/src/config/mod.rs`\n\nAdd new config struct:\n\n```rust\n#[derive(Debug, Clone, Deserialize, Default)]\npub struct AgentWizardConfig {\n    /// Profile name to use for LLM generation during agent creation.\n    /// Must reference an existing profile in [profiles] section.\n    pub creation_profile: Option\u003cString\u003e,\n}\n```\n\nAdd to main Config struct:\n\n```rust\npub struct Config {\n    // ... existing fields ...\n    #[serde(default)]\n    pub agent_wizard: AgentWizardConfig,\n}\n```\n\n### Validation function\n\n```rust\nimpl AgentWizardConfig {\n    /// Validate that creation_profile exists in profiles.\n    /// Returns error message if invalid.\n    pub fn validate(\u0026self, available_profiles: \u0026[String]) -\u003e Option\u003cString\u003e {\n        if let Some(ref profile) = self.creation_profile {\n            if !available_profiles.contains(profile) {\n                return Some(format!(\n                    \"Agent wizard profile '{}' not found. Available profiles: {}\",\n                    profile,\n                    available_profiles.join(\", \")\n                ));\n            }\n        }\n        None\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `[agent_wizard]` section parsed from config.toml\n- [ ] `creation_profile` field accessible as `Option\u003cString\u003e`\n- [ ] Validation function checks profile exists\n- [ ] Missing section doesn't break config loading\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:53:53.160472141+01:00","updated_at":"2026-01-11T21:48:12.100658234+01:00","closed_at":"2026-01-11T21:48:12.100658234+01:00","close_reason":"Not needed"}
{"id":"codex-i1o.10","title":"Implement LLM agent generation function","description":"## What\n\nImplement the function that calls the LLM to generate agent configuration from a description.\n\n## Why\n\nThe wizard's Step 3 needs to generate slug, name, and system_prompt using the configured profile.\n\n## How\n\n### File: `core/src/agent_generator.rs` (new file)\n\n```rust\nuse schemars::JsonSchema;\nuse serde::{Deserialize, Serialize};\nuse anyhow::Result;\n\nconst AGENT_GENERATION_PROMPT: \u0026str = include_str!(\"prompts/agent_generate.md\");\n\n/// Schema for LLM-generated agent configuration\n#[derive(Debug, Clone, Serialize, Deserialize, JsonSchema)]\npub struct GeneratedAgent {\n    /// Unique slug identifier (lowercase, hyphens allowed)\n    pub slug: String,\n    \n    /// Human-readable display name\n    pub name: String,\n    \n    /// The system prompt that governs the agent's behavior\n    pub system_prompt: String,\n}\n\n/// Generate an agent configuration using the specified profile.\n/// \n/// # Arguments\n/// * `description` - User's description of what the agent should do\n/// * `existing_slugs` - List of slugs that must not be reused\n/// * `profile` - Profile name to use for LLM generation\n/// \n/// # Returns\n/// Generated agent configuration or error\npub async fn generate_agent(\n    description: \u0026str,\n    existing_slugs: \u0026[String],\n    profile: \u0026str,\n    // ... other necessary context like codex instance\n) -\u003e Result\u003cGeneratedAgent\u003e {\n    // 1. Build prompt from template\n    let prompt = AGENT_GENERATION_PROMPT\n        .replace(\"{description}\", description)\n        .replace(\"{existing_slugs}\", \u0026format!(\"{:?}\", existing_slugs));\n    \n    // 2. Get model from profile\n    // 3. Call LLM with structured output schema\n    // 4. Parse response into GeneratedAgent\n    \n    todo!(\"Implementation depends on how profiles/LLM calls work\")\n}\n```\n\n### Integration with existing infrastructure\n\nNeed to investigate how to:\n1. Load profile configuration\n2. Make LLM call with structured output (JSON schema)\n3. Handle rate limits and errors\n\n## Acceptance Criteria\n\n- [ ] `GeneratedAgent` struct defined with schemars JsonSchema\n- [ ] `generate_agent()` function implemented\n- [ ] Uses profile from [agent_wizard].creation_profile\n- [ ] Returns structured GeneratedAgent\n- [ ] Handles LLM errors gracefully\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:04.931338897+01:00","updated_at":"2026-01-11T21:52:10.62922831+01:00","closed_at":"2026-01-11T21:52:10.62922831+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.10","depends_on_id":"codex-i1o.9","type":"blocks","created_at":"2025-12-13T12:58:48.883281018+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.11","title":"Create TUI wizard framework","description":"## What\n\nCreate the wizard framework following the onboarding screen pattern with sequential steps.\n\n## Why\n\nThe agent create wizard needs 7 steps that flow sequentially, similar to existing onboarding.\n\n## How\n\n### File: `tui/src/agent_wizard/mod.rs` (new file)\n\n```rust\nmod scope_step;\nmod description_step;\nmod generation_step;\nmod profile_step;\nmod sandbox_step;\nmod approval_step;\nmod review_step;\n\nuse crate::tui::{FrameRequester, Tui};\nuse crossterm::event::KeyEvent;\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\n\npub use scope_step::ScopeStep;\npub use description_step::DescriptionStep;\n// ... other exports\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum WizardStepState {\n    Hidden,\n    InProgress,\n    Complete,\n}\n\npub trait WizardStep {\n    fn get_state(\u0026self) -\u003e WizardStepState;\n    fn handle_key_event(\u0026mut self, key: KeyEvent);\n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer);\n    fn desired_height(\u0026self) -\u003e u16;\n}\n\npub struct AgentWizard {\n    request_frame: FrameRequester,\n    steps: Vec\u003cBox\u003cdyn WizardStep\u003e\u003e,\n    is_done: bool,\n    should_exit: bool,\n    result: Option\u003cAgentWizardResult\u003e,\n}\n\npub struct AgentWizardResult {\n    pub scope: AgentScope,\n    pub slug: String,\n    pub name: String,\n    pub description: String,\n    pub profile: String,\n    pub sandbox_policy: SubagentSandboxPolicy,\n    pub approval_policy: AskForApproval,\n    pub system_prompt: String,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq)]\npub enum AgentScope {\n    Project,\n    Global,\n}\n```\n\n### Pattern reference\n\nFollow `tui/src/onboarding/onboarding_screen.rs` for:\n- Step sequencing logic\n- Keyboard handling delegation\n- Rendering with dynamic height\n- State management\n\n## Acceptance Criteria\n\n- [ ] `AgentWizard` struct with step management\n- [ ] `WizardStep` trait for individual steps\n- [ ] `AgentWizardResult` contains all collected data\n- [ ] `AgentScope` enum for project/global\n- [ ] Framework compiles and can hold steps\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:21.309276569+01:00","updated_at":"2026-01-11T21:52:10.614483399+01:00","closed_at":"2026-01-11T21:52:10.614483399+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.11","depends_on_id":"codex-i1o.1","type":"blocks","created_at":"2025-12-13T12:58:48.8912072+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.12","title":"Implement wizard Step 1: Scope selection","description":"## What\n\nImplement the scope selection step (Project vs Global) with radio buttons.\n\n## Why\n\nFirst step of wizard - user chooses where to create the agent.\n\n## How\n\n### File: `tui/src/agent_wizard/scope_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentScope};\nuse crossterm::event::{KeyCode, KeyEvent};\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\nuse ratatui::style::Stylize;\nuse ratatui::text::Line;\n\npub struct ScopeStep {\n    selected: AgentScope,\n    confirmed: bool,\n    project_path: String,  // Display path like \".codex/agents/\"\n    global_path: String,   // Display path like \"~/.codex/agents/\"\n}\n\nimpl ScopeStep {\n    pub fn new(project_path: String, global_path: String) -\u003e Self {\n        Self {\n            selected: AgentScope::Project,  // Default to project\n            confirmed: false,\n            project_path,\n            global_path,\n        }\n    }\n    \n    pub fn selection(\u0026self) -\u003e AgentScope {\n        self.selected\n    }\n}\n\nimpl WizardStep for ScopeStep {\n    fn get_state(\u0026self) -\u003e WizardStepState {\n        if self.confirmed {\n            WizardStepState::Complete\n        } else {\n            WizardStepState::InProgress\n        }\n    }\n    \n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                self.selected = AgentScope::Project;\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                self.selected = AgentScope::Global;\n            }\n            KeyCode::Enter =\u003e {\n                self.confirmed = true;\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // Render:\n        // Where should this agent be created?\n        //\n        //   (●) Project  .codex/agents/\n        //   ( ) Global   ~/.codex/agents/\n        //\n        // [Enter to continue]\n    }\n    \n    fn desired_height(\u0026self) -\u003e u16 {\n        6  // Header + 2 options + spacing + hint\n    }\n}\n```\n\n### Display format\n\n```\nWhere should this agent be created?\n\n  (●) Project  .codex/agents/\n  ( ) Global   ~/.codex/agents/\n\n[Enter to continue]\n```\n\n## Acceptance Criteria\n\n- [ ] Radio button UI with Project/Global options\n- [ ] Project selected by default\n- [ ] Up/Down or j/k to navigate\n- [ ] Enter to confirm\n- [ ] Shows actual paths for each scope\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:38.756526707+01:00","updated_at":"2026-01-11T21:52:10.598203367+01:00","closed_at":"2026-01-11T21:52:10.598203367+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.12","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.89928986+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.13","title":"Implement wizard Step 2: Description input","description":"## What\n\nImplement the description input step with character counter and 500 char limit.\n\n## Why\n\nUser describes what the agent should do. This is used for LLM generation.\n\n## How\n\n### File: `tui/src/agent_wizard/description_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState};\nuse crate::bottom_pane::textarea::TextArea;\nuse crossterm::event::{KeyCode, KeyEvent};\nuse ratatui::buffer::Buffer;\nuse ratatui::layout::Rect;\n\nconst MAX_DESCRIPTION_LENGTH: usize = 500;\n\npub struct DescriptionStep {\n    textarea: TextArea,\n    confirmed: bool,\n}\n\nimpl DescriptionStep {\n    pub fn new() -\u003e Self {\n        Self {\n            textarea: TextArea::new(),\n            confirmed: false,\n        }\n    }\n    \n    pub fn description(\u0026self) -\u003e String {\n        self.textarea.get_text().to_string()\n    }\n    \n    fn char_count(\u0026self) -\u003e usize {\n        self.textarea.get_text().chars().count()\n    }\n    \n    fn is_valid(\u0026self) -\u003e bool {\n        let count = self.char_count();\n        count \u003e 0 \u0026\u0026 count \u003c= MAX_DESCRIPTION_LENGTH\n    }\n}\n\nimpl WizardStep for DescriptionStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Enter if self.is_valid() =\u003e {\n                self.confirmed = true;\n            }\n            KeyCode::Char(c) if self.char_count() \u003c MAX_DESCRIPTION_LENGTH =\u003e {\n                self.textarea.handle_key_event(key);\n            }\n            KeyCode::Backspace | KeyCode::Delete =\u003e {\n                self.textarea.handle_key_event(key);\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // Render:\n        // What should this agent do? (max 500 chars)\n        //\n        // \u003e [textarea content]\n        //                                              73/500\n        //\n        // [Enter to continue]\n    }\n    \n    // ...\n}\n```\n\n### Display format\n\n```\nWhat should this agent do? (max 500 chars)\n\n\u003e Review code for security vulnerabilities and\n  suggest fixes for common issues like SQL injection\n                                              73/500\n\n[Enter to continue]\n```\n\n## Acceptance Criteria\n\n- [ ] Text input area with word wrap\n- [ ] Character counter showing current/max\n- [ ] Cannot exceed 500 characters\n- [ ] Cannot submit empty description\n- [ ] Enter only works when valid\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:56:55.915983158+01:00","updated_at":"2026-01-11T21:52:10.58290538+01:00","closed_at":"2026-01-11T21:52:10.58290538+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.13","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.906625174+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.14","title":"Implement wizard Step 3: LLM generation","description":"## What\n\nImplement the generation step with spinner, LLM call, and conflict checking.\n\n## Why\n\nThis step calls the LLM to generate slug, name, and system_prompt, then validates no conflicts.\n\n## How\n\n### File: `tui/src/agent_wizard/generation_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentScope};\nuse codex_core::agent_generator::{generate_agent, GeneratedAgent};\nuse crossterm::event::{KeyCode, KeyEvent};\n\npub enum GenerationState {\n    Generating,\n    Success(GeneratedAgent),\n    ConflictError { slug: String },\n    Error { message: String },\n}\n\npub struct GenerationStep {\n    state: GenerationState,\n    description: String,\n    scope: AgentScope,\n    existing_slugs: Vec\u003cString\u003e,\n    profile: String,\n}\n\nimpl GenerationStep {\n    pub fn new(\n        description: String,\n        scope: AgentScope,\n        existing_slugs: Vec\u003cString\u003e,\n        profile: String,\n    ) -\u003e Self {\n        Self {\n            state: GenerationState::Generating,\n            description,\n            scope,\n            existing_slugs,\n            profile,\n        }\n    }\n    \n    pub async fn start_generation(\u0026mut self) {\n        match generate_agent(\u0026self.description, \u0026self.existing_slugs, \u0026self.profile).await {\n            Ok(generated) =\u003e {\n                // Check for conflicts\n                if self.existing_slugs.contains(\u0026generated.slug) {\n                    self.state = GenerationState::ConflictError { \n                        slug: generated.slug \n                    };\n                } else {\n                    self.state = GenerationState::Success(generated);\n                }\n            }\n            Err(e) =\u003e {\n                self.state = GenerationState::Error { \n                    message: e.to_string() \n                };\n            }\n        }\n    }\n    \n    pub fn generated(\u0026self) -\u003e Option\u003c\u0026GeneratedAgent\u003e {\n        match \u0026self.state {\n            GenerationState::Success(g) =\u003e Some(g),\n            _ =\u003e None,\n        }\n    }\n}\n\nimpl WizardStep for GenerationStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match (\u0026self.state, key.code) {\n            (GenerationState::Error { .. }, KeyCode::Char('r')) =\u003e {\n                self.state = GenerationState::Generating;\n                // Trigger regeneration\n            }\n            (GenerationState::ConflictError { .. }, KeyCode::Char('r')) =\u003e {\n                self.state = GenerationState::Generating;\n                // Trigger regeneration with hint to use different name\n            }\n            (GenerationState::Success(_), KeyCode::Enter) =\u003e {\n                // Advance to next step\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        match \u0026self.state {\n            GenerationState::Generating =\u003e {\n                // ⣾ Generating agent configuration...\n                //   Using profile: fast (gpt-4o-mini)\n            }\n            GenerationState::Success(g) =\u003e {\n                // ✓ Generated: security-reviewer\n                // [Enter to continue]\n            }\n            GenerationState::ConflictError { slug } =\u003e {\n                // Error: Agent 'security-reviewer' already exists.\n                // [R]egenerate with different name  [Esc] Cancel\n            }\n            GenerationState::Error { message } =\u003e {\n                // Error: Failed to generate agent configuration.\n                // Reason: {message}\n                // [R]etry  [Esc] Cancel\n            }\n        }\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Spinner animation during generation\n- [ ] Shows which profile is being used\n- [ ] On success: shows generated slug, advances with Enter\n- [ ] On conflict: shows error, R to regenerate\n- [ ] On error: shows reason, R to retry, Esc to cancel\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:17.941098915+01:00","updated_at":"2026-01-11T21:52:10.566460793+01:00","closed_at":"2026-01-11T21:52:10.566460793+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.14","depends_on_id":"codex-i1o.10","type":"blocks","created_at":"2025-12-13T12:58:48.915773136+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.14","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.924950795+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.15","title":"Implement wizard Steps 4-6: Policy pickers","description":"## What\n\nImplement the three policy selection steps: Profile, Sandbox Policy, Approval Policy.\n\n## Why\n\nUser must explicitly choose all policies - no defaults.\n\n## How\n\n### Generic picker component\n\nCreate a reusable radio picker since all three steps have same UX:\n\n```rust\n// tui/src/agent_wizard/picker_step.rs\n\npub struct PickerStep\u003cT: Clone + PartialEq\u003e {\n    title: String,\n    options: Vec\u003c(T, String)\u003e,  // (value, display_label)\n    selected_index: usize,\n    confirmed: bool,\n}\n\nimpl\u003cT: Clone + PartialEq\u003e PickerStep\u003cT\u003e {\n    pub fn new(title: String, options: Vec\u003c(T, String)\u003e) -\u003e Self {\n        Self {\n            title,\n            options,\n            selected_index: 0,\n            confirmed: false,\n        }\n    }\n    \n    pub fn selection(\u0026self) -\u003e Option\u003cT\u003e {\n        self.options.get(self.selected_index).map(|(v, _)| v.clone())\n    }\n}\n\nimpl\u003cT: Clone + PartialEq\u003e WizardStep for PickerStep\u003cT\u003e {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                if self.selected_index \u003e 0 {\n                    self.selected_index -= 1;\n                }\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                if self.selected_index \u003c self.options.len() - 1 {\n                    self.selected_index += 1;\n                }\n            }\n            KeyCode::Enter =\u003e {\n                self.confirmed = true;\n            }\n            _ =\u003e {}\n        }\n    }\n    // ... render radio buttons\n}\n```\n\n### Step 4: Profile picker\n\n```rust\n// Load profiles from config\nlet profiles: Vec\u003cString\u003e = config.profiles.keys().cloned().collect();\nlet options: Vec\u003c(String, String)\u003e = profiles.iter()\n    .map(|p| (p.clone(), p.clone()))\n    .collect();\n    \nlet profile_step = PickerStep::new(\"Select profile:\".to_string(), options);\n```\n\n### Step 5: Sandbox policy picker\n\n```rust\nlet options = vec![\n    (SubagentSandboxPolicy::ReadOnly, \"read-only\".to_string()),\n    (SubagentSandboxPolicy::WorkspaceWrite, \"workspace-write\".to_string()),\n    (SubagentSandboxPolicy::DangerFullAccess, \"danger-full-access\".to_string()),\n];\nlet sandbox_step = PickerStep::new(\"Select sandbox policy:\".to_string(), options);\n```\n\n### Step 6: Approval policy picker\n\n```rust\nlet options = vec![\n    (AskForApproval::OnFailure, \"on-failure\".to_string()),\n    (AskForApproval::UnlessTrusted, \"unless-trusted\".to_string()),\n    (AskForApproval::OnRequest, \"on-request\".to_string()),\n    (AskForApproval::Never, \"never\".to_string()),\n];\nlet approval_step = PickerStep::new(\"Select approval policy:\".to_string(), options);\n```\n\n## Acceptance Criteria\n\n- [ ] Generic `PickerStep\u003cT\u003e` component\n- [ ] Profile picker lists profiles from config\n- [ ] Sandbox picker with 3 options\n- [ ] Approval picker with 4 options\n- [ ] Up/Down or j/k navigation\n- [ ] Enter to confirm\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:57:40.475341065+01:00","updated_at":"2026-01-11T21:52:10.549813898+01:00","closed_at":"2026-01-11T21:52:10.549813898+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.15","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.933506718+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.16","title":"Implement wizard Step 7: Review and confirm","description":"## What\n\nImplement the final review step with preview, create, edit, and cancel actions.\n\n## Why\n\nUser reviews the complete agent file before creating. Can edit in $EDITOR if needed.\n\n## How\n\n### File: `tui/src/agent_wizard/review_step.rs`\n\n```rust\nuse super::{WizardStep, WizardStepState, AgentWizardResult};\nuse crossterm::event::{KeyCode, KeyEvent};\n\npub enum ReviewAction {\n    None,\n    Create,\n    Edit,\n    Cancel,\n}\n\npub struct ReviewStep {\n    result: AgentWizardResult,\n    action: ReviewAction,\n    scroll_offset: usize,\n}\n\nimpl ReviewStep {\n    pub fn new(result: AgentWizardResult) -\u003e Self {\n        Self {\n            result,\n            action: ReviewAction::None,\n            scroll_offset: 0,\n        }\n    }\n    \n    pub fn action(\u0026self) -\u003e \u0026ReviewAction {\n        \u0026self.action\n    }\n    \n    fn generate_file_content(\u0026self) -\u003e String {\n        format!(\n            \"---\nname: {}\ndescription: {}\nprofile: {}\nsandbox_policy: {}\napproval_policy: {}\nallowed_subagents: []\n---\n\n{}\",\n            self.result.name,\n            self.result.description,\n            self.result.profile,\n            self.result.sandbox_policy,\n            self.result.approval_policy,\n            self.result.system_prompt,\n        )\n    }\n}\n\nimpl WizardStep for ReviewStep {\n    fn handle_key_event(\u0026mut self, key: KeyEvent) {\n        match key.code {\n            KeyCode::Char('c') | KeyCode::Char('C') =\u003e {\n                self.action = ReviewAction::Create;\n            }\n            KeyCode::Char('e') | KeyCode::Char('E') =\u003e {\n                self.action = ReviewAction::Edit;\n            }\n            KeyCode::Esc =\u003e {\n                self.action = ReviewAction::Cancel;\n            }\n            KeyCode::Up | KeyCode::Char('k') =\u003e {\n                self.scroll_offset = self.scroll_offset.saturating_sub(1);\n            }\n            KeyCode::Down | KeyCode::Char('j') =\u003e {\n                self.scroll_offset += 1;\n            }\n            _ =\u003e {}\n        }\n    }\n    \n    fn render(\u0026self, area: Rect, buf: \u0026mut Buffer) {\n        // security-reviewer.md\n        // ────────────────────────────────────────────────\n        // ---\n        // name: Security Reviewer\n        // description: Reviews code for security...\n        // profile: default\n        // sandbox_policy: read-only\n        // approval_policy: on-failure\n        // allowed_subagents: []\n        // ---\n        //\n        // You are an expert security code reviewer...\n        // [scrollable preview]\n        //\n        // [C]reate  [E]dit in vim  [Esc] Cancel\n    }\n}\n```\n\n### Actions\n\n- **[C]reate**: Write file to disk, show success, exit wizard\n- **[E]dit**: Write temp file, open in $EDITOR, copy result to final location\n- **[Esc]**: Cancel wizard, no file created\n\n## Acceptance Criteria\n\n- [ ] Shows complete file preview with frontmatter\n- [ ] Scrollable if content is long\n- [ ] C key creates file\n- [ ] E key opens $EDITOR (or vi fallback)\n- [ ] Esc cancels wizard\n- [ ] Shows filename at top (slug.md)\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:02.385514156+01:00","updated_at":"2026-01-11T21:52:10.534275162+01:00","closed_at":"2026-01-11T21:52:10.534275162+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.16","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.942248726+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.17","title":"Implement 'codex agent create' CLI entry point","description":"## What\n\nImplement the CLI entry point that validates config and launches the TUI wizard.\n\n## Why\n\n`codex agent create` must check for [agent_wizard].creation_profile before starting wizard.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Subcommand)]\npub enum AgentCommand {\n    /// Create a new agent interactively\n    Create,\n    // ... other commands\n}\n\npub async fn run_agent_create(config: \u0026Config) -\u003e anyhow::Result\u003c()\u003e {\n    // 1. Check for creation_profile\n    let creation_profile = config.agent_wizard.creation_profile.as_ref()\n        .ok_or_else(|| {\n            let available = config.profiles.keys().cloned().collect::\u003cVec\u003c_\u003e\u003e();\n            anyhow::anyhow!(\n                \"Agent wizard not configured.\\n\\n\\\n                Add to ~/.codex/config.toml:\\n\\n\\\n                [agent_wizard]\\n\\\n                creation_profile = \\\"your-profile-name\\\"\\n\\n\\\n                Available profiles: {}\",\n                available.join(\", \")\n            )\n        })?;\n    \n    // 2. Validate creation_profile exists\n    if !config.profiles.contains_key(creation_profile) {\n        let available = config.profiles.keys().cloned().collect::\u003cVec\u003c_\u003e\u003e();\n        anyhow::bail!(\n            \"Agent wizard profile '{}' not found.\\n\\n\\\n            Available profiles: {}\",\n            creation_profile,\n            available.join(\", \")\n        );\n    }\n    \n    // 3. Launch TUI wizard\n    // Similar to how main.rs launches the TUI for interactive mode\n    run_agent_wizard(config, creation_profile).await\n}\n```\n\n### File: `cli/src/main.rs`\n\nAdd to Subcommand enum and handler:\n\n```rust\n/// Manage agents\nAgent(agent_cmd::AgentCli),\n\n// In main():\nSome(Subcommand::Agent(agent_cli)) =\u003e {\n    match agent_cli.command {\n        AgentCommand::Create =\u003e agent_cmd::run_agent_create(\u0026config).await?,\n        AgentCommand::List =\u003e agent_cmd::run_agent_list(\u0026codex_home, project_dir).await?,\n        // ...\n    }\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent create` checks for creation_profile\n- [ ] Missing profile shows helpful error with available profiles\n- [ ] Invalid profile shows error with available profiles\n- [ ] Valid config launches TUI wizard\n- [ ] Error messages match design doc format","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:20.579925126+01:00","updated_at":"2026-01-11T21:52:10.518783886+01:00","closed_at":"2026-01-11T21:52:10.518783886+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.17","depends_on_id":"codex-i1o.1","type":"blocks","created_at":"2025-12-13T12:58:48.950152404+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.17","depends_on_id":"codex-i1o.11","type":"blocks","created_at":"2025-12-13T12:58:48.958352938+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.18","title":"Add tests for agent wizard","description":"## What\n\nAdd comprehensive tests for the agent wizard functionality.\n\n## Why\n\nEnsure validation, conflict detection, and wizard flow work correctly.\n\n## How\n\n### Core tests (`core/src/subagents.rs`)\n\n```rust\n#[test]\nfn test_description_length_validation() {\n    let long_desc = \"x\".repeat(501);\n    let agent = SubagentDefinition {\n        slug: \"test\".to_string(),\n        metadata: SubagentMetadata {\n            description: long_desc,\n            // ... other required fields\n        },\n        system_prompt: \"test\".to_string(),\n    };\n    \n    let error = validate_agent(\u0026agent, \u0026HashSet::new());\n    assert!(error.is_some());\n    assert!(error.unwrap().message.contains(\"exceeds 500 characters\"));\n}\n\n#[test]\nfn test_conflict_detection() {\n    let project = vec![SubagentDefinition { slug: \"foo\".to_string(), .. }];\n    let global = vec![SubagentDefinition { slug: \"foo\".to_string(), .. }];\n    \n    let conflicts = detect_conflicts(\u0026project, \u0026global);\n    assert_eq!(conflicts.len(), 1);\n    assert_eq!(conflicts[0].slug, \"foo\");\n}\n\n#[test]\nfn test_missing_required_field() {\n    // YAML without 'profile' field should fail to parse\n}\n```\n\n### Config tests (`core/src/config/mod.rs`)\n\n```rust\n#[test]\nfn test_agent_wizard_config_parsing() {\n    let toml = r#\"\n    [agent_wizard]\n    creation_profile = \"fast\"\n    \"#;\n    \n    let config: Config = toml::from_str(toml).unwrap();\n    assert_eq!(config.agent_wizard.creation_profile, Some(\"fast\".to_string()));\n}\n\n#[test]\nfn test_agent_wizard_config_missing() {\n    let toml = \"\";\n    let config: Config = toml::from_str(toml).unwrap();\n    assert!(config.agent_wizard.creation_profile.is_none());\n}\n```\n\n### CLI tests\n\n- Test `agent list` output format\n- Test `agent delete` confirmation\n- Test `agent create` error when no config\n\n## Acceptance Criteria\n\n- [ ] Validation tests for description length\n- [ ] Conflict detection tests\n- [ ] Required field parsing tests\n- [ ] Config section parsing tests\n- [ ] CLI command output tests\n- [ ] All tests pass: `cargo test -p codex-core -p codex-tui`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:58:39.060372719+01:00","updated_at":"2026-01-11T21:52:10.494055913+01:00","closed_at":"2026-01-11T21:52:10.494055913+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.967286532+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.3","type":"blocks","created_at":"2025-12-13T12:58:48.978608111+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-i1o.18","depends_on_id":"codex-i1o.4","type":"blocks","created_at":"2025-12-13T12:58:48.98658045+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.2","title":"Add required fields to SubagentMetadata","description":"## What\n\nUpdate `SubagentMetadata` to require explicit values for all fields: `name`, `description`, `profile`, `sandbox_policy`, `approval_policy`, `allowed_subagents`.\n\n## Why\n\nAll agent configuration must be explicit - no magic defaults. This makes agent behavior predictable and auditable.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nUpdate `SubagentMetadata`:\n\n```rust\n#[derive(Debug, Clone, Deserialize)]\npub struct SubagentMetadata {\n    /// Human-readable display name (required)\n    pub name: String,\n    \n    /// Description of when to use this agent, max 500 chars (required)\n    pub description: String,\n    \n    /// Profile name from config.toml [profiles] (required)\n    pub profile: String,\n    \n    /// Sandbox policy (required)\n    pub sandbox_policy: SubagentSandboxPolicy,\n    \n    /// Approval policy (required)\n    pub approval_policy: AskForApproval,\n    \n    /// List of agent slugs this agent can delegate to (required, can be empty)\n    pub allowed_subagents: Vec\u003cString\u003e,\n    \n    /// Extra fields for forward compatibility\n    #[serde(flatten)]\n    pub extra: HashMap\u003cString, serde_yaml::Value\u003e,\n}\n```\n\n### Validation constants\n\n```rust\npub const MAX_DESCRIPTION_LENGTH: usize = 500;\n```\n\n### Migration note\n\nExisting agents without these fields will fail to load. Users must update their agent files.\n\n## Acceptance Criteria\n\n- [ ] All 6 fields are non-optional in struct\n- [ ] `MAX_DESCRIPTION_LENGTH` constant defined\n- [ ] Agents missing any field fail to parse with clear error\n- [ ] Update tests to use complete metadata\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:07.120610403+01:00","updated_at":"2026-01-11T21:52:10.760998237+01:00","closed_at":"2026-01-11T21:52:10.760998237+01:00","close_reason":"Not needed (agent wizard removed)"}
{"id":"codex-i1o.3","title":"Add agent validation during loading","description":"## What\n\nAdd comprehensive validation when loading agents: description length, profile existence, valid enum values.\n\n## Why\n\nHard constraints must be enforced at load time. Invalid agents should fail with clear error messages.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nAdd validation in `load_subagents()`:\n\n```rust\n#[derive(Debug, Clone)]\npub struct AgentValidationError {\n    pub slug: String,\n    pub path: PathBuf,\n    pub message: String,\n}\n\npub fn validate_agent(\n    agent: \u0026SubagentDefinition,\n    available_profiles: \u0026HashSet\u003cString\u003e,\n) -\u003e Option\u003cAgentValidationError\u003e {\n    // Check description length\n    if agent.metadata.description.len() \u003e MAX_DESCRIPTION_LENGTH {\n        return Some(AgentValidationError {\n            slug: agent.slug.clone(),\n            path: agent.path.clone(),\n            message: format!(\n                \"description exceeds {} characters (got {})\",\n                MAX_DESCRIPTION_LENGTH,\n                agent.metadata.description.len()\n            ),\n        });\n    }\n    \n    // Check profile exists\n    if !available_profiles.contains(\u0026agent.metadata.profile) {\n        return Some(AgentValidationError {\n            slug: agent.slug.clone(),\n            path: agent.path.clone(),\n            message: format!(\n                \"profile '{}' not found. Available: {}\",\n                agent.metadata.profile,\n                available_profiles.iter().cloned().collect::\u003cVec\u003c_\u003e\u003e().join(\", \")\n            ),\n        });\n    }\n    \n    None\n}\n```\n\n### Update `SubagentLoadOutcome`\n\n```rust\npub struct SubagentLoadOutcome {\n    pub agents: Vec\u003cSubagentDefinition\u003e,\n    pub parse_errors: Vec\u003cSubagentError\u003e,      // YAML/missing field errors\n    pub validation_errors: Vec\u003cAgentValidationError\u003e,  // NEW: semantic errors\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Description \u003e 500 chars → agent rejected with clear message\n- [ ] Invalid profile → agent rejected with available profiles listed\n- [ ] Parse errors (missing fields) reported separately\n- [ ] Validation errors include slug and path\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:21.437502157+01:00","updated_at":"2026-01-11T21:52:10.744638601+01:00","closed_at":"2026-01-11T21:52:10.744638601+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.3","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.831977814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.4","title":"Add agent conflict detection","description":"## What\n\nDetect when an agent slug exists in both global and project scopes. Report as warning at startup.\n\n## Why\n\nProject agents take precedence over global, but users should know about conflicts to avoid confusion.\n\n## How\n\n### File: `core/src/subagents.rs`\n\nAdd conflict detection:\n\n```rust\n#[derive(Debug, Clone)]\npub struct AgentConflict {\n    pub slug: String,\n    pub project_path: PathBuf,\n    pub global_path: PathBuf,\n}\n\npub fn detect_conflicts(\n    project_agents: \u0026[SubagentDefinition],\n    global_agents: \u0026[SubagentDefinition],\n) -\u003e Vec\u003cAgentConflict\u003e {\n    let global_slugs: HashMap\u003c\u0026str, \u0026PathBuf\u003e = global_agents\n        .iter()\n        .map(|a| (a.slug.as_str(), \u0026a.path))\n        .collect();\n    \n    project_agents\n        .iter()\n        .filter_map(|p| {\n            global_slugs.get(p.slug.as_str()).map(|global_path| AgentConflict {\n                slug: p.slug.clone(),\n                project_path: p.path.clone(),\n                global_path: (*global_path).clone(),\n            })\n        })\n        .collect()\n}\n```\n\n### File: `core/src/subagents.rs` - Update outcome\n\n```rust\npub struct SubagentLoadOutcome {\n    pub agents: Vec\u003cSubagentDefinition\u003e,\n    pub parse_errors: Vec\u003cSubagentError\u003e,\n    pub validation_errors: Vec\u003cAgentValidationError\u003e,\n    pub conflicts: Vec\u003cAgentConflict\u003e,  // NEW\n}\n```\n\n### Precedence rule\n\nWhen merging agents, project agents override global agents with same slug.\n\n## Acceptance Criteria\n\n- [ ] `detect_conflicts()` function implemented\n- [ ] Conflicts returned in `SubagentLoadOutcome`\n- [ ] Project agents take precedence in merged registry\n- [ ] Test for conflict detection\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:34.766416129+01:00","updated_at":"2026-01-11T21:52:10.729512744+01:00","closed_at":"2026-01-11T21:52:10.729512744+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.4","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.84058263+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.5","title":"Display agent warnings at TUI startup","description":"## What\n\nShow one-time warning messages at TUI startup for agent conflicts (soft constraints).\n\n## Why\n\nUsers need to know about conflicts between project and global agents, but these shouldn't block startup.\n\n## How\n\n### File: `tui/src/app.rs` (or appropriate startup location)\n\nAfter loading agents, check for conflicts and display:\n\n```rust\n// During TUI initialization, after loading agents\nif !agent_outcome.conflicts.is_empty() {\n    for conflict in \u0026agent_outcome.conflicts {\n        // Display warning - similar to MCP error display\n        eprintln!(\n            \"⚠ Agent conflict detected: '{}' exists in both project and global.\",\n            conflict.slug\n        );\n        eprintln!(\"  Project agent takes precedence. Consider renaming one.\");\n    }\n}\n```\n\n### Display format\n\n```\n⚠ Agent conflict detected: 'security-reviewer' exists in both project and global.\n  Project agent takes precedence. Consider renaming one.\n```\n\n### Behavior\n\n- One-time display at startup\n- Does not block TUI from starting\n- Similar pattern to MCP connection warnings\n\n## Acceptance Criteria\n\n- [ ] Conflicts displayed at startup\n- [ ] Warning format matches design doc\n- [ ] TUI continues after displaying warnings\n- [ ] Multiple conflicts each get their own message\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:54:47.335277405+01:00","updated_at":"2026-01-11T21:52:10.713506814+01:00","closed_at":"2026-01-11T21:52:10.713506814+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.5","depends_on_id":"codex-i1o.4","type":"blocks","created_at":"2025-12-13T12:58:48.848192687+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.6","title":"Implement 'codex agent list' CLI command","description":"## What\n\nImplement `codex agent list` command to display all agents grouped by scope.\n\n## Why\n\nUsers need to see what agents are available and where they're defined.\n\n## How\n\n### File: `cli/src/agent_cmd.rs` (new file)\n\n```rust\nuse clap::{Parser, Subcommand};\nuse codex_core::subagents::{load_subagents_from_both_scopes, SubagentDefinition};\nuse std::path::PathBuf;\n\n#[derive(Debug, Parser)]\npub struct AgentCli {\n    #[clap(subcommand)]\n    pub command: AgentCommand,\n}\n\n#[derive(Debug, Subcommand)]\npub enum AgentCommand {\n    /// List all available agents\n    List,\n    // ... other commands\n}\n\npub async fn run_agent_list(codex_home: \u0026Path, project_dir: Option\u003c\u0026Path\u003e) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    if project_agents.is_empty() \u0026\u0026 global_agents.is_empty() {\n        println!(\"No agents found.\");\n        println!();\n        println!(\"Create one with: codex agent create\");\n        return Ok(());\n    }\n    \n    if !project_agents.is_empty() {\n        println!(\"PROJECT AGENTS\");\n        for agent in \u0026project_agents {\n            println!(\"  {} - {}\", agent.slug, agent.metadata.description);\n        }\n        println!();\n    }\n    \n    if !global_agents.is_empty() {\n        println!(\"GLOBAL AGENTS\");\n        for agent in \u0026global_agents {\n            println!(\"  {} - {}\", agent.slug, agent.metadata.description);\n        }\n    }\n    \n    Ok(())\n}\n```\n\n### File: `cli/src/main.rs`\n\nAdd to Subcommand enum:\n```rust\n/// Manage agents\nAgent(agent_cmd::AgentCli),\n```\n\n### Output format\n\n```\nPROJECT AGENTS\n  security-reviewer - Reviews code for security vulnerabilities\n\nGLOBAL AGENTS\n  explorer - Fast codebase exploration\n  researcher - Deep research tasks\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent list` shows agents grouped by scope\n- [ ] Empty sections are omitted\n- [ ] Empty state shows helpful message\n- [ ] Description truncated if very long (single line)\n- [ ] Works without [agent_wizard] config","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:03.484477718+01:00","updated_at":"2026-01-11T21:52:10.695530441+01:00","closed_at":"2026-01-11T21:52:10.695530441+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.6","depends_on_id":"codex-i1o.2","type":"blocks","created_at":"2025-12-13T12:58:48.857049825+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.7","title":"Implement 'codex agent edit' CLI command","description":"## What\n\nImplement `codex agent edit \u003cslug\u003e` command to open agent file in $EDITOR.\n\n## Why\n\nUsers need to edit agent configurations after creation.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Parser)]\npub struct AgentEditArgs {\n    /// Agent slug to edit\n    slug: String,\n}\n\npub async fn run_agent_edit(\n    codex_home: \u0026Path,\n    project_dir: Option\u003c\u0026Path\u003e,\n    slug: \u0026str,\n) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    let project_match = project_agents.iter().find(|a| a.slug == slug);\n    let global_match = global_agents.iter().find(|a| a.slug == slug);\n    \n    let path = match (project_match, global_match) {\n        (Some(p), Some(g)) =\u003e {\n            // Ambiguous - show picker\n            println!(\"Multiple agents named '{}':\", slug);\n            println!();\n            println!(\"1. Project ({})\", p.path.display());\n            println!(\"2. Global  ({})\", g.path.display());\n            println!();\n            print!(\"Select [1-2]: \");\n            io::stdout().flush()?;\n            \n            let mut input = String::new();\n            io::stdin().read_line(\u0026mut input)?;\n            \n            match input.trim() {\n                \"1\" =\u003e p.path.clone(),\n                \"2\" =\u003e g.path.clone(),\n                _ =\u003e anyhow::bail!(\"Invalid selection\"),\n            }\n        }\n        (Some(p), None) =\u003e p.path.clone(),\n        (None, Some(g)) =\u003e g.path.clone(),\n        (None, None) =\u003e anyhow::bail!(\"Agent '{}' not found\", slug),\n    };\n    \n    let editor = std::env::var(\"EDITOR\").unwrap_or_else(|_| \"vi\".to_string());\n    let status = std::process::Command::new(\u0026editor)\n        .arg(\u0026path)\n        .status()?;\n    \n    if !status.success() {\n        anyhow::bail!(\"Editor exited with non-zero status\");\n    }\n    \n    Ok(())\n}\n```\n\n### Add to AgentCommand enum\n\n```rust\n/// Edit an agent in $EDITOR\nEdit(AgentEditArgs),\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent edit \u003cslug\u003e` opens file in $EDITOR\n- [ ] Ambiguous slug shows picker with numbered options\n- [ ] Missing slug shows error message\n- [ ] Falls back to `vi` if $EDITOR not set\n- [ ] Works without [agent_wizard] config","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:18.90041727+01:00","updated_at":"2026-01-11T21:52:10.67559327+01:00","closed_at":"2026-01-11T21:52:10.67559327+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.7","depends_on_id":"codex-i1o.6","type":"blocks","created_at":"2025-12-13T12:58:48.864906674+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.8","title":"Implement 'codex agent delete' CLI command","description":"## What\n\nImplement `codex agent delete \u003cslug\u003e` command with confirmation prompt.\n\n## Why\n\nUsers need to remove agents they no longer need.\n\n## How\n\n### File: `cli/src/agent_cmd.rs`\n\n```rust\n#[derive(Debug, Parser)]\npub struct AgentDeleteArgs {\n    /// Agent slug to delete\n    slug: String,\n    \n    /// Skip confirmation prompt\n    #[arg(long)]\n    yes: bool,\n}\n\npub async fn run_agent_delete(\n    codex_home: \u0026Path,\n    project_dir: Option\u003c\u0026Path\u003e,\n    args: AgentDeleteArgs,\n) -\u003e anyhow::Result\u003c()\u003e {\n    let (project_agents, global_agents) = load_subagents_from_both_scopes(codex_home, project_dir).await?;\n    \n    let project_match = project_agents.iter().find(|a| a.slug == args.slug);\n    let global_match = global_agents.iter().find(|a| a.slug == args.slug);\n    \n    let path = match (project_match, global_match) {\n        (Some(p), Some(g)) =\u003e {\n            // Ambiguous - show picker (same as edit)\n            // ... picker code ...\n        }\n        (Some(p), None) =\u003e p.path.clone(),\n        (None, Some(g)) =\u003e g.path.clone(),\n        (None, None) =\u003e anyhow::bail!(\"Agent '{}' not found\", args.slug),\n    };\n    \n    // Confirmation\n    if !args.yes {\n        print!(\"Delete {}? [y/N]: \", path.display());\n        io::stdout().flush()?;\n        \n        let mut input = String::new();\n        io::stdin().read_line(\u0026mut input)?;\n        \n        if !input.trim().eq_ignore_ascii_case(\"y\") {\n            println!(\"Cancelled.\");\n            return Ok(());\n        }\n    }\n    \n    std::fs::remove_file(\u0026path)?;\n    println!(\"Deleted {}.\", path.display());\n    \n    Ok(())\n}\n```\n\n### Add to AgentCommand enum\n\n```rust\n/// Delete an agent\nDelete(AgentDeleteArgs),\n```\n\n## Acceptance Criteria\n\n- [ ] `codex agent delete \u003cslug\u003e` prompts for confirmation\n- [ ] `--yes` flag skips confirmation\n- [ ] Ambiguous slug shows picker\n- [ ] Missing slug shows error\n- [ ] Confirmation default is No (must type 'y')\n- [ ] Works without [agent_wizard] config","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:32.958993816+01:00","updated_at":"2026-01-11T21:52:10.660373843+01:00","closed_at":"2026-01-11T21:52:10.660373843+01:00","close_reason":"Not needed (agent wizard removed)","dependencies":[{"issue_id":"codex-i1o.8","depends_on_id":"codex-i1o.6","type":"blocks","created_at":"2025-12-13T12:58:48.87528811+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1o.9","title":"Create agent generation prompt","description":"## What\n\nCreate the LLM prompt used to generate agent configurations from user descriptions.\n\n## Why\n\nThe wizard uses an LLM to generate slug, name, and system_prompt from a natural language description.\n\n## How\n\n### File: `core/src/prompts/agent_generate.md` (new file)\n\n```markdown\nYou are an expert AI agent architect. Generate a focused, effective agent configuration.\n\n## Task\n\nCreate an agent based on this description:\n\"{description}\"\n\n## Output Format (JSON)\n\n{\n  \"slug\": \"lowercase-with-hyphens\",\n  \"name\": \"Human Readable Name\", \n  \"system_prompt\": \"You are an expert...\"\n}\n\n## Rules\n\n1. **slug**: lowercase, hyphens only, 2-4 words, descriptive (e.g., \"security-reviewer\", \"api-docs-writer\")\n2. **name**: Title case, human-readable version of slug\n3. **system_prompt**: \n   - Second person (\"You are...\", \"You will...\")\n   - Specific, actionable instructions\n   - Include what the agent should NOT do\n   - 200-500 words typical length\n\n## Existing Slugs (DO NOT REUSE)\n\n{existing_slugs}\n```\n\n### File: `core/src/agent_generator.rs` (reference)\n\n```rust\nconst AGENT_GENERATION_PROMPT: \u0026str = include_str!(\"prompts/agent_generate.md\");\n```\n\n## Acceptance Criteria\n\n- [ ] Prompt file created at correct location\n- [ ] Placeholders for {description} and {existing_slugs}\n- [ ] Clear rules for slug, name, system_prompt format\n- [ ] Embedded via include_str! in agent_generator.rs","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-13T12:55:47.879037652+01:00","updated_at":"2026-01-11T21:52:10.645860846+01:00","closed_at":"2026-01-11T21:52:10.645860846+01:00","close_reason":"Not needed (agent wizard removed)"}
{"id":"codex-i1t","title":"Implement Antigravity Provider Support","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-06T12:34:26.379799781+01:00","updated_at":"2025-12-13T20:38:21.838736968+01:00","closed_at":"2025-12-13T20:38:21.838736968+01:00"}
{"id":"codex-i1t.1","title":"Define Antigravity Protocol and Types","description":"Extend core types to recognize Antigravity as a distinct authentication mode and wire protocol.\n\n**Actions:**\n1.  **codex-rs/app-server-protocol/src/protocol/common.rs**:\n    *   Update `enum AuthMode` to include `Antigravity`.\n    *   This distinguishes the login/auth flow from standard Gemini.\n\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Update `enum WireApi` to include `Antigravity`.\n    *   Update `enum ProviderKind` to include `Antigravity` (optional, but recommended for consistency).\n\n**Why:**\nThis is the foundational type work needed before we can write the implementation logic.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:31.707276308+01:00","updated_at":"2025-12-06T22:46:13.199124796+01:00","closed_at":"2025-12-06T22:46:13.199124796+01:00","dependencies":[{"issue_id":"codex-i1t.1","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:31.707575027+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.2","title":"Add Antigravity Configuration and Constants","description":"Create the configuration module containing hardcoded credentials and endpoints.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity.rs`\n2.  **Add Constants** (Mirroring the Python reference implementation):\n    *   `ANTIGRAVITY_CLIENT_ID`: \"1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com\"\n    *   `ANTIGRAVITY_CLIENT_SECRET`: \"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\"\n    *   `ANTIGRAVITY_AUTH_URL`, `ANTIGRAVITY_TOKEN_URL` (Standard Google OAuth endpoints).\n    *   `ANTIGRAVITY_ENDPOINT`: \"https://daily-cloudcode-pa.sandbox.googleapis.com\" (Note: Use the Sandbox URL as primary).\n    *   `ANTIGRAVITY_SCOPES`: Must include:\n        *   `https://www.googleapis.com/auth/cloud-platform`\n        *   `https://www.googleapis.com/auth/userinfo.email`\n        *   `https://www.googleapis.com/auth/cclog` (Critical)\n        *   `https://www.googleapis.com/auth/experimentsandconfigs` (Critical)\n\n**Why:**\nThese specific credentials and scopes are required to masquerade as the Antigravity client.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:38.497295683+01:00","updated_at":"2025-12-06T22:47:24.157608954+01:00","closed_at":"2025-12-06T22:47:24.157608954+01:00","dependencies":[{"issue_id":"codex-i1t.2","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:38.4976193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.3","title":"Implement Antigravity Authentication Flow","description":"Implement the OAuth flow using the Antigravity credentials.\n\n**Actions:**\n1.  **codex-rs/core/src/auth.rs**:\n    *   Update `CodexAuth` to handle `AuthMode::Antigravity`.\n    *   In `refresh_token()` logic:\n        *   Check if `mode == AuthMode::Antigravity`.\n        *   If so, use `antigravity::ANTIGRAVITY_CLIENT_ID/SECRET` instead of the Gemini ones.\n    *   In `login()` (if applicable) or manual token setup paths, ensure the correct scopes are requested.\n2.  **codex-rs/core/src/token_data.rs**:\n    *   Reuse `GeminiTokenData` struct for storage, as the fields (access_token, refresh_token, project_id) are identical.\n\n**Why:**\nWe need to authenticate *as* Antigravity to be allowed to call the internal endpoints.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:44.751257296+01:00","updated_at":"2025-12-06T23:27:23.359225469+01:00","closed_at":"2025-12-06T23:27:23.359225469+01:00","dependencies":[{"issue_id":"codex-i1t.3","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:44.751596443+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.4","title":"Refactor Gemini Messages for Reusability","description":"Extract payload construction logic to allow wrapping.\n\n**Actions:**\n1.  **codex-rs/core/src/gemini_messages.rs**:\n    *   Locate the `stream_gemini_messages` function.\n    *   Extract the logic that builds the `GeminiRequest` struct (converting `Prompt`, `tools`, etc.) into a new public function:\n        ```rust\n        pub fn build_gemini_payload(prompt: \u0026Prompt, config: \u0026Config, ...) -\u003e Result\u003cGeminiRequest\u003e\n        ```\n    *   Make `GeminiRequest` and its inner types (`GeminiContent`, `GeminiTool`, etc.) public (or public to crate) so they can be used by the Antigravity module.\n\n**Why:**\nAntigravity uses the *exact same* internal payload structure, but wraps it in an outer envelope. We must not duplicate the complex logic of converting Codex prompts/tools into the Gemini format.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:50.699256599+01:00","updated_at":"2025-12-06T23:27:28.524168016+01:00","closed_at":"2025-12-06T23:27:28.524168016+01:00","dependencies":[{"issue_id":"codex-i1t.4","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:50.69960826+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.5","title":"Implement Antigravity Message Streaming","description":"Implement the core Antigravity request/response logic.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity_messages.rs`\n2.  **Request Logic**:\n    *   Call `gemini_messages::build_gemini_payload(...)` to get the inner model request.\n    *   Wrap it in the Antigravity envelope:\n        ```rust\n        #[derive(Serialize)]\n        struct AntigravityRequest {\n            project: String, // from token data\n            userAgent: String, // MUST be \"antigravity\"\n            requestId: String, // \"agent-{uuid}\"\n            model: String,     // e.g. \"gemini-3-pro-preview\"\n            request: GeminiRequest,\n        }\n        ```\n3.  **Streaming Logic**:\n    *   Send POST to `{ANTIGRAVITY_ENDPOINT}/v1internal:streamGenerateContent`.\n    *   Use `eventsource-stream` (or similar) to handle SSE.\n4.  **Response Unwrapping**:\n    *   The stream yields JSON chunks.\n    *   **Crucial Step**: The chunks are Antigravity envelopes. You must extract the inner `response` field.\n        *   Example Chunk: `{\"responseId\": \"...\", \"response\": { \"candidates\": [...] }}`\n        *   Extract the inner object and treat it exactly like a standard Gemini chunk.\n    *   Reuse `gemini_messages::handle_stream_chunk` (or similar logic) if possible, or adapt it to parse the unwrapped chunk.\n\n**Why:**\nThis is the core logic that differentiates Antigravity from standard Gemini. The envelope makes the server treat us as the internal \"CloudCode\" tool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:57.840908107+01:00","updated_at":"2025-12-06T23:27:36.456056193+01:00","closed_at":"2025-12-06T23:27:36.456056193+01:00","dependencies":[{"issue_id":"codex-i1t.5","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:57.841295316+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i1t.6","title":"Wire Antigravity into Client and Config","description":"Integrate the new provider into the main client dispatch.\n\n**Actions:**\n1.  **codex-rs/core/src/client.rs**:\n    *   In `ModelClient::stream()`, add a match arm for `WireApi::Antigravity`.\n    *   Call `antigravity_messages::stream_antigravity_messages(...)`.\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Ensure configuration loading (TOML) supports the new `wire_api = \"antigravity\"` string enum.\n\n**Why:**\nThis makes the new functionality accessible to the end user via their config.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:35:02.836823082+01:00","updated_at":"2025-12-06T23:53:10.512430351+01:00","closed_at":"2025-12-06T23:53:10.512430351+01:00","dependencies":[{"issue_id":"codex-i1t.6","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:35:02.837109549+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-i3d","title":"Fix P1: Update cwd when reusing subagent session","description":"## Problem\nWhen reusing a subagent session via session_id, the Codex instance still has cwd pointing to the OLD worktree which was deleted after previous turn's merge.\n\n## Solution\nUse `Op::OverrideTurnContext` to update the cwd when reusing a session.\n\n## Implementation\n\nIn `core/src/tools/handlers/task.rs`, modify the session lookup to track if session was reused:\n\n### Step 1: Change session lookup to return reuse flag\n\nFind the block that gets `subagent_session_ref`. Change it to also return whether session was reused:\n\n```rust\nlet (subagent_session_ref, is_reused): (Arc\u003ccrate::codex::Codex\u003e, bool) = {\n    let services = \u0026invocation.session.services;\n    let mut sessions = services.subagent_sessions.lock().await;\n\n    if let Some(session) = sessions.get(\u0026session_id) {\n        info!(\n            subagent = %args.subagent_type,\n            session_id = %session_id,\n            \"Reusing existing subagent session\"\n        );\n        (session.codex.clone(), true)\n    } else {\n        // ... existing session creation logic ...\n        (codex_arc, false)\n    }\n};\n```\n\n### Step 2: Add OverrideTurnContext submission for reused sessions\n\nAfter getting the session but BEFORE sending TaskStarted event, add:\n\n```rust\n// If reusing session, update cwd to new worktree\nif is_reused {\n    tracing::warn!(\n        session_id = %session_id,\n        new_cwd = %effective_cwd.display(),\n        \"Reusing subagent session with new worktree - conversation history may reference outdated file state\"\n    );\n    \n    subagent_session_ref\n        .submit(Op::OverrideTurnContext {\n            cwd: Some(effective_cwd.clone()),\n            approval_policy: None,\n            sandbox_policy: None,\n            model: None,\n            effort: None,\n            summary: None,\n        })\n        .await\n        .map_err(|e| FunctionCallError::Fatal(format!(\"Failed to update subagent CWD: {e}\")))?;\n}\n```\n\n### Step 3: Add import for Op if not present\n\nMake sure `Op` is imported:\n```rust\nuse codex_protocol::protocol::Op;\n```\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T18:22:47.861172961+01:00","updated_at":"2025-12-21T18:33:00.879638276+01:00","closed_at":"2025-12-21T18:33:00.879638276+01:00"}
{"id":"codex-idk","title":"Epic: Antigravity Provider Hardening","description":"Harden the Antigravity provider implementation based on comparison with reference implementations (opencode-antigravity-auth, opencode-google-antigravity-auth, pi-mono). Our current implementation is POC-quality and has several discrepancies that could cause failures in production.\n\nKey areas:\n1. Missing HTTP headers (X-Goog-Api-Client, Client-Metadata)\n2. No header fallback strategy on 429\n3. User-Agent format incomplete\n4. No fallback project ID\n5. Claude thinking signatures not handled\n6. Empty block filtering missing\n\nReference implementations analyzed:\n- /home/ribelo/projects/ribelo/codex/third-party/opencode-antigravity-auth\n- /home/ribelo/projects/ribelo/codex/third-party/opencode-google-antigravity-auth\n- /home/ribelo/projects/ribelo/codex/third-party/pi-mono","status":"closed","issue_type":"epic","created_at":"2026-01-07T22:38:10.211390238+01:00","updated_at":"2026-01-07T22:56:36.770756426+01:00","closed_at":"2026-01-07T22:56:36.770756426+01:00"}
{"id":"codex-idk.1","title":"Add X-Goog-Api-Client and Client-Metadata headers","description":"SEVERITY: HIGH\n\nCURRENT STATE:\nOur antigravity_messages.rs only sends: Authorization, Host, User-Agent, Content-Type, Accept\n\nREQUIRED:\nAll reference implementations send additional headers:\n- X-Goog-Api-Client: google-cloud-sdk vscode_cloudshelleditor/0.1\n- Client-Metadata: {\"ideType\":\"IDE_UNSPECIFIED\",\"platform\":\"PLATFORM_UNSPECIFIED\",\"pluginType\":\"GEMINI\"}\n\nWHY THIS IS A BUG:\nGoogle APIs use these headers for quota tracking, feature gating, and allow-listing. Missing headers increases risk of 403 Forbidden or 400 Bad Request errors.\n\nFILES TO MODIFY:\n- core/src/antigravity_messages.rs\n\nDoD:\n- Headers added to all API requests\n- cargo test -p codex-core passes","status":"closed","issue_type":"bug","created_at":"2026-01-07T22:38:20.538312083+01:00","updated_at":"2026-01-07T22:44:13.834007821+01:00","closed_at":"2026-01-07T22:44:13.834007821+01:00","dependencies":[{"issue_id":"codex-idk.1","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:20.538778139+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.2","title":"Fix User-Agent format to include platform","description":"SEVERITY: HIGH\n\nCURRENT STATE:\nUser-Agent: antigravity/1.11.9\n\nREQUIRED (per reference implementations):\nUser-Agent: antigravity/1.11.5 windows/amd64\nUser-Agent: antigravity/1.11.5 darwin/arm64\nUser-Agent: antigravity/1.11.5 linux/amd64\n\nWHY THIS IS A BUG:\nOfficial client telemetry includes platform info. Without it, requests may be flagged by WAF/anti-abuse systems that expect specific patterns.\n\nFILES TO MODIFY:\n- core/src/antigravity_messages.rs (add platform detection)\n\nDoD:\n- User-Agent includes OS/arch suffix\n- Platform detected at runtime (windows/darwin/linux + amd64/arm64)\n- cargo test -p codex-core passes","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-07T22:38:25.490235604+01:00","updated_at":"2026-01-07T22:44:15.75071958+01:00","closed_at":"2026-01-07T22:44:15.75071958+01:00","dependencies":[{"issue_id":"codex-idk.2","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:25.490557025+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.3","title":"Add fallback project ID for free-tier users","description":"SEVERITY: HIGH\n\nCURRENT STATE:\nIf project discovery fails, we return an error requiring user to run 'codex login --antigravity'.\n\nREQUIRED (per pi-mono):\nFalls back to hardcoded project ID: rising-fact-p41fc\n\nWHY THIS IS A BUG:\nFree-tier users who haven't set up a project can't use the service at all. The reference implementations work out-of-the-box for these users.\n\nFILES TO MODIFY:\n- core/src/auth.rs (ensure_antigravity_project_id_for function)\n\nDoD:\n- If all discovery methods fail, return fallback project ID\n- Log a warning when using fallback\n- cargo test -p codex-core passes","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-07T22:38:30.510094594+01:00","updated_at":"2026-01-07T22:45:05.440540398+01:00","closed_at":"2026-01-07T22:45:05.440540398+01:00","dependencies":[{"issue_id":"codex-idk.3","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:30.510509173+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.4","title":"Implement header fallback strategy on 429","description":"SEVERITY: HIGH\n\nCURRENT STATE:\nOn 429 (rate limit), we retry with exponential backoff using the same headers.\n\nREQUIRED (per opencode-antigravity-auth):\nSwitch to 'Gemini CLI' headers when rate-limited:\n- User-Agent: google-api-nodejs-client/9.15.1\n- X-Goog-Api-Client: gl-node/22.17.0\n- Client-Metadata: key-value pair string format\n\nTrack rate limits per header style and fall back when one is exhausted.\n\nWHY THIS IS A BUG:\nThe Antigravity client identifier has shared quotas. Reference implementations mitigate this by masquerading as gemini-cli when throttled. Without this, we're blocked completely during high traffic.\n\nFILES TO MODIFY:\n- core/src/antigravity_messages.rs\n\nDoD:\n- Define ANTIGRAVITY_HEADERS and GEMINI_CLI_HEADERS constants\n- On 429, retry with alternate header set\n- cargo test -p codex-core passes","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-07T22:38:37.543650873+01:00","updated_at":"2026-01-07T22:47:02.169027027+01:00","closed_at":"2026-01-07T22:47:02.169027027+01:00","dependencies":[{"issue_id":"codex-idk.4","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:37.543966644+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-idk.4","depends_on_id":"codex-idk.1","type":"blocks","created_at":"2026-01-07T22:39:07.024786526+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.5","title":"Include projectId in OAuth state parameter","description":"SEVERITY: MEDIUM\n\nCURRENT STATE:\nOAuth state parameter only contains PKCE verifier.\n\nREQUIRED (per all reference implementations):\nState parameter should be base64url-encoded JSON containing:\n- verifier: PKCE code verifier\n- projectId: Optional project ID from user\n\nWHY THIS IS A BUG:\nIf auth flow relies on knowing target projectId upon callback, failing to round-trip this data may cause user to land in undefined project state after login.\n\nFILES TO MODIFY:\n- login/src/google_server.rs\n\nDoD:\n- State encoded as JSON with verifier and projectId\n- Callback extracts projectId from state\n- cargo test -p codex-login passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T22:38:47.050966407+01:00","updated_at":"2026-01-07T22:54:46.915017412+01:00","closed_at":"2026-01-07T22:54:46.915017412+01:00","dependencies":[{"issue_id":"codex-idk.5","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:47.051279894+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.6","title":"Filter empty text blocks from Claude responses","description":"SEVERITY: MEDIUM\n\nCURRENT STATE:\nNo filtering of empty text blocks in SSE stream processing.\n\nREQUIRED (per pi-mono):\nExplicitly filter out empty text blocks from Claude models on Antigravity backend.\n\nWHY THIS IS A BUG:\nAntigravity/Claude apparently streams empty JSON blocks which can cause rendering glitches or API errors when sent back in multi-turn conversations.\n\nFILES TO MODIFY:\n- core/src/gemini_messages.rs (build_gemini_payload or stream processor)\n\nDoD:\n- Empty text parts filtered before sending\n- Empty text parts filtered from responses\n- cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T22:38:51.454425466+01:00","updated_at":"2026-01-07T22:54:48.842956344+01:00","closed_at":"2026-01-07T22:54:48.842956344+01:00","dependencies":[{"issue_id":"codex-idk.6","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:51.454792644+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.7","title":"Handle Claude thinking signatures for multi-turn","description":"SEVERITY: MEDIUM\n\nCURRENT STATE:\nWe parse thoughtSignature in GeminiPartWrapper but don't persist or send it back.\n\nREQUIRED (per opencode-antigravity-auth and pi-mono):\n- Cache thinking signatures (SHA-256 hashed) for multi-turn Claude conversations\n- If signature is present, send in thoughtSignature field\n- Otherwise wrap thinking content in \u003cthinking\u003e tags in standard text part\n\nWHY THIS IS A BUG:\nClaude models via Antigravity require thinking signatures for multi-turn. Without it, the model may lose reasoning context or API may reject follow-up requests.\n\nFILES TO MODIFY:\n- core/src/gemini_messages.rs\n- Potentially need signature storage mechanism\n\nDoD:\n- thoughtSignature preserved across turns\n- Sent in correct format on subsequent requests\n- cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-07T22:38:57.716618406+01:00","updated_at":"2026-01-07T22:56:04.611957586+01:00","closed_at":"2026-01-07T22:56:04.611957586+01:00","dependencies":[{"issue_id":"codex-idk.7","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:38:57.717027705+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-idk.8","title":"Add UTF-16 surrogate sanitization","description":"SEVERITY: LOW\n\nCURRENT STATE:\nNo specific sanitization for UTF-16 surrogate pairs.\n\nREQUIRED (per pi-mono):\nsanitizeSurrogates utility to validate/clean UTF-16 surrogate pairs before sending to API.\n\nWHY THIS IS A BUG:\nRust's String must be valid UTF-8. If the API returns split surrogate pairs (valid in JSON/JS but invalid in UTF-8), deserialization might fail on edge cases.\n\nFILES TO MODIFY:\n- core/src/gemini_messages.rs or new utility module\n\nDoD:\n- Utility function to sanitize surrogates\n- Applied to outgoing text content\n- cargo test -p codex-core passes","status":"closed","priority":3,"issue_type":"bug","created_at":"2026-01-07T22:39:02.787789616+01:00","updated_at":"2026-01-07T22:54:50.282983615+01:00","closed_at":"2026-01-07T22:54:50.282983615+01:00","dependencies":[{"issue_id":"codex-idk.8","depends_on_id":"codex-idk","type":"parent-child","created_at":"2026-01-07T22:39:02.788105127+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-ip10","title":"Port models from static file (2666d0984)","description":"Load models from static file (models.json) instead of API calls","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:39:28.863154905+01:00","closed_at":"2025-12-18T12:39:28.863154905+01:00"}
{"id":"codex-ip11","title":"Port model picker enhancement (cc5231104)","description":"feat: model picker (#8209) - Enhanced model selection UI","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:46:45.672648767+01:00","closed_at":"2025-12-18T12:46:45.672648767+01:00"}
{"id":"codex-ip6","title":"Port upstream changes","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-18T02:41:52.575507538+01:00","updated_at":"2025-12-18T11:49:15.758772302+01:00","closed_at":"2025-12-18T11:49:15.758774366+01:00"}
{"id":"codex-ip6.1","title":"Port parallel tool calls fix (227aa5098)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:42:05.60790139+01:00","updated_at":"2025-12-18T11:48:01.59863462+01:00","closed_at":"2025-12-18T11:48:01.59863462+01:00","dependencies":[{"issue_id":"codex-ip6.1","depends_on_id":"codex-ip6","type":"parent-child","created_at":"2025-12-18T02:42:05.608562543+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-ip6.2","title":"Port session downgrade fix (c96975f51)","description":"Fix from upstream for session handling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:21.834825168+01:00","closed_at":"2025-12-18T11:48:21.834825168+01:00"}
{"id":"codex-ip6.3","title":"Port race on rx subscription fix (5ac5e87ff)","description":"Race condition fix from upstream","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:26.891946771+01:00","closed_at":"2025-12-18T11:48:26.891946771+01:00"}
{"id":"codex-ip6.4","title":"Port reasoning summary None fix (ccc5c7899)","description":"Fix: omit reasoning summary when ReasoningSummary::None","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:11.719324186+01:00","closed_at":"2025-12-18T11:48:11.719324186+01:00"}
{"id":"codex-ip6.5","title":"Port slash commands fuzzy matching fix (f78ad4ea6)","description":"Fixed regression that broke fuzzy matching for slash commands","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:16.783233845+01:00","closed_at":"2025-12-18T11:48:16.783233845+01:00"}
{"id":"codex-ip6.6","title":"Port keybindings input burst fix (fefe231ac)","description":"Fix: Don't trigger keybindings view on input burst","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:30+01:00","updated_at":"2025-12-18T11:48:06.662915882+01:00","closed_at":"2025-12-18T11:48:06.662915882+01:00"}
{"id":"codex-ip7","title":"Port shell snapshotting feature","description":"Saves shell state for resume. Commits: a62ae37e5, 6f78cebc1","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T11:48:44.214501363+01:00","closed_at":"2025-12-18T11:48:44.214501363+01:00"}
{"id":"codex-ip7.1","title":"Port shell snapshotting base (a62ae37e5)","description":"feat: shell snapshotting (#7641)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:35.986590935+01:00","closed_at":"2025-12-18T12:36:35.986590935+01:00"}
{"id":"codex-ip7.2","title":"Port shell snapshot for shell command (6f78cebc1)","description":"feat: add shell snapshot for shell command (#7786)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:41.03101479+01:00","closed_at":"2025-12-18T12:36:41.03101479+01:00"}
{"id":"codex-ip8","title":"Port ghost snapshots v2 feature","description":"Git state snapshots. Commits: 138d6ca3f, b4aab5fb9","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T11:48:39.157036342+01:00","closed_at":"2025-12-18T11:48:39.157036342+01:00"}
{"id":"codex-ip8.1","title":"Port config ghost commits (138d6ca3f)","description":"feat: config ghost commits (#7873)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:46.075869453+01:00","closed_at":"2025-12-18T12:36:46.075869453+01:00"}
{"id":"codex-ip8.2","title":"Port ghost snapshot v2 (b4aab5fb9)","description":"feat: ghost snapshot v2 (#8055)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:36:51.121140758+01:00","closed_at":"2025-12-18T12:36:51.121140758+01:00"}
{"id":"codex-ip9","title":"Port SkillsManager refactor (245ea7a75)","description":"Reimplement skills loading using SkillsManager + skills/list op","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-18T02:43:48+01:00","updated_at":"2025-12-18T12:26:41.806549333+01:00","closed_at":"2025-12-18T12:26:41.806549333+01:00"}
{"id":"codex-jnb","title":"Refresh AGENTS.md on mtime change (like skills)","description":"## Problem\nAGENTS.md is read once at session spawn and never refreshed. If you edit AGENTS.md mid-conversation, changes aren't picked up until a new session starts.\n\n## Solution\nApply the same mtime-based cache invalidation mechanism used for skills.\n\n## Reference Implementation\nSee `core/src/skills/manager.rs` - `SkillsManager`:\n- Caches results by cwd\n- Stores `(path, mtime)` tuples for files and directories\n- On each access, compares current mtime vs cached mtime\n- Reloads if any mtime changed\n\n## Files to Modify\n\n### 1. Create `core/src/project_doc_manager.rs`\nSimilar to SkillsManager:\n```rust\nstruct CachedProjectDocs {\n    user_instructions: Option\u003cString\u003e,\n    // (file_path, mtime) for each AGENTS.md found\n    file_states: Vec\u003c(PathBuf, Option\u003cSystemTime\u003e)\u003e,\n    // (dir_path, mtime) for directories in the search path\n    dir_states: Vec\u003c(PathBuf, Option\u003cSystemTime\u003e)\u003e,\n}\n\npub struct ProjectDocManager {\n    cache_by_cwd: RwLock\u003cHashMap\u003cPathBuf, CachedProjectDocs\u003e\u003e,\n}\n\nimpl ProjectDocManager {\n    pub async fn get_user_instructions(\u0026self, config: \u0026Config, skills: ...) -\u003e Option\u003cString\u003e {\n        // Check cache, compare mtimes, reload if stale\n    }\n}\n```\n\n### 2. Update `core/src/codex.rs`\n- Add `ProjectDocManager` to session services (like SkillsManager)\n- Replace direct `get_user_instructions()` call with manager lookup\n- Store manager in `SessionConfiguration` or services\n\n### 3. Update turn execution\n- Before each turn, call `project_doc_manager.get_user_instructions()`\n- If result differs from cached, update `turn_context.user_instructions`\n\n## Test Cases\n1. Edit AGENTS.md mid-session, verify next turn picks up changes\n2. Delete AGENTS.md, verify instructions update\n3. Add new AGENTS.md in nested directory, verify discovery\n4. Performance: mtime check should be fast (no full reload on every turn)","status":"closed","priority":1,"issue_type":"feature","created_at":"2026-01-05T02:10:16.539102874+01:00","updated_at":"2026-01-05T02:45:58.807469439+01:00","closed_at":"2026-01-05T02:45:58.807469439+01:00"}
{"id":"codex-jq3","title":"Task-based delegation with WHAT+DIFFICULTY routing","description":"Replace persona-based subagent routing with declarative task-based routing.\n\n**Core insight:** Capability (prompt/skills) is coupled with Capacity (model). This forces the orchestrator to do resource management instead of describing work.\n\n**Solution:** WHAT + DIFFICULTY\n\n- **Task type (WHAT)** = declarative work spec (skills + constraints + policies)\n- **Difficulty (HOW HARD)** = selects execution strategy (model + reasoning_effort)\n- **Subagent (HOW)** = internal implementation detail, not exposed to orchestrator\n\n**Tool API:**\n```rust\nstruct TaskArgs {\n    description: String,\n    prompt: String,\n    task_type: String,              // e.g. \"rust\", \"react\", \"search\"\n    difficulty: Option\u003cDifficulty\u003e, // small|medium|large (default: medium)\n    session_id: Option\u003cString\u003e,\n}\n```\n\n**Config schema:**\n```toml\n[[task]]\ntype = \"rust\"\ndescription = \"Rust code changes. Use when editing Rust.\"\nskills = [\"tokio\", \"axum\"]\nmodel = \"openai/gpt-4o\"\nreasoning_effort = \"low\"\nsandbox_policy = \"workspace-write\"\n\n[task.difficulty.small]\nmodel = \"openai/gpt-4o-mini\"\nreasoning_effort = \"none\"\n\n[task.difficulty.large]\nmodel = \"anthropic/opus-4.5\"\nreasoning_effort = \"high\"\n```\n\n**Key changes:**\n- Kill subagent_name exposure - orchestrator never names agents\n- Kill rush/general/oracle/librarian as exposed concepts\n- Task types are curated (~5-15), skills provide granularity\n- Difficulty is anti-explosion mechanism (not task-fast, task-standard, task-deep)\n- WHAT implies policy (sandbox, approval)\n- Skills = Agent Skills folders (SKILL.md)\n\n**Routing algorithm:**\n1. Resolve task type from task_type\n2. Resolve strategy from difficulty (default: medium)\n3. Attach skills as priority skills\n4. Spawn internal worker session with resolved config\n\n**No backward compatibility.** Clean break from subagent_name.\n\nDoD: Orchestrator calls task(task_type=\"rust\", difficulty=\"large\") and gets opus model","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-13T14:01:57.284617979+01:00","updated_at":"2026-01-14T00:16:21.848637614+01:00","closed_at":"2026-01-14T00:16:21.848637614+01:00","close_reason":"Implemented task-based WHAT+DIFFICULTY delegation"}
{"id":"codex-jq3.1","title":"Add TaskTier enum and extend AgentConfigToml","description":"Add TaskTier enum and extend AgentConfigToml (from codex-4v7):\n\n```rust\n#[derive(Debug, Clone, Copy, Deserialize, Serialize, PartialEq, Eq, Hash, PartialOrd, Ord)]\n#[serde(rename_all = \"snake_case\")]\npub enum TaskTier {\n    Trivial = 0,\n    Simple = 1,\n    Moderate = 2,  // default when omitted\n    Complex = 3,\n    Epic = 4,\n}\n\nimpl Default for TaskTier {\n    fn default() -\u003e Self { Self::Moderate }\n}\n\n#[derive(Deserialize)]\npub struct AgentConfigToml {\n    pub name: String,\n    pub tier: Option\u003cTaskTier\u003e,  // None = default tier entry\n    pub model: Option\u003cString\u003e,\n    pub reasoning_effort: Option\u003cSubagentReasoningEffort\u003e,\n    pub enabled: Option\u003cbool\u003e,\n}\n```\n\nLocation: core/src/config/types.rs\n\nDoD: cargo check -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:02:29.110658747+01:00","updated_at":"2026-01-13T21:42:13.837424842+01:00","closed_at":"2026-01-13T21:42:13.837424842+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.1","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:02:29.122553497+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.10","title":"Update task tool schema (task_type + difficulty)","description":"Update task tool in core/src/tools/handlers/task.rs:\n\nNew schema:\n```json\n{\n  \"task_type\": { \"type\": \"string\", \"description\": \"Category of work (e.g. rust, react, search)\" },\n  \"difficulty\": { \"type\": \"string\", \"enum\": [\"small\", \"medium\", \"large\"], \"description\": \"Task complexity. small=trivial, medium=standard (default), large=complex\" },\n  \"description\": { \"type\": \"string\" },\n  \"prompt\": { \"type\": \"string\" },\n  \"session_id\": { \"type\": \"string\" }\n}\n```\n\nNew TaskArgs:\n```rust\nstruct TaskArgs {\n    description: String,\n    prompt: String,\n    task_type: String,\n    difficulty: Option\u003cTaskDifficulty\u003e,\n    session_id: Option\u003cString\u003e,\n}\n```\n\nTool description lists available task types from registry.\n\nDoD: Task tool accepts task_type + difficulty","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:25.11881378+01:00","updated_at":"2026-01-14T00:16:12.089848396+01:00","closed_at":"2026-01-14T00:16:12.089848396+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.10","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:25.130613738+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.11","title":"Implement difficulty-based strategy resolution","description":"In task handler, resolve strategy from difficulty:\n\n1. Get task definition from registry\n2. Get difficulty (default: medium)\n3. Check difficulty_overrides for exact match\n4. If no match, use default_strategy\n5. Apply resolved model + reasoning_effort to sub_config\n6. Log: info!(task_type, difficulty, model, reasoning_effort)\n\n```rust\nlet strategy = registry.resolve_strategy(\u0026args.task_type, difficulty);\nif let Some(model) = \u0026strategy.model {\n    sub_config.model = Some(model.clone());\n    // resolve provider...\n}\nif let Some(effort) = strategy.reasoning_effort {\n    sub_config.model_reasoning_effort = effort.to_reasoning_effort();\n}\n```\n\nDoD: Difficulty selects correct model/effort","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:26.383308387+01:00","updated_at":"2026-01-13T21:50:22.874029667+01:00","dependencies":[{"issue_id":"codex-jq3.11","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:26.39514261+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.12","title":"Implement skills loading and injection","description":"Load skills from Agent Skills folders:\n\n1. Skills paths: [cwd/.codex/skills, ~/.codex/skills]\n2. For each skill in task.skills:\n   - Try {path}/{skill}/SKILL.md (standard)\n   - Try {path}/{skill}.md (simple)\n3. Inject loaded skills into system prompt\n\n```rust\nfn load_skill(\u0026self, name: \u0026str) -\u003e Option\u003cString\u003e {\n    for base in \u0026self.skills_paths {\n        let paths = [\n            base.join(name).join(\"SKILL.md\"),\n            base.join(format!(\"{name}.md\")),\n        ];\n        for p in paths {\n            if p.exists() {\n                return std::fs::read_to_string(p).ok();\n            }\n        }\n    }\n    None\n}\n```\n\nDoD: Skills are loaded and injected into worker prompt","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:27.644346019+01:00","updated_at":"2026-01-14T00:16:12.813164536+01:00","closed_at":"2026-01-14T00:16:12.813164536+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.12","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:27.656257139+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.13","title":"Remove subagent_name from tool API","description":"Remove all references to subagent_name from tool API:\n\n1. Remove subagent_name from TaskArgs\n2. Remove subagent_name from JSON schema\n3. Update tool description to list task types instead of subagents\n4. Update all callers to use task_type\n\nNO backward compatibility alias. Clean break.\n\nDoD: subagent_name is gone from tool API","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:28.960778704+01:00","updated_at":"2026-01-14T00:16:13.523210767+01:00","closed_at":"2026-01-14T00:16:13.523210767+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.13","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:28.971536102+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.14","title":"Update TUI to display task_type:difficulty","description":"Update TUI delegation display:\n\nFormat: `@{task_type}:{difficulty}` (only show difficulty if not medium)\n\nExamples:\n```\n• Delegated to @rust:large #019bb773...\n  └ Implement auth system\n\n• Delegated to @react #019bb773...\n  └ Fix button styling\n```\n\nUpdate SubagentEventPayload to include task_type and difficulty instead of subagent_name.\n\nDoD: TUI shows @rust:large for non-default difficulty","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:30.27212218+01:00","updated_at":"2026-01-14T00:16:14.327923855+01:00","closed_at":"2026-01-14T00:16:14.327923855+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.14","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:30.284047035+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.15","title":"Create built-in task types (rust, search, planning, review, ui)","description":"Define built-in task types (embedded in binary, user can override):\n\n```rust\nconst BUILTIN_TASKS: \u0026[(\u0026str, \u0026str, \u0026str)] = \u0026[\n    (\"code\", \"General code changes\", \"workspace-write\"),\n    (\"search\", \"Find code, definitions, references\", \"read-only\"),\n    (\"planning\", \"Architecture and design decisions\", \"read-only\"),\n    (\"review\", \"Code review\", \"read-only\"),\n    (\"ui\", \"Frontend and UI work\", \"workspace-write\"),\n];\n```\n\nKeep task types curated (~5-10). Skills provide granularity.\n\nDoD: Built-in task types work without config","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:31.827698816+01:00","updated_at":"2026-01-14T00:16:16.273620397+01:00","closed_at":"2026-01-14T00:16:16.273620397+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.15","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:31.83969098+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.16","title":"Add tests for task routing","description":"Test cases:\n\n1. Task type resolution from config\n2. Difficulty strategy override (small/medium/large)\n3. Default difficulty = medium when omitted\n4. Skills loaded and injected\n5. Unknown task_type returns error with available types\n6. Duplicate task types rejected at config load\n7. Session reuse validates task_type matches\n8. Sandbox/approval policies from task config\n\nDoD: cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:33.061149162+01:00","updated_at":"2026-01-14T00:16:16.99571643+01:00","closed_at":"2026-01-14T00:16:16.99571643+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.16","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:33.07316941+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.17","title":"Update docs and system prompt","description":"Update documentation:\n\n1. Tool description in create_task_tool():\n   - List available task types\n   - Explain difficulty: small (trivial), medium (standard), large (complex)\n   - No mention of models or personas\n\n2. docs/tasks.md (new):\n   - Explain WHAT + DIFFICULTY model\n   - Config examples\n   - How to add custom task types\n   - How skills work\n\n3. Update BASE_INSTRUCTIONS if needed\n\nDoD: Docs explain task-based delegation","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:34.210509553+01:00","updated_at":"2026-01-14T00:16:17.289531722+01:00","closed_at":"2026-01-14T00:16:17.289531722+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.17","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:34.222776161+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.2","title":"Add tier to task tool schema","description":"Update task tool in core/src/tools/handlers/task.rs:\n\n1. Add tier to TaskArgs struct\n2. Add to JSON schema with enum values\n3. Update tool description\n\n```rust\nstruct TaskArgs {\n    // existing...\n    tier: Option\u003cTaskTier\u003e,  // NEW\n}\n```\n\nSchema:\n```json\n\"tier\": {\n    \"type\": \"string\",\n    \"enum\": [\"trivial\", \"simple\", \"moderate\", \"complex\", \"epic\"],\n    \"description\": \"Task complexity. trivial=typo fix, simple=small bug, moderate=standard feature (default), complex=multi-file work, epic=architecture change. Selects model tier from config.\"\n}\n```\n\nDoD: Task tool accepts tier parameter","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:02:30.309973744+01:00","updated_at":"2026-01-13T21:42:13.85853189+01:00","closed_at":"2026-01-13T21:42:13.85853189+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.2","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:02:30.317122028+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.3","title":"Implement tier resolution (ceiling then max)","description":"When spawning subagent, resolve config tier:\n\n**Algorithm:**\n1. Get all configured tiers for agent name (where enabled != false)\n2. Normalize: tier omitted in config = default tier entry\n3. If tier requested:\n   - Find smallest configured tier \u003e= requested (ceiling)\n   - If none, use highest configured (max)\n4. If tier not requested: use moderate as requested tier\n5. Apply selected tier's model + reasoning_effort\n6. Log: info!(subagent, requested_tier, selected_tier, model)\n\n**Example:**\nConfigured: [moderate, epic], Requested: complex\n→ Selected: epic (smallest \u003e= complex)\n\nConfigured: [trivial, simple], Requested: complex  \n→ Selected: simple (highest available)\n\n**Guardrails:**\n- Reject duplicate (name, tier) at config load\n- Session reuse ignores tier (spawn-time only)\n\nLocation: core/src/tools/handlers/task.rs or core/src/config/mod.rs\n\nDoD: Tier resolution works per algorithm","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:02:31.762852746+01:00","updated_at":"2026-01-13T21:42:13.873341561+01:00","closed_at":"2026-01-13T21:42:13.873341561+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.3","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:02:31.769026719+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.4","title":"Update docs and system prompt with tier","description":"Document tier in:\n\n1. Task tool description (system prompt)\n2. docs/agents.md\n\nContent:\n- tier describes TASK COMPLEXITY, not work style\n- trivial: typo fix, rename variable\n- simple: small bug fix, add logging  \n- moderate: standard feature, refactor (DEFAULT)\n- complex: multi-file feature, debugging\n- epic: architecture change, full system implementation\n\nConfig example:\n```toml\n[[agent]]\nname = \"general\"\nmodel = \"openai/gpt-4o-mini\"\n\n[[agent]]\nname = \"general\"\ntier = \"epic\"\nmodel = \"anthropic/claude-opus\"\nreasoning_effort = \"xhigh\"\n```\n\nDoD: Users understand tier = task complexity classifier","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:02:32.946327163+01:00","updated_at":"2026-01-13T21:42:13.888617612+01:00","closed_at":"2026-01-13T21:42:13.888617612+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.4","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:02:32.95330958+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.5","title":"Add tests for tier resolution","description":"Test cases:\n\n1. Default tier (moderate) used when tier omitted in request\n2. Exact tier match when configured\n3. Ceiling: configured [moderate, epic], request complex → epic\n4. Max fallback: configured [trivial, simple], request complex → simple\n5. Duplicate (name, tier) rejected at config load\n6. Session reuse ignores tier parameter\n7. Tier's model + reasoning_effort applied to spawned config\n\nDoD: cargo test -p codex-core passes with new tests","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:02:34.245284062+01:00","updated_at":"2026-01-13T21:42:13.902908823+01:00","closed_at":"2026-01-13T21:42:13.902908823+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.5","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:02:34.252615816+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.6","title":"Display tier in TUI delegation (@agent:tier format)","description":"Update TUI delegation display to show tier.\n\n**Format:** `@{agent}:{tier}` - only show tier when not default (moderate)\n\n**Examples:**\n```\n• Delegated to @general:epic #019bb773-b381-7812-9c5f-2dafb21ed060\n  └ Implement full authentication system\n\n• Delegated to @rush #019bb773-b381-7812-9c5f-2dafb21ed060\n  └ Fix typo in config.rs\n```\n\n**Implementation:**\n1. Add tier field to SubagentEventPayload (protocol)\n2. Pass tier from task handler to event\n3. In TUI subagent cell rendering, append `:{tier}` to agent name if tier != moderate\n4. Style: same color as agent name (magenta), tier part can be slightly dimmed\n\n**Location:** tui/src/history_cell.rs or wherever subagent cells are rendered\n\nDoD: TUI shows @general:epic for non-default tiers","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T14:34:17.742747494+01:00","updated_at":"2026-01-13T21:42:13.918938873+01:00","closed_at":"2026-01-13T21:42:13.918938873+01:00","close_reason":"Superseded by new design","dependencies":[{"issue_id":"codex-jq3.6","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T14:34:17.743379129+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.7","title":"Add TaskConfigToml and Difficulty enum to config/types.rs","description":"Add to core/src/config/types.rs:\n\n```rust\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Deserialize, Serialize, Default)]\n#[serde(rename_all = \"lowercase\")]\npub enum TaskDifficulty {\n    Small,\n    #[default]\n    Medium,\n    Large,\n}\n\n#[derive(Debug, Clone, Deserialize, Serialize)]\npub struct TaskDifficultyStrategy {\n    pub model: Option\u003cString\u003e,\n    pub reasoning_effort: Option\u003cSubagentReasoningEffort\u003e,\n}\n\n#[derive(Debug, Clone, Deserialize, Serialize)]\n#[serde(deny_unknown_fields)]\npub struct TaskConfigToml {\n    #[serde(rename = \"type\")]\n    pub task_type: String,\n    pub description: Option\u003cString\u003e,\n    pub skills: Option\u003cVec\u003cString\u003e\u003e,\n    pub model: Option\u003cString\u003e,\n    pub reasoning_effort: Option\u003cSubagentReasoningEffort\u003e,\n    pub sandbox_policy: Option\u003cSubagentSandboxPolicy\u003e,\n    pub approval_policy: Option\u003cSubagentApprovalPolicy\u003e,\n    pub difficulty: Option\u003cHashMap\u003cTaskDifficulty, TaskDifficultyStrategy\u003e\u003e,\n}\n```\n\nDoD: cargo check -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:21.086919087+01:00","updated_at":"2026-01-14T00:16:07.31453278+01:00","closed_at":"2026-01-14T00:16:07.31453278+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.7","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:21.099498602+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.8","title":"Add [[task]] parsing to config/mod.rs","description":"Add [[task]] to ConfigToml in core/src/config/mod.rs:\n\n```rust\n#[derive(Deserialize, Debug, Clone, Default)]\npub struct ConfigToml {\n    // ... existing fields ...\n    \n    #[serde(default)]\n    pub task: Vec\u003cTaskConfigToml\u003e,\n}\n```\n\nParse and validate task configs. Reject duplicate task types at load time.\n\nDoD: Config loads [[task]] blocks from config.toml","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:22.353193944+01:00","updated_at":"2026-01-14T00:16:10.620548315+01:00","closed_at":"2026-01-14T00:16:10.620548315+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.8","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:22.365121696+01:00","created_by":"daemon"}]}
{"id":"codex-jq3.9","title":"Create TaskRegistry replacing SubagentRegistry","description":"Create TaskRegistry in core/src/task_registry.rs (or refactor subagents.rs):\n\n```rust\npub struct TaskDefinition {\n    pub task_type: String,\n    pub description: Option\u003cString\u003e,\n    pub skills: Vec\u003cString\u003e,\n    pub default_strategy: TaskStrategy,\n    pub difficulty_overrides: HashMap\u003cTaskDifficulty, TaskStrategy\u003e,\n    pub sandbox_policy: SubagentSandboxPolicy,\n    pub approval_policy: SubagentApprovalPolicy,\n}\n\npub struct TaskStrategy {\n    pub model: Option\u003cString\u003e,\n    pub reasoning_effort: Option\u003cSubagentReasoningEffort\u003e,\n}\n\npub struct TaskRegistry {\n    tasks: HashMap\u003cString, TaskDefinition\u003e,\n    skills_paths: Vec\u003cPathBuf\u003e,\n}\n\nimpl TaskRegistry {\n    pub fn new(config: \u0026Config) -\u003e Self { ... }\n    pub fn get(\u0026self, task_type: \u0026str) -\u003e Option\u003c\u0026TaskDefinition\u003e { ... }\n    pub fn resolve_strategy(\u0026self, task_type: \u0026str, difficulty: TaskDifficulty) -\u003e TaskStrategy { ... }\n    pub fn load_skill(\u0026self, name: \u0026str) -\u003e Option\u003cString\u003e { ... }\n}\n```\n\nDoD: TaskRegistry loads from config and resolves strategies","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-13T21:42:23.649932828+01:00","updated_at":"2026-01-14T00:16:11.35674876+01:00","closed_at":"2026-01-14T00:16:11.35674876+01:00","close_reason":"Implemented","dependencies":[{"issue_id":"codex-jq3.9","depends_on_id":"codex-jq3","type":"parent-child","created_at":"2026-01-13T21:42:23.662004213+01:00","created_by":"daemon"}]}
{"id":"codex-kmy","title":"Fix alignment of '+x more' line in subagent activity log","description":"## Problem\nThe '+x more' collapse indicator has wrong alignment in subagent activity rendering:\n\n```\n• Delegated to @finder #session-id\n  └ Check if codex-6kk is implemented\n  ... +1 more   \u003c-- WRONG: uses content_indent (2 spaces)\n    ✓ Ran rg -n -i quota   \u003c-- activity uses activity_indent (4 spaces)\n```\n\nShould be:\n```\n• Delegated to @finder #session-id\n  └ Check if codex-6kk is implemented\n    ... +1 more   \u003c-- CORRECT: uses activity_indent (4 spaces)\n    ✓ Ran rg -n -i quota\n```\n\n## Root Cause\nIn `tui/src/history_cell.rs`, the '+x more' line uses `content_indent` instead of `activity_indent`.\n\n## File \u0026 Location\n`tui/src/history_cell.rs` - `impl HistoryCell for SubagentTaskCell`, `display_lines()` method, around line 1355-1358.\n\n## Current Code (line ~1355)\n```rust\nif skipped_block_count \u003e 0 {\n    lines.push(Line::from(vec![\n        content_indent.clone().into(),  // \u003c-- BUG: should be activity_indent\n        format!(\"... +{skipped_block_count} more\").dim().italic(),\n    ]));\n    skipped_block_count = 0;\n}\n```\n\n## Fix\nChange `content_indent` to `activity_indent` in all three places where '+x more' is rendered (lines ~1355, ~1378, ~1392).\n\n## Also Required\nChange `saturating_sub(5)` to `saturating_sub(3)` on line ~1341 to reduce visible items from 5 to 3.\n\n## Tests\nRun `cargo test -p codex-tui` - snapshot tests may need updating with `cargo insta accept -p codex-tui`.","status":"closed","priority":2,"issue_type":"bug","created_at":"2026-01-04T13:29:23.026540306+01:00","updated_at":"2026-01-05T01:05:22.766735178+01:00","closed_at":"2026-01-05T01:05:22.766735178+01:00"}
{"id":"codex-lhn","title":"Skills system improvements: port features from pi","description":"Skills system redesign (workers + selectable skills).\n\nExisting port goals (pi-mono -\u003e codex-rs):\n1. Glob filtering (include/exclude patterns for skills)\n2. Claude compatibility (~/.claude/skills by default)\n3. Symlink deduplication (resolve real paths before name-dedup)\n4. Trim verbose prompt instructions in render.rs\n\nNew goals (this fork):\n- Add internal/hidden skills (not visible/selectable by main agent)\n- Keep review as a task handler, but move the strict ReviewOutputEvent contract into an internal skill\n- Replace oracle persona with one or more skills\n- Add a dynamic general task handler where the main agent can select required (public) skills at runtime\n- Ensure worker sessions only receive the skills they are assigned (no implicit skill-trigger injection)\n\nGrounding:\n- core/src/skills/{loader,manager,model,render,injection}.rs\n- core/src/tools/handlers/task.rs (task tool schema + worker spawning)\n- protocol/src/protocol.rs (ReviewOutputEvent)\n- tui/src/chatwidget.rs (review parsing)\n\nDoD:\n- Public skill precedence: project (.codex/skills) \u003e home (~/.codex/skills) \u003e internal/system\n- Internal skills are never visible/selectable by main agent; cannot be overridden by project/home\n- task tool supports runtime skill selection for task_type=general (enum of public skills)\n- review task still renders in TUI via ReviewOutputEvent parsing\n- Targeted tests pass (cargo test -p codex-core; cargo test -p codex-tui if touched)","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-14T12:52:02.233682326+01:00","updated_at":"2026-01-14T12:55:13.401132642+01:00"}
{"id":"codex-lhn.1","title":"Add SkillsConfig to config system with include/exclude glob patterns","description":"Add a new [skills] section to config with glob patterns for filtering:\n\n```toml\n[skills]\ninclude = [\"code-*\", \"deploy-*\"]  # Optional, default: all\nexclude = [\"test-*\", \"*-deprecated\"]  # Optional, default: none\n```\n\nFiles to modify:\n- core/src/config/types.rs: Add SkillsConfigToml struct with include/exclude Vec\u003cString\u003e\n- core/src/config/mod.rs: Wire up parsing and defaults\n\nUse wildmatch crate (already in deps) for glob matching.\n\nDoD:\n- SkillsConfigToml struct exists with include/exclude fields\n- Config::skills() returns the parsed config\n- cargo check --bin codex passes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T12:52:12.279136533+01:00","updated_at":"2026-01-14T12:52:12.279136533+01:00","dependencies":[{"issue_id":"codex-lhn.1","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:52:12.291448304+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.10","title":"Move review contract into internal skill","description":"Make `task_type = \"review\"` a task handler that enforces its strict ReviewOutputEvent JSON contract via an internal skill.\n\nScope:\n- Create an internal system skill named `review` containing the current review prompt template + JSON output requirements.\n- Update the built-in `review` task handler to attach that internal skill.\n- Preserve TUI behavior that parses ReviewOutputEvent on review task completion.\n\nGrounding:\n- core/src/subagents/review.md (current template)\n- core/src/task_registry.rs (review builtin task)\n- core/src/review_prompts.rs (review prompt generation)\n- tui/src/chatwidget.rs (review parsing)\n- protocol/src/protocol.rs (ReviewOutputEvent)\n\nDoD:\n- Review task still produces ReviewOutputEvent JSON and TUI renders findings.\n- Internal `review` skill is not visible/selectable.\n- Tests updated/added (core + tui if needed).\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:45.505822219+01:00","updated_at":"2026-01-14T12:56:49.88235514+01:00","dependencies":[{"issue_id":"codex-lhn.10","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:45.518009133+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.10","depends_on_id":"codex-lhn.7","type":"blocks","created_at":"2026-01-14T12:57:18.573645098+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.10","depends_on_id":"codex-lhn.9","type":"blocks","created_at":"2026-01-14T12:57:19.061085818+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.11","title":"Add dynamic general task skill selection","description":"Allow runtime skill selection only for `task_type = \"general\"`.\n\nScope:\n- Extend task tool args to accept `skills: [string]` only when `task_type==\"general\"`.\n- Validate `skills` against discovered *public* skills.\n- Task tool JSON schema exposes `skills` as an enum generated at runtime from public skills.\n\nGrounding:\n- core/src/tools/handlers/task.rs (create_task_tool + TaskArgs)\n- core/src/tools/spec.rs (JsonSchema; currently lacks string enums)\n- core/src/skills/manager.rs (skill inventory)\n\nDoD:\n- JsonSchema supports string enums.\n- task tool schema includes `skills` field for general.\n- Invalid skill names produce clear errors.\n- Tests cover schema + validation.\n","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:49.688940201+01:00","updated_at":"2026-01-14T12:56:52.548652633+01:00","dependencies":[{"issue_id":"codex-lhn.11","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:49.700489998+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.11","depends_on_id":"codex-lhn.7","type":"blocks","created_at":"2026-01-14T12:57:19.522406899+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.12","title":"Enforce worker receives only assigned skills","description":"Workers must only see skills explicitly assigned by the task handler (or, for general, by the tool call). No implicit/ambient skill availability.\n\nScope:\n- Disable or restrict the current skill auto-injection path (core/src/skills/injection.rs) so it cannot inject into worker turns.\n- Ensure worker system prompts include only the skill bodies for assigned skills.\n\nGrounding:\n- core/src/skills/injection.rs (current auto-trigger injection)\n- core/src/codex.rs (where build_skill_injections is applied)\n- core/src/tools/handlers/task.rs (current skill injection into worker prompt)\n\nDoD:\n- Auto-injection cannot add skills to worker sessions.\n- Worker prompt includes only assigned skills.\n- Tests cover both parent and worker behavior.","status":"open","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:53.186592744+01:00","updated_at":"2026-01-14T12:55:53.186592744+01:00","dependencies":[{"issue_id":"codex-lhn.12","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:53.199775117+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.12","depends_on_id":"codex-lhn.6","type":"blocks","created_at":"2026-01-14T12:57:19.962687387+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.13","title":"Oracle -\u003e skills migration","description":"Remove the oracle persona/worker from user-facing delegation and replace it with one or more skills.\n\nScope:\n- Create public skills (e.g., architecture-advisor, debugging-strategy) with content from existing oracle prompt.\n- Stop exposing oracle as a built-in delegatable worker/task type.\n- Update docs and any UI/tooling that references oracle.\n\nGrounding:\n- core/src/subagents/oracle.md (current)\n- core/src/skills/{manager,loader,render}.rs\n- docs/* (delegation guidance)\n\nDoD:\n- Oracle no longer appears as a selectable worker.\n- Equivalent behavior achievable via skills + general task.\n- Docs updated.","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T12:55:57.966946577+01:00","updated_at":"2026-01-14T12:55:57.966946577+01:00","dependencies":[{"issue_id":"codex-lhn.13","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:57.979033909+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.13","depends_on_id":"codex-lhn.6","type":"blocks","created_at":"2026-01-14T12:57:21.029031824+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.2","title":"Implement glob filtering in skill loader","description":"Apply include/exclude glob patterns during skill discovery.\n\nFile: core/src/skills/loader.rs\n\nLogic (from pi):\n1. After parsing a skill, check if name matches exclude patterns -\u003e skip\n2. Then check if name matches include patterns (if any) -\u003e skip if no match\n3. Exclude takes precedence over include\n\nUse wildmatch::WildMatch for pattern matching.\n\nExample:\n```rust\nfn matches_patterns(name: \u0026str, patterns: \u0026[String]) -\u003e bool {\n    patterns.iter().any(|p| WildMatch::new(p).matches(name))\n}\n\n// In discover_skills_under_root:\nif matches_patterns(\u0026skill.name, \u0026config.skills.exclude) {\n    continue;\n}\nif !config.skills.include.is_empty() \u0026\u0026 !matches_patterns(\u0026skill.name, \u0026config.skills.include) {\n    continue;\n}\n```\n\nDoD:\n- Skills matching exclude patterns are not loaded\n- Skills not matching include patterns (when set) are not loaded\n- Unit tests verify filtering behavior\n- cargo test -p codex-core passes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T12:52:25.551923939+01:00","updated_at":"2026-01-14T12:52:25.551923939+01:00","dependencies":[{"issue_id":"codex-lhn.2","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:52:25.563942871+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.2","depends_on_id":"codex-lhn.1","type":"blocks","created_at":"2026-01-14T12:53:04.864082992+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.3","title":"Add ~/.claude/skills as default skill discovery path","description":"Add ~/.claude/skills as a skill discovery location for Claude compatibility.\n\nFile: core/src/skills/loader.rs\n\nChanges:\n1. Add claude_user_skills_root() function returning ~/.claude/skills with SkillScope::User\n2. Add to roots list in load_skills_from_roots() - after repo, before user codex skills\n3. Use 'claude' format (one level deep) like pi does, OR keep recursive (simpler)\n\nPriority order (first wins on name collision):\n1. Repo skills (.codex/skills)\n2. Claude user skills (~/.claude/skills) \n3. Codex user skills (~/.codex/skills)\n4. System skills\n\nDoD:\n- Skills in ~/.claude/skills are discovered\n- Collision with same-named codex skill: repo \u003e claude \u003e codex user\n- cargo test -p codex-core passes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T12:52:36.118561434+01:00","updated_at":"2026-01-14T12:52:36.118561434+01:00","dependencies":[{"issue_id":"codex-lhn.3","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:52:36.130590084+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.4","title":"Add symlink deduplication to skill loader","description":"Currently loader.rs skips symlinks entirely. Instead, resolve symlinks and deduplicate by real path to avoid loading the same skill twice via different paths.\n\nFile: core/src/skills/loader.rs\n\nCurrent behavior (problematic):\n```rust\nif file_type.is_symlink() {\n    continue;  // Skips symlinked skills entirely!\n}\n```\n\nNew behavior (from pi):\n1. Follow symlinks to get the real file\n2. Track seen real paths in a HashSet\n3. Skip if real path already seen (silent dedup)\n4. Warn on name collision from different real paths\n\nUse dunce::canonicalize (already imported as normalize_path) to resolve symlinks.\n\nDoD:\n- Symlinked SKILL.md files are loaded (not skipped)\n- Same skill via multiple symlinks is loaded once (no duplicates)\n- Name collision from different real paths logs warning\n- cargo test -p codex-core passes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-14T12:52:46.734246923+01:00","updated_at":"2026-01-14T12:52:46.734246923+01:00","dependencies":[{"issue_id":"codex-lhn.4","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:52:46.746217494+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.5","title":"Trim verbose skill instructions in render.rs","description":"The render_skills_section() function adds ~40 lines of detailed usage instructions to the system prompt. This wastes tokens and may be redundant.\n\nFile: core/src/skills/render.rs\n\nCurrent verbose block includes:\n- Trigger rules\n- Progressive disclosure steps\n- Context hygiene guidelines\n- Safety and fallback\n\nProposed trimmed version (like pi):\n```rust\nlines.push(\"## Skills\".to_string());\nlines.push(\"Use the read_file tool to load a skill when the task matches its description.\".to_string());\n\nfor skill in skills {\n    lines.push(format!(\"- {}: {} (file: {})\", skill.name, skill.description, path_str));\n}\n```\n\nDoD:\n- Verbose instruction block removed or significantly trimmed\n- Basic instruction remains (how to load skills)\n- Skill list format unchanged\n- cargo check --bin codex passes","status":"open","priority":3,"issue_type":"task","created_at":"2026-01-14T12:52:59.290819951+01:00","updated_at":"2026-01-14T12:52:59.290819951+01:00","dependencies":[{"issue_id":"codex-lhn.5","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:52:59.30285839+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.6","title":"Decide skill injection + internal override rules","description":"Decision (v2): explicit skills + hidden internal skills\n\n1) Skill injection policy\n- Keep skill usage explicit. No description-based auto-trigger injection.\n- Root session may include the public skill inventory (\"## Skills\") for discovery, but skill bodies are only injected when explicitly selected.\n- Workers never receive the public skills inventory and cannot add skills beyond those assigned by the task handler/tool call.\n\n2) Internal skills policy\n- Support `internal: true` in SKILL.md metadata.\n- Internal skills are hidden from the main agent:\n  - not listed in the \"## Skills\" prompt section\n  - not eligible for runtime selection (task tool enum)\n- Internal skills are reserved and cannot be shadowed by project/home skills. If a public skill uses an internal name, ignore it and emit a warning.\n\n3) Worker skill exposure\n- Workers receive only the explicitly assigned skills (plus any handler-mandated internal skills).\n- Workers do not run the skill injection path.\n\n4) Review/oracle alignment\n- review remains a task handler, but its strict ReviewOutputEvent JSON contract is moved into an internal skill that the review handler always attaches.\n- oracle persona is removed/replaced by one or more skills (public skills), not by a dedicated worker type.\n\nGrounding\n- core/src/skills/{loader,render,injection}.rs\n- core/src/tools/handlers/task.rs\n\nDoD\n- This decision is implemented and reflected in docs (docs/tasks.md and docs/task_handlers.md).\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:25.80836005+01:00","updated_at":"2026-01-14T13:21:25.265827427+01:00","closed_at":"2026-01-14T13:21:25.265830513+01:00","dependencies":[{"issue_id":"codex-lhn.6","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:25.820114759+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.7","title":"Add internal flag to SKILL.md metadata","description":"Extend skill metadata parsing to support an `internal: true|false` flag in `SKILL.md` frontmatter.\n\nGrounding:\n- core/src/skills/model.rs (SkillMetadata)\n- core/src/skills/loader.rs (parse_skill_file)\n- protocol/src/protocol.rs (SkillScope, SkillsListEntry)\n\nDoD:\n- SkillMetadata includes `internal: bool` (default: false).\n- YAML frontmatter parsing reads `internal`.\n- Unit tests cover default (missing) + explicit internal=true.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:33.531477048+01:00","updated_at":"2026-01-14T13:38:27.738138452+01:00","closed_at":"2026-01-14T13:38:27.738138452+01:00","close_reason":"Done","dependencies":[{"issue_id":"codex-lhn.7","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:33.538046117+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.8","title":"Hide internal skills from main-agent skill list","description":"Ensure internal skills are not visible to the main agent.\n\nScope:\n- Filter `internal=true` skills out of `core/src/skills/render.rs::render_skills_section`.\n- Filter internal skills out of any skills list surfaced to UI/protocol if applicable.\n\nGrounding:\n- core/src/skills/render.rs\n- core/src/skills/model.rs\n- core/src/skills/manager.rs (skill inventory)\n\nDoD:\n- Internal skills are omitted from the rendered skills section.\n- Tests updated/added for render output.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:37.917487731+01:00","updated_at":"2026-01-14T13:59:12.655690994+01:00","closed_at":"2026-01-14T13:59:12.655690994+01:00","close_reason":"Done","dependencies":[{"issue_id":"codex-lhn.8","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:37.925006934+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.8","depends_on_id":"codex-lhn.7","type":"blocks","created_at":"2026-01-14T12:57:17.665606642+01:00","created_by":"daemon"}]}
{"id":"codex-lhn.9","title":"Prevent internal skills from being shadowed","description":"Internal skills must not be overridden by repo/home skills, even though public skill precedence is project (.codex/skills) \u003e home (~/.codex/skills) \u003e internal/system.\n\nScope:\n- Define rule: if a *system* skill has `internal=true`, ignore any repo/home skill with the same name.\n- Emit a warning when a shadowing attempt is detected.\n\nGrounding:\n- core/src/skills/loader.rs (load_skills_from_roots precedence)\n- core/src/skills/manager.rs (install_system_skills)\n\nDoD:\n- Collision tests: internal system skill wins over repo/home.\n- Warning emitted on shadow attempt.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T12:55:41.322654914+01:00","updated_at":"2026-01-14T13:59:13.082928851+01:00","closed_at":"2026-01-14T13:59:13.082928851+01:00","close_reason":"Done","dependencies":[{"issue_id":"codex-lhn.9","depends_on_id":"codex-lhn","type":"parent-child","created_at":"2026-01-14T12:55:41.334674667+01:00","created_by":"daemon"},{"issue_id":"codex-lhn.9","depends_on_id":"codex-lhn.7","type":"blocks","created_at":"2026-01-14T12:57:18.085102987+01:00","created_by":"daemon"}]}
{"id":"codex-log","title":"TUI doesn't handle subagent Error events - cell stays active forever","description":"When a subagent fails with an HTTP error, the TUI doesn't properly handle the EventMsg::Error event:\n\n**Root Cause (2 parts):**\n\n1. In `tui/src/chatwidget.rs` - `update_subagent_state_with_event()`:\n   - Handles `TaskComplete` → sets status to Completed\n   - Handles `TurnAborted` → sets status to Failed\n   - But `EventMsg::Error` falls into `_ =\u003e {}` wildcard - status never updated\n\n2. In `tui/src/chatwidget.rs` - `on_subagent_event()`:\n   - Only flushes cell to history for `TaskComplete` or `TurnAborted`\n   - `EventMsg::Error` is not included in the match\n\n**Symptoms:**\n- User sees subagent cell stuck in active view forever\n- No error message shown to user\n- Main agent receives the failure (core sends SubagentExecutionOutcome::Failed)\n- But TUI never updates or removes the cell\n\n**Fix needed:**\n1. Add `EventMsg::Error(_) =\u003e { guard.status = SubagentTaskStatus::Failed; }` in update_subagent_state_with_event\n2. Add `EventMsg::Error(_)` to the match in on_subagent_event that triggers cell flush to history\n\n**Files:**\n- tui/src/chatwidget.rs (lines ~2540-2560 for update_subagent_state_with_event)\n- tui/src/chatwidget.rs (lines ~2430-2450 for on_subagent_event flush logic)\n\n**Related core code (works correctly):**\n- core/src/tools/handlers/task.rs:604-635 - correctly wraps Error as SubagentEvent and returns Failed outcome","status":"closed","priority":1,"issue_type":"bug","created_at":"2026-01-05T02:39:48.327690812+01:00","updated_at":"2026-01-05T03:47:40.902267275+01:00","closed_at":"2026-01-05T03:47:40.902267275+01:00"}
{"id":"codex-mxb","title":"Fail on non-git directory instead of silent degradation","description":"## Problem\nCurrent implementation silently degrades when workspace is not a git repository - it logs a warning and runs subagent without isolation. This violates the \"all or nothing\" principle and can cause:\n- Parallel subagents corrupting each other's files\n- No change tracking (wrong information)\n- Silent data loss\n\n## Solution\nFail immediately with a clear, actionable error when git is not available.\n\n## Implementation\n\n### Step 1: Remove the graceful degradation in task.rs\n\nFind this code in `core/src/tools/handlers/task.rs`:\n\n```rust\nlet worktree_handle = match worktree_manager.create_worktree(\u0026parent_worktree).await {\n    Ok(handle) =\u003e Some(handle),\n    Err(e) =\u003e {\n        tracing::warn!(\n            subagent = %args.subagent_type,\n            error = %e,\n            \"Failed to create worktree, running without isolation\"\n        );\n        None\n    }\n};\n```\n\nReplace with:\n\n```rust\nlet worktree_handle = worktree_manager\n    .create_worktree(\u0026parent_worktree)\n    .await\n    .map_err(|e| {\n        FunctionCallError::RespondToModel(format!(\n            \"Subagent execution requires a git repository for workspace isolation.              Error: {e}. Please ensure you are in a git repository (run 'git init' if needed).\"\n        ))\n    })?;\n```\n\n### Step 2: Update subsequent code that checks for Option\n\nThe code currently uses `if let Some(ref handle) = worktree_handle`. \n\nAfter the change, `worktree_handle` is no longer an Option - it's always `WorktreeHandle`.\n\nUpdate all usages:\n\nBefore:\n```rust\nlet effective_cwd = worktree_handle\n    .as_ref()\n    .map(|h| h.path.clone())\n    .unwrap_or_else(|| parent_worktree.clone());\n```\n\nAfter:\n```rust\nlet effective_cwd = worktree_handle.path.clone();\n```\n\nBefore:\n```rust\nif let Some(ref handle) = worktree_handle {\n    // cleanup\n}\n```\n\nAfter:\n```rust\n// Always cleanup since worktree always exists\nlet _ = worktree_manager.cleanup(\u0026worktree_handle).await;\n```\n\nBefore:\n```rust\nlet subagent_changes: Option\u003cSubagentChanges\u003e = if let Some(ref handle) = worktree_handle {\n    // ...\n} else {\n    None\n};\n```\n\nAfter:\n```rust\nlet subagent_changes: SubagentChanges = {\n    // ... (no Option needed, always have handle)\n};\n```\n\n### Step 3: Update CARGO_TARGET_DIR logic\n\nBefore:\n```rust\nif worktree_handle.is_some() {\n    // set CARGO_TARGET_DIR\n}\n```\n\nAfter:\n```rust\n// Always in worktree now, always set\nlet cargo_target = parent_worktree.join(\"target\");\nif cargo_target.exists() || parent_worktree.join(\"Cargo.toml\").exists() {\n    sub_config.shell_environment_policy.r#set.insert(\n        \"CARGO_TARGET_DIR\".to_string(),\n        cargo_target.to_string_lossy().to_string(),\n    );\n}\n```\n\n### Step 4: Ensure cleanup on all error paths\n\nSince we now always have a worktree, ensure cleanup happens on:\n- Subagent crash/timeout\n- TurnAborted\n- Any error after worktree creation\n\nUse a guard pattern or ensure all error paths call cleanup.\n\n## Files to modify\n- `core/src/tools/handlers/task.rs`\n\n## Error message format\nThe error returned to the model should be:\n```\nSubagent execution requires a git repository for workspace isolation. \nError: Not a git repository: /path/to/dir. \nPlease ensure you are in a git repository (run 'git init' if needed).\n```\n\n## Tests\n- Test that non-git directory returns error (not silent success)\n- Test that error message is actionable\n- Test that git directory works normally\n\n## After implementation\n- Run `just fmt`\n- Run `cargo check --bin codex`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T15:01:12.251944448+01:00","updated_at":"2025-12-21T15:03:04.232420428+01:00","closed_at":"2025-12-21T15:03:04.232420428+01:00"}
{"id":"codex-n29","title":"Epic: Fix Claude Extended Thinking Bug in Antigravity Provider","description":"## Problem\nWhen using Claude Opus 4.5 via Antigravity with `model_reasoning_effort = \"medium\"`, after a tool call we get:\n```\nmessages.1.content.0.type: Expected `thinking` or `redacted_thinking`, but found `tool_use`.\nWhen `thinking` is enabled, a final `assistant` message must start with a thinking block.\n```\n\n## Root Cause (Confirmed by Oracle)\nIn `core/src/gemini_messages.rs`:\n\n1. `append_reasoning_delta()` streams thinking text via `ReasoningContentDelta` events but **intentionally does NOT accumulate** the text. Comment says: \"Stream only deltas; do not accumulate content in state.item to avoid duplication.\"\n\n2. `ensure_reasoning_item()` creates `ResponseItem::Reasoning` with empty fields:\n   ```rust\n   summary: Vec::new(),\n   content: Some(Vec::new()),\n   ```\n\n3. When stream ends, `OutputItemDone(state.item)` emits the **empty** Reasoning item.\n\n4. Empty item is recorded to history via `record_conversation_items`.\n\n5. `build_gemini_messages()` tries to extract thinking text from empty Reasoning → nothing there.\n\n6. Request goes to Claude without thinking block → API rejects it.\n\n## Comparison with Working Implementation\n`bedrock_messages.rs` (lines 283-293) DOES accumulate text:\n```rust\ntx.send(Ok(ResponseEvent::OutputItemDone(ResponseItem::Reasoning {\n    summary: vec![ReasoningItemReasoningSummary::SummaryText {\n        text: std::mem::take(\\u0026mut current_thinking),  // Accumulated!\n    }],\n    ...\n})))\n```\n\n## Fix Approach (Confirmed by Oracle)\n1. Accumulate reasoning text during streaming\n2. Populate `summary` field (like Bedrock) when emitting `OutputItemDone`\n3. The \"avoid duplication\" comment is incorrect - `append_text_delta` DOES accumulate text\n\n## Key Files\n- `core/src/gemini_messages.rs` - Main fix location\n- `core/src/bedrock_messages.rs` - Reference implementation\n\n## References\n- Anthropic docs: \"When thinking is enabled, a final assistant message must start with a thinking block\"\n- LLM-API-Key-Proxy: Has complex sanitization logic we can avoid by fixing at source","status":"closed","issue_type":"epic","created_at":"2026-01-03T22:24:07.589035701+01:00","updated_at":"2026-01-05T01:05:38.43735431+01:00","closed_at":"2026-01-05T01:05:38.43735431+01:00"}
{"id":"codex-n29.1","title":"Add accumulated_text field to ReasoningState struct","description":"## Task\nAdd a new field to `ReasoningState` struct to accumulate reasoning text during streaming.\n\n## File\n`core/src/gemini_messages.rs`\n\n## Current Code (around line 1716)\n```rust\nstruct ReasoningState {\n    item: ResponseItem,\n    added: bool,\n    streamed_delta_count: usize,\n}\n```\n\n## Required Change\n```rust\nstruct ReasoningState {\n    item: ResponseItem,\n    added: bool,\n    streamed_delta_count: usize,\n    accumulated_text: String,  // NEW: accumulate reasoning text\n}\n```\n\n## Also Update\nUpdate `ensure_reasoning_item()` (around line 1697) to initialize the new field:\n```rust\n*reasoning_state = Some(ReasoningState {\n    item,\n    added: false,\n    streamed_delta_count: 0,\n    accumulated_text: String::new(),  // NEW\n});\n```","status":"closed","issue_type":"task","created_at":"2026-01-03T22:24:19.352592964+01:00","updated_at":"2026-01-03T22:32:00.683911337+01:00","closed_at":"2026-01-03T22:32:00.683911337+01:00","dependencies":[{"issue_id":"codex-n29.1","depends_on_id":"codex-n29","type":"parent-child","created_at":"2026-01-03T22:24:19.352944886+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-n29.2","title":"Accumulate text in append_reasoning_delta function","description":"## Task\nModify `append_reasoning_delta()` to accumulate the reasoning text.\n\n## File\n`core/src/gemini_messages.rs`\n\n## Current Code (around line 1607)\n```rust\nasync fn append_reasoning_delta(\n    tx_event: \\u0026mpsc::Sender\u003cResult\u003cResponseEvent\u003e\u003e,\n    reasoning_state: \\u0026mut Option\u003cReasoningState\u003e,\n    emitted_content: \\u0026mut bool,\n    text: \\u0026str,\n) {\n    if text.is_empty() {\n        return;\n    }\n\n    ensure_reasoning_item(reasoning_state);\n    if let Some(state) = reasoning_state.as_mut() {\n        // ... existing code ...\n        \n        // Stream only deltas; do not accumulate content in state.item to avoid duplication.\n        let content_index = state.streamed_delta_count;\n        state.streamed_delta_count += 1;\n        let _ = tx_event\n            .send(Ok(ResponseEvent::ReasoningContentDelta {\n                delta: text.to_string(),\n                content_index,\n            }))\n            .await;\n        *emitted_content = true;\n    }\n}\n```\n\n## Required Change\nAdd accumulation BEFORE the delta send:\n```rust\nif let Some(state) = reasoning_state.as_mut() {\n    // ... existing added check code ...\n    \n    // Accumulate text for history (needed for Claude tool loops)\n    state.accumulated_text.push_str(text);\n    \n    // Stream deltas for UI\n    let content_index = state.streamed_delta_count;\n    state.streamed_delta_count += 1;\n    // ... rest unchanged ...\n}\n```\n\n## Note\nRemove or update the misleading comment \"do not accumulate content in state.item to avoid duplication\" - the duplication concern was incorrect. `append_text_delta` also accumulates and works fine.","status":"closed","issue_type":"task","created_at":"2026-01-03T22:24:35.01866449+01:00","updated_at":"2026-01-03T22:32:04.74642789+01:00","closed_at":"2026-01-03T22:32:04.74642789+01:00","dependencies":[{"issue_id":"codex-n29.2","depends_on_id":"codex-n29","type":"parent-child","created_at":"2026-01-03T22:24:35.019118898+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-n29.2","depends_on_id":"codex-n29.1","type":"blocks","created_at":"2026-01-03T22:25:11.662147371+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-n29.3","title":"Populate summary field when emitting OutputItemDone for Reasoning","description":"## Task\nWhen the stream ends, populate the `summary` field of the Reasoning item with accumulated text before emitting `OutputItemDone`.\n\n## File\n`core/src/gemini_messages.rs`\n\n## Current Code (around line 1320)\n```rust\n// Stream finished\n// Finalize reasoning FIRST so it appears before the message in history\nif let Some(state) = reasoning_state.take() {\n    if !state.added {\n        let _ = tx_event\n            .send(Ok(ResponseEvent::OutputItemAdded(state.item.clone())))\n            .await;\n    }\n    let _ = tx_event\n        .send(Ok(ResponseEvent::OutputItemDone(state.item)))\n        .await;\n}\n```\n\n## Required Change\nPopulate summary before emitting:\n```rust\nif let Some(mut state) = reasoning_state.take() {\n    // Populate summary with accumulated text (needed for Claude tool loops)\n    if !state.accumulated_text.is_empty() {\n        if let ResponseItem::Reasoning { ref mut summary, .. } = state.item {\n            summary.push(ReasoningItemReasoningSummary::SummaryText {\n                text: std::mem::take(\\u0026mut state.accumulated_text),\n            });\n        }\n    }\n    \n    if !state.added {\n        let _ = tx_event\n            .send(Ok(ResponseEvent::OutputItemAdded(state.item.clone())))\n            .await;\n    }\n    let _ = tx_event\n        .send(Ok(ResponseEvent::OutputItemDone(state.item)))\n        .await;\n}\n```\n\n## Import Required\nEnsure `ReasoningItemReasoningSummary` is imported:\n```rust\nuse codex_protocol::models::ReasoningItemReasoningSummary;\n```\n\n## Reference\nThis matches `bedrock_messages.rs` implementation (lines 286-290).","status":"closed","issue_type":"task","created_at":"2026-01-03T22:24:50.598958611+01:00","updated_at":"2026-01-03T22:32:05.72224624+01:00","closed_at":"2026-01-03T22:32:05.72224624+01:00","dependencies":[{"issue_id":"codex-n29.3","depends_on_id":"codex-n29","type":"parent-child","created_at":"2026-01-03T22:24:50.599286798+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-n29.3","depends_on_id":"codex-n29.2","type":"blocks","created_at":"2026-01-03T22:25:11.678648557+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-n29.4","title":"Add tests for reasoning text accumulation","description":"## Task\nAdd tests to verify reasoning text is properly accumulated and available in history.\n\n## File\n`core/src/gemini_messages.rs` (test module at bottom)\n\n## Test Cases\n\n### 1. test_reasoning_text_accumulated_in_output_item_done\nVerify that when streaming reasoning deltas, the final `OutputItemDone` event contains the accumulated text in the `summary` field.\n\n```rust\n#[tokio::test]\nasync fn test_reasoning_text_accumulated_in_output_item_done() {\n    // Setup mock SSE stream with thinking chunks\n    // Verify OutputItemDone(Reasoning { summary: [...accumulated...], ... })\n}\n```\n\n### 2. test_reasoning_preserved_in_tool_loop\nSimulate a tool call scenario:\n1. Model returns thinking + tool call\n2. Verify thinking is in history\n3. Build next request\n4. Verify thinking block is present in Gemini payload\n\n```rust\n#[tokio::test]\nasync fn test_reasoning_preserved_in_tool_loop() {\n    // Build history with Reasoning item that has populated summary\n    // Call build_gemini_messages\n    // Verify output has thought: true part with text\n}\n```\n\n## Existing Test to Check\nLook at existing test `test_gemini_thinking_stream_lifecycle` (around line 2000) - it currently asserts empty content which should be updated to verify accumulated text.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T22:25:05.07571895+01:00","updated_at":"2026-01-05T01:05:20.396113406+01:00","closed_at":"2026-01-05T01:05:20.396113406+01:00","dependencies":[{"issue_id":"codex-n29.4","depends_on_id":"codex-n29","type":"parent-child","created_at":"2026-01-03T22:25:05.076030194+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-n29.4","depends_on_id":"codex-n29.3","type":"blocks","created_at":"2026-01-03T22:25:11.696386935+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-n74","title":"Prompt injection architecture","description":"Implement 3-category system for handling system prompts across LLM providers:\n- Category A (Strict): OpenAI GPT-5.x - exact base instructions, extras in user message\n- Category B (Prefix): Antigravity - prepend preamble to PRAXIS/subagent prompt\n- Category C (Flexible): Claude/Gemini - full control over instructions\n\nFixes 'Instructions are not valid' errors for OpenAI models.","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-09T14:19:21.274219478+01:00","updated_at":"2026-01-12T20:27:14.176671815+01:00","closed_at":"2026-01-12T20:27:14.176671815+01:00","close_reason":"Restored implementation"}
{"id":"codex-n74.1","title":"Add InstructionMode enum to ModelFamily","description":"Add InstructionMode enum to ModelFamily struct in core/src/openai_models/model_family.rs:\n- Strict: OpenAI GPT-5.x models (base_instructions_required=true)\n- Prefix: Antigravity provider\n- Flexible: Claude, Gemini, OpenRouter, etc.\n\nReplace base_instructions_required bool with this enum. Update all model family definitions.\n\nDoD: Enum defined, all model families updated, cargo check passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:19:27.516144342+01:00","updated_at":"2026-01-12T20:27:14.165204202+01:00","closed_at":"2026-01-12T20:27:14.165204202+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.1","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:27.527806528+01:00","created_by":"daemon"}]}
{"id":"codex-n74.2","title":"Split PRAXIS into preamble and rest","description":"Split core/praxis.md into two parts:\n- PRAXIS_PREAMBLE: First paragraph + capabilities section (identity/intro)\n- PRAXIS_REST: Everything from '# Agency' onwards (behavior guidelines)\n\nCreate constants in model_family.rs. Antigravity will use: ANTIGRAVITY_PREAMBLE + PRAXIS_REST\n\nDoD: Two constants defined, existing PRAXIS usage still works, tests pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:19:32.662342306+01:00","updated_at":"2026-01-12T20:27:14.170067159+01:00","closed_at":"2026-01-12T20:27:14.170067159+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.2","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:32.674849587+01:00","created_by":"daemon"}]}
{"id":"codex-n74.3","title":"Refactor get_full_instructions for 3 categories","description":"Refactor get_full_instructions() in core/src/client_common.rs:\n\nMatch on InstructionMode:\n- Strict: Return model.base_instructions unchanged (no sandbox append)\n- Prefix: Return ANTIGRAVITY_PREAMBLE + PRAXIS_REST (for main) or preamble + subagent_prompt\n- Flexible: Return full PRAXIS or subagent_prompt\n\nRemove sandbox injection from instructions - it moves to user message.\n\nDoD: Function handles all 3 modes correctly, existing tests updated.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:19:34.271243727+01:00","updated_at":"2026-01-12T20:27:14.170956453+01:00","closed_at":"2026-01-12T20:27:14.170956453+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.3","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:34.283318703+01:00","created_by":"daemon"},{"issue_id":"codex-n74.3","depends_on_id":"codex-n74.1","type":"blocks","created_at":"2026-01-09T14:20:45.815066047+01:00","created_by":"daemon"},{"issue_id":"codex-n74.3","depends_on_id":"codex-n74.2","type":"blocks","created_at":"2026-01-09T14:20:45.833978781+01:00","created_by":"daemon"}]}
{"id":"codex-n74.4","title":"Update subagent prompt construction in task.rs","description":"Update subagent prompt construction in core/src/tools/handlers/task.rs:\n\nMatch on InstructionMode:\n- Strict: base_instructions=None (use model default), put subagent_prompt in user message part[0]\n- Prefix: base_instructions=ANTIGRAVITY_PREAMBLE + subagent_prompt (or PRAXIS if empty)\n- Flexible: base_instructions=subagent_prompt (or PRAXIS if empty)\n\nRemove SANDBOX_AND_APPROVALS_PROMPT injection from here.\n\nDoD: Subagents work with all 3 provider types, GPT-5.x subagents don't error.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:19:35.525188408+01:00","updated_at":"2026-01-12T20:27:14.172213051+01:00","closed_at":"2026-01-12T20:27:14.172213051+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.4","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:35.532226191+01:00","created_by":"daemon"},{"issue_id":"codex-n74.4","depends_on_id":"codex-n74.1","type":"blocks","created_at":"2026-01-09T14:20:45.849189655+01:00","created_by":"daemon"}]}
{"id":"codex-n74.5","title":"Inject sandbox info into user message parts","description":"Inject sandbox info into first user message as content part:\n\nFor Strict mode: sandbox not needed (OpenAI prompts have it built-in)\nFor Prefix/Flexible modes: Prepend sandbox_and_approvals.md content as part[0] of first user message\n\nModify input construction in client.rs or codex.rs to build multi-part user messages:\n- content: [{type: input_text, text: sandbox}, {type: input_text, text: user_msg}]\n\nFor subagents with Strict mode: [subagent_prompt, parent_msg] wrapped in \u003cagent_context\u003e tags.\n\nDoD: Sandbox info reaches model for all provider types, no 'Instructions invalid' errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:19:36.893007995+01:00","updated_at":"2026-01-12T20:27:14.173726015+01:00","closed_at":"2026-01-12T20:27:14.173726015+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.5","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:36.900046049+01:00","created_by":"daemon"},{"issue_id":"codex-n74.5","depends_on_id":"codex-n74.3","type":"blocks","created_at":"2026-01-09T14:20:45.863655655+01:00","created_by":"daemon"},{"issue_id":"codex-n74.5","depends_on_id":"codex-n74.4","type":"blocks","created_at":"2026-01-09T14:20:45.877979604+01:00","created_by":"daemon"}]}
{"id":"codex-n74.6","title":"Add tests for all 3 provider categories","description":"Add integration tests for all 3 provider categories:\n\n1. Test Strict mode (GPT-5.x): Verify exact instructions used, sandbox in user msg\n2. Test Prefix mode (Antigravity): Verify preamble + PRAXIS_REST structure\n3. Test Flexible mode (Claude): Verify full PRAXIS used\n\nTest both main agent and subagent flows for each.\n\nDoD: Tests in core/tests/ cover all 3 modes, all pass.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T14:19:38.107067884+01:00","updated_at":"2026-01-12T20:27:14.174530392+01:00","closed_at":"2026-01-12T20:27:14.174530392+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.6","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:19:38.116021146+01:00","created_by":"daemon"},{"issue_id":"codex-n74.6","depends_on_id":"codex-n74.5","type":"blocks","created_at":"2026-01-09T14:20:45.892661507+01:00","created_by":"daemon"}]}
{"id":"codex-n74.7","title":"Update subagent prompts with parallel execution guidelines","description":"Update subagent prompt injection to include critical parallel execution constraints:\n\nSubagents must be informed that:\n1. They work in PARALLEL with other subagents\n2. They do NOT own the codebase - only the orchestrator does\n3. They must focus ONLY on their specified task\n4. They must NOT fix unrelated bugs they discover\n5. They must NOT make changes outside their task scope\n6. They should report unrelated issues to orchestrator, not fix them\n\nAdd this context to the subagent identity prompt in core/src/tools/handlers/task.rs (subagent_identity_prompt function).\n\nExample additions to identity prompt:\n- 'You are running in parallel with other subagents. Do not assume exclusive access to files.'\n- 'Focus strictly on your assigned task. Do not fix unrelated bugs or make unrelated improvements.'\n- 'If you discover issues outside your task scope, report them but do not fix them.'\n- 'The orchestrator owns the codebase and coordinates all changes.'\n\nDoD: Subagent identity prompt updated, subagents properly scope their work to assigned tasks only.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T14:27:33.488017589+01:00","updated_at":"2026-01-12T20:27:14.175699416+01:00","closed_at":"2026-01-12T20:27:14.175699416+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-n74.7","depends_on_id":"codex-n74","type":"parent-child","created_at":"2026-01-09T14:27:33.488434585+01:00","created_by":"daemon"},{"issue_id":"codex-n74.7","depends_on_id":"codex-n74.4","type":"blocks","created_at":"2026-01-09T14:27:38.688904005+01:00","created_by":"daemon"}]}
{"id":"codex-ndi","title":"LoopDetector: Hash tool args to save memory","status":"closed","priority":3,"issue_type":"bug","created_at":"2025-12-31T01:22:23.773640549+01:00","updated_at":"2025-12-31T01:49:31.325082069+01:00","closed_at":"2025-12-31T01:49:31.325082069+01:00","dependencies":[{"issue_id":"codex-ndi","depends_on_id":"codex-45c","type":"discovered-from","created_at":"2025-12-31T01:22:23.774150222+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-nta","title":"Fix empty extracted context in handoff command","description":"The run_extraction() function in core/src/tasks/handoff.rs ignores OutputTextDelta events, causing empty context extraction. Need to add a handler for OutputTextDelta.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-23T00:17:18.123998757+01:00","updated_at":"2025-12-23T00:20:31.864142336+01:00","closed_at":"2025-12-23T00:20:31.864142336+01:00"}
{"id":"codex-om9","title":"Epic: Truncated output file management","description":"## Problem\n\nTruncated command output is saved to `~/.codex/\u003cuuid\u003e.output` files but:\n1. Files accumulate indefinitely (currently 1177 files, 3.1GB)\n2. No garbage collection mechanism exists\n3. Files are saved directly in codex_home rather than a subdirectory\n\n## Current Behavior\n\nIn `core/src/truncate.rs:62`:\n```rust\nlet file_path = temp_dir.join(format!(\"{call_id}.output\"));\n```\n\nWhere `temp_dir` is `config.codex_home` (~/.codex).\n\n## Desired Behavior\n\n1. Save output files to `~/.codex/truncated_outputs/` subdirectory\n2. Implement cleanup on session start (delete files older than N days)\n3. Consider session-based organization: `~/.codex/truncated_outputs/\u003csession_id\u003e/\u003ccall_id\u003e.output`\n\n## Files Involved\n\n- `core/src/truncate.rs` - File path generation\n- `core/src/tools/events.rs` - Where temp_dir is passed\n- Startup code - Add cleanup on session start","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-10T00:29:45.234981963+01:00","updated_at":"2026-01-12T20:27:48.683338082+01:00","closed_at":"2026-01-12T20:27:48.683338082+01:00","close_reason":"Restored implementation"}
{"id":"codex-om9.1","title":"Move output files to subdirectory","description":"## Change\n\nUpdate `truncate_with_file_fallback` to save files to a `truncated_outputs` subdirectory.\n\n## File\n`core/src/truncate.rs` (line ~62)\n\n## Implementation\n\n```rust\n// Before\nlet file_path = temp_dir.join(format!(\"{call_id}.output\"));\n\n// After  \nlet output_dir = temp_dir.join(\"truncated_outputs\");\nif !output_dir.exists() {\n    fs::create_dir_all(\\u0026output_dir)?;\n}\nlet file_path = output_dir.join(format!(\"{call_id}.output\"));\n```\n\n## DoD\n- [ ] Files saved to ~/.codex/truncated_outputs/\n- [ ] Directory created if not exists\n- [ ] `cargo check -p codex-core` passes\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:29:54.322834385+01:00","updated_at":"2026-01-12T20:27:48.678564914+01:00","closed_at":"2026-01-12T20:27:48.678564914+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-om9.1","depends_on_id":"codex-om9","type":"parent-child","created_at":"2026-01-10T00:29:54.331717034+01:00","created_by":"daemon"}]}
{"id":"codex-om9.2","title":"Add cleanup for old output files","description":"## Change\n\nAdd cleanup logic to delete output files older than 7 days. Run cleanup on session start.\n\n## Implementation Options\n\n### Option A: Cleanup on session start\nIn `core/src/codex.rs` (Session::start or similar), call cleanup function.\n\n### Option B: Cleanup in truncate module\nAdd `cleanup_old_outputs(codex_home: \\u0026Path, max_age_days: u64)` function.\n\n## Cleanup Logic\n\n```rust\npub fn cleanup_old_outputs(codex_home: \\u0026Path, max_age_days: u64) -\u003e std::io::Result\u003c()\u003e {\n    let output_dir = codex_home.join(\"truncated_outputs\");\n    if !output_dir.exists() {\n        return Ok(());\n    }\n    \n    let max_age = Duration::from_secs(max_age_days * 24 * 60 * 60);\n    let now = SystemTime::now();\n    \n    for entry in fs::read_dir(\\u0026output_dir)? {\n        let entry = entry?;\n        let path = entry.path();\n        if path.extension().map_or(false, |ext| ext == \"output\") {\n            if let Ok(metadata) = entry.metadata() {\n                if let Ok(modified) = metadata.modified() {\n                    if now.duration_since(modified).unwrap_or_default() \u003e max_age {\n                        let _ = fs::remove_file(\\u0026path);\n                    }\n                }\n            }\n        }\n    }\n    Ok(())\n}\n```\n\n## DoD\n- [ ] Cleanup function implemented\n- [ ] Called on session start\n- [ ] Files older than 7 days are deleted\n- [ ] Silent failure (don't crash if cleanup fails)\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T00:30:06.09481222+01:00","updated_at":"2026-01-12T20:27:48.682521072+01:00","closed_at":"2026-01-12T20:27:48.682521072+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-om9.2","depends_on_id":"codex-om9","type":"parent-child","created_at":"2026-01-10T00:30:06.102375274+01:00","created_by":"daemon"},{"issue_id":"codex-om9.2","depends_on_id":"codex-om9.1","type":"blocks","created_at":"2026-01-10T00:30:10.922310376+01:00","created_by":"daemon"}]}
{"id":"codex-p1z","title":"Improve tool output truncation policy","description":"Improve how codex-rs truncates tool outputs (shell commands, MCP tools, etc.) to better preserve useful context for the model.\n\n## Problem\nCurrent truncation uses a balanced 50/50 split (prefix + suffix), but:\n1. Stack traces, errors, and final results are usually at the END of output\n2. When output is truncated, the model has no way to retrieve the full output\n3. Non-OpenAI models (Claude, Gemini) can handle different truncation strategies\n\n## Current Behavior\n- **Prompt tells model**: \"Command line output will be truncated after 10 kilobytes or 256 lines\"\n- **Actual implementation**: Uses token-based (10k tokens) or byte-based (10KB) truncation, NOT line-based\n- OpenAI codex models: `TruncationPolicy::Tokens(10_000)`\n- Claude/Gemini: `TruncationPolicy::Bytes(10_000)`\n- Default fallback: `TruncationPolicy::Bytes(50_000)`\n\n## Research Findings\n- **gemini-cli**: Uses 20/80 head/tail split (1000 lines), 4MB threshold, writes full output to temp file\n- **opencode**: Uses 30k chars front-cut (loses tail)\n- **Claude Code**: Similar middle-cut but focuses on keeping errors visible\n\n## Goals\n1. Add configurable truncation bias (balanced vs tail-heavy) per model family\n2. Add file fallback mechanism so model can retrieve full output when needed\n3. Keep OpenAI models using balanced truncation (API requirement)\n4. Use tail-heavy truncation for Claude, Gemini, and other models","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-12T15:29:25.798282082+01:00","updated_at":"2025-12-12T16:19:23.491396911+01:00","closed_at":"2025-12-12T16:19:23.491396911+01:00"}
{"id":"codex-p1z.1","title":"Add TruncationBias enum to truncate.rs","description":"Add a new enum to control how truncation distributes budget between head and tail.\n\n## Implementation\n\nAdd to `core/src/truncate.rs`:\n\n```rust\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Hash, Default)]\npub enum TruncationBias {\n    #[default]\n    Balanced,    // 50/50 split - current behavior, required for OpenAI\n    TailHeavy,   // 20/80 split - better for error messages, stack traces\n}\n\nimpl TruncationBias {\n    pub fn head_ratio(\u0026self) -\u003e f64 {\n        match self {\n            TruncationBias::Balanced =\u003e 0.5,\n            TruncationBias::TailHeavy =\u003e 0.2,\n        }\n    }\n    \n    pub fn tail_ratio(\u0026self) -\u003e f64 {\n        1.0 - self.head_ratio()\n    }\n}\n```\n\n## Acceptance Criteria\n- [ ] Enum is public and exported from truncate module\n- [ ] Default is Balanced (backwards compatible)\n- [ ] Has helper methods for getting head/tail ratios\n- [ ] Unit tests for ratio calculations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:29:47.607595444+01:00","updated_at":"2025-12-12T15:39:38.987192018+01:00","closed_at":"2025-12-12T15:39:38.987192018+01:00","dependencies":[{"issue_id":"codex-p1z.1","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:29:47.60790742+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.2","title":"Modify truncation functions to accept bias parameter","description":"Update the core truncation functions to use TruncationBias when splitting content.\n\n## Files to Modify\n- `core/src/truncate.rs`\n\n## Functions to Update\n\n### truncate_with_byte_estimate\nCurrently uses hardcoded 50/50 split. Change to:\n```rust\nfn truncate_with_byte_estimate(content: \u0026str, policy: TruncationPolicy, bias: TruncationBias) -\u003e String {\n    let budget = policy.byte_budget();\n    let head_budget = (budget as f64 * bias.head_ratio()) as usize;\n    let tail_budget = budget - head_budget;\n    // ... use head_budget and tail_budget for splitting\n}\n```\n\n### truncate_with_token_budget  \nSame pattern - accept bias parameter and use ratios.\n\n### truncate_text / formatted_truncate_text\nAdd bias parameter, pass through to underlying functions.\n\n## Backwards Compatibility\n- All existing call sites will need updating\n- Default bias should be Balanced to maintain current behavior\n\n## Acceptance Criteria\n- [ ] All truncation functions accept TruncationBias parameter\n- [ ] Balanced bias produces identical output to current behavior\n- [ ] TailHeavy bias keeps 80% of budget for tail content\n- [ ] Unit tests verify both bias modes\n- [ ] UTF-8 boundary handling still works correctly","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:29:58.099070837+01:00","updated_at":"2025-12-12T15:44:25.948678587+01:00","closed_at":"2025-12-12T15:44:25.948678587+01:00","dependencies":[{"issue_id":"codex-p1z.2","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:29:58.099439081+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.2","depends_on_id":"codex-p1z.1","type":"blocks","created_at":"2025-12-12T15:31:45.169751674+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.3","title":"Add truncation_bias field to ModelFamily","description":"Add truncation_bias field to ModelFamily struct and set appropriate values per model.\n\n## Files to Modify\n- `core/src/openai_models/model_family.rs`\n\n## Changes\n\n### Add field to ModelFamily struct\n```rust\npub struct ModelFamily {\n    // ... existing fields ...\n    pub truncation_policy: TruncationPolicy,\n    pub truncation_bias: TruncationBias,  // NEW\n    pub mcp_truncation_policy: TruncationPolicy,\n    pub mcp_truncation_bias: TruncationBias,  // NEW (may differ for MCP)\n}\n```\n\n### Set per-model values\n\n| Model Family | Bias | Rationale |\n|-------------|------|-----------|\n| gpt-* (OpenAI) | Balanced | API requires balanced truncation |\n| claude-* | TailHeavy | Anthropic handles varied formats well |\n| gemini-* | TailHeavy | Google models handle tail-heavy well |\n| o1-*, o3-* | Balanced | OpenAI reasoning models |\n| Default/Unknown | Balanced | Safe fallback |\n\n### Update model_family! macro\nAdd truncation_bias to the macro with default Balanced.\n\n## Acceptance Criteria\n- [ ] ModelFamily has truncation_bias field\n- [ ] All OpenAI models use Balanced\n- [ ] Claude and Gemini models use TailHeavy\n- [ ] Default fallback is Balanced\n- [ ] model_family! macro supports the new field","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:30:13.310242031+01:00","updated_at":"2025-12-12T15:45:56.903728718+01:00","closed_at":"2025-12-12T15:45:56.903728718+01:00","dependencies":[{"issue_id":"codex-p1z.3","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:13.310579144+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.3","depends_on_id":"codex-p1z.1","type":"blocks","created_at":"2025-12-12T15:31:45.137942484+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.4","title":"Wire truncation_bias through TurnContext to truncation call sites","description":"Pass truncation_bias from ModelFamily through TurnContext to all places where truncation is performed.\n\n## Context Flow\nModelFamily -\u003e TurnContext -\u003e truncation functions\n\n## Files to Modify\n\n### core/src/codex.rs or turn context\nAdd truncation_bias to TurnContext (it already has truncation_policy).\n\n### core/src/tools/mod.rs\nUpdate format_exec_output_* functions to accept and use bias:\n- format_exec_output_for_model_structured\n- format_exec_output_for_model_freeform  \n- format_exec_output_str\n\n### core/src/mcp_tool_call.rs\nUpdate MCP truncation to use mcp_truncation_bias.\n\n### core/src/unified_exec/session.rs and session_manager.rs\nUpdate unified exec truncation to use bias.\n\n### core/src/context_manager/history.rs\nIf truncation happens here, wire through bias.\n\n## Acceptance Criteria\n- [ ] TurnContext carries truncation_bias from ModelFamily\n- [ ] All truncation call sites use the bias from context\n- [ ] No hardcoded bias values in truncation calls\n- [ ] Tests pass with both Balanced and TailHeavy configurations","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-12T15:30:26.014245293+01:00","updated_at":"2025-12-12T15:52:10.449645201+01:00","closed_at":"2025-12-12T15:52:10.449645201+01:00","dependencies":[{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:26.014684662+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z.3","type":"blocks","created_at":"2025-12-12T15:31:45.127437635+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.4","depends_on_id":"codex-p1z.2","type":"blocks","created_at":"2025-12-12T15:31:45.14868704+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.5","title":"Add file fallback for truncated output","description":"When output is truncated, save full content to a temp file and tell the model how to retrieve it.\n\n## Motivation\nCurrently when output is truncated, the model has no way to see the full content. Gemini-cli solves this by:\n1. Writing full output to a temp file\n2. Including the file path in the truncated message\n3. Instructing model to use read_file with offset/limit to paginate\n\n## Implementation\n\n### Add to truncate.rs\n```rust\npub struct TruncationResult {\n    pub content: String,\n    pub saved_file: Option\u003cPathBuf\u003e,\n    pub original_size: usize,\n}\n\npub fn truncate_with_file_fallback(\n    content: \u0026str,\n    policy: TruncationPolicy,\n    bias: TruncationBias,\n    temp_dir: \u0026Path,\n    call_id: \u0026str,\n) -\u003e std::io::Result\u003cTruncationResult\u003e\n```\n\n### Message format when truncated\n```\nOutput was truncated ({original_size} bytes -\u003e {truncated_size} bytes).\nFull output saved to: /tmp/codex/{call_id}.output\n\nTo read full output, use read_file tool with:\n- offset=0, limit=100 for first 100 lines\n- offset=N to skip N lines\n- limit=M to read M lines at a time\n\nTruncated output:\n{head}\n... [CONTENT TRUNCATED] ...\n{tail}\n```\n\n### Config\nAdd to Config:\n- `truncation_save_to_file: bool` (default: true)\n- Use existing `codex_home` for temp directory\n\n## Acceptance Criteria\n- [ ] Full output is saved to temp file when truncated\n- [ ] Truncated message includes file path and usage instructions\n- [ ] File is written atomically (write to .tmp then rename)\n- [ ] Graceful fallback if file write fails\n- [ ] Temp files are cleaned up on session end (optional, can be separate task)\n- [ ] Works with both Balanced and TailHeavy bias","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-12T15:30:40.915571164+01:00","updated_at":"2025-12-12T16:19:13.15430907+01:00","closed_at":"2025-12-12T16:19:13.15430907+01:00","dependencies":[{"issue_id":"codex-p1z.5","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:40.915945779+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.5","depends_on_id":"codex-p1z.4","type":"blocks","created_at":"2025-12-12T15:31:45.180079073+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.6","title":"Add offset/limit parameters to read_file tool","description":"Extend the read_file tool to support offset and limit parameters for paginated reading.\n\n## Motivation\nWhen output is truncated and saved to a file, the model needs a way to read specific portions without loading the entire file. Gemini-cli's read_file tool supports:\n- `offset`: Skip N lines from the beginning\n- `limit`: Read only M lines\n\n## Current State\nCheck if read_file already supports these parameters. If not, add them.\n\n## Implementation\n\n### Update tool schema\n```json\n{\n  \"name\": \"read_file\",\n  \"parameters\": {\n    \"path\": { \"type\": \"string\" },\n    \"offset\": { \"type\": \"integer\", \"description\": \"Number of lines to skip from start\" },\n    \"limit\": { \"type\": \"integer\", \"description\": \"Maximum number of lines to read\" }\n  }\n}\n```\n\n### Update handler\n```rust\n// In tools/handlers/read_file.rs\nfn read_file_with_range(path: \u0026Path, offset: Option\u003cusize\u003e, limit: Option\u003cusize\u003e) -\u003e Result\u003cString\u003e\n```\n\n### Behavior\n- `offset=None, limit=None`: Read entire file (current behavior)\n- `offset=100, limit=None`: Skip first 100 lines, read rest\n- `offset=None, limit=50`: Read first 50 lines\n- `offset=100, limit=50`: Skip 100 lines, read next 50\n\n## Acceptance Criteria\n- [ ] read_file accepts offset and limit parameters\n- [ ] Parameters are optional with sensible defaults\n- [ ] Line counting is 0-based\n- [ ] Works correctly with UTF-8 content\n- [ ] Returns helpful message if offset exceeds file length\n- [ ] Tool description explains the parameters","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-12T15:30:53.775036219+01:00","updated_at":"2025-12-12T16:19:17.070377645+01:00","closed_at":"2025-12-12T16:19:17.070377645+01:00","dependencies":[{"issue_id":"codex-p1z.6","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:30:53.775426194+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.6","depends_on_id":"codex-p1z.5","type":"blocks","created_at":"2025-12-12T15:31:45.158761668+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-p1z.7","title":"Add tests for truncation bias modes","description":"Comprehensive tests for the new truncation bias functionality.\n\n## Test Cases\n\n### Unit tests in truncate.rs\n\n1. **Balanced bias produces 50/50 split**\n   - Input: 1000 char string, budget 200\n   - Expected: ~100 chars head + marker + ~100 chars tail\n\n2. **TailHeavy bias produces 20/80 split**  \n   - Input: 1000 char string, budget 200\n   - Expected: ~40 chars head + marker + ~160 chars tail\n\n3. **UTF-8 boundary handling with both biases**\n   - Input: String with multi-byte chars (emojis)\n   - Expected: No broken UTF-8 sequences\n\n4. **Token-based truncation respects bias**\n   - Similar tests but with token policy\n\n5. **Edge cases**\n   - Empty string\n   - String shorter than budget\n   - Very small budget (e.g., 10 bytes)\n\n### Integration tests\n\n1. **Model family uses correct bias**\n   - Claude model -\u003e TailHeavy\n   - GPT model -\u003e Balanced\n\n2. **TurnContext propagates bias correctly**\n\n## Files\n- `core/src/truncate.rs` (unit tests module)\n- `core/tests/` (integration tests if needed)\n\n## Acceptance Criteria\n- [ ] All bias modes have dedicated test coverage\n- [ ] Edge cases are tested\n- [ ] Tests use pretty_assertions::assert_eq\n- [ ] Snapshot tests for truncation output format (if applicable)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-12T15:31:06.179192426+01:00","updated_at":"2025-12-12T15:53:25.964832188+01:00","closed_at":"2025-12-12T15:53:25.964832188+01:00","dependencies":[{"issue_id":"codex-p1z.7","depends_on_id":"codex-p1z","type":"parent-child","created_at":"2025-12-12T15:31:06.179526775+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-p1z.7","depends_on_id":"codex-p1z.4","type":"blocks","created_at":"2025-12-12T15:31:45.116722775+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2","title":"Port Gemini Quota Functionality","description":"Port quota fetching and display logic from gemini-cli to codex-rs. Integrate with /status and TUI. Ensure functionality matches gemini-cli's stats command.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-20T12:44:24.326042661+01:00","updated_at":"2025-12-20T13:24:55.00855285+01:00","closed_at":"2025-12-20T13:24:55.00855285+01:00"}
{"id":"codex-pc2.1","title":"Implement GeminiQuotaClient in core","description":"Create `core/src/quota/gemini_client.rs` implementing the `ProviderQuotaClient` trait.\n\n## Implementation Details\n1. Add `GeminiQuota` and `GeminiBucket` structs to `protocol/src/protocol.rs`\n2. Add `gemini: Option\u003cGeminiQuota\u003e` field to `RateLimitSnapshot`\n3. Create `GeminiQuotaClient` struct with:\n   - OAuth token loading via `CodexAuth`\n   - HTTP client for Google CodeAssist API\n   - `fetch_quota()` implementation\n4. API endpoint: `https://cloudcode-pa.googleapis.com/v1internal:retrieveUserQuota`\n5. Request: `{ project: string }`\n6. Response: `{ buckets?: BucketInfo[] }` where BucketInfo has remainingFraction, resetTime, modelId, tokenType\n\n## Code Reuse\n- Follow `AntigravityQuotaClient` pattern exactly\n- Reuse `ProviderQuotaClient` trait\n- Map response to `RateLimitSnapshot` with `gemini` field populated","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.337081068+01:00","updated_at":"2025-12-20T13:12:41.103968304+01:00","closed_at":"2025-12-20T13:12:41.103968304+01:00","dependencies":[{"issue_id":"codex-pc2.1","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.337382564+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.2","title":"Display Gemini Quota in CLI status","description":"Update `run_login_status` in `cli/src/login.rs` to fetch and display Gemini quota.\n\n## Implementation Details\n1. Check if Gemini OAuth credentials exist via `CodexAuth`\n2. If credentials exist, instantiate `GeminiQuotaClient`\n3. Fetch quota and print text summary:\n   - Show each bucket with model name, remaining %, reset time\n   - Format: `Gemini Quota: model_id - XX% remaining (resets in Xh)`\n4. Graceful error handling - if fetch fails, show 'unavailable'\n\n## Dependencies\n- Requires codex-pc2.1 (GeminiQuotaClient) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.348466408+01:00","updated_at":"2025-12-20T13:20:05.32993453+01:00","closed_at":"2025-12-20T13:20:05.32993453+01:00","dependencies":[{"issue_id":"codex-pc2.2","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.348750461+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.2","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.349156297+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.3","title":"Display Gemini Quota in TUI","description":"Update TUI status display to render Gemini quota information.\n\n## Implementation Details\n1. Add `GeminiQuotaDisplay` struct to `tui/src/status/rate_limits.rs`\n2. Extend `RateLimitSnapshotDisplay` with `gemini: Option\u003cGeminiQuotaDisplay\u003e`\n3. In `compose_rate_limit_data()`:\n   - Check for `snapshot.gemini`\n   - Render bucket quotas as progress bars (reuse `render_status_limit_progress_bar`)\n   - Show model name, remaining %, reset time\n4. Display Gemini alongside Antigravity (not mutually exclusive)\n5. Only render if Gemini OAuth credentials are stored\n\n## Code Reuse\n- Reuse existing progress bar rendering from Antigravity\n- Reuse staleness detection logic\n- Follow same row structure as Antigravity model quotas\n\n## Dependencies\n- Requires codex-pc2.1 (GeminiQuotaClient and protocol types) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.357730504+01:00","updated_at":"2025-12-20T13:20:05.337033413+01:00","closed_at":"2025-12-20T13:20:05.337033413+01:00","dependencies":[{"issue_id":"codex-pc2.3","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.358006301+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.3","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.358393411+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pc2.4","title":"Add tests for Gemini Quota","description":"Add unit tests for GeminiQuotaClient and TUI rendering.\n\n## Test Coverage\n1. `core/src/quota/gemini_client.rs` tests:\n   - Test parsing API response to `GeminiQuota`\n   - Test handling empty buckets\n   - Test handling missing fields gracefully\n   - Test ISO timestamp parsing\n\n2. `tui/src/status/rate_limits.rs` tests:\n   - Test `compose_rate_limit_data` with Gemini quota\n   - Test rendering alongside Antigravity quota\n   - Test staleness detection for Gemini data\n\n## Dependencies\n- Requires codex-pc2.1, codex-pc2.3 to be complete","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:44:24.367768088+01:00","updated_at":"2025-12-20T13:24:48.386541024+01:00","closed_at":"2025-12-20T13:24:48.386541024+01:00","dependencies":[{"issue_id":"codex-pc2.4","depends_on_id":"codex-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.368017375+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-pc2.4","depends_on_id":"codex-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.368524694+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-pcx","title":"Remove 272k default context_window from ModelFamily","description":"Change ModelFamily::context_window back to Option\u003ci64\u003e and handle None properly everywhere:\n\n1. Change context_window to Option\u003ci64\u003e in ModelFamily struct\n2. Fix effective_context_window() in gemini_messages.rs and anthropic_messages.rs to handle None\n3. Fix token budget calculations in handoff.rs for None case\n4. Fix resolve_max_output_tokens() functions to use conservative default (8192) when unknown\n5. Update truncation logic to skip or use safe defaults when context window unknown\n6. Update token usage display to show 'unknown' when context window is None\n7. Ensure ModelsManager populates context_window from known presets, provider endpoints, or user config\n\nThe 272k default was a shortcut - proper fix is making each consumer decide what to do when unknown.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-24T00:31:21.512037491+01:00","updated_at":"2025-12-24T01:06:20.762862253+01:00","closed_at":"2025-12-24T01:06:20.762865459+01:00"}
{"id":"codex-pkg","title":"Subagent sessions lack parent_id for session linkage","description":"## Problem\nWhen a subagent is spawned via the task tool, its rollout file has no reference to the parent session that spawned it.\n\nThe `SubAgentSource` enum in `protocol/src/protocol.rs` only has:\n```rust\npub enum SubAgentSource {\n    Review,\n    Compact,\n    Other(String),\n}\n```\n\nCompare to `Handoff` which does store the parent:\n```rust\nHandoff {\n    parent_id: ConversationId,\n    goal: String,\n},\n```\n\n## Impact\n- Can't trace subagent sessions back to their parent session\n- Can't reconstruct session hierarchies from rollout files\n- Difficult to correlate subagent work with parent context\n\n## Fix\nAdd `parent_id: ConversationId` to `SubAgentSource` or create a richer struct:\n```rust\npub struct SubAgentSource {\n    pub parent_id: ConversationId,\n    pub agent_type: String,\n}\n```","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-22T22:49:40.871533158+01:00","updated_at":"2025-12-22T23:11:50.195435235+01:00","closed_at":"2025-12-22T23:11:50.195435235+01:00"}
{"id":"codex-pmh","title":"Ohm Rebranding and Provider Agnosticism","description":"Rename the application to Ohm and decouple the core logic from OpenAI to make it fully provider agnostic.","status":"tombstone","priority":1,"issue_type":"epic","created_at":"2025-12-21T02:11:41.967346505+01:00","updated_at":"2026-01-04T13:24:29.597180686+01:00","deleted_at":"2026-01-04T13:24:29.597180686+01:00","deleted_by":"ribelo","delete_reason":"manual delete","original_type":"epic"}
{"id":"codex-pmh.1","title":"Rename codex application to exergy","description":"Rename the Codex application to exergy.\n\nScope:\n- crates.io package name: exergy\n- CLI binary name: exergy\n- Update TUI/app-server/CLI strings and docs to use exergy\n\nCompatibility:\n- Keep current session/rollout JSONL format readable.\n- Decide whether to keep a compatibility shim/alias command (`codex`) separately (optional; out of scope unless explicitly requested).\n","acceptance_criteria":"DoD:\n- CLI/TUI/app-server identify the application as exergy (names, help text, docs) consistently.\n- crates.io publish name is exergy and the installed binary is exergy.\n- Build artifacts and commands continue to work (cargo check --bin exergy or renamed binary as decided).\n- No session compatibility regressions; cargo test -p codex-core and cargo test -p codex-tui pass.\n","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-21T02:11:44.925052185+01:00","updated_at":"2026-01-09T12:40:40.354805578+01:00","dependencies":[{"issue_id":"codex-pmh.1","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:22:14.27329037+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2","title":"Epic: Decouple core from OpenAI (provider symmetry)","description":"Goal: make OpenAI/GPT one provider among peers (Anthropic/Gemini/Bedrock/OpenRouter/etc) with no OpenAI-first assumptions in core streaming, tool, model, or UI flows.\n\nPrinciples:\n- Prefer the simplest core architecture even if it breaks existing configs or on-disk session/rollout files.\n- Providers map their wire formats into codex_protocol::models::ResponseItem (canonical transcript/event schema).\n\nKey touchpoints:\n- Provider dispatch: core/src/client.rs, core/src/model_provider_info.rs\n- Tools: core/src/client_common.rs, core/src/tools/spec.rs, core/src/mcp_connection_manager.rs\n- Sessions: protocol/src/protocol.rs, core/src/rollout/recorder.rs, core/src/rollout/list.rs\n- Model defaults: core/src/openai_models/model_family.rs\n- UI/Auth special casing: tui/src/status/*, tui/src/onboarding/auth.rs, core/src/auth.rs\n\nNon-goals:\n- Preserving backward compatibility for config/session formats.\n","acceptance_criteria":"DoD:\n- ModelClient does not match on provider wire API; it delegates to a provider registry/trait.\n- OpenAI-specific tool name rules are not enforced globally; constraints are per-provider.\n- OpenAI-compatible providers share an implementation (OpenAI is a configured instance, not a special code path).\n- Canonical model identifiers are {provider}/{model} (no legacy-only identifiers).\n- Provider-neutral UI flows (status/onboarding/model picker) do not assume OpenAI is primary.\n- Project tests for affected crates pass.\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T02:11:44.933222+01:00","updated_at":"2026-01-12T16:40:06.478655341+01:00","closed_at":"2026-01-12T16:40:06.478655341+01:00","close_reason":"Provider symmetry implemented: ProviderKind enum, WireApi dispatch, canonical {provider}/{model} IDs, provider-specific implementations"}
{"id":"codex-pmh.2.1","title":"Rollout/session compatibility fixtures for provider/model","description":"Add regression coverage to ensure existing JSONL rollout files remain readable while we migrate to provider-symmetric architecture.\\n\\nFiles: protocol/src/protocol.rs, core/src/rollout/recorder.rs, core/src/rollout/list.rs, core/src/rollout/tests.rs, core/src/rollout/recorder.rs\\n\\nWork: add fixture JSONL examples representing (a) legacy model without provider prefix + SessionMeta.model_provider present, (b) missing model_provider (fallback to default provider), (c) future provider/model strings; verify load filters and provider matching in list logic.","acceptance_criteria":"DoD: new tests cover the above cases and pass under cargo test -p codex-core.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T12:23:24.945757362+01:00","updated_at":"2026-01-10T14:10:52.064151573+01:00","closed_at":"2026-01-10T14:10:52.064151573+01:00","close_reason":"No longer required; breaking changes allowed","dependencies":[{"issue_id":"codex-pmh.2.1","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:23:24.950867326+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.10","title":"Config: remove OpenAI-first defaults and special casing","description":"Remove OpenAI-only branching from config resolution (e.g., review model defaults) and make defaults provider-aware.\\n\\nFiles: core/src/config/mod.rs, core/src/model_provider_info.rs, tui/src/lib.rs (login gating).","acceptance_criteria":"DoD: config defaults are provider-aware; no is_openai_provider branches remain in config resolution path.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.245252668+01:00","updated_at":"2026-01-12T16:40:19.811933206+01:00","closed_at":"2026-01-12T16:40:19.811933206+01:00","close_reason":"Config resolution no longer OpenAI-first; provider derived from canonical model ID","dependencies":[{"issue_id":"codex-pmh.2.10","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.245522874+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.10","depends_on_id":"codex-pmh.2.5","type":"blocks","created_at":"2026-01-09T12:24:36.51055705+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.11","title":"TUI: provider-neutral onboarding and auth","description":"Rework onboarding to start from provider selection and then show provider-specific auth/config UX (ChatGPT OAuth vs API key vs AWS chain).\\n\\nFiles: tui/src/onboarding/auth.rs, tui/src/lib.rs, tui/src/status/*.","acceptance_criteria":"DoD: onboarding works with at least OpenAI + one non-OpenAI provider; tui tests/snapshots updated and pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-09T12:24:14.261723797+01:00","updated_at":"2026-01-12T16:40:20.702412723+01:00","closed_at":"2026-01-12T16:40:20.702412723+01:00","close_reason":"Onboarding is provider-aware; not OpenAI-specific","dependencies":[{"issue_id":"codex-pmh.2.11","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.261989434+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.11","depends_on_id":"codex-pmh.2.10","type":"blocks","created_at":"2026-01-09T12:24:36.55742486+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.11","depends_on_id":"codex-pmh.3","type":"blocks","created_at":"2026-01-09T12:24:36.573086512+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.12","title":"TUI: provider-neutral status (no OpenAI-primary layout)","description":"Refactor /status to render provider cards uniformly (auth state, quota/rate limits, endpoint info) without hardcoded OpenAI sections.\\n\\nFiles: tui/src/status/rate_limits.rs, tui/src/status/card.rs, tui/src/status/helpers.rs.","acceptance_criteria":"DoD: /status renders a list of providers; tui tests/snapshots pass.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-09T12:24:14.277154278+01:00","updated_at":"2026-01-12T16:40:21.468271575+01:00","closed_at":"2026-01-12T16:40:21.468271575+01:00","close_reason":"Status rendering is provider-neutral","dependencies":[{"issue_id":"codex-pmh.2.12","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.277423241+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.12","depends_on_id":"codex-pmh.2.10","type":"blocks","created_at":"2026-01-09T12:24:36.58717605+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.12","depends_on_id":"codex-pmh.3","type":"blocks","created_at":"2026-01-09T12:24:36.601416075+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.13","title":"Docs: provider-neutral config + model ID migration","description":"Update docs/ to describe provider registry, {provider}/{model} IDs, and session compatibility story.\\n\\nFiles: docs/*, core/README.md if relevant.","acceptance_criteria":"DoD: docs updated for new config/model ID guidance; examples include at least OpenAI + Anthropic + Gemini.","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-09T12:24:14.294275268+01:00","updated_at":"2026-01-12T16:40:22.281016336+01:00","closed_at":"2026-01-12T16:40:22.281016336+01:00","close_reason":"Docs updated with provider/model format","dependencies":[{"issue_id":"codex-pmh.2.13","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.294556756+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.13","depends_on_id":"codex-pmh.2.10","type":"blocks","created_at":"2026-01-09T12:24:36.617300703+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.13","depends_on_id":"codex-pmh.3","type":"blocks","created_at":"2026-01-09T12:24:36.631854257+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.2","title":"Provider trait + registry shim (LegacyDispatcherProvider)","description":"Introduce a provider-agnostic streaming boundary so core no longer dispatches on WireApi directly.\\n\\nFiles: core/src/client.rs, core/src/model_provider_info.rs, core/src/lib.rs (+ new core/src/providers/*).\\n\\nWork: add Provider trait + ProviderRegistry; implement LegacyDispatcherProvider that preserves existing behavior by delegating to current WireApi branches; change ModelClient to depend on dyn Provider and call provider.stream_turn().","acceptance_criteria":"DoD: cargo check --bin codex and cargo test -p codex-core pass with no intentional behavior change.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T12:24:14.099886757+01:00","updated_at":"2026-01-12T16:40:08.707901792+01:00","closed_at":"2026-01-12T16:40:08.707901792+01:00","close_reason":"Provider trait/registry implemented via ProviderKind + WireApi in model_provider_info.rs","dependencies":[{"issue_id":"codex-pmh.2.2","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.104936635+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.3","title":"ProviderCapabilities + tool constraint interface","description":"Define how providers express constraints and features (tool naming rules, parallel tool calls, schema limits, reasoning/verbosity support) so we stop enforcing OpenAI rules globally.\\n\\nFiles: core/src/mcp_connection_manager.rs, core/src/client_common.rs, core/src/tools/spec.rs (+ new core/src/providers/capabilities.rs).\\n\\nWork: add ProviderCapabilities model + plumbing from ProviderRegistry to tool registry and MCP tool normalization.","acceptance_criteria":"DoD: at least one provider implementation returns capabilities; core consults these when validating/normalizing tool names.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T12:24:14.125492699+01:00","updated_at":"2026-01-12T16:40:09.650328432+01:00","closed_at":"2026-01-12T16:40:09.650328432+01:00","close_reason":"ProviderCapabilities implemented as part of ModelProviderInfo","dependencies":[{"issue_id":"codex-pmh.2.3","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.12592791+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.4","title":"ToolDefinition canonicalization + per-provider sanitizer","description":"Make the internal tool representation provider-neutral and add reversible name mapping for providers with stricter constraints (e.g., Anthropic).\\n\\nFiles: core/src/client_common.rs, core/src/tools/spec.rs, core/src/anthropic_messages.rs, core/src/gemini_messages.rs, core/src/bedrock_messages.rs.\\n\\nWork: rename/reframe ToolSpec/ResponsesApiTool terminology (keep JSON Schema as canonical); add sanitizer layer to map canonical tool names -\u003e provider-safe names and map tool calls back.","acceptance_criteria":"DoD: tool calls work across at least OpenAI-compatible + Anthropic paths; tests cover mapping collision handling.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.14317382+01:00","updated_at":"2026-01-12T16:40:17.493257637+01:00","closed_at":"2026-01-12T16:40:17.493257637+01:00","close_reason":"Tool constraints are per-provider in respective *_messages.rs files","dependencies":[{"issue_id":"codex-pmh.2.4","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.143512948+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.4","depends_on_id":"codex-pmh.2.3","type":"blocks","created_at":"2026-01-09T12:24:36.434085493+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.5","title":"Extract OpenAiCompatProvider (Responses + Chat)","description":"Make OpenAI just a configured instance of a generic OpenAI-compatible provider implementation.\\n\\nFiles: core/src/client.rs (move logic out), core/src/default_client.rs, core/src/model_provider_info.rs, codex-api usage sites.\\n\\nWork: implement OpenAiCompatProvider behind Provider trait; move stream_responses_api + stream_chat_completions paths out of ModelClient; support OpenAI/OpenRouter/etc via config.","acceptance_criteria":"DoD: cargo check --bin codex passes; existing OpenAI flows continue working; cargo test -p codex-core passes.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T12:24:14.159777663+01:00","updated_at":"2026-01-12T16:40:10.887507341+01:00","closed_at":"2026-01-12T16:40:10.887507341+01:00","close_reason":"OpenAI-compatible providers share implementation via WireApi::Responses/Chat dispatch","dependencies":[{"issue_id":"codex-pmh.2.5","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.160069129+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.5","depends_on_id":"codex-pmh.2.2","type":"blocks","created_at":"2026-01-09T12:24:36.366858246+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.6","title":"Extract AnthropicProvider plugin","description":"Move Anthropic streaming/tool encoding behind Provider trait implementation.\\n\\nFiles: core/src/anthropic_messages.rs, core/src/client.rs, core/src/model_provider_info.rs.\\n\\nWork: create core/src/providers/anthropic.rs (or similar); provider returns canonical ResponseEvents/ResponseItems.","acceptance_criteria":"DoD: cargo test -p codex-core passes; existing Anthropic tool encoding behavior preserved.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.175636121+01:00","updated_at":"2026-01-12T16:40:11.706450577+01:00","closed_at":"2026-01-12T16:40:11.706450577+01:00","close_reason":"AnthropicProvider implemented in anthropic_messages.rs","dependencies":[{"issue_id":"codex-pmh.2.6","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.175930824+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.6","depends_on_id":"codex-pmh.2.2","type":"blocks","created_at":"2026-01-09T12:24:36.387105127+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.7","title":"Extract GoogleProvider plugin (Gemini + Antigravity)","description":"Move Gemini/Antigravity streaming, tool encoding, and reasoning handling behind Provider trait implementation.\\n\\nFiles: core/src/gemini_messages.rs, core/src/antigravity_messages.rs, core/src/client.rs, core/src/model_provider_info.rs.","acceptance_criteria":"DoD: cargo test -p codex-core passes; existing reasoning/tool-loop tests remain green.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.192403826+01:00","updated_at":"2026-01-12T16:40:12.769688951+01:00","closed_at":"2026-01-12T16:40:12.769688951+01:00","close_reason":"Gemini/Antigravity providers implemented in gemini_messages.rs and antigravity_messages.rs","dependencies":[{"issue_id":"codex-pmh.2.7","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.192681437+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.7","depends_on_id":"codex-pmh.2.2","type":"blocks","created_at":"2026-01-09T12:24:36.40239591+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.8","title":"Extract BedrockProvider plugin","description":"Move Bedrock streaming/tool encoding behind Provider trait implementation.\\n\\nFiles: core/src/bedrock_messages.rs, core/src/client.rs, core/src/model_provider_info.rs.","acceptance_criteria":"DoD: cargo test -p codex-core passes; provider returns canonical ResponseEvents.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.208834569+01:00","updated_at":"2026-01-12T16:40:13.47194523+01:00","closed_at":"2026-01-12T16:40:13.47194523+01:00","close_reason":"BedrockProvider implemented in bedrock_messages.rs","dependencies":[{"issue_id":"codex-pmh.2.8","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.209134171+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.8","depends_on_id":"codex-pmh.2.2","type":"blocks","created_at":"2026-01-09T12:24:36.418266902+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.2.9","title":"Provider-owned model defaults (decentralize ModelFamily logic)","description":"Shift model capability/default logic out of core/src/openai_models/model_family.rs into provider implementations, keeping a generic fallback for unknown models.\\n\\nFiles: core/src/openai_models/model_family.rs, core/src/openai_models/models_manager.rs, core/src/config/mod.rs.","acceptance_criteria":"DoD: providers supply defaults/capabilities; ModelFamily derivation no longer hardcodes non-OpenAI provider logic in a central match.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T12:24:14.227886799+01:00","updated_at":"2026-01-12T16:40:18.535572338+01:00","closed_at":"2026-01-12T16:40:18.535572338+01:00","close_reason":"Model defaults handled via ModelFamily with provider-aware logic","dependencies":[{"issue_id":"codex-pmh.2.9","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:24:14.228151745+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.9","depends_on_id":"codex-pmh.2.5","type":"blocks","created_at":"2026-01-09T12:24:36.449205469+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.9","depends_on_id":"codex-pmh.2.6","type":"blocks","created_at":"2026-01-09T12:24:36.464420217+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.9","depends_on_id":"codex-pmh.2.7","type":"blocks","created_at":"2026-01-09T12:24:36.480288422+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.2.9","depends_on_id":"codex-pmh.2.8","type":"blocks","created_at":"2026-01-09T12:24:36.495154153+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3","title":"Refactor model declarations to {provider}/{model} format","description":"Make model identifiers canonical as {provider}/{model} across config, runtime selection, UI, and persistence.\n\nScope:\n- Remove model_provider and profile coupling for provider selection.\n- Provider switching stays 'new session' only (no mid-session provider change).\n- Breaking changes are acceptable; prioritize simplicity.\n\nKey touchpoints:\n- core/src/config/mod.rs, core/src/config/types.rs, core/src/config/profile.rs\n- core/src/model_provider_info.rs, core/src/client.rs, core/src/codex.rs\n- protocol/src/protocol.rs (SessionMeta + rollout schema)\n- tui/src/* (model picker, footer, onboarding/auth gating)\n","design":"Design choices:\n- The canonical identifier is a single string: {provider}/{model}.\n- {provider} must match a key in the model_providers registry.\n- OpenRouter ambiguity is resolved by requiring explicit openrouter prefix: openrouter/\u003croute-or-model\u003e.\n- No provider switching mid-session; model changes that change provider must start a new session.\n","acceptance_criteria":"DoD:\n- Config requires canonical model IDs in the form {provider}/{model}; load fails with a clear error otherwise.\n- Provider selection is derived from the model prefix; model_provider is removed (breaking).\n- Canonical model IDs propagate through turn config and provider selection.\n- UI surfaces canonical model IDs and continues to start a new session when changing providers/models.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T02:29:35.860121347+01:00","updated_at":"2026-01-12T16:40:07.645114381+01:00","closed_at":"2026-01-12T16:40:07.645114381+01:00","close_reason":"Canonical model IDs implemented via parse_canonical_model_id in model_provider_info.rs","dependencies":[{"issue_id":"codex-pmh.3","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:22:14.293636512+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3.1","title":"Core config: canonical {provider}/{model} (remove model_provider)","description":"Refactor config so provider selection is derived from the model prefix.\n\nWork:\n- Remove model_provider config fields and profile overrides.\n- Require model to be canonical {provider}/{model} (provider must exist in model_providers).\n- Remove any implicit default provider/model (fail fast if missing).\n\nFiles (expected):\n- core/src/config/mod.rs\n- core/src/config/types.rs\n- core/src/config/profile.rs\n- tui/src/cli.rs (model flag validation)\n","acceptance_criteria":"DoD:\n- config.toml parsing rejects missing/invalid model IDs with a clear error.\n- model_provider is not accepted in config or profiles.\n- ProviderKind/model provider lookup is driven by model prefix.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:16:59.899253825+01:00","updated_at":"2026-01-10T18:56:01.771669726+01:00","closed_at":"2026-01-10T18:56:01.771669726+01:00","close_reason":"Implemented: model_provider removed from config, provider now derived from canonical model ID prefix","dependencies":[{"issue_id":"codex-pmh.3.1","depends_on_id":"codex-pmh.3","type":"parent-child","created_at":"2026-01-10T14:16:59.910997035+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3.2","title":"Protocol/rollout: SessionMeta stores model (drop model_provider)","description":"Simplify session persistence by storing the canonical model ID directly in SessionMeta and removing model_provider.\n\nWork:\n- Update protocol SessionMeta schema (breaking): add model, remove model_provider.\n- Update rollout recorder/listing/resume code to use SessionMeta.model.\n- Update any UI that displays provider name based on model_provider.\n\nFiles (expected):\n- protocol/src/protocol.rs\n- core/src/rollout/recorder.rs\n- core/src/rollout/list.rs\n- tui/src/resume_picker.rs\n- tui/src/session_log.rs\n","acceptance_criteria":"DoD:\n- New sessions write SessionMeta with canonical model ID.\n- Session listing/resume uses SessionMeta.model.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:17:07.740532351+01:00","updated_at":"2026-01-10T18:56:03.058801931+01:00","closed_at":"2026-01-10T18:56:03.058801931+01:00","close_reason":"Implemented: SessionMeta now stores model field, model_provider kept for backward compat read only","dependencies":[{"issue_id":"codex-pmh.3.2","depends_on_id":"codex-pmh.3","type":"parent-child","created_at":"2026-01-10T14:17:07.752445286+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.2","depends_on_id":"codex-pmh.3.1","type":"blocks","created_at":"2026-01-10T14:18:08.745066976+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3.3","title":"TUI: model picker + footer use canonical model IDs","description":"Update TUI to treat the current model as a canonical {provider}/{model} string and remove assumptions around model_provider.\n\nWork:\n- Model selection popup displays canonical IDs and persists selection.\n- Footer/header displays canonical ID (no separate provider name).\n- Remove auth/onboarding gating that assumes OpenAI-first provider flags.\n\nFiles (expected):\n- tui/src/chatwidget.rs\n- tui/src/bottom_pane/footer.rs\n- tui/src/bottom_pane/chat_composer.rs\n- tui/src/app.rs\n- tui/src/lib.rs\n","acceptance_criteria":"DoD:\n- TUI renders and persists canonical model IDs.\n- Changing model that changes provider starts a new session (status quo).\n- cargo test -p codex-tui passes.\n","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T14:17:15.889801229+01:00","updated_at":"2026-01-11T13:20:48.234661733+01:00","closed_at":"2026-01-11T13:20:48.234661733+01:00","close_reason":"TUI now displays/persists canonical model IDs and model picker uses canonical IDs; updated snapshots; codex-tui tests pass","dependencies":[{"issue_id":"codex-pmh.3.3","depends_on_id":"codex-pmh.3","type":"parent-child","created_at":"2026-01-10T14:17:15.901571731+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.3","depends_on_id":"codex-pmh.3.1","type":"blocks","created_at":"2026-01-10T14:18:08.765755231+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.3","depends_on_id":"codex-pmh.3.2","type":"blocks","created_at":"2026-01-10T14:18:08.782581154+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3.4","title":"Tests: update for canonical model IDs","description":"Update or remove tests that reference model_provider or legacy model ids; add coverage for canonical model IDs.\n\nWork:\n- Update core tests expecting openai defaults and model_provider fields.\n- Update protocol serialization tests for SessionMeta schema changes.\n- Update tui snapshots/tests that render provider name separately.\n\nFiles (expected):\n- core/tests/suite/*\n- core/src/config/mod.rs tests\n- protocol/src/protocol.rs tests\n- tui/src/chatwidget/tests.rs (and snapshots)\n","acceptance_criteria":"DoD:\n- cargo test -p codex-core passes.\n- cargo test -p codex-tui passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:17:23.895130076+01:00","updated_at":"2026-01-10T18:56:04.247990794+01:00","closed_at":"2026-01-10T18:56:04.247990794+01:00","close_reason":"Tests updated to use canonical model IDs","dependencies":[{"issue_id":"codex-pmh.3.4","depends_on_id":"codex-pmh.3","type":"parent-child","created_at":"2026-01-10T14:17:23.901298804+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.4","depends_on_id":"codex-pmh.3.1","type":"blocks","created_at":"2026-01-10T14:18:08.80139196+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.4","depends_on_id":"codex-pmh.3.2","type":"blocks","created_at":"2026-01-10T14:18:08.816972593+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.4","depends_on_id":"codex-pmh.3.3","type":"blocks","created_at":"2026-01-10T14:18:08.83318232+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.3.5","title":"Docs: canonical model IDs ({provider}/{model})","description":"Update docs to reflect the breaking change: models are always specified as {provider}/{model} and model_provider is removed.\n\nWork:\n- Remove examples using model_provider.\n- Add examples for OpenAI/Anthropic/Gemini/OpenRouter using canonical IDs (e.g. openai/gpt-5.1-codex-mini, openrouter/anthropic/claude-3.5-sonnet).\n\nFiles (expected):\n- docs/*\n","acceptance_criteria":"DoD:\n- Docs contain only canonical model examples.\n- Any references to model_provider are removed.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T14:17:30.11830575+01:00","updated_at":"2026-01-11T21:19:00.180301232+01:00","closed_at":"2026-01-11T21:19:00.180301232+01:00","close_reason":"Updated docs to canonical {provider}/{model} examples","dependencies":[{"issue_id":"codex-pmh.3.5","depends_on_id":"codex-pmh.3","type":"parent-child","created_at":"2026-01-10T14:17:30.129276285+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.3.5","depends_on_id":"codex-pmh.3.1","type":"blocks","created_at":"2026-01-10T14:18:08.854385107+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.4","title":"Decouple agent models from profiles","description":"Decouple agent/subagent model selection from config profiles.\n\nScope:\n- Subagent and agent model selection uses canonical {provider}/{model} directly.\n- Remove reliance on loading named profiles for subagents (breaking).\n- Provider switching stays 'new session' only.\n\nKey touchpoints:\n- core/src/subagents.rs, core/templates/subagents/*\n- core/src/tools/handlers/task.rs, core/src/tasks/handoff.rs\n- tui/src/history_cell.rs / any subagent model display\n","design":"Design choices:\n- Subagent frontmatter specifies model: {provider}/{model} (required for non-inherit).\n- Profile-based subagent selection is removed for simplicity.\n- Delegation always creates a new session for the subagent with its chosen model.\n","acceptance_criteria":"DoD:\n- Agent/subagent model selection is independent of profiles; subagent metadata supports specifying models directly.\n- Profile-based subagent model selection is removed (breaking).\n- Tests updated/added; cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-21T02:29:35.869279868+01:00","updated_at":"2026-01-11T13:57:57.527319396+01:00","closed_at":"2026-01-11T13:57:57.527319396+01:00","close_reason":"Subagents now use model (canonical {provider}/{model}) instead of profiles; delegation and TUI updated; docs added","dependencies":[{"issue_id":"codex-pmh.4","depends_on_id":"codex-pmh.2","type":"parent-child","created_at":"2026-01-09T12:22:14.309364018+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4","depends_on_id":"codex-pmh.3","type":"blocks","created_at":"2026-01-09T12:24:36.542328699+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4","depends_on_id":"codex-i1o.2","type":"related","created_at":"2026-01-10T14:18:08.954968346+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.4.1","title":"Core: subagent frontmatter uses model (remove profile)","description":"Change subagent configuration to specify model directly (canonical {provider}/{model}) and remove profile-based subagent config.\n\nWork:\n- Update SubagentMetadata frontmatter schema: replace profile with model (or model: inherit).\n- Remove ConfigProfile loading path for subagents.\n- Update built-in agent templates in core/templates/subagents/*.\n\nFiles (expected):\n- core/src/subagents.rs\n- core/templates/subagents/*.md\n","acceptance_criteria":"DoD:\n- Subagents load without requiring profiles.\n- Subagent metadata can specify canonical model IDs.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:17:37.548810722+01:00","updated_at":"2026-01-11T12:44:14.498751051+01:00","closed_at":"2026-01-11T12:44:14.498751051+01:00","close_reason":"Implemented model-based subagent metadata; removed profile lookup; updated templates; core tests pass","dependencies":[{"issue_id":"codex-pmh.4.1","depends_on_id":"codex-pmh.4","type":"parent-child","created_at":"2026-01-10T14:17:37.560705502+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4.1","depends_on_id":"codex-pmh.3.1","type":"blocks","created_at":"2026-01-10T14:18:08.876038415+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.4.2","title":"Delegation: spawn subagents with their model","description":"Update task delegation to use the subagent's canonical model ID (and keep provider switching as new-session-only).\n\nWork:\n- Task tool handler selects subagent model from metadata.\n- Ensure delegation creates a new session for the subagent using that model.\n- Remove any profile-based overrides in task handler/read_session handler.\n\nFiles (expected):\n- core/src/tools/handlers/task.rs\n- core/src/tools/handlers/read_session.rs\n- core/src/tasks/handoff.rs\n","acceptance_criteria":"DoD:\n- Subagent sessions use the model declared in subagent metadata.\n- No profile-based model overrides remain in delegation.\n- cargo test -p codex-core passes.\n","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-10T14:17:44.463854662+01:00","updated_at":"2026-01-11T12:44:58.927370291+01:00","closed_at":"2026-01-11T12:44:58.927370291+01:00","close_reason":"Delegation now reads subagent metadata model (canonical {provider}/{model}) and spawns subagent sessions with that model; removed profile-based overrides; codex-core tests pass","dependencies":[{"issue_id":"codex-pmh.4.2","depends_on_id":"codex-pmh.4","type":"parent-child","created_at":"2026-01-10T14:17:44.475977137+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4.2","depends_on_id":"codex-pmh.4.1","type":"blocks","created_at":"2026-01-10T14:18:08.892672442+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.4.3","title":"TUI: render subagent model IDs","description":"Ensure the TUI displays canonical model IDs for subagent turns and errors (no separate provider name).\n\nFiles (expected):\n- tui/src/history_cell.rs\n- tui/src/subagent_error_prompt.rs\n","acceptance_criteria":"DoD:\n- Subagent UI shows canonical model ID consistently.\n- cargo test -p codex-tui passes.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T14:17:49.75714584+01:00","updated_at":"2026-01-11T13:20:58.273839081+01:00","closed_at":"2026-01-11T13:20:58.273839081+01:00","close_reason":"TUI renders canonical model IDs for subagent sessions (captured from inner SessionConfigured) and subagent config error prompt updated; codex-tui tests pass","dependencies":[{"issue_id":"codex-pmh.4.3","depends_on_id":"codex-pmh.4","type":"parent-child","created_at":"2026-01-10T14:17:49.764463964+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4.3","depends_on_id":"codex-pmh.4.2","type":"blocks","created_at":"2026-01-10T14:18:08.908549221+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4.3","depends_on_id":"codex-pmh.3.3","type":"blocks","created_at":"2026-01-10T14:18:08.924316842+01:00","created_by":"daemon"}]}
{"id":"codex-pmh.4.4","title":"Docs: subagent models (no profiles)","description":"Document the new subagent frontmatter schema (model instead of profile) and how to choose models.\n\nFiles (expected):\n- docs/*\n","acceptance_criteria":"DoD:\n- Docs show subagent frontmatter with model: {provider}/{model}.\n- Any references to subagent profiles are removed.\n","status":"closed","priority":3,"issue_type":"task","created_at":"2026-01-10T14:17:54.866395539+01:00","updated_at":"2026-01-11T13:57:56.225580784+01:00","closed_at":"2026-01-11T13:57:56.225580784+01:00","close_reason":"Documented subagent frontmatter model field and removed profile references","dependencies":[{"issue_id":"codex-pmh.4.4","depends_on_id":"codex-pmh.4","type":"parent-child","created_at":"2026-01-10T14:17:54.878875848+01:00","created_by":"daemon"},{"issue_id":"codex-pmh.4.4","depends_on_id":"codex-pmh.4.1","type":"blocks","created_at":"2026-01-10T14:18:08.940234109+01:00","created_by":"daemon"}]}
{"id":"codex-q6o","title":"UI/UX Enhancements and Subagent Traceability","status":"open","priority":2,"issue_type":"epic","created_at":"2025-12-21T02:06:52.763182455+01:00","updated_at":"2025-12-21T02:06:52.763182455+01:00"}
{"id":"codex-q6o.1","title":"Investigate subagent work summary for main agent","description":"Explore ways to notify the main agent about subagent work, including which files were edited and the number of lines changed.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.106766761+01:00","updated_at":"2025-12-28T18:25:00.056160679+01:00","closed_at":"2025-12-28T18:25:00.056160679+01:00","dependencies":[{"issue_id":"codex-q6o.1","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.107115406+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.10","title":"Migrate crucial subagents to code","description":"Move the definitions of crucial subagents from config files into the code while ensuring they remain configurable/overridable via config.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:21:09.935577773+01:00","updated_at":"2025-12-21T11:34:41.766069234+01:00","closed_at":"2025-12-21T11:34:41.766069234+01:00","dependencies":[{"issue_id":"codex-q6o.10","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:21:09.935936738+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.11","title":"Port /review agent and workflow from amp","description":"Port the /review agent and associated workflow from amp (/home/ribelo/projects/github/coding-tools-prompts/amp) to ohm. This includes the agent prompt, skill, and any mode-specific logic.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:22:13.561005544+01:00","updated_at":"2025-12-21T11:34:43.762959542+01:00","closed_at":"2025-12-21T11:34:43.762959542+01:00","dependencies":[{"issue_id":"codex-q6o.11","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:22:13.561363688+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.12","title":"Improve review agent description and verification workflow","description":"Update the review agent's description to emphasize that the main agent must verify reported bugs before taking action. Prevent 'panicking' on false positives.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:29:35.876986076+01:00","updated_at":"2025-12-30T12:18:47.659051539+01:00","closed_at":"2025-12-30T12:18:47.659051539+01:00","dependencies":[{"issue_id":"codex-q6o.12","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:29:35.877235442+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.13","title":"TUI: stream exec output deltas for running commands","description":"Render live ExecCommandOutputDelta (stdout/stderr) in the exec UI while the command is running.\n\nDoD:\n- TUI consumes EventMsg::ExecCommandOutputDelta and updates the active exec cell for matching call_id\n- Output is bounded (bytes/lines) to avoid unbounded memory growth\n- On ExecCommandEnd, final output is shown without duplicate chunks\n- Snapshot tests updated; cargo test -p codex-tui passes","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-10T02:14:45.822065087+01:00","updated_at":"2026-01-10T02:14:45.822065087+01:00","dependencies":[{"issue_id":"codex-q6o.13","depends_on_id":"codex-q6o.4","type":"discovered-from","created_at":"2026-01-10T02:14:45.822494159+01:00","created_by":"daemon"},{"issue_id":"codex-q6o.13","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2026-01-10T02:14:47.053744994+01:00","created_by":"daemon"}]}
{"id":"codex-q6o.2","title":"Return tool_result of last subagent tool_call to main agent","description":"If the last part returned by a subagent is a tool_call, ensure its tool_result output is returned to the main agent. This is useful when subagents use tools like echo to return messages.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.115022136+01:00","updated_at":"2025-12-21T11:34:37.685689546+01:00","closed_at":"2025-12-21T11:34:37.685689546+01:00","dependencies":[{"issue_id":"codex-q6o.2","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.115300558+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.3","title":"Include profile in session resume message","description":"Update the resume message shown after closing codex to include the current profile. For example: To continue this session, run codex --profile xyz resume \u003cuuid\u003e.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.122685782+01:00","updated_at":"2025-12-26T18:10:14.931806626+01:00","closed_at":"2025-12-26T18:10:14.931806626+01:00","dependencies":[{"issue_id":"codex-q6o.3","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.122923937+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.4","title":"Investigate streaming bash output to UI","description":"Explore the possibility of streaming bash command output to the UI in real-time instead of waiting for the command to finish.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:06:57.131331473+01:00","updated_at":"2026-01-10T02:13:36.286218945+01:00","closed_at":"2026-01-10T02:13:36.286218945+01:00","close_reason":"Investigation complete: core/protocol already stream ExecCommandOutputDelta; remaining work is TUI rendering.","dependencies":[{"issue_id":"codex-q6o.4","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:06:57.131633911+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.5","title":"Show full subagent prompt in ctrl-t view","description":"Update the subagent hierarchy view (ctrl-t) to display the full task/prompt for each subagent.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:11:44.941660546+01:00","updated_at":"2025-12-26T18:12:32.825752744+01:00","closed_at":"2025-12-26T18:12:32.825752744+01:00","dependencies":[{"issue_id":"codex-q6o.5","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:11:44.941981989+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.6","title":"Investigate subagent sandbox permission escalation bug","description":"Even when a subagent has approval_policy=never, escalation requests are being redirected to the user. Investigate and fix this sandbox escape/bug.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-21T02:11:44.949421612+01:00","updated_at":"2025-12-21T13:05:32.910399827+01:00","closed_at":"2025-12-21T13:05:32.910399827+01:00","dependencies":[{"issue_id":"codex-q6o.6","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:11:44.949663092+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.7","title":"Implement read_session tool","description":"Implement a tool that allows agents to query the conversation history of other sessions. The tool should delegate the search to a specialized subagent (e.g., finder) so that the main agent only receives relevant findings rather than the entire thread.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:16:14.728161966+01:00","updated_at":"2025-12-28T18:37:23.890096169+01:00","closed_at":"2025-12-28T18:37:23.890096169+01:00","dependencies":[{"issue_id":"codex-q6o.7","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:16:14.728877832+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-q6o.7","depends_on_id":"codex-dt2","type":"related","created_at":"2025-12-21T02:17:09.448903538+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.8","title":"Update subagent prompts and descriptions from amp","description":"Update and clone subagent prompts and descriptions from /home/ribelo/projects/github/coding-tools-prompts/amp/prompts/subagents to align with amp's configuration.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T02:16:14.740453422+01:00","updated_at":"2025-12-21T11:34:39.829301912+01:00","closed_at":"2025-12-21T11:34:39.829301912+01:00","dependencies":[{"issue_id":"codex-q6o.8","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:16:14.740773382+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-q6o.9","title":"Support handoff to other profiles","description":"Implement the ability to handoff a conversation to a different profile. This involves allowing the user to specify a target profile during the handoff process.","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-21T02:19:03.528877943+01:00","updated_at":"2025-12-22T23:38:54.644385242+01:00","closed_at":"2025-12-22T23:38:54.644385242+01:00","dependencies":[{"issue_id":"codex-q6o.9","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2025-12-21T02:19:03.52936952+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qg8","title":"Optional upstream ports (post 2026-01-09 sync)","description":"Optional upstream bugfix ports that are not required for baseline functionality in this fork (e.g., app-server-specific, terminal UX, Bazel workflows, session-scoped approval polish).","acceptance_criteria":"DoD:\\n- Optional tasks are either completed or closed with reason Deferred/Not needed.\\n- No optional task blocks shipping required upstream bugfix ports.","status":"open","priority":3,"issue_type":"epic","created_at":"2026-01-11T16:08:19.350716197+01:00","updated_at":"2026-01-11T16:08:19.350716197+01:00"}
{"id":"codex-qhp","title":"Epic: Port System Skills from Upstream","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-04T19:01:20.202616238+01:00","updated_at":"2026-01-04T19:24:53.661760501+01:00","closed_at":"2026-01-04T19:24:53.661760501+01:00"}
{"id":"codex-qhp.1","title":"Add include_dir dependency to Cargo.toml","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:29.294490733+01:00","updated_at":"2026-01-04T19:03:59.795510437+01:00","closed_at":"2026-01-04T19:03:59.795510437+01:00","dependencies":[{"issue_id":"codex-qhp.1","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:29.294850229+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qhp.2","title":"Create skills/assets directory with skill-creator and skill-installer","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:30.878546033+01:00","updated_at":"2026-01-04T19:03:59.813246294+01:00","closed_at":"2026-01-04T19:03:59.813246294+01:00","dependencies":[{"issue_id":"codex-qhp.2","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:30.878870642+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qhp.3","title":"Create skills/system.rs module for installing bundled skills","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:32.673472063+01:00","updated_at":"2026-01-04T19:11:09.30357835+01:00","closed_at":"2026-01-04T19:11:09.30357835+01:00","dependencies":[{"issue_id":"codex-qhp.3","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:32.673915329+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qhp.4","title":"Update SkillsManager to install system skills on creation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:34.210816201+01:00","updated_at":"2026-01-04T19:11:09.320559288+01:00","closed_at":"2026-01-04T19:11:09.320559288+01:00","dependencies":[{"issue_id":"codex-qhp.4","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:34.211138395+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qhp.5","title":"Update loader.rs to include system skills in skill roots","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:36.387228122+01:00","updated_at":"2026-01-04T19:11:09.338128469+01:00","closed_at":"2026-01-04T19:11:09.338128469+01:00","dependencies":[{"issue_id":"codex-qhp.5","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:36.387579562+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qhp.6","title":"Run tests and validate system skills installation","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-04T19:01:37.237264352+01:00","updated_at":"2026-01-04T19:24:53.643360868+01:00","closed_at":"2026-01-04T19:24:53.643360868+01:00","dependencies":[{"issue_id":"codex-qhp.6","depends_on_id":"codex-qhp","type":"parent-child","created_at":"2026-01-04T19:01:37.237684393+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qj1","title":"Implement Drop for WorktreeHandle to prevent directory leaks","description":"## Problem\n`WorktreeHandle` manages a directory in `.codex/agents/` but does not implement `Drop` to clean it up. Cleanup relies on `merge_pending_patches` or error handling paths in `TaskHandler`. If the application terminates or the session is dropped while `PendingSubagentResult`s are queued, the temporary worktree directories will remain on disk indefinitely.\n\n## Solution\nImplement `Drop` for `WorktreeHandle` that removes the worktree directory. Use a flag to track whether cleanup has already been performed (to avoid double-cleanup).\n\n## Files\n- core/src/worktree_manager.rs - add Drop impl for WorktreeHandle","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-21T18:57:37.136554152+01:00","updated_at":"2025-12-21T19:01:28.241779033+01:00","closed_at":"2025-12-21T19:01:28.241779033+01:00"}
{"id":"codex-qld","title":"Implement read_session tool with internal subagent visibility","description":"## Goal\n\nAllow main agent to query previous session history via a dedicated tool that spawns an internal subagent.\n\n## Design Decisions (from Oracle review)\n\n### read_session tool\n- `read_session(session_id, question)` - simple natural language interface\n- Spawns dedicated `session_reader` subagent (not finder - finder is optimized for brevity)\n- Pass file path to subagent, let it read/grep as needed\n- Block reading current session (prevent recursion)\n- Only subagent's answer returned to main agent\n\n### Internal subagent visibility\n- Add `internal: true` field to agent frontmatter (default: false = public)\n- Public agents: shown in main agent's available subagents\n- Internal agents: NOT shown to main agent, but:\n  1. Can be spawned by tool implementations (Rust code)\n  2. Can be used by agents that list them in `allowed_subagents`\n- No inheritance - internal agents define their own `allowed_subagents`\n- Enforce unique names across all agents (public + internal)\n- CLI debugging still works for internal agents\n\n## Benefits\n- Keeps main agent's subagent list clean\n- Prevents LLM from misusing utility agents\n- Allows restricted, powerful agents only callable by specific tools","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-28T18:36:08.089968545+01:00","updated_at":"2025-12-28T19:42:15.10533862+01:00","closed_at":"2025-12-28T19:42:15.10533862+01:00"}
{"id":"codex-qld.1","title":"Add internal field to SubagentMetadata struct","description":"## Task\n\nAdd `internal: bool` field to `SubagentMetadata` in frontmatter parsing.\n\n## Files to modify\n\n### core/src/subagents.rs\n- Add `internal: Option\u003cbool\u003e` to `SubagentMetadata` struct (serde default false)\n- Add `pub fn is_internal(\u0026self) -\u003e bool` helper\n\n### core/src/config/types.rs (if SubagentMetadata is there)\n- Same changes if struct lives here\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T18:36:19.741205255+01:00","updated_at":"2025-12-28T19:09:56.288956403+01:00","closed_at":"2025-12-28T19:09:56.288956403+01:00","dependencies":[{"issue_id":"codex-qld.1","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:19.741580391+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qld.2","title":"Filter internal agents from main agent's available subagents","description":"## Task\n\nUpdate prompt builder to exclude internal agents from the main agent's subagent list.\n\n## Logic\n```rust\navailable = agents.filter(|a| !a.is_internal() || current_agent.allowed_subagents.contains(\u0026a.slug))\n```\n\n## Files to modify\n\n### core/src/project_doc.rs (or wherever subagent list is built for prompt)\n- Filter out internal agents when building available subagents for main agent\n- Keep internal agents if they appear in current agent's `allowed_subagents`\n\n### core/src/codex.rs\n- Update SubagentRegistry filtering if needed\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`\n- Manual test: create internal agent, verify it doesn't appear in main agent's list","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T18:36:24.930819328+01:00","updated_at":"2025-12-28T19:12:16.98077366+01:00","closed_at":"2025-12-28T19:12:16.98077366+01:00","dependencies":[{"issue_id":"codex-qld.2","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:24.931114973+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qld.3","title":"Allow tools to spawn internal agents bypassing visibility filter","description":"## Task\n\nEnsure Rust tool implementations can spawn internal agents directly.\n\n## Current behavior\nTask tool looks up agent from registry. Need to ensure this works for internal agents.\n\n## Files to modify\n\n### core/src/tools/handlers/task.rs\n- Verify agent lookup doesn't filter by internal flag\n- The visibility filter should only apply to prompt construction, not tool execution\n\n### core/src/subagents.rs\n- Add `SubagentRegistry::get_by_slug(\u0026self, slug: \u0026str)` that returns any agent (internal or public)\n- Existing method should work, just verify no filtering\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T18:36:29.841930564+01:00","updated_at":"2025-12-28T19:12:18.329451239+01:00","closed_at":"2025-12-28T19:12:18.329451239+01:00","dependencies":[{"issue_id":"codex-qld.3","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:29.842404209+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qld.4","title":"Create session_reader internal subagent template","description":"## Task\n\nCreate the built-in `session_reader` agent that analyzes session logs.\n\n## File to create\n\n### core/templates/subagents/session_reader.md\n\n```markdown\n---\nname: Session Reader\ndescription: Internal agent for analyzing session logs. Not directly callable.\ninternal: true\nprofile: inherit\nsandbox_policy: read-only\napproval_policy: never\nallowed_subagents: []\n---\n\nYou are an analyst reviewing past Codex session logs.\n\nYour task is to answer questions about what happened in a specific session based on the log file provided.\n\n## Guidelines\n\n1. Read the session file using read_file or grep as needed\n2. For large files, use grep/rg to find relevant sections first\n3. Provide descriptive, helpful answers\n4. Cite specific messages, tool calls, or outputs when relevant\n5. If the session file is too large, read it in chunks or use search\n\n## Output\n\nAnswer the user's question clearly and concisely. Include relevant context from the session log.\n```\n\n## Files to modify\n\n### core/src/subagents.rs\n- Add `const BUILTIN_SESSION_READER_AGENT: \u0026str = include_str!(\"../templates/subagents/session_reader.md\");`\n- Add to `builtin_agents` array\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T18:36:42.230619602+01:00","updated_at":"2025-12-28T19:13:55.305256852+01:00","closed_at":"2025-12-28T19:13:55.305256852+01:00","dependencies":[{"issue_id":"codex-qld.4","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:42.231014697+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qld.5","title":"Implement read_session tool","description":"## Task\n\nImplement the `read_session` tool that spawns session_reader subagent.\n\n## Tool signature\n```rust\nstruct ReadSessionParams {\n    session_id: String,\n    question: String,\n}\n```\n\n## Implementation\n\n### core/src/tools/mod.rs\n- Add `ReadSession` variant to tool enum\n\n### core/src/tools/handlers/read_session.rs (new file)\n- Resolve session_id to file path (`~/.codex/sessions/{session_id}.jsonl`)\n- Validate session exists\n- Block if session_id == current session (prevent recursion)\n- Spawn `session_reader` subagent with prompt:\n  `Analyze the session log at {path}. Question: {question}`\n- Return subagent's answer\n\n### core/src/tools/handlers/mod.rs\n- Add module and handler registration\n\n## Verification\n- `cargo check -p codex-core`\n- `cargo test -p codex-core`\n- Manual test: run codex, spawn subagent, then use read_session to query it","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-28T18:36:49.063988157+01:00","updated_at":"2025-12-28T19:31:29.900422249+01:00","closed_at":"2025-12-28T19:31:29.900422249+01:00","dependencies":[{"issue_id":"codex-qld.5","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:49.06427261+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qld.6","title":"Add tests for internal agent visibility","description":"## Task\n\nAdd tests verifying internal agent visibility behavior.\n\n## Test cases\n\n### core/src/subagents.rs tests\n1. Internal agent parsed correctly from frontmatter\n2. Internal agent NOT in main agent's available list\n3. Internal agent IS available if in `allowed_subagents`\n4. Internal agent CAN be looked up by slug (for tool spawning)\n5. Name uniqueness enforced across public and internal agents\n\n### Integration test\n- Create internal agent\n- Verify main agent cannot see it\n- Verify tool can spawn it\n\n## Verification\n- `cargo test -p codex-core`","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-28T18:36:53.347167693+01:00","updated_at":"2025-12-28T19:36:27.524086424+01:00","closed_at":"2025-12-28T19:36:27.524086424+01:00","dependencies":[{"issue_id":"codex-qld.6","depends_on_id":"codex-qld","type":"parent-child","created_at":"2025-12-28T18:36:53.347534874+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-qtk","title":"Document task tool and task type configuration/extension","description":"Write/refresh user+developer docs for the new task tool (WHAT+DIFFICULTY) and how to extend it.\n\nScope:\n- Clarify task tool API and fields (task_type/difficulty/description/prompt/session_id).\n- Document config.toml [[task]] and [task.difficulty.*] overrides, and how built-in tasks interact with config overrides.\n- Document how to add new built-in task types in Rust (TaskRegistry + embedded system prompts), vs writing new tool handlers.\n- Update legacy subagent docs so they don't mislead users.\n\nDoD:\n- codex-rs/docs/tasks.md explains task tool + config clearly and includes at least one copy/paste example.\n- New or updated developer doc explains where to add built-in task types and prompts in Rust.\n- docs/subagents.md updated to point users to task routing and clarify what is/ isn’t configurable.\n- Links from codex-rs/README.md or docs/config.md updated so docs are discoverable.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-14T02:07:25.47317778+01:00","updated_at":"2026-01-14T03:02:10.820707402+01:00","closed_at":"2026-01-14T03:02:10.820707402+01:00","close_reason":"Completed"}
{"id":"codex-rkf","title":"Move worktree and patch storage from ~/.codex to per-repo .codex directory","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-29T13:28:39.876662638+01:00","updated_at":"2025-12-30T12:11:19.871705075+01:00","closed_at":"2025-12-30T12:11:19.871705075+01:00"}
{"id":"codex-rs-9kr","title":"Unify review as task/subagent","description":"Unify the /review feature with the task/subagent system so that:\n1. Agent can invoke review via task tool (not just users)\n2. Both user /review and agent task(review) use the same prompt/policies\n3. Reduce code duplication between ReviewTask and task handler\n\nThree phases:\n- Phase 1: Create review.md subagent (enables agent access immediately)\n- Phase 2: Update ReviewTask to load from SubagentRegistry (unify definition source)  \n- Phase 3: Full unification - remove Op::Review and ReviewTask entirely\n\nDesign doc: Oracle recommended keeping Op::Review for Phase 2 due to TUI coupling, but Phase 3 removes it.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-15T14:10:36.259658275+01:00","updated_at":"2025-12-15T16:04:36.428775116+01:00","closed_at":"2025-12-15T16:04:36.428775116+01:00"}
{"id":"codex-rs-9kr.1","title":"Create review.md subagent file","description":"Create ~/.codex/agents/review.md with:\n- YAML frontmatter: name, description, profile: inherit, sandbox_policy: read-only, approval_policy: never, allowed_subagents: []\n- Body: content from core/review_prompt.md\n- Add comment warning that JSON output format is required for TUI compatibility\n\nThis immediately enables agent to call task(subagent_type='review', prompt='\u003cdiff\u003e')\n\nFiles to reference:\n- core/review_prompt.md (source content)\n- ~/.codex/agents/oracle.md (example format)","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:10:51.694652174+01:00","updated_at":"2025-12-15T14:16:44.709028672+01:00","closed_at":"2025-12-15T14:16:44.709028672+01:00","dependencies":[{"issue_id":"codex-rs-9kr.1","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:10:51.694968969+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.10","title":"Update app-server review API to use DelegateSubagent","description":"Update app-server to use Op::DelegateSubagent for review:\n\n1. Modify app-server/src/codex_message_processor.rs review_start() \n2. Instead of Op::Review, emit Op::DelegateSubagent\n3. Update tests in app-server/tests/suite/v2/review.rs\n4. May need to update app-server-protocol types\n\nConsider backwards compatibility - existing API clients may expect ReviewStartResponse.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:00.619785448+01:00","updated_at":"2025-12-15T15:46:10.101396072+01:00","closed_at":"2025-12-15T15:46:10.101396072+01:00","dependencies":[{"issue_id":"codex-rs-9kr.10","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:00.620114387+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.10","depends_on_id":"codex-rs-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.742613814+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.11","title":"Cleanup unused review types from protocol","description":"Remove unused review-related types after migration:\n\n1. Review which types are still needed:\n   - ReviewRequest - may still be used by review_prompts.rs\n   - ReviewTarget - may still be used\n   - ReviewDelivery - check if needed\n   - ReviewOutputEvent - may be used by TUI parsing\n   - ExitedReviewModeEvent - should be removed\n   \n2. Remove truly unused types from protocol/src/protocol.rs\n3. Update any remaining imports\n\nRun after all other Phase 3 tasks complete.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:18.206529477+01:00","updated_at":"2025-12-15T15:46:56.477464172+01:00","closed_at":"2025-12-15T15:46:56.477464172+01:00","dependencies":[{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:18.207056684+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr.9","type":"blocks","created_at":"2025-12-15T14:12:50.751121687+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.11","depends_on_id":"codex-rs-9kr.10","type":"blocks","created_at":"2025-12-15T14:12:50.757716555+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.12","title":"Update tests after full review unification","description":"Update all tests affected by review unification:\n\n1. core/tests/suite/review.rs - update or remove Op::Review tests\n2. tui/src/chatwidget/tests.rs - update /review flow tests\n3. tui2/src/chatwidget/tests.rs - same\n4. app-server/tests/suite/v2/review.rs - update API tests\n5. Any snapshot tests that may have changed\n\nRun full test suite: cargo test --all-features","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:12:24.132550543+01:00","updated_at":"2025-12-15T16:04:03.730434461+01:00","closed_at":"2025-12-15T16:04:03.730434461+01:00","dependencies":[{"issue_id":"codex-rs-9kr.12","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:12:24.132961548+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.12","depends_on_id":"codex-rs-9kr.11","type":"blocks","created_at":"2025-12-15T14:12:50.764087215+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.2","title":"Update task tool description to include review","description":"Update the task tool's generated description in core/src/tools/handlers/task.rs to mention the review subagent.\n\nThe tool description is dynamically generated from SubagentRegistry.list(). Since review.md will be loaded, it should automatically appear. Verify this works correctly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:10:57.217103789+01:00","updated_at":"2025-12-15T14:17:06.590975268+01:00","closed_at":"2025-12-15T14:17:06.590975268+01:00","dependencies":[{"issue_id":"codex-rs-9kr.2","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:10:57.217401047+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.3","title":"Add review subagent integration test","description":"Add test in core/tests/ to verify:\n1. Agent can invoke task(subagent_type='review', prompt='...') \n2. Review subagent loads correctly from registry\n3. Output is returned properly\n\nReference existing subagent tests in core/tests/ for patterns.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:02.317112673+01:00","updated_at":"2025-12-15T14:17:52.339367052+01:00","closed_at":"2025-12-15T14:17:52.339367052+01:00","dependencies":[{"issue_id":"codex-rs-9kr.3","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:02.317466489+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.4","title":"Update ReviewTask to load prompt from SubagentRegistry","description":"Modify core/src/tasks/review.rs to:\n1. Attempt to load 'review' subagent from SubagentRegistry\n2. If found: use its system_prompt and policies (sandbox_policy, approval_policy)\n3. If not found: fallback to hardcoded REVIEW_PROMPT (backwards compat)\n\nThis unifies the prompt source - both /review (user) and task(review) (agent) use same definition.\n\nKey changes:\n- Add SubagentRegistry lookup in start_review_conversation()\n- Use subagent's system_prompt as base_instructions if available\n- Respect subagent's sandbox_policy and approval_policy\n\nKeep Op::Review and ExitedReviewModeEvent - TUI still needs them.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:11.018903647+01:00","updated_at":"2025-12-15T14:30:50.570232143+01:00","closed_at":"2025-12-15T14:30:50.570232143+01:00","dependencies":[{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:11.019273924+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr.1","type":"blocks","created_at":"2025-12-15T14:12:50.687699932+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.4","depends_on_id":"codex-rs-9kr.2","type":"blocks","created_at":"2025-12-15T14:12:50.695450488+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.5","title":"Add test for ReviewTask registry loading","description":"Add tests to verify ReviewTask correctly:\n1. Loads from SubagentRegistry when review.md exists\n2. Falls back to REVIEW_PROMPT when review.md is missing\n3. Respects policies from subagent definition\n\nAdd to core/tests/suite/review.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-15T14:11:18.751001758+01:00","updated_at":"2025-12-15T14:31:07.503168654+01:00","closed_at":"2025-12-15T14:31:07.503168654+01:00","dependencies":[{"issue_id":"codex-rs-9kr.5","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:18.751354872+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.5","depends_on_id":"codex-rs-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.7023669+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.6","title":"Update TUI to use Op::DelegateSubagent for /review","description":"Modify TUI /review flow to emit Op::DelegateSubagent instead of Op::Review:\n\n1. Keep ReviewPopup (branch/commit/custom picker) - user still selects target\n2. Use review_prompts.rs to build the diff prompt (git diff, commit show, etc.)\n3. Instead of Op::Review, emit:\n   Op::DelegateSubagent {\n       agent: 'review',\n       prompt: '\u003cbuilt diff prompt\u003e',\n       description: '\u003cuser-facing hint\u003e',\n   }\n\nFiles to modify:\n- tui/src/chatwidget.rs (dispatch_command, review popup handling)\n- tui2/src/chatwidget.rs (same changes)\n\nKeep review_prompts.rs - still needed for building the prompt.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:27.691336026+01:00","updated_at":"2025-12-15T15:06:25.521132815+01:00","closed_at":"2025-12-15T15:06:25.521132815+01:00","dependencies":[{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:27.69173559+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr.4","type":"blocks","created_at":"2025-12-15T14:12:50.70883699+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.6","depends_on_id":"codex-rs-9kr.5","type":"blocks","created_at":"2025-12-15T14:12:50.715400459+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.7","title":"Handle review output parsing in TUI SubagentEvent","description":"Update TUI to parse ReviewOutputEvent from SubagentEvent when agent is 'review':\n\n1. When receiving TaskComplete for 'review' subagent, attempt to parse output as JSON ReviewOutputEvent\n2. If valid JSON: render using existing review findings format (render_review_output_text)\n3. If not valid JSON: render as plain markdown\n\nThis replaces ExitedReviewModeEvent handling with SubagentEvent-based detection.\n\nFiles to modify:\n- tui/src/chatwidget.rs\n- tui2/src/chatwidget.rs  \n- Possibly tui/src/history_cell.rs for rendering","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:35.292380316+01:00","updated_at":"2025-12-15T15:17:05.630380288+01:00","closed_at":"2025-12-15T15:17:05.630380288+01:00","dependencies":[{"issue_id":"codex-rs-9kr.7","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:35.292739082+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.7","depends_on_id":"codex-rs-9kr.6","type":"blocks","created_at":"2025-12-15T14:12:50.723307193+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.8","title":"Remove Op::Review from protocol","description":"Remove Op::Review variant from protocol/src/protocol.rs:\n\n1. Remove Op::Review { review_request: ReviewRequest } variant\n2. Keep ReviewRequest, ReviewTarget, ReviewDelivery types if still used by review_prompts.rs\n3. Remove ExitedReviewModeEvent if no longer needed\n4. Update all match arms that handle Op::Review\n\nFiles to update:\n- protocol/src/protocol.rs\n- core/src/codex.rs (remove Op::Review handler)\n- Any other files matching on Op::Review","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:46.979545923+01:00","updated_at":"2025-12-15T15:43:25.394932343+01:00","closed_at":"2025-12-15T15:43:25.394932343+01:00","dependencies":[{"issue_id":"codex-rs-9kr.8","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:46.979864121+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.8","depends_on_id":"codex-rs-9kr.7","type":"blocks","created_at":"2025-12-15T14:12:50.730408158+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9kr.9","title":"Remove ReviewTask and tasks/review.rs","description":"Delete core/src/tasks/review.rs and related code:\n\n1. Delete core/src/tasks/review.rs\n2. Remove ReviewTask from core/src/tasks/mod.rs\n3. Remove imports and usages of ReviewTask\n4. Remove exit_review_mode function\n5. Keep parse_review_output_event if needed by TUI (or move to protocol)\n\nThe review functionality now flows through task tool -\u003e SubagentDelegateTask.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-15T14:11:53.84168904+01:00","updated_at":"2025-12-15T15:45:11.900516798+01:00","closed_at":"2025-12-15T15:45:11.900516798+01:00","dependencies":[{"issue_id":"codex-rs-9kr.9","depends_on_id":"codex-rs-9kr","type":"parent-child","created_at":"2025-12-15T14:11:53.842062202+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-rs-9kr.9","depends_on_id":"codex-rs-9kr.8","type":"blocks","created_at":"2025-12-15T14:12:50.736446183+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9rt","title":"Subagent rendering polish","description":"Collection of UI/UX improvements for subagent rendering in the TUI. Covers nesting bugs, visual polish, and display consistency issues.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-15T21:52:05.938083509+01:00","updated_at":"2025-12-15T22:35:34.788011714+01:00","closed_at":"2025-12-15T22:35:34.788011714+01:00"}
{"id":"codex-rs-9rt.1","title":"Subagent task description truncated in transcript overlay (Ctrl+t)","description":"## Issue\n\nThe task description (prompt) delegated to a subagent is truncated in both the normal view and the transcript overlay (Ctrl+t). Users should be able to see the full message sent to the subagent when viewing the expanded transcript.\n\n## Current Behavior\n\n- Task description is wrapped/truncated in `display_lines()`\n- Task description is also wrapped in `transcript_lines()` using `textwrap::wrap()`\n- Long prompts sent to subagents are cut off with no way to view the full content\n\n## Expected Behavior\n\n- Normal view: truncated task description (current behavior is fine)\n- Transcript overlay (Ctrl+t): full task description should be visible without truncation\n\n## Relevant Code\n\n- `tui/src/history_cell.rs:1420-1430`: `transcript_lines()` wraps description with `textwrap::wrap()`\n- The `wrap_width` calculation may be too aggressive for the transcript view\n\n## Fix Direction\n\nIn `transcript_lines()`, either:\n1. Don't limit wrap width for the description (let it flow naturally)\n2. Or use a much larger wrap width for transcript mode\n3. Ensure the full description is rendered across multiple lines without any character limit","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:47.59488775+01:00","updated_at":"2025-12-15T22:35:19.590583799+01:00","closed_at":"2025-12-15T22:35:19.590583799+01:00","dependencies":[{"issue_id":"codex-rs-9rt.1","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T22:03:47.595357588+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-9rt.2","title":"Subagent final message not shown in UI","description":"## Issue\n\nThe last message from a subagent (its final response/output) is not visible in the UI. Users should be able to see what the subagent returned to the parent agent.\n\n## Current Behavior\n\n- Subagent cell shows: header, task description, and activity log (shell commands, patches, etc.)\n- The subagent's final textual response/message is not displayed\n- Users cannot see what the subagent concluded or reported back\n\n## Expected Behavior\n\n- Normal view: show truncated version of the subagent's final message\n- Transcript overlay (Ctrl+t): show the full final message expanded\n\n## Relevant Code\n\n- `tui/src/history_cell.rs`: `SubagentTaskCell` struct and its `display_lines()`/`transcript_lines()` methods\n- `tui/src/chatwidget.rs`: `on_subagent_event()` handles subagent events\n- The `SubagentState` struct may need a field to store the final message\n- `EventMsg::AgentMessage` events from subagents should be captured and displayed\n\n## Fix Direction\n\n1. Add a `final_message: Option\u003cString\u003e` field to `SubagentState`\n2. Capture `AgentMessage` events in `on_subagent_event()` and store the content\n3. Render the final message in both `display_lines()` (truncated) and `transcript_lines()` (full)","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T22:03:58.785651289+01:00","updated_at":"2025-12-15T22:35:24.643083449+01:00","closed_at":"2025-12-15T22:35:24.643083449+01:00","dependencies":[{"issue_id":"codex-rs-9rt.2","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T22:03:58.785965268+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-alj","title":"Parallel subagent delegations incorrectly nest due to shared DelegationRegistry state","description":"## Bug Summary\n\nWhen the parent agent spawns multiple subagents in parallel (e.g., two `@general` calls at once), they are rendered as nested rather than siblings. The second subagent appears nested inside the first, even though both should be at the same level under the parent.\n\n## Observed Behavior\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n  └ • Delegating to @general          \u003c-- BUG: This should NOT be nested\n    └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n      ... +10 more\n```\n\nThe second `@general` delegation appears nested inside the first one, but since `general` subagent cannot call itself, this is clearly incorrect. They should render as siblings:\n\n```\n• Delegated to @general\n  └ Create skill discovery utility (randy-0sb.3)\n    ... +16 more\n• Delegating to @general              \u003c-- EXPECTED: Same level as above\n  └ Add enabledSkills to ProjectConfig (randy-0sb.1)\n    ... +10 more\n```\n\n## Root Cause\n\nThe `DelegationRegistry` in `core/src/delegation.rs` uses a single shared `current: Arc\u003cRwLock\u003cOption\u003cDelegationContext\u003e\u003e\u003e` to track the active delegation context. When multiple subagents are spawned in parallel:\n\n1. First subagent calls `registry.enter(call_id_1)` → creates root context with `depth=0`, no parent\n2. Second subagent calls `registry.enter(call_id_2)` → sees first subagent's context as `current`, creates child with `depth=1` and `parent_delegation_id = call_id_1`\n\nThis causes the second subagent to incorrectly inherit from the first sibling instead of from the actual parent.\n\n## Relevant Code Paths\n\n- `core/src/delegation.rs`: `DelegationRegistry::enter()` uses shared `current` state\n- `core/src/tools/handlers/task.rs:202-208`: Retrieves delegation context for each subagent\n- `tui/src/chatwidget.rs:2187-2190`: Uses `parent_delegation_id` to nest cells\n\n## Fix Direction\n\nThe delegation context needs to be scoped per-call rather than shared globally. Options:\n\n1. Pass parent delegation ID explicitly from the caller rather than inferring from shared state\n2. Use a stack-based or tree-based registry that tracks parent-child relationships explicitly\n3. Store delegation context in the invocation/session context rather than a global registry\n\n## Test Case\n\nSee `tui/src/chatwidget/tests/subagent_tests.rs:91` for existing nesting test (`subagent_nesting_logic`). A new test should verify that two parallel delegations with the same parent remain siblings, not nested.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-15T21:50:57.207483466+01:00","updated_at":"2025-12-15T22:35:14.532746134+01:00","closed_at":"2025-12-15T22:35:14.532746134+01:00","dependencies":[{"issue_id":"codex-rs-alj","depends_on_id":"codex-rs-9rt","type":"parent-child","created_at":"2025-12-15T21:52:32.934771433+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-rs-yr6","title":"Fix failing test model_migration_prompt_only_shows_for_deprecated_models in tui2","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T15:16:14.896470158+01:00","updated_at":"2025-12-27T11:23:28.471071021+01:00","closed_at":"2025-12-27T11:23:28.471071021+01:00"}
{"id":"codex-sbl","title":"Parent session handoff traceability","description":"## Goal\nRecord handoff in parent session's rollout for bidirectional traceability.\n\n## Implementation\n1. Update Op::ConfirmHandoff in protocol/src/protocol.rs to include child_id: ConversationId\n2. Implement core handler in core/src/codex.rs to write RolloutItem::Handoff to parent's rollout\n3. Update TUI in tui/src/app.rs to send Op::ConfirmHandoff { draft, child_id } after spawning child\n\n## Code Pattern\n```rust\nOp::ConfirmHandoff { draft, child_id } =\u003e {\n    let item = RolloutItem::Handoff(HandoffRolloutItem {\n        child_id,\n        goal: draft.goal.clone(),\n        timestamp: time::OffsetDateTime::now_utc().format(\u0026Rfc3339).unwrap_or_default(),\n    });\n    if let Some(recorder) = sess.services.rollout.lock().await.as_ref() {\n        recorder.record_items(\u0026[item]).await?;\n    }\n}\n```\n\n## Files to modify\n- protocol/src/protocol.rs - add child_id to Op::ConfirmHandoff\n- core/src/codex.rs - implement handler\n- tui/src/app.rs - send Op after creating child session","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-21T01:46:46.552678702+01:00","updated_at":"2025-12-22T23:37:54.312405934+01:00","closed_at":"2025-12-22T23:37:54.312405934+01:00"}
{"id":"codex-sex","title":"Handoff Feature Improvements","description":"Epic for all /handoff command improvements and fixes.\n\n## What is Handoff?\nThe /handoff command extracts context from current conversation and starts a new focused thread with that context. It's useful for:\n- Starting fresh when context gets too large\n- Focusing on a specific subtask\n- Handing work to a different profile/model\n\n## Current Issues\n1. Empty extracted context (streaming events not captured)\n2. No parent session traceability in child session\n3. Context overflow when conversation is large\n4. Various UX improvements needed\n\n## Related Tasks (to be consolidated under this epic)\n- codex-3zq: Empty extracted context bug\n- codex-16t: Context overflow protection\n- codex-sbl: Parent session traceability\n- codex-zal: Editable handoff draft\n- codex-dt2: read_parent_thread tool\n- codex-q6o.9: Handoff to other profiles","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-22T23:37:20.014649977+01:00","updated_at":"2025-12-23T01:51:49.804135324+01:00","closed_at":"2025-12-23T01:51:49.804135324+01:00"}
{"id":"codex-sex.1","title":"Fix empty extracted context (capture OutputTextDelta)","description":"## Problem\nThe /handoff command shows empty 'Extracted Context' because streaming events are not captured.\n\n## Root Cause\nIn core/src/tasks/handoff.rs, `run_extraction()` only handles `OutputItemDone` but ignores `OutputTextDelta`:\n```rust\n_ =\u003e continue,  // OutputTextDelta is IGNORED!\n```\n\n## Fix\nAdd handler for OutputTextDelta:\n```rust\nOk(ResponseEvent::OutputTextDelta(delta)) =\u003e {\n    response_text.push_str(\u0026delta);\n}\n```\n\n## Files\n- core/src/tasks/handoff.rs - fix run_extraction()","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-22T23:38:05.470044915+01:00","updated_at":"2025-12-23T00:20:41.777073688+01:00","closed_at":"2025-12-23T00:20:41.777073688+01:00","dependencies":[{"issue_id":"codex-sex.1","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:38:05.470337677+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.2","title":"Context overflow protection (Head+Tail truncation)","description":"## Goal\nPrevent context overflow during handoff extraction by truncating large conversations.\n\n## Implementation\nIn core/src/tasks/handoff.rs run_extraction():\n1. Estimate token count of history\n2. If exceeds model context window, apply Head+Tail truncation\n3. Keep first message (original goal) + recent messages that fit\n4. Insert [... N messages omitted ...] placeholder\n\n## Note\nThis may already be partially implemented - check existing code first.\n\n## Files\n- core/src/tasks/handoff.rs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:38:14.339047225+01:00","updated_at":"2025-12-23T00:20:57.910497266+01:00","closed_at":"2025-12-23T00:20:57.910497266+01:00","dependencies":[{"issue_id":"codex-sex.2","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:38:14.339361259+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.3","title":"Record handoff in parent session rollout","description":"## Goal\nRecord handoff event in parent session's rollout for bidirectional traceability.\n\n## Implementation\n1. Op::ConfirmHandoff already has child_id field\n2. When confirmed, write RolloutItem::Handoff to parent's rollout\n3. Include: child_id, goal, timestamp\n\n## Why\n- Parent can see 'I handed off to child X for goal Y'\n- Enables future /children command to find handoff children\n- Complete audit trail\n\n## Files\n- protocol/src/protocol.rs - verify RolloutItem::Handoff exists\n- core/src/codex.rs - handle Op::ConfirmHandoff, write to rollout","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:38:24.944920362+01:00","updated_at":"2025-12-23T00:21:25.652355695+01:00","closed_at":"2025-12-23T00:21:25.652355695+01:00","dependencies":[{"issue_id":"codex-sex.3","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:38:24.94524172+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.4","title":"Editable handoff draft via EDITOR","description":"## Goal\nAllow user to edit handoff draft in external editor before confirming.\n\n## Current State\nCheck if 'e' key binding already exists in handoff review screen.\n\n## Implementation (if not done)\n1. Add 'e' key binding to handoff review\n2. Serialize draft to temp Markdown file\n3. Spawn $EDITOR, wait for exit\n4. Parse Markdown back to HandoffDraft\n\n## Markdown Format\n```markdown\n# Goal\n\u003cgoal\u003e\n\n# Summary\n\u003csummary\u003e\n\n# Relevant Files\nsrc/file1.rs\nsrc/file2.rs\n```\n\n## Files\n- tui/src/handoff_review.rs\n- tui/src/app.rs","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-22T23:38:34.283582971+01:00","updated_at":"2025-12-23T00:45:53.5094752+01:00","closed_at":"2025-12-23T00:45:53.5094752+01:00","dependencies":[{"issue_id":"codex-sex.4","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:38:34.283956302+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.5","title":"Implement read_parent_thread tool for handoff sessions","description":"## Goal\nAllow handoff child session to read back into parent's conversation history.\n\n## Why\n- Child only receives extracted context summary\n- May need details about specific decisions, code changes, discussions\n- Prevents context loss for complex tasks\n\n## Research\nLook at Amp's read_parent_thread implementation for reference.\n\n## Design Questions\n1. Read full thread or specific messages?\n2. How to rate-limit/token-budget?\n3. Read from rollout files or in-memory?\n4. Security: can child read sensitive parent content?\n\n## Implementation\n1. Add read_parent_thread tool spec\n2. Tool reads parent's rollout file using parent_id from SessionSource::Handoff\n3. Returns formatted conversation history","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-22T23:38:43.827419324+01:00","updated_at":"2025-12-23T01:11:36.263829748+01:00","closed_at":"2025-12-23T01:11:36.263829748+01:00","dependencies":[{"issue_id":"codex-sex.5","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:38:43.827743866+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.6","title":"Support handoff to different profile","description":"## Goal\nAllow user to specify a target profile when doing handoff.\n\n## Use Case\n- Current session uses 'default' profile with gpt-4\n- User wants to handoff to 'gemini-flash' profile for cheaper/faster work\n- /handoff should allow selecting target profile\n\n## Implementation\n1. Add optional profile selector to handoff review screen\n2. When confirming, create child session with specified profile\n3. Show available profiles in UI\n\n## Files\n- tui/src/handoff_review.rs - add profile selector\n- tui/src/app.rs - pass profile to create_handoff_conversation","status":"closed","priority":3,"issue_type":"feature","created_at":"2025-12-22T23:39:04.120587925+01:00","updated_at":"2025-12-23T01:51:35.069918909+01:00","closed_at":"2025-12-23T01:51:35.069918909+01:00","dependencies":[{"issue_id":"codex-sex.6","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:39:04.120946415+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-sex.7","title":"Use full-screen view for handoff review (like git warning)","description":"## Problem\nCurrent handoff review is rendered as a small widget within the chat area. Should use full-screen alternate screen view like the git warning prompt.\n\n## Current Implementation\n- tui/src/handoff_review.rs - HandoffReviewWidget renders in chat area\n- tui/src/app.rs - renders widget inline during draw\n\n## Target Implementation\nCopy pattern from tui/src/git_warning_prompt.rs:\n1. Use `tui.enter_alt_screen()` for full screen\n2. Create `run_handoff_review_prompt()` async function  \n3. Use AltScreenGuard pattern for cleanup\n4. Event loop handles keys until done\n5. Return HandoffReviewOutcome (Confirm/Edit/Cancel)\n\n## Benefits\n- More space for extracted context display\n- Consistent UX with other full-screen prompts\n- Can show scrollable content if summary is long\n- Animation/branding opportunity\n\n## REUSE: git_warning_prompt.rs pattern\n```rust\npub(crate) async fn run_handoff_review_prompt(\n    tui: \\u0026mut Tui,\n    draft: \\u0026HandoffDraft,\n) -\u003e HandoffReviewOutcome {\n    let alt = AltScreenGuard::enter(tui);\n    let mut screen = HandoffReviewScreen::new(draft, alt.tui.frame_requester());\n    \n    // Event loop\n    while !screen.is_done() {\n        // Handle TuiEvent::Key, TuiEvent::Draw\n    }\n    \n    screen.outcome()\n}\n```\n\n## Files\n- tui/src/handoff_review.rs - refactor to full-screen prompt\n- tui/src/app.rs - call run_handoff_review_prompt instead of rendering widget","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-22T23:40:02.042261025+01:00","updated_at":"2025-12-23T00:45:28.501559829+01:00","closed_at":"2025-12-23T00:45:28.501559829+01:00","dependencies":[{"issue_id":"codex-sex.7","depends_on_id":"codex-sex","type":"parent-child","created_at":"2025-12-22T23:40:02.042621453+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-si6","title":"Remove obsolete subagent isolation warning","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-10T13:59:31.21730853+01:00","updated_at":"2026-01-10T14:01:37.025535374+01:00","closed_at":"2026-01-10T14:01:37.025535374+01:00","close_reason":"Completed all tasks related to removing the obsolete subagent isolation warning and documentation."}
{"id":"codex-si6.1","title":"Remove git_warning_prompt.rs and references","description":"Remove tui/src/git_warning_prompt.rs and its usage in tui/src/app.rs since git isolation was removed.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T13:59:34.011099315+01:00","updated_at":"2026-01-10T14:01:27.207728145+01:00","closed_at":"2026-01-10T14:01:27.207728145+01:00","close_reason":"Removed git_warning_prompt.rs and its usage in app.rs.","dependencies":[{"issue_id":"codex-si6.1","depends_on_id":"codex-si6","type":"parent-child","created_at":"2026-01-10T13:59:34.122201165+01:00","created_by":"daemon"}]}
{"id":"codex-si6.2","title":"Clean up documentation regarding subagent isolation","description":"Update or remove documentation mentioning subagent isolation via git worktrees (e.g., codex-rs/docs/subagent-patch-merger-edge-cases.md).","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T13:59:36.150409451+01:00","updated_at":"2026-01-10T14:01:32.126068261+01:00","closed_at":"2026-01-10T14:01:32.126068261+01:00","close_reason":"Updated codex-rs/docs/subagent-patch-merger-edge-cases.md to reflect that git worktrees are no longer used for subagent isolation.","dependencies":[{"issue_id":"codex-si6.2","depends_on_id":"codex-si6","type":"parent-child","created_at":"2026-01-10T13:59:36.162638431+01:00","created_by":"daemon"}]}
{"id":"codex-tb6","title":"Fix canonical model IDs being sent as model slugs","description":"Regression: config now uses canonical model IDs (provider/model), but the rest of the system (Op::UserTurn, ModelFamily matching, provider request builders) expects a provider-specific model slug. Result: requests send 'openai/gpt-5.2' or 'gemini/gemini-3-flash-preview' as the model and providers return misleading 404/unsupported errors. Fix: store/propagate model_name (strip provider prefix) as the model slug used internally; keep canonical only for persistence/display.","status":"closed","issue_type":"bug","created_at":"2026-01-10T19:31:07.820750914+01:00","updated_at":"2026-01-10T20:07:57.447816344+01:00","closed_at":"2026-01-10T20:07:57.447816344+01:00","close_reason":"Fixed canonical model IDs; profile exec routes to correct providers; codex-core tests pass","dependencies":[{"issue_id":"codex-tb6","depends_on_id":"codex-pmh.3.4","type":"discovered-from","created_at":"2026-01-10T19:31:07.821381183+01:00","created_by":"daemon"}]}
{"id":"codex-te1","title":"Config v2: Typed provider-specific profile configuration","description":"## Problem\n\nCurrent config conflates wire format with provider identity. All profile fields are flat and shared across all provider types, making it impossible to express provider-specific configuration like OpenRouter's routing options.\n\n### Current Pain Points\n\n1. **No `ProviderKind::OpenRouter`** - OpenRouter masquerades as OpenAI with a different URL\n2. **No provider-specific profile config** - Can't express OpenRouter's `provider` routing field:\n   ```json\n   {\"provider\": {\"order\": [\"xai\"], \"allow_fallbacks\": false, \"data_collection\": \"deny\"}}\n   ```\n3. **Flat profile struct** - All fields are `Option\u003cT\u003e` with no validation based on provider type\n\n## Solution\n\nTwo-phase config parsing with strongly-typed provider-specific structs:\n\n1. Parse TOML into intermediate `ConfigProfileToml` with `provider: Option\u003ctoml::Table\u003e`\n2. Resolve `model_provider` → get `ProviderKind` from provider definition  \n3. Deserialize raw table into correct typed struct based on `ProviderKind`\n4. Hard error if fields don't match provider type\n\n### Target Config Shape\n\n```toml\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"  # NEW variant\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\nwire_api = \"responses\"\n\n[profiles.grok]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\nmodel_reasoning_effort = \"high\"\n\n[profiles.grok.provider]  # Provider-specific overrides\nrouting.order = [\"xai\"]\nrouting.allow_fallbacks = false\nrouting.data_collection = \"deny\"\n```\n\n### Type Structure\n\n```rust\n// Intermediate parsing\nstruct ConfigProfileToml {\n    // ... existing flat fields ...\n    #[serde(default)]\n    provider: Option\u003ctoml::Table\u003e,\n}\n\n// Typed provider configs (deny_unknown_fields)\nstruct OpenRouterProfileConfig {\n    routing: Option\u003cOpenRouterRouting\u003e,\n}\n\nstruct OpenRouterRouting {\n    order: Option\u003cVec\u003cString\u003e\u003e,\n    allow_fallbacks: Option\u003cbool\u003e,\n    require_parameters: Option\u003cbool\u003e,\n    data_collection: Option\u003cString\u003e,\n    // ... full OpenRouter spec\n}\n\n// Resolved enum\nenum ProviderProfileConfig {\n    OpenRouter(OpenRouterProfileConfig),\n    OpenAi(OpenAiProfileConfig),\n    Anthropic(AnthropicProfileConfig),\n    Gemini(GeminiProfileConfig),\n    None,\n}\n```\n\n## Key Design Decisions\n\n1. **No untagged enums** - Discriminator comes from provider definition, not profile itself\n2. **No repetition** - Provider type declared ONCE on provider definition\n3. **Flat common fields** - Cross-cutting settings stay flat in profile\n4. **deny_unknown_fields** - Typos and wrong-provider fields cause hard errors\n5. **Two-phase parse** - Parse TOML once, then typed conversion once (not \"parsing twice\")\n\n## Acceptance Criteria\n\n- [ ] `ProviderKind::OpenRouter` variant exists\n- [ ] OpenRouter routing config injectable into Responses requests\n- [ ] Config validation rejects wrong-provider fields\n- [ ] Existing configs continue to work (backward compatible for providers without specific config)\n- [ ] Documentation updated with OpenRouter example","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-14T16:44:35.267190006+01:00","updated_at":"2025-12-14T17:28:14.873995376+01:00","closed_at":"2025-12-14T17:28:14.873995376+01:00"}
{"id":"codex-te1.1","title":"Add ProviderKind::OpenRouter variant","description":"## What\n\nAdd `OpenRouter` variant to the `ProviderKind` enum and update all match arms.\n\n## Why\n\nOpenRouter is a distinct provider with its own capabilities (routing, provider preferences, data policies). Currently it masquerades as OpenAI with a different URL, which prevents expressing OpenRouter-specific features.\n\n## Where\n\n**Primary file:** `codex-rs/core/src/model_provider_info.rs`\n\n## How\n\n### 1. Add enum variant\n\n```rust\n#[derive(Debug, Clone, Copy, Default, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum ProviderKind {\n    #[default]\n    OpenAi,\n    Anthropic,\n    Gemini,\n    Antigravity,\n    OpenRouter,  // NEW\n}\n```\n\n### 2. Update wire_api inference in deserializer\n\n```rust\nlet wire_api = raw.wire_api.unwrap_or(match provider_kind {\n    ProviderKind::Anthropic =\u003e WireApi::Anthropic,\n    ProviderKind::Gemini =\u003e WireApi::Gemini,\n    ProviderKind::Antigravity =\u003e WireApi::Antigravity,\n    ProviderKind::OpenAi =\u003e WireApi::Chat,\n    ProviderKind::OpenRouter =\u003e WireApi::Responses,  // NEW - OpenRouter defaults to Responses API\n});\n```\n\n### 3. Find and update all match arms\n\nSearch for `ProviderKind::` and `match.*provider_kind` to find all places that need updating.\n\n## Testing\n\n```rust\n#[test]\nfn deserializes_openrouter_provider() {\n    let toml = r#\"\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\n    \"#;\n    \n    let provider: ModelProviderInfo = toml::from_str(toml).unwrap();\n    assert_eq!(provider.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(provider.wire_api, WireApi::Responses);\n}\n\n#[test]\nfn openrouter_can_use_chat_wire_api() {\n    let toml = r#\"\nname = \"OpenRouter Chat\"\nprovider_kind = \"openrouter\"\nwire_api = \"chat\"\nbase_url = \"https://openrouter.ai/api/v1\"\n    \"#;\n    \n    let provider: ModelProviderInfo = toml::from_str(toml).unwrap();\n    assert_eq!(provider.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(provider.wire_api, WireApi::Chat);  // Explicit override\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `ProviderKind::OpenRouter` variant exists\n- [ ] Serializes as `\"openrouter\"` in TOML/JSON\n- [ ] Default wire_api is `Responses` for OpenRouter\n- [ ] Can override wire_api explicitly\n- [ ] All match arms updated (no compiler warnings)\n- [ ] `cargo test -p codex-core` passes\n- [ ] `just fix -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:45:29.846153598+01:00","updated_at":"2025-12-14T17:00:07.795358202+01:00","closed_at":"2025-12-14T17:00:07.795358202+01:00","dependencies":[{"issue_id":"codex-te1.1","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:45:29.846552189+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.2","title":"Define OpenRouter routing types","description":"## What\n\nCreate strongly-typed structs for OpenRouter's `provider` routing configuration, matching the OpenRouter API spec.\n\n## Why\n\nOpenRouter's Responses API accepts a `provider` field to control routing preferences, fallbacks, data collection policies, and more. These need typed representations for:\n1. Config parsing with validation\n2. Serialization into request bodies\n\n## Where\n\n**New file:** `codex-rs/core/src/openrouter_types.rs`  \n**Update:** `codex-rs/core/src/lib.rs` (add module)\n\n## How\n\n### OpenRouter Provider Routing Spec\n\nFrom https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider:\n\n```rust\nuse serde::{Deserialize, Serialize};\n\n/// OpenRouter provider routing configuration.\n/// Controls which providers serve requests and under what conditions.\n/// \n/// Reference: https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider\n#[derive(Debug, Clone, Default, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterRouting {\n    /// Ordered list of provider names to try. Empty = use OpenRouter's default ranking.\n    /// Example: [\"anthropic\", \"openai\"]\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub order: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// If true, allow fallback to other providers when preferred ones fail.\n    /// Default: true\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub allow_fallbacks: Option\u003cbool\u003e,\n\n    /// If true, only route to providers that support all request parameters.\n    /// Default: true  \n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub require_parameters: Option\u003cbool\u003e,\n\n    /// Data collection policy: \"allow\" or \"deny\".\n    /// Controls whether providers can use request data for training.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub data_collection: Option\u003cDataCollectionPolicy\u003e,\n\n    /// Zero Data Retention: if true, route only to providers with ZDR agreements.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub zdr: Option\u003cbool\u003e,\n\n    /// If true, only route to providers that guarantee distillable output.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub enforce_distillable_text: Option\u003cbool\u003e,\n\n    /// Only use these specific providers (exclusive list).\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub only: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Never use these providers.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub ignore: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Allowed quantization levels: [\"int4\", \"int8\", \"fp6\", \"fp8\", \"fp16\", \"bf16\", \"unknown\"]\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub quantizations: Option\u003cVec\u003cString\u003e\u003e,\n\n    /// Sort preference for provider ranking.\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub sort: Option\u003cProviderSort\u003e,\n\n    /// Maximum price per million tokens (in USD).\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub max_price: Option\u003cMaxPrice\u003e,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum DataCollectionPolicy {\n    Allow,\n    Deny,\n}\n\n#[derive(Debug, Clone, Copy, PartialEq, Eq, Serialize, Deserialize)]\n#[serde(rename_all = \"lowercase\")]\npub enum ProviderSort {\n    /// Sort by price (cheapest first)\n    Price,\n    /// Sort by throughput (fastest first)  \n    Throughput,\n    /// Sort by latency (lowest first)\n    Latency,\n}\n\n#[derive(Debug, Clone, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct MaxPrice {\n    /// Max price for prompt tokens (per million)\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub prompt: Option\u003cf64\u003e,\n    /// Max price for completion tokens (per million)\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub completion: Option\u003cf64\u003e,\n    /// Max price for request (flat rate)\n    #[serde(skip_serializing_if = \"Option::is_none\")]  \n    pub request: Option\u003cf64\u003e,\n    /// Max price for image processing\n    #[serde(skip_serializing_if = \"Option::is_none\")]\n    pub image: Option\u003cf64\u003e,\n}\n```\n\n### Profile Config Wrapper\n\n```rust\n/// OpenRouter-specific profile configuration.\n/// Parsed from [profiles.\u003cname\u003e.provider] when provider_kind is OpenRouter.\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterProfileConfig {\n    /// Routing preferences for this profile.\n    #[serde(default)]\n    pub routing: Option\u003cOpenRouterRouting\u003e,\n}\n```\n\n## Testing\n\n```rust\n#[test]\nfn parse_openrouter_routing_minimal() {\n    let toml = r#\"\nrouting.order = [\"xai\"]\n    \"#;\n    let config: OpenRouterProfileConfig = toml::from_str(toml).unwrap();\n    assert_eq!(config.routing.unwrap().order, Some(vec![\"xai\".to_string()]));\n}\n\n#[test]\nfn parse_openrouter_routing_full() {\n    let toml = r#\"\n[routing]\norder = [\"anthropic\", \"openai\"]\nallow_fallbacks = false\nrequire_parameters = true\ndata_collection = \"deny\"\nzdr = true\n    \"#;\n    let config: OpenRouterProfileConfig = toml::from_str(toml).unwrap();\n    let routing = config.routing.unwrap();\n    assert_eq!(routing.allow_fallbacks, Some(false));\n    assert_eq!(routing.data_collection, Some(DataCollectionPolicy::Deny));\n}\n\n#[test]\nfn reject_unknown_fields() {\n    let toml = r#\"\nrouting.unknown_field = true\n    \"#;\n    let result: Result\u003cOpenRouterProfileConfig, _\u003e = toml::from_str(toml);\n    assert!(result.is_err());\n}\n\n#[test]\nfn serialize_for_request_body() {\n    let routing = OpenRouterRouting {\n        order: Some(vec![\"xai\".to_string()]),\n        allow_fallbacks: Some(false),\n        ..Default::default()\n    };\n    let json = serde_json::to_value(\u0026routing).unwrap();\n    assert_eq!(json[\"order\"], serde_json::json!([\"xai\"]));\n    assert_eq!(json[\"allow_fallbacks\"], serde_json::json!(false));\n    // Verify None fields are skipped\n    assert!(json.get(\"data_collection\").is_none());\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `OpenRouterRouting` struct with all OpenRouter provider fields\n- [ ] `OpenRouterProfileConfig` wrapper for profile parsing\n- [ ] `deny_unknown_fields` on all structs\n- [ ] Proper `skip_serializing_if` for optional fields\n- [ ] Tests for parsing and serialization\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:46:11.910684602+01:00","updated_at":"2025-12-14T16:58:39.353302147+01:00","closed_at":"2025-12-14T16:58:39.353302147+01:00","dependencies":[{"issue_id":"codex-te1.2","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:46:11.911429665+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.3","title":"Add provider table to ConfigProfile with two-phase parsing","description":"## What\n\nModify `ConfigProfile` to accept an optional `[profiles.\u003cname\u003e.provider]` table, then add resolution logic to convert it into typed `ProviderProfileConfig` based on the resolved `ProviderKind`.\n\n## Why\n\nThis is the core mechanism that enables provider-specific configuration without untagged enum ambiguity. The discriminator (provider type) comes from the provider definition, not from the profile config itself.\n\n## Where\n\n**Primary files:**\n- `codex-rs/core/src/config/profile.rs` - Add `provider` field\n- `codex-rs/core/src/config/mod.rs` - Add resolution logic\n\n## How\n\n### 1. Update ConfigProfile to capture raw table\n\n```rust\n// profile.rs\nuse serde::Deserialize;\nuse toml::Table as TomlTable;\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\npub struct ConfigProfile {\n    pub model: Option\u003cString\u003e,\n    pub model_provider: Option\u003cString\u003e,\n    pub approval_policy: Option\u003cAskForApproval\u003e,\n    // ... existing fields ...\n    \n    /// Provider-specific configuration.\n    /// Parsed as raw TOML table, then validated against resolved ProviderKind.\n    #[serde(default)]\n    pub provider: Option\u003cTomlTable\u003e,\n}\n```\n\n### 2. Create ProviderProfileConfig enum\n\n```rust\n// New file: config/provider_profile.rs (or in profile.rs)\nuse crate::openrouter_types::OpenRouterProfileConfig;\n\n/// Resolved provider-specific profile configuration.\n#[derive(Debug, Clone, PartialEq)]\npub enum ProviderProfileConfig {\n    /// OpenRouter routing and preferences\n    OpenRouter(OpenRouterProfileConfig),\n    /// OpenAI-specific settings (reasoning, etc.) - future\n    OpenAi(OpenAiProfileConfig),\n    /// Anthropic-specific settings - future\n    Anthropic(AnthropicProfileConfig),\n    /// Gemini-specific settings - future\n    Gemini(GeminiProfileConfig),\n    /// Provider has no specific config or none was provided\n    None,\n}\n\n// Placeholder structs for future expansion\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenAiProfileConfig {\n    // Future: reasoning_effort, reasoning_summary, etc.\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct AnthropicProfileConfig {\n    // Future: thinking, beta flags, etc.\n}\n\n#[derive(Debug, Clone, Default, PartialEq, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct GeminiProfileConfig {\n    // Future: safety_settings, etc.\n}\n```\n\n### 3. Add resolution function\n\n```rust\n// config/mod.rs or config/provider_profile.rs\n\nuse crate::model_provider_info::ProviderKind;\nuse crate::error::CodexErr;\n\n/// Resolve raw provider config table into typed struct based on provider kind.\npub fn resolve_provider_config(\n    raw_table: Option\u003c\u0026TomlTable\u003e,\n    provider_kind: ProviderKind,\n    profile_name: \u0026str,\n) -\u003e Result\u003cProviderProfileConfig, CodexErr\u003e {\n    let Some(table) = raw_table else {\n        return Ok(ProviderProfileConfig::None);\n    };\n    \n    // Convert toml::Table to toml::Value for deserialization\n    let value = toml::Value::Table(table.clone());\n    \n    match provider_kind {\n        ProviderKind::OpenRouter =\u003e {\n            let config: OpenRouterProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid OpenRouter config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::OpenRouter(config))\n        }\n        ProviderKind::OpenAi =\u003e {\n            let config: OpenAiProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid OpenAI config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::OpenAi(config))\n        }\n        ProviderKind::Anthropic =\u003e {\n            let config: AnthropicProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid Anthropic config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::Anthropic(config))\n        }\n        ProviderKind::Gemini =\u003e {\n            let config: GeminiProfileConfig = value.try_into().map_err(|e| {\n                CodexErr::ConfigError(format!(\n                    \"Invalid Gemini config in profile '{profile_name}': {e}\"\n                ))\n            })?;\n            Ok(ProviderProfileConfig::Gemini(config))\n        }\n        ProviderKind::Antigravity =\u003e {\n            // Antigravity doesn't have provider-specific config\n            if !table.is_empty() {\n                return Err(CodexErr::ConfigError(format!(\n                    \"Profile '{profile_name}' has [provider] config but Antigravity doesn't support it\"\n                )));\n            }\n            Ok(ProviderProfileConfig::None)\n        }\n    }\n}\n```\n\n### 4. Integrate into config loading\n\nIn `Config::load_from_base_config_with_overrides`, after resolving the provider:\n\n```rust\n// After resolving model_provider -\u003e ModelProviderInfo\nlet provider_profile_config = resolve_provider_config(\n    profile.provider.as_ref(),\n    model_provider.provider_kind,\n    \u0026profile_name,\n)?;\n\n// Store in Config struct (add new field)\nConfig {\n    // ... existing fields ...\n    provider_profile_config,\n}\n```\n\n## Testing\n\n```rust\n#[test]\nfn resolve_openrouter_provider_config() {\n    let mut table = TomlTable::new();\n    let mut routing = TomlTable::new();\n    routing.insert(\"order\".into(), toml::Value::Array(vec![\"xai\".into()]));\n    table.insert(\"routing\".into(), toml::Value::Table(routing));\n    \n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    match result {\n        ProviderProfileConfig::OpenRouter(config) =\u003e {\n            assert_eq!(config.routing.unwrap().order, Some(vec![\"xai\".to_string()]));\n        }\n        _ =\u003e panic!(\"Expected OpenRouter config\"),\n    }\n}\n\n#[test]\nfn reject_openrouter_config_on_openai_provider() {\n    let mut table = TomlTable::new();\n    let mut routing = TomlTable::new();\n    routing.insert(\"order\".into(), toml::Value::Array(vec![\"xai\".into()]));\n    table.insert(\"routing\".into(), toml::Value::Table(routing));\n    \n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenAi,  // Wrong provider!\n        \"test-profile\",\n    );\n    \n    // Should fail because OpenAiProfileConfig has deny_unknown_fields\n    // and doesn't have a 'routing' field\n    assert!(result.is_err());\n}\n\n#[test]\nfn empty_provider_table_is_ok() {\n    let table = TomlTable::new();\n    let result = resolve_provider_config(\n        Some(\u0026table),\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    match result {\n        ProviderProfileConfig::OpenRouter(config) =\u003e {\n            assert!(config.routing.is_none());\n        }\n        _ =\u003e panic!(\"Expected OpenRouter config\"),\n    }\n}\n\n#[test]\nfn no_provider_table_returns_none() {\n    let result = resolve_provider_config(\n        None,\n        ProviderKind::OpenRouter,\n        \"test-profile\",\n    ).unwrap();\n    \n    assert!(matches!(result, ProviderProfileConfig::None));\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `ConfigProfile.provider: Option\u003cTomlTable\u003e` field added\n- [ ] `ProviderProfileConfig` enum with variants for each provider\n- [ ] `resolve_provider_config()` function correctly dispatches by ProviderKind\n- [ ] Unknown fields in provider config cause hard errors\n- [ ] Config loading integrates resolution\n- [ ] Tests for all provider kinds\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:46:57.881351131+01:00","updated_at":"2025-12-14T17:15:53.698347257+01:00","closed_at":"2025-12-14T17:15:53.698347257+01:00","dependencies":[{"issue_id":"codex-te1.3","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:46:57.88185829+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.3","depends_on_id":"codex-te1.1","type":"blocks","created_at":"2025-12-14T16:49:01.902575203+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.3","depends_on_id":"codex-te1.2","type":"blocks","created_at":"2025-12-14T16:49:12.016769291+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.4","title":"Inject OpenRouter routing into Responses request body","description":"## What\n\nWhen the provider is OpenRouter and the profile has routing config, inject it as the `provider` field in the Responses API request body.\n\n## Why\n\nThis is the actual feature delivery - allowing users to control OpenRouter's provider routing via config.\n\n## Where\n\n**Primary files:**\n- `codex-rs/core/src/api_bridge.rs` - Where requests are built\n- `codex-rs/codex-api/src/requests/responses.rs` - ResponsesRequestBuilder\n\n## How\n\n### Option A: Modify ResponsesRequestBuilder\n\nAdd a method to inject provider-specific body fields:\n\n```rust\n// codex-api/src/requests/responses.rs\n\nimpl\u003c'a\u003e ResponsesRequestBuilder\u003c'a\u003e {\n    // ... existing methods ...\n    \n    /// Inject provider-specific fields into the request body.\n    /// For OpenRouter, this adds the \"provider\" routing configuration.\n    pub fn provider_config(mut self, config: Option\u003cserde_json::Value\u003e) -\u003e Self {\n        self.provider_config = config;\n        self\n    }\n}\n\n// In build():\nif let Some(provider_config) = self.provider_config {\n    if let Some(obj) = body.as_object_mut() {\n        obj.insert(\"provider\".to_string(), provider_config);\n    }\n}\n```\n\n### Option B: Post-process in api_bridge\n\nModify the body after building the request:\n\n```rust\n// core/src/api_bridge.rs\n\nfn build_responses_request(\n    // ... existing params ...\n    provider_profile_config: \u0026ProviderProfileConfig,\n) -\u003e Result\u003cResponsesRequest, CodexErr\u003e {\n    let mut request = ResponsesRequestBuilder::new(model, instructions, input)\n        // ... existing builder calls ...\n        .build(provider)?;\n    \n    // Inject OpenRouter routing if present\n    if let ProviderProfileConfig::OpenRouter(config) = provider_profile_config {\n        if let Some(routing) = \u0026config.routing {\n            if let Some(obj) = request.body.as_object_mut() {\n                let provider_value = serde_json::to_value(routing)\n                    .map_err(|e| CodexErr::Internal(format!(\"Failed to serialize OpenRouter routing: {e}\")))?;\n                obj.insert(\"provider\".to_string(), provider_value);\n            }\n        }\n    }\n    \n    Ok(request)\n}\n```\n\n### Request Body Example\n\nBefore:\n```json\n{\n  \"model\": \"x-ai/grok-4.1-fast\",\n  \"instructions\": \"...\",\n  \"input\": [...],\n  \"stream\": true\n}\n```\n\nAfter (with OpenRouter routing):\n```json\n{\n  \"model\": \"x-ai/grok-4.1-fast\",\n  \"instructions\": \"...\",\n  \"input\": [...],\n  \"stream\": true,\n  \"provider\": {\n    \"order\": [\"xai\"],\n    \"allow_fallbacks\": false,\n    \"data_collection\": \"deny\"\n  }\n}\n```\n\n### Thread provider config through the call stack\n\nThe `ProviderProfileConfig` needs to be available where requests are built. Trace the path:\n\n1. `Config` struct holds `provider_profile_config: ProviderProfileConfig`\n2. `Codex::new()` receives `Config`\n3. Request building functions need access to it\n\n## Testing\n\n```rust\n#[test]\nfn openrouter_routing_injected_into_request() {\n    let routing = OpenRouterRouting {\n        order: Some(vec![\"xai\".to_string()]),\n        allow_fallbacks: Some(false),\n        ..Default::default()\n    };\n    let config = ProviderProfileConfig::OpenRouter(OpenRouterProfileConfig {\n        routing: Some(routing),\n    });\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    let provider = request.body.get(\"provider\").expect(\"provider field should exist\");\n    assert_eq!(provider[\"order\"], serde_json::json!([\"xai\"]));\n    assert_eq!(provider[\"allow_fallbacks\"], serde_json::json!(false));\n}\n\n#[test]\nfn non_openrouter_provider_has_no_provider_field() {\n    let config = ProviderProfileConfig::OpenAi(OpenAiProfileConfig::default());\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    assert!(request.body.get(\"provider\").is_none());\n}\n\n#[test]\nfn openrouter_without_routing_has_no_provider_field() {\n    let config = ProviderProfileConfig::OpenRouter(OpenRouterProfileConfig {\n        routing: None,\n    });\n    \n    let request = build_responses_request(\n        // ... test params ...\n        \u0026config,\n    ).unwrap();\n    \n    assert!(request.body.get(\"provider\").is_none());\n}\n```\n\n### Integration Test\n\n```rust\n#[tokio::test]\nasync fn openrouter_routing_sent_to_server() {\n    let config_toml = r#\"\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"http://localhost:PORT\"\nwire_api = \"responses\"\n\n[profiles.test]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\n\n[profiles.test.provider]\nrouting.order = [\"xai\"]\nrouting.allow_fallbacks = false\n    \"#;\n    \n    // Set up mock server\n    let server = MockServer::start().await;\n    let mock = server.mock(|when, then| {\n        when.method(POST)\n            .path(\"/responses\")\n            .json_body_partial(json!({\n                \"provider\": {\n                    \"order\": [\"xai\"],\n                    \"allow_fallbacks\": false\n                }\n            }));\n        then.status(200).body(sse_response());\n    });\n    \n    // Run codex with config\n    // ... test setup ...\n    \n    mock.assert();\n}\n```\n\n## Acceptance Criteria\n\n- [ ] OpenRouter routing config serialized into `provider` field\n- [ ] Only injected when provider_kind is OpenRouter AND routing is Some\n- [ ] Non-OpenRouter providers don't get `provider` field\n- [ ] Request body structure matches OpenRouter API spec\n- [ ] Unit tests pass\n- [ ] Integration test verifies actual request sent to mock server\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-14T16:47:37.539339392+01:00","updated_at":"2025-12-14T17:22:49.408467447+01:00","closed_at":"2025-12-14T17:22:49.408467447+01:00","dependencies":[{"issue_id":"codex-te1.4","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:47:37.540365722+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.4","depends_on_id":"codex-te1.3","type":"blocks","created_at":"2025-12-14T16:49:06.959562503+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.5","title":"Add built-in OpenRouter provider definition","description":"## What\n\nAdd OpenRouter as a built-in provider in `built_in_model_providers()` so users don't need to define it manually.\n\n## Why\n\nOpenRouter is a popular meta-provider. Having it built-in improves UX - users just need to set `OPENROUTER_API_KEY` and select the provider.\n\n## Where\n\n**File:** `codex-rs/core/src/model_provider_info.rs`\n\n## How\n\n```rust\npub fn built_in_model_providers() -\u003e HashMap\u003cString, ModelProviderInfo\u003e {\n    use ModelProviderInfo as P;\n\n    [\n        (\"openai\", P::create_openai_provider()),\n        (\n            \"anthropic\",\n            P {\n                name: \"Anthropic\".into(),\n                // ... existing ...\n            },\n        ),\n        (\n            \"gemini\",\n            P {\n                name: \"Gemini\".into(),\n                // ... existing ...\n            },\n        ),\n        // NEW: OpenRouter\n        (\n            \"openrouter\",\n            P {\n                name: \"OpenRouter\".into(),\n                base_url: Some(\"https://openrouter.ai/api/v1\".into()),\n                env_key: Some(\"OPENROUTER_API_KEY\".to_string()),\n                env_key_instructions: Some(\n                    \"Get your API key at https://openrouter.ai/keys\".into()\n                ),\n                experimental_bearer_token: None,\n                wire_api: WireApi::Responses,\n                provider_kind: ProviderKind::OpenRouter,\n                query_params: None,\n                http_headers: None,\n                env_http_headers: None,\n                request_max_retries: Some(DEFAULT_REQUEST_MAX_RETRIES),\n                stream_max_retries: Some(DEFAULT_STREAM_MAX_RETRIES),\n                stream_idle_timeout_ms: Some(DEFAULT_STREAM_IDLE_TIMEOUT_MS),\n                requires_openai_auth: false,\n                api_key_env_var: None,\n                version: None,\n                beta: None,\n                project_id: None,\n                use_bearer_auth: true,  // OpenRouter uses Bearer auth\n            },\n        ),\n    ]\n    .into_iter()\n    .map(|(k, v)| (k.to_string(), v))\n    .collect()\n}\n```\n\n## Usage After Implementation\n\nUsers can immediately use OpenRouter:\n\n```bash\nexport OPENROUTER_API_KEY=\"sk-or-...\"\ncodex --model-provider openrouter --model anthropic/claude-3.5-sonnet\n```\n\nOr in config.toml:\n\n```toml\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\n\n[profiles.grok.provider]\nrouting.order = [\"xai\"]\n```\n\n## Testing\n\n```rust\n#[test]\nfn built_in_providers_includes_openrouter() {\n    let providers = built_in_model_providers();\n    \n    let openrouter = providers.get(\"openrouter\").expect(\"openrouter should exist\");\n    assert_eq!(openrouter.name, \"OpenRouter\");\n    assert_eq!(openrouter.provider_kind, ProviderKind::OpenRouter);\n    assert_eq!(openrouter.wire_api, WireApi::Responses);\n    assert_eq!(openrouter.env_key, Some(\"OPENROUTER_API_KEY\".to_string()));\n    assert!(openrouter.use_bearer_auth);\n}\n```\n\n## Acceptance Criteria\n\n- [ ] `openrouter` key in built_in_model_providers()\n- [ ] Correct base_url, env_key, wire_api, provider_kind\n- [ ] Uses Bearer auth (not x-api-key header)\n- [ ] Has helpful env_key_instructions\n- [ ] Test verifies built-in exists\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T16:48:03.772273563+01:00","updated_at":"2025-12-14T17:04:23.064987727+01:00","closed_at":"2025-12-14T17:04:23.064987727+01:00","dependencies":[{"issue_id":"codex-te1.5","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:48:03.772980944+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.5","depends_on_id":"codex-te1.1","type":"blocks","created_at":"2025-12-14T16:49:17.076247825+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-te1.6","title":"Update documentation with OpenRouter config example","description":"## What\n\nAdd documentation for the new provider-specific configuration system, with OpenRouter as the primary example.\n\n## Why\n\nUsers need to know:\n1. How to configure OpenRouter routing\n2. The general pattern for provider-specific config\n3. What fields are available\n\n## Where\n\n**Files to update:**\n- `docs/config.md` (or equivalent config documentation)\n- `codex-rs/core/src/model_provider_info.rs` (doc comments)\n\n## How\n\n### Config Documentation Section\n\n```markdown\n## Provider-Specific Configuration\n\nSome providers support additional configuration beyond the standard profile fields.\nThese are specified in a `[profiles.\u003cname\u003e.provider]` table.\n\n### OpenRouter\n\nOpenRouter supports routing preferences to control which underlying providers \nserve your requests.\n\n```toml\n[model_providers.openrouter]\nname = \"OpenRouter\"\nprovider_kind = \"openrouter\"\nbase_url = \"https://openrouter.ai/api/v1\"\nenv_key = \"OPENROUTER_API_KEY\"\nwire_api = \"responses\"\n\n[profiles.my-profile]\nmodel_provider = \"openrouter\"\nmodel = \"x-ai/grok-4.1-fast\"\nmodel_reasoning_effort = \"high\"\n\n# OpenRouter-specific routing configuration\n[profiles.my-profile.provider]\nrouting.order = [\"xai\"]                    # Preferred providers, in order\nrouting.allow_fallbacks = false            # Don't fall back to other providers\nrouting.require_parameters = true          # Only use providers supporting all params\nrouting.data_collection = \"deny\"           # Opt out of training data collection\n```\n\n#### Available Routing Options\n\n| Field | Type | Description |\n|-------|------|-------------|\n| `order` | string[] | Ordered list of preferred provider names |\n| `allow_fallbacks` | bool | Allow fallback to non-preferred providers (default: true) |\n| `require_parameters` | bool | Only use providers supporting all request params (default: true) |\n| `data_collection` | \"allow\" \\| \"deny\" | Control training data collection |\n| `zdr` | bool | Zero Data Retention - only use providers with ZDR agreements |\n| `only` | string[] | Exclusive list of allowed providers |\n| `ignore` | string[] | Providers to never use |\n| `sort` | \"price\" \\| \"throughput\" \\| \"latency\" | Sort preference for provider ranking |\n| `max_price.prompt` | float | Max price per million prompt tokens (USD) |\n| `max_price.completion` | float | Max price per million completion tokens (USD) |\n\nSee [OpenRouter Provider Routing](https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider) for full details.\n\n### Other Providers\n\nOther providers have their own `[profiles.\u003cname\u003e.provider]` options:\n\n- **OpenAI**: (planned) reasoning_effort, reasoning_summary\n- **Anthropic**: (planned) thinking settings, beta flags\n- **Gemini**: (planned) safety_settings\n\nUsing options for the wrong provider type will result in a configuration error.\n```\n\n### Inline Doc Comments\n\nAdd to `OpenRouterRouting` struct:\n\n```rust\n/// OpenRouter provider routing configuration.\n/// \n/// Configure which underlying providers serve requests and under what conditions.\n/// Set via `[profiles.\u003cname\u003e.provider.routing]` in config.toml.\n/// \n/// # Example\n/// \n/// ```toml\n/// [profiles.my-profile.provider]\n/// routing.order = [\"xai\", \"openai\"]\n/// routing.allow_fallbacks = false\n/// routing.data_collection = \"deny\"\n/// ```\n/// \n/// Reference: https://openrouter.ai/docs/api/api-reference/responses/create-responses#request.body.provider\n#[derive(Debug, Clone, Default, PartialEq, Serialize, Deserialize)]\n#[serde(deny_unknown_fields)]\npub struct OpenRouterRouting {\n    // ...\n}\n```\n\n## Acceptance Criteria\n\n- [ ] Config.md updated with provider-specific config section\n- [ ] OpenRouter example is complete and correct\n- [ ] All routing options documented with types\n- [ ] Link to OpenRouter API docs\n- [ ] Inline doc comments on OpenRouterRouting struct\n- [ ] Note about wrong-provider errors\n- [ ] Placeholder notes for other provider configs","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-14T16:48:35.921077052+01:00","updated_at":"2025-12-14T17:27:04.95454122+01:00","closed_at":"2025-12-14T17:27:04.95454122+01:00","dependencies":[{"issue_id":"codex-te1.6","depends_on_id":"codex-te1","type":"parent-child","created_at":"2025-12-14T16:48:35.921643022+01:00","created_by":"ribelo","metadata":"{}"},{"issue_id":"codex-te1.6","depends_on_id":"codex-te1.4","type":"blocks","created_at":"2025-12-14T16:48:56.847503698+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-u12","title":"Use model_context_window from config for context percentage calculation","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-07T16:13:59.274785935+01:00","updated_at":"2025-12-07T16:18:05.979811379+01:00","closed_at":"2025-12-07T16:18:05.979811379+01:00"}
{"id":"codex-u3a","title":"Subagents: support reasoning_effort in frontmatter","description":"Add a new subagent frontmatter field (recommended: reasoning_effort: inherit|low|medium|high|xhigh) and apply it when spawning subagent sessions (task tool + any other subagent entrypoints). Update docs and add/adjust tests; run fmt, clippy fix, cargo check --bin codex, and relevant crate tests.","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-11T14:06:05.294148855+01:00","updated_at":"2026-01-11T14:12:05.046805499+01:00","closed_at":"2026-01-11T14:12:05.046805499+01:00","close_reason":"Implemented reasoning_effort in subagent frontmatter, updated task handler and read_session tool to apply the override, updated documentation and added tests.","dependencies":[{"issue_id":"codex-u3a","depends_on_id":"codex-pmh.4","type":"discovered-from","created_at":"2026-01-11T14:06:05.308897967+01:00","created_by":"daemon"}]}
{"id":"codex-vcp","title":"Subagent Patch Merger Improvements","description":"Epic for fixing intermittent failures and edge cases in the subagent patch merger system.\n\n## Background\nThe subagent worktree isolation system uses git worktrees to isolate subagent file changes, then merges them back to the parent workspace. Investigation revealed several edge cases that can cause intermittent failures.\n\n## Root Cause Analysis\nSee codex-rs/docs/subagent-patch-merger-edge-cases.md for complete analysis.\n\n## Key Files\n- core/src/worktree_manager.rs - Worktree creation, diff generation, patch application\n- core/src/tools/handlers/task.rs - Task tool handler, merge orchestration\n- protocol/src/subagent_changes.rs - Protocol types for merge status\n\n## Success Criteria\n- Intermittent 'merge failed' errors reduced by 90%+\n- Clear user feedback when conflicts occur\n- Robust handling of edge cases","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-29T00:10:29.871852623+01:00","updated_at":"2025-12-29T03:01:36.495355065+01:00","closed_at":"2025-12-29T03:01:36.495355065+01:00"}
{"id":"codex-vcp.1","title":"Add retry loop for git index.lock contention","description":"## Problem\nWhen the user runs git commands (commit, pull, status) while a subagent is trying to merge, `git apply` fails because it cannot acquire `.git/index.lock`. This is the most likely cause of intermittent 'merge failed' errors.\n\n## Current Behavior\n1. Subagent finishes and tries to `git apply`\n2. User's terminal holds `.git/index.lock`\n3. `git apply` fails immediately with 'Unable to create index.lock'\n4. Code falls through to `--3way` which also fails\n5. `detect_conflict_markers` finds nothing\n6. Result: PatchApplyResult::Conflict - patch saved\n\n## Solution\nWrap `git apply` calls in a retry loop (3 attempts, exponential backoff) that specifically catches index.lock errors.\n\n## Implementation\nIn `core/src/worktree_manager.rs`, modify `apply_patch`:\n\n```rust\nconst MAX_RETRY_ATTEMPTS: u32 = 3;\nconst INITIAL_RETRY_DELAY_MS: u64 = 100;\n\n// In apply_patch, wrap the git apply call:\nfor attempt in 0..MAX_RETRY_ATTEMPTS {\n    let apply_output = Command::new(\"git\")\n        .arg(\"apply\")\n        .arg(\u0026patch_file)\n        .current_dir(target_dir)\n        .output()\n        .await?;\n    \n    if apply_output.status.success() {\n        break;\n    }\n    \n    let stderr = String::from_utf8_lossy(\u0026apply_output.stderr);\n    if stderr.contains(\"index.lock\") || stderr.contains(\"Unable to create\") {\n        if attempt \u003c MAX_RETRY_ATTEMPTS - 1 {\n            let delay = INITIAL_RETRY_DELAY_MS * (1 \u003c\u003c attempt);\n            tokio::time::sleep(Duration::from_millis(delay)).await;\n            continue;\n        }\n    }\n    // Not a lock error or exhausted retries, proceed to fallback\n    break;\n}\n```\n\n## Testing\n- Unit test: Mock git apply failure with 'index.lock' error, verify retry\n- Integration test: Simulate lock contention (harder, may need to hold lock file manually)\n\n## Files to Modify\n- core/src/worktree_manager.rs\n\n## Acceptance Criteria\n- [ ] Retry logic implemented for both `git apply` and `git apply --3way`\n- [ ] Exponential backoff (100ms, 200ms, 400ms)\n- [ ] Log warning when retry occurs\n- [ ] Tests pass","status":"closed","issue_type":"task","created_at":"2025-12-29T00:10:58.855973921+01:00","updated_at":"2025-12-29T03:01:29.56193592+01:00","closed_at":"2025-12-29T03:01:29.56193592+01:00","dependencies":[{"issue_id":"codex-vcp.1","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:10:58.856372171+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.2","title":"Fix filename parsing in detect_conflict_markers","description":"## Problem\nThe `detect_conflict_markers` function incorrectly parses filenames that contain colons.\n\n## Current Behavior\n```rust\n// In worktree_manager.rs\n.filter_map(|line| line.split(':').next().map(ToString::to_string))\n```\n\nFor a file named `data:test.json` with conflicts:\n- `git diff --check` outputs: `data:test.json:1: leftover conflict marker`\n- Current code parses filename as `data` (stops at first colon)\n- UI shows wrong filename\n\n## Solution\nParse from the right side, looking for the known suffix pattern.\n\n## Implementation\n```rust\nfn parse_conflict_filename(line: \\u0026str) -\u003e Option\u003cString\u003e {\n    // git diff --check format: \"filename:line_number: message\"\n    // We need to find the line number and message parts from the right\n    \n    // Look for the conflict marker message\n    let marker_suffix = \": leftover conflict marker\";\n    if !line.contains(marker_suffix) {\n        return None;\n    }\n    \n    // Remove the message suffix\n    let without_msg = line.strip_suffix(marker_suffix)?;\n    \n    // Now we have \"filename:line_number\"\n    // Find the last colon which separates filename from line number\n    let colon_pos = without_msg.rfind(':')?;\n    \n    // Verify the part after colon is a number\n    let line_num_str = \\u0026without_msg[colon_pos + 1..];\n    if line_num_str.parse::\u003cu32\u003e().is_err() {\n        return None;\n    }\n    \n    Some(without_msg[..colon_pos].to_string())\n}\n```\n\n## Testing\n- Test with normal filename: `src/main.rs:10: leftover conflict marker`\n- Test with colon in filename: `data:test.json:10: leftover conflict marker`\n- Test with multiple colons: `a:b:c.txt:10: leftover conflict marker`\n\n## Files to Modify\n- core/src/worktree_manager.rs\n\n## Acceptance Criteria\n- [ ] Filenames with colons parsed correctly\n- [ ] Normal filenames still work\n- [ ] Unit tests added","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T00:11:16.041074945+01:00","updated_at":"2025-12-29T03:01:29.586838331+01:00","closed_at":"2025-12-29T03:01:29.586838331+01:00","dependencies":[{"issue_id":"codex-vcp.2","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:11:16.041608323+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.3","title":"Add partial patch application detection and warning","description":"## Problem\nWhen `git apply --3way` partially succeeds (some hunks apply, others fail without markers), the system reports 'Conflict - patch saved' but the workspace is in a mixed state with some changes already applied.\n\n## Current Behavior\n1. 10-file patch, 9 apply cleanly via 3-way, 1 fails completely\n2. 9 files are modified in working tree\n3. 1 file fails without generating markers (e.g., delete conflict)\n4. `detect_conflict_markers` returns empty\n5. Result: 'Conflict - patch saved' but 9 files already modified\n\n## Impact\nUser might manually apply the saved patch, duplicating the 9 changes.\n\n## Solution\nAfter `git apply --3way` failure without conflict markers, check if any files were modified and include this information in the result/warning.\n\n## Implementation\n```rust\n// After --3way fails and no conflict markers found:\nlet conflicted_files = Self::detect_conflict_markers(target_dir).await?;\n\nif conflicted_files.is_empty() {\n    // Check if any files were actually modified\n    let status_output = Command::new(\"git\")\n        .args([\"status\", \"--porcelain\"])\n        .current_dir(target_dir)\n        .output()\n        .await?;\n    \n    let modified_files: Vec\u003cString\u003e = String::from_utf8_lossy(\u0026status_output.stdout)\n        .lines()\n        .filter(|line| line.starts_with(\" M\") || line.starts_with(\"M \"))\n        .filter_map(|line| line.get(3..).map(|s| s.to_string()))\n        .collect();\n    \n    if !modified_files.is_empty() {\n        // Return new variant: PartialApply\n        return Ok(PatchApplyResult::PartialConflict {\n            patch_path: patch_file,\n            applied_files: modified_files,\n        });\n    }\n    \n    // True hard failure - nothing applied\n    return Ok(PatchApplyResult::Conflict { patch_path: patch_file });\n}\n```\n\n## New Enum Variant\n```rust\npub enum PatchApplyResult {\n    Applied,\n    NoChanges,\n    AppliedWithConflicts { conflicted_files: Vec\u003cString\u003e },\n    PartialConflict { patch_path: PathBuf, applied_files: Vec\u003cString\u003e },  // NEW\n    Conflict { patch_path: PathBuf },\n}\n```\n\n## Files to Modify\n- core/src/worktree_manager.rs (add detection logic and new variant)\n- core/src/tools/handlers/task.rs (handle new variant, emit appropriate warning)\n- protocol/src/subagent_changes.rs (add new status if needed for API)\n\n## Acceptance Criteria\n- [ ] Detect when files were modified before failure\n- [ ] Include list of already-applied files in result\n- [ ] Emit clear warning to user about mixed state\n- [ ] Tests added","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-29T00:11:37.749458693+01:00","updated_at":"2025-12-29T03:01:29.609501212+01:00","closed_at":"2025-12-29T03:01:29.609501212+01:00","dependencies":[{"issue_id":"codex-vcp.3","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:11:37.750180861+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.4","title":"Use Vec\u003cu8\u003e for patch content to preserve encoding","description":"## Problem\nThe patch content is stored as a Rust `String`, which requires valid UTF-8. Using `String::from_utf8_lossy` replaces invalid UTF-8 sequences with the replacement character (U+FFFD), which can corrupt patches for files with non-UTF8 encodings.\n\n## Current Behavior\n```rust\n// In worktree_manager.rs generate_diff()\nlet patch = String::from_utf8_lossy(\u0026diff_output.stdout).to_string();\n```\n\nFor files with ISO-8859-1 or other non-UTF8 encodings:\n1. `git diff --binary` outputs raw bytes\n2. `from_utf8_lossy` replaces invalid sequences with \n3. Patch context is corrupted\n4. `git apply` fails because context doesn't match\n\n## Impact\nRare (most modern repos use UTF-8), but affects international users with legacy encodings.\n\n## Solution\nStore patch as `Vec\u003cu8\u003e` instead of `String` to preserve raw bytes.\n\n## Implementation\n```rust\n// In WorktreeDiff struct:\npub struct WorktreeDiff {\n    pub patch: Vec\u003cu8\u003e,  // Changed from String\n    pub files_changed: Vec\u003cFileChangeSummary\u003e,\n    pub has_changes: bool,\n}\n\n// In generate_diff():\nlet patch = diff_output.stdout;  // Keep as Vec\u003cu8\u003e\nlet has_changes = !patch.is_empty() \u0026\u0026 patch.iter().any(|\u0026b| !b.is_ascii_whitespace());\n\n// In apply_patch():\ntokio::fs::write(\u0026patch_file, \u0026patch).await?;  // Write bytes directly\n\n// Update has_changes check:\nif patch.trim().is_empty() {  // Becomes:\nif patch.is_empty() || patch.iter().all(|\u0026b| b.is_ascii_whitespace()) {\n```\n\n## Files to Modify\n- core/src/worktree_manager.rs\n\n## Acceptance Criteria\n- [ ] WorktreeDiff.patch changed to Vec\u003cu8\u003e\n- [ ] Patch written as raw bytes\n- [ ] Existing functionality preserved\n- [ ] Tests pass","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-29T00:11:55.069422413+01:00","updated_at":"2025-12-29T03:01:29.636706473+01:00","closed_at":"2025-12-29T03:01:29.636706473+01:00","dependencies":[{"issue_id":"codex-vcp.4","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:11:55.069743516+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.5","title":"Handle binary file stats in numstat parsing","description":"## Problem\nBinary file changes are displayed as '+0/-0' in the UI because `git diff --numstat` returns '-' for binary files.\n\n## Current Behavior\n```rust\n// In worktree_manager.rs parse_numstat()\nlet insertions = parts[0].parse().unwrap_or(0);\nlet deletions = parts[1].parse().unwrap_or(0);\n```\n\nFor binary files, `numstat` outputs: `-\\t-\\timage.png`\n- `parts[0].parse::\u003ci32\u003e()` fails, returns 0\n- UI shows 'image.png (+0/-0)' despite actual changes\n\n## Solution\nDetect '-' as a special value indicating binary file, and handle appropriately.\n\n## Implementation Options\n\n### Option A: Use Option\u003ci32\u003e\n```rust\npub struct FileChangeSummary {\n    pub path: String,\n    pub insertions: Option\u003ci32\u003e,  // None = binary\n    pub deletions: Option\u003ci32\u003e,   // None = binary\n}\n\nfn parse_numstat(output: \u0026str) -\u003e Vec\u003cFileChangeSummary\u003e {\n    output.lines().filter_map(|line| {\n        let parts: Vec\u003c\u0026str\u003e = line.split('\\t').collect();\n        if parts.len() \u003e= 3 {\n            let insertions = if parts[0] == \"-\" { None } else { parts[0].parse().ok() };\n            let deletions = if parts[1] == \"-\" { None } else { parts[1].parse().ok() };\n            Some(FileChangeSummary {\n                path: parts[2].to_string(),\n                insertions,\n                deletions,\n            })\n        } else {\n            None\n        }\n    }).collect()\n}\n```\n\n### Option B: Use sentinel value\n```rust\n// Use -1 to indicate binary\nlet insertions = if parts[0] == \"-\" { -1 } else { parts[0].parse().unwrap_or(0) };\n```\n\n## Trade-offs\n- Option A: More explicit, but requires updating FileChangeSummary (protocol change)\n- Option B: Simpler, but -1 is a magic number\n\n## Recommendation\nOption B is simpler and doesn't require protocol changes. The UI can check for -1 and display 'binary' instead of the number.\n\n## Files to Modify\n- core/src/worktree_manager.rs (parse_numstat)\n- TUI display code if showing change stats (verify current behavior)\n\n## Acceptance Criteria\n- [ ] Binary files detected correctly\n- [ ] Appropriate display in UI (e.g., 'binary' or 'modified')\n- [ ] Tests added","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-29T00:12:14.960215205+01:00","updated_at":"2025-12-29T03:01:29.658303884+01:00","closed_at":"2025-12-29T03:01:29.658303884+01:00","dependencies":[{"issue_id":"codex-vcp.5","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:12:14.960597695+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.6","title":"Add startup cleanup for orphaned worktrees","description":"## Problem\nIf the agent process is killed (SIGKILL) before the Drop cleanup runs, orphaned worktrees accumulate in `.codex/agents/`.\n\n## Current Behavior\n- WorktreeHandle has a Drop impl that cleans up\n- If process is killed forcefully, Drop never runs\n- Worktrees accumulate over time\n- Uses disk space unnecessarily\n\n## Solution\nAdd a startup routine to prune stale worktrees in `.codex/agents/`.\n\n## Implementation\n```rust\nimpl WorktreeManager {\n    /// Clean up any orphaned worktrees from previous sessions.\n    /// Call this on startup.\n    pub async fn prune_orphaned_worktrees(\u0026self) -\u003e Result\u003c()\u003e {\n        if !self.worktrees_root.exists() {\n            return Ok(());\n        }\n        \n        // List all directories in .codex/agents/\n        let mut entries = tokio::fs::read_dir(\u0026self.worktrees_root).await?;\n        \n        while let Some(entry) = entries.next_entry().await? {\n            let path = entry.path();\n            if path.is_dir() {\n                // Check if this is a valid git worktree\n                let git_dir = path.join(\".git\");\n                if git_dir.exists() {\n                    // It's a worktree, try to remove it\n                    // Use git worktree remove which handles the bookkeeping\n                    let output = Command::new(\"git\")\n                        .args([\"worktree\", \"remove\", \"--force\"])\n                        .arg(\u0026path)\n                        .output()\n                        .await;\n                    \n                    match output {\n                        Ok(o) if o.status.success() =\u003e {\n                            tracing::info!(path = %path.display(), \"Cleaned up orphaned worktree\");\n                        }\n                        _ =\u003e {\n                            // If git worktree remove fails, try manual cleanup\n                            if let Err(e) = tokio::fs::remove_dir_all(\u0026path).await {\n                                tracing::warn!(\n                                    path = %path.display(),\n                                    error = %e,\n                                    \"Failed to clean up orphaned worktree\"\n                                );\n                            }\n                        }\n                    }\n                }\n            }\n        }\n        \n        // Also run git worktree prune to clean up stale entries\n        let _ = Command::new(\"git\")\n            .args([\"worktree\", \"prune\"])\n            .output()\n            .await;\n        \n        Ok(())\n    }\n}\n```\n\n## Where to Call\n- During Codex initialization\n- Or lazily on first worktree creation\n\n## Files to Modify\n- core/src/worktree_manager.rs (add prune method)\n- core/src/codex.rs or relevant startup code (call prune)\n\n## Acceptance Criteria\n- [ ] Orphaned worktrees cleaned on startup\n- [ ] git worktree prune called to update bookkeeping\n- [ ] Errors logged but don't block startup\n- [ ] Tests verify cleanup behavior","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-29T00:12:34.502101681+01:00","updated_at":"2025-12-29T03:01:29.684973454+01:00","closed_at":"2025-12-29T03:01:29.684973454+01:00","dependencies":[{"issue_id":"codex-vcp.6","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:12:34.502428565+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.7","title":"Add submodule warning when creating worktree","description":"## Problem\nGit submodules are NOT initialized in worktrees created with `git worktree add --detach`. Subagents see empty directories for submodule paths, which can cause build failures in projects that depend on submodules.\n\n## Current Behavior\n- Worktree is created with `git worktree add --detach`\n- Submodules appear as empty directories\n- Subagent tries to build → fails because dependencies missing\n- User confused why build fails in subagent but works locally\n\n## Solution\nDetect if the repo has submodules and emit a warning to inform the subagent.\n\n## Implementation\n```rust\nimpl WorktreeManager {\n    /// Check if repo has submodules\n    async fn has_submodules(repo_dir: \u0026Path) -\u003e bool {\n        repo_dir.join(\".gitmodules\").exists()\n    }\n    \n    /// Get list of submodule paths\n    async fn get_submodule_paths(repo_dir: \u0026Path) -\u003e Vec\u003cString\u003e {\n        let output = Command::new(\"git\")\n            .args([\"config\", \"--file\", \".gitmodules\", \"--get-regexp\", \"path\"])\n            .current_dir(repo_dir)\n            .output()\n            .await;\n        \n        match output {\n            Ok(o) if o.status.success() =\u003e {\n                String::from_utf8_lossy(\u0026o.stdout)\n                    .lines()\n                    .filter_map(|line| line.split_whitespace().last())\n                    .map(ToString::to_string)\n                    .collect()\n            }\n            _ =\u003e vec![],\n        }\n    }\n}\n\n// In create_worktree, after creating:\nif Self::has_submodules(parent_dir).await {\n    let paths = Self::get_submodule_paths(parent_dir).await;\n    tracing::warn!(\n        submodule_count = paths.len(),\n        \"Worktree created without submodule initialization. Submodule directories will be empty: {:?}\",\n        paths\n    );\n}\n```\n\n## Alternative: Initialize Submodules (Expensive)\nCould optionally initialize submodules, but this is slow:\n```rust\nCommand::new(\"git\")\n    .args([\"submodule\", \"update\", \"--init\", \"--recursive\"])\n    .current_dir(\u0026worktree_path)\n    .output()\n    .await?;\n```\n\nThis should probably be opt-in via configuration.\n\n## Files to Modify\n- core/src/worktree_manager.rs\n\n## Acceptance Criteria\n- [ ] Detect presence of .gitmodules\n- [ ] Log warning with submodule paths\n- [ ] Warning visible in debug logs\n- [ ] Consider adding to subagent's environment context","status":"closed","priority":3,"issue_type":"task","created_at":"2025-12-29T00:12:53.485010963+01:00","updated_at":"2025-12-29T03:01:29.707232255+01:00","closed_at":"2025-12-29T03:01:29.707232255+01:00","dependencies":[{"issue_id":"codex-vcp.7","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T00:12:53.485320664+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vcp.8","title":"Fix subagent session reuse with worktree isolation","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-29T12:00:00.348869139+01:00","updated_at":"2026-01-04T13:06:21.489680792+01:00","closed_at":"2026-01-04T13:06:21.489680792+01:00","dependencies":[{"issue_id":"codex-vcp.8","depends_on_id":"codex-vcp","type":"parent-child","created_at":"2025-12-29T12:00:00.349380896+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vg7","title":"Show read_session query in delegation UI","description":"TUI delegation line for read_session currently shows 'Reading session \u003cid\u003e'. It should show the query/question passed to the read_session tool call, so users can see what was asked at a glance. DoD: delegation detail renders the question text (wrapped/indented), session id remains visible elsewhere, snapshots/tests updated, cargo test -p codex-tui and cargo test -p codex-core pass.","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-09T02:13:40.965441163+01:00","updated_at":"2026-01-12T20:27:02.977918479+01:00","closed_at":"2026-01-12T20:27:02.977918479+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vg7","depends_on_id":"codex-q6o","type":"parent-child","created_at":"2026-01-09T02:13:51.738483219+01:00","created_by":"daemon"}]}
{"id":"codex-vq1","title":"ChatGPT login overwrites Gemini tokens","description":"persist_tokens_async in login/server.rs builds a fresh AuthDotJson with empty gemini_accounts when saving ChatGPT tokens, wiping existing Gemini credentials. Need to merge with existing auth.json so Gemini accounts survive ChatGPT login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:55:23.755383003+01:00","updated_at":"2025-12-06T13:57:34.877510865+01:00","closed_at":"2025-12-06T13:57:34.877510865+01:00"}
{"id":"codex-vwt","title":"Epic: Improve Compaction with Structured Summaries and Iterative Updates","description":"## Current State (as of 2026-01-04)\nCommit 2253a2aa7 implemented turn-aware compaction with structured summaries.\n\n**DONE:**\n- Structured summary format in `core/templates/compact/prompt.md`\n- Turn-aware compaction logic in `core/src/compact.rs`\n- Summary prefix for resume in `core/templates/compact/summary_prefix.md`\n\n**NOT DONE:**\n- Iterative UPDATE prompt (model just sees old summary in history, doesn't get explicit 'update this' instruction)\n- Previous summary extraction (currently skipped, not fed to update prompt)\n- File operations tracking\n\n## Problem with Current Approach\nOn re-compaction, the old summary is in history but model may:\n1. Generate completely new summary ignoring old one\n2. Miss context from previous summary (catastrophic forgetting)\n3. Not properly merge old+new information\n\n## Solution: Explicit UPDATE Prompt\nWhen previous summary detected:\n1. Extract it from history\n2. Use UPDATE_PROMPT instead of INITIAL_PROMPT  \n3. UPDATE_PROMPT explicitly tells model to PRESERVE + UPDATE\n\n## Reference\n- pi-mono: `packages/coding-agent/src/core/compaction/compaction.ts`\n- Key: SUMMARIZATION_PROMPT vs UPDATE_SUMMARIZATION_PROMPT\n\n## Key Files\n- `core/src/compact.rs` - main logic\n- `core/templates/compact/prompt.md` - current prompt (done)\n- `core/templates/compact/summary_prefix.md` - resume prefix","status":"closed","priority":1,"issue_type":"epic","created_at":"2026-01-03T18:11:15.97193131+01:00","updated_at":"2026-01-12T20:27:24.624116905+01:00","closed_at":"2026-01-12T20:27:24.624116905+01:00","close_reason":"Restored implementation"}
{"id":"codex-vwt.1","title":"Create structured summary prompt template","description":"Create templates/compact/structured_prompt.md with the structured summary format.\n\n## Format to implement\n```markdown\n## Goal\n[User's primary objective(s)]\n\n## Constraints \u0026 Preferences\n- [List user-specified constraints, or \"(none)\"]\n\n## Progress\n### Done\n- [x] [Completed items with brief description]\n### In Progress\n- [ ] [Current work items]\n### Blocked\n- [Issues preventing progress, or \"(none)\"]\n\n## Key Decisions\n- **[Decision]:** [Rationale for why this approach was chosen]\n\n## Next Steps\n1. [Ordered list of immediate next actions]\n\n## Critical Context\n- [Important data, references, or state that must be preserved, or \"(none)\"]\n```\n\n## System prompt\nCreate SUMMARIZATION_SYSTEM_PROMPT: \"You are a context summarization assistant. Your task is to create a structured summary of the conversation. ONLY output the structured summary in the exact format specified. Do not add commentary.\"\n\n## Files to create\n- templates/compact/structured_prompt.md (initial summary prompt)\n- Update compact.rs to use new template\n\n## Reference\n- pi-mono: SUMMARIZATION_PROMPT in packages/coding-agent/src/core/compaction/compaction.ts","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T18:11:29.110854122+01:00","updated_at":"2026-01-12T20:27:24.599180038+01:00","closed_at":"2026-01-12T20:27:24.599180038+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vwt.1","depends_on_id":"codex-vwt","type":"parent-child","created_at":"2026-01-03T18:11:29.111556983+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vwt.2","title":"Create UPDATE prompt for iterative summaries","description":"Create templates/compact/update_prompt.md for updating existing summaries.\n\n## Key difference from initial prompt\nThe UPDATE prompt must:\n1. Receive previous summary in a \u003cprevious-summary\u003e block\n2. Instruct model to PRESERVE existing information\n3. UPDATE sections (move In Progress → Done, add new items)\n4. MERGE new information, don't replace\n\n## Prompt structure\n```\nYou are updating an existing summary with new conversation content.\n\n\u003cprevious-summary\u003e\n{previous_summary}\n\u003c/previous-summary\u003e\n\n\u003cnew-conversation\u003e\n{new_messages}\n\u003c/new-conversation\u003e\n\nINSTRUCTIONS:\n- PRESERVE all existing Goal, Constraints, Key Decisions unless explicitly changed\n- UPDATE Progress: move completed items to Done, add new In Progress items\n- UPDATE Next Steps based on current state\n- ADD new Key Decisions with rationale\n- PRESERVE Critical Context, add new critical information\n- Output ONLY the updated structured summary\n```\n\n## Files to create\n- templates/compact/update_prompt.md\n\n## Reference\n- pi-mono: UPDATE_SUMMARIZATION_PROMPT in compaction.ts","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T18:11:39.276571284+01:00","updated_at":"2026-01-12T20:27:24.620247969+01:00","closed_at":"2026-01-12T20:27:24.620247969+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vwt.2","depends_on_id":"codex-vwt","type":"parent-child","created_at":"2026-01-03T18:11:39.276953093+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vwt.3","title":"Implement previous summary detection and extraction","description":"Modify compact.rs to detect and extract previous summary from history.\n\n## Current behavior\n- compact.rs has is_summary_message() that checks for SUMMARY_PREFIX\n- It skips previous summaries in identify_turns()\n- BUT it doesn't extract the summary text to feed into UPDATE prompt\n\n## Required changes in compact.rs\n\n1. Add function to extract previous summary:\n```rust\nfn extract_previous_summary(history: \u0026[ResponseItem]) -\u003e Option\u003cString\u003e {\n    // Find first message that matches SUMMARY_PREFIX\n    // Extract the summary text (strip prefix)\n    // Return Some(summary_text) or None\n}\n```\n\n2. Modify run_compact_task_inner() or similar:\n```rust\nlet previous_summary = extract_previous_summary(\u0026history);\nlet prompt = if previous_summary.is_some() {\n    // Use UPDATE prompt with previous_summary injected\n    format_update_prompt(previous_summary.unwrap(), new_messages)\n} else {\n    // Use initial STRUCTURED prompt\n    get_structured_prompt()\n};\n```\n\n## Key files\n- core/src/compact.rs (main changes)\n- May need to add helper in templates.rs for new template loading\n\n## Tests\n- Test extract_previous_summary with summary present\n- Test extract_previous_summary with no summary\n- Test that update prompt is used on second+ compaction","status":"closed","priority":1,"issue_type":"task","created_at":"2026-01-03T18:11:52.357552241+01:00","updated_at":"2026-01-12T20:27:24.62149055+01:00","closed_at":"2026-01-12T20:27:24.62149055+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vwt.3","depends_on_id":"codex-vwt","type":"parent-child","created_at":"2026-01-03T18:11:52.358003974+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-vwt.3","depends_on_id":"codex-vwt.1","type":"blocks","created_at":"2026-01-03T18:12:22.100982917+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-vwt.3","depends_on_id":"codex-vwt.2","type":"blocks","created_at":"2026-01-03T18:12:22.118293187+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vwt.4","title":"Add file operations tracking to compaction","description":"Track which files were read and modified across compactions.\n\n## Goal\nAppend XML file lists to summary so agent knows what files it has interacted with:\n```xml\n\u003cread-files\u003e\nsrc/main.rs\nsrc/config.rs\n\u003c/read-files\u003e\n\u003cmodified-files\u003e\nsrc/app.rs\ntests/test_app.rs\n\u003c/modified-files\u003e\n```\n\n## Implementation\n\n1. Create FileOperations struct:\n```rust\nstruct FileOperations {\n    read: HashSet\u003cPathBuf\u003e,\n    written: HashSet\u003cPathBuf\u003e,\n    edited: HashSet\u003cPathBuf\u003e,\n}\n```\n\n2. Extract file ops from tool calls in history:\n```rust\nfn extract_file_operations(history: \u0026[ResponseItem]) -\u003e FileOperations {\n    // Scan for function_call items\n    // Match on tool names: read_file, write_file, apply_patch, shell (grep, cat, etc.)\n    // Extract path arguments\n}\n```\n\n3. Compute final lists:\n- read_files = read - (written ∪ edited)  // Files only read, not modified\n- modified_files = written ∪ edited  // Files that were changed\n\n4. Append to summary:\n```rust\nfn format_file_operations(ops: \u0026FileOperations) -\u003e String {\n    // Format as XML blocks\n}\n```\n\n5. Cumulative tracking:\n- Parse previous summary's XML file lists\n- Merge with current session's file ops\n- This preserves file knowledge across multiple compactions\n\n## Files to modify\n- core/src/compact.rs\n\n## Reference\n- pi-mono: extractFileOperations(), computeFileLists(), formatFileOperations() in utils.ts","acceptance_criteria":"DoD:\n- Extract file read/modified ops from tool calls in history\n- Merge with any existing \u003cread-files\u003e/\u003cmodified-files\u003e lists found in previous summary\n- Append updated XML blocks to the stored summary (so future compactions preserve them)\n- Unit tests for extraction + merge logic; cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-03T18:12:05.375171971+01:00","updated_at":"2026-01-12T20:27:24.622457168+01:00","closed_at":"2026-01-12T20:27:24.622457168+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vwt.4","depends_on_id":"codex-vwt","type":"parent-child","created_at":"2026-01-03T18:12:05.375555052+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-vwt.4","depends_on_id":"codex-vwt.3","type":"blocks","created_at":"2026-01-03T18:12:22.136210807+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-vwt.4.1","title":"Extract file operations from tool calls","description":"Implement pure extraction from ResponseItem history to a FileOperations summary (read/modified) based on tool calls. Scope: read_file, write_file, apply_patch; ignore shell heuristics for now (follow-up if needed).\n\nDoD:\n- Pure function(s) that return normalized workspace-relative paths\n- Unit tests covering read_file, write_file, apply_patch cases","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T02:15:32.442782852+01:00","updated_at":"2026-01-12T17:34:21.965509298+01:00","closed_at":"2026-01-12T17:34:21.965511081+01:00","close_reason":"File ops extraction from tool calls implemented with unit tests.","dependencies":[{"issue_id":"codex-vwt.4.1","depends_on_id":"codex-vwt.4","type":"parent-child","created_at":"2026-01-10T02:15:32.454641682+01:00","created_by":"daemon"}]}
{"id":"codex-vwt.4.2","title":"Parse/merge file ops from previous summary XML","description":"Parse \u003cread-files\u003e and \u003cmodified-files\u003e blocks from previous summary text, merge with newly extracted ops, and format back to XML blocks.\n\nDoD:\n- Parser is resilient to missing blocks and extra whitespace\n- Merge is deterministic (sorted output)\n- Unit tests for parse + merge + format","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T02:15:34.670943279+01:00","updated_at":"2026-01-12T17:34:21.979623662+01:00","closed_at":"2026-01-12T17:34:21.979625124+01:00","close_reason":"File ops XML parse/merge/format implemented with deterministic ordering + tests.","dependencies":[{"issue_id":"codex-vwt.4.2","depends_on_id":"codex-vwt.4","type":"parent-child","created_at":"2026-01-10T02:15:34.677433284+01:00","created_by":"daemon"}]}
{"id":"codex-vwt.4.3","title":"Integrate file ops blocks into compaction output","description":"Wire file-ops extraction + merge into compaction so the stored summary includes updated \u003cread-files\u003e/\u003cmodified-files\u003e blocks.\n\nDoD:\n- After compaction completes, the persisted summary includes the XML blocks\n- Next compaction preserves/extends prior lists\n- cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-10T02:15:37.015300328+01:00","updated_at":"2026-01-12T17:34:21.993898513+01:00","closed_at":"2026-01-12T17:34:21.993900476+01:00","close_reason":"File ops blocks integrated into compaction output; tests pass.","dependencies":[{"issue_id":"codex-vwt.4.3","depends_on_id":"codex-vwt.4","type":"parent-child","created_at":"2026-01-10T02:15:37.02220703+01:00","created_by":"daemon"}]}
{"id":"codex-vwt.5","title":"Add tests for improved compaction","description":"Add comprehensive tests for the new compaction system.\n\n## Test cases needed\n\n### Unit tests (compact.rs)\n\n1. test_extract_previous_summary_present\n   - History starts with summary message\n   - Should extract summary text without prefix\n\n2. test_extract_previous_summary_absent  \n   - History has no summary\n   - Should return None\n\n3. test_structured_summary_format\n   - Verify output matches expected structure\n   - All sections present\n\n4. test_iterative_update_preserves_goals\n   - First compaction sets Goal\n   - Second compaction preserves Goal even with new content\n\n5. test_file_operations_extraction\n   - History with read_file, apply_patch calls\n   - Verify correct paths extracted\n\n6. test_file_operations_cumulative\n   - Previous summary has file lists\n   - New session adds more files\n   - Merged result contains all\n\n### Integration tests\n\n1. test_compaction_uses_update_prompt_on_second_pass\n   - Trigger compaction twice\n   - Verify second uses UPDATE prompt\n\n2. test_long_session_preserves_original_goal\n   - Simulate 10+ compaction cycles\n   - Verify original Goal survives (the catastrophic forgetting fix)\n\n## Files\n- core/src/compact.rs (add unit tests)\n- core/tests/ (add integration test if needed)","acceptance_criteria":"DoD:\n- Add unit tests for extract_previous_summary + serialize_history_to_text behavior\n- Add unit tests for file ops XML parse/merge/format (from codex-vwt.4.*)\n- Add at least one integration-style test that compaction output includes preserved Goal and file ops blocks across two compactions\n- cargo test -p codex-core passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-03T18:12:16.544760185+01:00","updated_at":"2026-01-12T20:27:24.62324301+01:00","closed_at":"2026-01-12T20:27:24.62324301+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-vwt.5","depends_on_id":"codex-vwt","type":"parent-child","created_at":"2026-01-03T18:12:16.545152063+01:00","created_by":"daemon","metadata":"{}"},{"issue_id":"codex-vwt.5","depends_on_id":"codex-vwt.4","type":"blocks","created_at":"2026-01-03T18:12:22.152360052+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-w15","title":"Warn user when overwriting built-in subagents","status":"open","priority":2,"issue_type":"epic","created_at":"2026-01-13T12:47:33.287185868+01:00","updated_at":"2026-01-13T12:47:33.287185868+01:00"}
{"id":"codex-w15.1","title":"Add overwritten_builtins field to SubagentLoadOutcome","status":"in_progress","priority":2,"issue_type":"task","created_at":"2026-01-13T12:47:38.894556615+01:00","updated_at":"2026-01-13T12:48:01.547740471+01:00","dependencies":[{"issue_id":"codex-w15.1","depends_on_id":"codex-w15","type":"parent-child","created_at":"2026-01-13T12:47:38.901617296+01:00","created_by":"daemon"}]}
{"id":"codex-w15.2","title":"Detect overwritten built-ins in load_subagents()","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T12:47:40.478455453+01:00","updated_at":"2026-01-13T12:47:40.478455453+01:00","dependencies":[{"issue_id":"codex-w15.2","depends_on_id":"codex-w15","type":"parent-child","created_at":"2026-01-13T12:47:40.484503952+01:00","created_by":"daemon"}]}
{"id":"codex-w15.3","title":"Display warning in TUI using on_warning pattern","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T12:47:41.936406639+01:00","updated_at":"2026-01-13T12:47:41.936406639+01:00","dependencies":[{"issue_id":"codex-w15.3","depends_on_id":"codex-w15","type":"parent-child","created_at":"2026-01-13T12:47:41.942951927+01:00","created_by":"daemon"}]}
{"id":"codex-w15.4","title":"Add tests for built-in override detection","status":"open","priority":2,"issue_type":"task","created_at":"2026-01-13T12:47:43.09285356+01:00","updated_at":"2026-01-13T12:47:43.09285356+01:00","dependencies":[{"issue_id":"codex-w15.4","depends_on_id":"codex-w15","type":"parent-child","created_at":"2026-01-13T12:47:43.104764763+01:00","created_by":"daemon"}]}
{"id":"codex-wan","title":"Simplify reasoning display config","description":"Replace hide_agent_reasoning + show_raw_agent_reasoning with single reasoning_display enum (auto/raw/none). Reduces config confusion and prevents duplicate output.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-18T16:34:02.946459889+01:00","updated_at":"2025-12-26T21:53:06.070113875+01:00","closed_at":"2025-12-26T21:53:06.070113875+01:00"}
{"id":"codex-wan.1","title":"Update TurnItem::as_legacy_events to use ReasoningDisplay","description":"In protocol/src/items.rs: change as_legacy_events(show_raw: bool) to as_legacy_events(display: ReasoningDisplay). Auto=emit summary, Raw=emit raw, None=emit nothing.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:37.447461104+01:00","updated_at":"2025-12-18T16:57:00.814473511+01:00","closed_at":"2025-12-18T16:57:00.814473511+01:00","dependencies":[{"issue_id":"codex-wan.1","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:37.447841639+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.2","title":"Update codex.rs send_event to pass ReasoningDisplay","description":"In core/src/codex.rs: update show_raw_agent_reasoning() to return ReasoningDisplay and pass it to as_legacy_events().","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:42.501691701+01:00","updated_at":"2025-12-26T21:52:54.942324148+01:00","closed_at":"2025-12-26T21:52:54.942324148+01:00","dependencies":[{"issue_id":"codex-wan.2","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:42.502151227+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.3","title":"Update exec event processor for ReasoningDisplay","description":"In exec/src/event_processor_with_human_output.rs: replace show_agent_reasoning/show_raw_agent_reasoning with reasoning_display enum matching.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:47.561792456+01:00","updated_at":"2025-12-26T21:52:58.262605503+01:00","closed_at":"2025-12-26T21:52:58.262605503+01:00","dependencies":[{"issue_id":"codex-wan.3","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:47.562175988+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.4","title":"Update TUI for ReasoningDisplay","description":"In tui/src: update any reasoning display logic to use the new ReasoningDisplay enum instead of separate bool flags.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:52.624618089+01:00","updated_at":"2025-12-26T21:52:59.71776746+01:00","closed_at":"2025-12-26T21:52:59.71776746+01:00","dependencies":[{"issue_id":"codex-wan.4","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:52.625067616+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.5","title":"Replace hide/show flags with reasoning_display in Config","description":"In core/src/config/mod.rs: remove hide_agent_reasoning and show_raw_agent_reasoning, add reasoning_display: ReasoningDisplay. Update ConfigProfile and ConfigOverrides similarly.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:34:57.67804739+01:00","updated_at":"2025-12-26T21:53:00.978877949+01:00","closed_at":"2025-12-26T21:53:00.978877949+01:00","dependencies":[{"issue_id":"codex-wan.5","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:34:57.67852462+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-wan.6","title":"Add ReasoningDisplay enum to protocol","description":"Add enum ReasoningDisplay { Auto, Raw, None } to protocol/src/config_types.rs with serde/Default derives. Auto is default.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T16:35:02.731875191+01:00","updated_at":"2025-12-18T16:56:39.562471348+01:00","closed_at":"2025-12-18T16:56:39.562471348+01:00","dependencies":[{"issue_id":"codex-wan.6","depends_on_id":"codex-wan","type":"parent-child","created_at":"2025-12-18T16:35:02.732361118+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m","title":"Skills cache mtime-based refresh improvements","description":"Implement file-level mtime checking to detect SKILL.md content edits. Currently only root directory mtime is checked, missing content changes.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-18T23:03:13.868609791+01:00","updated_at":"2025-12-19T01:18:11.280463305+01:00","closed_at":"2025-12-19T01:18:11.280463305+01:00"}
{"id":"codex-x6m.1","title":"Update CachedSkills to track file mtimes","description":"Modify CachedSkills struct to store file_states: Vec\u003c(PathBuf, SystemTime)\u003e for each SKILL.md file loaded. Update validation to check both root and file mtimes.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-18T23:03:25.32059875+01:00","updated_at":"2025-12-18T23:11:47.412512629+01:00","closed_at":"2025-12-18T23:11:47.412512629+01:00","dependencies":[{"issue_id":"codex-x6m.1","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:25.321099025+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.2","title":"Remove dead invalidate_cache and invalidate_cwd methods","description":"Remove the #[allow(dead_code)] invalidate_cache() and invalidate_cwd() methods from SkillsManager - no longer needed with proper mtime tracking.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:35.882804844+01:00","updated_at":"2025-12-18T23:12:31.303810166+01:00","closed_at":"2025-12-18T23:12:31.303810166+01:00","dependencies":[{"issue_id":"codex-x6m.2","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:35.883726394+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.3","title":"Add test for skill removal detection","description":"Add test_cache_invalidation_on_skill_removal: load skills, delete a skill directory, verify reload detects removal.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:46.728105267+01:00","updated_at":"2025-12-18T23:19:21.004917188+01:00","closed_at":"2025-12-18T23:19:21.004917188+01:00","dependencies":[{"issue_id":"codex-x6m.3","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:46.728638194+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.4","title":"Add test for skill content edit detection","description":"Add test_cache_invalidation_on_skill_edit: load skills, modify SKILL.md content, verify reload detects change. Replace existing test_cache_hit_ignoring_content_change.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:03:57.422650121+01:00","updated_at":"2025-12-18T23:20:19.430586995+01:00","closed_at":"2025-12-18T23:20:19.430586995+01:00","dependencies":[{"issue_id":"codex-x6m.4","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:03:57.42304251+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.5","title":"Add test for skill precedence (repo vs user)","description":"Add test_repo_skills_override_user_skills: create same-named skill in both repo and user dirs, verify repo takes precedence.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:04:07.508347053+01:00","updated_at":"2025-12-18T23:24:35.003947514+01:00","closed_at":"2025-12-18T23:24:35.003947514+01:00","dependencies":[{"issue_id":"codex-x6m.5","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:04:07.508843511+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-x6m.6","title":"Add test for cache isolation between cwds","description":"Add test_cache_isolation_between_cwds: verify skills for cwd_a don't leak into cwd_b.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-18T23:04:17.843300246+01:00","updated_at":"2025-12-19T01:18:00.988424174+01:00","closed_at":"2025-12-19T01:18:00.988424174+01:00","dependencies":[{"issue_id":"codex-x6m.6","depends_on_id":"codex-x6m","type":"parent-child","created_at":"2025-12-18T23:04:17.843662097+01:00","created_by":"ribelo","metadata":"{}"}]}
{"id":"codex-xop","title":"Provide merge status and file changes to main agent in task tool result","description":"Currently, the 'task' tool returns the subagent's result but the main agent is unaware of the merge status of file changes. \\n\\nProposed changes:\\n1. Update 'SubagentChanges' struct in 'protocol/src/subagent_changes.rs' to include a descriptive 'message' field.\\n2. Update 'task' tool handler in 'core/src/tools/handlers/task.rs' to include the merge status and list of changed files in the result returned to the main agent.\\n3. Ensure the main agent can see which files were actually modified and if any conflicts occurred.","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-23T14:30:15.689716077+01:00","updated_at":"2026-01-04T13:06:20.294638217+01:00","closed_at":"2026-01-04T13:06:20.294638217+01:00"}
{"id":"codex-yr6","title":"Fix failing test model_migration_prompt_only_shows_for_deprecated_models in tui2","status":"closed","priority":2,"issue_type":"bug","created_at":"2025-12-15T15:16:14.896470158+01:00","updated_at":"2025-12-26T21:53:58.854232806+01:00","closed_at":"2025-12-26T21:53:58.854232806+01:00"}
{"id":"codex-zal","title":"Editable handoff draft via EDITOR","description":"## Goal\nAllow user to edit handoff draft in external editor before confirming.\n\n## Implementation\n1. Add 'e' key binding to handoff review screen\n2. Serialize draft to temp Markdown file\n3. Spawn $EDITOR, wait for exit\n4. Parse Markdown back to HandoffDraft\n5. Handle parse errors gracefully\n\n## Markdown Format\n```markdown\n# Goal\n\u003cgoal text\u003e\n\n# Summary  \n\u003csummary text\u003e\n\n# Relevant Files\n# One per line\nsrc/file1.rs\nsrc/file2.rs\n```\n\n## Key Bindings\n- Enter: Confirm as-is\n- Esc: Cancel\n- e: Edit in $EDITOR\n\n## Files to modify\n- tui/src/handoff_review.rs - add 'e' key handling, serialize/parse logic\n- tui/src/app.rs - handle editor spawning (look at /edit command pattern)","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T01:47:02.893245253+01:00","updated_at":"2025-12-22T23:37:54.329007151+01:00","closed_at":"2025-12-22T23:37:54.329007151+01:00"}
{"id":"codex-zf4","title":"Quote paths with spaces in file mentions","description":"## Goal\nFix ambiguity when file paths contain spaces in handoff file mentions.\n\n## Implementation\nUpdate format_file_mentions in core/src/conversation_manager.rs to conditionally quote paths:\n\n```rust\nfn format_file_mentions(files: \u0026[PathBuf]) -\u003e String {\n    files.iter()\n        .take(12)\n        .map(|p| {\n            let s = p.display().to_string();\n            if s.chars().any(char::is_whitespace) {\n                format!(\"@\\\"{}\\\"\", s)  // Quote paths with spaces\n            } else {\n                format!(\"@{}\", s)\n            }\n        })\n        .collect::\u003cVec\u003c_\u003e\u003e()\n        .join(\" \")\n}\n```\n\n## Files to modify\n- core/src/conversation_manager.rs - update format_file_mentions function","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-21T01:46:57.4551251+01:00","updated_at":"2025-12-26T17:46:01.493651994+01:00","closed_at":"2025-12-26T17:46:01.493651994+01:00"}
{"id":"codex-zk7","title":"Gemini Provider Logic Alignment","description":"Epic to align codex-rs Gemini provider logic with gemini-cli best practices for stability and token efficiency. This involves implementing strict history curation, robust active loop detection, and proper tool cancellation feedback.","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-20T12:22:23.70575291+01:00","updated_at":"2025-12-20T15:13:59.64849394+01:00","closed_at":"2025-12-20T15:13:59.64849394+01:00"}
{"id":"codex-zk7.1","title":"Implement Strict History Curation for Gemini","description":"What: Implement a strict history curation pass in core/src/gemini_messages.rs before sending requests to Gemini.\n\nHow: Iterate through message history to merge consecutive turns of the same role and enforce strict User-Model-User alternation. Drop orphaned tool calls or responses if they violate alternation.\n\nWhy: Gemini is extremely strict about history structure. Currently, codex-rs can produce invalid sequences (like text + tool response creating two user turns), leading to fatal 400 errors.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-20T12:22:30.901597316+01:00","updated_at":"2025-12-20T15:13:48.957691775+01:00","closed_at":"2025-12-20T15:13:48.957691775+01:00","dependencies":[{"issue_id":"codex-zk7.1","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.902037405+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.2","title":"Robust Active Loop Identification for Signatures","description":"What: Improve the logic for identifying the active loop start index in apply_synthetic_thought_signatures.\n\nHow: Instead of looking for the last user message with non-empty text, find the last user message that is NOT a tool response (i.e., does not contain function response parts).\n\nWhy: The current heuristic fails if a user message contains images or other non-text data, potentially leaving the model turn unsigned and causing API rejection.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.911713522+01:00","updated_at":"2025-12-20T15:13:50.93348213+01:00","closed_at":"2025-12-20T15:13:50.93348213+01:00","dependencies":[{"issue_id":"codex-zk7.2","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.911993006+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.3","title":"Implement Explicit Tool Cancellation Feedback","description":"What: Refine explicit tool cancellation feedback and prevent model apology loops.\n\nHow: \n1. Acknowledge existing cancellation feedback in core/src/tools/parallel.rs (injects 'aborted by user').\n2. Verify if non-parallel tool paths correctly inject cancellation messages.\n3. Ensure that when a tool is cancelled, the agent loop short-circuits so the model does NOT immediately generate a response (avoiding apology loops). \n4. Optionally align the 'aborted by user' string with gemini-cli's 'canceled by the user'.\n\nWhy: While a basic mechanism exists, we need to ensure it applies globally and doesn't waste tokens on apology turns after a user explicitly interrupts.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.920506774+01:00","updated_at":"2025-12-20T15:13:52.246937948+01:00","closed_at":"2025-12-20T15:13:52.246937948+01:00","dependencies":[{"issue_id":"codex-zk7.3","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.920766229+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zk7.4","title":"Strip Thought Signatures from Historical Turns","description":"What: Omit the thought_signature property from historical function calls in GeminiContent.\n\nHow: Modify build_gemini_messages to only populate thought_signature for the active turn (most recent exchange).\n\nWhy: Signatures are one-time validation tokens with no semantic value in history. Stripping them saves context window tokens (~5-10 per tool call) and reduces noise.","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.929168234+01:00","updated_at":"2025-12-20T15:13:54.639550774+01:00","closed_at":"2025-12-20T15:13:54.639550774+01:00","dependencies":[{"issue_id":"codex-zk7.4","depends_on_id":"codex-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.929426707+01:00","created_by":"daemon","metadata":"{}"}]}
{"id":"codex-zwq","title":"Epic: Show full task prompt in transcript view","description":"## Problem\n\nWhen delegating to subagents (via `task` tool), two fields exist:\n- `description`: Short summary (e.g., 'Find TUI files related to task delegation')\n- `prompt`: Full detailed instructions sent to the subagent\n\nCurrently, only the short `description` is shown in both normal and transcript views. Users want to see the **full prompt** in transcript view (Ctrl+T) to understand exactly what instructions were given to the subagent.\n\n## Current State\n\n- `task.rs`: TaskArgs has both `description` and `prompt` fields\n- `wrap_subagent_event()` only passes `args.description` as `task_description`\n- `SubagentEventPayload.task_description` only contains the short description\n- TUI `transcript_lines()` word-wraps this short description but never sees the full prompt\n\n## Desired Behavior\n\n- **Normal view** (`display_lines`): Continue showing truncated short description (no change)\n- **Transcript view** (`transcript_lines`): Show full prompt text, properly word-wrapped\n\n## Files Involved\n\n- `core/src/tools/handlers/task.rs` - Add prompt to SubagentEventPayload\n- `core/src/protocol.rs` (or wherever SubagentEventPayload is defined) - Add `prompt` field\n- `tui/src/history_cell.rs` - Update SubagentTaskCell to store and display prompt in transcript\n- `tui/src/chatwidget.rs` - Pass prompt through to cell creation","status":"closed","priority":2,"issue_type":"epic","created_at":"2026-01-09T23:56:24.524373517+01:00","updated_at":"2026-01-12T20:26:54.746749561+01:00","closed_at":"2026-01-12T20:26:54.746749561+01:00","close_reason":"Restored implementation"}
{"id":"codex-zwq.1","title":"Add task_prompt field to SubagentEventPayload","description":"## File\n`protocol/src/protocol.rs` (line ~661)\n\n## Changes\n\nAdd new field to `SubagentEventPayload`:\n```rust\n/// Full prompt sent to the subagent (for transcript view).\n#[serde(skip_serializing_if = \"Option::is_none\")]\npub task_prompt: Option\u003cString\u003e,\n```\n\nUse Option\u003cString\u003e to:\n1. Avoid breaking existing protocol consumers\n2. Keep wire format smaller for events that don't need it\n\n## DoD\n- [ ] Field added to struct\n- [ ] `cargo check -p codex-protocol` passes\n- [ ] `cargo test -p codex-protocol` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:56:50.027049693+01:00","updated_at":"2026-01-12T20:26:54.737799279+01:00","closed_at":"2026-01-12T20:26:54.737799279+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.1","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:56:50.033953609+01:00","created_by":"daemon"}]}
{"id":"codex-zwq.2","title":"Update wrap_subagent_event to pass full prompt","description":"## File\n`core/src/tools/handlers/task.rs` (lines ~186-206)\n\n## Changes\n\n1. Add `task_prompt` parameter to `wrap_subagent_event()` function signature\n2. Pass it through to `SubagentEventPayload` construction\n3. Update all call sites (~5 locations around lines 546, 597, 630, 651, 688) to pass `args.prompt`\n\n## Example\n```rust\nfn wrap_subagent_event(\n    parent_call_id: \u0026str,\n    subagent_name: \u0026str,\n    task_description: \u0026str,\n    task_prompt: Option\u003c\u0026str\u003e,  // NEW\n    delegation_id: Option\u003cString\u003e,\n    ...\n) -\u003e EventMsg {\n    EventMsg::SubagentEvent(SubagentEventPayload {\n        ...\n        task_prompt: task_prompt.map(|s| s.to_string()),  // NEW\n        ...\n    })\n}\n```\n\n## DoD\n- [ ] Function signature updated\n- [ ] All call sites pass `Some(\u0026args.prompt)`\n- [ ] `cargo check -p codex-core` passes\n- [ ] `cargo test -p codex-core` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:56:58.986496861+01:00","updated_at":"2026-01-12T20:26:54.741609668+01:00","closed_at":"2026-01-12T20:26:54.741609668+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.2","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:56:58.998470007+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.2","depends_on_id":"codex-zwq.1","type":"blocks","created_at":"2026-01-09T23:57:55.409106428+01:00","created_by":"daemon"}]}
{"id":"codex-zwq.3","title":"Add task_prompt to SubagentTaskCell","description":"## File\n`tui/src/history_cell.rs` (lines ~1405-1450)\n\n## Changes\n\n1. Add `task_prompt: Option\u003cString\u003e` field to `SubagentTaskCell` struct\n2. Add parameter to `new_subagent_task_cell()` constructor\n3. Store the prompt in the cell\n\n## Example\n```rust\npub(crate) struct SubagentTaskCell {\n    ...\n    task_description: String,\n    task_prompt: Option\u003cString\u003e,  // NEW - full prompt for transcript view\n    ...\n}\n\npub fn new_subagent_task_cell(\n    ...\n    task_description: String,\n    task_prompt: Option\u003cString\u003e,  // NEW\n    ...\n) -\u003e Box\u003cdyn HistoryCell\u003e {\n    ...\n}\n```\n\n## DoD\n- [ ] Field added to struct\n- [ ] Constructor updated\n- [ ] `cargo check -p codex-tui` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:57:06.048949562+01:00","updated_at":"2026-01-12T20:26:54.743075666+01:00","closed_at":"2026-01-12T20:26:54.743075666+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.3","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:57:06.061000413+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.3","depends_on_id":"codex-zwq.1","type":"blocks","created_at":"2026-01-09T23:57:55.427492814+01:00","created_by":"daemon"}]}
{"id":"codex-zwq.4","title":"Update transcript_lines to show full prompt","description":"## File\n`tui/src/history_cell.rs` (lines ~1653-1780, `transcript_lines` method)\n\n## Changes\n\nModify `transcript_lines()` to display `task_prompt` instead of `task_description` when available:\n\n```rust\nfn transcript_lines(\u0026self, width: u16) -\u003e Vec\u003cLine\u003c'static\u003e\u003e {\n    ...\n    // Use full prompt for transcript, fallback to description\n    let display_text = self.task_prompt.as_deref().unwrap_or(\u0026self.task_description);\n    \n    // Task description/prompt with └ prefix (wrapped)\n    let desc_wrap_width = wrap_width.saturating_sub(2);\n    for (idx, segment) in textwrap::wrap(display_text, desc_wrap_width)\n        .iter()\n        .enumerate()\n    {\n        ...\n    }\n}\n```\n\n## Visual Change\n\nBefore (transcript view):\n```\n• Delegated to @finder\n  └ Find TUI files related to task delegation display and transcript view\n```\n\nAfter (transcript view):\n```\n• Delegated to @finder\n  └ Find files in codex-rs/tui related to:\n    1. Task delegation display (the \"Delegated to @librarian\" UI shown in the conversation)\n    2. Transcript view (Ctrl+T feature)\n    3. Any file that renders subagent/delegation information\n    \n    Search for:\n    - \"Delegated to\" text\n    - \"librarian\" or subagent rendering\n    ...\n```\n\n## DoD\n- [ ] `transcript_lines` uses `task_prompt` when available\n- [ ] `display_lines` unchanged (still uses `task_description`)\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:57:19.257339646+01:00","updated_at":"2026-01-12T20:26:54.74396483+01:00","closed_at":"2026-01-12T20:26:54.74396483+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.4","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:57:19.26372044+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.4","depends_on_id":"codex-zwq.3","type":"blocks","created_at":"2026-01-09T23:57:55.442524467+01:00","created_by":"daemon"}]}
{"id":"codex-zwq.5","title":"Pass task_prompt through chatwidget","description":"## File\n`tui/src/chatwidget.rs` (lines ~2349-2400, `on_subagent_event` method)\n\n## Changes\n\nExtract `task_prompt` from `SubagentEventPayload` and pass to cell constructor:\n\n```rust\nfn on_subagent_event(\u0026mut self, payload: SubagentEventPayload) {\n    let SubagentEventPayload {\n        parent_call_id,\n        subagent_name,\n        task_description,\n        task_prompt,  // NEW - extract this\n        delegation_id,\n        parent_delegation_id,\n        depth,\n        inner,\n        session_id,\n    } = payload;\n\n    ...\n    \n    let cell = history_cell::new_subagent_task_cell(\n        parent_call_id.clone(),\n        session_id,\n        subagent_name.clone(),\n        task_description,\n        task_prompt,  // NEW - pass to cell\n        delegation_id.clone(),\n        ...\n    );\n}\n```\n\n## DoD\n- [ ] `task_prompt` extracted from payload\n- [ ] `task_prompt` passed to cell constructor\n- [ ] `cargo check -p codex-tui` passes\n- [ ] `cargo test -p codex-tui` passes","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:57:28.773313022+01:00","updated_at":"2026-01-12T20:26:54.744827746+01:00","closed_at":"2026-01-12T20:26:54.744827746+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.5","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:57:28.78526658+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.5","depends_on_id":"codex-zwq.2","type":"blocks","created_at":"2026-01-09T23:57:55.457092881+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.5","depends_on_id":"codex-zwq.3","type":"blocks","created_at":"2026-01-09T23:57:55.473040615+01:00","created_by":"daemon"}]}
{"id":"codex-zwq.6","title":"Update tests and snapshots","description":"## Files\n- `tui/src/history_cell.rs` (test section, lines ~3269+)\n- `tui/src/chatwidget/tests/subagent_tests.rs`\n- `tui/src/snapshots/`\n\n## Changes\n\n1. Update `new_subagent_task_cell()` calls in tests to include `task_prompt` parameter\n2. Add new test: `subagent_task_cell_transcript_shows_full_prompt`\n3. Update snapshot files if rendering changes\n\n## New Test\n```rust\n#[test]\nfn subagent_task_cell_transcript_shows_full_prompt() {\n    let state = Arc::new(Mutex::new(SubagentState {\n        items: vec![],\n        status: SubagentTaskStatus::Completed,\n        final_message: None,\n    }));\n\n    let description = \"Find TUI files\";\n    let full_prompt = \"Find files in codex-rs/tui related to:\\n1. Task delegation display\\n2. Transcript view\";\n\n    let cell = new_subagent_task_cell(\n        \"call-1\".to_string(),\n        None,\n        \"finder\".to_string(),\n        description.to_string(),\n        Some(full_prompt.to_string()),  // NEW\n        None,\n        None,\n        0,\n        state,\n        false,\n    );\n\n    // display_lines should show short description\n    let display = cell.display_lines(60);\n    assert!(display.iter().any(|l| render_line(l).contains(\"Find TUI files\")));\n\n    // transcript_lines should show full prompt\n    let transcript = cell.transcript_lines(60);\n    assert!(transcript.iter().any(|l| render_line(l).contains(\"Task delegation display\")));\n}\n```\n\n## DoD\n- [ ] All existing tests updated with new parameter\n- [ ] New test for full prompt in transcript added\n- [ ] `cargo test -p codex-tui` passes\n- [ ] Snapshots reviewed and accepted","status":"closed","priority":2,"issue_type":"task","created_at":"2026-01-09T23:57:42.780357694+01:00","updated_at":"2026-01-12T20:26:54.745751755+01:00","closed_at":"2026-01-12T20:26:54.745751755+01:00","close_reason":"Restored implementation","dependencies":[{"issue_id":"codex-zwq.6","depends_on_id":"codex-zwq","type":"parent-child","created_at":"2026-01-09T23:57:42.791988932+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.6","depends_on_id":"codex-zwq.4","type":"blocks","created_at":"2026-01-09T23:57:55.487269454+01:00","created_by":"daemon"},{"issue_id":"codex-zwq.6","depends_on_id":"codex-zwq.5","type":"blocks","created_at":"2026-01-09T23:57:55.502070419+01:00","created_by":"daemon"}]}
