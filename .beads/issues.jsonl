{"id":"codex-56f","title":"Scope Gemini OAuth to providers requiring Code Assist","description":"resolve_gemini_credential always prefers stored Gemini OAuth tokens when gemini_account_count\u003e0, forcing all Gemini providers to use Code Assist endpoint and ignoring configured API keys. Public generative-language providers break after codex login --gemini. Adjust credential selection to only use OAuth for providers that explicitly require Code Assist and keep API-key providers on their configured bearer.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:19:48.565853205+01:00","updated_at":"2025-12-06T13:27:55.960118498+01:00","closed_at":"2025-12-06T13:27:55.960118498+01:00"}
{"id":"codex-7kf","title":"Migrate Custom Features (Providers, Subagents, UI)","description":"","status":"closed","priority":1,"issue_type":"epic","created_at":"2025-12-05T13:57:24.388988989+01:00","updated_at":"2025-12-05T16:02:22.845701629+01:00","closed_at":"2025-12-05T16:02:22.845701629+01:00"}
{"id":"codex-7kf.1","title":"Migrate Multi-provider Support (Gemini, Anthropic)","description":"Port core backend support for Gemini and Anthropic from the old fork to codex-rs/core.\n\nSTEPS:\n1. Copy source files from old fork (core/src/):\n   - gemini.rs\n   - gemini_messages.rs\n   - anthropic_messages.rs\n2. Copy resource files:\n   - core/gemini-3-prompt.md\n3. Integrate into codex-rs/core:\n   - Update lib.rs to expose modules\n   - Update model_family.rs to include Gemini/Anthropic variants\n   - Update model_provider_info logic if necessary","notes":"Gemini + Anthropic scaffolds ported; proceeding to subagents","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:30.334759125+01:00","updated_at":"2025-12-05T15:33:33.919881922+01:00","closed_at":"2025-12-05T15:33:33.919885529+01:00","dependencies":[{"issue_id":"codex-7kf.1","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:30.335098263+01:00","created_by":"daemon"}]}
{"id":"codex-7kf.1.1","title":"Port Gemini Support","description":"Port all Gemini-related code and assets.\n\nFILES TO COPY:\n- /core/src/gemini.rs\n- /core/src/gemini_messages.rs\n- /core/gemini-3-prompt.md\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Gemini as a provider in core/src/model_family.rs","notes":"Gemini provider files ported, compiling in codex-core","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:34.905643645+01:00","updated_at":"2025-12-05T15:24:55.559395065+01:00","closed_at":"2025-12-05T15:24:55.559399624+01:00","dependencies":[{"issue_id":"codex-7kf.1.1","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:34.905983584+01:00","created_by":"daemon"}]}
{"id":"codex-7kf.1.2","title":"Port Anthropic Support","description":"Port Anthropic-related code.\n\nFILES TO COPY:\n- /core/src/anthropic_messages.rs\n\nINTEGRATION:\n- Add modules to core/src/lib.rs\n- Register Anthropic as a provider in core/src/model_family.rs (if distinct from OpenAI/Gemini path)","notes":"Anthropic messages/provider ported and compiling","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-05T13:58:43.383129271+01:00","updated_at":"2025-12-05T15:31:40.109495912+01:00","closed_at":"2025-12-05T15:31:40.109498948+01:00","dependencies":[{"issue_id":"codex-7kf.1.2","depends_on_id":"codex-7kf.1","type":"parent-child","created_at":"2025-12-05T13:58:43.383462036+01:00","created_by":"daemon"}]}
{"id":"codex-7kf.2","title":"Migrate Subagents Architecture","description":"Port the subagent orchestration logic to enable task delegation.\n\nSTEPS:\n1. Copy core/src/subagents.rs to codex-rs/core/src/\n2. Copy core/src/tools/handlers/task.rs to codex-rs/core/src/tools/handlers/\n3. Register the 'task' tool in the core tool registry\n4. Ensure the task handler hooks correctly into the event loop in codex-rs/app-server or core","notes":"Subagent scaffolding and task tool stubbed; responds unsupported pending full wiring","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:34.951409492+01:00","updated_at":"2025-12-05T15:43:43.070080627+01:00","closed_at":"2025-12-05T15:43:43.070085035+01:00","dependencies":[{"issue_id":"codex-7kf.2","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:34.951692232+01:00","created_by":"daemon"}]}
{"id":"codex-7kf.3","title":"Update TUI for New Providers and Subagents","description":"Adapt the TUI to render non-OpenAI models and subagent activities.\n\nSTEPS:\n1. Port TUI view modes:\n   - Copy/Adapt tui/src/tui/inline.rs\n   - Copy/Adapt tui/src/tui/standard.rs\n2. Update rendering logic:\n   - Check tui/src/chatwidget.rs for provider-specific rendering adjustments\n   - Ensure subagent tool calls are displayed correctly","status":"closed","priority":1,"issue_type":"feature","created_at":"2025-12-05T13:57:39.162584085+01:00","updated_at":"2025-12-05T16:02:19.277920853+01:00","closed_at":"2025-12-05T16:02:19.277920853+01:00","dependencies":[{"issue_id":"codex-7kf.3","depends_on_id":"codex-7kf","type":"parent-child","created_at":"2025-12-05T13:57:39.162905789+01:00","created_by":"daemon"}]}
{"id":"codex-cs1","title":"Fix Gemini login prefers newest credential","description":"Gemini login currently keeps using the first stored credential; new logins append to auth.json but core picks index 0 so refreshed tokens are ignored unless users edit auth.json. Update persistence to promote most recent Gemini tokens to the front so runtime uses latest login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T12:59:39.702700307+01:00","updated_at":"2025-12-06T13:04:15.269773177+01:00","closed_at":"2025-12-06T13:04:15.269773177+01:00"}
{"id":"codex-d8a","title":"Gemini tokens ignored when API key present","description":"load_auth early returns CodexAuth::from_api_key_with_client when auth.json includes an API key, discarding gemini_accounts snapshot. Runtime then sees zero Gemini accounts and keeps using API key. Need to preserve auth snapshot so Gemini tokens remain accessible even when API key exists.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:09:00.722385922+01:00","updated_at":"2025-12-06T13:49:19.30910605+01:00","closed_at":"2025-12-06T13:49:19.30910605+01:00"}
{"id":"codex-i1t","title":"Implement Antigravity Provider Support","description":"","status":"in_progress","priority":1,"issue_type":"epic","created_at":"2025-12-06T12:34:26.379799781+01:00","updated_at":"2025-12-06T22:44:23.612368907+01:00"}
{"id":"codex-i1t.1","title":"Define Antigravity Protocol and Types","description":"Extend core types to recognize Antigravity as a distinct authentication mode and wire protocol.\n\n**Actions:**\n1.  **codex-rs/app-server-protocol/src/protocol/common.rs**:\n    *   Update `enum AuthMode` to include `Antigravity`.\n    *   This distinguishes the login/auth flow from standard Gemini.\n\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Update `enum WireApi` to include `Antigravity`.\n    *   Update `enum ProviderKind` to include `Antigravity` (optional, but recommended for consistency).\n\n**Why:**\nThis is the foundational type work needed before we can write the implementation logic.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:31.707276308+01:00","updated_at":"2025-12-06T22:46:13.199124796+01:00","closed_at":"2025-12-06T22:46:13.199124796+01:00","dependencies":[{"issue_id":"codex-i1t.1","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:31.707575027+01:00","created_by":"daemon"}]}
{"id":"codex-i1t.2","title":"Add Antigravity Configuration and Constants","description":"Create the configuration module containing hardcoded credentials and endpoints.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity.rs`\n2.  **Add Constants** (Mirroring the Python reference implementation):\n    *   `ANTIGRAVITY_CLIENT_ID`: \"1071006060591-tmhssin2h21lcre235vtolojh4g403ep.apps.googleusercontent.com\"\n    *   `ANTIGRAVITY_CLIENT_SECRET`: \"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\"\n    *   `ANTIGRAVITY_AUTH_URL`, `ANTIGRAVITY_TOKEN_URL` (Standard Google OAuth endpoints).\n    *   `ANTIGRAVITY_ENDPOINT`: \"https://daily-cloudcode-pa.sandbox.googleapis.com\" (Note: Use the Sandbox URL as primary).\n    *   `ANTIGRAVITY_SCOPES`: Must include:\n        *   `https://www.googleapis.com/auth/cloud-platform`\n        *   `https://www.googleapis.com/auth/userinfo.email`\n        *   `https://www.googleapis.com/auth/cclog` (Critical)\n        *   `https://www.googleapis.com/auth/experimentsandconfigs` (Critical)\n\n**Why:**\nThese specific credentials and scopes are required to masquerade as the Antigravity client.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:38.497295683+01:00","updated_at":"2025-12-06T22:47:24.157608954+01:00","closed_at":"2025-12-06T22:47:24.157608954+01:00","dependencies":[{"issue_id":"codex-i1t.2","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:38.4976193+01:00","created_by":"daemon"}]}
{"id":"codex-i1t.3","title":"Implement Antigravity Authentication Flow","description":"Implement the OAuth flow using the Antigravity credentials.\n\n**Actions:**\n1.  **codex-rs/core/src/auth.rs**:\n    *   Update `CodexAuth` to handle `AuthMode::Antigravity`.\n    *   In `refresh_token()` logic:\n        *   Check if `mode == AuthMode::Antigravity`.\n        *   If so, use `antigravity::ANTIGRAVITY_CLIENT_ID/SECRET` instead of the Gemini ones.\n    *   In `login()` (if applicable) or manual token setup paths, ensure the correct scopes are requested.\n2.  **codex-rs/core/src/token_data.rs**:\n    *   Reuse `GeminiTokenData` struct for storage, as the fields (access_token, refresh_token, project_id) are identical.\n\n**Why:**\nWe need to authenticate *as* Antigravity to be allowed to call the internal endpoints.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:44.751257296+01:00","updated_at":"2025-12-06T23:27:23.359225469+01:00","closed_at":"2025-12-06T23:27:23.359225469+01:00","dependencies":[{"issue_id":"codex-i1t.3","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:44.751596443+01:00","created_by":"daemon"}]}
{"id":"codex-i1t.4","title":"Refactor Gemini Messages for Reusability","description":"Extract payload construction logic to allow wrapping.\n\n**Actions:**\n1.  **codex-rs/core/src/gemini_messages.rs**:\n    *   Locate the `stream_gemini_messages` function.\n    *   Extract the logic that builds the `GeminiRequest` struct (converting `Prompt`, `tools`, etc.) into a new public function:\n        ```rust\n        pub fn build_gemini_payload(prompt: \u0026Prompt, config: \u0026Config, ...) -\u003e Result\u003cGeminiRequest\u003e\n        ```\n    *   Make `GeminiRequest` and its inner types (`GeminiContent`, `GeminiTool`, etc.) public (or public to crate) so they can be used by the Antigravity module.\n\n**Why:**\nAntigravity uses the *exact same* internal payload structure, but wraps it in an outer envelope. We must not duplicate the complex logic of converting Codex prompts/tools into the Gemini format.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:50.699256599+01:00","updated_at":"2025-12-06T23:27:28.524168016+01:00","closed_at":"2025-12-06T23:27:28.524168016+01:00","dependencies":[{"issue_id":"codex-i1t.4","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:50.69960826+01:00","created_by":"daemon"}]}
{"id":"codex-i1t.5","title":"Implement Antigravity Message Streaming","description":"Implement the core Antigravity request/response logic.\n\n**Actions:**\n1.  **Create file**: `codex-rs/core/src/antigravity_messages.rs`\n2.  **Request Logic**:\n    *   Call `gemini_messages::build_gemini_payload(...)` to get the inner model request.\n    *   Wrap it in the Antigravity envelope:\n        ```rust\n        #[derive(Serialize)]\n        struct AntigravityRequest {\n            project: String, // from token data\n            userAgent: String, // MUST be \"antigravity\"\n            requestId: String, // \"agent-{uuid}\"\n            model: String,     // e.g. \"gemini-3-pro-preview\"\n            request: GeminiRequest,\n        }\n        ```\n3.  **Streaming Logic**:\n    *   Send POST to `{ANTIGRAVITY_ENDPOINT}/v1internal:streamGenerateContent`.\n    *   Use `eventsource-stream` (or similar) to handle SSE.\n4.  **Response Unwrapping**:\n    *   The stream yields JSON chunks.\n    *   **Crucial Step**: The chunks are Antigravity envelopes. You must extract the inner `response` field.\n        *   Example Chunk: `{\"responseId\": \"...\", \"response\": { \"candidates\": [...] }}`\n        *   Extract the inner object and treat it exactly like a standard Gemini chunk.\n    *   Reuse `gemini_messages::handle_stream_chunk` (or similar logic) if possible, or adapt it to parse the unwrapped chunk.\n\n**Why:**\nThis is the core logic that differentiates Antigravity from standard Gemini. The envelope makes the server treat us as the internal \"CloudCode\" tool.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:34:57.840908107+01:00","updated_at":"2025-12-06T23:27:36.456056193+01:00","closed_at":"2025-12-06T23:27:36.456056193+01:00","dependencies":[{"issue_id":"codex-i1t.5","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:34:57.841295316+01:00","created_by":"daemon"}]}
{"id":"codex-i1t.6","title":"Wire Antigravity into Client and Config","description":"Integrate the new provider into the main client dispatch.\n\n**Actions:**\n1.  **codex-rs/core/src/client.rs**:\n    *   In `ModelClient::stream()`, add a match arm for `WireApi::Antigravity`.\n    *   Call `antigravity_messages::stream_antigravity_messages(...)`.\n2.  **codex-rs/core/src/model_provider_info.rs**:\n    *   Ensure configuration loading (TOML) supports the new `wire_api = \"antigravity\"` string enum.\n\n**Why:**\nThis makes the new functionality accessible to the end user via their config.","status":"closed","priority":1,"issue_type":"task","created_at":"2025-12-06T12:35:02.836823082+01:00","updated_at":"2025-12-06T23:53:10.512430351+01:00","closed_at":"2025-12-06T23:53:10.512430351+01:00","dependencies":[{"issue_id":"codex-i1t.6","depends_on_id":"codex-i1t","type":"parent-child","created_at":"2025-12-06T12:35:02.837109549+01:00","created_by":"daemon"}]}
{"id":"codex-vq1","title":"ChatGPT login overwrites Gemini tokens","description":"persist_tokens_async in login/server.rs builds a fresh AuthDotJson with empty gemini_accounts when saving ChatGPT tokens, wiping existing Gemini credentials. Need to merge with existing auth.json so Gemini accounts survive ChatGPT login.","status":"closed","priority":1,"issue_type":"bug","created_at":"2025-12-06T13:55:23.755383003+01:00","updated_at":"2025-12-06T13:57:34.877510865+01:00","closed_at":"2025-12-06T13:57:34.877510865+01:00"}
