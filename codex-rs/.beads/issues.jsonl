{"id":"codex-rs-pc2","title":"Port Gemini Quota Functionality","description":"Port quota fetching and display logic from gemini-cli to codex-rs. Integrate with /status and TUI. Ensure functionality matches gemini-cli's stats command.","status":"closed","priority":2,"issue_type":"epic","created_at":"2025-12-20T12:44:24.326042661+01:00","updated_at":"2025-12-20T13:24:55.00855285+01:00","closed_at":"2025-12-20T13:24:55.00855285+01:00"}
{"id":"codex-rs-pc2.1","title":"Implement GeminiQuotaClient in core","description":"Create `core/src/quota/gemini_client.rs` implementing the `ProviderQuotaClient` trait.\n\n## Implementation Details\n1. Add `GeminiQuota` and `GeminiBucket` structs to `protocol/src/protocol.rs`\n2. Add `gemini: Option\u003cGeminiQuota\u003e` field to `RateLimitSnapshot`\n3. Create `GeminiQuotaClient` struct with:\n   - OAuth token loading via `CodexAuth`\n   - HTTP client for Google CodeAssist API\n   - `fetch_quota()` implementation\n4. API endpoint: `https://cloudcode-pa.googleapis.com/v1internal:retrieveUserQuota`\n5. Request: `{ project: string }`\n6. Response: `{ buckets?: BucketInfo[] }` where BucketInfo has remainingFraction, resetTime, modelId, tokenType\n\n## Code Reuse\n- Follow `AntigravityQuotaClient` pattern exactly\n- Reuse `ProviderQuotaClient` trait\n- Map response to `RateLimitSnapshot` with `gemini` field populated","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.337081068+01:00","updated_at":"2025-12-20T13:12:41.103968304+01:00","closed_at":"2025-12-20T13:12:41.103968304+01:00","dependencies":[{"issue_id":"codex-rs-pc2.1","depends_on_id":"codex-rs-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.337382564+01:00","created_by":"daemon"}]}
{"id":"codex-rs-pc2.2","title":"Display Gemini Quota in CLI status","description":"Update `run_login_status` in `cli/src/login.rs` to fetch and display Gemini quota.\n\n## Implementation Details\n1. Check if Gemini OAuth credentials exist via `CodexAuth`\n2. If credentials exist, instantiate `GeminiQuotaClient`\n3. Fetch quota and print text summary:\n   - Show each bucket with model name, remaining %, reset time\n   - Format: `Gemini Quota: model_id - XX% remaining (resets in Xh)`\n4. Graceful error handling - if fetch fails, show 'unavailable'\n\n## Dependencies\n- Requires codex-rs-pc2.1 (GeminiQuotaClient) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.348466408+01:00","updated_at":"2025-12-20T13:20:05.32993453+01:00","closed_at":"2025-12-20T13:20:05.32993453+01:00","dependencies":[{"issue_id":"codex-rs-pc2.2","depends_on_id":"codex-rs-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.348750461+01:00","created_by":"daemon"},{"issue_id":"codex-rs-pc2.2","depends_on_id":"codex-rs-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.349156297+01:00","created_by":"daemon"}]}
{"id":"codex-rs-pc2.3","title":"Display Gemini Quota in TUI","description":"Update TUI status display to render Gemini quota information.\n\n## Implementation Details\n1. Add `GeminiQuotaDisplay` struct to `tui/src/status/rate_limits.rs`\n2. Extend `RateLimitSnapshotDisplay` with `gemini: Option\u003cGeminiQuotaDisplay\u003e`\n3. In `compose_rate_limit_data()`:\n   - Check for `snapshot.gemini`\n   - Render bucket quotas as progress bars (reuse `render_status_limit_progress_bar`)\n   - Show model name, remaining %, reset time\n4. Display Gemini alongside Antigravity (not mutually exclusive)\n5. Only render if Gemini OAuth credentials are stored\n\n## Code Reuse\n- Reuse existing progress bar rendering from Antigravity\n- Reuse staleness detection logic\n- Follow same row structure as Antigravity model quotas\n\n## Dependencies\n- Requires codex-rs-pc2.1 (GeminiQuotaClient and protocol types) to be complete","status":"closed","priority":2,"issue_type":"feature","created_at":"2025-12-20T12:44:24.357730504+01:00","updated_at":"2025-12-20T13:20:05.337033413+01:00","closed_at":"2025-12-20T13:20:05.337033413+01:00","dependencies":[{"issue_id":"codex-rs-pc2.3","depends_on_id":"codex-rs-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.358006301+01:00","created_by":"daemon"},{"issue_id":"codex-rs-pc2.3","depends_on_id":"codex-rs-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.358393411+01:00","created_by":"daemon"}]}
{"id":"codex-rs-pc2.4","title":"Add tests for Gemini Quota","description":"Add unit tests for GeminiQuotaClient and TUI rendering.\n\n## Test Coverage\n1. `core/src/quota/gemini_client.rs` tests:\n   - Test parsing API response to `GeminiQuota`\n   - Test handling empty buckets\n   - Test handling missing fields gracefully\n   - Test ISO timestamp parsing\n\n2. `tui/src/status/rate_limits.rs` tests:\n   - Test `compose_rate_limit_data` with Gemini quota\n   - Test rendering alongside Antigravity quota\n   - Test staleness detection for Gemini data\n\n## Dependencies\n- Requires codex-rs-pc2.1, codex-rs-pc2.3 to be complete","status":"closed","priority":2,"issue_type":"task","created_at":"2025-12-20T12:44:24.367768088+01:00","updated_at":"2025-12-20T13:24:48.386541024+01:00","closed_at":"2025-12-20T13:24:48.386541024+01:00","dependencies":[{"issue_id":"codex-rs-pc2.4","depends_on_id":"codex-rs-pc2","type":"parent-child","created_at":"2025-12-20T12:44:24.368017375+01:00","created_by":"daemon"},{"issue_id":"codex-rs-pc2.4","depends_on_id":"codex-rs-pc2.1","type":"blocks","created_at":"2025-12-20T12:44:24.368524694+01:00","created_by":"daemon"}]}
{"id":"codex-rs-zk7","title":"Gemini Provider Logic Alignment","description":"Epic to align codex-rs Gemini provider logic with gemini-cli best practices for stability and token efficiency. This involves implementing strict history curation, robust active loop detection, and proper tool cancellation feedback.","status":"open","priority":1,"issue_type":"epic","created_at":"2025-12-20T12:22:23.70575291+01:00","updated_at":"2025-12-20T12:22:23.70575291+01:00"}
{"id":"codex-rs-zk7.1","title":"Implement Strict History Curation for Gemini","description":"What: Implement a strict history curation pass in core/src/gemini_messages.rs before sending requests to Gemini.\n\nHow: Iterate through message history to merge consecutive turns of the same role and enforce strict User-Model-User alternation. Drop orphaned tool calls or responses if they violate alternation.\n\nWhy: Gemini is extremely strict about history structure. Currently, codex-rs can produce invalid sequences (like text + tool response creating two user turns), leading to fatal 400 errors.","status":"open","priority":1,"issue_type":"task","created_at":"2025-12-20T12:22:30.901597316+01:00","updated_at":"2025-12-20T12:22:37.850954549+01:00","dependencies":[{"issue_id":"codex-rs-zk7.1","depends_on_id":"codex-rs-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.902037405+01:00","created_by":"daemon"}]}
{"id":"codex-rs-zk7.2","title":"Robust Active Loop Identification for Signatures","description":"What: Improve the logic for identifying the active loop start index in apply_synthetic_thought_signatures.\n\nHow: Instead of looking for the last user message with non-empty text, find the last user message that is NOT a tool response (i.e., does not contain function response parts).\n\nWhy: The current heuristic fails if a user message contains images or other non-text data, potentially leaving the model turn unsigned and causing API rejection.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.911713522+01:00","updated_at":"2025-12-20T12:22:37.857859707+01:00","dependencies":[{"issue_id":"codex-rs-zk7.2","depends_on_id":"codex-rs-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.911993006+01:00","created_by":"daemon"}]}
{"id":"codex-rs-zk7.3","title":"Implement Explicit Tool Cancellation Feedback","description":"What: Refine explicit tool cancellation feedback and prevent model apology loops.\n\nHow: \n1. Acknowledge existing cancellation feedback in core/src/tools/parallel.rs (injects 'aborted by user').\n2. Verify if non-parallel tool paths correctly inject cancellation messages.\n3. Ensure that when a tool is cancelled, the agent loop short-circuits so the model does NOT immediately generate a response (avoiding apology loops). \n4. Optionally align the 'aborted by user' string with gemini-cli's 'canceled by the user'.\n\nWhy: While a basic mechanism exists, we need to ensure it applies globally and doesn't waste tokens on apology turns after a user explicitly interrupts.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.920506774+01:00","updated_at":"2025-12-20T12:25:46.332442322+01:00","dependencies":[{"issue_id":"codex-rs-zk7.3","depends_on_id":"codex-rs-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.920766229+01:00","created_by":"daemon"}]}
{"id":"codex-rs-zk7.4","title":"Strip Thought Signatures from Historical Turns","description":"What: Omit the thought_signature property from historical function calls in GeminiContent.\n\nHow: Modify build_gemini_messages to only populate thought_signature for the active turn (most recent exchange).\n\nWhy: Signatures are one-time validation tokens with no semantic value in history. Stripping them saves context window tokens (~5-10 per tool call) and reduces noise.","status":"open","priority":2,"issue_type":"task","created_at":"2025-12-20T12:22:30.929168234+01:00","updated_at":"2025-12-20T12:22:37.870845581+01:00","dependencies":[{"issue_id":"codex-rs-zk7.4","depends_on_id":"codex-rs-zk7","type":"parent-child","created_at":"2025-12-20T12:22:30.929426707+01:00","created_by":"daemon"}]}
